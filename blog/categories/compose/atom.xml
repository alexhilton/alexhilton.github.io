<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Compose | ç¨€æœ‰çŒ¿è¯‰]]></title>
  <link href="https://alexhilton.github.io/blog/categories/compose/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2025-08-17T22:07:16+08:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[ç”¨Composeä¸­çš„Shaderå®ç°ä¸€ä¸ªé›ªèŠ±é£˜é£˜å¼¹çª—æ•ˆæœ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader/"/>
    <updated>2025-08-17T22:02:24+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒSnow Dialog Shader Tutorialã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20">https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´12æœˆ27æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:2000/1*oNN6ZtalbQEvYCpTx8gLWg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘å¤§å®¶å±•ç¤ºå¦‚ä½•åˆ›å»ºé›ªèŠ±è¦†ç›–çš„å¯¹è¯æ¡†æ•ˆæœã€‚æ€»çš„æ¥è¯´ï¼Œè¯¥æ•ˆæœå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>

<ol>
<li><strong>è®¾ç½® Compose ä»£ç </strong>ï¼šè¿™ç¡®ä¿äº†åŸºç¡€æ•ˆæœçš„å®ç°ã€‚</li>
<li><strong>åˆ›å»ºå¯¹è¯æ¡†åº•éƒ¨ç§¯é›ªçš„ç€è‰²å™¨</strong>ï¼šè¿™æ˜¯æˆ‘åœ¨ä»Šå¤©æ•™ç¨‹ä¸­é‡ç‚¹è®²è§£çš„æ ¸å¿ƒæ•ˆæœã€‚</li>
<li><strong>æ·»åŠ é£˜è½çš„é›ªèŠ±</strong>ï¼šä¸ºæ­¤ï¼Œæˆ‘åœ¨ ShaderToy ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªç°æˆçš„ç€è‰²å™¨ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œä½¿å…¶ä¸ä¼šå¯¹æ‰‹æœºæ€§èƒ½é€ æˆå¤ªå¤§è´Ÿæ‹…ã€‚ç¬¬ä¸‰éƒ¨åˆ†å°†åŒ…å«åŸå§‹ç€è‰²å™¨çš„é“¾æ¥ä»¥åŠä¸€äº›ä¼˜åŒ–è¯´æ˜ã€‚</li>
</ol>


<p>æœ¬æ•™ç¨‹ä¸»è¦è®²è§£å¦‚ä½•ä¸ºå¯¹è¯æ¡†åˆ›å»ºä¸æ–­å¢é•¿çš„é›ªç›–æ•ˆæœã€‚</p>

<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:804/1*SRa57BglcDzpLzAAw1UAPw.gif" alt="æœ€ç»ˆæ•ˆæœ" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰æ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ï¼ˆé“¾æ¥ï¼š<a href="https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81">https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81</a></p></blockquote>

<p>è®©æˆ‘ä»¬ä» Compose ä¸­ä¸ºæ•ˆæœè®¾ç½®ä¸€ä¸ªæœ€å°é¡µé¢å¼€å§‹ã€‚å®ƒåŒ…å«ä¸€å¼ èƒŒæ™¯å›¾ç‰‡å’Œä¸€ä¸ªä½äºä¸­å¿ƒçš„æŒ‰é’®ï¼Œç”¨äºè§¦å‘å¯¹è¯æ¡†ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹è¯æ¡†ä¸åº”æ¥è‡ª Material åº“ï¼Œè€Œåº”ä½¿ç”¨ Compose ä¸­æœ€åŸºæœ¬çš„â€œAlertDialogâ€ã€‚</p>

<p>ä»¥ä¸‹æ˜¯æœ€ä½é…ç½®ï¼š</p>

<pre><code class="Kotlin">@Composable
fun SnowDialogScreen() {
    var showDialog by remember { mutableStateOf(false) }  

    Box(
        modifier = Modifier.fillMaxSize(),
        contentAlignment = Alignment.Center
    ) {
        Image(
            painter = painterResource(id = R.drawable.christmas_night),
            contentDescription = "Sample Image",
            contentScale = ContentScale.Crop,
            modifier = Modifier.fillMaxSize()
        )        if (!showDialog) {
            Button(onClick = { showDialog = true }) {
                Text("Ho-ho-ho!")
            }
        } else {
            SnowedDialog { showDialog = false }
        }
    }
}

@Composable
private fun SnowedDialog(onDismiss: () -&gt; Unit) {
    BasicAlertDialog(
        onDismissRequest = { onDismiss() },
        properties = DialogProperties(usePlatformDefaultWidth = false)
    ) {
        Column(
            Modifier
                .padding(horizontal = 16.dp)
                .background(shape = MaterialTheme.shapes.large, 
                            color = MaterialTheme.colorScheme.surface)
                .padding(16.dp),
        ) {
            Text("Merry Christmas!", style = MaterialTheme.typography.titleLarge)
            Spacer(modifier = Modifier.height(10.dp))
            Text("Happy New Year!")
            Spacer(modifier = Modifier.height(26.dp))
            Row(
                modifier = Modifier
                    .fillMaxWidth(),
                horizontalArrangement = Arrangement.End
            ) {
                Text(
                    modifier = Modifier
                        .clickable { onDismiss() }
                        .padding(5.dp),
                    text = "Close",
                    style = MaterialTheme.typography.bodyMedium.copy(color = MaterialTheme.colorScheme.primary)
                )
            }
        }
    }
}
</code></pre>

<p>æœ€ç»ˆï¼Œä½ åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*fnlF56ZxRxMwa7vHkCOudA.png" alt="é¢œè‰²å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œæ­¤å¤–è§‚å·²é’ˆå¯¹æš—é»‘æ¨¡å¼è¿›è¡Œäº†è°ƒæ•´" /></p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™ç€è‰²å™¨äº†ï¼æˆ‘å°†ç®€è¦ä»‹ç»å¦‚ä½•è®¾ç½®ç€è‰²å™¨å¹¶å°†å…¶é™„åŠ åˆ°å¯¹è¯æ¡†ä¸­ã€‚æœ‰å…³è¿è¡Œæ—¶ç€è‰²å™¨çš„æ›´è¯¦ç»†ä»‹ç»å’Œåˆå­¦è€…æŒ‡å—ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„å¦ä¸€ä¸ª<a href="https://juejin.cn/post/7535292253813981247">æ•™ç¨‹</a>ã€‚</p>

<p>å¼€å§‹ä½¿ç”¨ç€è‰²å™¨æ‰€éœ€çš„æœ€ä½è¦æ±‚å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨å¯¹è¯æ¡†ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª <code>runtimeShader</code>ï¼Œå¹¶ä½¿ç”¨ <code>graphicsLayer</code> å°†å…¶åˆ†é…ç»™ <code>Column</code>ï¼š</p>

<pre><code class="kotlin">@Composable
private fun SnowedDialog(onDismiss: () -&gt; Unit) {
    // ä»å­—ç¬¦ä¸²ç¼–è¯‘æˆ‘ä»¬çš„ç€è‰²å™¨
    val snowCapShader = remember { RuntimeShader(snowCapShader) }  

    BasicAlertDialog(
        onDismissRequest = { onDismiss() },
        properties = DialogProperties(usePlatformDefaultWidth = false)
    ) {
        Column(
            Modifier
                .padding(horizontal = 16.dp)
                .background(shape = MaterialTheme.shapes.large, color = MaterialTheme.colorScheme.surface)
                .onSizeChanged { size -&gt;
                    // pass resolution
                    snowCapShader.setFloatUniform(
                        "resolution",
                        size.width.toFloat(),
                        size.height.toFloat()
                    )
                }
                .graphicsLayer {
                    // apply shader 
                    this.renderEffect = RenderEffect
                        .createRuntimeShaderEffect(snowCapShader, "image")
                        .asComposeRenderEffect()
                }
                .padding(16.dp),
        ) {
          // å…¶ä½™ä»£ç ä¿æŒä¸å˜

//...

@Language("agsl")
private val snowCapShader = """
    uniform shader image;
    uniform vec2 resolution;    
    vec4 main(float2 fragCoord) {
         float2 uv = fragCoord / resolution - 0.5;
         if(abs(uv.x)&gt;0.5 || abs(uv.y)&gt;0.5) {
             return vec4(0.0);
         }          
         float ratio = resolution.x / resolution.y;    
         uv.x *= ratio;        
         vec4 imageColor = image.eval(fragCoord);        
         return vec4(vec3(1.0), imageColor.a);
    }
""".trimIndent()
</code></pre>

<p>ç›®å‰ï¼Œå®ƒå°†æ˜¾ç¤ºä¸ºä¸€ä¸ªç©ºç™½çŸ©å½¢ï¼Œå°±åƒæˆ‘ä»¬çš„å¯¹è¯æ¡†ä¸€æ ·ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*C5O1IMHS7MvK0lFnIqHFYA.png" alt="" /></p>

<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘å…ˆå°½å¯èƒ½ç®€å•åœ°è§£é‡Šä¸€ä¸‹å®ç°æ­¤æ•ˆæœèƒŒåçš„é€»è¾‘ã€‚æˆ‘å°†ç®—æ³•åˆ†ä¸ºå››ä¸ªæ¦‚å¿µæ­¥éª¤ï¼š</p>

<ol>
<li><strong>æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°</strong>æ¥å®šä¹‰é›ªè¾¹ç¼˜çš„è½®å»“ã€‚</li>
<li><strong>åœ¨ y è½´ä¸Š</strong>ç»˜åˆ¶æ­¤å‡½æ•°ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹**ï¼Œå¹¶å°†å…¶å‚ç›´ç§»å‘åº•éƒ¨è¾¹ç¼˜ã€‚</li>
<li><strong>å®šä¹‰ä¸€ä¸ªé®ç½©åŒºåŸŸ</strong>ï¼Œè¿™æ„å‘³ç€åœ¨æ­¤åŒºåŸŸä¹‹å¤–ï¼Œå‡½æ•°å°†è¢«å®Œå…¨å¿½ç•¥ï¼Œæˆ‘ä»¬åªéœ€ç»˜åˆ¶ç€è‰²å™¨ä»ç³»ç»Ÿæ¥æ”¶çš„å†…å®¹å³å¯ã€‚</li>
<li><strong>ä¿®æ”¹ä¾§é¢å’Œé¡¶éƒ¨çš„é®ç½©</strong>ï¼Œä½¿é›ªçš„å½¢çŠ¶æ›´è‡ªç„¶ï¼Œè€Œåº•éƒ¨è¾¹ç¼˜çš„è½®å»“åˆ™ç”±æˆ‘ä»¬çš„å‡½æ•°å¤„ç†ã€‚</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Vbq5YEL42g1tQsLjWKAokQ.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç€è‰²å™¨ä¸­æŒ‰é¡ºåºå®ç°è¿™äº›æ­¥éª¤ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©äº†ä¸€ä¸ªåŸºæœ¬çš„æ­£å¼¦æ³¢ä½œä¸ºé›ªè¾¹ç¼˜çš„å‡½æ•°ã€‚æˆ‘æ·»åŠ äº†ä¸€äº›ç³»æ•°æ¥å‹ç¼©å®ƒå¹¶é™ä½å…¶æŒ¯å¹…ï¼š</p>

<pre><code class="glsl">float snowEdge = (sin(10.*uv.x)*0.5+0.5)*0.2;
</code></pre>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ç™½è‰²å¡«å……æ­¤çº¿ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒæ—¶å¿½ç•¥å…¶ä¸‹æ–¹çš„æ‰€æœ‰å†…å®¹ã€‚</p>

<pre><code class="glsl">vec4 snow = step(uv.y, snowEdge)*vec4(1.0);
</code></pre>

<blockquote><p>é€šè¿‡å‘ <code>uv.y</code> æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç›´ç§»åŠ¨æ•´ä¸ªå‡½æ•°ã€‚</p></blockquote>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥æ–¹æ³•ç§»è¿‘å¯¹è¯æ¡†çš„åº•éƒ¨è¾¹ç¼˜å¹¶æ·»åŠ ä¸€ä¸ªé®ç½©ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„çŸ©å½¢åŒºåŸŸä½œä¸ºé®ç½©ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†åˆ«æŒ‡å®šæ¯ä¸ªè¾¹ç¼˜æ¥å®šä¹‰å®ƒã€‚è¿™ç§æ–¹æ³•å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹å†—é•¿ï¼Œä½†å®ƒä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ï¼š</p>

<pre><code class="glsl"> vec4 main(float2 fragCoord) {
         float2 uv = fragCoord / resolution - 0.5;        
         float ratio = resolution.x / resolution.y;    
         uv.x *= ratio;         

         float snowEdge = (sin(10.*uv.x)*0.5+0.5)*0.2;
         snowEdge = step(uv.y-0.4, snowEdge);       

         float topBound = 0.3;
         float leftBound = -.5*ratio;
         float rightBound = .5*ratio;        

         float snowMask = 0.;       
         if(uv.x &gt; leftBound &amp;&amp; uv.x &lt; rightBound &amp;&amp; uv.y &gt; topBound) {
            snowMask = 1.0;
         }
         snowMask *= snowEdge;        
         vec4 imageColor = image.eval(fragCoord);
         vec3 snowColor = vec3(1.0);       
         vec3 finalColor = mix(imageColor.rgb, snowColor, snowMask);      

         return vec4(finalColor, snowMask+imageColor.a);
    }
</code></pre>

<p>è°ƒæ•´åï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æœã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*GM2d-tsCUOAHnloMiDYAAA.png" alt="" /></p>

<p>ç°åœ¨å¯èƒ½ä¸æ˜¯æåŠè¿™ä¸€ç‚¹çš„æœ€ä½³æ—¶æœºï¼Œä¹Ÿè®¸åº”è¯¥æ—©ç‚¹æåŠï¼Œä½†åœ¨è¿™é‡Œå¼ºè°ƒè¿™ä¸€ç‚¹è‡³å…³é‡è¦ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬å¯¹åæ ‡è¿›è¡Œäº†å½’ä¸€åŒ–ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†å¹³ç§»ï¼Œä½¿é›¶ç‚¹æ°å¥½ä½äºç”»å¸ƒï¼ˆå³å¯¹è¯æ¡†ï¼‰çš„ä¸­å¿ƒã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š<code>_float2 uv = fragCoord/resolution â€” 0.5;_</code></p>

<p>ç†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºç°åœ¨æˆ‘æƒ³å‡å°ä¸­å¿ƒæ­£å¼¦æ³¢çš„æŒ¯å¹…ï¼Œå¹¶éšç€æˆ‘ä»¬å‘å·¦å³ä¸¤ä¾§è¿œç¦»ä¸­å¿ƒè€Œå¢å¤§æŒ¯å¹…ã€‚ç†è§£åæ ‡ç³»çš„è®¾ç½®æ–¹å¼åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å‡½æ•°ä¹˜ä»¥æ²¿ x è½´è·ç¦»ä¸­å¿ƒçš„è·ç¦»æ¥å®ç°è¿™ä¸€ç‚¹ã€‚è¿™æ ·ï¼Œå‡½æ•°å°†åœ¨ä¸­å¿ƒå¤„æ°å¥½è¿”å›é›¶ç‚¹ï¼Œå¹¶éšç€å‘å¤–ç§»åŠ¨è€Œå¢å¤§ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ç°ä»¥ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*oW8OP3R2VFo0SkJmDhgVSw.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯å¸¸é‡æ¥å®šä¹‰é®ç½©çš„é¡¶éƒ¨è¾¹ç•Œã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªæ­£å¼¦æ³¢ï¼Œä½†é—´éš”ç­‰äºå¯¹è¯æ¡†çš„å®½åº¦ã€‚</p>

<pre><code class="glsl">float topBound = (sin(ratio*uv.x*0.8+2.)*0.5+0.5)*.2+0.3;
</code></pre>

<p>æˆ‘ä»¬å°†ä¸ºå·¦å³è¾¹ç•Œæ·»åŠ ç±»ä¼¼çš„ä»£ç ï¼šæˆ‘å¸Œæœ›å®ƒä»¬ä¹Ÿä½¿ç”¨æ­£å¼¦æ³¢ï¼Œä½†è¿™æ¬¡æ˜¯å‚ç›´è¿è¡Œçš„ã€‚</p>

<pre><code class="glsl">float leftBound = -.5*ratio+(sin(10.*uv.y)*0.5+0.5)*0.5*length(uv.y-topBound);
float rightBound = .5*ratio-(sin(10.*uv.y)*0.5+0.5)*0.4*length(uv.y-topBound);
</code></pre>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåº•éƒ¨è¾¹ç¼˜æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼šè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å˜é‡ï¼Œæˆ‘ä»¬ä¼šå°†å®ƒä» Compose ä¼ é€’ç»™ç€è‰²å™¨ã€‚åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€æ·»åŠ ç›¸åº”çš„ <code>uniform</code> å˜é‡ï¼Œå¹¶å°†åº•éƒ¨è¾¹ç¼˜å‡½æ•°ä¹˜ä»¥å®ƒå³å¯ï¼š</p>

<pre><code class="glsl">uniform shader image;
    uniform vec2 resolution;
    uniform float time;        vec4 main(float2 fragCoord) {
         float2 uv = fragCoord / resolution - 0.5;        

         float ratio = resolution.x / resolution.y;    
         uv.x *= ratio;         

         float adjustedTime = clamp(time * 0.3,0.0,1.0);
         float snowEdge = (sin(10.*uv.x)*0.5+0.5)*0.2 * length(uv.x)*adjustedTime;
         snowEdge = step(uv.y-0.5, snowEdge);       

         float topBound = (sin(ratio*uv.x*0.8+2.)*0.5+0.5)*.2+0.3;
         float leftBound = -.5*ratio+(sin(10.*uv.y)*0.5+0.5)*0.5*length(uv.y-topBound);
         float rightBound = .5*ratio-(sin(10.*uv.y)*0.5+0.5)*0.4*length(uv.y-topBound);                   

         float snowMask = 0.;         
         if(uv.x &gt; leftBound &amp;&amp; uv.x &lt; rightBound &amp;&amp; uv.y &gt; topBound) {
            snowMask = 1.0;
         }

         snowMask *= snowEdge;         

         vec4 imageColor = image.eval(fragCoord);
         vec3 snowColor = vec3(1.0);        
         vec3 finalColor = mix(imageColor.rgb, snowColor, snowMask);       

         return vec4(finalColor, snowMask+imageColor.a);
    }
</code></pre>

<p>åˆ«å¿˜äº†ä»composableä¸­æä¾›æ—¶é—´ï¼š</p>

<pre><code class="Kotlin">@Composable
private fun SnowedDialog(onDismiss: () -&gt; Unit) {
    val snowCapShader = remember { RuntimeShader(snowCapShader) }
    var time by remember { mutableStateOf(0f) }

    LaunchedEffect(null)  {
        while (true) {
            delay(10)
            time += 0.01f
        }
    }

    BasicAlertDialog(
        onDismissRequest = { onDismiss() },
        properties = DialogProperties(usePlatformDefaultWidth = false)
    ) {
        Column(
            Modifier
                .padding(horizontal = 16.dp)
                .background(shape = MaterialTheme.shapes.large, color = MaterialTheme.colorScheme.surface)
                .onSizeChanged { size -&gt;
                    snowCapShader.setFloatUniform(
                        "resolution",
                        size.width.toFloat(),
                        size.height.toFloat()
                    )
                }
                .graphicsLayer {
                    // è¿™é‡Œæä¾›æ—¶é—´ï¼š
                    snowCapShader.setFloatUniform("time", time)
                    this.renderEffect = RenderEffect
                        .createRuntimeShaderEffect(snowCapShader, "image")
                        .asComposeRenderEffect()
                }
                .padding(16.dp),
        ) {
// å…¶ä½™ä»£ç ä¿æŒä¸å˜
</code></pre>

<p>æˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*5YYiM3lZYp42O8Fa9iS-4A.gif" alt="" /></p>

<p>å…³äºè¿™ä¸ªæ•ˆæœï¼Œæˆ‘æƒ³åˆ†äº«çš„å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼è¿™æ˜¯æ ¸å¿ƒæ€æƒ³ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œä½ å¯ä»¥å°è¯•ä¸åŒçš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ç”¨ä¸€ä¸ªåŸºäº Perlin å™ªå£°çš„æ›´æ··ä¹±çš„ç‰ˆæœ¬æ›¿æ¢äº†åŸºæœ¬çš„æ­£å¼¦æ³¢ã€‚</p>

<p>ä½†è¿™äº›åªæ˜¯ç»†èŠ‚ï¼Œåœ¨å®ç°ä¸Šå¯ä»¥æœ‰æ— é™çš„å˜åŒ–ã€‚åˆ›å»ºç€è‰²å™¨çš„å…³é”®åœ¨äºæŒæ¡å…¶èƒŒåçš„æ ¸å¿ƒæ€æƒ³ã€‚</p>

<p>ä½ å¯ä»¥åœ¨æˆ‘çš„ä»£ç åº“ä¸­æ‰¾åˆ°æˆ‘çš„å®ç°ï¼Œå…¶ä¸­è¿˜åŒ…å«å„ç§ç”¨äºä¸åŒå¢å¼ºåŠŸèƒ½çš„è¾…åŠ©æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ç³»åˆ—è¿‡æ¸¡æ•ˆæœï¼ˆçº¿æ€§ã€ä¸‰æ¬¡ã€æŒ‡æ•°ç­‰ï¼‰ã€‚</p>

<p>æ·»åŠ é›ªèŠ±æ˜¯æœ€åä¸€æ­¥ï¼Œä½†åˆ›å»ºé›ªã€é›¨ã€æ˜Ÿæ˜Ÿç­‰æ•ˆæœçš„æ–¹æ³•å€¼å¾—å¦å¼€ä¸€ä¸ªæ•™ç¨‹ã€‚ä¸‹æ¬¡æˆ‘ä¸€å®šä¼šè®²è§£ã€‚ä»Šå¤©ï¼Œæˆ‘åªæƒ³æä¸€ä¸‹ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç‰¹å®šçš„æ•ˆæœï¼Œæˆ‘ä½¿ç”¨äº† <strong>Andrew Baldwin</strong> äº 2013 å¹´åœ¨ ShaderToy ä¸Šåˆ›å»ºçš„ç€è‰²å™¨ã€‚é“¾æ¥å¦‚ä¸‹ï¼š<a href="https://www.shadertoy.com/view/ldsGDn">https://www.shadertoy.com/view/ldsGDn</a></p>

<p>ç”±äºåŸå§‹ç€è‰²å™¨å¯¹äºæ‰‹æœºæ¥è¯´è¿‡äºåºå¤§ï¼Œæˆ‘åšäº†ä¸€äº›ç®€åŒ–ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜éœ€è¦ä¸€äº›é€‚é… AGSL çš„åŠŸèƒ½ã€‚è¿™æ˜¯æˆ‘çš„ç‰ˆæœ¬ï¼š</p>

<pre><code class="glsl">  uniform shader image;
   uniform vec2 resolution;
   uniform float time;

   uniform int uLayers;
   uniform float uDepth;
   uniform float uSpeed;

   const int MAX_LAYERS = 50;
   const float WIDTH = 0.4;

   vec2 NormalizeCoordinates(vec2 o, vec2 r) {
        float2 uv = o / r - 0.5;
        if (r.x &gt; r.y) {
            uv.x *= r.x / r.y;
        } else {
            uv.y *= r.y / r.x;
        } 
        return uv;
    }

    vec4 GetImageTexture(vec2 p, vec2 pivot, vec2 r) {
        if (r.x &gt; r.y) {
            p.x /= r.x / r.y;
        } else {
            p.y /= r.y / r.x;
        }
        p += pivot;
        p *= r;
        return image.eval(p);
    }

    vec4 main(float2 fragCoord) {
       float2 uv = NormalizeCoordinates(fragCoord, resolution);  
       vec4 image = GetImageTexture(uv, vec2(0.5, 0.5), resolution);
       const mat3 p = mat3(13.323122, 23.5112, 21.71123, 21.1212, 28.7312, 11.9312, 21.8112, 14.7212, 61.3934);

       float ratio = resolution.y / resolution.x;
       vec3 acc = vec3(0.0);
       float alpha = 0.0; // åˆå§‹åŒ– alpha
       float dof = 5.0 * sin(time * 0.1);
       for (int i = 0; i &lt; MAX_LAYERS; i++) {
           if (i &gt;= uLayers) break; // å¦‚æœ i è¶…å‡º uLayersï¼Œåˆ™è·³å‡ºå¾ªç¯

           float fi = float(i);
           vec2 q = uv * (1.0 + fi * uDepth);

           // é€šè¿‡è°ƒåˆ¶å’Œæ—¶é—´è°ƒæ•´é›ªèŠ±ä½ç½®
           q -= vec2(q.y * (WIDTH * mod(fi * 7.238917, 1.0) - WIDTH * 0.5), uSpeed * time / (1.0 + fi * uDepth * 0.03));                      vec3 n = vec3(floor(q), 31.189 + fi);
           vec3 m = floor(n) * 0.00001 + fract(n);
           vec3 mp = (31415.9 + m) / fract(p * m);
           vec3 r = fract(mp);

           // ä½¿ç”¨åœ†å½¢maskçš„åœ†å½¢é›ªèŠ±å½¢çŠ¶
           float2 center = mod(q, 1.0) - 0.5 + 0.5 * r.xy;
           float distanceToCenter = length(center); // åœ†å‘¨è·ç¦»
           float flakeRadius = 0.015 + 0.01 * r.z; // æ¯ä¸ªè–„ç‰‡çš„åŠå¾„ç•¥æœ‰ä¸åŒ

           // é€šè¿‡æ‰©å±•çš„å¹³æ»‘æ­¥è¿›å®ç°æ›´å¹³æ»‘çš„è¾¹ç¼˜
           float intensity = smoothstep(flakeRadius + 0.015, flakeRadius, distanceToCenter) * 
                               smoothstep(flakeRadius, flakeRadius - 0.015, distanceToCenter);

           // Ensure flakes are white or transparent (prevent black color)
           vec3 flakeColor = vec3(1.0); // é›ªèŠ±è¦æ˜¯ç™½è‰²
           acc += flakeColor * intensity;

           // é€šè¿‡å¹³æ»‘è¿‡æ¸¡ç§¯ç´¯ alpha
           alpha += intensity;
       }

       // å½’ä¸€åŒ– alpha ä»¥ç¡®ä¿å…¶ä¸è¶…è¿‡ 1.0
       alpha = clamp(alpha, 0.0, 1.0);
       vec3 finalColor = mix(image.rgb, acc, alpha);

      if(uv.y &lt; -0.5*ratio || uv.y &gt; .5*ratio) {
           finalColor = vec3(0.0);
           alpha = 0.0;
       }
       return vec4(finalColor, alpha+image.a);
   }
</code></pre>

<p>å½“ç„¶ï¼Œä¸ºäº†è®©ä¸€äº›é›ªèŠ±å‡ºç°åœ¨å±å¹•å‰æ–¹ï¼Œè€Œå¦ä¸€äº›é›ªèŠ±é£˜åˆ°å±å¹•åæ–¹ï¼Œæˆ‘å¿…é¡»åœ¨è¿™ä¸ªç€è‰²å™¨ä¸­ä½¿ç”¨ä¸¤å±‚ã€‚è¿™æ˜¯å¯¹è¯æ¡†å¯ç»„åˆå‡½æ•°çš„æœ€ç»ˆæ•ˆæœï¼š</p>

<pre><code class="Kotlin">@Composable
private fun SnowedDialog(onDismiss: () -&gt; Unit) {
    val snowCapShader = remember { RuntimeShader(snowCapShader) }
    val flakesShaderForeground = remember { RuntimeShader(snowShader) }
    val flakesShaderBackground = remember { RuntimeShader(snowShader) }

    var time by remember { mutableStateOf(0f) }

    LaunchedEffect(null)  {
        while (true) {
            delay(10)
            time += 0.01f
        }
    }

    flakesShaderForeground.setIntUniform("uLayers", 5)
    flakesShaderForeground.setFloatUniform("uDepth", 0.15f)
    flakesShaderForeground.setFloatUniform("uSpeed", 1.0f)

    flakesShaderBackground.setIntUniform("uLayers", 10)
    flakesShaderBackground.setFloatUniform("uDepth", 1.5f)
    flakesShaderBackground.setFloatUniform("uSpeed", 0.8f)

    BasicAlertDialog(
        onDismissRequest = { onDismiss() },
        properties = DialogProperties(usePlatformDefaultWidth = false)
    ) {
        Box(
            modifier = Modifier
                .fillMaxSize()
                .onSizeChanged { size -&gt;
                    flakesShaderForeground.setFloatUniform(
                        "resolution",
                        size.width.toFloat(),
                        size.height.toFloat()
                    )
                }
                .graphicsLayer {
                    flakesShaderForeground.setFloatUniform("time", time)
                    this.renderEffect = RenderEffect
                        .createRuntimeShaderEffect(flakesShaderForeground, "image")
                        .asComposeRenderEffect()
                }
                .padding(16.dp),
            contentAlignment = Alignment.Center
        ) {
            Box(
                modifier = Modifier
                    .fillMaxSize()
                    .onSizeChanged { size -&gt;
                        flakesShaderBackground.setFloatUniform(
                            "resolution",
                            size.width.toFloat(),
                            size.height.toFloat()
                        )
                    }
                    .graphicsLayer {
                        flakesShaderBackground.setFloatUniform("time", time)
                        this.renderEffect = RenderEffect
                            .createRuntimeShaderEffect(flakesShaderBackground, "image")
                            .asComposeRenderEffect()
                    }
            ) {
                Box(
                    modifier = Modifier
                        .fillMaxSize()
                        .background(color = Color.Black.copy(0.1f))
                )
            }
            Column(
                Modifier
                    .padding(horizontal = 16.dp)
                    .background(shape = MaterialTheme.shapes.large, color = MaterialTheme.colorScheme.surface)
                    .onSizeChanged { size -&gt;
                        snowCapShader.setFloatUniform(
                            "resolution",
                            size.width.toFloat(),
                            size.height.toFloat()
                        )
                    }
                    .graphicsLayer {
                        snowCapShader.setFloatUniform("time", time)
                        this.renderEffect = RenderEffect
                            .createRuntimeShaderEffect(snowCapShader, "image")
                            .asComposeRenderEffect()
                    }
                    .padding(16.dp),
            ) {
                Text("Merry Christmas!", style = MaterialTheme.typography.titleLarge)
                Spacer(modifier = Modifier.height(10.dp))
                Text("Happy New Year!")
                Spacer(modifier = Modifier.height(26.dp))
                Row(
                    modifier = Modifier
                        .fillMaxWidth(),
                    horizontalArrangement = Arrangement.End
                ) {
                    Text(
                        modifier = Modifier
                            .clickable { onDismiss() }
                            .padding(5.dp),
                        text = "Close",
                        style = MaterialTheme.typography.bodyMedium.copy(color = MaterialTheme.colorScheme.primary)
                    )
                }
            }
        }
    }
}
</code></pre>

<p>æœ€ç»ˆç»“æœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*UG3e4b_9AqY1J1kKCNFqAw.png" alt="" /></p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚ä½ çš„æ”¯æŒæ„ä¹‰é‡å¤§ï¼Œå¹¶æ¿€åŠ±ç€æˆ‘ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åˆæ¢Composeä¸­çš„ç€è‰²å™¨RuntimeShader]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader/"/>
    <updated>2025-08-15T22:21:24+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒFirst look at RuntimeShaders in Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644">https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´4æœˆ12æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:1302/1*QXaDvaYryDIZ1GItjM1uqQ.png" title="auto auto" ></a></p>

<!-- more -->


<p>è‡ªä»æˆ‘ä»¬æœ‰æœºä¼šåœ¨ Compose ä¸­ä½¿ç”¨ RuntimeShaders è‡ªå®šä¹‰Shaderï¼ˆç€è‰²å™¨ï¼‰ä»¥æ¥ï¼Œå·²ç»è¿‡å»äº†ä¸€å¹´å¤šçš„æ—¶é—´ã€‚è¯´å®è¯ï¼Œæˆ‘åŸæœ¬ä»¥ä¸ºä¼šæœ‰å¤§é‡å…³äºè¿™ä¸ªä¸»é¢˜çš„æ–‡ç« ã€‚æˆ‘ä»¥ä¸ºç°åœ¨ Android ä¸Šåº”è¯¥å·²ç»å……æ–¥ç€æ— æ•°ä»¤äººæƒŠå¹çš„ç¤ºä¾‹ã€æ„æƒ³ä¸åˆ°çš„æ•ˆæœï¼Œä»¥åŠå¬åˆ°â€œç€è‰²å™¨â€è¿™ä¸ªè¯æ—¶è„‘æµ·ä¸­æµ®ç°çš„å…¶ä»–ä»¤äººç€è¿·çš„ä¸œè¥¿ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚åœ¨ RuntimeShaders å¯ç”¨ä¹‹åï¼Œå‡ ä¹ç«‹åˆ»å°±å‡ºç°äº†å‡ ç¯‡æ–‡ç« ï¼Œä¹‹åå°±å†ä¹Ÿæ²¡æœ‰äº†ã€‚ä¸€ç‰‡å¯‚é™ã€‚</p>

<p>æˆ‘æƒ³ç­”æ¡ˆå¾ˆç®€å•ï¼šAndroid å¼€å‘è€…å¹¶ä¸ç†Ÿæ‚‰ç€è‰²å™¨ï¼Œè€Œç€è‰²å™¨ç¨‹åºå‘˜é€šå¸¸ä¸ä¼šç›´æ¥ä¸º Android ç¼–å†™ä»£ç ï¼›ä»–ä»¬é€šå¸¸ä¼šä½¿ç”¨æŸç§æ¸¸æˆå¼•æ“ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘çš„å‡è®¾æ­£ç¡®ï¼Œæˆ‘å¸Œæœ›ç”¨è¿™ç¯‡æ–‡ç« æ¥å¼¥åˆè¿™ä¸¤ä¸ªä¸–ç•Œä¹‹é—´çš„å·®è·ã€‚æˆ‘çœŸå¿ƒå¸Œæœ›ç€è‰²å™¨ç¼–å†™èƒ½å¤Ÿæ¸—é€åˆ° Android å¼€å‘é¢†åŸŸã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡çš„å‰©ä½™éƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›å¿…è¦çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥ä¾¿ä½ å¯ä»¥åä¸‹æ¥ç¼–å†™ç€è‰²å™¨å¹¶äº«å—å…¶æˆæœã€‚</p>

<p>å› æ­¤ï¼Œæˆ‘å‡è®¾ä½ å·²ç»å¯¹ Compose æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æœ¬æ–‡ä¸ä¼šè¿‡å¤šè®¨è®ºç€è‰²å™¨ã€‚æˆ‘çš„ä¸»è¦é‡ç‚¹æ˜¯è¿æ¥è¿™ä¸¤ä¸ªä¸–ç•Œã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥è®¨è®ºå…·ä½“çš„æŠ€æœ¯ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªé¡¹ç›®ï¼šä¸€ä¸ªå¸¦æœ‰èƒŒæ™¯å›¾åƒï¼Œé¡¶éƒ¨æœ‰ä¸€ä¸ªæ¡†ï¼Œæˆ‘ä»¬æš‚æ—¶å°†å…¶è®¾ç½®ä¸ºé»‘è‰²ã€‚ä»¥ä¸‹æ˜¯ä»£ç çš„ç®€åŒ–ç‰ˆæœ¬ï¼š</p>

<pre><code class="Kotlin">VerySimpleShaderTheme {
    Box(Modifier.fillMaxSize(), 
        contentAlignment = Alignment.Center) {
        Image(
            modifier = Modifier.fillMaxSize(),
            contentScale = androidx.compose.ui.layout.ContentScale.Crop,
            painter = painterResource(id = R.drawable.background_pattern),
            contentDescription = null
        )
        Box(modifier = Modifier
            .size(200.dp)
            .clipToBounds()
          ){
        }
    }
}
</code></pre>

<p>ç°åœ¨ï¼Œè¦å°†ç€è‰²å™¨æ·»åŠ åˆ°æ¡†ä¸­ï¼Œä½ éœ€è¦è·å–ç€è‰²å™¨æ–‡æœ¬æœ¬èº«ï¼Œè¯¥æ–‡æœ¬ä»¥å¸¸è§„å­—ç¬¦ä¸²å½¢å¼ä¼ é€’ã€‚ä½¿ç”¨æ­¤æ–‡æœ¬åˆ›å»ºä¸€ä¸ª <code>RuntimeShader</code> å¯¹è±¡ã€‚ç„¶åï¼Œå°†å…¶ä¼ é€’ç»™ <code>graphicsLayer</code> æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<pre><code class="Kotlin">val runtimeShader = """
uniform shader image;

half4 main(float2 fragCoord) {
   return half4(0., 0.0, 0.0, .5);
}
""".trimIndent()

val shader = remember { RuntimeShader(runtimeShader) } 
Box(modifier = Modifier.size(200.dp)
                        .clipToBounds()
                        .graphicsLayer {
                            this.renderEffect = RenderEffect
                                .createRuntimeShaderEffect(
                                    shader, "image"
                                )
                                .asComposeRenderEffect()
                        }
                        .background(Color.White)
                       ) 
</code></pre>

<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç€è‰²å™¨ç¤ºä¾‹ï¼Œå®ƒè¾“å‡ºé»‘è‰²ï¼Œé€æ˜åº¦ä¸º 50%ã€‚å®ƒçœ‹èµ·æ¥åƒä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼ˆèƒŒæ™¯åªæ˜¯æ¥è‡ªèµ„æºåº“çš„å›¾ç‰‡ï¼‰ã€‚å®ƒå¯èƒ½è¿˜ä¸å¤Ÿä»¤äººå°è±¡æ·±åˆ»ï¼Œä½†æˆ‘æƒ³åœ¨è¿™é‡Œå¼ºè°ƒä¸¤ä¸ªé‡è¦çš„ç»†èŠ‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¦‚ä½•å°†ç€è‰²å™¨åº”ç”¨åˆ°ç›’å­ä¸Šã€‚åœ¨æˆ‘ä»¬çš„ç€è‰²å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç€è‰²å™¨å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åˆ›å»º renderEffect æ—¶ä¼ é€’å®ƒã€‚ç¬¬äºŒä¸ªé‡è¦çš„ç»†èŠ‚æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºç›’å­æ·»åŠ ä¸€ä¸ªèƒŒæ™¯ï¼Œå¹¶ä¸”èƒŒæ™¯ä¸èƒ½å®Œå…¨é€æ˜ï¼›åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬çš„ç€è‰²å™¨æ‰èƒ½åº”ç”¨åˆ°ç›’å­ä¸Šï¼Œå¦åˆ™å®ƒå°†ä¸å¯è§ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*DWbBFHchSRHzeVv_9FuxvQ.png" alt="" /></p>

<p>åœ¨ä½¿ç”¨ç€è‰²å™¨æ—¶ï¼Œé€šå¸¸éœ€è¦å¯¹åæ ‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶ä» 0 å˜ä¸º 1ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä» -0.5 åˆ° 0.5ï¼Œè¿™æ ·åæ ‡ä¸­å¿ƒå°±ä½äºç”»å¸ƒçš„æ­£ä¸­å¤®ã€‚è¿™æœ‰åŠ©äºä½¿ç”¨å„ç§æ•°å­¦å…¬å¼ã€‚ç„¶è€Œï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¸ä»…éœ€è¦çŸ¥é“å½“å‰åƒç´ åæ ‡ï¼Œè¿˜éœ€è¦çŸ¥é“ç”»å¸ƒçš„æ€»å°ºå¯¸ã€‚ä¸ºäº†æ¼”ç¤ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸‹ä¸€ä¸ªé‡ç‚¹ï¼šå°†å‚æ•°ä»ä»£ç ä¼ é€’ç»™ç€è‰²å™¨ã€‚æˆ‘ä»¬å°†ä¼ é€’ç›’å­çš„å°ºå¯¸å¹¶ä¿®æ”¹ç€è‰²å™¨ï¼Œä½¿å…¶ç»˜åˆ¶ä¸€ä¸ªåœ†åœˆï¼š</p>

<pre><code class="Kotlin">val runtimeShader = """
uniform shader image;
uniform float2 resolution;

half4 main(float2 fragCoord) {
    vec2 uv = fragCoord/resolution.xy - .5;
    uv.x *= resolution.x/resolution.y;    
    return half4(step(length(uv),0.5));
}
""".trimIndent()

Box(modifier = Modifier
                        .size(200.dp)
                        .clipToBounds()
                        .onSizeChanged { size -&gt;
                            shader.setFloatUniform(
                                "resolution", size.width.toFloat(), size.height.toFloat()
                            )
                        }
                        .graphicsLayer {
                            this.renderEffect = RenderEffect
                                .createRuntimeShaderEffect(
                                    shader, "image"
                                )
                                .asComposeRenderEffect()
                        }
                        .background(Color.White)
                       ) {
                    }
</code></pre>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*nBzr_W24ekFtGgf3xdz8QA.png" alt="" /></p>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•åˆ›å»ºè‡ªå·±çš„ç€è‰²å™¨å¹¶ä¸ºå…¶ä¼ é€’å‚æ•°ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ä½ å¯ä»¥ä¼ é€’ä»»ä½•ä½ éœ€è¦çš„å‚æ•°ï¼Œæ— è®ºæ˜¯æ—¶é—´ã€é¢œè‰²è¿˜æ˜¯ç€è‰²å™¨æ‰€éœ€çš„å…¶ä»–å‚æ•°ã€‚ä¸ºäº†å·©å›ºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸€ä¸ªæˆ‘ä¸º Android åˆ¶ä½œçš„ç¬¬ä¸€ä¸ªç€è‰²å™¨çš„ç¤ºä¾‹â€”â€”ä¸€ä¸ªç”¨äºåŠ è½½çš„å‘å…‰åœ†åœˆã€‚æˆ‘ä»¬å°†ä¼ é€’å½“å‰æ—¶é—´æ¥ä¸ºå…¶æ·»åŠ åŠ¨ç”»æ•ˆæœï¼›ä¸‹é¢æ˜¯ä¸€ä¸ªæ­¤ç±»æ•ˆæœçš„ç®€å•ç¤ºä¾‹ï¼š</p>

<pre><code class="Kotlin">val runtimeShader = """
uniform shader image;
uniform float2 resolution;
uniform float radius;
uniform float time;

half4 main(float2 fragCoord) {
    vec2 uv = fragCoord/resolution.xy - .5;
    uv.x *= resolution.x/resolution.y;    
    float radiusWithTime = (1+sin(time))*0.1 + radius;
    float glowingCircle = smoothstep(radiusWithTime, radiusWithTime-radiusWithTime*0.3, length(uv));    
    return half4(glowingCircle-step(length(uv),radius*0.7));
}
""".trimIndent()

val shader = remember { RuntimeShader(runtimeShader) }
var time by remember { mutableStateOf(0f) }
shader.setFloatUniform("radius", 0.6f)
LaunchedEffect(null) {
    while (true) {
        delay(10)
        time+=0.01f
    }
}

shader.setFloatUniform("time", time)
</code></pre>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Lr85zuDhk8o0-TUgw993_A.png" alt="å®ƒå®é™…ä¸Šæœ‰ä¸€ä¸ªå…‰æ™•åŠ¨ç”»" /></p>

<p>æˆ‘å·²ç»æ¼”ç¤ºäº†æœ€åŸºç¡€çš„éƒ¨åˆ†ã€‚æˆ‘çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œå¹¶å±•ç¤ºå®ƒæ˜¯å¤šä¹ˆçš„ç®€å•ã€‚å…³äºç€è‰²å™¨ï¼Œæˆ‘è¿˜æœ‰å¾ˆå¤šæƒ³è®¨è®ºçš„ï¼Œä½†æˆ‘ä»¬ç•™åˆ°ä¸‹æ¬¡å†è¯´ã€‚</p>

<p>æ„Ÿè°¢ä½ çš„å…³æ³¨ï¼Œç¥ä½ ä½¿ç”¨ Androidã€Compose å’ŒShaderï¼ˆç€è‰²å™¨ï¼‰é¡ºåˆ©è¿›å…¥éå‡¡çš„ UI ä¸–ç•Œã€‚æœŸå¾…ä¸ä½ ç›¸è§ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¼šç”¨æœ€ä¼˜é›…çš„å§¿å¼åœ¨Composeä¸­æ˜¾ç¤ºå¯Œæ–‡æœ¬]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose/"/>
    <updated>2025-07-30T22:50:40+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒStyledString: A Better Pattern for Rich Text in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1">https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1</a>ï¼Œç”±Eury PÃ©rez BeltrÃ©å‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NS_T-i72tS5eOs5F0f_Tnw.png" title="auto auto" ></a></p>

<!-- more -->


<p>åœ¨ Jetpack Compose ä¸­è®¾ç½®æ–‡æœ¬æ ·å¼çœ‹ä¼¼ç®€å•â€¦â€¦ä½†å…¶å®ä¸ç„¶ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ AnnotatedString çš„å±€é™æ€§ï¼Œä»¥åŠ StyledString å¦‚ä½•è®©å¯Œæ–‡æœ¬æ›´æ˜“äºç®¡ç†ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚ğŸ‘‡</p>

<h2>ğŸ“š ç›®å½•</h2>

<ol>
<li>å¼•è¨€ï¼šä¸€ä¸ªç²—ä½“å­—ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</li>
<li>AnnotatedStringï¼šæ ·å¼è¿‡å¤šï¼Œç®€æ´æ€§ä¸è¶³</li>
<li>StyledString ç®€ä»‹ï¼šä¸€ä¸ª API å³å¯è®¾ç½®æ‰€æœ‰æ ·å¼</li>
<li>StyledString åº•å±‚åŸç†ï¼šAPI èƒŒåçš„å¼•æ“</li>
<li>ç»“è¯­</li>
</ol>


<h2>å¼•è¨€ï¼šä¸€ä¸ªåŠ ç²—çš„å•è¯ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</h2>

<p>ä¸€å¼€å§‹ï¼Œä½ æ‹¥æœ‰äº† AnnotatedString å’Œä¸€ä¸ª SpanStyle ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆé¡ºç•…ã€‚ä½ æƒ³åŠ ç²—ä¸€ä¸ªå•è¯ï¼Ÿå¾ˆç®€å•âœ…ã€‚ç»™æŸä¸ªä¸œè¥¿åŠ ä¸‹åˆ’çº¿ï¼Ÿæ²¡é—®é¢˜ã€‚è¿™ç”šè‡³æ„Ÿè§‰æœ‰ç‚¹æœ‰è¶£ï¼Œå°¤å…¶æ˜¯åœ¨ä½ åƒ<a href="https://developer.android.com/develop/ui/compose/text/style-text#multiple-styles">å®˜æ–¹æ–‡æ¡£</a>ä¸­é‚£æ ·æ‰‹åŠ¨æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ã€‚</p>

<p>ä½†é—®é¢˜æ˜¯ï¼šğŸ§ </p>

<p>å½“ä½ å®Œå…¨æ§åˆ¶å­—ç¬¦ä¸²æ—¶ï¼Œè¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆã€‚ä½†å½“ä½ å¤„ç†å®é™…å†…å®¹ï¼šåŠ¨æ€å‰¯æœ¬ã€æœ¬åœ°åŒ–æ–‡æœ¬ã€ä»å…¶ä»–åœ°æ–¹ä¼ å…¥çš„æ®µè½ï¼Œè€Œä½ åªéœ€è¦è®¾ç½®å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ ·å¼æ—¶ï¼Ÿ</p>

<p>äº‹æƒ…å¾ˆå¿«å°±å˜å¾—å¾ˆç³Ÿç³•ã€‚</p>

<p>çªç„¶é—´ï¼Œä½ éœ€è¦è·Ÿè¸ªå­å­—ç¬¦ä¸²ã€è®¡ç®—ç´¢å¼•ã€åº”ç”¨æ ·å¼ï¼Œå¹¶è¿æ¥ç‚¹å‡»ç›‘å¬å™¨ã€‚åªéœ€å¯¹æ–‡æœ¬è¿›è¡Œä¸€æ¬¡æ›´æ”¹ï¼Œä½ çš„é€»è¾‘å°±ä¼šåƒçº¸ç‰Œå±‹ä¸€æ ·å´©æºƒã€‚ğŸƒ</p>

<p>ä½ åŸæœ¬æƒ³è¦çš„åªæ˜¯åŠ ç²—ä¸€ä¸ªå•è¯å¹¶è®©é“¾æ¥å¯ç‚¹å‡»ã€‚ç°åœ¨ä½ æ·±é™·äºæ ·æ¿ä»£ç ä¸­ï¼Œç¥ˆç¥·ä¸€åˆ‡éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šä¸ºä»€ä¹ˆ AnnotatedString åœ¨å®é™… UI ä¸­æ— æ³•å¾ˆå¥½åœ°æ‰©å±•ï¼Œå¹¶ä»‹ç»ä¸€ä¸ªæˆ‘ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæ„å»ºçš„å¾®å‹æŠ½è±¡ã€‚å®ƒå«åš StyledStringï¼Œå®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼šğŸ’¡ å®ƒç¡®å®åšåˆ°äº†ï¼š</p>

<p><strong>è®©Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚</strong></p>

<h2>AnnotatedStringï¼šæ ·å¼å¤ªå¤šï¼Œç®€æ´æ€§ä¸è¶³</h2>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç§°èµä¸€ä¸‹ AnnotatedStringã€‚å®ƒæ˜¯ä¸€æ¬¾å¼ºå¤§çš„å·¥å…·ğŸ’ª.</p>

<p>ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª Text å¯ç»„åˆé¡¹æ¥åˆ›å»ºå¸¦æ ·å¼ã€å¯ç‚¹å‡»ã€å¯äº¤äº’çš„æ–‡æœ¬ã€‚æƒ³è¦è®©ä¸€ä¸ªå•è¯åŠ ç²—ï¼Œå¦ä¸€ä¸ªå•è¯åƒé“¾æ¥ä¸€æ ·æ˜¾ç¤ºï¼Ÿå®Œå…¨å¯ä»¥ã€‚è¯¥ API çµæ´»ã€åº•å±‚ï¼Œå¹¶ä¸”ç”± Compose æœ¬èº«çš„å¯Œæ–‡æœ¬å¼•æ“æ”¯æŒã€‚</p>

<p>é—®é¢˜æ˜¯ï¼Œå®ƒåªæœ‰<strong>åœ¨æ‰‹åŠ¨</strong>æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²æ—¶æ‰èƒ½å‘æŒ¥æœ€ä½³æ•ˆæœã€‚</p>

<p>æ–‡æ¡£ä¸­çš„å¤§å¤šæ•°ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="Kotlin">buildAnnotatedString {
    append("Hello ")
    withStyle(style = SpanStyle(fontWeight = FontWeight.Bold)) {
        append("world")
    }
}
</code></pre>

<p>çœ‹èµ·æ¥ä¸é”™ï¼Œå¯¹å§ï¼Ÿä½†æ£˜æ‰‹çš„åœ°æ–¹å°±åœ¨è¿™é‡Œã€‚ğŸ‘€</p>

<p>å¦‚æœä½ æœ‰ä¸€æ•´æ®µåŠ¨æ€æ–‡æœ¬ï¼Œæ¯”å¦‚ä¸€æ®µæœ¬åœ°åŒ–çš„å­—ç¬¦ä¸²æˆ–ä¸€ä¸ªä»å…¶ä»–åœ°æ–¹æ‹‰å–çš„å¥å­ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>

<p>ç°åœ¨ä½ éœ€è¦å¤„ç†ï¼š</p>

<ul>
<li>æŸ¥æ‰¾è¦æ·»åŠ æ ·å¼çš„å­å­—ç¬¦ä¸²</li>
<li>è®¡ç®—èµ·å§‹å’Œç»“æŸç´¢å¼•</li>
<li>æ‰‹åŠ¨æ·»åŠ æ ·å¼æˆ–æ³¨é‡Š</li>
<li>å¸Œæœ›æ–‡æœ¬æ°¸è¿œä¸å˜ï¼Œå¦åˆ™ä¸€åˆ‡éƒ½ä¼šå´©æºƒã€‚</li>
</ul>


<p>å¦‚æœä½ éœ€è¦å¤šç§æ ·å¼ï¼Œæ¯”å¦‚ç²—ä½“å•è¯ã€å¯ç‚¹å‡»çš„ç”µå­é‚®ä»¶å’Œå¸¦ä¸‹åˆ’çº¿çš„ URLï¼ŒåŠ¨æ€åœ°ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—æ··ä¹±ã€‚ğŸ”¥
è¿™æ—¶ï¼ŒbuildAnnotatedString å°±ä¼šå˜æˆä¸€å †è„†å¼±çš„ç´¢å¼•æ•°å­¦è¿ç®—ã€é‡å¤çš„é€»è¾‘å’Œæ ·æ¿ä»£ç ï¼Œéš¾ä»¥é˜…è¯»ï¼Œæ›´éš¾ä»¥ç»´æŠ¤ã€‚</p>

<p>å½“ç„¶ï¼ŒAnnotatedString åŠŸèƒ½å¼ºå¤§ã€‚ä½†å½“ä½ çš„æ–‡æœ¬æ˜¯åŠ¨æ€çš„ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼æ—¶ï¼Ÿå®ƒå¾ˆå¿«å°±ä¼šå˜å¾—ç´¢ç„¶æ— å‘³ã€‚</p>

<h2>StyledString éš†é‡å‡ºåœºï¼šä¸€ä¸ª API å³å¯å®ç°æ‰€æœ‰æ ·å¼</h2>

<p>åœ¨ä¸ AnnotatedString çº ç»“äº†æ— æ•°æ¬¡ä¹‹åï¼Œæˆ‘å†³å®šæ„å»ºä¸€ä¸ªæ›´å¥½çš„ä¸œè¥¿ã€‚å®ƒå¹¶éä¸€ä¸ªåºå¤§çš„åº“ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ·å¼æ¡†æ¶ã€‚è€Œæ˜¯ä¸€ä¸ªç®€å•ã€å…¼å®¹ Compose çš„æŠ½è±¡ï¼Œç”¨äºè§£å†³ä¸€ä¸ªéå¸¸å…·ä½“çš„é—®é¢˜ã€‚</p>

<p><strong>StyledString æ¥å•¦ï¼ğŸ‘‹</strong></p>

<p>å®ƒçš„ç›®æ ‡å¾ˆç®€å•ï¼šè®©ä½ å®šä¹‰å­—ç¬¦ä¸²çš„å“ªäº›éƒ¨åˆ†åº”è¯¥è¢«è®¾ç½®æ ·å¼æˆ–å¯ç‚¹å‡»ï¼Œè€Œæ— éœ€æ‹…å¿ƒ indexOf ã€ addStyle æˆ– AnnotatedString.Builder ã€‚ä½ åªéœ€ç¼–å†™æ–‡æœ¬ï¼Œå‘Šè¯‰å®ƒéœ€è¦è®¾ç½®å“ªäº›å•è¯çš„æ ·å¼ï¼Œä»¥åŠç‚¹å‡»åè¯¥æ‰§è¡Œçš„æ“ä½œã€‚</p>

<p>å®ƒçš„å®é™…æ•ˆæœå¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">// This list can be built in the ViewModel
val styledStrings = persistentListOf(
    StyledString.ClickableEmail(
        highlightedText = "support@example.com",
        email = "support@example.com",
        style = SpanStyle(
            color = Color.Blue,
            textDecoration = TextDecoration.Underline
        )
    ),
    StyledString.ClickableUrl(
        highlightedText = "website",
        url = "https://euryperez.dev",
        style = SpanStyle(
            color = Color.Blue,
            textDecoration = TextDecoration.Underline
        )
    )
)

// In your Compose Screen
StyledText(
    fullText = "Contact us at support@example.com or visit our website",
    styledStrings = styledStrings,
    style = MaterialTheme.typography.label,
    onClick = { styled -&gt;
        when (styled) {
            is ClickableEmail -&gt; openEmailClient(styled.email)
            is ClickableUrl -&gt; openUrl(styled.url)
        }
    }
)
</code></pre>

<p>å°±æ˜¯è¿™æ ·ã€‚æ— éœ€æ‰‹åŠ¨æ„å»ºæ–‡æœ¬ï¼Œæ— éœ€ç´¢å¼•è®¡ç®—ï¼Œæ— éœ€æ ·æ¿ä»£ç ã€‚åªéœ€ç®€æ´ã€æ˜“è¯»ã€å£°æ˜å¼çš„æ ·å¼ï¼Œå³å¯ä¸çœŸå®æ–‡æœ¬å…¼å®¹ã€‚</p>

<p>ç”±äº StyledString æ”¯æŒ Simple ã€ ClickableEmail å’Œ ClickableUrl ç­‰ç±»å‹ï¼Œå› æ­¤å®ƒæ˜“äºåœ¨ä½ çš„åº”ç”¨ä¸­æ‰©å±•å’Œå¤ç”¨ã€‚ä½ å¯ä»¥è·å¾—å¯ç‚¹å‡»çš„ã€å¸¦æ ·å¼çš„æ–‡æœ¬ï¼Œè€Œæ— éœ€ç‰ºç‰²å…¶åˆç†æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ğŸ™</p>

<h2>StyledString çš„åº•å±‚ï¼šAPI èƒŒåçš„å¼•æ“</h2>

<p>è®©æˆ‘ä»¬æ­å¼€å®ƒçš„é¢çº±ï¼Œé€æ­¥äº†è§£ StyledString çš„å·¥ä½œåŸç†ã€‚ğŸª„</p>

<p>å½“ä½ åœ¨ UI ä¸­ä½¿ç”¨ StyledText æ—¶ï¼ŒğŸ§ å®ƒå¯èƒ½æ„Ÿè§‰åƒé­”æ³•ä¸€æ ·ç¥å¥‡ï¼Œä½†åœ¨å¹•åï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€æ´ã€æ˜“äºç»„åˆçš„æ¶æ„ï¼Œæ—¨åœ¨å‡å°‘æ ·å¼è®¾è®¡çš„ç—›è‹¦ï¼Œè€Œä¸ä¼šå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚</p>

<p>æœ¬èŠ‚æ¶µç›–äº† StyledString ç³»ç»Ÿçš„æ¯ä¸ªéƒ¨åˆ†ï¼Œä»æ ·å¼çš„æè¿°æ–¹å¼ï¼Œåˆ°æ ·å¼çš„æŸ¥æ‰¾ã€åº”ç”¨å’Œåœ¨å±å¹•ä¸Šæ¸²æŸ“ã€‚</p>

<h3>ğŸ§± 1. æ•°æ®æ¨¡å‹ï¼šStyledString å’Œ ClickableStyleString</h3>

<p>æ•´ä¸ªå®ç”¨ç¨‹åºçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º StyledString çš„å¯†å°æ¥å£ã€‚æˆ‘ä»¬é€šè¿‡å®ƒæ¥å¯¹éœ€è¦ä»¥æŸç§æ–¹å¼è®¾ç½®æ ·å¼çš„æ–‡æœ¬ç‰‡æ®µè¿›è¡Œå»ºæ¨¡ã€‚</p>

<pre><code class="Kotlin">@Immutable
sealed interface StyledString {
    val highlightedText: String
    val style: SpanStyle

    // Add `Simple` type

    // Add `ClickableEmail` type

    // Add `ClickableUrl` type
}
</code></pre>

<p>æ¯ä¸ª StyledString éƒ½éœ€è¦ä¸¤æ¡ä¿¡æ¯ï¼š</p>

<ul>
<li>highlightedTextï¼šéœ€è¦è®¾ç½®æ ·å¼çš„æ–‡æœ¬çš„ç¡®åˆ‡éƒ¨åˆ†</li>
<li>styleï¼šå®šä¹‰å…¶å¤–è§‚çš„ SpanStyleï¼ˆé¢œè‰²ã€ä¸‹åˆ’çº¿ã€å­—ä½“ç²—ç»†ç­‰ï¼‰ã€‚</li>
</ul>


<p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€äº›å®ç°æ­¤æ¥å£çš„ç‰¹å®šç±»å‹ï¼š</p>

<pre><code class="Kotlin">@Immutable
data class Simple(
    override val highlightedText: String,
    override val style: SpanStyle,
) : StyledString
</code></pre>

<p>è¿™ä¸ªæ˜¯çº¯è§†è§‰æ•ˆæœçš„ï¼Œå®ƒä¼šæ”¹å˜æ–‡æœ¬çš„å¤–è§‚ï¼Œä½†ä¸å“åº”ç‚¹å‡»ã€‚</p>

<p>ç„¶åæˆ‘ä»¬ä»‹ç»äº¤äº’ç±»å‹ï¼š</p>

<pre><code class="Kotlin">@Immutable
data class ClickableEmail(
    override val highlightedText: String,
    val email: String,
    override val style: SpanStyle,
) : StyledString, ClickableStyleString

@Immutable
data class ClickableUrl(
    override val highlightedText: String,
    val url: String,
    override val style: SpanStyle
) : StyledString, ClickableStyleString
</code></pre>

<p>å®ƒä»¬æ‰§è¡Œç›¸åŒçš„æ ·å¼è®¾ç½®å·¥ä½œï¼Œä½†è¿˜æºå¸¦é¢å¤–çš„æ•°æ®ï¼ˆä¾‹å¦‚ç‚¹å‡»æ—¶åº”æ‰“å¼€çš„ URL æˆ–ç”µå­é‚®ä»¶ï¼‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä»¬å®ç°äº†ç¬¬äºŒä¸ªæ¥å£ï¼šClickableStyleStringã€‚</p>

<pre><code class="Kotlin">sealed interface ClickableStyleString
</code></pre>

<p>è¿™ä¸ªå°æ¥å£æ„ä¹‰é‡å¤§ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤ŸåŒºåˆ†çº¯è§†è§‰æ ·å¼å’Œåº”è¯¥å“åº”ç‚¹å‡»çš„æ ·å¼ã€‚è¿™ä½¿å¾—æˆ‘ä»¬çš„ç‚¹å‡»å¤„ç†é€»è¾‘ç®€æ´ä¸”ç±»å‹å®‰å…¨ã€‚ğŸ’¡</p>

<p>ä½ å¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šå˜ä½“ï¼Œä¾‹å¦‚ @mentionsã€#hashtags æˆ–ç”µè¯å·ç ï¼Œåªéœ€åˆ›å»ºå¦ä¸€ä¸ªæ•°æ®ç±»å¹¶é€‰æ‹©æ€§åœ°å®ç°ClickableStyleString å³å¯ã€‚</p>

<h3>ğŸ¯ 2. æ ·å¼å’Œé“¾æ¥ï¼šapplyStyle</h3>

<p>ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†å“ªäº›æ–‡æœ¬éœ€è¦æ ·å¼ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ç§å°†è¿™äº›æ ·å¼åº”ç”¨äºå®é™…çš„ AnnotatedString çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯ applyStyle() çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„æ‰©å±•å‡½æ•°ï¼Œå®ƒæ ¹æ® StyledString çš„ç±»å‹åº”ç”¨æ ·å¼ï¼ˆå’Œç‚¹å‡»ç›‘å¬å™¨ï¼‰ã€‚</p>

<pre><code class="Kotlin">private fun AnnotatedString.Builder.applyStyle(
    styledString: StyledString,
    startIndex: Int,
    endIndex: Int,
    onClick: (ClickableStyleString) -&gt; Unit
) {
    when (styledString) {
        is StyledString.ClickableUrl -&gt; TODO()

        is StyledString.ClickableEmail -&gt; TODO()

        is StyledString.Simple -&gt; TODO()
    }
}
</code></pre>

<p>æ¯æ¬¡åŒ¹é…æ¯ä¸ª StyledString æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡æ­¤å‡½æ•°ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š</p>

<pre><code class="Kotlin">is StyledString.ClickableUrl -&gt; {
    val linkAnnotation = LinkAnnotation.Url(
        url = styledString.url,
        styles = TextLinkStyles(style = styledString.style),
        linkInteractionListener = { onClick(styledString) }
    )
    addLink(linkAnnotation, startIndex, endIndex)
}
</code></pre>

<p>å¦‚æœæ˜¯ URLï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª LinkAnnotation.Url å¯¹è±¡ï¼Œé™„åŠ æ ·å¼ï¼Œå¹¶ä¸ºå…¶æ·»åŠ ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨ã€‚addLink è´Ÿè´£å°†å…¶é™„åŠ åˆ°æ­£ç¡®çš„æ–‡æœ¬èŒƒå›´ã€‚</p>

<p>æˆ‘ä»¬æ‰§è¡Œçš„æ“ä½œç±»ä¼¼ï¼Œä½†é’ˆå¯¹ç”µå­é‚®ä»¶ä½¿ç”¨çš„æ˜¯ LinkAnnotation.Clickable ï¼š</p>

<pre><code class="Kotlin">is StyledString.ClickableEmail -&gt; {
    val linkAnnotation = LinkAnnotation.Clickable(
        tag = styledString.highlightedText,
        styles = TextLinkStyles(style = styledString.style),
        linkInteractionListener = { onClick(styledString) }
    )
    addLink(linkAnnotation, startIndex, endIndex)
}
</code></pre>

<p>å¦‚æœæ ·å¼åªæ˜¯è§†è§‰ä¸Šçš„ï¼ˆä¸å¯ç‚¹å‡»ï¼‰ï¼Œæˆ‘ä»¬ä¼šåº”ç”¨å¸¸è§„è·¨åº¦ï¼š</p>

<pre><code class="Kotlin">is StyledString.Simple -&gt; {
    addStyle(
        style = styledString.style, 
        start = startIndex, 
        end = endIndex
    )
}
</code></pre>

<p>è¿™ç§åˆ†ç¦»å°†æ‰€æœ‰æ ·å¼åº”ç”¨é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ã€‚å¦‚æœä½ æƒ³è¦æ”¯æŒæ–°çš„é“¾æ¥ç±»å‹æˆ–è¡Œä¸ºï¼Œåªéœ€æ›´æ–°æ­¤å‡½æ•°å³å¯ã€‚</p>

<h3>ğŸ” 3. åŒ¹é…æ–‡æœ¬ï¼šfindAllOccurrences</h3>

<p>åœ¨åº”ç”¨æ ·å¼ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ–‡æœ¬ä¸­æ‰€æœ‰å‡ºç°æŒ‡å®šhighlightedText çš„ä½ç½®ã€‚è¿™å°±æ˜¯æ­¤å‡½æ•°çš„ç”¨é€”ã€‚</p>

<pre><code class="Kotlin">/**
 * Find all occurrences of a substring in a string, optionally ignoring case.
 *
 * @param substring The substring to search for.
 * @param ignoreCase Whether to perform a case-insensitive search.
 * @return A list of indices where the substring was found.
 */
private fun String.findAllOccurrences(
    substring: String,
    ignoreCase: Boolean = false
): List&lt;Int&gt;
</code></pre>

<p>è¿™å°†è·å–å…¨æ–‡ï¼Œå¹¶è¿”å›ç»™å®šå­å­—ç¬¦ä¸²çš„æ¯ä¸ªåŒ¹é…é¡¹çš„èµ·å§‹ç´¢å¼•åˆ—è¡¨ã€‚</p>

<p>å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">if (substring.isEmpty()) return emptyList()
</code></pre>

<p>å¯¹äºç©ºå­å­—ç¬¦ä¸²ï¼Œå¿«é€Ÿæå‰é€€å‡ºã€‚é¿å…å¥‡æ€ªçš„è¾¹ç¼˜æƒ…å†µã€‚ç„¶åï¼Œæˆ‘ä»¬å‡†å¤‡è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„æœç´¢ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š</p>

<pre><code class="Kotlin">val indices = mutableListOf&lt;Int&gt;()
val searchString = if (ignoreCase) this.lowercase() else this
val searchSubstring = if (ignoreCase) substring.lowercase() else substring
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬éå†å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ¹é…é¡¹ï¼š</p>

<pre><code class="Kotlin">var startIndex = 0
val maxStartIndex = length - substring.length

while (startIndex &lt;= maxStartIndex) {
    val index = searchString.indexOf(searchSubstring, startIndex)
    if (index == -1) break
    indices.add(index)
    startIndex = index + 1
}
</code></pre>

<p>æˆ‘ä»¬æœ€ç»ˆè¿”å›ç»“æœï¼š</p>

<pre><code class="Kotlin">return indices.toList()
</code></pre>

<p>è¿™ä½¿å¾—æˆ‘ä»¬çš„æ ·å¼é€»è¾‘ä¿æŒçµæ´»æ€§å’Œå¼¹æ€§ï¼Œæ— è®ºæˆ‘ä»¬è®¾è®¡çš„å•è¯å‡ºç°ä¸€æ¬¡è¿˜æ˜¯åå‡ æ¬¡ã€‚</p>

<h3>ğŸ§  4. æ„å»º AnnotatedStringï¼šrememberStyledAnnotationString</h3>

<p>ä»¥ä¸‹å‡½æ•°å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚å®ƒæ¥æ”¶å®Œæ•´æ–‡æœ¬å’Œä½ çš„StyledString åˆ—è¡¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªåº”ç”¨äº†æ‰€æœ‰æ ·å¼çš„ AnnotatedStringã€‚</p>

<pre><code class="Kotlin">@Composable
fun rememberStyledAnnotationString(
    fullText: String,
    styledStrings: ImmutableList&lt;StyledString&gt;,
    ignoreCase: Boolean = false,
    onClick: (ClickableStyleString) -&gt; Unit
): AnnotatedString
</code></pre>

<p>æˆ‘ä»¬ç¡®ä¿ä½¿ç”¨ rememberUpdatedState() æ¥ä¿æŒç‚¹å‡»ç›‘å¬å™¨çš„æœ€æ–°çŠ¶æ€ï¼š</p>

<pre><code class="Kotlin">val currentOnClick by rememberUpdatedState(onClick)
</code></pre>

<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨è®°ä½æ¥ç¼“å­˜å·¥ä½œï¼Œé™¤éè¾“å…¥å‘ç”Ÿå˜åŒ–ï¼š</p>

<pre><code class="Kotlin">return remember(fullText, styledStrings, ignoreCase) {
  // TODO: build annotated string
}
</code></pre>

<p>æˆ‘ä»¬é¦–å…ˆé™„åŠ å®Œæ•´çš„æœªæ ·å¼åŒ–çš„æ–‡æœ¬ã€‚ç„¶åï¼Œå¯¹äºæ¯ä¸ª StyledString ï¼Œæˆ‘ä»¬æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ä½ç½®å¹¶åº”ç”¨æ ·å¼ï¼š</p>

<pre><code class="Kotlin">buildAnnotatedString {
    append(fullText)

    styledStrings.fastForEach { styledStringInfo -&gt;
        val indices =
            fullText.findAllOccurrences(styledStringInfo.highlightedText, ignoreCase)

        indices.fastForEach { startIndex -&gt;
            val endIndex = startIndex + styledStringInfo.highlightedText.length
            applyStyle(styledStringInfo, startIndex, endIndex, currentOnClick)
        }
    }
}
</code></pre>

<p>è¿™ä¸ªå¾ªç¯ä½¿å¾—æ ·å¼è®¾ç½®èƒ½å¤ŸåŠ¨æ€ä¸”å¤šç›®æ ‡åŒ–ã€‚ä½ å¯ä»¥å°†ä»»ä½•æœ¬åœ°åŒ–æˆ–è¿è¡Œæ—¶ç”Ÿæˆçš„å­—ç¬¦ä¸²ä½œä¸º fullText ä¼ é€’ï¼Œå®ƒä»ç„¶èƒ½å¤Ÿæ­£ç¡®åº”ç”¨æ ·å¼ã€‚</p>

<h3>ğŸ§© 5. å¯ç»„åˆé¡¹ï¼šStyledText</h3>

<p>æœ€åï¼ŒStyledText å¯ç»„åˆé¡¹å°†æ‰€æœ‰å†…å®¹è¿æ¥åœ¨ä¸€èµ·ã€‚</p>

<pre><code class="Kotlin">@Composable
fun StyledText(
    fullText: String,
    styledStrings: ImmutableList&lt;StyledString&gt;,
    style: TextStyle,
    modifier: Modifier = Modifier,
    onClick: (ClickableStyleString) -&gt; Unit = {},
    ignoreCase: Boolean = false,
) {
    // TODO: Implementation
}
</code></pre>

<p>ä½ ä¼ å…¥å…¨æ–‡ã€æ ·å¼ä»¥åŠå¯é€‰çš„ç‚¹å‡»å¤„ç†ç¨‹åºã€‚å®ƒçš„å†…éƒ¨åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">val annotatedString = rememberStyledAnnotationString(
    fullText = fullText,
    styledStrings = styledStrings,
    ignoreCase = ignoreCase,
    onClick = onClick
)
</code></pre>

<p>è¿™è°ƒç”¨äº†æˆ‘ä»¬åˆšåˆšè®²è¿‡çš„é€»è¾‘ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸¦æ ·å¼çš„ AnnotatedString ã€‚ç„¶åæˆ‘ä»¬æ¸²æŸ“å®ƒï¼š</p>

<pre><code class="Kotlin">Text(
    modifier = modifier,
    text = annotatedString,
    style = style
)
</code></pre>

<p>å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Compose Text ã€‚ä½†æ‰€æœ‰æ ·å¼é€»è¾‘éƒ½å·²é¢„å…ˆçƒ˜ç„™ã€‚ç°åœ¨ï¼Œä½ çš„ UI ä»£ç ä¿æŒç®€æ´ä¸”å£°æ˜å¼ã€‚ğŸŒš</p>

<h3>âš¡ï¸ 6. StyledText å®è·µ</h3>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ StyledText çš„å®è·µï¼Œä¸ºæ­¤ï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸ªé¢„è§ˆï¼Œä½ å¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<pre><code class="Kotlin">@PreviewLightDark
@Composable
private fun StyledTextPreview() {
    MyTheme {
        Box(
            modifier = Modifier
                .background(color = MaterialTheme.colors.background)
                .padding(16.dp)
        ) {
            // This list can be built in the ViewModel
            val styledStrings = persistentListOf(
                StyledString.ClickableEmail(
                    highlightedText = "support@example.com",
                    email = "support@example.com",
                    style = SpanStyle(
                        color = Color.Gray,
                        textDecoration = TextDecoration.Underline
                    )
                ),
                StyledString.ClickableUrl(
                    highlightedText = "website",
                    url = "https://euryperez.dev",
                    style = SpanStyle(
                        color = Color.Gray,
                        textDecoration = TextDecoration.Underline
                    )
                )
            )

            // In your Compose Screen
            StyledText(
                fullText = "Contact us at support@example.com or visit our website",
                styledStrings = styledStrings,
                style = MaterialTheme.typography.body2,
                color = MaterialTheme.colors.onBackground,
                onClick = { styled -&gt;
                    when (styled) {
                        is StyledString.ClickableEmail -&gt; TODO()
                        is StyledString.ClickableUrl -&gt; TODO()
                    }
                }
            )
        }
    }
}
</code></pre>

<p>ä½ å°†åœ¨é¢„è§ˆä¸­çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š
<img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Tc22BNoUfij54fBGQ7YCg.png" alt="StyledTextPreview" /></p>

<h3>âœ… æ€»ç»“ï¼šä¸€ä¸ªè¾“å‡ºç®€æ´çš„ç®€å•å¼•æ“</h3>

<p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œå…¨å¯å¤ç”¨çš„ Compose å®ç”¨ç¨‹åºï¼Œå®ƒï¼š</p>

<ul>
<li>ä½¿ç”¨ StyledString ä»¥å£°æ˜å¼æ–¹å¼æè¿°æ ·å¼</li>
<li>å®‰å…¨åœ°åŒºåˆ†å¯è§†æ ·å¼å’Œå¯ç‚¹å‡»æ ·å¼</li>
<li>ä½¿ç”¨ applyStyle åº”ç”¨ span å’Œ link</li>
<li>ä½¿ç”¨ findAllOccurrences æŸ¥æ‰¾å¤šä¸ªåŒ¹é…é¡¹</li>
<li>ä»¥ Compose ç¨³å®šçš„æ–¹å¼ç»„è£…æ‰€æœ‰å†…å®¹</li>
<li>å°è£…åœ¨ä¸€ä¸ªç®€æ´çš„ API ä¸­ï¼šStyledText</li>
</ul>


<p>æ— éœ€ indexOf ï¼Œæ— éœ€å¤æ‚çš„èŒƒå›´é€»è¾‘ï¼Œä¹Ÿæ— éœ€å¤åˆ¶ç²˜è´´ buildAnnotatedStringæ ·æ¿ä»£ç ã€‚</p>

<p><a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a">ç‚¹å‡»æ­¤å¤„</a>ï¼ˆé“¾æ¥ï¼š<a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82">https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82</a></p>

<h2>ç»“è¯­ğŸ¯</h2>

<p>Jetpack Compose èµ‹äºˆæˆ‘ä»¬å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†å¹¶éæ€»æ˜¯æœ€ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„å¼€ç®±å³ç”¨å·¥å…·ã€‚AnnotatedString å¯¹äºä¸€æ¬¡æ€§éœ€æ±‚æ¥è¯´éå¸¸æ£’ï¼Œä½†ä¸€æ—¦ä½ çš„ UI éœ€è¦å¤šç§æ ·å¼ã€å¤ç”¨æ¨¡å¼æˆ–åŠ¨æ€ç‚¹å‡»å¤„ç†ï¼Œå®ƒå°±ä¼šå¾ˆå¿«å˜å¾—å†—é•¿ã€‚</p>

<p>è¿™å°±æ˜¯ StyledString çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>

<p>å®ƒå¹¶éå–ä»£ AnnotatedStringï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼Œä¸ºä½ æä¾›ä¸€ç§æ›´å®‰å…¨ã€æ›´æ¸…æ™°çš„æ–¹å¼æ¥æè¿°æ„å›¾ï¼š</p>

<ul>
<li>â†’ â€œå°†æ­¤å•è¯åŠ ç²—â€</li>
<li>â†’ â€œå°†æ­¤çŸ­è¯­è®¾ä¸ºé“¾æ¥â€</li>
<li>â†’ â€œä¸ºè¯¥å­—ç¬¦ä¸²çš„æ¯ä¸ªå®ä¾‹è®¾ç½®æ ·å¼â€</li>
</ul>


<p>ä½ æ— éœ€å†è€ƒè™‘æ–‡æœ¬åç§»é‡å’Œè·¨åº¦èŒƒå›´ï¼Œè€Œæ˜¯å¼€å§‹æ€è€ƒå«ä¹‰ã€‚ç»“æœï¼šä»£ç æ›´ç®€æ´ã€æ ·æ¿æ›´å°‘ï¼Œå¼€å‘è€…ä½“éªŒæ›´ä½³ğŸ’†</p>

<h3>ğŸ§© æ˜“äºé‡‡ç”¨</h3>

<p>ä½ æ— éœ€é‡æ„æ•´ä¸ªåº”ç”¨å³å¯ä½¿ç”¨ StyledString ã€‚</p>

<p>åªéœ€å°†ä¸€ä¸¤ä¸ª Text() å…ƒç´ æ›¿æ¢ä¸º StyledText() å³å¯ã€‚å°†å†…è”çš„ buildAnnotatedString { &hellip; } å—æ›¿æ¢ä¸º StyledString.Simple æˆ– ClickableUrl çš„ç®€å•åˆ—è¡¨å³å¯ã€‚</p>

<p>å°±è¿™æ ·ï¼Œä½ å°±æˆåŠŸäº†ã€‚âœ¨</p>

<h3>ğŸ› ï¸ æ˜“äºæ‰©å±•</h3>

<p>è¿˜æœ‰å…¶ä»–ç”¨ä¾‹å—ï¼Ÿ</p>

<ul>
<li>ä¸º #hashtags è®¾ç½®æ ·å¼ï¼Ÿ</li>
<li>å¤„ç† @mentionsï¼Ÿ</li>
<li>è‡ªåŠ¨æ£€æµ‹ç”µè¯å·ç ï¼Ÿ</li>
<li>æ·»åŠ å›¾æ ‡æˆ–èƒŒæ™¯é«˜äº®ï¼Ÿ</li>
</ul>


<p>åªéœ€åˆ›å»ºä¸€ä¸ªå®ç° StyledString çš„æ–°æ•°æ®ç±»ï¼Œå¹¶åœ¨ applyStyle() ä¸­å¤„ç†å®ƒå³å¯ã€‚ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚</p>

<p>è¿™ç§åˆ†ç¦»ä½¿ä½ çš„æ–‡æœ¬é€»è¾‘æ¨¡å—åŒ–ã€å¯æµ‹è¯•ï¼Œå¹¶èƒ½å¤Ÿé€‚åº”æœªæ¥çš„è®¾è®¡æˆ–ä¸šåŠ¡éœ€æ±‚ã€‚</p>

<p>å¦‚æœä½ æœ‰ä»€ä¹ˆæœ‰è¶£çš„æƒ³æ³•ï¼Œåˆ«å¿˜äº†åœ¨è¯„è®ºåŒºåˆ†äº«ã€‚ğŸ˜‰</p>

<h3>ğŸ«± è½®åˆ°ä½ äº†</h3>

<p>ç°åœ¨ä½ å·²ç»äº†è§£äº†å®ƒçš„å·¥ä½œåŸç†ï¼ˆä»¥åŠå®ƒå®é™…éœ€è¦çš„ä»£ç é‡æœ‰å¤šå°ï¼‰ï¼Œé‚£å°±åœ¨ä¸‹ä¸€ä¸ª Compose å±å¹•ä¸­å°è¯•ä¸€ä¸‹å§ã€‚ä¸å†éœ€è¦ç¹ççš„ AnnotatedString.Builder ä»£ç ã€‚ä¸å†éœ€è¦é‡å¤çš„ span é€»è¾‘ã€‚åªéœ€æè¿°ä½ æƒ³è¦çš„å†…å®¹ï¼Œå‰©ä¸‹çš„äº¤ç»™ StyledText å¤„ç†ã€‚</p>

<p><strong>è®© Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚ğŸ˜</strong></p>

<h3>ğŸ¤ æ„Ÿè°¢é˜…è¯»</h3>

<p>å¦‚æœä½ æœ€ç»ˆåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† StyledStringï¼Œè¯·å‘Šè¯‰æˆ‘ï¼çœ‹åˆ°è¿™äº›å¾®å‹æ¨¡å¼åœ¨ç°å®ä¸–ç•Œä¸­è½åœ°æ€»æ˜¯å¾ˆé…·ã€‚ğŸ‘€</p>

<p>æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·è€ƒè™‘åˆ†äº«ç»™å…¶ä»–å¼€å‘è€…ï¼Œç‚¹èµæˆ–ç•™è¨€ã€‚è¿™å¾ˆæœ‰å¸®åŠ©ã€‚âœŒï¸</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ­å¯†Jetpack Composeä¸­çš„PausableComposition]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition/"/>
    <updated>2025-07-24T19:55:51+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒExploring PausableComposition internals in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose">https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose</a>ï¼Œç”±Shreyas Patilå‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751791091096/4e5b36e3-485c-4079-88be-987082e7d67e.png?w=1600&amp;h=840&amp;fit=crop&amp;crop=entropy&amp;auto=compress,format&amp;format=webp" title="auto auto" ></a></p>

<!-- more -->


<p>å—¨ï¼ŒComposers ä»¬ğŸ‘‹ï¼Œåœ¨æœ€è¿‘çš„ Compose 1.9.X ç‰ˆæœ¬ä¸­ï¼ŒCompose-runtime å¼•å…¥äº†ä¸€ä¸ªåä¸º PausableComposition çš„æ–°å†…éƒ¨ APIï¼Œæ®ç§°å®ƒå¯ä»¥è§£å†³æ€§èƒ½é—®é¢˜ã€‚å®ƒå¬èµ·æ¥åƒé­”æ³•ï¼Œä½†åœ¨åº•å±‚ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäºä¸€äº›éå¸¸å·§å¦™çš„å·¥ç¨‹è®¾è®¡ã€‚åœ¨æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶ä»¥æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹æ—¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº†ä¸€ä¸ªå¼ºå¤§çš„å†…éƒ¨å·¥å…·ï¼Œå®ƒä½¿è¿™ä¸€åˆ‡æˆä¸ºå¯èƒ½ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« å°†æ·±å…¥åˆ†æè¿™ä¸€æœºåˆ¶ï¼šPausableCompositionã€‚è¿™æ˜¯ Compose çš„å†…éƒ¨ APIï¼Œå¼€å‘è€…æ— éœ€äº†è§£å®ƒã€‚ä½†äº†è§£å®ƒçš„åº•å±‚å·¥ä½œåŸç†æ€»æ˜¯æœ‰ç›Šçš„ã€‚å¯¹äºæƒ³è¦æ·±å…¥äº†è§£ Compose å¦‚ä½•å®ç°å…¶æƒŠäººæ€§èƒ½çš„ Jetpack Compose å¼€å‘è€…æ¥è¯´ï¼Œè¿™ç¯‡æ¢ç´¢æ–‡ç« å°†ä¸ºä½ æä¾›æ›´æ¸…æ™°çš„è§†è§’ã€‚æˆ‘ä»¬å°†æ·±å…¥è¿è¡Œæ—¶æºä»£ç ï¼Œäº†è§£å®ƒçš„å·¥ä½œåŸç†ã€å®ƒå¯¹æ€§èƒ½å¦‚æ­¤é‡è¦çš„åŸå› ï¼Œä»¥åŠå¦‚ä½•åè°ƒæ‰€æœ‰ç»„ä»¶ä»¥ä½¿æˆ‘ä»¬çš„ UI æ„Ÿè§‰å¦‚æ­¤æµç•…ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>

<h2>ç¼˜èµ·</h2>

<p>ä¸ºäº†å®ç°æµç•…çš„ 60 å¸§/ç§’ (fps)ï¼Œæˆ‘ä»¬çš„åº”ç”¨éœ€è¦åœ¨ 16.7 æ¯«ç§’å†…ç»˜åˆ¶æ¯ä¸€å¸§ã€‚å½“ç”¨æˆ·æ»šåŠ¨æµè§ˆ LazyColumn æ—¶ï¼Œå¿…é¡»åœ¨è¿™ä¸ªå¾®å°çš„çª—å£å†…åˆ›å»ºã€æµ‹é‡å’Œç»˜åˆ¶æ–°çš„é¡¹ç›®ã€‚</p>

<p>å¦‚æœä¸€ä¸ªé¡¹ç›®å¾ˆå¤æ‚ï¼ŒåŒ…å«åµŒå¥—å¸ƒå±€ã€å›¾ç‰‡å’Œå¤§é‡é€»è¾‘ï¼Œé‚£ä¹ˆç»„åˆå®ƒæ‰€éœ€çš„å·¥ä½œå¾ˆå®¹æ˜“è¶…è¿‡ 16 æ¯«ç§’ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¸»çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå¸§ä¼šä¸¢å¤±ï¼Œç”¨æˆ·ä¼šåœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­çœ‹åˆ°â€œå¡é¡¿â€æˆ–å¡é¡¿ã€‚ğŸ˜©</p>

<p>è¿™æ­£æ˜¯ PausableComposition çš„åˆè¡·ã€‚</p>

<h2>â€œåšä»€ä¹ˆâ€ï¼šæ›´æ™ºèƒ½çš„ Compose æ–¹å¼</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä¸€ä½å¨å¸ˆï¼Œæ­£åœ¨ä¸ºä¸€åœºæ´»åŠ¨å‡†å¤‡ä¸€é¡¿å¤§é¤ã€‚ğŸ‘¨â€ğŸ³ ä¸å…¶åœ¨ç¬¬ä¸€ä½å®¢äººåˆ°æ¥æ—¶æ…Œä¹±åœ°ä»å¤´å¼€å§‹çƒ¹é¥ªæ‰€æœ‰é£Ÿæï¼Œä¸å¦‚æå‰å‡ ä¸ªå°æ—¶åšå¥½å‡†å¤‡å·¥ä½œã€‚åˆ‡èœã€è°ƒé…±ã€çƒ¤ç”œç‚¹ã€‚ç­‰åˆ°ä¸Šæ¡Œæ—¶ï¼Œæœ€åçš„çƒ¹é¥ªå’Œç»„è£…é€Ÿåº¦ä¼šå¿«å¾—ä»¤äººéš¾ä»¥ç½®ä¿¡ã€‚</p>

<p>PausableComposition å°†è¿™ç§â€œå‡†å¤‡å·¥ä½œâ€çš„ç†å¿µå¸¦åˆ°äº† Compose ä¸­ã€‚å®ƒå…è®¸è¿è¡Œæ—¶ï¼š</p>

<ol>
<li>å¢é‡å¼ Composeï¼šå°†å¤§å‹ UI å…ƒç´ çš„åˆæˆåˆ†è§£æˆæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„éƒ¨åˆ†ã€‚</li>
<li>å¼‚æ­¥å‡†å¤‡ï¼šåœ¨ UI çœŸæ­£éœ€è¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šä¹‹å‰è¿›è¡Œåˆæˆå·¥ä½œï¼Œé€šå¸¸åˆ©ç”¨å¸§é—´çš„ç©ºé—²æ—¶é—´ã€‚</li>
</ol>


<p>è¿™ç§å¯ç»„åˆé¡¹çš„é¢„çƒ­æ„å‘³ç€ï¼Œå½“æŸä¸ªé¡¹ç›®æœ€ç»ˆæ»šåŠ¨åˆ°è§†å›¾ä¸­æ—¶ï¼Œå¤§éƒ¨åˆ†ç¹é‡çš„å·¥ä½œå·²ç»å®Œæˆï¼Œä½¿å…¶å‡ ä¹å¯ä»¥ç«‹å³æ˜¾ç¤ºã€‚</p>

<p>ä¸ºäº†ç›´è§‚åœ°ç†è§£è¿™ä¸€æ¦‚å¿µï¼Œè¯·è§‚çœ‹ä»¥ä¸‹åŠ¨ç”»ï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751997214840/f9f7308a-7b83-4a3d-9d38-e3ce6aa8d9a9.gif?auto=format,compress&amp;gif-q=60&amp;format=webm" alt="æ»šåŠ¨å¸§æ—¶é—´çº¿" /></p>

<p>æ»šåŠ¨å‘ç”Ÿæ—¶ï¼Œå‡è®¾é¡¹ç›® Aã€Bã€Cã€D å’Œ E å·²åœ¨å±å¹•ä¸Šå¯è§ï¼Œä¸‹ä¸€ä¸ªé¡¹ç›®æ˜¯ Fã€‚å¦‚æœé¡¹ç›® F çš„å¸ƒå±€æˆ–ç»“æ„å¤æ‚ï¼Œéœ€è¦æ›´å¤šæ—¶é—´è¿›è¡Œå¸ƒå±€è®¡ç®—æˆ–å…¶ä»–é¢„å¤„ç†æ‰èƒ½åœ¨ UI ä¸Šæ¸²æŸ“ï¼Œåˆ™æ­¤é¢„å¤„ç†å°†åœ¨å¸§æ—¶é—´è½´å†…åˆ†å—è¿›è¡Œï¼ˆä¾‹å¦‚ 16 æ¯«ç§’ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœå®ƒéœ€è¦ 2 å¸§ï¼Œåˆ™ F æ‰€éœ€çš„é¢„å¤„ç†ä¼šåœ¨ 2 å¸§çš„ç©ºé—²æ—¶é—´å†…å®Œæˆï¼Œä¸ä¼šé€ æˆä»»ä½•å¸§å¡é¡¿ã€‚æœ€åï¼Œå½“éœ€è¦æ˜¾ç¤ºæ—¶ï¼Œå®ƒä¼šè¢«ç»˜åˆ¶åˆ° UI ä¸Šã€‚é¡¹ç›® G å’Œ H ä¹Ÿé‡‡ç”¨ç›¸åŒçš„æµç¨‹ã€‚</p>

<h2>å·¥ä½œåŸç†ï¼šæ ¸å¿ƒç»„ä»¶</h2>

<p>é€šè¿‡æŸ¥çœ‹è¿è¡Œæ—¶æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸€äº›å…³é”®æ¥å£å’Œç±»æ¥å¤„ç†çš„ã€‚è™½ç„¶ä½ ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™äº› APIï¼Œä½†ç†è§£å®ƒä»¬å¯ä»¥æ­ç¤º LazyColumn çš„æ€§èƒ½æå‡ã€‚ğŸ•µï¸â€â™‚ï¸</p>

<h3>ç”Ÿå‘½å‘¨æœŸï¼šPausableComposition åŠå…¶æ§åˆ¶å™¨</h3>

<p>æ—…ç¨‹ä» PausableComposition æ¥å£å¼€å§‹ï¼Œè¯¥æ¥å£æ‰©å±•äº† ReusableComposition å¹¶æ·»åŠ äº†æš‚åœåŠŸèƒ½ã€‚</p>

<blockquote><p>å…³äº ReusableComposition çš„ç®€è¦è¯´æ˜ï¼š</p>

<p>åœ¨è®¨è®ºæš‚åœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ ReusableCompositionï¼Ÿå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„åˆï¼Œä¸“ä¸ºéœ€è¦é«˜æ•ˆå›æ”¶ UI å†…å®¹çš„é«˜æ€§èƒ½åœºæ™¯è€Œè®¾è®¡ã€‚æƒ³è±¡ä¸€ä¸‹ LazyColumn ä¸­çš„é¡¹ç›®ã€‚ReusableComposition ä¸ä¼šé”€æ¯æ»šåŠ¨åˆ°å±å¹•å¤–çš„é¡¹ç›®çš„æ•´ä¸ªç»„åˆï¼Œè€Œæ˜¯å…è®¸è¿è¡Œæ—¶åœç”¨å®ƒã€‚è¿™ä¼šä¿ç•™åº•å±‚ UI èŠ‚ç‚¹ï¼Œä½†ä¼šæ¸…é™¤å·²è®°ä½çš„çŠ¶æ€ã€‚ç„¶åï¼Œè¿™ä¸ªåœç”¨çš„ç»„åˆå¯ä»¥å¿«é€Ÿåœ°ç”¨æ–°å†…å®¹â€œé‡æ–°å¡«å……â€ï¼Œä»è€ŒèŠ‚çœäº†ä»å¤´åˆ›å»ºèŠ‚ç‚¹çš„æˆæœ¬ã€‚PausableComposition ç›´æ¥æ„å»ºäºè¿™ä¸ªå¼ºå¤§çš„å›æ”¶åŸºç¡€ä¹‹ä¸Šã€‚</p></blockquote>

<p>PausableComposition çš„å¤–è§‚å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=66
sealed interface PausableComposition : ReusableComposition {
    fun setPausableContent(content: @Composable () -&gt; Unit): PausedComposition
    fun setPausableContentWithReuse(content: @Composable () -&gt; Unit): PausedComposition
}
</code></pre>

<p>ï¼ˆæ³¨æ„ï¼šè¯¥æ¥å£æ˜¯å¯†å°çš„ï¼Œå› ä¸ºå®ƒä»…åœ¨ Compose è¿è¡Œæ—¶å†…éƒ¨å…·æœ‰ä¸€ç»„å°é—­ä¸”æœ‰é™çš„å®ç°ã€‚è¿™ä¸ºç¼–è¯‘å™¨æä¾›äº†æ›´å¤šä¿¡æ¯æ¥è¿›è¡Œä¼˜åŒ–ã€‚ï¼‰</p>

<p>è°ƒç”¨ setPausableContent ä¸ä¼šç«‹å³ç»„åˆç•Œé¢ã€‚ç›¸åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª PausedComposition å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å……å½“é€æ­¥è¿‡ç¨‹çš„æ§åˆ¶å™¨ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=112
sealed interface PausedComposition {
    val isComplete: Boolean
    fun resume(shouldPause: ShouldPauseCallback): Boolean
    fun apply()
    fun cancel()
}
</code></pre>

<p>è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæœ€å¥½ä»¥çŠ¶æ€æœºçš„å½¢å¼æ¥è¡¨ç¤ºï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751864148018/27512893-f186-47e7-9bdc-26036460aed7.png?auto=compress,format&amp;format=webp" alt="PausableCompositionç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾" /></p>

<ul>
<li>resume(shouldPause: ShouldPauseCallback)ï¼šè¿™æ˜¯å¼•æ“ã€‚é¢„å–ç³»ç»Ÿï¼ˆæ­¤å¤„æŒ‡ LazyColumn ä¸Šä¸‹æ–‡ï¼‰ä¼šåå¤è°ƒç”¨ resume() æ¥æ‰§è¡Œå¤§é‡çš„ç»„åˆå·¥ä½œã€‚ç¥å¥‡ä¹‹å¤„åœ¨äº shouldPause å›è°ƒã€‚Compose è¿è¡Œæ—¶ä¼šåœ¨ç»„åˆè¿‡ç¨‹ä¸­é¢‘ç¹è°ƒç”¨æ­¤ lambdaã€‚å¦‚æœå®ƒè¿”å› trueï¼ˆä¾‹å¦‚ï¼Œç”±äºå¸§æˆªæ­¢æ—¶é—´å·²è¿‘ï¼‰ï¼Œåˆ™ç»„åˆè¿‡ç¨‹å°†åœæ­¢ï¼Œå¹¶å°†ä¸»çº¿ç¨‹äº¤è¿˜ç»™æ›´é‡è¦çš„å·¥ä½œï¼Œä¾‹å¦‚ç»˜åˆ¶å½“å‰å¸§ã€‚</li>
<li>apply()ï¼šä¸€æ—¦ resume() è¿”å› trueï¼Œå³è¡¨ç¤ºæ“ä½œå®Œæˆï¼Œå°±ä¼šè°ƒç”¨ apply()ã€‚è¿™ä¼šè·å–æ‰€æœ‰è®¡ç®—å‡ºçš„ç•Œé¢æ›´æ”¹ï¼Œå¹¶å°†å…¶æäº¤åˆ°å®é™…çš„ç•Œé¢æ ‘ä¸­ã€‚</li>
<li>cancel()ï¼šå¦‚æœç”¨æˆ·æ»šåŠ¨ç¦»å¼€ï¼Œå¹¶ä¸”ä¸å†éœ€è¦é¢„å…ˆç»„åˆçš„é¡¹ç›®ï¼Œåˆ™ä¼šè°ƒç”¨ cancellation() æ¥ä¸¢å¼ƒå·¥ä½œå¹¶é‡Šæ”¾èµ„æºã€‚</li>
</ul>


<h3>å†…éƒ¨ç»“æ„æ¦‚è§ˆï¼šPausedCompositionImpl</h3>

<p>ä¸Šè¿°çŠ¶æ€æœºç”±å†…éƒ¨çš„ PausedCompositionImpl ç±»ç®¡ç†ã€‚è¯¥ç±»ä¿å­˜çŠ¶æ€å¹¶è¿æ¥æ‰€æœ‰éƒ¨åˆ†ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=202
internal class PausedCompositionImpl(...) : PausedComposition {
    private var state = PausedCompositionState.InitialPending
    internal val pausableApplier = RecordingApplier(applier.current)
    // ...

    override fun resume(shouldPause: ShouldPauseCallback): Boolean {
        when (state) {
            PausedCompositionState.InitialPending -&gt; {
                // This is the first time resume() is called.
                // It starts the initial composition of the content.
                invalidScopes =
                    context.composeInitialPaused(composition, shouldPause, content)
                state = PausedCompositionState.RecomposePending
                if (invalidScopes.isEmpty()) markComplete()
            }
            PausedCompositionState.RecomposePending -&gt; {
                // This is for subsequent calls to resume().
                state = PausedCompositionState.Recomposing
                // It tells the Composer to continue where it left off,
                // processing any pending invalidations.
                invalidScopes =
                    context.recomposePaused(composition, shouldPause, invalidScopes)
                state = PausedCompositionState.RecomposePending
                if (invalidScopes.isEmpty()) markComplete()
            }
            // ... other states like Recomposing, Applied, Cancelled are handled here ...
        }
        return isComplete
    }

    override fun apply() {
        // ... other state checks ...
        if (state == PausedCompositionState.ApplyPending) {
            applyChanges() // The call site
            state = PausedCompositionState.Applied
        }
        // ...
    }

    private fun applyChanges() {
        // ...
        pausableApplier.playTo(applier, rememberManager)
        rememberManager.dispatchRememberObservers()
        rememberManager.dispatchSideEffects()
        // ...
    }
}
</code></pre>

<p>è°ƒç”¨ resume() æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å…¶å†…éƒ¨çŠ¶æ€å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ï¼š</p>

<ul>
<li>InitialPendingï¼šé¦–æ¬¡è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.composeInitialPaused å¯åŠ¨åˆæˆè¿‡ç¨‹ã€‚è¿™ä¼šå‘ŠçŸ¥æ ¸å¿ƒ ComposerImpl å¼€å§‹æ‰§è¡Œ @Composable å†…å®¹ï¼Œå¹¶æ‰§è¡Œ shouldPause å›è°ƒã€‚</li>
<li>RecomposePendingï¼šåç»­è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.recomposePaused ç»§ç»­å·¥ä½œã€‚æ­¤æ–¹æ³•ç”¨äºå¤„ç†åˆæˆä¸­ä»»ä½•å› çŠ¶æ€å˜åŒ–è€Œå¤±æ•ˆçš„éƒ¨åˆ†ï¼Œæˆ–ç»§ç»­ä¹‹å‰æš‚åœçš„å·¥ä½œã€‚</li>
<li>Applierï¼šåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼ŒComposerImpl å°†æ‰€æœ‰ UI æ›´æ”¹æ“ä½œè½¬å‘ç»™ pausableApplierï¼ˆå³ RecordingApplierï¼‰ï¼Œè¯¥æ“ä½œä¼šè¿›è¡Œç¼“å†²ï¼Œè€Œä¸æ˜¯ç«‹å³åº”ç”¨ã€‚</li>
<li>æ­¤è¿‡ç¨‹æŒç»­è¿›è¡Œï¼Œç›´åˆ°å·¥ä½œå®Œæˆæˆ– shouldPause å›è°ƒè¿”å› trueã€‚</li>
</ul>


<h3>RecordingApplierï¼šæ¨è¿Ÿæœ€åçš„æ¶¦è‰²</h3>

<p>ä¸€ä¸ªå…³é”®çš„æ€§èƒ½æŠ€å·§æ˜¯ RecordingApplierã€‚è°ƒç”¨ resume() æ—¶ï¼ŒComposer ä¸ä¼šç›´æ¥æ›´æ”¹å®æ—¶ UI æ ‘ã€‚å¦‚æœåˆ†å°æ­¥æ‰§è¡Œï¼Œå¯èƒ½ä¼šå¾ˆæ…¢ï¼Œå¹¶å¯¼è‡´ UI æ›´æ–°ä¸å®Œæ•´ï¼Œæ˜¾å¾—æ€ªå¼‚ã€‚</p>

<p>PausableComposition ä½¿ç”¨çš„æ˜¯ RecordingApplierã€‚è¿™ä¸ªç‰¹æ®Šçš„ Applier ä¼šå°†å…¶åº”è¯¥æ‰§è¡Œçš„æ‰€æœ‰ UI æ“ä½œï¼ˆä¾‹å¦‚â€œåˆ›å»º Text èŠ‚ç‚¹â€ã€â€œè®¾ç½®å…¶æ–‡æœ¬å±æ€§â€æˆ–â€œæ·»åŠ å­å›¾åƒâ€ï¼‰è®°å½•åˆ°ä¸€ä¸ªå†…éƒ¨åˆ—è¡¨ä¸­ã€‚</p>

<p>åªæœ‰è°ƒç”¨ PausedComposition.apply() æ—¶ï¼ŒRecordingApplier æ‰ä¼šå°†å…¶è®°å½•çš„æ“ä½œåˆ—è¡¨â€œå›æ”¾â€åˆ°å®é™…çš„ Applier ä¸Šï¼Œä»è€Œé«˜æ•ˆåœ°å•æ­¥æ›´æ–° UI æ ‘ã€‚PausedComposition çš„å…¬å…± apply() æ–¹æ³•æ˜¯ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºå®ˆå«ã€‚çœŸæ­£çš„å·¥ä½œå‘ç”Ÿåœ¨å†…éƒ¨çš„ applyChanges() æ–¹æ³•ä¸­ï¼ˆå¦‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼‰ã€‚</p>

<p>å½“è°ƒç”¨ applyChanges æ—¶ï¼Œå®ƒä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‰é¡¹å…³é”®æ“ä½œï¼š</p>

<ul>
<li>å®ƒä¼šå‘Šè¯‰ RecordingApplier å°†å…¶æ‰€æœ‰ç¼“å†²çš„å‘½ä»¤æ’­æ”¾åˆ°å®é™…çš„ applier ä¸Šã€‚è¿™æ‰æ˜¯ UI çœŸæ­£å‡ºç°åœ¨å±å¹•ä¸Šçš„å…³é”®ã€‚</li>
<li>å®ƒä¼šä¸ºæ‰€æœ‰å·²åˆ›å»ºçš„ RememberObserversï¼ˆä¾‹å¦‚ DisposableEffectï¼‰è°ƒåº¦æ‰€æœ‰ onRemembered ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</li>
<li>æœ€åï¼Œå®ƒä¼šè¿è¡Œåœ¨åˆæˆè¿‡ç¨‹ä¸­æ’é˜Ÿçš„æ‰€æœ‰ SideEffectã€‚</li>
</ul>


<p>è¿™ç§æœ‰åºçš„æ‰¹å¤„ç†è¿‡ç¨‹ç¡®ä¿ UI é«˜æ•ˆæ›´æ–°ï¼Œå¹¶ä¸”æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½åœ¨æ­£ç¡®çš„æ—¶é—´å‘ç”Ÿã€‚</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751794209046/49f5c1c7-b424-4c7d-a017-8ba65bb7b2d3.png?auto=compress,format&amp;format=webp" alt="PausableCompositionæ—¶åºå›¾" /></p>

<h2>ä½¿ç”¨äº† PausableComposition çš„ LazyList</h2>

<p>LazyList å·²ç»å¼€å§‹ä½¿ç”¨ PausableComposition APIäº†ã€‚åœ¨ LazyList ä¸­ï¼ŒPausableComposition å¹¶éç‹¬ç«‹å·¥ä½œï¼Œè€Œæ˜¯ååŒå·¥ä½œçš„ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚</p>

<ul>
<li>æŒ‡æŒ¥å™¨ (Recomposer)ï¼šä¸» Recomposer è´Ÿè´£æ§åˆ¶èŠ‚å¥ï¼Œé©±åŠ¨å¯è§ UI çš„é€å¸§æ›´æ–°ã€‚</li>
<li>è§„åˆ’å™¨ (LazyLayoutPrefetchState)ï¼šå½“ç”¨æˆ·æ»šåŠ¨æ—¶ï¼Œæ­¤ç»„ä»¶ä¼šé¢„æµ‹å“ªäº›é¡¹ç›®å³å°†æ˜¾ç¤ºã€‚</li>
<li>èˆå°ç®¡ç†å™¨ (SubcomposeLayout)ï¼šè¿™ä¸ªå¼ºå¤§çš„ SubcomposeLayout æ˜¯ LazyList çš„åŸºç¡€ã€‚å®ƒçš„ SubcomposeLayoutState å¯ä»¥åœ¨éœ€è¦æ—¶ä¸ºå„ä¸ªé¡¹ç›®åˆ›å»ºå’Œç®¡ç†åˆæˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒæä¾›äº† createPausedPrecomposition() APIã€‚</li>
<li>èˆå°è°ƒåº¦å™¨ (PrefetchScheduler)ï¼šæ­¤è°ƒåº¦å™¨ä¼šåœ¨å¸§ä¹‹é—´å¯»æ‰¾ç©ºé—²æ—¶é—´æ¥æ‰§è¡Œè§„åˆ’å™¨è¯·æ±‚çš„é¢„åˆæˆå·¥ä½œã€‚</li>
</ul>


<p>äº†è§£æ­¤åŠŸèƒ½çš„å¼€å‘è¿‡ç¨‹ä¹Ÿå¾ˆæœ‰è¶£ã€‚åœ¨ LazyLayoutPrefetchState æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°æ§åˆ¶å®ƒçš„åŠŸèƒ½æ ‡å¿—ï¼š</p>

<pre><code class="Kotlin">// A simplified look inside LazyLayoutPrefetchState.kt: https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=647
if (ComposeFoundationFlags.isPausableCompositionInPrefetchEnabled) {
    // This is the future, modern path.
    performPausableComposition(key, contentType, average)
} else {
    // This is the older, non-pausable fallback.
    performFullComposition(key, contentType)
}
</code></pre>

<p>isPausableCompositionInPrefetchEnabled è¿™ä¸ªæ ‡å¿—å……å½“äº†ç»ˆæ­¢å¼€å…³çš„ä½œç”¨ã€‚è™½ç„¶å®ƒåœ¨æºä»£ç ä¸­çš„é»˜è®¤å€¼ä¸º falseã€‚å¦‚æœä½ æƒ³åœ¨æƒ°æ€§å¸ƒå±€ï¼ˆLazyColumnã€LazyRow ç­‰ï¼‰ä¸­å¯ç”¨å¯æš‚åœç»„åˆè¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŒ‰å¦‚ä¸‹æ–¹å¼å¯ç”¨å®ƒï¼š</p>

<pre><code class="Kotlin">class MyApplication : Application() {
    fun onCreate() {
        ComposeFoundationFlags.isPausableCompositionInPrefetchEnabled = true
        super.onCreate()
    }
}
</code></pre>

<h3>è§„åˆ’å™¨ï¼šLazyLayoutPrefetchState è¯¦è§£</h3>

<p>LazyLayoutPrefetchState æ˜¯é¢„å–æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„ä½œç”¨æ˜¯è·å–æ¥è‡ª LazyLayout çš„é¢„æµ‹ï¼ˆä¾‹å¦‚ï¼Œâ€œç¬¬ 25 é¡¹å³å°†ä¸Šçº¿â€ï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå®é™…çš„é¢„ç»„åˆä»»åŠ¡ã€‚</p>

<p>å®ƒé€šè¿‡ PrefetchHandleProvider å®ç°æ­¤æ“ä½œï¼Œè¯¥æä¾›è€…ä¼šåˆ›å»ºä¸€ä¸ª PrefetchRequestã€‚æ­¤è¯·æ±‚æ˜¯ PrefetchScheduler å¯ä»¥æ‰§è¡Œçš„å·¥ä½œå•å…ƒã€‚åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æš‚åœé€»è¾‘çš„æ ¸å¿ƒã€‚</p>

<p>å½“ PrefetchScheduler æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œå®ƒä¼šè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨ PausableComposition ä¸Šè°ƒç”¨ resume()ã€‚ä¼ é€’ç»™ resume çš„ lambda è¡¨è¾¾å¼å†³å®šæ˜¯å¦æš‚åœã€‚</p>

<p>å› æ­¤ï¼Œå¦‚æœå¯ç”¨äº†ä¸Šè¿°åŠŸèƒ½æ ‡è®°ï¼Œå®ƒå°†é€šè¿‡ Pausable Composition API æ‰§è¡Œè¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=754
// Simplified from HandleAndRequestImpl inside LazyLayoutPrefetchState
private fun PrefetchRequestScope.performPausableComposition(...) {
    val composition = // get the composition for the item of the LazyLayout 
    pauseRequested = false

    while (!composition.isComplete &amp;&amp; !pauseRequested) {
        composition.resume {
            if (!pauseRequested) {
                // 1. Update how much time is left in this frame's idle window.
                updateElapsedAndAvailableTime()

                // 2. Save how long this work chunk took, to improve future estimates.
                averages.saveResumeTimeNanos(elapsedTimeNanos)

                // 3. The Core Decision: Is there enough time left to do another
                //    chunk of work without risking a frame drop?
                pauseRequested = !shouldExecute(
                    availableTimeNanos,
                    averages.resumeTimeNanos + averages.pauseTimeNanos,
                )
            }
            // 4. Return the decision to the composition engine.
            pauseRequested
        }
    }

    updateElapsedAndAvailableTime()
    if (pauseRequested) {
        // If we decided to pause, record how long the final pause check took.
        averages.savePauseTimeNanos(elapsedTimeNanos)
    } else {
        // If we finished without pausing, record the time for the final resume chunk.
        averages.saveResumeTimeNanos(elapsedTimeNanos)
    }
}
</code></pre>

<p>è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼š</p>

<ol>
<li>updateElapsedAndAvailableTime()ï¼šåœ¨æ¢å¤ lambda å‡½æ•°å†…éƒ¨ï¼Œç³»ç»Ÿä¼šä¸æ–­æ£€æŸ¥è·ç¦»ä¸‹ä¸€å¸§éœ€è¦ç»˜åˆ¶è¿˜å‰©å¤šå°‘æ—¶é—´ã€‚</li>
<li>averages.saveResumeTimeNanos(&hellip;)ï¼šå®ƒä¼šè®°å½•æ¯ä¸ªå°å—åˆæˆå·¥ä½œæ‰€éœ€çš„æ—¶é—´ã€‚è¿™æœ‰åŠ©äºå®ƒæ„å»ºä¸€ä¸ªå¹³å‡å€¼ (averages) æ¥é¢„æµ‹æœªæ¥å·¥ä½œçš„æˆæœ¬ã€‚</li>
<li>!shouldExecute(&hellip;)ï¼šè¿™æ˜¯æ ¸å¿ƒå†³ç­–ã€‚å®ƒä¼šå°† availableTimeNanos ä¸é¢„ç®—è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªé¢„ç®—æ˜¯ä¸€ä¸ªæ™ºèƒ½ä¼°ç®—ï¼šå®Œæˆå¦ä¸€å—å·¥ä½œæ‰€éœ€çš„å¹³å‡æ—¶é—´åŠ ä¸Šæš‚åœæ‰€éœ€çš„å¹³å‡æ—¶é—´ã€‚å¦‚æœæ—¶é—´ä¸è¶³ï¼ŒpauseRequested ä¼šå˜ä¸º trueã€‚</li>
<li>æœ€ç»ˆè®¡æ—¶ï¼šåœ¨æœ¬æ¬¡å¾ªç¯é€€å‡ºåï¼ˆå› ä¸ºå·¥ä½œå®Œæˆæˆ–è¯·æ±‚æš‚åœï¼‰ï¼Œä¼šè°ƒç”¨æœ€åä¸€æ¬¡ updateElapsedAndAvailableTime()ã€‚è¿™ä¼šæ•è·æœ€åä¸€ä¸ªæ“ä½œçš„æ—¶é—´ã€‚</li>
<li>ä¿å­˜å¹³å‡å€¼ï¼šç„¶åç³»ç»Ÿä¼šä¿å­˜è¿™ä¸ªæœ€ç»ˆè®¡æ—¶ã€‚å¦‚æœè¯·æ±‚äº†æš‚åœï¼Œåˆ™å®ƒä¼šå½±å“ pauseTimeNanosã€‚å¦‚æœå¾ªç¯è‡ªç„¶å®Œæˆï¼Œåˆ™å®ƒä¼šå½±å“ resumeTimeNanosã€‚è¿™ç¡®ä¿äº†ç”¨äºæœªæ¥é¢„æµ‹çš„å†å²æ•°æ®å§‹ç»ˆå‡†ç¡®ã€‚</li>
</ol>


<p>è¿™ç§è‡ªæˆ‘è°ƒèŠ‚çš„åé¦ˆå¾ªç¯å…è®¸é¢„å–å™¨åœ¨ç³»ç»Ÿç©ºé—²æ—¶ä¿æŒç§¯æä¸»åŠ¨ï¼Œä½†åœ¨éœ€è¦æ¸²æŸ“ UI æ—¶åˆèƒ½ä¿æŒç¤¼è²Œï¼Œå°Šé‡ä¸»çº¿ç¨‹ã€‚</p>

<h3>æœ€åä¸€æ­¥ï¼šåº”ç”¨é¢„ç»„åˆ UI</h3>

<p>é‚£ä¹ˆï¼Œå½“å±å¹•ä¸ŠçœŸæ­£éœ€è¦é¢„ç»„åˆçš„é¡¹ç›®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè¿™æ—¶ SubcomposeLayout å°±å æ®äº†ä¸­å¿ƒä½ç½®ã€‚åœ¨æ­£å¸¸çš„æµ‹é‡è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä¸ºç°åœ¨å¯è§çš„é¡¹ç›®è°ƒç”¨å…¶ subcompose å‡½æ•°ã€‚åœ¨å†…éƒ¨ï¼Œè¿™ä¼šè§¦å‘æœ€åä¸€æ­¥ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/ui/ui/src/commonMain/kotlin/androidx/compose/ui/layout/SubcomposeLayout.kt;l=1186
// Simplified from LayoutNodeSubcompositionsState inside SubcomposeLayout.kt
private fun NodeState.applyPausedPrecomposition(shouldComplete: Boolean) {
    val pausedComposition = this.pausedComposition
    if (pausedComposition != null) {
        // 1. If the work must be completed now...
        if (shouldComplete) {
            // ...force the composition to finish by looping `resume`
            // and always passing `false` to the `shouldPause` callback.
            while (!pausedComposition.isComplete) {
                pausedComposition.resume { false }
            }
        }
        // 2. Apply the changes to the real UI tree.
        pausedComposition.apply()
        this.pausedComposition = null // Clear the handle.
    }
}
</code></pre>

<p>å½“æŸä¸ªé¡¹ç›®å¯è§æ—¶ï¼Œå…¶ç»„åˆä¸å†æ˜¯ä½ä¼˜å…ˆçº§çš„åå°ä»»åŠ¡ï¼Œè€Œæ˜¯é«˜ä¼˜å…ˆçº§çš„åŒæ­¥ä»»åŠ¡ã€‚shouldComplete = true å‚æ•°ç¡®ä¿æ‰€æœ‰å‰©ä½™çš„ç»„åˆå·¥ä½œç«‹å³å®Œæˆï¼Œæ— éœ€æš‚åœã€‚ç„¶åï¼Œapply() è¢«è°ƒç”¨ï¼Œå®Œæ•´çš„ UI ä¼šç«‹å³æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>

<p>å®ƒä»¬å¦‚ä½•ååŒå·¥ä½œï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751799217100/82837ef0-e97e-49c7-bee6-cd68ab1804ba.png?auto=compress,format&amp;format=webp" alt="LazyListæ»šåŠ¨æ—¶åºå›¾" /></p>

<h2>ç»“è®º</h2>

<p>æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶åï¼ŒPausableComposition çš„è®¾è®¡å ªç§°æ€§èƒ½å·¥ç¨‹çš„æ°ä½œã€‚</p>

<ul>
<li>å®ƒå¹¶éé­”æ³•ï¼Œè€Œæ˜¯å»¶è¿Ÿï¼šå…¶æ ¸å¿ƒç†å¿µæ˜¯åœ¨ç´§æ€¥ä»»åŠ¡ä¹‹å‰å®Œæˆã€‚é€šè¿‡åœ¨ç©ºé—²æ—¶é—´åˆæˆé¡¹ç›®ï¼Œå¿«é€Ÿæ»šåŠ¨æ—¶ä¸»çº¿ç¨‹æ‰€éœ€çš„å·¥ä½œé‡ä¼šå¤§å¤§å‡å°‘ã€‚</li>
<li>åä½œå¼å’Œéé˜»å¡å¼ï¼šshouldPause å›è°ƒæ˜¯å¤„ç†å¤šä»»åŠ¡çš„ç»ä½³æ–¹å¼ã€‚å®ƒå¯ä»¥è®©é•¿æ—¶é—´è¿è¡Œçš„åˆæˆä»»åŠ¡ä¼˜é›…åœ°è®©ä½äºæ›´ç´§æ€¥çš„å½“å‰å¸§æ¸²æŸ“ä»»åŠ¡ï¼Œä»è€Œç›´æ¥é˜²æ­¢å¡é¡¿ã€‚</li>
<li>é€šè¿‡æ‰¹å¤„ç†æé«˜æ•ˆç‡ï¼šRecordingApplier é€šè¿‡å°† UI æ ‘ä¸­çš„è®¸å¤šå°çš„ç‹¬ç«‹æ›´æ”¹åˆ†ç»„ä¸ºå•ä¸ªé«˜æ•ˆçš„æ›´æ–°ï¼Œé¿å…äº†è¿™äº›æ›´æ”¹å¸¦æ¥çš„å¼€é”€ã€‚</li>
</ul>


<p>è™½ç„¶ PausableComposition æ˜¯ä¸€ä¸ªä½ å¯èƒ½æ°¸è¿œä¸ä¼šç›´æ¥ä½¿ç”¨çš„å†…éƒ¨åŠŸèƒ½ï¼Œä½†äº†è§£å®ƒçš„å­˜åœ¨å’Œè¿ä½œæ–¹å¼ï¼Œå¯ä»¥è®©ä½ çœŸæ­£ä½“ä¼šåˆ° Jetpack Compose å¦‚æ­¤é«˜æ€§èƒ½çš„æ˜æ™ºå†³ç­–ã€‚ä¸‹æ¬¡ä½ è½»æ¾æµç•…åœ°æ»šåŠ¨æµè§ˆå¤æ‚çš„ LazyColumn æ—¶ï¼Œä½ å°±ä¼šä½“ä¼šåˆ°è¿™å·§å¦™ä¸”ç²¾å¿ƒç¼–æ’çš„â€œèˆè¹ˆâ€æ˜¯å¦‚ä½•åœ¨è¡¨é¢ä¹‹ä¸‹è¿›è¡Œçš„ã€‚âœ… è¿™ç§æ¶æ„ä¸ä»…è§£å†³äº†å½“å‰çš„æ€§èƒ½æŒ‘æˆ˜ï¼Œè¿˜ä¸º Compose æœªæ¥æ›´å…ˆè¿›çš„æ¸²æŸ“ç­–ç•¥é“ºå¹³äº†é“è·¯ã€‚</p>

<p>å¸Œæœ›ä½ å·²ç»äº†è§£äº†è¿™ä¸ªæ–° API åœ¨ Jetpack Compose ä¸­çš„å·¥ä½œåŸç†ã€‚</p>

<p>å¤ªæ£’äº†ï¼å¸Œæœ›ä½ ä»ä¸­è·å¾—äº†ä¸€äº›å®è´µçš„è§è§£ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº« ğŸ˜‰ï¼Œå› ä¸ºâ€¦â€¦</p>

<p>â€œåˆ†äº«å³å…³çˆ±â€</p>

<p>è°¢è°¢ï¼ğŸ˜„</p>

<p>è®©æˆ‘ä»¬ä¸€èµ·å›é¡¾ X ï¼ˆé“¾æ¥ï¼š<a href="https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF">https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF</a> ğŸ˜ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SnapshotFlowè¿˜æ˜¯collectAsStateï¼Ÿå¯¹äºJetpack Composeæ¥è¯´å“ªä¸ªæ›´é¦™ï¼Ÿ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"/>
    <updated>2025-07-16T22:31:22+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒSnapshotFlow or collectAsState? How to pick the right tool for Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123">https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123</a>ï¼Œç”±Dmitry Glazunovå‘å¸ƒäº2025å¹´7æœˆ7æ—¥ã€‚</p>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P0darOG2IeBIDWdY" title="auto auto" ></a></p>

<!-- more -->


<p>æ„å»º UI å¯èƒ½æ„Ÿè§‰å¾ˆç®€å•ï¼Œç›´åˆ°éœ€è¦è®¢é˜…çŠ¶æ€å˜åŒ–å¹¶æœ‰æ•ˆå¤„ç†å‰¯ä½œç”¨æ—¶ä¹‹å‰ã€‚è®¸å¤šå¼€å‘è€…è¿‡åº¦ä½¿ç”¨ collectAsStateï¼Œå¯¼è‡´å»¶è¿Ÿå’Œæ„å¤–çš„é‡ç»„ï¼ˆreCompositionï¼‰ã€‚è¿˜æœ‰ä¸€äº›äººå¬è¯´è¿‡ snapshotFlowï¼Œä½†å´ä¸å¤ªæ˜ç™½æ—¢ç„¶ StateFlow å’Œ collectAsState å·²ç»å­˜åœ¨ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å®ƒï¼Ÿ</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†é€šè¿‡æ¢ç´¢å®é™…é¡¹ç›®ä¸­ç®€çŸ­ä¸”å®ç”¨çš„ç¤ºä¾‹ï¼Œåˆ†äº«æˆ‘å¯¹ä½•æ—¶ä½¿ç”¨ snapshotFlow ä»¥åŠä½•æ—¶æ›´é€‚åˆä½¿ç”¨ collectAsState çš„çœ‹æ³•ï¼Œå¸®åŠ©ä½ é¿å…é¡¹ç›®ä¸­éšè—çš„ bug å’Œæ€§èƒ½é—®é¢˜ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>

<h2>collectAsState çš„ä½œç”¨</h2>

<p>collectAsState åœ¨ Compose ä¸­è®¢é˜… Flowï¼Œå¹¶è‡ªåŠ¨å°†å…¶å…¬å¼€ä¸ºStateï¼Œä»¥ä¾¿åœ¨ UI ä¸­è½»æ¾æ˜¾ç¤ºï¼š</p>

<pre><code class="Kotlin">val uiState by viewModel.uiStateFlow.collectAsState()
Text(uiState.text)
</code></pre>

<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸æ˜“äºä½¿ç”¨ã€‚</li>
<li>é‡ç»„æ—¶è‡ªåŠ¨å–æ¶ˆå¹¶é‡æ–°å¼€å§‹æ”¶é›†ã€‚</li>
<li>éå¸¸é€‚åˆ ViewModel â†’ UI æ•°æ®ç»‘å®šã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>æ¯æ¬¡å‘å‡ºæ–°æ•°æ®æ—¶éƒ½ä¼šè§¦å‘é‡ç»„ï¼Œå“ªæ€•åªæ˜¯å‘ç”Ÿäº†å¾®å°çš„å˜åŒ–ã€‚</li>
<li>å¯ç»„åˆé¡¹è¿›å…¥é‡ç»„çŠ¶æ€åç«‹å³å¼€å§‹æ”¶é›†ã€‚</li>
<li>ä¸é€‚ç”¨äºè§‚å¯Ÿ Compose ç‰¹æœ‰çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ»šåŠ¨æˆ–æ‰‹åŠ¿ã€‚</li>
</ul>


<h2>å¿«ç…§æµ (snapshotFlow) çš„ä½œç”¨</h2>

<p>å¿«ç…§æµ (snapshotFlow) å°† Compose çŠ¶æ€ï¼ˆä¾‹å¦‚ LazyListState ã€ derivedStateOf ï¼‰è½¬æ¢ä¸ºå†·æµ (cold Flow)ï¼Œè®©ä½ æ— éœ€è¿›è¡Œä¸å¿…è¦çš„é‡ç»„å³å¯å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”ï¼š</p>

<pre><code class="Kotlin">val listState = rememberLazyListState()

LaunchedEffect(Unit) {
    snapshotFlow { listState.firstVisibleItemIndex }
        .distinctUntilChanged()
        .collect { index -&gt;
            analytics.logScrollPosition(index)
        }
}
</code></pre>

<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸é€‚åˆ Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ã€‚</li>
<li>ä¸ä¼šè§¦å‘é‡ç»„ã€‚</li>
<li>å¯åœ¨ LaunchedEffect æˆ–åç¨‹ä¸­ä½¿ç”¨ã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>ä¸ä¼šå…¬å¼€çŠ¶æ€ä»¥è¿›è¡Œç›´æ¥ UI æ¸²æŸ“ã€‚</li>
<li>ä¸ä¼šæ›¿ä»£ CollectAsState æ¥å®ç° ViewModel â†’ UI æ›´æ–°ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ collectAsState</h2>

<ul>
<li>ä» ViewModel è®¢é˜… UI çš„ Flow æˆ– StateFlowã€‚</li>
<li>åœ¨ UI ä¸­æ˜¾ç¤ºæ•°æ®ï¼ˆæ–‡æœ¬ã€åŠ è½½çŠ¶æ€ã€è·å–çš„æ•°æ®ï¼‰ã€‚</li>
<li>ç”¨æˆ·éœ€è¦çœ‹åˆ°çš„ä½é¢‘æ›´æ–°ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>é«˜é¢‘æ›´æ–°ï¼ˆæ»šåŠ¨åç§»ã€ä¼ æ„Ÿå™¨æ•°æ®ï¼‰ã€‚</li>
<li>è§¦å‘ä¸éœ€è¦ UI æ›´æ–°çš„å‰¯ä½œç”¨ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ snaphotFlow</h2>

<ul>
<li>å“åº” Compose çŠ¶æ€ï¼ˆæ»šåŠ¨ã€æ‰‹åŠ¿ã€åŠ¨ç”»ï¼‰ã€‚</li>
<li>è§¦å‘å‰¯ä½œç”¨ä½†ä¸ä¼šå¯¼è‡´é‡ç»„ã€‚</li>
<li>ä» Compose çŠ¶æ€æ„å»º Flow ç®¡é“ï¼ˆåˆ†æã€å»¶è¿ŸåŠ è½½è§¦å‘å™¨ï¼‰ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>ç›´æ¥ UI æ•°æ®æ¸²æŸ“ã€‚</li>
<li>ç”¨ viewModel â†’ UI æµæ›¿æ¢ collectAsStateã€‚</li>
</ul>


<h2>snapshotFlow çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šä½¿ç”¨ snaphotFlow.collectAsState è¿›è¡ŒåŠ¨ç”»è¿›åº¦</p>

<pre><code class="Kotlin">val progress by snapshotFlow { animationState.progress }
    .collectAsState(initial = 0f)

Text("Progress: ${(progress * 100).toInt()}%")
</code></pre>

<p>ä½¿ç”¨ snaphotFlow å’Œ collectAsState æ¥é©±åŠ¨åŠ¨ç”»è¿›åº¦çš„ UI æ›´æ–°ä¼šå¯¼è‡´æ¯ä¸€å¸§éƒ½é‡æ–°åˆæˆï¼Œä»è€Œå¯¼è‡´å¡é¡¿ï¼Œè¿èƒŒäº† snaphotFlow çš„åˆè¡·ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ snaphotFlow åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¿›è¡Œåˆ†æ</p>

<pre><code class="Kotlin">LaunchedEffect(Unit) {
    snapshotFlow { animationState.progress }
        .distinctUntilChanged { old, new -&gt;
            (old * 100).toInt() == (new * 100).toInt()
        }
        .collect { progress -&gt;
            analytics.logAnimationProgress(progress)
        }
}
</code></pre>

<p>è¿™ä¼šè·Ÿè¸ªåŠ¨ç”»è¿›åº¦ï¼Œä»¥ä¾¿è¿›è¡Œåˆ†ææˆ–è®°å½•ï¼Œè€Œä¸ä¼šè§¦å‘ UI é‡æ„ã€‚</p>

<h2>collectAsState çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šå°† collectAsState ç”¨äºé«˜é¢‘æ»šåŠ¨æ•°æ®</p>

<pre><code class="Kotlin">val scrollOffset by viewModel.scrollOffsetFlow.collectAsState()
Text("Offset: $scrollOffset")
</code></pre>

<p>è¿™ä¼šåœ¨æ»šåŠ¨çš„æ¯ä¸ªåƒç´ ä¸Šè§¦å‘é‡æ–°åˆæˆï¼Œå¯¼è‡´ CPU è¿‡è½½ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ collectAsState è·å–æœ‰æ„ä¹‰çš„ UI æ•°æ®</p>

<pre><code class="Kotlin">val userName by viewModel.userNameFlow.collectAsState()
Text("Hello, $userName!")
</code></pre>

<p>è¿™é€‚ç”¨äºæ˜¾ç¤ºç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸”ä¸ç»å¸¸æ›´æ”¹çš„æ•°æ®ã€‚</p>

<h2>ç»“è®º</h2>

<p>collectAsState å’Œ snapshotFlow ç›¸è¾…ç›¸æˆï¼š</p>

<ul>
<li>ä½¿ç”¨ collectAsState åœ¨ UI ä¸­æ˜¾ç¤º ViewModel æ•°æ®ã€‚</li>
<li>ä½¿ç”¨ snapshotFlow å“åº” Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ï¼Œè€Œæ— éœ€è§¦å‘é‡ç»„ã€‚</li>
</ul>


<p>æ­£ç¡®ä½¿ç”¨å®ƒä»¬å°†å¸®åŠ©ä½ é¿å…ä¸å¿…è¦çš„é‡ç»„ï¼Œæå‡åº”ç”¨çš„å“åº”é€Ÿåº¦ï¼Œå¹¶ä¿æŒ Compose ä»£ç ç®€æ´ã€å¯æ‰©å±•ä¸”å¯é¢„æµ‹ã€‚</p>

<p>å¦‚æœä½ è§‰å¾—æœ¬æ–‡åˆ†ææœ‰ç”¨ï¼Œè¯·éšæ—¶å…³æ³¨æˆ‘ä»¥è·å–æ›´å¤šè§è§£ã€‚</p>
]]></content>
  </entry>
  
</feed>
