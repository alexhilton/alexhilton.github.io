<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Compose | ç¨€æœ‰çŒ¿è¯‰]]></title>
  <link href="https://alexhilton.github.io/blog/categories/compose/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2025-08-01T21:29:31+08:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[å­¦ä¼šç”¨æœ€ä¼˜é›…çš„å§¿å¼åœ¨Composeä¸­æ˜¾ç¤ºå¯Œæ–‡æœ¬]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose/"/>
    <updated>2025-07-30T22:50:40+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒStyledString: A Better Pattern for Rich Text in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1">https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1</a>ï¼Œç”±Eury PÃ©rez BeltrÃ©å‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NS_T-i72tS5eOs5F0f_Tnw.png" title="auto auto" ></a></p>

<!-- more -->


<p>åœ¨ Jetpack Compose ä¸­è®¾ç½®æ–‡æœ¬æ ·å¼çœ‹ä¼¼ç®€å•â€¦â€¦ä½†å…¶å®ä¸ç„¶ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ AnnotatedString çš„å±€é™æ€§ï¼Œä»¥åŠ StyledString å¦‚ä½•è®©å¯Œæ–‡æœ¬æ›´æ˜“äºç®¡ç†ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚ğŸ‘‡</p>

<h2>ğŸ“š ç›®å½•</h2>

<ol>
<li>å¼•è¨€ï¼šä¸€ä¸ªç²—ä½“å­—ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</li>
<li>AnnotatedStringï¼šæ ·å¼è¿‡å¤šï¼Œç®€æ´æ€§ä¸è¶³</li>
<li>StyledString ç®€ä»‹ï¼šä¸€ä¸ª API å³å¯è®¾ç½®æ‰€æœ‰æ ·å¼</li>
<li>StyledString åº•å±‚åŸç†ï¼šAPI èƒŒåçš„å¼•æ“</li>
<li>ç»“è¯­</li>
</ol>


<h2>å¼•è¨€ï¼šä¸€ä¸ªåŠ ç²—çš„å•è¯ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</h2>

<p>ä¸€å¼€å§‹ï¼Œä½ æ‹¥æœ‰äº† AnnotatedString å’Œä¸€ä¸ª SpanStyle ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆé¡ºç•…ã€‚ä½ æƒ³åŠ ç²—ä¸€ä¸ªå•è¯ï¼Ÿå¾ˆç®€å•âœ…ã€‚ç»™æŸä¸ªä¸œè¥¿åŠ ä¸‹åˆ’çº¿ï¼Ÿæ²¡é—®é¢˜ã€‚è¿™ç”šè‡³æ„Ÿè§‰æœ‰ç‚¹æœ‰è¶£ï¼Œå°¤å…¶æ˜¯åœ¨ä½ åƒ<a href="https://developer.android.com/develop/ui/compose/text/style-text#multiple-styles">å®˜æ–¹æ–‡æ¡£</a>ä¸­é‚£æ ·æ‰‹åŠ¨æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ã€‚</p>

<p>ä½†é—®é¢˜æ˜¯ï¼šğŸ§ </p>

<p>å½“ä½ å®Œå…¨æ§åˆ¶å­—ç¬¦ä¸²æ—¶ï¼Œè¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆã€‚ä½†å½“ä½ å¤„ç†å®é™…å†…å®¹ï¼šåŠ¨æ€å‰¯æœ¬ã€æœ¬åœ°åŒ–æ–‡æœ¬ã€ä»å…¶ä»–åœ°æ–¹ä¼ å…¥çš„æ®µè½ï¼Œè€Œä½ åªéœ€è¦è®¾ç½®å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ ·å¼æ—¶ï¼Ÿ</p>

<p>äº‹æƒ…å¾ˆå¿«å°±å˜å¾—å¾ˆç³Ÿç³•ã€‚</p>

<p>çªç„¶é—´ï¼Œä½ éœ€è¦è·Ÿè¸ªå­å­—ç¬¦ä¸²ã€è®¡ç®—ç´¢å¼•ã€åº”ç”¨æ ·å¼ï¼Œå¹¶è¿æ¥ç‚¹å‡»ç›‘å¬å™¨ã€‚åªéœ€å¯¹æ–‡æœ¬è¿›è¡Œä¸€æ¬¡æ›´æ”¹ï¼Œä½ çš„é€»è¾‘å°±ä¼šåƒçº¸ç‰Œå±‹ä¸€æ ·å´©æºƒã€‚ğŸƒ</p>

<p>ä½ åŸæœ¬æƒ³è¦çš„åªæ˜¯åŠ ç²—ä¸€ä¸ªå•è¯å¹¶è®©é“¾æ¥å¯ç‚¹å‡»ã€‚ç°åœ¨ä½ æ·±é™·äºæ ·æ¿ä»£ç ä¸­ï¼Œç¥ˆç¥·ä¸€åˆ‡éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šä¸ºä»€ä¹ˆ AnnotatedString åœ¨å®é™… UI ä¸­æ— æ³•å¾ˆå¥½åœ°æ‰©å±•ï¼Œå¹¶ä»‹ç»ä¸€ä¸ªæˆ‘ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæ„å»ºçš„å¾®å‹æŠ½è±¡ã€‚å®ƒå«åš StyledStringï¼Œå®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼šğŸ’¡ å®ƒç¡®å®åšåˆ°äº†ï¼š</p>

<p><strong>è®©Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚</strong></p>

<h2>AnnotatedStringï¼šæ ·å¼å¤ªå¤šï¼Œç®€æ´æ€§ä¸è¶³</h2>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç§°èµä¸€ä¸‹ AnnotatedStringã€‚å®ƒæ˜¯ä¸€æ¬¾å¼ºå¤§çš„å·¥å…·ğŸ’ª.</p>

<p>ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª Text å¯ç»„åˆé¡¹æ¥åˆ›å»ºå¸¦æ ·å¼ã€å¯ç‚¹å‡»ã€å¯äº¤äº’çš„æ–‡æœ¬ã€‚æƒ³è¦è®©ä¸€ä¸ªå•è¯åŠ ç²—ï¼Œå¦ä¸€ä¸ªå•è¯åƒé“¾æ¥ä¸€æ ·æ˜¾ç¤ºï¼Ÿå®Œå…¨å¯ä»¥ã€‚è¯¥ API çµæ´»ã€åº•å±‚ï¼Œå¹¶ä¸”ç”± Compose æœ¬èº«çš„å¯Œæ–‡æœ¬å¼•æ“æ”¯æŒã€‚</p>

<p>é—®é¢˜æ˜¯ï¼Œå®ƒåªæœ‰<strong>åœ¨æ‰‹åŠ¨</strong>æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²æ—¶æ‰èƒ½å‘æŒ¥æœ€ä½³æ•ˆæœã€‚</p>

<p>æ–‡æ¡£ä¸­çš„å¤§å¤šæ•°ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="Kotlin">buildAnnotatedString {
    append("Hello ")
    withStyle(style = SpanStyle(fontWeight = FontWeight.Bold)) {
        append("world")
    }
}
</code></pre>

<p>çœ‹èµ·æ¥ä¸é”™ï¼Œå¯¹å§ï¼Ÿä½†æ£˜æ‰‹çš„åœ°æ–¹å°±åœ¨è¿™é‡Œã€‚ğŸ‘€</p>

<p>å¦‚æœä½ æœ‰ä¸€æ•´æ®µåŠ¨æ€æ–‡æœ¬ï¼Œæ¯”å¦‚ä¸€æ®µæœ¬åœ°åŒ–çš„å­—ç¬¦ä¸²æˆ–ä¸€ä¸ªä»å…¶ä»–åœ°æ–¹æ‹‰å–çš„å¥å­ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>

<p>ç°åœ¨ä½ éœ€è¦å¤„ç†ï¼š</p>

<ul>
<li>æŸ¥æ‰¾è¦æ·»åŠ æ ·å¼çš„å­å­—ç¬¦ä¸²</li>
<li>è®¡ç®—èµ·å§‹å’Œç»“æŸç´¢å¼•</li>
<li>æ‰‹åŠ¨æ·»åŠ æ ·å¼æˆ–æ³¨é‡Š</li>
<li>å¸Œæœ›æ–‡æœ¬æ°¸è¿œä¸å˜ï¼Œå¦åˆ™ä¸€åˆ‡éƒ½ä¼šå´©æºƒã€‚</li>
</ul>


<p>å¦‚æœä½ éœ€è¦å¤šç§æ ·å¼ï¼Œæ¯”å¦‚ç²—ä½“å•è¯ã€å¯ç‚¹å‡»çš„ç”µå­é‚®ä»¶å’Œå¸¦ä¸‹åˆ’çº¿çš„ URLï¼ŒåŠ¨æ€åœ°ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—æ··ä¹±ã€‚ğŸ”¥
è¿™æ—¶ï¼ŒbuildAnnotatedString å°±ä¼šå˜æˆä¸€å †è„†å¼±çš„ç´¢å¼•æ•°å­¦è¿ç®—ã€é‡å¤çš„é€»è¾‘å’Œæ ·æ¿ä»£ç ï¼Œéš¾ä»¥é˜…è¯»ï¼Œæ›´éš¾ä»¥ç»´æŠ¤ã€‚</p>

<p>å½“ç„¶ï¼ŒAnnotatedString åŠŸèƒ½å¼ºå¤§ã€‚ä½†å½“ä½ çš„æ–‡æœ¬æ˜¯åŠ¨æ€çš„ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼æ—¶ï¼Ÿå®ƒå¾ˆå¿«å°±ä¼šå˜å¾—ç´¢ç„¶æ— å‘³ã€‚</p>

<h2>StyledString éš†é‡å‡ºåœºï¼šä¸€ä¸ª API å³å¯å®ç°æ‰€æœ‰æ ·å¼</h2>

<p>åœ¨ä¸ AnnotatedString çº ç»“äº†æ— æ•°æ¬¡ä¹‹åï¼Œæˆ‘å†³å®šæ„å»ºä¸€ä¸ªæ›´å¥½çš„ä¸œè¥¿ã€‚å®ƒå¹¶éä¸€ä¸ªåºå¤§çš„åº“ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ·å¼æ¡†æ¶ã€‚è€Œæ˜¯ä¸€ä¸ªç®€å•ã€å…¼å®¹ Compose çš„æŠ½è±¡ï¼Œç”¨äºè§£å†³ä¸€ä¸ªéå¸¸å…·ä½“çš„é—®é¢˜ã€‚</p>

<p><strong>StyledString æ¥å•¦ï¼ğŸ‘‹</strong></p>

<p>å®ƒçš„ç›®æ ‡å¾ˆç®€å•ï¼šè®©ä½ å®šä¹‰å­—ç¬¦ä¸²çš„å“ªäº›éƒ¨åˆ†åº”è¯¥è¢«è®¾ç½®æ ·å¼æˆ–å¯ç‚¹å‡»ï¼Œè€Œæ— éœ€æ‹…å¿ƒ indexOf ã€ addStyle æˆ– AnnotatedString.Builder ã€‚ä½ åªéœ€ç¼–å†™æ–‡æœ¬ï¼Œå‘Šè¯‰å®ƒéœ€è¦è®¾ç½®å“ªäº›å•è¯çš„æ ·å¼ï¼Œä»¥åŠç‚¹å‡»åè¯¥æ‰§è¡Œçš„æ“ä½œã€‚</p>

<p>å®ƒçš„å®é™…æ•ˆæœå¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">// This list can be built in the ViewModel
val styledStrings = persistentListOf(
    StyledString.ClickableEmail(
        highlightedText = "support@example.com",
        email = "support@example.com",
        style = SpanStyle(
            color = Color.Blue,
            textDecoration = TextDecoration.Underline
        )
    ),
    StyledString.ClickableUrl(
        highlightedText = "website",
        url = "https://euryperez.dev",
        style = SpanStyle(
            color = Color.Blue,
            textDecoration = TextDecoration.Underline
        )
    )
)

// In your Compose Screen
StyledText(
    fullText = "Contact us at support@example.com or visit our website",
    styledStrings = styledStrings,
    style = MaterialTheme.typography.label,
    onClick = { styled -&gt;
        when (styled) {
            is ClickableEmail -&gt; openEmailClient(styled.email)
            is ClickableUrl -&gt; openUrl(styled.url)
        }
    }
)
</code></pre>

<p>å°±æ˜¯è¿™æ ·ã€‚æ— éœ€æ‰‹åŠ¨æ„å»ºæ–‡æœ¬ï¼Œæ— éœ€ç´¢å¼•è®¡ç®—ï¼Œæ— éœ€æ ·æ¿ä»£ç ã€‚åªéœ€ç®€æ´ã€æ˜“è¯»ã€å£°æ˜å¼çš„æ ·å¼ï¼Œå³å¯ä¸çœŸå®æ–‡æœ¬å…¼å®¹ã€‚</p>

<p>ç”±äº StyledString æ”¯æŒ Simple ã€ ClickableEmail å’Œ ClickableUrl ç­‰ç±»å‹ï¼Œå› æ­¤å®ƒæ˜“äºåœ¨ä½ çš„åº”ç”¨ä¸­æ‰©å±•å’Œå¤ç”¨ã€‚ä½ å¯ä»¥è·å¾—å¯ç‚¹å‡»çš„ã€å¸¦æ ·å¼çš„æ–‡æœ¬ï¼Œè€Œæ— éœ€ç‰ºç‰²å…¶åˆç†æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ğŸ™</p>

<h2>StyledString çš„åº•å±‚ï¼šAPI èƒŒåçš„å¼•æ“</h2>

<p>è®©æˆ‘ä»¬æ­å¼€å®ƒçš„é¢çº±ï¼Œé€æ­¥äº†è§£ StyledString çš„å·¥ä½œåŸç†ã€‚ğŸª„</p>

<p>å½“ä½ åœ¨ UI ä¸­ä½¿ç”¨ StyledText æ—¶ï¼ŒğŸ§ å®ƒå¯èƒ½æ„Ÿè§‰åƒé­”æ³•ä¸€æ ·ç¥å¥‡ï¼Œä½†åœ¨å¹•åï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€æ´ã€æ˜“äºç»„åˆçš„æ¶æ„ï¼Œæ—¨åœ¨å‡å°‘æ ·å¼è®¾è®¡çš„ç—›è‹¦ï¼Œè€Œä¸ä¼šå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚</p>

<p>æœ¬èŠ‚æ¶µç›–äº† StyledString ç³»ç»Ÿçš„æ¯ä¸ªéƒ¨åˆ†ï¼Œä»æ ·å¼çš„æè¿°æ–¹å¼ï¼Œåˆ°æ ·å¼çš„æŸ¥æ‰¾ã€åº”ç”¨å’Œåœ¨å±å¹•ä¸Šæ¸²æŸ“ã€‚</p>

<h3>ğŸ§± 1. æ•°æ®æ¨¡å‹ï¼šStyledString å’Œ ClickableStyleString</h3>

<p>æ•´ä¸ªå®ç”¨ç¨‹åºçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º StyledString çš„å¯†å°æ¥å£ã€‚æˆ‘ä»¬é€šè¿‡å®ƒæ¥å¯¹éœ€è¦ä»¥æŸç§æ–¹å¼è®¾ç½®æ ·å¼çš„æ–‡æœ¬ç‰‡æ®µè¿›è¡Œå»ºæ¨¡ã€‚</p>

<pre><code class="Kotlin">@Immutable
sealed interface StyledString {
    val highlightedText: String
    val style: SpanStyle

    // Add `Simple` type

    // Add `ClickableEmail` type

    // Add `ClickableUrl` type
}
</code></pre>

<p>æ¯ä¸ª StyledString éƒ½éœ€è¦ä¸¤æ¡ä¿¡æ¯ï¼š</p>

<ul>
<li>highlightedTextï¼šéœ€è¦è®¾ç½®æ ·å¼çš„æ–‡æœ¬çš„ç¡®åˆ‡éƒ¨åˆ†</li>
<li>styleï¼šå®šä¹‰å…¶å¤–è§‚çš„ SpanStyleï¼ˆé¢œè‰²ã€ä¸‹åˆ’çº¿ã€å­—ä½“ç²—ç»†ç­‰ï¼‰ã€‚</li>
</ul>


<p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€äº›å®ç°æ­¤æ¥å£çš„ç‰¹å®šç±»å‹ï¼š</p>

<pre><code class="Kotlin">@Immutable
data class Simple(
    override val highlightedText: String,
    override val style: SpanStyle,
) : StyledString
</code></pre>

<p>è¿™ä¸ªæ˜¯çº¯è§†è§‰æ•ˆæœçš„ï¼Œå®ƒä¼šæ”¹å˜æ–‡æœ¬çš„å¤–è§‚ï¼Œä½†ä¸å“åº”ç‚¹å‡»ã€‚</p>

<p>ç„¶åæˆ‘ä»¬ä»‹ç»äº¤äº’ç±»å‹ï¼š</p>

<pre><code class="Kotlin">@Immutable
data class ClickableEmail(
    override val highlightedText: String,
    val email: String,
    override val style: SpanStyle,
) : StyledString, ClickableStyleString

@Immutable
data class ClickableUrl(
    override val highlightedText: String,
    val url: String,
    override val style: SpanStyle
) : StyledString, ClickableStyleString
</code></pre>

<p>å®ƒä»¬æ‰§è¡Œç›¸åŒçš„æ ·å¼è®¾ç½®å·¥ä½œï¼Œä½†è¿˜æºå¸¦é¢å¤–çš„æ•°æ®ï¼ˆä¾‹å¦‚ç‚¹å‡»æ—¶åº”æ‰“å¼€çš„ URL æˆ–ç”µå­é‚®ä»¶ï¼‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä»¬å®ç°äº†ç¬¬äºŒä¸ªæ¥å£ï¼šClickableStyleStringã€‚</p>

<pre><code class="Kotlin">sealed interface ClickableStyleString
</code></pre>

<p>è¿™ä¸ªå°æ¥å£æ„ä¹‰é‡å¤§ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤ŸåŒºåˆ†çº¯è§†è§‰æ ·å¼å’Œåº”è¯¥å“åº”ç‚¹å‡»çš„æ ·å¼ã€‚è¿™ä½¿å¾—æˆ‘ä»¬çš„ç‚¹å‡»å¤„ç†é€»è¾‘ç®€æ´ä¸”ç±»å‹å®‰å…¨ã€‚ğŸ’¡</p>

<p>ä½ å¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šå˜ä½“ï¼Œä¾‹å¦‚ @mentionsã€#hashtags æˆ–ç”µè¯å·ç ï¼Œåªéœ€åˆ›å»ºå¦ä¸€ä¸ªæ•°æ®ç±»å¹¶é€‰æ‹©æ€§åœ°å®ç°ClickableStyleString å³å¯ã€‚</p>

<h3>ğŸ¯ 2. æ ·å¼å’Œé“¾æ¥ï¼šapplyStyle</h3>

<p>ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†å“ªäº›æ–‡æœ¬éœ€è¦æ ·å¼ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ç§å°†è¿™äº›æ ·å¼åº”ç”¨äºå®é™…çš„ AnnotatedString çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯ applyStyle() çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„æ‰©å±•å‡½æ•°ï¼Œå®ƒæ ¹æ® StyledString çš„ç±»å‹åº”ç”¨æ ·å¼ï¼ˆå’Œç‚¹å‡»ç›‘å¬å™¨ï¼‰ã€‚</p>

<pre><code class="Kotlin">private fun AnnotatedString.Builder.applyStyle(
    styledString: StyledString,
    startIndex: Int,
    endIndex: Int,
    onClick: (ClickableStyleString) -&gt; Unit
) {
    when (styledString) {
        is StyledString.ClickableUrl -&gt; TODO()

        is StyledString.ClickableEmail -&gt; TODO()

        is StyledString.Simple -&gt; TODO()
    }
}
</code></pre>

<p>æ¯æ¬¡åŒ¹é…æ¯ä¸ª StyledString æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡æ­¤å‡½æ•°ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š</p>

<pre><code class="Kotlin">is StyledString.ClickableUrl -&gt; {
    val linkAnnotation = LinkAnnotation.Url(
        url = styledString.url,
        styles = TextLinkStyles(style = styledString.style),
        linkInteractionListener = { onClick(styledString) }
    )
    addLink(linkAnnotation, startIndex, endIndex)
}
</code></pre>

<p>å¦‚æœæ˜¯ URLï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª LinkAnnotation.Url å¯¹è±¡ï¼Œé™„åŠ æ ·å¼ï¼Œå¹¶ä¸ºå…¶æ·»åŠ ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨ã€‚addLink è´Ÿè´£å°†å…¶é™„åŠ åˆ°æ­£ç¡®çš„æ–‡æœ¬èŒƒå›´ã€‚</p>

<p>æˆ‘ä»¬æ‰§è¡Œçš„æ“ä½œç±»ä¼¼ï¼Œä½†é’ˆå¯¹ç”µå­é‚®ä»¶ä½¿ç”¨çš„æ˜¯ LinkAnnotation.Clickable ï¼š</p>

<pre><code class="Kotlin">is StyledString.ClickableEmail -&gt; {
    val linkAnnotation = LinkAnnotation.Clickable(
        tag = styledString.highlightedText,
        styles = TextLinkStyles(style = styledString.style),
        linkInteractionListener = { onClick(styledString) }
    )
    addLink(linkAnnotation, startIndex, endIndex)
}
</code></pre>

<p>å¦‚æœæ ·å¼åªæ˜¯è§†è§‰ä¸Šçš„ï¼ˆä¸å¯ç‚¹å‡»ï¼‰ï¼Œæˆ‘ä»¬ä¼šåº”ç”¨å¸¸è§„è·¨åº¦ï¼š</p>

<pre><code class="Kotlin">is StyledString.Simple -&gt; {
    addStyle(
        style = styledString.style, 
        start = startIndex, 
        end = endIndex
    )
}
</code></pre>

<p>è¿™ç§åˆ†ç¦»å°†æ‰€æœ‰æ ·å¼åº”ç”¨é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ã€‚å¦‚æœä½ æƒ³è¦æ”¯æŒæ–°çš„é“¾æ¥ç±»å‹æˆ–è¡Œä¸ºï¼Œåªéœ€æ›´æ–°æ­¤å‡½æ•°å³å¯ã€‚</p>

<h3>ğŸ” 3. åŒ¹é…æ–‡æœ¬ï¼šfindAllOccurrences</h3>

<p>åœ¨åº”ç”¨æ ·å¼ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ–‡æœ¬ä¸­æ‰€æœ‰å‡ºç°æŒ‡å®šhighlightedText çš„ä½ç½®ã€‚è¿™å°±æ˜¯æ­¤å‡½æ•°çš„ç”¨é€”ã€‚</p>

<pre><code class="Kotlin">/**
 * Find all occurrences of a substring in a string, optionally ignoring case.
 *
 * @param substring The substring to search for.
 * @param ignoreCase Whether to perform a case-insensitive search.
 * @return A list of indices where the substring was found.
 */
private fun String.findAllOccurrences(
    substring: String,
    ignoreCase: Boolean = false
): List&lt;Int&gt;
</code></pre>

<p>è¿™å°†è·å–å…¨æ–‡ï¼Œå¹¶è¿”å›ç»™å®šå­å­—ç¬¦ä¸²çš„æ¯ä¸ªåŒ¹é…é¡¹çš„èµ·å§‹ç´¢å¼•åˆ—è¡¨ã€‚</p>

<p>å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">if (substring.isEmpty()) return emptyList()
</code></pre>

<p>å¯¹äºç©ºå­å­—ç¬¦ä¸²ï¼Œå¿«é€Ÿæå‰é€€å‡ºã€‚é¿å…å¥‡æ€ªçš„è¾¹ç¼˜æƒ…å†µã€‚ç„¶åï¼Œæˆ‘ä»¬å‡†å¤‡è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„æœç´¢ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š</p>

<pre><code class="Kotlin">val indices = mutableListOf&lt;Int&gt;()
val searchString = if (ignoreCase) this.lowercase() else this
val searchSubstring = if (ignoreCase) substring.lowercase() else substring
</code></pre>

<p>ç°åœ¨æˆ‘ä»¬éå†å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ¹é…é¡¹ï¼š</p>

<pre><code class="Kotlin">var startIndex = 0
val maxStartIndex = length - substring.length

while (startIndex &lt;= maxStartIndex) {
    val index = searchString.indexOf(searchSubstring, startIndex)
    if (index == -1) break
    indices.add(index)
    startIndex = index + 1
}
</code></pre>

<p>æˆ‘ä»¬æœ€ç»ˆè¿”å›ç»“æœï¼š</p>

<pre><code class="Kotlin">return indices.toList()
</code></pre>

<p>è¿™ä½¿å¾—æˆ‘ä»¬çš„æ ·å¼é€»è¾‘ä¿æŒçµæ´»æ€§å’Œå¼¹æ€§ï¼Œæ— è®ºæˆ‘ä»¬è®¾è®¡çš„å•è¯å‡ºç°ä¸€æ¬¡è¿˜æ˜¯åå‡ æ¬¡ã€‚</p>

<h3>ğŸ§  4. æ„å»º AnnotatedStringï¼šrememberStyledAnnotationString</h3>

<p>ä»¥ä¸‹å‡½æ•°å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚å®ƒæ¥æ”¶å®Œæ•´æ–‡æœ¬å’Œä½ çš„StyledString åˆ—è¡¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªåº”ç”¨äº†æ‰€æœ‰æ ·å¼çš„ AnnotatedStringã€‚</p>

<pre><code class="Kotlin">@Composable
fun rememberStyledAnnotationString(
    fullText: String,
    styledStrings: ImmutableList&lt;StyledString&gt;,
    ignoreCase: Boolean = false,
    onClick: (ClickableStyleString) -&gt; Unit
): AnnotatedString
</code></pre>

<p>æˆ‘ä»¬ç¡®ä¿ä½¿ç”¨ rememberUpdatedState() æ¥ä¿æŒç‚¹å‡»ç›‘å¬å™¨çš„æœ€æ–°çŠ¶æ€ï¼š</p>

<pre><code class="Kotlin">val currentOnClick by rememberUpdatedState(onClick)
</code></pre>

<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨è®°ä½æ¥ç¼“å­˜å·¥ä½œï¼Œé™¤éè¾“å…¥å‘ç”Ÿå˜åŒ–ï¼š</p>

<pre><code class="Kotlin">return remember(fullText, styledStrings, ignoreCase) {
  // TODO: build annotated string
}
</code></pre>

<p>æˆ‘ä»¬é¦–å…ˆé™„åŠ å®Œæ•´çš„æœªæ ·å¼åŒ–çš„æ–‡æœ¬ã€‚ç„¶åï¼Œå¯¹äºæ¯ä¸ª StyledString ï¼Œæˆ‘ä»¬æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ä½ç½®å¹¶åº”ç”¨æ ·å¼ï¼š</p>

<pre><code class="Kotlin">buildAnnotatedString {
    append(fullText)

    styledStrings.fastForEach { styledStringInfo -&gt;
        val indices =
            fullText.findAllOccurrences(styledStringInfo.highlightedText, ignoreCase)

        indices.fastForEach { startIndex -&gt;
            val endIndex = startIndex + styledStringInfo.highlightedText.length
            applyStyle(styledStringInfo, startIndex, endIndex, currentOnClick)
        }
    }
}
</code></pre>

<p>è¿™ä¸ªå¾ªç¯ä½¿å¾—æ ·å¼è®¾ç½®èƒ½å¤ŸåŠ¨æ€ä¸”å¤šç›®æ ‡åŒ–ã€‚ä½ å¯ä»¥å°†ä»»ä½•æœ¬åœ°åŒ–æˆ–è¿è¡Œæ—¶ç”Ÿæˆçš„å­—ç¬¦ä¸²ä½œä¸º fullText ä¼ é€’ï¼Œå®ƒä»ç„¶èƒ½å¤Ÿæ­£ç¡®åº”ç”¨æ ·å¼ã€‚</p>

<h3>ğŸ§© 5. å¯ç»„åˆé¡¹ï¼šStyledText</h3>

<p>æœ€åï¼ŒStyledText å¯ç»„åˆé¡¹å°†æ‰€æœ‰å†…å®¹è¿æ¥åœ¨ä¸€èµ·ã€‚</p>

<pre><code class="Kotlin">@Composable
fun StyledText(
    fullText: String,
    styledStrings: ImmutableList&lt;StyledString&gt;,
    style: TextStyle,
    modifier: Modifier = Modifier,
    onClick: (ClickableStyleString) -&gt; Unit = {},
    ignoreCase: Boolean = false,
) {
    // TODO: Implementation
}
</code></pre>

<p>ä½ ä¼ å…¥å…¨æ–‡ã€æ ·å¼ä»¥åŠå¯é€‰çš„ç‚¹å‡»å¤„ç†ç¨‹åºã€‚å®ƒçš„å†…éƒ¨åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">val annotatedString = rememberStyledAnnotationString(
    fullText = fullText,
    styledStrings = styledStrings,
    ignoreCase = ignoreCase,
    onClick = onClick
)
</code></pre>

<p>è¿™è°ƒç”¨äº†æˆ‘ä»¬åˆšåˆšè®²è¿‡çš„é€»è¾‘ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸¦æ ·å¼çš„ AnnotatedString ã€‚ç„¶åæˆ‘ä»¬æ¸²æŸ“å®ƒï¼š</p>

<pre><code class="Kotlin">Text(
    modifier = modifier,
    text = annotatedString,
    style = style
)
</code></pre>

<p>å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Compose Text ã€‚ä½†æ‰€æœ‰æ ·å¼é€»è¾‘éƒ½å·²é¢„å…ˆçƒ˜ç„™ã€‚ç°åœ¨ï¼Œä½ çš„ UI ä»£ç ä¿æŒç®€æ´ä¸”å£°æ˜å¼ã€‚ğŸŒš</p>

<h3>âš¡ï¸ 6. StyledText å®è·µ</h3>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ StyledText çš„å®è·µï¼Œä¸ºæ­¤ï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸ªé¢„è§ˆï¼Œä½ å¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<pre><code class="Kotlin">@PreviewLightDark
@Composable
private fun StyledTextPreview() {
    MyTheme {
        Box(
            modifier = Modifier
                .background(color = MaterialTheme.colors.background)
                .padding(16.dp)
        ) {
            // This list can be built in the ViewModel
            val styledStrings = persistentListOf(
                StyledString.ClickableEmail(
                    highlightedText = "support@example.com",
                    email = "support@example.com",
                    style = SpanStyle(
                        color = Color.Gray,
                        textDecoration = TextDecoration.Underline
                    )
                ),
                StyledString.ClickableUrl(
                    highlightedText = "website",
                    url = "https://euryperez.dev",
                    style = SpanStyle(
                        color = Color.Gray,
                        textDecoration = TextDecoration.Underline
                    )
                )
            )

            // In your Compose Screen
            StyledText(
                fullText = "Contact us at support@example.com or visit our website",
                styledStrings = styledStrings,
                style = MaterialTheme.typography.body2,
                color = MaterialTheme.colors.onBackground,
                onClick = { styled -&gt;
                    when (styled) {
                        is StyledString.ClickableEmail -&gt; TODO()
                        is StyledString.ClickableUrl -&gt; TODO()
                    }
                }
            )
        }
    }
}
</code></pre>

<p>ä½ å°†åœ¨é¢„è§ˆä¸­çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š
<img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Tc22BNoUfij54fBGQ7YCg.png" alt="StyledTextPreview" /></p>

<h3>âœ… æ€»ç»“ï¼šä¸€ä¸ªè¾“å‡ºç®€æ´çš„ç®€å•å¼•æ“</h3>

<p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œå…¨å¯å¤ç”¨çš„ Compose å®ç”¨ç¨‹åºï¼Œå®ƒï¼š</p>

<ul>
<li>ä½¿ç”¨ StyledString ä»¥å£°æ˜å¼æ–¹å¼æè¿°æ ·å¼</li>
<li>å®‰å…¨åœ°åŒºåˆ†å¯è§†æ ·å¼å’Œå¯ç‚¹å‡»æ ·å¼</li>
<li>ä½¿ç”¨ applyStyle åº”ç”¨ span å’Œ link</li>
<li>ä½¿ç”¨ findAllOccurrences æŸ¥æ‰¾å¤šä¸ªåŒ¹é…é¡¹</li>
<li>ä»¥ Compose ç¨³å®šçš„æ–¹å¼ç»„è£…æ‰€æœ‰å†…å®¹</li>
<li>å°è£…åœ¨ä¸€ä¸ªç®€æ´çš„ API ä¸­ï¼šStyledText</li>
</ul>


<p>æ— éœ€ indexOf ï¼Œæ— éœ€å¤æ‚çš„èŒƒå›´é€»è¾‘ï¼Œä¹Ÿæ— éœ€å¤åˆ¶ç²˜è´´ buildAnnotatedStringæ ·æ¿ä»£ç ã€‚</p>

<p><a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a">ç‚¹å‡»æ­¤å¤„</a>ï¼ˆé“¾æ¥ï¼š<a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82">https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82</a></p>

<h2>ç»“è¯­ğŸ¯</h2>

<p>Jetpack Compose èµ‹äºˆæˆ‘ä»¬å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†å¹¶éæ€»æ˜¯æœ€ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„å¼€ç®±å³ç”¨å·¥å…·ã€‚AnnotatedString å¯¹äºä¸€æ¬¡æ€§éœ€æ±‚æ¥è¯´éå¸¸æ£’ï¼Œä½†ä¸€æ—¦ä½ çš„ UI éœ€è¦å¤šç§æ ·å¼ã€å¤ç”¨æ¨¡å¼æˆ–åŠ¨æ€ç‚¹å‡»å¤„ç†ï¼Œå®ƒå°±ä¼šå¾ˆå¿«å˜å¾—å†—é•¿ã€‚</p>

<p>è¿™å°±æ˜¯ StyledString çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>

<p>å®ƒå¹¶éå–ä»£ AnnotatedStringï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼Œä¸ºä½ æä¾›ä¸€ç§æ›´å®‰å…¨ã€æ›´æ¸…æ™°çš„æ–¹å¼æ¥æè¿°æ„å›¾ï¼š</p>

<ul>
<li>â†’ â€œå°†æ­¤å•è¯åŠ ç²—â€</li>
<li>â†’ â€œå°†æ­¤çŸ­è¯­è®¾ä¸ºé“¾æ¥â€</li>
<li>â†’ â€œä¸ºè¯¥å­—ç¬¦ä¸²çš„æ¯ä¸ªå®ä¾‹è®¾ç½®æ ·å¼â€</li>
</ul>


<p>ä½ æ— éœ€å†è€ƒè™‘æ–‡æœ¬åç§»é‡å’Œè·¨åº¦èŒƒå›´ï¼Œè€Œæ˜¯å¼€å§‹æ€è€ƒå«ä¹‰ã€‚ç»“æœï¼šä»£ç æ›´ç®€æ´ã€æ ·æ¿æ›´å°‘ï¼Œå¼€å‘è€…ä½“éªŒæ›´ä½³ğŸ’†</p>

<h3>ğŸ§© æ˜“äºé‡‡ç”¨</h3>

<p>ä½ æ— éœ€é‡æ„æ•´ä¸ªåº”ç”¨å³å¯ä½¿ç”¨ StyledString ã€‚</p>

<p>åªéœ€å°†ä¸€ä¸¤ä¸ª Text() å…ƒç´ æ›¿æ¢ä¸º StyledText() å³å¯ã€‚å°†å†…è”çš„ buildAnnotatedString { &hellip; } å—æ›¿æ¢ä¸º StyledString.Simple æˆ– ClickableUrl çš„ç®€å•åˆ—è¡¨å³å¯ã€‚</p>

<p>å°±è¿™æ ·ï¼Œä½ å°±æˆåŠŸäº†ã€‚âœ¨</p>

<h3>ğŸ› ï¸ æ˜“äºæ‰©å±•</h3>

<p>è¿˜æœ‰å…¶ä»–ç”¨ä¾‹å—ï¼Ÿ</p>

<ul>
<li>ä¸º #hashtags è®¾ç½®æ ·å¼ï¼Ÿ</li>
<li>å¤„ç† @mentionsï¼Ÿ</li>
<li>è‡ªåŠ¨æ£€æµ‹ç”µè¯å·ç ï¼Ÿ</li>
<li>æ·»åŠ å›¾æ ‡æˆ–èƒŒæ™¯é«˜äº®ï¼Ÿ</li>
</ul>


<p>åªéœ€åˆ›å»ºä¸€ä¸ªå®ç° StyledString çš„æ–°æ•°æ®ç±»ï¼Œå¹¶åœ¨ applyStyle() ä¸­å¤„ç†å®ƒå³å¯ã€‚ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚</p>

<p>è¿™ç§åˆ†ç¦»ä½¿ä½ çš„æ–‡æœ¬é€»è¾‘æ¨¡å—åŒ–ã€å¯æµ‹è¯•ï¼Œå¹¶èƒ½å¤Ÿé€‚åº”æœªæ¥çš„è®¾è®¡æˆ–ä¸šåŠ¡éœ€æ±‚ã€‚</p>

<p>å¦‚æœä½ æœ‰ä»€ä¹ˆæœ‰è¶£çš„æƒ³æ³•ï¼Œåˆ«å¿˜äº†åœ¨è¯„è®ºåŒºåˆ†äº«ã€‚ğŸ˜‰</p>

<h3>ğŸ«± è½®åˆ°ä½ äº†</h3>

<p>ç°åœ¨ä½ å·²ç»äº†è§£äº†å®ƒçš„å·¥ä½œåŸç†ï¼ˆä»¥åŠå®ƒå®é™…éœ€è¦çš„ä»£ç é‡æœ‰å¤šå°ï¼‰ï¼Œé‚£å°±åœ¨ä¸‹ä¸€ä¸ª Compose å±å¹•ä¸­å°è¯•ä¸€ä¸‹å§ã€‚ä¸å†éœ€è¦ç¹ççš„ AnnotatedString.Builder ä»£ç ã€‚ä¸å†éœ€è¦é‡å¤çš„ span é€»è¾‘ã€‚åªéœ€æè¿°ä½ æƒ³è¦çš„å†…å®¹ï¼Œå‰©ä¸‹çš„äº¤ç»™ StyledText å¤„ç†ã€‚</p>

<p><strong>è®© Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚ğŸ˜</strong></p>

<h3>ğŸ¤ æ„Ÿè°¢é˜…è¯»</h3>

<p>å¦‚æœä½ æœ€ç»ˆåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† StyledStringï¼Œè¯·å‘Šè¯‰æˆ‘ï¼çœ‹åˆ°è¿™äº›å¾®å‹æ¨¡å¼åœ¨ç°å®ä¸–ç•Œä¸­è½åœ°æ€»æ˜¯å¾ˆé…·ã€‚ğŸ‘€</p>

<p>æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·è€ƒè™‘åˆ†äº«ç»™å…¶ä»–å¼€å‘è€…ï¼Œç‚¹èµæˆ–ç•™è¨€ã€‚è¿™å¾ˆæœ‰å¸®åŠ©ã€‚âœŒï¸</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ­å¯†Jetpack Composeä¸­çš„PausableComposition]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition/"/>
    <updated>2025-07-24T19:55:51+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒExploring PausableComposition internals in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose">https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose</a>ï¼Œç”±Shreyas Patilå‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href=""><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751791091096/4e5b36e3-485c-4079-88be-987082e7d67e.png?w=1600&amp;h=840&amp;fit=crop&amp;crop=entropy&amp;auto=compress,format&amp;format=webp" title="auto auto" ></a></p>

<!-- more -->


<p>å—¨ï¼ŒComposers ä»¬ğŸ‘‹ï¼Œåœ¨æœ€è¿‘çš„ Compose 1.9.X ç‰ˆæœ¬ä¸­ï¼ŒCompose-runtime å¼•å…¥äº†ä¸€ä¸ªåä¸º PausableComposition çš„æ–°å†…éƒ¨ APIï¼Œæ®ç§°å®ƒå¯ä»¥è§£å†³æ€§èƒ½é—®é¢˜ã€‚å®ƒå¬èµ·æ¥åƒé­”æ³•ï¼Œä½†åœ¨åº•å±‚ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäºä¸€äº›éå¸¸å·§å¦™çš„å·¥ç¨‹è®¾è®¡ã€‚åœ¨æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶ä»¥æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹æ—¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº†ä¸€ä¸ªå¼ºå¤§çš„å†…éƒ¨å·¥å…·ï¼Œå®ƒä½¿è¿™ä¸€åˆ‡æˆä¸ºå¯èƒ½ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« å°†æ·±å…¥åˆ†æè¿™ä¸€æœºåˆ¶ï¼šPausableCompositionã€‚è¿™æ˜¯ Compose çš„å†…éƒ¨ APIï¼Œå¼€å‘è€…æ— éœ€äº†è§£å®ƒã€‚ä½†äº†è§£å®ƒçš„åº•å±‚å·¥ä½œåŸç†æ€»æ˜¯æœ‰ç›Šçš„ã€‚å¯¹äºæƒ³è¦æ·±å…¥äº†è§£ Compose å¦‚ä½•å®ç°å…¶æƒŠäººæ€§èƒ½çš„ Jetpack Compose å¼€å‘è€…æ¥è¯´ï¼Œè¿™ç¯‡æ¢ç´¢æ–‡ç« å°†ä¸ºä½ æä¾›æ›´æ¸…æ™°çš„è§†è§’ã€‚æˆ‘ä»¬å°†æ·±å…¥è¿è¡Œæ—¶æºä»£ç ï¼Œäº†è§£å®ƒçš„å·¥ä½œåŸç†ã€å®ƒå¯¹æ€§èƒ½å¦‚æ­¤é‡è¦çš„åŸå› ï¼Œä»¥åŠå¦‚ä½•åè°ƒæ‰€æœ‰ç»„ä»¶ä»¥ä½¿æˆ‘ä»¬çš„ UI æ„Ÿè§‰å¦‚æ­¤æµç•…ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>

<h2>ç¼˜èµ·</h2>

<p>ä¸ºäº†å®ç°æµç•…çš„ 60 å¸§/ç§’ (fps)ï¼Œæˆ‘ä»¬çš„åº”ç”¨éœ€è¦åœ¨ 16.7 æ¯«ç§’å†…ç»˜åˆ¶æ¯ä¸€å¸§ã€‚å½“ç”¨æˆ·æ»šåŠ¨æµè§ˆ LazyColumn æ—¶ï¼Œå¿…é¡»åœ¨è¿™ä¸ªå¾®å°çš„çª—å£å†…åˆ›å»ºã€æµ‹é‡å’Œç»˜åˆ¶æ–°çš„é¡¹ç›®ã€‚</p>

<p>å¦‚æœä¸€ä¸ªé¡¹ç›®å¾ˆå¤æ‚ï¼ŒåŒ…å«åµŒå¥—å¸ƒå±€ã€å›¾ç‰‡å’Œå¤§é‡é€»è¾‘ï¼Œé‚£ä¹ˆç»„åˆå®ƒæ‰€éœ€çš„å·¥ä½œå¾ˆå®¹æ˜“è¶…è¿‡ 16 æ¯«ç§’ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¸»çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå¸§ä¼šä¸¢å¤±ï¼Œç”¨æˆ·ä¼šåœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­çœ‹åˆ°â€œå¡é¡¿â€æˆ–å¡é¡¿ã€‚ğŸ˜©</p>

<p>è¿™æ­£æ˜¯ PausableComposition çš„åˆè¡·ã€‚</p>

<h2>â€œåšä»€ä¹ˆâ€ï¼šæ›´æ™ºèƒ½çš„ Compose æ–¹å¼</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä¸€ä½å¨å¸ˆï¼Œæ­£åœ¨ä¸ºä¸€åœºæ´»åŠ¨å‡†å¤‡ä¸€é¡¿å¤§é¤ã€‚ğŸ‘¨â€ğŸ³ ä¸å…¶åœ¨ç¬¬ä¸€ä½å®¢äººåˆ°æ¥æ—¶æ…Œä¹±åœ°ä»å¤´å¼€å§‹çƒ¹é¥ªæ‰€æœ‰é£Ÿæï¼Œä¸å¦‚æå‰å‡ ä¸ªå°æ—¶åšå¥½å‡†å¤‡å·¥ä½œã€‚åˆ‡èœã€è°ƒé…±ã€çƒ¤ç”œç‚¹ã€‚ç­‰åˆ°ä¸Šæ¡Œæ—¶ï¼Œæœ€åçš„çƒ¹é¥ªå’Œç»„è£…é€Ÿåº¦ä¼šå¿«å¾—ä»¤äººéš¾ä»¥ç½®ä¿¡ã€‚</p>

<p>PausableComposition å°†è¿™ç§â€œå‡†å¤‡å·¥ä½œâ€çš„ç†å¿µå¸¦åˆ°äº† Compose ä¸­ã€‚å®ƒå…è®¸è¿è¡Œæ—¶ï¼š</p>

<ol>
<li>å¢é‡å¼ Composeï¼šå°†å¤§å‹ UI å…ƒç´ çš„åˆæˆåˆ†è§£æˆæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„éƒ¨åˆ†ã€‚</li>
<li>å¼‚æ­¥å‡†å¤‡ï¼šåœ¨ UI çœŸæ­£éœ€è¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šä¹‹å‰è¿›è¡Œåˆæˆå·¥ä½œï¼Œé€šå¸¸åˆ©ç”¨å¸§é—´çš„ç©ºé—²æ—¶é—´ã€‚</li>
</ol>


<p>è¿™ç§å¯ç»„åˆé¡¹çš„é¢„çƒ­æ„å‘³ç€ï¼Œå½“æŸä¸ªé¡¹ç›®æœ€ç»ˆæ»šåŠ¨åˆ°è§†å›¾ä¸­æ—¶ï¼Œå¤§éƒ¨åˆ†ç¹é‡çš„å·¥ä½œå·²ç»å®Œæˆï¼Œä½¿å…¶å‡ ä¹å¯ä»¥ç«‹å³æ˜¾ç¤ºã€‚</p>

<p>ä¸ºäº†ç›´è§‚åœ°ç†è§£è¿™ä¸€æ¦‚å¿µï¼Œè¯·è§‚çœ‹ä»¥ä¸‹åŠ¨ç”»ï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751997214840/f9f7308a-7b83-4a3d-9d38-e3ce6aa8d9a9.gif?auto=format,compress&amp;gif-q=60&amp;format=webm" alt="æ»šåŠ¨å¸§æ—¶é—´çº¿" /></p>

<p>æ»šåŠ¨å‘ç”Ÿæ—¶ï¼Œå‡è®¾é¡¹ç›® Aã€Bã€Cã€D å’Œ E å·²åœ¨å±å¹•ä¸Šå¯è§ï¼Œä¸‹ä¸€ä¸ªé¡¹ç›®æ˜¯ Fã€‚å¦‚æœé¡¹ç›® F çš„å¸ƒå±€æˆ–ç»“æ„å¤æ‚ï¼Œéœ€è¦æ›´å¤šæ—¶é—´è¿›è¡Œå¸ƒå±€è®¡ç®—æˆ–å…¶ä»–é¢„å¤„ç†æ‰èƒ½åœ¨ UI ä¸Šæ¸²æŸ“ï¼Œåˆ™æ­¤é¢„å¤„ç†å°†åœ¨å¸§æ—¶é—´è½´å†…åˆ†å—è¿›è¡Œï¼ˆä¾‹å¦‚ 16 æ¯«ç§’ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœå®ƒéœ€è¦ 2 å¸§ï¼Œåˆ™ F æ‰€éœ€çš„é¢„å¤„ç†ä¼šåœ¨ 2 å¸§çš„ç©ºé—²æ—¶é—´å†…å®Œæˆï¼Œä¸ä¼šé€ æˆä»»ä½•å¸§å¡é¡¿ã€‚æœ€åï¼Œå½“éœ€è¦æ˜¾ç¤ºæ—¶ï¼Œå®ƒä¼šè¢«ç»˜åˆ¶åˆ° UI ä¸Šã€‚é¡¹ç›® G å’Œ H ä¹Ÿé‡‡ç”¨ç›¸åŒçš„æµç¨‹ã€‚</p>

<h2>å·¥ä½œåŸç†ï¼šæ ¸å¿ƒç»„ä»¶</h2>

<p>é€šè¿‡æŸ¥çœ‹è¿è¡Œæ—¶æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸€äº›å…³é”®æ¥å£å’Œç±»æ¥å¤„ç†çš„ã€‚è™½ç„¶ä½ ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™äº› APIï¼Œä½†ç†è§£å®ƒä»¬å¯ä»¥æ­ç¤º LazyColumn çš„æ€§èƒ½æå‡ã€‚ğŸ•µï¸â€â™‚ï¸</p>

<h3>ç”Ÿå‘½å‘¨æœŸï¼šPausableComposition åŠå…¶æ§åˆ¶å™¨</h3>

<p>æ—…ç¨‹ä» PausableComposition æ¥å£å¼€å§‹ï¼Œè¯¥æ¥å£æ‰©å±•äº† ReusableComposition å¹¶æ·»åŠ äº†æš‚åœåŠŸèƒ½ã€‚</p>

<blockquote><p>å…³äº ReusableComposition çš„ç®€è¦è¯´æ˜ï¼š</p>

<p>åœ¨è®¨è®ºæš‚åœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ ReusableCompositionï¼Ÿå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„åˆï¼Œä¸“ä¸ºéœ€è¦é«˜æ•ˆå›æ”¶ UI å†…å®¹çš„é«˜æ€§èƒ½åœºæ™¯è€Œè®¾è®¡ã€‚æƒ³è±¡ä¸€ä¸‹ LazyColumn ä¸­çš„é¡¹ç›®ã€‚ReusableComposition ä¸ä¼šé”€æ¯æ»šåŠ¨åˆ°å±å¹•å¤–çš„é¡¹ç›®çš„æ•´ä¸ªç»„åˆï¼Œè€Œæ˜¯å…è®¸è¿è¡Œæ—¶åœç”¨å®ƒã€‚è¿™ä¼šä¿ç•™åº•å±‚ UI èŠ‚ç‚¹ï¼Œä½†ä¼šæ¸…é™¤å·²è®°ä½çš„çŠ¶æ€ã€‚ç„¶åï¼Œè¿™ä¸ªåœç”¨çš„ç»„åˆå¯ä»¥å¿«é€Ÿåœ°ç”¨æ–°å†…å®¹â€œé‡æ–°å¡«å……â€ï¼Œä»è€ŒèŠ‚çœäº†ä»å¤´åˆ›å»ºèŠ‚ç‚¹çš„æˆæœ¬ã€‚PausableComposition ç›´æ¥æ„å»ºäºè¿™ä¸ªå¼ºå¤§çš„å›æ”¶åŸºç¡€ä¹‹ä¸Šã€‚</p></blockquote>

<p>PausableComposition çš„å¤–è§‚å¦‚ä¸‹ï¼š</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=66
sealed interface PausableComposition : ReusableComposition {
    fun setPausableContent(content: @Composable () -&gt; Unit): PausedComposition
    fun setPausableContentWithReuse(content: @Composable () -&gt; Unit): PausedComposition
}
</code></pre>

<p>ï¼ˆæ³¨æ„ï¼šè¯¥æ¥å£æ˜¯å¯†å°çš„ï¼Œå› ä¸ºå®ƒä»…åœ¨ Compose è¿è¡Œæ—¶å†…éƒ¨å…·æœ‰ä¸€ç»„å°é—­ä¸”æœ‰é™çš„å®ç°ã€‚è¿™ä¸ºç¼–è¯‘å™¨æä¾›äº†æ›´å¤šä¿¡æ¯æ¥è¿›è¡Œä¼˜åŒ–ã€‚ï¼‰</p>

<p>è°ƒç”¨ setPausableContent ä¸ä¼šç«‹å³ç»„åˆç•Œé¢ã€‚ç›¸åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª PausedComposition å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å……å½“é€æ­¥è¿‡ç¨‹çš„æ§åˆ¶å™¨ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=112
sealed interface PausedComposition {
    val isComplete: Boolean
    fun resume(shouldPause: ShouldPauseCallback): Boolean
    fun apply()
    fun cancel()
}
</code></pre>

<p>è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæœ€å¥½ä»¥çŠ¶æ€æœºçš„å½¢å¼æ¥è¡¨ç¤ºï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751864148018/27512893-f186-47e7-9bdc-26036460aed7.png?auto=compress,format&amp;format=webp" alt="PausableCompositionç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾" /></p>

<ul>
<li>resume(shouldPause: ShouldPauseCallback)ï¼šè¿™æ˜¯å¼•æ“ã€‚é¢„å–ç³»ç»Ÿï¼ˆæ­¤å¤„æŒ‡ LazyColumn ä¸Šä¸‹æ–‡ï¼‰ä¼šåå¤è°ƒç”¨ resume() æ¥æ‰§è¡Œå¤§é‡çš„ç»„åˆå·¥ä½œã€‚ç¥å¥‡ä¹‹å¤„åœ¨äº shouldPause å›è°ƒã€‚Compose è¿è¡Œæ—¶ä¼šåœ¨ç»„åˆè¿‡ç¨‹ä¸­é¢‘ç¹è°ƒç”¨æ­¤ lambdaã€‚å¦‚æœå®ƒè¿”å› trueï¼ˆä¾‹å¦‚ï¼Œç”±äºå¸§æˆªæ­¢æ—¶é—´å·²è¿‘ï¼‰ï¼Œåˆ™ç»„åˆè¿‡ç¨‹å°†åœæ­¢ï¼Œå¹¶å°†ä¸»çº¿ç¨‹äº¤è¿˜ç»™æ›´é‡è¦çš„å·¥ä½œï¼Œä¾‹å¦‚ç»˜åˆ¶å½“å‰å¸§ã€‚</li>
<li>apply()ï¼šä¸€æ—¦ resume() è¿”å› trueï¼Œå³è¡¨ç¤ºæ“ä½œå®Œæˆï¼Œå°±ä¼šè°ƒç”¨ apply()ã€‚è¿™ä¼šè·å–æ‰€æœ‰è®¡ç®—å‡ºçš„ç•Œé¢æ›´æ”¹ï¼Œå¹¶å°†å…¶æäº¤åˆ°å®é™…çš„ç•Œé¢æ ‘ä¸­ã€‚</li>
<li>cancel()ï¼šå¦‚æœç”¨æˆ·æ»šåŠ¨ç¦»å¼€ï¼Œå¹¶ä¸”ä¸å†éœ€è¦é¢„å…ˆç»„åˆçš„é¡¹ç›®ï¼Œåˆ™ä¼šè°ƒç”¨ cancellation() æ¥ä¸¢å¼ƒå·¥ä½œå¹¶é‡Šæ”¾èµ„æºã€‚</li>
</ul>


<h3>å†…éƒ¨ç»“æ„æ¦‚è§ˆï¼šPausedCompositionImpl</h3>

<p>ä¸Šè¿°çŠ¶æ€æœºç”±å†…éƒ¨çš„ PausedCompositionImpl ç±»ç®¡ç†ã€‚è¯¥ç±»ä¿å­˜çŠ¶æ€å¹¶è¿æ¥æ‰€æœ‰éƒ¨åˆ†ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=202
internal class PausedCompositionImpl(...) : PausedComposition {
    private var state = PausedCompositionState.InitialPending
    internal val pausableApplier = RecordingApplier(applier.current)
    // ...

    override fun resume(shouldPause: ShouldPauseCallback): Boolean {
        when (state) {
            PausedCompositionState.InitialPending -&gt; {
                // This is the first time resume() is called.
                // It starts the initial composition of the content.
                invalidScopes =
                    context.composeInitialPaused(composition, shouldPause, content)
                state = PausedCompositionState.RecomposePending
                if (invalidScopes.isEmpty()) markComplete()
            }
            PausedCompositionState.RecomposePending -&gt; {
                // This is for subsequent calls to resume().
                state = PausedCompositionState.Recomposing
                // It tells the Composer to continue where it left off,
                // processing any pending invalidations.
                invalidScopes =
                    context.recomposePaused(composition, shouldPause, invalidScopes)
                state = PausedCompositionState.RecomposePending
                if (invalidScopes.isEmpty()) markComplete()
            }
            // ... other states like Recomposing, Applied, Cancelled are handled here ...
        }
        return isComplete
    }

    override fun apply() {
        // ... other state checks ...
        if (state == PausedCompositionState.ApplyPending) {
            applyChanges() // The call site
            state = PausedCompositionState.Applied
        }
        // ...
    }

    private fun applyChanges() {
        // ...
        pausableApplier.playTo(applier, rememberManager)
        rememberManager.dispatchRememberObservers()
        rememberManager.dispatchSideEffects()
        // ...
    }
}
</code></pre>

<p>è°ƒç”¨ resume() æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å…¶å†…éƒ¨çŠ¶æ€å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ï¼š</p>

<ul>
<li>InitialPendingï¼šé¦–æ¬¡è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.composeInitialPaused å¯åŠ¨åˆæˆè¿‡ç¨‹ã€‚è¿™ä¼šå‘ŠçŸ¥æ ¸å¿ƒ ComposerImpl å¼€å§‹æ‰§è¡Œ @Composable å†…å®¹ï¼Œå¹¶æ‰§è¡Œ shouldPause å›è°ƒã€‚</li>
<li>RecomposePendingï¼šåç»­è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.recomposePaused ç»§ç»­å·¥ä½œã€‚æ­¤æ–¹æ³•ç”¨äºå¤„ç†åˆæˆä¸­ä»»ä½•å› çŠ¶æ€å˜åŒ–è€Œå¤±æ•ˆçš„éƒ¨åˆ†ï¼Œæˆ–ç»§ç»­ä¹‹å‰æš‚åœçš„å·¥ä½œã€‚</li>
<li>Applierï¼šåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼ŒComposerImpl å°†æ‰€æœ‰ UI æ›´æ”¹æ“ä½œè½¬å‘ç»™ pausableApplierï¼ˆå³ RecordingApplierï¼‰ï¼Œè¯¥æ“ä½œä¼šè¿›è¡Œç¼“å†²ï¼Œè€Œä¸æ˜¯ç«‹å³åº”ç”¨ã€‚</li>
<li>æ­¤è¿‡ç¨‹æŒç»­è¿›è¡Œï¼Œç›´åˆ°å·¥ä½œå®Œæˆæˆ– shouldPause å›è°ƒè¿”å› trueã€‚</li>
</ul>


<h3>RecordingApplierï¼šæ¨è¿Ÿæœ€åçš„æ¶¦è‰²</h3>

<p>ä¸€ä¸ªå…³é”®çš„æ€§èƒ½æŠ€å·§æ˜¯ RecordingApplierã€‚è°ƒç”¨ resume() æ—¶ï¼ŒComposer ä¸ä¼šç›´æ¥æ›´æ”¹å®æ—¶ UI æ ‘ã€‚å¦‚æœåˆ†å°æ­¥æ‰§è¡Œï¼Œå¯èƒ½ä¼šå¾ˆæ…¢ï¼Œå¹¶å¯¼è‡´ UI æ›´æ–°ä¸å®Œæ•´ï¼Œæ˜¾å¾—æ€ªå¼‚ã€‚</p>

<p>PausableComposition ä½¿ç”¨çš„æ˜¯ RecordingApplierã€‚è¿™ä¸ªç‰¹æ®Šçš„ Applier ä¼šå°†å…¶åº”è¯¥æ‰§è¡Œçš„æ‰€æœ‰ UI æ“ä½œï¼ˆä¾‹å¦‚â€œåˆ›å»º Text èŠ‚ç‚¹â€ã€â€œè®¾ç½®å…¶æ–‡æœ¬å±æ€§â€æˆ–â€œæ·»åŠ å­å›¾åƒâ€ï¼‰è®°å½•åˆ°ä¸€ä¸ªå†…éƒ¨åˆ—è¡¨ä¸­ã€‚</p>

<p>åªæœ‰è°ƒç”¨ PausedComposition.apply() æ—¶ï¼ŒRecordingApplier æ‰ä¼šå°†å…¶è®°å½•çš„æ“ä½œåˆ—è¡¨â€œå›æ”¾â€åˆ°å®é™…çš„ Applier ä¸Šï¼Œä»è€Œé«˜æ•ˆåœ°å•æ­¥æ›´æ–° UI æ ‘ã€‚PausedComposition çš„å…¬å…± apply() æ–¹æ³•æ˜¯ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºå®ˆå«ã€‚çœŸæ­£çš„å·¥ä½œå‘ç”Ÿåœ¨å†…éƒ¨çš„ applyChanges() æ–¹æ³•ä¸­ï¼ˆå¦‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼‰ã€‚</p>

<p>å½“è°ƒç”¨ applyChanges æ—¶ï¼Œå®ƒä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‰é¡¹å…³é”®æ“ä½œï¼š</p>

<ul>
<li>å®ƒä¼šå‘Šè¯‰ RecordingApplier å°†å…¶æ‰€æœ‰ç¼“å†²çš„å‘½ä»¤æ’­æ”¾åˆ°å®é™…çš„ applier ä¸Šã€‚è¿™æ‰æ˜¯ UI çœŸæ­£å‡ºç°åœ¨å±å¹•ä¸Šçš„å…³é”®ã€‚</li>
<li>å®ƒä¼šä¸ºæ‰€æœ‰å·²åˆ›å»ºçš„ RememberObserversï¼ˆä¾‹å¦‚ DisposableEffectï¼‰è°ƒåº¦æ‰€æœ‰ onRemembered ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</li>
<li>æœ€åï¼Œå®ƒä¼šè¿è¡Œåœ¨åˆæˆè¿‡ç¨‹ä¸­æ’é˜Ÿçš„æ‰€æœ‰ SideEffectã€‚</li>
</ul>


<p>è¿™ç§æœ‰åºçš„æ‰¹å¤„ç†è¿‡ç¨‹ç¡®ä¿ UI é«˜æ•ˆæ›´æ–°ï¼Œå¹¶ä¸”æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½åœ¨æ­£ç¡®çš„æ—¶é—´å‘ç”Ÿã€‚</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751794209046/49f5c1c7-b424-4c7d-a017-8ba65bb7b2d3.png?auto=compress,format&amp;format=webp" alt="PausableCompositionæ—¶åºå›¾" /></p>

<h2>ä½¿ç”¨äº† PausableComposition çš„ LazyList</h2>

<p>LazyList å·²ç»å¼€å§‹ä½¿ç”¨ PausableComposition APIäº†ã€‚åœ¨ LazyList ä¸­ï¼ŒPausableComposition å¹¶éç‹¬ç«‹å·¥ä½œï¼Œè€Œæ˜¯ååŒå·¥ä½œçš„ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚</p>

<ul>
<li>æŒ‡æŒ¥å™¨ (Recomposer)ï¼šä¸» Recomposer è´Ÿè´£æ§åˆ¶èŠ‚å¥ï¼Œé©±åŠ¨å¯è§ UI çš„é€å¸§æ›´æ–°ã€‚</li>
<li>è§„åˆ’å™¨ (LazyLayoutPrefetchState)ï¼šå½“ç”¨æˆ·æ»šåŠ¨æ—¶ï¼Œæ­¤ç»„ä»¶ä¼šé¢„æµ‹å“ªäº›é¡¹ç›®å³å°†æ˜¾ç¤ºã€‚</li>
<li>èˆå°ç®¡ç†å™¨ (SubcomposeLayout)ï¼šè¿™ä¸ªå¼ºå¤§çš„ SubcomposeLayout æ˜¯ LazyList çš„åŸºç¡€ã€‚å®ƒçš„ SubcomposeLayoutState å¯ä»¥åœ¨éœ€è¦æ—¶ä¸ºå„ä¸ªé¡¹ç›®åˆ›å»ºå’Œç®¡ç†åˆæˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒæä¾›äº† createPausedPrecomposition() APIã€‚</li>
<li>èˆå°è°ƒåº¦å™¨ (PrefetchScheduler)ï¼šæ­¤è°ƒåº¦å™¨ä¼šåœ¨å¸§ä¹‹é—´å¯»æ‰¾ç©ºé—²æ—¶é—´æ¥æ‰§è¡Œè§„åˆ’å™¨è¯·æ±‚çš„é¢„åˆæˆå·¥ä½œã€‚</li>
</ul>


<p>äº†è§£æ­¤åŠŸèƒ½çš„å¼€å‘è¿‡ç¨‹ä¹Ÿå¾ˆæœ‰è¶£ã€‚åœ¨ LazyLayoutPrefetchState æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°æ§åˆ¶å®ƒçš„åŠŸèƒ½æ ‡å¿—ï¼š</p>

<pre><code class="Kotlin">// A simplified look inside LazyLayoutPrefetchState.kt: https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=647
if (ComposeFoundationFlags.isPausableCompositionInPrefetchEnabled) {
    // This is the future, modern path.
    performPausableComposition(key, contentType, average)
} else {
    // This is the older, non-pausable fallback.
    performFullComposition(key, contentType)
}
</code></pre>

<p>isPausableCompositionInPrefetchEnabled è¿™ä¸ªæ ‡å¿—å……å½“äº†ç»ˆæ­¢å¼€å…³çš„ä½œç”¨ã€‚è™½ç„¶å®ƒåœ¨æºä»£ç ä¸­çš„é»˜è®¤å€¼ä¸º falseã€‚å¦‚æœä½ æƒ³åœ¨æƒ°æ€§å¸ƒå±€ï¼ˆLazyColumnã€LazyRow ç­‰ï¼‰ä¸­å¯ç”¨å¯æš‚åœç»„åˆè¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŒ‰å¦‚ä¸‹æ–¹å¼å¯ç”¨å®ƒï¼š</p>

<pre><code class="Kotlin">class MyApplication : Application() {
    fun onCreate() {
        ComposeFoundationFlags.isPausableCompositionInPrefetchEnabled = true
        super.onCreate()
    }
}
</code></pre>

<h3>è§„åˆ’å™¨ï¼šLazyLayoutPrefetchState è¯¦è§£</h3>

<p>LazyLayoutPrefetchState æ˜¯é¢„å–æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„ä½œç”¨æ˜¯è·å–æ¥è‡ª LazyLayout çš„é¢„æµ‹ï¼ˆä¾‹å¦‚ï¼Œâ€œç¬¬ 25 é¡¹å³å°†ä¸Šçº¿â€ï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå®é™…çš„é¢„ç»„åˆä»»åŠ¡ã€‚</p>

<p>å®ƒé€šè¿‡ PrefetchHandleProvider å®ç°æ­¤æ“ä½œï¼Œè¯¥æä¾›è€…ä¼šåˆ›å»ºä¸€ä¸ª PrefetchRequestã€‚æ­¤è¯·æ±‚æ˜¯ PrefetchScheduler å¯ä»¥æ‰§è¡Œçš„å·¥ä½œå•å…ƒã€‚åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æš‚åœé€»è¾‘çš„æ ¸å¿ƒã€‚</p>

<p>å½“ PrefetchScheduler æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œå®ƒä¼šè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨ PausableComposition ä¸Šè°ƒç”¨ resume()ã€‚ä¼ é€’ç»™ resume çš„ lambda è¡¨è¾¾å¼å†³å®šæ˜¯å¦æš‚åœã€‚</p>

<p>å› æ­¤ï¼Œå¦‚æœå¯ç”¨äº†ä¸Šè¿°åŠŸèƒ½æ ‡è®°ï¼Œå®ƒå°†é€šè¿‡ Pausable Composition API æ‰§è¡Œè¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=754
// Simplified from HandleAndRequestImpl inside LazyLayoutPrefetchState
private fun PrefetchRequestScope.performPausableComposition(...) {
    val composition = // get the composition for the item of the LazyLayout 
    pauseRequested = false

    while (!composition.isComplete &amp;&amp; !pauseRequested) {
        composition.resume {
            if (!pauseRequested) {
                // 1. Update how much time is left in this frame's idle window.
                updateElapsedAndAvailableTime()

                // 2. Save how long this work chunk took, to improve future estimates.
                averages.saveResumeTimeNanos(elapsedTimeNanos)

                // 3. The Core Decision: Is there enough time left to do another
                //    chunk of work without risking a frame drop?
                pauseRequested = !shouldExecute(
                    availableTimeNanos,
                    averages.resumeTimeNanos + averages.pauseTimeNanos,
                )
            }
            // 4. Return the decision to the composition engine.
            pauseRequested
        }
    }

    updateElapsedAndAvailableTime()
    if (pauseRequested) {
        // If we decided to pause, record how long the final pause check took.
        averages.savePauseTimeNanos(elapsedTimeNanos)
    } else {
        // If we finished without pausing, record the time for the final resume chunk.
        averages.saveResumeTimeNanos(elapsedTimeNanos)
    }
}
</code></pre>

<p>è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼š</p>

<ol>
<li>updateElapsedAndAvailableTime()ï¼šåœ¨æ¢å¤ lambda å‡½æ•°å†…éƒ¨ï¼Œç³»ç»Ÿä¼šä¸æ–­æ£€æŸ¥è·ç¦»ä¸‹ä¸€å¸§éœ€è¦ç»˜åˆ¶è¿˜å‰©å¤šå°‘æ—¶é—´ã€‚</li>
<li>averages.saveResumeTimeNanos(&hellip;)ï¼šå®ƒä¼šè®°å½•æ¯ä¸ªå°å—åˆæˆå·¥ä½œæ‰€éœ€çš„æ—¶é—´ã€‚è¿™æœ‰åŠ©äºå®ƒæ„å»ºä¸€ä¸ªå¹³å‡å€¼ (averages) æ¥é¢„æµ‹æœªæ¥å·¥ä½œçš„æˆæœ¬ã€‚</li>
<li>!shouldExecute(&hellip;)ï¼šè¿™æ˜¯æ ¸å¿ƒå†³ç­–ã€‚å®ƒä¼šå°† availableTimeNanos ä¸é¢„ç®—è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªé¢„ç®—æ˜¯ä¸€ä¸ªæ™ºèƒ½ä¼°ç®—ï¼šå®Œæˆå¦ä¸€å—å·¥ä½œæ‰€éœ€çš„å¹³å‡æ—¶é—´åŠ ä¸Šæš‚åœæ‰€éœ€çš„å¹³å‡æ—¶é—´ã€‚å¦‚æœæ—¶é—´ä¸è¶³ï¼ŒpauseRequested ä¼šå˜ä¸º trueã€‚</li>
<li>æœ€ç»ˆè®¡æ—¶ï¼šåœ¨æœ¬æ¬¡å¾ªç¯é€€å‡ºåï¼ˆå› ä¸ºå·¥ä½œå®Œæˆæˆ–è¯·æ±‚æš‚åœï¼‰ï¼Œä¼šè°ƒç”¨æœ€åä¸€æ¬¡ updateElapsedAndAvailableTime()ã€‚è¿™ä¼šæ•è·æœ€åä¸€ä¸ªæ“ä½œçš„æ—¶é—´ã€‚</li>
<li>ä¿å­˜å¹³å‡å€¼ï¼šç„¶åç³»ç»Ÿä¼šä¿å­˜è¿™ä¸ªæœ€ç»ˆè®¡æ—¶ã€‚å¦‚æœè¯·æ±‚äº†æš‚åœï¼Œåˆ™å®ƒä¼šå½±å“ pauseTimeNanosã€‚å¦‚æœå¾ªç¯è‡ªç„¶å®Œæˆï¼Œåˆ™å®ƒä¼šå½±å“ resumeTimeNanosã€‚è¿™ç¡®ä¿äº†ç”¨äºæœªæ¥é¢„æµ‹çš„å†å²æ•°æ®å§‹ç»ˆå‡†ç¡®ã€‚</li>
</ol>


<p>è¿™ç§è‡ªæˆ‘è°ƒèŠ‚çš„åé¦ˆå¾ªç¯å…è®¸é¢„å–å™¨åœ¨ç³»ç»Ÿç©ºé—²æ—¶ä¿æŒç§¯æä¸»åŠ¨ï¼Œä½†åœ¨éœ€è¦æ¸²æŸ“ UI æ—¶åˆèƒ½ä¿æŒç¤¼è²Œï¼Œå°Šé‡ä¸»çº¿ç¨‹ã€‚</p>

<h3>æœ€åä¸€æ­¥ï¼šåº”ç”¨é¢„ç»„åˆ UI</h3>

<p>é‚£ä¹ˆï¼Œå½“å±å¹•ä¸ŠçœŸæ­£éœ€è¦é¢„ç»„åˆçš„é¡¹ç›®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè¿™æ—¶ SubcomposeLayout å°±å æ®äº†ä¸­å¿ƒä½ç½®ã€‚åœ¨æ­£å¸¸çš„æµ‹é‡è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä¸ºç°åœ¨å¯è§çš„é¡¹ç›®è°ƒç”¨å…¶ subcompose å‡½æ•°ã€‚åœ¨å†…éƒ¨ï¼Œè¿™ä¼šè§¦å‘æœ€åä¸€æ­¥ã€‚</p>

<pre><code class="Kotlin">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/ui/ui/src/commonMain/kotlin/androidx/compose/ui/layout/SubcomposeLayout.kt;l=1186
// Simplified from LayoutNodeSubcompositionsState inside SubcomposeLayout.kt
private fun NodeState.applyPausedPrecomposition(shouldComplete: Boolean) {
    val pausedComposition = this.pausedComposition
    if (pausedComposition != null) {
        // 1. If the work must be completed now...
        if (shouldComplete) {
            // ...force the composition to finish by looping `resume`
            // and always passing `false` to the `shouldPause` callback.
            while (!pausedComposition.isComplete) {
                pausedComposition.resume { false }
            }
        }
        // 2. Apply the changes to the real UI tree.
        pausedComposition.apply()
        this.pausedComposition = null // Clear the handle.
    }
}
</code></pre>

<p>å½“æŸä¸ªé¡¹ç›®å¯è§æ—¶ï¼Œå…¶ç»„åˆä¸å†æ˜¯ä½ä¼˜å…ˆçº§çš„åå°ä»»åŠ¡ï¼Œè€Œæ˜¯é«˜ä¼˜å…ˆçº§çš„åŒæ­¥ä»»åŠ¡ã€‚shouldComplete = true å‚æ•°ç¡®ä¿æ‰€æœ‰å‰©ä½™çš„ç»„åˆå·¥ä½œç«‹å³å®Œæˆï¼Œæ— éœ€æš‚åœã€‚ç„¶åï¼Œapply() è¢«è°ƒç”¨ï¼Œå®Œæ•´çš„ UI ä¼šç«‹å³æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>

<p>å®ƒä»¬å¦‚ä½•ååŒå·¥ä½œï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751799217100/82837ef0-e97e-49c7-bee6-cd68ab1804ba.png?auto=compress,format&amp;format=webp" alt="LazyListæ»šåŠ¨æ—¶åºå›¾" /></p>

<h2>ç»“è®º</h2>

<p>æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶åï¼ŒPausableComposition çš„è®¾è®¡å ªç§°æ€§èƒ½å·¥ç¨‹çš„æ°ä½œã€‚</p>

<ul>
<li>å®ƒå¹¶éé­”æ³•ï¼Œè€Œæ˜¯å»¶è¿Ÿï¼šå…¶æ ¸å¿ƒç†å¿µæ˜¯åœ¨ç´§æ€¥ä»»åŠ¡ä¹‹å‰å®Œæˆã€‚é€šè¿‡åœ¨ç©ºé—²æ—¶é—´åˆæˆé¡¹ç›®ï¼Œå¿«é€Ÿæ»šåŠ¨æ—¶ä¸»çº¿ç¨‹æ‰€éœ€çš„å·¥ä½œé‡ä¼šå¤§å¤§å‡å°‘ã€‚</li>
<li>åä½œå¼å’Œéé˜»å¡å¼ï¼šshouldPause å›è°ƒæ˜¯å¤„ç†å¤šä»»åŠ¡çš„ç»ä½³æ–¹å¼ã€‚å®ƒå¯ä»¥è®©é•¿æ—¶é—´è¿è¡Œçš„åˆæˆä»»åŠ¡ä¼˜é›…åœ°è®©ä½äºæ›´ç´§æ€¥çš„å½“å‰å¸§æ¸²æŸ“ä»»åŠ¡ï¼Œä»è€Œç›´æ¥é˜²æ­¢å¡é¡¿ã€‚</li>
<li>é€šè¿‡æ‰¹å¤„ç†æé«˜æ•ˆç‡ï¼šRecordingApplier é€šè¿‡å°† UI æ ‘ä¸­çš„è®¸å¤šå°çš„ç‹¬ç«‹æ›´æ”¹åˆ†ç»„ä¸ºå•ä¸ªé«˜æ•ˆçš„æ›´æ–°ï¼Œé¿å…äº†è¿™äº›æ›´æ”¹å¸¦æ¥çš„å¼€é”€ã€‚</li>
</ul>


<p>è™½ç„¶ PausableComposition æ˜¯ä¸€ä¸ªä½ å¯èƒ½æ°¸è¿œä¸ä¼šç›´æ¥ä½¿ç”¨çš„å†…éƒ¨åŠŸèƒ½ï¼Œä½†äº†è§£å®ƒçš„å­˜åœ¨å’Œè¿ä½œæ–¹å¼ï¼Œå¯ä»¥è®©ä½ çœŸæ­£ä½“ä¼šåˆ° Jetpack Compose å¦‚æ­¤é«˜æ€§èƒ½çš„æ˜æ™ºå†³ç­–ã€‚ä¸‹æ¬¡ä½ è½»æ¾æµç•…åœ°æ»šåŠ¨æµè§ˆå¤æ‚çš„ LazyColumn æ—¶ï¼Œä½ å°±ä¼šä½“ä¼šåˆ°è¿™å·§å¦™ä¸”ç²¾å¿ƒç¼–æ’çš„â€œèˆè¹ˆâ€æ˜¯å¦‚ä½•åœ¨è¡¨é¢ä¹‹ä¸‹è¿›è¡Œçš„ã€‚âœ… è¿™ç§æ¶æ„ä¸ä»…è§£å†³äº†å½“å‰çš„æ€§èƒ½æŒ‘æˆ˜ï¼Œè¿˜ä¸º Compose æœªæ¥æ›´å…ˆè¿›çš„æ¸²æŸ“ç­–ç•¥é“ºå¹³äº†é“è·¯ã€‚</p>

<p>å¸Œæœ›ä½ å·²ç»äº†è§£äº†è¿™ä¸ªæ–° API åœ¨ Jetpack Compose ä¸­çš„å·¥ä½œåŸç†ã€‚</p>

<p>å¤ªæ£’äº†ï¼å¸Œæœ›ä½ ä»ä¸­è·å¾—äº†ä¸€äº›å®è´µçš„è§è§£ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº« ğŸ˜‰ï¼Œå› ä¸ºâ€¦â€¦</p>

<p>â€œåˆ†äº«å³å…³çˆ±â€</p>

<p>è°¢è°¢ï¼ğŸ˜„</p>

<p>è®©æˆ‘ä»¬ä¸€èµ·å›é¡¾ X ï¼ˆé“¾æ¥ï¼š<a href="https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF">https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF</a> ğŸ˜ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SnapshotFlowè¿˜æ˜¯collectAsStateï¼Ÿå¯¹äºJetpack Composeæ¥è¯´å“ªä¸ªæ›´é¦™ï¼Ÿ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"/>
    <updated>2025-07-16T22:31:22+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒSnapshotFlow or collectAsState? How to pick the right tool for Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123">https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123</a>ï¼Œç”±Dmitry Glazunovå‘å¸ƒäº2025å¹´7æœˆ7æ—¥ã€‚</p>

<p><a href=""><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P0darOG2IeBIDWdY" title="auto auto" ></a></p>

<!-- more -->


<p>æ„å»º UI å¯èƒ½æ„Ÿè§‰å¾ˆç®€å•ï¼Œç›´åˆ°éœ€è¦è®¢é˜…çŠ¶æ€å˜åŒ–å¹¶æœ‰æ•ˆå¤„ç†å‰¯ä½œç”¨æ—¶ä¹‹å‰ã€‚è®¸å¤šå¼€å‘è€…è¿‡åº¦ä½¿ç”¨ collectAsStateï¼Œå¯¼è‡´å»¶è¿Ÿå’Œæ„å¤–çš„é‡ç»„ï¼ˆreCompositionï¼‰ã€‚è¿˜æœ‰ä¸€äº›äººå¬è¯´è¿‡ snapshotFlowï¼Œä½†å´ä¸å¤ªæ˜ç™½æ—¢ç„¶ StateFlow å’Œ collectAsState å·²ç»å­˜åœ¨ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å®ƒï¼Ÿ</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†é€šè¿‡æ¢ç´¢å®é™…é¡¹ç›®ä¸­ç®€çŸ­ä¸”å®ç”¨çš„ç¤ºä¾‹ï¼Œåˆ†äº«æˆ‘å¯¹ä½•æ—¶ä½¿ç”¨ snapshotFlow ä»¥åŠä½•æ—¶æ›´é€‚åˆä½¿ç”¨ collectAsState çš„çœ‹æ³•ï¼Œå¸®åŠ©ä½ é¿å…é¡¹ç›®ä¸­éšè—çš„ bug å’Œæ€§èƒ½é—®é¢˜ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>

<h2>collectAsState çš„ä½œç”¨</h2>

<p>collectAsState åœ¨ Compose ä¸­è®¢é˜… Flowï¼Œå¹¶è‡ªåŠ¨å°†å…¶å…¬å¼€ä¸ºStateï¼Œä»¥ä¾¿åœ¨ UI ä¸­è½»æ¾æ˜¾ç¤ºï¼š</p>

<pre><code class="Kotlin">val uiState by viewModel.uiStateFlow.collectAsState()
Text(uiState.text)
</code></pre>

<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸æ˜“äºä½¿ç”¨ã€‚</li>
<li>é‡ç»„æ—¶è‡ªåŠ¨å–æ¶ˆå¹¶é‡æ–°å¼€å§‹æ”¶é›†ã€‚</li>
<li>éå¸¸é€‚åˆ ViewModel â†’ UI æ•°æ®ç»‘å®šã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>æ¯æ¬¡å‘å‡ºæ–°æ•°æ®æ—¶éƒ½ä¼šè§¦å‘é‡ç»„ï¼Œå“ªæ€•åªæ˜¯å‘ç”Ÿäº†å¾®å°çš„å˜åŒ–ã€‚</li>
<li>å¯ç»„åˆé¡¹è¿›å…¥é‡ç»„çŠ¶æ€åç«‹å³å¼€å§‹æ”¶é›†ã€‚</li>
<li>ä¸é€‚ç”¨äºè§‚å¯Ÿ Compose ç‰¹æœ‰çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ»šåŠ¨æˆ–æ‰‹åŠ¿ã€‚</li>
</ul>


<h2>å¿«ç…§æµ (snapshotFlow) çš„ä½œç”¨</h2>

<p>å¿«ç…§æµ (snapshotFlow) å°† Compose çŠ¶æ€ï¼ˆä¾‹å¦‚ LazyListState ã€ derivedStateOf ï¼‰è½¬æ¢ä¸ºå†·æµ (cold Flow)ï¼Œè®©ä½ æ— éœ€è¿›è¡Œä¸å¿…è¦çš„é‡ç»„å³å¯å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”ï¼š</p>

<pre><code class="Kotlin">val listState = rememberLazyListState()

LaunchedEffect(Unit) {
    snapshotFlow { listState.firstVisibleItemIndex }
        .distinctUntilChanged()
        .collect { index -&gt;
            analytics.logScrollPosition(index)
        }
}
</code></pre>

<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸é€‚åˆ Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ã€‚</li>
<li>ä¸ä¼šè§¦å‘é‡ç»„ã€‚</li>
<li>å¯åœ¨ LaunchedEffect æˆ–åç¨‹ä¸­ä½¿ç”¨ã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>ä¸ä¼šå…¬å¼€çŠ¶æ€ä»¥è¿›è¡Œç›´æ¥ UI æ¸²æŸ“ã€‚</li>
<li>ä¸ä¼šæ›¿ä»£ CollectAsState æ¥å®ç° ViewModel â†’ UI æ›´æ–°ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ collectAsState</h2>

<ul>
<li>ä» ViewModel è®¢é˜… UI çš„ Flow æˆ– StateFlowã€‚</li>
<li>åœ¨ UI ä¸­æ˜¾ç¤ºæ•°æ®ï¼ˆæ–‡æœ¬ã€åŠ è½½çŠ¶æ€ã€è·å–çš„æ•°æ®ï¼‰ã€‚</li>
<li>ç”¨æˆ·éœ€è¦çœ‹åˆ°çš„ä½é¢‘æ›´æ–°ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>é«˜é¢‘æ›´æ–°ï¼ˆæ»šåŠ¨åç§»ã€ä¼ æ„Ÿå™¨æ•°æ®ï¼‰ã€‚</li>
<li>è§¦å‘ä¸éœ€è¦ UI æ›´æ–°çš„å‰¯ä½œç”¨ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ snaphotFlow</h2>

<ul>
<li>å“åº” Compose çŠ¶æ€ï¼ˆæ»šåŠ¨ã€æ‰‹åŠ¿ã€åŠ¨ç”»ï¼‰ã€‚</li>
<li>è§¦å‘å‰¯ä½œç”¨ä½†ä¸ä¼šå¯¼è‡´é‡ç»„ã€‚</li>
<li>ä» Compose çŠ¶æ€æ„å»º Flow ç®¡é“ï¼ˆåˆ†æã€å»¶è¿ŸåŠ è½½è§¦å‘å™¨ï¼‰ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>ç›´æ¥ UI æ•°æ®æ¸²æŸ“ã€‚</li>
<li>ç”¨ viewModel â†’ UI æµæ›¿æ¢ collectAsStateã€‚</li>
</ul>


<h2>snapshotFlow çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šä½¿ç”¨ snaphotFlow.collectAsState è¿›è¡ŒåŠ¨ç”»è¿›åº¦</p>

<pre><code class="Kotlin">val progress by snapshotFlow { animationState.progress }
    .collectAsState(initial = 0f)

Text("Progress: ${(progress * 100).toInt()}%")
</code></pre>

<p>ä½¿ç”¨ snaphotFlow å’Œ collectAsState æ¥é©±åŠ¨åŠ¨ç”»è¿›åº¦çš„ UI æ›´æ–°ä¼šå¯¼è‡´æ¯ä¸€å¸§éƒ½é‡æ–°åˆæˆï¼Œä»è€Œå¯¼è‡´å¡é¡¿ï¼Œè¿èƒŒäº† snaphotFlow çš„åˆè¡·ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ snaphotFlow åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¿›è¡Œåˆ†æ</p>

<pre><code class="Kotlin">LaunchedEffect(Unit) {
    snapshotFlow { animationState.progress }
        .distinctUntilChanged { old, new -&gt;
            (old * 100).toInt() == (new * 100).toInt()
        }
        .collect { progress -&gt;
            analytics.logAnimationProgress(progress)
        }
}
</code></pre>

<p>è¿™ä¼šè·Ÿè¸ªåŠ¨ç”»è¿›åº¦ï¼Œä»¥ä¾¿è¿›è¡Œåˆ†ææˆ–è®°å½•ï¼Œè€Œä¸ä¼šè§¦å‘ UI é‡æ„ã€‚</p>

<h2>collectAsState çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šå°† collectAsState ç”¨äºé«˜é¢‘æ»šåŠ¨æ•°æ®</p>

<pre><code class="Kotlin">val scrollOffset by viewModel.scrollOffsetFlow.collectAsState()
Text("Offset: $scrollOffset")
</code></pre>

<p>è¿™ä¼šåœ¨æ»šåŠ¨çš„æ¯ä¸ªåƒç´ ä¸Šè§¦å‘é‡æ–°åˆæˆï¼Œå¯¼è‡´ CPU è¿‡è½½ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ collectAsState è·å–æœ‰æ„ä¹‰çš„ UI æ•°æ®</p>

<pre><code class="Kotlin">val userName by viewModel.userNameFlow.collectAsState()
Text("Hello, $userName!")
</code></pre>

<p>è¿™é€‚ç”¨äºæ˜¾ç¤ºç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸”ä¸ç»å¸¸æ›´æ”¹çš„æ•°æ®ã€‚</p>

<h2>ç»“è®º</h2>

<p>collectAsState å’Œ snapshotFlow ç›¸è¾…ç›¸æˆï¼š</p>

<ul>
<li>ä½¿ç”¨ collectAsState åœ¨ UI ä¸­æ˜¾ç¤º ViewModel æ•°æ®ã€‚</li>
<li>ä½¿ç”¨ snapshotFlow å“åº” Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ï¼Œè€Œæ— éœ€è§¦å‘é‡ç»„ã€‚</li>
</ul>


<p>æ­£ç¡®ä½¿ç”¨å®ƒä»¬å°†å¸®åŠ©ä½ é¿å…ä¸å¿…è¦çš„é‡ç»„ï¼Œæå‡åº”ç”¨çš„å“åº”é€Ÿåº¦ï¼Œå¹¶ä¿æŒ Compose ä»£ç ç®€æ´ã€å¯æ‰©å±•ä¸”å¯é¢„æµ‹ã€‚</p>

<p>å¦‚æœä½ è§‰å¾—æœ¬æ–‡åˆ†ææœ‰ç”¨ï¼Œè¯·éšæ—¶å…³æ³¨æˆ‘ä»¥è·å–æ›´å¤šè§è§£ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Kotlin Multiplatformé¡¹ç›®ä¸­ä½¿ç”¨DataStore]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/04/datastore-in-kmp/"/>
    <updated>2025-06-04T23:05:35+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/04/datastore-in-kmp</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒImplementing DataStore in Kotlin Multiplatform Projectsã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://carrion.dev/en/posts/datastore-in-kmp/">https://carrion.dev/en/posts/datastore-in-kmp/</a>ï¼Œç”± Ignacio CarriÃ³nå‘å¸ƒäº2025å¹´5æœˆ9æ—¥ã€‚</p></blockquote>

<p>DataStore æ˜¯ Google å¼€å‘çš„ä¸€ç§ç°ä»£æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ›¿ä»£ SharedPreferencesã€‚å®ƒæä¾›äº†ä¸€ä¸ªä¸€è‡´ã€ç±»å‹å®‰å…¨çš„ APIï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹å’Œç±»å‹åŒ–å¯¹è±¡ï¼Œå¹¶æ”¯æŒ Kotlin åç¨‹å’Œ Flowã€‚éšç€ Kotlin Multiplatform (KMP) çš„æœ€æ–°è¿›å±•ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°† DataStore é›†æˆåˆ° KMP é¡¹ç›®ä¸­ï¼Œä»è€Œå®ç°è·¨å¹³å°å…±äº«åå¥½è®¾ç½®å’Œæ•°æ®å­˜å‚¨ä»£ç ã€‚è¿™ç¯‡åšæ–‡æ¢è®¨äº†å¦‚ä½•åœ¨ KMP ç¯å¢ƒä¸­é…ç½®ã€å®ç°å’Œä¼˜åŒ– DataStoreã€‚</p>

<p><a href=""><img src="file:///Users/alexhilton/Downloads/datastore.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç†è§£ Kotlin å¤šå¹³å°ç¯å¢ƒä¸­çš„ DataStore</h2>

<p>KMP ä¸­çš„ DataStore æ—¨åœ¨æä¾›è·¨å¹³å°ä¸€è‡´çš„ APIï¼ŒåŒæ—¶åˆ©ç”¨å¹³å°ç‰¹å®šçš„å­˜å‚¨æœºåˆ¶ã€‚DataStore æœ‰ä¸¤ç§ç±»å‹ï¼š</p>

<ol>
<li>Preferences DataStoreï¼šç”¨äºå­˜å‚¨é”®å€¼å¯¹</li>
<li>Proto DataStoreï¼šç”¨äºä½¿ç”¨åè®®ç¼“å†²åŒºå­˜å‚¨ç±»å‹åŒ–å¯¹è±¡</li>
</ol>


<p>åœ¨ KMP ä¸Šä¸‹æ–‡ä¸­ï¼ŒDataStoreï¼š</p>

<ol>
<li>å¹³å°ç‰¹å®šçš„å®ç°æä¾›å®é™…çš„å­˜å‚¨æœºåˆ¶</li>
<li>API ä½¿ç”¨åç¨‹å’Œ Flowï¼Œè·¨å¹³å°ä¿æŒä¸€è‡´</li>
</ol>


<p>è¿™ç§æ–¹æ³•ä½¿æˆ‘ä»¬èƒ½å¤Ÿç”¨é€šç”¨ä»£ç å®šä¹‰æ•°æ®è®¿é—®æ¨¡å¼ï¼Œè€Œåº•å±‚å­˜å‚¨æ“ä½œåˆ™ç”±å¹³å°ç‰¹å®šçš„å®ç°å¤„ç†ã€‚</p>

<pre><code class="Kotlin">// In commonMain - DataStore interface
interface UserPreferences {
    val userData: Flow&lt;UserData&gt;
    suspend fun updateUsername(name: String)
    suspend fun updateEmail(email: String)
    suspend fun clearData()
}

// In commonMain - Data model
data class UserData(
    val username: String = "",
    val email: String = "",
    val isLoggedIn: Boolean = false
)
</code></pre>

<h2>åœ¨ KMP é¡¹ç›®ä¸­è®¾ç½®æ•°æ®å­˜å‚¨</h2>

<p>è¦å°† DataStore é›†æˆåˆ°ä½ çš„ KMP é¡¹ç›®ä¸­ï¼Œä½ éœ€è¦æ­£ç¡®é…ç½®æ„å»ºæ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯åˆ†æ­¥æŒ‡å—ï¼š</p>

<h3>1. åœ¨å…±äº«æ¨¡å—ä¸­é…ç½® build.gradle.kts æ–‡ä»¶</h3>

<pre><code class="Kotlin">plugins {
    kotlin("multiplatform")
    id("com.android.library")
    id("com.google.devtools.ksp") version "2.1.20-2.0.1" // For Proto DataStore
}

kotlin {
    androidTarget()
    iosX64()
    iosArm64()
    iosSimulatorArm64()

    sourceSets {
        val commonMain by getting {
            dependencies {
                // For Preferences DataStore
                implementation("androidx.datastore:datastore-preferences-core:1.1.0")

                // For coroutines
                implementation("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3")
            }
        }
    }
}
</code></pre>

<h3>2. ä»é€šç”¨ä»£ç åˆ›å»º DataStore å®ä¾‹</h3>

<pre><code class="Kotlin">/**
 * è·å–å•ä¾‹ DataStore å®ä¾‹ï¼Œå¦‚æœ‰å¿…è¦åˆ™åˆ›å»ºå®ƒã€‚
 */
fun createDataStore(producePath: () -&gt; String): DataStore&lt;Preferences&gt; =
   PreferenceDataStoreFactory.createWithPath(
      produceFile = { producePath().toPath() }
   )

internal const val dataStoreFileName = "dice.preferences_pb"
</code></pre>

<h2>ç‰¹å®šå¹³å°çš„è€ƒè™‘å› ç´ </h2>

<h3>Android å®ç°</h3>

<pre><code class="Kotlin">// shared/src/androidMain/kotlin/DataStore.kt

fun createDataStoreAndroid(context: Context): DataStore&lt;Preferences&gt; = createDataStore(
   producePath = { context.filesDir.resolve(dataStoreFileName).absolutePath }
)
</code></pre>

<h3>iOS å®ç°</h3>

<pre><code class="Kotlin">// shared/src/iosMain/kotlin/DataStore.kt

fun createDataStoreIOS(): DataStore&lt;Preferences&gt; = createDataStore(
   producePath = {
      val documentDirectory: NSURL? = NSFileManager.defaultManager.URLForDirectory(
         directory = NSDocumentDirectory,
         inDomain = NSUserDomainMask,
         appropriateForURL = null,
         create = false,
         error = null,
      )
      requireNotNull(documentDirectory).path + "/$dataStoreFileName"
   }
)
</code></pre>

<h2>å®é™…ç¤ºä¾‹ï¼šå®ç°ç”¨æˆ·åå¥½å­˜å‚¨åº“</h2>

<p>ä¸ºäº†æ¼”ç¤ºå®Œæ•´çš„å®ç°ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ DataStore çš„å­˜å‚¨åº“ï¼š</p>

<pre><code class="Kotlin">// In commonMain
class UserPreferencesRepository(private val dataStore: PreferencesDataStore) {
    //å®šä¹‰preferencesçš„é”®
    private object PreferenceKeys {
        val USERNAME = stringPreferencesKey("username")
        val EMAIL = stringPreferencesKey("email")
        val IS_LOGGED_IN = booleanPreferencesKey("is_logged_in")
    }

    // Get user data as a Flow
    val userData: Flow&lt;UserData&gt; = dataStore.data.map { preferences -&gt;
        UserData(
            username = preferences[PreferenceKeys.USERNAME] ?: "",
            email = preferences[PreferenceKeys.EMAIL] ?: "",
            isLoggedIn = preferences[PreferenceKeys.IS_LOGGED_IN] ?: false
        )
    }

    // Update username
    suspend fun updateUsername(name: String) {
        dataStore.updateData { preferences -&gt;
            preferences.toMutablePreferences().apply {
                this[PreferenceKeys.USERNAME] = name
            }
        }
    }

    // Update email
    suspend fun updateEmail(email: String) {
        dataStore.updateData { preferences -&gt;
            preferences.toMutablePreferences().apply {
                this[PreferenceKeys.EMAIL] = email
            }
        }
    }

    // Set login status
    suspend fun setLoggedIn(isLoggedIn: Boolean) {
        dataStore.updateData { preferences -&gt;
            preferences.toMutablePreferences().apply {
                this[PreferenceKeys.IS_LOGGED_IN] = isLoggedIn
            }
        }
    }

    // Clear all data
    suspend fun clearData() {
        dataStore.updateData { preferences -&gt;
            preferences.toMutablePreferences().apply {
                remove(PreferenceKeys.USERNAME)
                remove(PreferenceKeys.EMAIL)
                remove(PreferenceKeys.IS_LOGGED_IN)
            }
        }
    }
}

// In commonMain - ViewModel or Presenter
class UserViewModel(private val userPreferencesRepository: UserPreferencesRepository) {
    val userData: Flow&lt;UserData&gt; = userPreferencesRepository.userData

    suspend fun updateUserProfile(username: String, email: String) {
        if (username.isNotBlank()) {
            userPreferencesRepository.updateUsername(username)
        }

        if (email.isNotBlank()) {
            userPreferencesRepository.updateEmail(email)
        }
    }

    suspend fun login() {
        userPreferencesRepository.setLoggedIn(true)
    }

    suspend fun logout() {
        userPreferencesRepository.setLoggedIn(false)
    }

    suspend fun clearUserData() {
        userPreferencesRepository.clearData()
    }
}
</code></pre>

<h2>KMP ä¸­çš„é«˜çº§æ•°æ®å­˜å‚¨åŠŸèƒ½</h2>

<p>DataStore æä¾›äº†å‡ ç§å¯åœ¨ KMP ç¯å¢ƒä¸­åˆ©ç”¨çš„é«˜çº§åŠŸèƒ½ï¼š</p>

<h3>1. ç”¨äºç±»å‹åŒ–å¯¹è±¡çš„ Proto DataStore</h3>

<p>å¦‚æœä½ éœ€è¦å­˜å‚¨å¤æ‚å¯¹è±¡ï¼ŒProto DataStore æä¾›äº†ä¸€ä¸ªç±»å‹å®‰å…¨çš„è§£å†³æ–¹æ¡ˆï¼š</p>

<pre><code class="proto">// åœ¨ .proto æ–‡ä»¶ä¸­å®šä¹‰æ•°æ®ç»“æ„
syntax = "proto3";

option java_package = "com.example.app";
option java_multiple_files = true;

message UserPreferences {
  string username = 1;
  string email = 2;
  bool is_logged_in = 3;
}
</code></pre>

<pre><code class="Kotlin">// In commonMain - åˆ›å»ºåºåˆ—åŒ–å™¨
class UserPreferencesSerializer : Serializer&lt;UserPreferences&gt; {
    override val defaultValue: UserPreferences = UserPreferences.getDefaultInstance()

    override suspend fun readFrom(input: InputStream): UserPreferences {
        return UserPreferences.parseFrom(input)
    }

    override suspend fun writeTo(t: UserPreferences, output: OutputStream) {
        t.writeTo(output)
    }
}

// Proto DataStore çš„å¹³å°ç‰¹å®šå®ç°
</code></pre>

<h3>2.æ•°æ®è¿ç§»</h3>

<pre><code class="Kotlin">// In androidMain - ä» SharedPreferences è¿ç§»åˆ° DataStore
val dataStore = context.createDataStore(
    name = "user_preferences",
    produceMigrations = { context -&gt;
        listOf(
            SharedPreferencesMigration(
                context = context,
                sharedPreferencesName = "legacy_preferences"
            )
        )
    }
)
</code></pre>

<h3>3.å¤„ç†å¼‚å¸¸</h3>

<pre><code class="Kotlin">// In commonMain - æ•°æ®æ“ä½œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸å¤„ç†
val userData = dataStore.data
    .catch { exception -&gt;
        // å¤„ç†å¼‚å¸¸ï¼ˆä¾‹å¦‚æ•°æ®æŸåï¼‰
        if (exception is IOException) {
            emit(emptyPreferences())
        } else {
            throw exception
        }
    }
    .map { preferences -&gt;
        // Map preferences to your data model
        UserData(
            username = preferences[USERNAME] ?: "",
            email = preferences[EMAIL] ?: ""
        )
    }
</code></pre>

<h2>KMP ä¸­æ•°æ®å­˜å‚¨çš„æœ€ä½³å®è·µ</h2>

<ol>
<li>åˆ©ç”¨åç¨‹å’Œ Flow è¿›è¡Œå¼‚æ­¥æ“ä½œ

<ul>
<li>DataStore æ“ä½œæœ¬è´¨ä¸Šæ˜¯å¼‚æ­¥çš„</li>
<li>ä½¿ç”¨ Flow è§‚å¯Ÿå­˜å‚¨æ•°æ®çš„å˜åŒ–</li>
<li>åº”ç”¨ Mapã€Filter å’Œ Combine ç­‰ Flow æ“ä½œç¬¦è¿›è¡Œæ•°æ®è½¬æ¢</li>
</ul>
</li>
<li>åˆ›å»ºå­˜å‚¨åº“å±‚

<ul>
<li>å°† DataStore æ“ä½œæŠ½è±¡åˆ°å­˜å‚¨åº“åé¢</li>
<li>è¿™æ ·å¯ä»¥æ›´è½»æ¾åœ°æ ¹æ®éœ€è¦åˆ‡æ¢å®ç°</li>
<li>ä¸ºä½ çš„ä¸šåŠ¡é€»è¾‘æä¾›ç®€æ´çš„ API</li>
</ul>
</li>
<li>ä¼˜é›…åœ°å¤„ç†é”™è¯¯

<ul>
<li>ä½¿ç”¨ catch æ“ä½œç¬¦å¤„ç† Flow ä¸­çš„å¼‚å¸¸</li>
<li>åœ¨æ— æ³•è¯»å–æ•°æ®æ—¶æä¾›å›é€€å€¼</li>
<li>è€ƒè™‘ä¸ºå…³é”®æ“ä½œå®ç°é‡è¯•æœºåˆ¶</li>
</ul>
</li>
<li>ä¼˜åŒ–æ€§èƒ½

<ul>
<li>æœ€å¤§é™åº¦åœ°å‡å°‘ DataStore æ›´æ–°æ¬¡æ•°</li>
<li>å°†ç›¸å…³çš„æ›´æ”¹é›†ä¸­å¤„ç†</li>
<li>ä½¿ç”¨ distinctUntilChanged() é¿å…ä¸å¿…è¦çš„æ’æ”¾</li>
</ul>
</li>
<li>å½»åº•æµ‹è¯•ä½ çš„ DataStore ä»£ç 

<ul>
<li>åœ¨ commonTest ä¸­ä¸ºä½ çš„å­˜å‚¨åº“ç¼–å†™æµ‹è¯•</li>
<li>ä½¿ç”¨æµ‹è¯•æ›¿èº«æ¨¡æ‹Ÿä¸åŒçš„åœºæ™¯</li>
</ul>
</li>
</ol>


<h2>ç»“è®º</h2>

<p>å°† DataStore é›†æˆåˆ° Kotlin Multiplatform é¡¹ç›®ä¸­ï¼Œæä¾›äº†ä¸€ç§ç°ä»£åŒ–ã€ç±»å‹å®‰å…¨çš„è·¨å¹³å°æ•°æ®å­˜å‚¨å’Œè®¿é—®æ–¹æ³•ã€‚</p>

<p>æœ¬æ–‡æ¦‚è¿°çš„æ–¹æ³•æä¾›äº†ä¸€ç§å®ç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥è·¨å¹³å°å…±äº«é¦–é€‰é¡¹å’Œæ•°æ®å­˜å‚¨é€»è¾‘ï¼Œå¹¶ä¸”åªéœ€æå°‘çš„å¹³å°ç‰¹å®šä»£ç ã€‚DataStore å¯¹åç¨‹å’Œ Flow çš„æ”¯æŒä½¿å…¶ä¸ KMP é¡¹ç›®å®Œç¾å¥‘åˆï¼Œèƒ½å¤Ÿé€šè¿‡ä¸€è‡´çš„ API å®ç°å“åº”å¼å’Œå¼‚æ­¥æ•°æ®æ“ä½œã€‚</p>

<p>é€šè¿‡éµå¾ªæœ¬æ–‡æ¦‚è¿°çš„é…ç½®æ­¥éª¤ã€å¹³å°ç‰¹å®šæ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥åœ¨ KMP é¡¹ç›®ä¸­æˆåŠŸå®ç° DataStoreï¼Œå¹¶åˆ›å»ºç¨³å®šã€é«˜æ•ˆçš„è·¨å¹³å°æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”åªéœ€æå°‘çš„å¹³å°ç‰¹å®šä»£ç ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ­ç§˜åŸç”ŸViewä¸Jetpack Composeä¹‹é—´çš„ä¼ é€é—¨]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/02/android-vies-in-compose/"/>
    <updated>2025-06-02T21:44:19+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/02/android-vies-in-compose</id>
    <content type="html"><![CDATA[<p>èŠ³è²éšæ˜¥å»ï¼Œç¢§ç»¿å…¥å¤æ¥ï¼Œä¸çŸ¥ä¸è§‰ä¸­<a href="https://juejin.cn/column/7367555191338467337">Composeä¸“é¢˜</a>å·²ç»å†™äº†è¿‘40ç¯‡æ–‡ç« äº†ï¼Œä»Composeå„ç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼Œåˆ°Composeçš„ç¼–ç¨‹æ€æƒ³ï¼Œå†åˆ°å†…éƒ¨åŸç†å’Œæœ€ä½³å®è·µã€‚é€šè¿‡<a href="https://juejin.cn/column/7367555191338467337">è¿™ä¸€ç³»åˆ—çš„æ–‡ç« </a>ç›¸ä¿¡å¯¹Composeå·²ç»æœ‰äº†è¶³å¤Ÿçš„ç†è§£ï¼Œèƒ½å¤Ÿåœ¨é¡¹ç›®ä¸­è¿›è¡Œå®æˆ˜å’Œè¿ç”¨ã€‚å­¦æ— æ­¢å¢ƒï¼Œä»Šå¤©å°†ç»§ç»­å­¦ä¹ ï¼Œé‡ç‚¹æ¢è®¨å¦‚ä½•åœ¨å·²æœ‰çš„é¡¹ç›®ä¸­ä½¿ç”¨Composeã€‚</p>

<p><a href=""><img src="file:///Users/alexhilton/Downloads/portal_2.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç¼˜èµ·</h2>

<p>æ— ç–‘Jetpack Composeæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å£°æ˜å¼UIæ¡†æ¶ï¼Œå®ƒä¸åŸç”Ÿçš„Viewæ–¹å¼æœ€å¤§çš„åŒºåˆ«ï¼Œåœ¨äºæ€è€ƒé—®é¢˜çš„æ–¹å¼ä¸Šå¹¶ä¸ä¸€æ ·ã€‚å£°æ˜å¼æ¡†æ¶èƒ½æŠŠå¼€å‘è€…ä»ç¹æ‚çš„å‘½ä»¤å¼çš„UIç»†èŠ‚ä¸­è§£æ”¾å‡ºæ¥ï¼Œé‡ç‚¹æ€è€ƒä¸€ä¸ªå¥½çš„ä½“éªŒåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œè€Œå…·ä½“çš„UIç»†èŠ‚ç”±æ¡†æ¶æ¥å¤„ç†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ¯•ç«ŸComposeæ˜¯è¿‘å‡ å¹´æ¥å‘å±•èµ·æ¥çš„ï¼Œç°ä»Šå¤§é‡çš„é¡¹ç›®ä»æ˜¯åŸç”ŸViewä¸»å¯¼çš„ã€‚æ­¤å¤–ï¼ŒComposeä¹Ÿè¿˜åœ¨å‘å±•ä¸­ï¼Œæœ‰äº›ç‰¹å®šä¸šåŠ¡é¢†åŸŸå¦‚Cameraï¼Œè§†é¢‘ï¼Œ3Dæ¸²æŸ“ï¼Œè¿˜æ²¡æœ‰èƒ½åŠ›æ”¯æŒã€‚å› æ­¤ï¼Œæ•´åˆåŸç”ŸViewå’ŒComposeæ˜¯é¡¹ç›®ä¸­å¾ˆç°å®çš„ä¸€ä¸ªéš¾é¢˜ï¼Œæœ¬æ–‡å°†é‡ç‚¹è®¨è®ºä¸¤ä¸ªè®®é¢˜ï¼šä¸€ä¸ªæ˜¯å¦‚ä½•åœ¨åŸç”ŸViewä¸­åµŒå…¥Composeï¼Œå¦ä¸€ä¸ªå°±æ˜¯å¦‚ä½•åœ¨Composeä¸­åµŒå…¥åŸç”ŸViewã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> æœ¬æ–‡ä¸­æåˆ°çš„ä¸¤ä¸ªç»„ä»¶ComposeViewå’ŒAndroidViewéƒ½ä»…åœ¨Jetpack Composeï¼ˆfor Androidï¼‰ç”Ÿæ•ˆï¼Œå¹¶ä¸é€‚ç”¨äºè·¨å¹³å°çš„Compose Multiplatformã€‚</p>

<h2>åœ¨åŸç”ŸViewä¸­åµŒå…¥Compose</h2>

<p>ç¬¬ä¸€ä¸ªä¼ é€é—¨æ˜¯å¦‚ä½•è¿›å…¥Composeçš„ä¸–ç•Œã€‚ç›¸ä¿¡ç°åœ¨ç»å¤§å¤šæ•°é¡¹ç›®éƒ½æ˜¯åŸºäºåŸç”ŸViewçš„ï¼Œå€ŸåŠ©<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/platform/ComposeView">ComposeView</a>å°±å¯ä»¥è¿›å…¥åˆ°Composeçš„ä¸–ç•Œã€‚</p>

<pre><code class="Kotlin">    val composeView = ComposeView(context).apply {
                setContent {
                    // è¿™é‡Œè°ƒç”¨Composables
                }
            }
</code></pre>

<p>ComposeViewæ˜¯Viewçš„ä¸€ä¸ªå­ç±»ï¼Œèƒ½å¤Ÿä½œä¸ºComposeçš„å®¹å™¨ï¼Œåœ¨<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/platform/ComposeView#setContent(kotlin.Function0">å…¶setContentæ–¹æ³•</a>)ä¸­æä¾›ä¸€ä¸ªComposableå³å¯ã€‚ComposeViewä¸å…¶ä»–Viewä¸€æ ·ï¼Œå¯ä»¥ç”¨åœ¨View treeä¸­ï¼Œç”¨åœ¨Fragmenté‡Œå’ŒActivityé‡Œé¢ã€‚å®é™…ä¸Šä½œä¸ºå¹³å°çš„å…¥å£ComponentActivityç”¨çš„ä¹Ÿæ˜¯ComposeViewã€‚</p>

<h3>åœ¨Viewå±‚çº§ä¸­ç›´æ¥åµŒå…¥</h3>

<p>ComposeViewå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Android Viewï¼Œè·Ÿå…¶ä»–Viewçš„å­ç±»æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠŠå®ƒæ”¾åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨Viewçš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸€ä¸ªå¸ƒå±€é‡Œé¢ï¼Œä½œä¸ºä¸€ä¸ªé¡µé¢çš„ä¸€éƒ¨åˆ†ã€‚</p>

<pre><code class="xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:id="@+id/container"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    tools:context=".MainActivity"&gt;

    &lt;androidx.compose.ui.platform.ComposeView
        android:id="@+id/compose_view"
        android:layout_width="match_parent"
        android:layout_height="wrap_content" /&gt;

    &lt;Button
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="WidgetButton"
        /&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p><strong>æ³¨æ„ï¼š</strong> å°½ç®¡å¯ä»¥æŠŠComposeViewå½“æˆæ™®é€šçš„Viewï¼Œç›´æ¥åµŒå…¥åˆ°å¸ƒå±€ä¸­ï¼Œä½œä¸ºé¡µé¢ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼Œä¸€æ¥æ˜¯ä¸èƒ½å‘æŒ¥Composeçš„ä¼˜åŠ¿ï¼Œå¦å¤–Composeæœ¬èº«æ˜¯æœ‰ç‰¹å®šçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼ˆé‡ç»„ï¼‰ï¼Œå®ƒéœ€è¦çŸ¥é“å¹³å°çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥ç®¡æ§å®ƒè‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸã€‚è€Œå¸¸è§„çš„View treeä¹‹ä¸­æ˜¯æ²¡æœ‰å¹³å°ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå› ä¸ºå¸¸è§„çš„View treeå¹¶ä¸å…³å¿ƒå¹³å°çš„ç”Ÿå‘½å‘¨æœŸï¼Œview treeä¸»è¦å—çª—å£å½±å“ï¼ˆattachToWindowï¼ŒdetachFromWindowï¼‰ï¼Œè¿™ä¸ªä¸å¹³å°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰å…³ç³»ã€‚</p>

<h3>ç”¨åœ¨Fragmentä¸­</h3>

<p>æƒ³è¦åœ¨æŸä¸ªFragmentä¸­é›†æˆComposeçš„æ–¹å¼å°±æ˜¯æŠŠComposeViewä½œä¸ºFragmentçš„æ ¹Viewå³å¯ï¼š</p>

<pre><code class="Kotlin">class ExampleFragmentNoXml : Fragment() {

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View {
        return ComposeView(requireContext()).apply {
            // å½“Viewçš„å®¿ä¸»destroyæ—¶é”€æ¯ç»„åˆ
            setViewCompositionStrategy(ViewCompositionStrategy.DisposeOnViewTreeLifecycleDestroyed)
            setContent {
                MaterialTheme {
                    // è¿›å…¥åˆ°Composeä¸–ç•Œ
                    Text("Hello Compose!")
                }
            }
        }
    }
}
</code></pre>

<h3>ç”¨åœ¨Activityä¸­</h3>

<p>è¿™å…¶å®æ˜¯æœ€å¥½çš„æ–¹å¼ï¼Œåœ¨ä¸€ä¸ªæ–°çš„é¡µé¢çª—å£ä¸­ä½¿ç”¨Composeï¼Œè¿™å°±èƒ½ä¸å…¶ä½™viewç‹¬ç«‹å¼€æ¥ï¼Œæ˜¯æœ€ä¸ºç†æƒ³çš„ã€‚</p>

<pre><code class="Kotlin">class ExampleActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        setContent {
            MaterialTheme {
                Greeting(name = "compose")
            }
        }
    }
}

@Composable
fun Greeting(name: String) {
    Text(text = "Hello $name!")
}
</code></pre>

<h3>ä½¿ç”¨å»ºè®®</h3>

<p>è™½ç„¶ComposeViewå¯ä»¥å½“æˆä¸€ä¸ªæ™®é€šçš„Viewæ¥ä½¿ç”¨ï¼Œä½†æœ€ä¸ºåˆç†çš„æ–¹å¼å°±æ˜¯åœ¨ä¸€ä¸ªæ–°çš„Activityä¸­æ‰ä½¿ç”¨Composeï¼Œä¹Ÿå°±æ˜¯è¯´å½“æœ‰ä¸€ä¸ªå…¨æ–°çš„é¡µé¢æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨Composeæ¥å¼€å‘ï¼Œè¿™æ ·æ‰èƒ½å‘æŒ¥å‡ºå®ƒçš„ä»·å€¼ã€‚</p>

<p>é™¤éæœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œå¦åˆ™ä¸è¦æŠŠComposeViewä½œä¸ºç°æœ‰é¡µé¢çš„ä¸€éƒ¨åˆ†åµŒå…¥åˆ°View treeä¸­ï¼ˆä¹Ÿå°±æ˜¯ä½œä¸ºé¡µé¢çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚</p>

<p>è‡³äºåœ¨Fragmentä¸­ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå…¨æ–°çš„é¡µé¢ï¼Œè€Œéç°æœ‰å¸ƒå±€çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨Composeã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> å…¶æ ¹æœ¬åŸå› åœ¨äºï¼Œæˆ‘ä»¬ä½¿ç”¨Jetpack Composeå¹¶ä¸æ˜¯å›¾å®ƒèƒ½å®ç°ä»€ä¹ˆç‰¹åˆ«çš„UIæ•ˆæœï¼ŒComposeèƒ½åšçš„äº‹æƒ…Viewéƒ½èƒ½åšï¼Œç”šè‡³å®ƒä¸èƒ½åšçš„äº‹æƒ…Viewä¹Ÿèƒ½åšã€‚ç”¨Composeæ˜¯å› ä¸ºå®ƒæ˜¯å£°æ˜å¼çš„UIæ¡†æ¶ï¼Œåœ¨å¼€å‘æ•ˆç‡å’Œå¯æ‰©å±•æ€§ä¸Šé¢æœ‰å·¨å¤§çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œåªåº”è¯¥åœ¨æƒ³è¦å‘æŒ¥å£°æ˜å¼æ¡†æ¶ä¼˜åŠ¿çš„æ—¶å€™ï¼Œæ‰è€ƒè™‘ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”åº”è¯¥ä»ä¸€ä¸ªå…¨æ–°çš„é¡µé¢å¼€å§‹ã€‚</p>

<h2>åœ¨Composeä¸­åµŒå…¥åŸç”ŸView</h2>

<p>Jetpack Composeæä¾›äº†è¶³å¤Ÿä¸°å¯Œçš„ç»„ä»¶ï¼Œè¶³ä»¥åº”å¯¹å¸¸è§„çš„UIï¼Œä½†å®ƒæ¯•ç«Ÿè¿˜ä¸æ˜¯ç‰¹åˆ«çš„æˆç†Ÿï¼Œæ€»ä¼šé‡åˆ°ä¸€äº›åœºæ™¯ï¼Œå‘ç°Composeæ— æ³•èƒœä»»ï¼Œè€Œä¸”å¹¶ä¸æ˜¯é€šè¿‡è‡ªå®šä¹‰ç»„ä»¶å°±èƒ½å¤Ÿè§£å†³çš„ï¼Œæ¯”å¦‚ä¸€äº›ç‰¹å®šé¢†åŸŸçš„UIï¼Œå¦‚cameraï¼Œå¦‚è§†é¢‘ï¼Œå¦‚3Dæ¸²æŸ“ã€‚æˆ–è€…è¯´ï¼Œå·²ç»æœ‰äº†è‡ªå®šä¹‰å¥½çš„Viewï¼Œå¹¶ä¸æƒ³é‡å¤å¼€å‘ã€‚å†æˆ–è€…è¯´å¯¹äºä¸€äº›ä¸‰æ–¹çš„åº“ï¼Œå®ƒå¹¶æ²¡æœ‰å¯¹åº”çš„Composeç»„ä»¶ã€‚è¿™äº›åœºæ™¯å°±éœ€è¦æŠŠåŸç”Ÿçš„ViewåµŒå…¥åˆ°Composeä¹‹ä¸­ã€‚</p>

<p><a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/viewinterop/package-summary#AndroidView(kotlin.Function1,androidx.compose.ui.Modifier,kotlin.Function1,kotlin.Function1,kotlin.Function1">AndroidView</a>)å°±æ˜¯ä¸“é—¨ç”¨äºæŠŠåŸç”ŸViewåµŒå…¥åˆ°Composeä¸­çš„ä¸€ä¸ªç‰¹æ®Šcomposableã€‚å®ƒå°±åƒä¸€ä¸ªä¼ é€é—¨ä¸€æ ·ï¼Œèƒ½æŠŠåŸç”Ÿçš„Viewï¼Œæ— è®ºæ˜¯ä¸€ä¸ªç°æˆçš„è‡ªå®šä¹‰Viewï¼Œè¿˜æ˜¯ç‰¹å®šé¢†åŸŸçš„Viewæˆ–è€…ä¸‰æ–¹åº“çš„Viewï¼Œå¸¦å…¥åˆ°Composeä¸­ï¼Œå˜æˆä¸€ä¸ªcomposableã€‚</p>

<h3>AndroidViewçš„ä½¿ç”¨æ–¹æ³•</h3>

<p>AndroidViewæ˜¯ä¸€ä¸ªcomposableï¼ŒæŠŠå®ƒæ”¾åœ¨æƒ³è¦çš„ä½ç½®å³å¯ã€‚å®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¸¸è§„çš„Modifierç”¨ä»¥çº¦æŸè¿™ä¸ªcomposableçš„ï¼›å¦ä¸¤ä¸ªæ˜¯lambdaï¼Œä¸€ä¸ªæ˜¯ç”¨äºåˆ›å»ºViewçš„ï¼Œè¿”å›ä¸€ä¸ªViewçš„å®ä¾‹ï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼›å¦ä¸€ä¸ªå°±æ˜¯ç”¨äºæ›´æ–°Viewçš„ï¼Œä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼š</p>

<pre><code class="Kotlin">@Composable
fun CustomView() {
    var selectedItem by remember { mutableStateOf(0) }

    // æ·»åŠ åŸç”ŸViewåˆ°Compose
    AndroidView(
        modifier = Modifier.fillMaxSize(),
        factory = { context -&gt;
            // åˆ›å»ºViewçš„å®ä¾‹
            MyView(context).apply {
                // è®¾ç½®Viewçš„ç‚¹å‡»äº‹ä»¶ï¼Œæ›´æ–°çŠ¶æ€ï¼Œè¿™ä¼šè§¦å‘é‡ç»„
                setOnClickListener {
                    selectedItem = 1
                }
            }
        },
        update = { view -&gt;
            // æ›´æ–°Viewçš„çŠ¶æ€
            // è¿™é‡Œè¯»äº†çŠ¶æ€ï¼Œæ‰€ä»¥é‡ç»„æ—¶updateä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œviewèƒ½æ‹¿åˆ°æœ€æ–°çš„çŠ¶æ€
            view.selectedItem = selectedItem
        }
    )
}

@Composable
fun ContentExample() {
    Column(Modifier.fillMaxSize()) {
        Text("Look at this CustomView!")
        CustomView()
    }
}
</code></pre>

<p><strong>æ³¨æ„ï¼š</strong> factoryä»…ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç”¨äºåˆ›å»ºViewå®ä¾‹ï¼Œupdateä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œç”¨äºæ›´æ–°viewçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬åˆæ¬¡ç»„åˆæ—¶ï¼Œä¹Ÿå°±æ˜¯factoryæ‰§è¡Œä¹‹åï¼Œå°±ä¼šè°ƒç”¨updateã€‚AndroidViewå‡½æ•°ä¼šå¸®åŠ©æä¾›Viewéœ€è¦çš„å‚æ•°contextï¼Œä»¥åŠç®¡ç†Viewçš„å®ä¾‹ï¼Œæ‰€ä»¥updateä¸­ä¼šæŠŠviewå½“ä½œå‚æ•°ä¼ ç»™æˆ‘ä»¬ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨æ²¡æœ‰å¿…è¦å†ç”¨é¢å¤–çš„çŠ¶æ€ï¼ˆrememberï¼‰å»ç¼“å­˜Viewçš„å®ä¾‹äº†ã€‚</p>

<h3>ä½¿ç”¨å»ºè®®</h3>

<p>è™½ç„¶AndroidViewæ˜¯ä¸€ä¸ªä¼ é€é—¨ï¼Œå¯ä»¥è¿æ¥ä¸¤ä¸ªä¸–ç•Œï¼Œä½†æ˜¯èƒ½ä¸ç”¨è¿˜æ˜¯ä¸è¦ç”¨ï¼Œéå¿…è¦ä¸ä½¿ç”¨ã€‚å¦‚æœèƒ½ç”¨Composeæå®šçš„äº‹æƒ…ï¼Œè¿˜æ˜¯è¦ç”¨Composeæ¥æï¼Œæ¯”å¦‚ç”¨Canvaså»å®ç°è‡ªå®šä¹‰ç»„ä»¶ã€‚</p>

<p>éœ€è¦ä½¿ç”¨AndroidViewçš„åœºæ™¯åªæœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯æœ‰ç°æˆçš„è‡ªå®šä¹‰Viewï¼Œæ‹¿è¿‡æ¥å°±å¯ä»¥ç”¨ï¼Œä¸æƒ³äºŒæ¬¡å¼€å‘ï¼›äºŒæ˜¯ä¸‰æ–¹åº“çš„Viewï¼›ä¸‰å°±æ˜¯Composeç¡®å®æä¸å®šçš„ç‰¹å®šé¢†åŸŸï¼Œå¦‚WebViewï¼Œå¦‚è§†é¢‘ï¼Œå¦‚SurfaceViewæˆ–è€…3Dæ¸²æŸ“ï¼ˆOpenGL ESï¼‰ç­‰ç­‰ã€‚é™¤ä»¥ä¹‹å¤–ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>

<p>è¿˜éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåŸç”Ÿçš„Viewäº¤äº’æ¯”è¾ƒå¤æ‚ï¼Œä¸å…‰æ˜¯ç‚¹å‡»ï¼Œè¿˜æ¶‰åŠTouchäº‹ä»¶å¤„ç†ï¼Œå¤„ç†äº‹ä»¶çš„åŒæ—¶è¿˜è¦ä¸æ–­æ›´æ–°Viewçš„çŠ¶æ€ï¼Œé‚£ä¹Ÿä¸åº”è¯¥ä½¿ç”¨å®ƒã€‚æ¯”è¾ƒç†æƒ³çš„æƒ…å†µæ˜¯ï¼ŒåµŒå…¥çš„è¿™ä¸ªViewæ˜¯ä¸€ä¸ªæ¯”è¾ƒçº¯ç²¹çš„ç”Ÿäº§è€…ï¼Œæ¯”å¦‚å®ƒåªäº§ç”Ÿäº‹ä»¶ï¼Œä¸éœ€è¦å†å¾€å›æ›´æ–°çŠ¶æ€ï¼›æˆ–è€…æ˜¯ä¸€ä¸ªæ¯”è¾ƒçº¯ç²¹çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚å®ƒå°±è´Ÿè´£å±•ç¤ºï¼Œåªéœ€è¦å¡æ•°æ®å°±è¡Œäº†ã€‚</p>

<h2>æ€»ç»“</h2>

<p>ç½‘ä¸Šçš„æ•™ç¨‹æˆ–è€…Demoä¸­çš„ä¸–ç•Œæ˜¯å¾ˆç¾å¥½çš„ï¼Œå¾€å¾€éƒ½æ˜¯ä¸€ä¸ªæ–°å»ºçš„é¡¹ç›®ï¼Œä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œç›´æ¥å°±è¿›å…¥äº†Composeä¸–ç•Œï¼Œä¹Ÿéƒ½åœ¨è®²Composeèƒ½åšçš„äº‹æƒ…ã€‚ä½†ç°å®çš„ä¸–ç•Œå¾€å¾€ä¸æ˜¯è¿™æ ·å­çš„ï¼Œæå°‘æƒ…å†µä¸‹æ˜¯å…¨æ–°å¼€å§‹çš„é¡¹ç›®ï¼Œå¾€å¾€éœ€è¦ä¸é—ç•™ä»£ç æ‰“äº¤é“ï¼Œéœ€è¦å®ç°çš„éœ€æ±‚ä¹Ÿæ˜¯å¤šç§å¤šæ ·çš„ã€‚æœ¬æ–‡ä¸­ä»‹ç»äº†ä¸¤ä¸ªä¼ é€é—¨ï¼ŒComposeViewå’ŒAndroidViewå¯ä»¥æ–¹ä¾¿åœ°è¿æ¥åŸç”ŸViewå’ŒComposeä¸¤ä¸ªä¸–ç•Œï¼Œä¸ºç°å®é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜æä¾›äº†ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚</p>

<h3>è®©Composeæ”¯æŒOpenGL ES</h3>

<ul>
<li><a href="https://stackoverflow.com/questions/78796021/how-to-render-opengl-alongside-jetpack-compose-ui-without-covering-other-element">How to render OpenGL alongside Jetpack Compose UI without covering other elements</a></li>
<li><a href="https://www.reddit.com/r/Kotlin/comments/on36sy/experiment_to_make_opengl_work_together_with/?rdt=62185">Experiment to make OpenGL work together with Jetpack Compose</a></li>
<li><a href="https://composables.com/foundation/androidexternalsurface">AndroidExternalSurface</a></li>
<li><a href="https://youtrack.jetbrains.com/issue/CMP-3810/Using-Open-GL-with-Compose-Multiplatform">Using Open GL with Compose Multiplatform</a></li>
</ul>


<h2>References</h2>

<ul>
<li><a href="https://developer.android.com/develop/ui/compose/migrate/interoperability-apis/compose-in-views">Using Compose in Views</a></li>
<li><a href="https://developer.android.com/develop/ui/compose/migrate/interoperability-apis/views-in-compose">Using Views in Compose</a></li>
<li><a href="https://medium.com/@seungbae2/jetpack-compose-androidview-seamless-integration-of-android-views-into-compose-ui-644f217437d3">Jetpack Compose AndroidView: Seamless Integration of Android Views into Compose UI</a></li>
<li><a href="https://stackoverflow.com/questions/59995970/using-custom-views-with-jetpack-compose">Using Custom Views with Jetpack Compose</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
