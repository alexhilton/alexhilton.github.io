
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Jetpack Compose重组稳定性分析器 - 稀有猿诉</title>
  <meta name="author" content="Alex Hilton">

  
  <meta name="description" content="本文将探讨 Compose 稳定性分析器的工作原理，一个Jetpack Compose 的实时重组稳定性洞察工具，包括：IntelliJ 插件、编译器插件以及稳定性验证系统。">
  <meta name="keywords" content="Compose, Stablization">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://alexhilton.github.io/blog/2026/01/30/compose-stability-analyzer">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="稀有猿诉" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/toolbar.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- for Gitment -->
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">

<!-- for favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">稀有猿诉</a></h1>
  
    <h2>十年磨一剑，历炼出锋芒，说话千百句，不如码二行。</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alexhilton.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/donation">Donation</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Jetpack Compose重组稳定性分析器</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2026-01-30'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2026</span></span> <span class='time'>12:00 am</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>本文译自「Compose Stability Analyzer: Real-Time Stability Insights for Jetpack Compose」，原文链接<a href="https://medium.com/proandroiddev/compose-stability-analyzer-real-time-stability-insights-for-jetpack-compose-1399924a0a64">https://medium.com/proandroiddev/compose-stability-analyzer-real-time-stability-insights-for-jetpack-compose-1399924a0a64</a>，由Jaewoong Eum发布于2025年11月10日。</p></blockquote>

<p><a href="/blog/2026/01/30/compose-stability-analyzer/"><img src="https://miro.medium.com/v2/resize:fit:1400/0*uLjBHnzVq5vM002Z" title="auto auto" ></a></p>

<!-- more -->


<p>Jetpack Compose 以其声明式编程范式革新了 Android UI 开发，但这种简洁性背后却隐藏着复杂性：理解重组合行为。当一个可组合元素不必要地进行重组合时，就会造成性能损失，CPU 周期会浪费在重新渲染实际上并未改变的 UI 上。挑战不仅在于识别这些问题，更在于理解它们发生的<strong>原因</strong>。</p>

<p>Compose 编译器一直在后台执行稳定性分析，确定哪些可组合元素在输入未发生变化时可以跳过重组合。但这种分析是在编译时静默进行的，开发者无法得知他们的可组合元素是否得到了优化。你可能编写出看似完美稳定的代码，但之后却发现类中一个 <code>var</code> 属性就足以导致整个代码不稳定，并波及整个 UI 树。</p>

<p><a href="https://github.com/skydoves/compose-stability-analyzer">Compose Stability Analyzer</a> 将这种隐藏的分析揭示出来。它是一套全面的工具集，可在 IDE 中提供实时可视化反馈，通过注解进行运行时代码重组追踪，并在 CI 流水线中进行稳定性验证。无需等到性能问题在生产环境中出现，你就能在编码过程中获得即时反馈，使稳定性分析自然而然地融入你的开发工作流程。</p>

<p>本文将探讨 Compose 稳定性分析器的工作原理，包括：IntelliJ 插件（为你的 IDE 提供可视化的稳定性指示器）、编译器插件（启用运行时重组跟踪）以及稳定性验证系统（防止回归问题影响生产环境）。</p>

<h2>理解稳定性问题：为什么可组合函数会重组</h2>

<p>在深入工具之前，值得了解 Compose 编译器实际上分析的内容。编译器会对每个可组合函数执行稳定性推断，回答两个问题：</p>

<p><strong>1. 这个可组合函数可以跳过吗？</strong></p>

<p>当编译器能够证明使用相同的输入重新组合该函数会产生相同的结果时，该可组合函数就是可跳过的。如果所有参数都是稳定的并且没有发生变化，可组合函数可以完全跳过重新组合，这是一个显著的性能优化。</p>

<p><strong>2. 该可组合项是否可重启？</strong></p>

<p>当一个可组合项可以独立重新组合而无需重新组合其父项时，该可组合项是可重启的。这使得重新组合更加细粒度。大多数可组合项都是可重启的，但带有某些修饰符的可组合项可能不是。</p>

<p>这里的关键概念是<strong>参数稳定性</strong>。当 Compose 编译器能够可靠地检测到参数值是否发生变化时，该参数是稳定的。规则非常复杂，如果你想深入了解这些规则，可以参考稳定性研究<a href="https://github.com/skydoves/compose-stability-inference">Compose 稳定性推断</a>。</p>

<h2>在 Android Studio 中进行可视化稳定性分析</h2>

<p>Compose Stability Analyzer IntelliJ 插件可将稳定性分析直接集成到 Android Studio 和 IntelliJ IDEA 中，在你编写代码时提供四层可视化反馈。</p>

<h3>安装和设置</h3>

<p>安装插件非常简单：</p>

<ol>
<li><p>打开 <strong>Android Studio</strong> → <strong>设置</strong> → <strong>插件</strong> → <strong>应用市场</strong>。</p></li>
<li><p>搜索“Compose Stability Analyzer”。</p></li>
<li><p>点击 <strong>安装</strong> 并重启 IDE。</p></li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*ukPWg_I6mOo9Drk0.png" alt="图1" /></p>

<p>安装完成后，插件会立即开始分析你的代码。无需任何配置，它可与任何 Compose 项目开箱即用。</p>

<h3>边栏图标：即时视觉反馈</h3>

<p>最直观的功能是边栏图标，即出现在可组合函数左侧边栏的彩色圆点：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*r3BFUwBTNNRfa2Y7.png" alt="图2" /></p>

<ul>
<li><p><strong>绿点</strong>：此可组合函数可跳过。所有参数均稳定，编译器可以优化重新组合。</p></li>
<li><p><strong>黄点</strong>：此可组合函数可重启，但不可跳过。它会在其父函数重新组合时重新组合。</p></li>
<li><p><strong>红点</strong>：此可组合函数的参数不稳定，无法进行优化。</p></li>
</ul>


<p>这种即时视觉反馈是快速发现 Jetpack Compose 性能问题的最佳方法。只需快速浏览左侧边栏，即可了解哪些可组合函数需要关注。如果屏幕上布满红点，则说明需要进行一些优化工作。</p>

<p>边栏图标的计算基于 Compose 编译器执行的相同稳定性分析。该插件会接入编译器的分析阶段并提取稳定性信息，然后在编辑器中以可视化的方式呈现。</p>

<p>但请注意，目前<a href="https://developer.android.com/develop/ui/compose/performance/stability/strongskipping">强跳过模式</a>默认大多已启用，因此所有可组合函数默认都可以跳过。你可以在插件配置中启用或禁用强跳过模式检查（工具 > Compose 稳定性分析器），该功能自 0.5.0 版本起也默认启用。如果你希望更加关注稳定性问题，可以根据实际情况将其关闭。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*UGJB2Jx_JKIv3_l0xrMCoQ.png" alt="图3" /></p>

<h3>悬停提示：了解原因</h3>

<p>边栏图标告诉你<strong>哪里</strong>出了问题，而悬停提示则告诉你<strong>为什么</strong>。当你将鼠标悬停在可组合函数名称上时，会显示详细的提示信息：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*s_KwLNlhbLEsoBko.png" alt="图4" /></p>

<p>提示信息显示：</p>

<ul>
<li><p>可组合函数是否可跳过和可重启</p></li>
<li><p>稳定参数与不稳定参数的总数</p></li>
<li><p>每个参数的详细稳定性信息</p></li>
<li><p>接收器稳定性（针对扩展函数）</p></li>
</ul>


<p>这种细致的反馈对于调试至关重要。你无需猜测哪个参数导致了不稳定，而是可以准确地看到哪些参数存在问题。</p>

<h3>内联参数提示：精细化可见性</h3>

<p>工具提示会在鼠标悬停时提供详细信息，而内联参数提示则无需任何交互即可提供持续可见性：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*g1f1L5ZuagOSKrA8.png" alt="图5" /></p>

<p>函数签名中每个参数类型旁边都会显示小徽章，指示该参数是稳定还是不稳定。这是最详细的反馈级别；每个参数的稳定性一目了然。</p>

<p>对于参数众多的函数，这有助于你快速浏览并识别有问题的参数，而无需打开工具提示。颜色编码与稳定性状态相对应：</p>

<ul>
<li><p>绿色徽章：参数稳定</p></li>
<li><p>红色徽章：参数不稳定</p></li>
<li><p>黄色徽章：稳定性将在运行时决定（因此可能稳定也可能不稳定）</p></li>
</ul>


<h3>代码检查：自动建议</h3>

<p>第四层反馈是主动代码检查。当插件检测到不稳定的组合体时，它可以：</p>

<ol>
<li><p><strong>用警告下划线突出显示问题</strong>。</p></li>
<li><p><strong>通过 Alt+Enter 菜单提供快速修复建议</strong>。</p></li>
<li><p><strong>提供添加注解（例如 <code>@TraceRecomposition</code>）</strong>以进行调试。</p></li>
<li><p><strong>提供抑制选项</strong>（如果不稳定是故意的）。</p></li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*o9_zJzFKaKfyLp_hiXCvoA.png" alt="图6" /></p>

<p>插件在此开始主动出击。它不仅会指出问题，还会提供解决方案。在不稳定的组合体上按下 Alt+Enter，你可能会看到如下选项：</p>

<ul>
<li><p>添加 <code>@TraceRecomposition</code> 以监控重新组合。</p></li>
<li><p>使用 <code>@Stable</code> 注解进行标记（请谨慎使用）。</p></li>
<li><p>抑制此函数的稳定性警告。</p></li>
</ul>


<h3>稳定性浏览器：包级分析</h3>

<p>除了单个函数分析之外，稳定性浏览器还提供整个代码库稳定性的概览：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*xPe6l50SxP3DQHEP.png" alt="图7" /></p>

<p>启用方法：</p>

<ol>
<li><p>安装 Compose Stability Analyzer Gradle 插件（下一节将介绍）。</p></li>
<li><p>转到“视图”→“工具窗口”→“Compose Stability Analyzer”。</p></li>
<li><p>构建项目并单击刷新按钮。</p></li>
</ol>


<p>浏览器以树状视图显示包结构，每个可组合函数都带有其稳定性状态的注解。你可以快速深入查找整个代码库中不稳定的函数，从而轻松地确定优化工作的优先级。</p>

<p>这在大型项目中尤其有用，因为手动检查每个可组合组件是不切实际的。该工具会为你的应用程序提供一份稳定性“成绩单”，显示哪些包存在最多的稳定性问题。</p>

<h3>自定义配置</h3>

<p>该插件具有高度可定制性。你可以调整颜色、启用或禁用特定的视觉指示器，并配置分析行为以满足你的偏好。</p>

<p>前往“设置”→“工具”→“Compose Stability Analyzer”（组合稳定性分析器）访问配置选项：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*l2CoGtjreY7XNdyK.png" alt="图8" /></p>

<p>你可以：</p>

<ul>
<li><p>更改边栏图标颜色以匹配你的 IDE 主题</p></li>
<li><p>分别启用或禁用内联提示、警告和边栏图标</p></li>
<li><p>配置强跳过模式分析</p></li>
<li><p>添加忽略类型模式以从分析中排除某些类</p></li>
<li><p>在测试源集中启用分析</p></li>
<li><p>设置自定义稳定性配置文件</p></li>
</ul>


<p>这种灵活性确保插件能够自然地融入你现有的工作流程，无论你偏好最小的视觉干扰还是最大的信息密度。</p>

<h2>Gradle 插件：运行时重组追踪</h2>

<p>IntelliJ 插件提供编译时可见性，而 Gradle 插件则支持<strong>运行时分析</strong>，能够精确追踪可组合组件在运行中的重组时间和原因。这是通过 <code>@TraceRecomposition</code> 注解实现的，该注解是一个编译器插件，它会在可组合组件中添加日志代码。</p>

<h3>安装和设置</h3>

<p>将以下依赖项添加到 <code>libs.versions.toml</code> 文件中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='toml'><span class='line'><span class="n">stability-analyzer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">id</span> <span class="o">=</span> <span class="s">&quot;com.github.skydoves.compose.stability.analyzer&quot;</span><span class="p">,</span> <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;0.5.0&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来，将插件应用到根目录下的 <code>build.gradle.kts</code> 文件中，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">alias</span><span class="p">(</span><span class="n">libs</span><span class="p">.</span><span class="n">plugins</span><span class="p">.</span><span class="n">stability</span><span class="p">.</span><span class="n">analyzer</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>完成！该插件会自动将编译器插件应用到项目中的所有 Kotlin 编译任务。基本用法无需额外配置。</p>

<h3>Kotlin 版本兼容性</h3>

<p>该插件与 Kotlin 编译器紧密耦合，因此版本一致性至关重要。截至撰写本文时，<strong>你至少应使用 Kotlin 2.2.21 版本</strong>。使用不匹配的版本可能会导致编译错误。请始终使用与你的稳定性分析器版本完全匹配的 Kotlin 版本。你可以参考 Kotlin 版本映射表（<a href="https://github.com/skydoves/compose-stability-analyzer?tab=readme-ov-file#kotlin-version-mapping%EF%BC%89%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E3%80%82">https://github.com/skydoves/compose-stability-analyzer?tab=readme-ov-file#kotlin-version-mapping%EF%BC%89%E8%8E%B7%E5%8F%96%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF%E3%80%82</a></p>

<h3>@TraceRecomposition 注解</h3>

<p>安装插件后，你可以使用 <code>@TraceRecomposition</code> 注解任何可组合组件，以跟踪其重组行为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@TraceRecomposition</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductCard</span><span class="p">(</span>
</span><span class='line'>    <span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Card</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="n">onClick</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;$${product.price}&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当此可组合组件重组时，你将在 Logcat 中看到详细的日志：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#1] ProductCard  </span>
</span><span class='line'>D/Recomposition:   ├─ product: Product stable <span class="o">(</span>Product@abc123<span class="o">)</span>
</span><span class='line'>D/Recomposition:   └─ onClick: <span class="o">()</span> -&gt; Unit stable <span class="o">(</span>Function@xyz789<span class="o">)</span>
</span><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#2] ProductCard  </span>
</span><span class='line'>D/Recomposition:   ├─ product: Product changed <span class="o">(</span>Product@abc123 → Product@def456<span class="o">)</span>
</span><span class='line'>D/Recomposition:   └─ onClick: <span class="o">()</span> -&gt; Unit stable <span class="o">(</span>Function@xyz789<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>日志显示：</p>

<ul>
<li><p><strong>重组次数</strong>：此实例已重组的次数</p></li>
<li><p><strong>参数稳定性</strong>：每个参数是稳定还是不稳定</p></li>
<li><p><strong>变更检测</strong>：哪些参数发生了更改，显示新旧值</p></li>
<li><p><strong>身份跟踪</strong>：每个参数值的哈希码</p></li>
</ul>


<p>这些细粒度的信息对于调试至关重要。你可以准确地看到是哪个参数的更改触发了重组，从而帮助你了解应用程序的重组模式。</p>

<h3>使用标签参数进行过滤</h3>

<p>对于包含大量跟踪可组合组件的大型应用程序，日志可能会变得非常庞大。 <code>tag</code> 参数可以帮助你组织和筛选日志：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@TraceRecomposition</span><span class="p">(</span><span class="n">tag</span> <span class="p">=</span> <span class="s">&quot;product-list&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductCard</span><span class="p">(</span><span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">,</span> <span class="n">onClick</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@TraceRecomposition</span><span class="p">(</span><span class="n">tag</span> <span class="p">=</span> <span class="s">&quot;user-profile&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProfileHeader</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在日志包含以下标签：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#1] ProductCard (tag: product-list)</span>
</span><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#1] ProfileHeader (tag: user-profile)</span>
</span></code></pre></td></tr></table></div></figure>


<p>你可以筛选 Logcat 以仅显示特定标签：</p>

<ul>
<li><p>按 <code>tag: product-list</code> 筛选，仅查看与产品相关的重组日志。</p></li>
<li><p>按 <code>tag: user-profile</code> 筛选，仅查看与用户个人资料相关的重组日志。</p></li>
</ul>


<p>这在与自定义日志记录器（将在下文介绍）结合使用时尤其有用，因为你可能只想将某些标签发送到分析服务。</p>

<h3>设置阈值以减少噪音</h3>

<p>大多数可组合组件在初始设置期间会重新组合 1-2 次，这是预期行为，<strong>并非性能问题</strong>。<code>threshold</code> 参数可以过滤掉这些噪音：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@TraceRecomposition</span><span class="p">(</span><span class="n">threshold</span> <span class="p">=</span> <span class="m">3</span><span class="p">)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">FrequentlyRecomposingScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Logs will only appear after the 3rd recomposition</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样可以将注意力集中在真正的问题上：用户交互期间不断重新组合的可组合组件，而不仅仅是初始设置。</p>

<p>一个实际用例：设置一个较高的阈值，并在超过该阈值时发送分析事件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@TraceRecomposition</span><span class="p">(</span><span class="n">tag</span> <span class="p">=</span> <span class="s">&quot;checkout&quot;</span><span class="p">,</span> <span class="n">threshold</span> <span class="p">=</span> <span class="m">10</span><span class="p">)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CheckoutScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// If this recomposes 10+ times, something is wrong</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在你的自定义日志记录器（参见下一节）中，你可以在超过阈值时发送 Firebase 事件，从而监控生产环境中的性能问题。</p>

<h3>配置日志系统</h3>

<p>默认情况下，<code>@TraceRecomposition</code> 不会记录任何日志，你需要在 <code>Application</code> 类中启用日志记录：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyApp</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Enable only in debug builds</span>
</span><span class='line'>        <span class="n">ComposeStabilityAnalyzer</span><span class="p">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="n">BuildConfig</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这一点非常重要，如果你没有自定义日志记录器，<strong>务必使用</strong> <code>**BuildConfig.DEBUG**</code> 包裹，以避免生产构建中潜在的安全问题。</p>

<p><strong>自定义日志记录器：Logcat 之外的选择</strong> 默认日志记录器使用 Logcat，但你可以提供自定义实现，将日志发送到你想要的任何位置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">ComposeStabilityAnalyzer</span><span class="p">.</span><span class="n">setLogger</span><span class="p">(</span><span class="k">object</span> <span class="err">: </span><span class="nc">RecompositionLogger</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">RecompositionEvent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Send to Firebase, Crashlytics, custom analytics, etc.  </span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">recompositionCount</span> <span class="p">&gt;=</span> <span class="m">10</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">FirebaseAnalytics</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="n">logEvent</span><span class="p">(</span><span class="s">&quot;excessive\_recomposition&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">param</span><span class="p">(</span><span class="s">&quot;composable&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">composableName</span><span class="p">)</span>
</span><span class='line'>                <span class="n">param</span><span class="p">(</span><span class="s">&quot;count&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">recompositionCount</span><span class="p">)</span>
</span><span class='line'>                <span class="n">param</span><span class="p">(</span><span class="s">&quot;unstable\_params&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">.</span><span class="n">unstableParameters</span><span class="p">.</span><span class="n">joinToString</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>因此，你甚至可以根据调试模式或发布模式设置不同的日志记录器。<code>RecompositionEvent</code> 包含：</p>

<ul>
<li><p><code>composableName</code>：函数名称。</p></li>
<li><p><code>tag</code>：来自 <code>@TraceRecomposition</code> 的标签。</p></li>
<li><p><code>recompositionCount</code>：重新组合的次数。</p></li>
<li><p><code>parameterChanges</code>：包含稳定性信息的参数变更列表。</p></li>
<li><p><code>unstableParameters</code>：不稳定参数名称列表。</p></li>
</ul>


<p>这支持强大的监控模式。你可以：</p>

<ul>
<li><p>针对过度重组的组合对象发送分析事件</p></li>
<li><p>在生产环境中跟踪性能指标（并采取适当的隐私保护措施）</p></li>
<li><p>构建显示重组模式的自定义仪表板</p></li>
<li><p>在测试环境中出现性能下降时发出警报</p></li>
</ul>


<p>以下是一个使用标签过滤日志内容的更贴近实际的示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">tagsToLog</span> <span class="p">=</span> <span class="n">setOf</span><span class="p">(</span><span class="s">&quot;checkout&quot;</span><span class="p">,</span> <span class="s">&quot;product-list&quot;</span><span class="p">,</span> <span class="s">&quot;search&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">ComposeStabilityAnalyzer</span><span class="p">.</span><span class="n">setLogger</span><span class="p">(</span><span class="k">object</span> <span class="err">: </span><span class="nc">RecompositionLogger</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">RecompositionEvent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">BuildConfig</span><span class="p">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// In debug, log everything</span>
</span><span class='line'>            <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s">&quot;Recomposition&quot;</span><span class="p">,</span> <span class="n">formatEvent</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// In release, only log tagged composables that exceed threshold</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">tag</span> <span class="k">in</span> <span class="n">tagsToLog</span> <span class="p">&amp;&amp;</span> <span class="n">event</span><span class="p">.</span><span class="n">recompositionCount</span> <span class="p">&gt;=</span> <span class="m">5</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Send to analytics</span>
</span><span class='line'>                <span class="n">FirebaseAnalytics</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="n">logEvent</span><span class="p">(</span><span class="s">&quot;recomposition_issue&quot;</span><span class="p">,</span> <span class="p">...)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h3>理解日志</h3>

<p>让我们一起来了解如何解读日志。请看以下示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#1] UserCard  </span>
</span><span class='line'>D/Recomposition:   ├─ user: User stable <span class="o">(</span>User@abc123<span class="o">)</span>
</span><span class='line'>D/Recomposition:   └─ onClick: <span class="o">()</span> -&gt; Unit stable <span class="o">(</span>Function@xyz789<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>这意味着：</strong></p>

<ul>
<li><p>这是此 <code>UserCard</code> 实例的首次重组。</p></li>
<li><p>两个参数都稳定。</p></li>
<li><p>这是初始重组的预期行为。</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#2] UserCard  </span>
</span><span class='line'>D/Recomposition:   ├─ user: User changed <span class="o">(</span>User@abc123 → User@def456<span class="o">)</span>
</span><span class='line'>D/Recomposition:   └─ onClick: <span class="o">()</span> -&gt; Unit stable <span class="o">(</span>Function@xyz789<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>这意味着：</strong></p>

<ul>
<li><p>第二次重组。</p></li>
<li><p><code>user</code> 参数已更改（新实例）。</p></li>
<li><p><code>onClick</code> 保持不变（相同的 lambda 实例）。</p></li>
<li><p>这是正常现象，参数已更改，因此需要进行重组。</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>D/Recomposition: <span class="o">[</span>Recomposition <span class="c">#3] UserCard (tag: user-profile)  </span>
</span><span class='line'>D/Recomposition:   ├─ user: MutableUser unstable <span class="o">(</span>MutableUser@xyz789<span class="o">)</span>
</span><span class='line'>D/Recomposition:   └─ Unstable parameters: <span class="o">[</span>user<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>这意味着：</strong></p>

<ul>
<li><p>第三次重组。</p></li>
<li><p><code>user</code> 参数<strong>不稳定</strong>（可能具有 <code>var</code> 属性）。</p></li>
<li><p>即使 <code>user</code> 没有更改，此可组合对象也会在每次父级重组时重新组合。</p></li>
<li><p><strong>需要采取的措施</strong>：将 <code>MutableUser</code> 类修复为不可变。</p></li>
</ul>


<h2>稳定性验证：防止 CI 中的性能退化</h2>

<p>Compose 稳定性分析器最强大的功能并非可视化反馈或运行时跟踪，而是<strong>防止稳定性退化影响生产环境</strong>。稳定性验证系统的作用类似于 git diff，用于检查可组合组件的稳定性，如果稳定性下降，则 CI 构建失败。</p>

<h3>问题：静默的性能退化</h3>

<p>想象一下这样的场景：你花了数周时间优化你的应用。每个可组合组件都稳定、可跳过且运行速度快。然后，一位同事无意中修改了一个数据类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Before (stable)</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">age</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// After (unstable)</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="k">var</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">var</span> <span class="py">age</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这一简单的更改会波及整个 UI 树。数十个原本可跳过的可组合组件变得不可跳过。性能退化了，但代码审查却未能发现，也没有任何明显的迹象表明出了问题。</p>

<p>稳定性验证可以防止这种情况发生。它会跟踪你的可组合组件的稳定性随时间的变化，并在稳定性下降时自动构建失败，强制在合并之前解决问题。</p>

<h3>工作原理：稳定性快照</h3>

<p>验证系统通过两个 Gradle 任务运行：</p>

<ul>
<li><p><code>**stabilityDump**</code>：创建一个包含所有可组合组件稳定性状态的 <code>.stability</code> 文件。</p></li>
<li><p><code>**stabilityCheck**</code>：将当前代码与基线进行比较，如果稳定性下降则构建失败。</p></li>
</ul>


<p>可以这样理解：</p>

<ul>
<li><p><code>stabilityDump</code> = &ldquo;保存当前状态&rdquo;</p></li>
<li><p><code>stabilityCheck</code> = &ldquo;自上次保存以来是否有任何更改？&rdquo;</p></li>
</ul>


<h3>步骤 1：创建基线</h3>

<p>编译项目后，运行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew :app:compileDebugKotlin
</span><span class='line'>./gradlew :app:stabilityDump
</span></code></pre></td></tr></table></div></figure>


<p>这将生成 <code>app/stability/app.stability</code> 文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">com</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">UserCard</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">User</span><span class="p">):</span> <span class="n">kotlin</span><span class="p">.</span><span class="n">Unit</span>
</span><span class='line'>  <span class="n">skippable</span><span class="p">:</span> <span class="k">true</span>
</span><span class='line'>  <span class="n">restartable</span><span class="p">:</span> <span class="k">true</span>
</span><span class='line'>  <span class="n">params</span><span class="p">:</span>
</span><span class='line'>    <span class="p">-</span> <span class="n">user</span><span class="p">:</span> <span class="n">STABLE</span> <span class="p">(</span><span class="n">immutable</span> <span class="n">data</span> <span class="k">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">com</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">ProductList</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">kotlin</span><span class="p">.</span><span class="n">collections</span><span class="p">.</span><span class="n">List</span><span class="p">&lt;</span><span class="n">com</span><span class="p">.</span><span class="n">example</span><span class="p">.</span><span class="n">Product</span><span class="err">\</span><span class="p">&gt;):</span> <span class="n">kotlin</span><span class="p">.</span><span class="n">Unit</span>
</span><span class='line'>  <span class="n">skippable</span><span class="p">:</span> <span class="k">true</span>
</span><span class='line'>  <span class="n">restartable</span><span class="p">:</span> <span class="k">true</span>
</span><span class='line'>  <span class="n">params</span><span class="p">:</span>
</span><span class='line'>    <span class="p">-</span> <span class="n">items</span><span class="p">:</span> <span class="n">STABLE</span> <span class="p">(</span><span class="n">immutable</span> <span class="n">collection</span> <span class="n">with</span> <span class="n">stable</span> <span class="n">elements</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>此文件易于阅读，并准确显示了编译器对每个可组合组件的判断结果。它是应用程序稳定性状态的完整快照。</p>

<p><strong>将此文件提交到 Git：</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add app/stability/app.stability
</span><span class='line'>git commit -m <span class="s2">&quot;Add stability baseline&quot;</span>
</span><span class='line'>git push
</span></code></pre></td></tr></table></div></figure>


<p>现在，团队中的每个人都拥有相同的基线。</p>

<h3>步骤 2：检查回归问题</h3>

<p>在你的 CI 流水线中运行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew :app:compileDebugKotlin
</span><span class='line'>./gradlew :app:stabilityCheck
</span></code></pre></td></tr></table></div></figure>


<p>如果没有任何变化，任务成功：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>✅ Stability check passed.
</span></code></pre></td></tr></table></div></figure>


<p>如果稳定性出现回归，任务失败：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>❌ Stability check failed!
</span><span class='line'>
</span><span class='line'>The following composables have changed stability:
</span><span class='line'>
</span><span class='line'>~ com.example.UserCard<span class="o">(</span>user<span class="o">)</span>: parameter <span class="s1">&#39;user&#39;</span> changed from STABLE to UNSTABLE
</span><span class='line'>
</span><span class='line'>If these changes are intentional, run <span class="s1">&#39;./gradlew stabilityDump&#39;</span> to update the baseline.
</span></code></pre></td></tr></table></div></figure>


<p>构建失败，在问题修复或明确接受回归之前，拉取请求将无法合并。</p>

<h3>检测到的变更类型</h3>

<p>验证器会检测到四种类型的变更：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1374/1*IwkocOj8s1No8lIphL1JIQ.png" alt="图9" /></p>

<p>这种全面的跟踪机制确保<strong>任何</strong>稳定性变更都清晰可见，并需要进行相应的决策。</p>

<h3>CI/CD 集成</h3>

<p>将稳定性验证添加到你的 GitHub Actions 工作流：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>name: Android CI
</span><span class='line'>
</span><span class='line'>on: <span class="o">[</span>push, pull_request<span class="o">]</span>
</span><span class='line'><span class="nb">jobs</span>:
</span><span class='line'>  build:
</span><span class='line'>    runs-on: ubuntu-latest
</span><span class='line'>    steps:
</span><span class='line'>      - uses: actions/checkout@v3
</span><span class='line'>      - name: Set up JDK <span class="m">17</span>
</span><span class='line'>        uses: actions/setup-java@v3
</span><span class='line'>        with:
</span><span class='line'>          java-version: <span class="s1">&#39;17&#39;</span>
</span><span class='line'>          distribution: <span class="s1">&#39;temurin&#39;</span>
</span><span class='line'>      - name: Build project
</span><span class='line'>        run: ./gradlew :app:compileDebugKotlin
</span><span class='line'>  stability_check:
</span><span class='line'>    name: Compose Stability Check
</span><span class='line'>    runs-on: ubuntu-latest
</span><span class='line'>    needs: build
</span><span class='line'>    steps:
</span><span class='line'>      - name: Check out code
</span><span class='line'>        uses: actions/checkout@v5.0.0
</span><span class='line'>      - name: Set up JDK
</span><span class='line'>        uses: actions/setup-java@v5.0.0
</span><span class='line'>        with:
</span><span class='line'>          distribution: <span class="s1">&#39;zulu&#39;</span>
</span><span class='line'>          java-version: <span class="m">21</span>
</span><span class='line'>      - name: Run stability check
</span><span class='line'>        run: ./gradlew stabilityCheck
</span></code></pre></td></tr></table></div></figure>


<p>现在，每个拉取请求都会自动进行检查。如果稳定性下降，则拉取请求将无法合并。</p>

<h3>配置选项</h3>

<p>你可以自定义要跟踪的内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// In your build.gradle.kts</span>
</span><span class='line'><span class="n">composeStabilityAnalyzer</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">stabilityValidation</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">enabled</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>        <span class="n">outputDir</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">layout</span><span class="p">.</span><span class="n">projectDirectory</span><span class="p">.</span><span class="n">dir</span><span class="p">(</span><span class="s">&quot;stability&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="n">includeTests</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="c1">// Exclude test code</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Ignore specific packages</span>
</span><span class='line'>        <span class="n">ignoredPackages</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="s">&quot;com.example.internal&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="c1">// Ignore specific classes (e.g., previews)</span>
</span><span class='line'>        <span class="n">ignoredClasses</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="s">&quot;PreviewComposables&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="c1">// Ignore entire modules</span>
</span><span class='line'>        <span class="n">ignoredProjects</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="s">&quot;benchmarks&quot;</span><span class="p">,</span> <span class="s">&quot;examples&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这对于排除不需要稳定性跟踪的代码非常有用，例如预览组合或调试屏幕。</p>

<h3>排除特定组合</h3>

<p>使用 <code>@IgnoreStabilityReport</code> 从验证中排除单个组合：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@IgnoreStabilityReport</span>
</span><span class='line'><span class="n">@Preview</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">UserCardPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">UserCard</span><span class="p">(</span><span class="n">user</span> <span class="p">=</span> <span class="n">User</span><span class="p">(</span><span class="s">&quot;John&quot;</span><span class="p">,</span> <span class="m">30</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>预览组合不会出现在生产版本中，因此它们的稳定性无关紧要。排除它们可以减少稳定性报告中的噪音。</p>

<h3>多模块项目</h3>

<p>对于包含多个模块的项目，每个模块都会有自己的 <code>.stability</code> 文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>project/
</span><span class='line'>├── app/stability/app.stability
</span><span class='line'>├── feature-auth/stability/feature-auth.stability
</span><span class='line'>└── feature-profile/stability/feature-profile.stability
</span></code></pre></td></tr></table></div></figure>


<p>在根目录运行 <code>stabilityCheck</code> 来检查所有模块：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew stabilityCheck
</span></code></pre></td></tr></table></div></figure>


<p>或者检查单个模块：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew :feature-auth:stabilityCheck
</span></code></pre></td></tr></table></div></figure>


<h3>接受有意为之的回归</h3>

<p>有时稳定性回归是有意为之的，例如你正在重构代码并暂时接受较低的稳定性。在这种情况下，请更新基线：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./gradlew :app:stabilityDump
</span><span class='line'>git add app/stability/app.stability
</span><span class='line'>git commit -m <span class="s2">&quot;Accept stability regression for UserCard (refactoring in progress)&quot;</span>
</span><span class='line'>git push
</span></code></pre></td></tr></table></div></figure>


<p>这会在 Git 历史记录中创建一个<strong>已记录的决策</strong>。回归不再是默默进行的，而是明确且可跟踪的。</p>

<h2>性能考量和最佳实践</h2>

<p>虽然这些工具功能强大，但仍有一些性能特性和最佳实践需要注意。有人问我是否需要让<em>每个</em>类型都稳定，答案绝对是“不需要”。</p>

<p>由于现在有了强跳过模式，每个可组合函数都可以跳过，这本身就能优化稳定性。即使这个插件可能会提示“不稳定”或“运行时稳定性”，但你实际上并不需要为每个可组合函数都进行修复。我们来看一个简单的例子。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*4ZtAbwb8_5tRAR112kL1HA.png" alt="图10" /></p>

<p>如果你查看 compose-material3 库中的 <code>Icon</code> 可组合函数，这个插件会提示它不稳定，因为它包含运行时参数。但是，<code>painter</code> 参数通常是通过 <code>painterResource</code> 函数初始化的，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.)</span>
</span><span class='line'><span class="n">Icon</span><span class="p">(</span><span class="n">painter</span> <span class="p">=</span> <span class="n">painter</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果你查看 <code>painterResource</code> 的内部逻辑，你会发现它本质上是稳定的。它内部使用 <code>remember</code> 将值缓存到内存中，所以你可以把它看作是一个小小的权衡：<em>“我会用一点内存来存储这个不稳定的实例，这样我就不必触发不必要的重新组合。”</em></p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*sRvsZMkusaZuOMjGskhz0A.png" alt="图11" /></p>

<p>关于不可变集合还有一个常见的误解——认为仅仅使用 <code>ImmutableList</code> 而不是普通的 <code>List</code> 就能提升性能。 <strong>并非总是如此。</strong></p>

<p>不妨这样想：如果你有一个包含 1000 个大型对象的列表，然后你将其转换为不可变列表，那么你的可组合组件就变得可以忽略了。但是，每次重新组合时，Compose 都会对列表中的每个元素运行 <code>equals()</code> 函数，以检查新实例是否与之前的实例匹配。在某些情况下，这实际上会比重新渲染一个只显示其中五个元素的轻量级 UI 更<strong>影响性能</strong>。</p>

<p>因此，<strong>稳定性会根据具体情况产生截然不同的影响</strong>，试图让整个 UI 保持稳定通常是不必要的，也是徒劳的。我希望这个插件不会加重你对稳定性的担忧，而是能够帮助你更有效地调试实际的性能问题，并做出更明智、更数据驱动的决策，而无需过度考虑稳定性。</p>

<h2>结论</h2>

<p>在本文中，我们探索了 Compose 稳定性分析器 (Compose Stability Analyzer) (<a href="https://github.com/skydoves/compose-stability-analyzer">https://github.com/skydoves/compose-stability-analyzer</a>)，了解了它如何通过三个互补的工具将 Compose 隐藏的稳定性分析可视化：IntelliJ 插件用于在开发过程中提供可视化反馈，Gradle 插件用于运行时重组追踪，以及稳定性验证系统用于防止持续集成 (CI) 中的回归。</p>

<p>IntelliJ 插件将稳定性从一个不可见的编译时概念转化为可感知的事物，通过边栏图标、工具提示和内联提示，使稳定性问题一目了然。<code>@TraceRecomposition</code> 注解弥合了编译时分析和运行时行为之间的鸿沟，让你可以准确地了解可组合组件何时以及为何重新组合。稳定性验证系统则起到安全网的作用，确保你精心设计的优化不会随着代码库的演进而悄然失效。</p>

<p>这些工具共同作用，使稳定性分析成为你开发工作流程中自然而然的一部分。你无需等待性能问题显现，即可在编码过程中立即发现它们。你无需猜测哪个参数导致了重新组合——日志会准确地告诉你哪些参数发生了变化。你也无需手动审查每个 PR 是否存在稳定性回归，CI 流水线会自动完成这项工作。</p>

<p>理解稳定性是编写高性能 Compose 应用程序的基础。借助 Compose 稳定性分析器，这种理解变得轻松、直观、即时且有效。</p>

<p>祝你编码愉快！</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alex Hilton</span></span>

      




<time class='entry-date' datetime='2026-01-30'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>30</span><span class='date-suffix'>th</span>, <span class='date-year'>2026</span></span> <span class='time'>12:00 am</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/compose/'>compose</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
    <!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2026/01/22/glitch-at-scale-effects/" title="Previous Post: Compose GPU加速特效：带缩放的故障效果">&laquo; Compose GPU加速特效：带缩放的故障效果</a>
      
      
        <a class="basic-alignment right" href="/blog/2026/02/02/mastering-intrisnicsize/" title="Next Post: Compose中的IntrinsicSize实战指南">Compose中的IntrinsicSize实战指南 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="comments"></div>
    <!-- Duoshuo COMMENT BEGIN -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var clientId = 'bc66a01ef24d14fc282b'
    var clientSecret = 'c7fd5e55db1776204fe201fe20c050b140982884'
    var gitment = new Gitment({
      id: 'toughcoder.net',
      owner: 'alexhilton',
      repo: 'alexhilton.github.io',
      oauth: {
        client_id: clientId,
        client_secret: clientSecret,
      },
    })

    gitment.render('comments')
</script>
<!-- Duoshuo COMMENT END -->

  </section>

</div>

<aside class="sidebar">
  
    <section>
    <div class="
        col-lg-2 col-lg-offset-0
        visible-lg-block
        sidebar-container
        catalog-container">
        <div class="side-catalog">
            <hr class="hidden-sm hidden-xs">
            <h3>
                <a class="catalog-toggle" href="#">CATALOG</a>
            </h3>
            <ul class="catalog-body"></ul>
        </div>
    </div>
</section>
<!-- Back to top and Scroll to bottom -->
<a href="#" class="cd-top"></a>
<a href="#" class="cd-bottom"></a>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2026 - Alex Hilton -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<script type="text/javascript">
    //async load function 
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }

    function generateCatalog (selector) {
        var P = $('article'),a,n,t,l,i,c, id;
        a = P.find('h2,h3,h4,h5,h6');
        var index = 0;
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            id = $(this).prop('id');
            if (!id) {
                var nid = 'catalog-section-' + index;
                $(this).attr('id', nid);
                i = '#' + nid;
            } else {
                i = '#' + id;
            }
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
            index++;
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/javascripts/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });

// Navigation Scripts to Show Header on Scroll-Up
jQuery(document).ready(function($) {
    var MQL = 1170;

    //primary navigation slide-in effect
    if ($(window).width() > MQL) {
        // We do not have the sticky nav bar so, first can be zero
        var headerHeight = 0;
        $('nav').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $('header').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $(window).on('scroll', {
                previousTop: 0
            },
            function() {
                var currentTop = $(window).scrollTop(),
                    $catalog = $('.side-catalog');

                this.previousTop = currentTop;

                //adjust the appearance of side-catalog
                $catalog.show()
                if (currentTop > (headerHeight + 42)) {
                    $catalog.addClass('fixed')
                } else {
                    $catalog.removeClass('fixed')
                }
            });
    }
});
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3fab3b1bae08e6d4a5e638d9e8c6f40a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


</body>
</html>
