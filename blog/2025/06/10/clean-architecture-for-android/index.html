
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>在现代Android开发中实战Clean Architecture - 稀有猿诉</title>
  <meta name="author" content="Alex Hilton">

  
  <meta name="description" content="通过实战，运用整洁架构（Clean Architecture）方法，来解决现代 Android 开发中的常见陷阱，并增强可维护性。">
  <meta name="keywords" content="Clean architecture, Android, Compose">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://alexhilton.github.io/blog/2025/06/10/clean-architecture-for-android">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="稀有猿诉" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/toolbar.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- for Gitment -->
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">

<!-- for favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">稀有猿诉</a></h1>
  
    <h2>十年磨一剑，历炼出锋芒，说话千百句，不如码二行。</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alexhilton.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/donation">Donation</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">在现代Android开发中实战Clean Architecture</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2025-06-10T22:33:00+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2025</span></span> <span class='time'>10:33 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>本文译自「Refining Clean Architecture for Android: A
Practical Approach」，原文链接<a href="https://medium.com/@siarhei.krupenich/refining-clean-architecture-for-android-a-practical-approach-32ce966f8ba3">https://medium.com/@siarhei.krupenich/refining-clean-architecture-for-android-a-practical-approach-32ce966f8ba3</a>，由Siarhei Krupenich发布于2025年2月23日。</p></blockquote>

<p><a href="/blog/2025/06/10/clean-architecture-for-android/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*964gi7PELf9cc4CQwp6XBA.png" title="auto auto" ></a></p>

<!-- more -->


<h2>简介</h2>

<p>本文是专注于 Android 开发和设计中实际问题一系列文章中的第一篇，这些文章将会涵盖整洁架构 (Clean Architecture)、ViewModel 输入/输出拆分、Repository 模式等，并基于最佳实践提供解决方案。每篇都将聚焦于一个特定主题，并包含一个 GitHub 分支的链接，用于演示该主题的实践代码。作为开篇，本文将探讨整洁架构、其面临的挑战以及可在生产环境中应用的实用解决方案。</p>

<h2>整洁架构（Clean Architecture）简介</h2>

<p>整洁架构是一种结构化的方法，通过将应用程序的代码库划分为数据层、领域层和展现层来组织它。</p>

<ul>
<li>数据层（Data Layer）：处理数据检索和存储，无需了解域层或表示层。</li>
<li>领域层（Domain Layer）：包含业务逻辑和用例，与数据层交互，但独立于表示层。</li>
<li>展现层（Presentation Layer）：专注于 UI，从领域层接收状态，并保持逻辑最小化。</li>
</ul>


<p>这里关键原则是依赖关系只向内流动——每一层只了解其下一层，从而确保可维护性和关注点分离（Separation of Concerns）。下图展示了 Android 中一个简单的整洁架构 (Clean Architecture) 实现：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1064/format:webp/0*iND5nS_w8q9O_o2z" alt="图 1：Android 的简单整洁架构实现" /></p>

<h2>让我们开始撸吧！</h2>

<p>首先，我们需要按照图 1构建项目结构。虽然功能模块通常是大型项目的一部分，但为了演示方便，我们将尽量简化，仅关注整洁架构。</p>

<p>我们将构建一个小型应用，该应用使用整洁架构 + MVVM + 协程，进行单个 API 调用并显示一个简单的列表。</p>

<p>为了保持独立性，每个层将被拆分为独立的模块：</p>

<ul>
<li>数据层(Data Layer)：包含 Retrofit 依赖项、网络模型和用于数据访问的存储库。（也可以选择添加本地存储实现。）</li>
<li>领域层(Domain Layer)：包含用例（或交互器）、领域模型和用于将网络模型转换为领域模型的映射器。它依赖于数据模块，因为它使用其存储库。</li>
<li>表示层(Presentation Layer)：包含与领域模块中的用例交互的 ViewModel，用于处理 UI 数据。</li>
</ul>


<p>项目结构如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>- Data
</span><span class='line'>  API Interface <span class="o">(</span>Retrofit<span class="o">)</span>
</span><span class='line'>  DAO
</span><span class='line'>  Repository Interface
</span><span class='line'>  Repository Instance
</span><span class='line'>- Domain
</span><span class='line'>  Use-cases and their interfaces
</span><span class='line'>  Domain models
</span><span class='line'>  Mappers from Network to Domain models
</span><span class='line'>- Presentation
</span><span class='line'>  ViewModels
</span><span class='line'>  Views
</span></code></pre></td></tr></table></div></figure>


<h3>数据模块（Data Module）:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">DataNetworkApi</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">@GET</span><span class="p">(</span><span class="n">API_DATA</span><span class="p">)</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ApiEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">companion</span> <span class="k">object</span> <span class="err">{ </span>
</span><span class='line'>    <span class="k">private</span> <span class="n">const</span> <span class="k">val</span> <span class="py">API_DATA</span> <span class="p">=</span> <span class="s">&quot;/api/data&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Keep</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">DataApiEntity</span><span class="p">(</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">description</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataApiEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">dataNetworkApi</span><span class="p">:</span> <span class="n">DataNetworkApi</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">dataLocalStorage</span><span class="p">:</span> <span class="n">DataLocalStorage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>
</span><span class='line'>    <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataApiEntity</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// dataLocalStorage and dataLocalStorage usage </span>
</span><span class='line'>    <span class="err">…</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dataNetworkApi</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>显然，这不是存储库模式(Repository Pattern)的经典实现——它纯粹是为了演示而设计的，以让我们能专注于整洁架构。</p>

<h3>领域模块（Domain Module）：</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">DataEntity</span><span class="p">(</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">title</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">description</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataEntityMapperImpl</span><span class="p">:</span> <span class="n">DataEntityMapper</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">fun</span> <span class="nf">map</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">DataApiEntity</span><span class="p">):</span> <span class="n">DataEntity</span> <span class="p">=</span> <span class="n">with</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DataEntity</span><span class="p">(</span>
</span><span class='line'>      <span class="err">…</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>  <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetDataUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">DataEntityMapper</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">DataRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span>
</span><span class='line'>    <span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>  <span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">repository</span><span class="p">.</span><span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">map</span> <span class="p">{</span> <span class="n">repositoryData</span> <span class="p">-&gt;</span>
</span><span class='line'>      <span class="n">repositoryData</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">data</span> <span class="p">-&gt;</span> <span class="n">mapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>展现模块（Presentation Module）：</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="n">sealed</span> <span class="n">interface</span> <span class="n">UiDataState</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">(</span><span class="k">val</span> <span class="py">repos</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;):</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">object</span> <span class="nc">Empty</span><span class="p">:</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span><span class="p">:</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">message</span><span class="p">:</span> <span class="n">String</span><span class="p">?):</span> <span class="n">UiDataState</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">GetUiDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">UiDataState</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetUiDataUseCaseImpl</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetDataUseCase</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapUiData</span><span class="p">:</span> <span class="n">MapDataUiModelUseCase</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapUiStateData</span><span class="p">:</span> <span class="n">MapDataUiStateUseCase</span>
</span><span class='line'><span class="p">):</span> <span class="n">GetUiDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">UiDataState</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">mapUiStateData</span><span class="p">(</span>
</span><span class='line'>      <span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">mapCatching</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">it</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapUiRepos</span><span class="o">::</span><span class="n">invoke</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于 GetUiDataUseCaseImpl 有几个关键点需要注意。如你所见，它包含一个上述 GetDataUseCase 实现的实例以及两个额外的映射器。MapDataUiModelUseCase 可以将领域模型转换为 UI 模型（属于表示层）。同时，MapDataUiStateUseCase 确定相应的 UI 状态，可以是以下之一：</p>

<ul>
<li>正在加载(Loading)</li>
<li>空数据(Empty)</li>
<li>非空(Non-Empty)</li>
<li>错误(Error)</li>
</ul>


<h4>ViewModel：</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">TestViewModel</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetUiDataUseCase</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">refresh</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">RepoState</span><span class="p">.</span><span class="n">Loading</span>
</span><span class='line'>     <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>GitHub 项目与提供的代码片段略有不同，因为它使用了 ViewModel 输入/输出模式和 Hilt 依赖注入——这两者都是可扩展开发的基本原则，我们将在后续文章中探讨。此外，所有组件都用接口包装，确保可测试性，同时允许在接口级别进行无缝操作。后续文章将深入探讨这些方面。</p>

<p>我们成功了！现在，让我们深入研究代码。每一层都负责特定的功能，使其既模块化又易于测试。数据层的存储库依赖于 API 和本地存储，而领域用例依赖于存储库。表示层与领域用例交互。</p>

<p>如果我需要替换 HTTP 客户端，我只需将新的依赖项注入存储库，同时保持契约，确保功能无缝衔接。此外，每个组件都可以被单元测试覆盖，从而使架构可扩展且易于维护。</p>

<p>同样需要强调的是，接口应该属于使用它们的层。乍一看，一切都井井有条，似乎没有什么需要改进的地方。但让我们仔细看看。</p>

<h2>经典整洁架构实现的缺点</h2>

<h3>观察结果和潜在问题</h3>

<p>我们上面开发的实现允许直接访问底层模块组件，例如 API 实现或数据库存储。一种可能的解决方案是将它们内部化，并确保只能通过存储库访问数据。然而，这种方法仍然存在一个关键的缺点：存储库的接口及其实例都保存在同一个数据模块中。这会导致一些潜在的风险：</p>

<ol>
<li>违反封装——直接使用具体实例而不是接口存在风险，这也会影响接口隔离原则。</li>
<li>违反整洁架构契约——随着项目的发展，可能会出现偷工减料的倾向，例如允许领域用例与数据库实例而不是存储库接口交互。</li>
<li>存储库委托的复杂性增加——将组件绑定在一起变得更具挑战性，尤其是在依赖关系增加的情况下。</li>
<li>更高的维护成本——随着时间的推移，违反架构契约会导致维护工作量增加，并降低代码的可扩展性。</li>
<li>更复杂的单元测试——对低级组件的无限制访问使测试变得复杂，因为依赖项可能会以非预期的方式使用。</li>
</ol>


<p>缓解上述风险的唯一方法是将职责进一步拆分成更多独立的层和模块。数据模块应继续包含 API 和数据存储的实例，但所有存储库接口都应移出。建议在领域模块内创建子模块，并确保它们保持独立。</p>

<p>此外，API 和数据库实例可以通过专用服务层（例如 API 服务和本地存储服务）访问。这不仅增强了可测试性，还强制执行了适当的抽象。此外，数据实体应放置在数据子模块中，这些子模块仍与域层保持连接。</p>

<p>通过遵循这种方法，所有组件仅通过各自的接口进行交互，而无需直接了解它们的实际实现。这确保了更好的模块化、可维护性，并遵循了整洁架构原则。</p>

<p>下图展示了改进的解决方案：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6pQ1HngSx6WIwaZx" alt="图 2. 增强型 Android Clean Architecture 实现" /></p>

<p>以下项目结构说明了增强的架构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>- Data
</span><span class='line'>  API Interface <span class="o">(</span>Retrofit<span class="o">)</span>
</span><span class='line'>  DAO
</span><span class='line'>  Data Services
</span><span class='line'>  API Services
</span><span class='line'>  Repositories implementations of Domain.Repository
</span><span class='line'>- Domain
</span><span class='line'>  Use-cases
</span><span class='line'>  Domain Entities
</span><span class='line'>  Mappers from Network models to Domain ones
</span><span class='line'>  -- Repository
</span><span class='line'>     Repository Interface
</span><span class='line'>     API Entity
</span><span class='line'>- Presentation
</span><span class='line'>  ViewModels
</span><span class='line'>  Views
</span></code></pre></td></tr></table></div></figure>


<h3>重新开始编码</h3>

<p>现在，我们将重点关注架构的改进部分。你可以通过以下链接在 GitHub 上找到完整的示例。</p>

<h4>Domain.Repository 子模块：</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Data Module:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">dataNetworkApi</span><span class="p">:</span> <span class="n">DataNetworkApi</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span>
</span><span class='line'>       <span class="n">dataNetworkApi</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Domain Module:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetDataUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">DataEntityMapper</span><span class="p">,</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">DataRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>       <span class="n">repository</span><span class="p">.</span><span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span><span class='line'>           <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">listOfData</span> <span class="p">-&gt;</span>
</span><span class='line'>               <span class="n">listOfData</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">data</span> <span class="p">-&gt;</span> <span class="n">mapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>           <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>结论</h2>

<p>总而言之，我们实现了增强版的整洁架构。逻辑可以按功能进一步划分，每个功能模块都遵循其自身的整洁架构结构。此外，这种划分可以扩展到展现层，确保领域层和展现层之间的界限清晰区分。这种方法允许 UI用例严格通过接口与领域用例交互，从而保持模块化和可扩展性。</p>

<h2>额外注意事项</h2>

<p>项目示例演示了这种方法。通过实现了一个简单的应用程序，可以进行 API 调用、接收数据并显示列表。为了使应用程序功能齐全，它还使用了本文未涉及的其他组件：Retrofit、Hilt 以及包含通用组件的核心模块。这些额外组件不会影响你对本文主题的理解。</p>

<p>完整实例代码：<a href="https://github.com/sergeykrupenich/TestRepo/tree/clean-architecture">https://github.com/sergeykrupenich/TestRepo/tree/clean-architecture</a></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alex Hilton</span></span>

      




<time class='entry-date' datetime='2025-06-10T22:33:00+08:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2025</span></span> <span class='time'>10:33 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/architecture/'>architecture</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
    <!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2025/06/07/ui-layer-architecture/" title="Previous Post: 长驻UI元素的UI层体系结构">&laquo; 长驻UI元素的UI层体系结构</a>
      
      
        <a class="basic-alignment right" href="/blog/2025/06/11/mvvm-inputs-outputs-jetpack-compose/" title="Next Post: Jetpack Compose 中ViewModel的最佳实践">Jetpack Compose 中ViewModel的最佳实践 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="comments"></div>
    <!-- Duoshuo COMMENT BEGIN -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var clientId = 'bc66a01ef24d14fc282b'
    var clientSecret = 'c7fd5e55db1776204fe201fe20c050b140982884'
    var gitment = new Gitment({
      id: 'toughcoder.net',
      owner: 'alexhilton',
      repo: 'alexhilton.github.io',
      oauth: {
        client_id: clientId,
        client_secret: clientSecret,
      },
    })

    gitment.render('comments')
</script>
<!-- Duoshuo COMMENT END -->

  </section>

</div>

<aside class="sidebar">
  
    <section>
    <div class="
        col-lg-2 col-lg-offset-0
        visible-lg-block
        sidebar-container
        catalog-container">
        <div class="side-catalog">
            <hr class="hidden-sm hidden-xs">
            <h3>
                <a class="catalog-toggle" href="#">CATALOG</a>
            </h3>
            <ul class="catalog-body"></ul>
        </div>
    </div>
</section>
<!-- Back to top and Scroll to bottom -->
<a href="#" class="cd-top"></a>
<a href="#" class="cd-bottom"></a>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - Alex Hilton -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<script type="text/javascript">
    //async load function 
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }

    function generateCatalog (selector) {
        var P = $('article'),a,n,t,l,i,c, id;
        a = P.find('h2,h3,h4,h5,h6');
        var index = 0;
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            id = $(this).prop('id');
            if (!id) {
                var nid = 'catalog-section-' + index;
                $(this).attr('id', nid);
                i = '#' + nid;
            } else {
                i = '#' + id;
            }
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
            index++;
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/javascripts/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });

// Navigation Scripts to Show Header on Scroll-Up
jQuery(document).ready(function($) {
    var MQL = 1170;

    //primary navigation slide-in effect
    if ($(window).width() > MQL) {
        // We do not have the sticky nav bar so, first can be zero
        var headerHeight = 0;
        $('nav').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $('header').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $(window).on('scroll', {
                previousTop: 0
            },
            function() {
                var currentTop = $(window).scrollTop(),
                    $catalog = $('.side-catalog');

                this.previousTop = currentTop;

                //adjust the appearance of side-catalog
                $catalog.show()
                if (currentTop > (headerHeight + 42)) {
                    $catalog.addClass('fixed')
                } else {
                    $catalog.removeClass('fixed')
                }
            });
    }
});
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3fab3b1bae08e6d4a5e638d9e8c6f40a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


</body>
</html>
