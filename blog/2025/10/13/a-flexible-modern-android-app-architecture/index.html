
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>灵活、现代的Android应用架构：完整分步指南 - 稀有猿诉</title>
  <meta name="author" content="Alex Hilton">

  
  <meta name="description" content="本文通过具体的实例来一步一步地构建一个Android应用，以展示在应用构建过程中各种关于架构的决策是如何制定的。">
  <meta name="keywords" content="Android, Clean Architecture">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="稀有猿诉" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js" integrity="sha256-oP6HI9z1XaZNBrJURtCoUT5SUnxFr8s3BzRl+cbzUq8=" crossorigin="anonymous"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <script src="/javascripts/toolbar.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.lug.ustc.edu.cn/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- for Gitment -->
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">

<!-- for favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">稀有猿诉</a></h1>
  
    <h2>十年磨一剑，历炼出锋芒，说话千百句，不如码二行。</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com.hk/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alexhilton.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/donation">Donation</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">灵活、现代的Android应用架构：完整分步指南</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2025-10-13T23:05:25+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2025</span></span> <span class='time'>11:05 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>本文译自「A flexible, modern Android app architecture: complete step-by-step」，原文链接<a href="https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993">https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993</a>，由Tom Colvin发布于2023年7月4日。</p></blockquote>

<p><a href="/blog/2025/10/13/a-flexible-modern-android-app-architecture/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*ykKTTMXsKNzLJ7In" title="auto auto" ></a></p>

<!-- more -->


<p>我最近写了一篇关于<a href="https://juejin.cn/post/7553894051460694055">优秀 Android 应用架构背后的理论</a>的文章。这篇文章成为了我迄今为止最受欢迎的文章，许多人都慷慨地表示它对他们很有帮助。</p>

<p>最常见的问题之一是：“但是 X 呢？它不太符合规则。” 这就是为什么我一直说：</p>

<blockquote><p>要学习原则，而不是盲目遵循规则。</p></blockquote>

<p>本文旨在展示实践的一面：通过示例来教授 Android 架构。最重要的是，这意味着展示各种架构决策是如何制定的。我们会遇到有多种可能答案的情况，在每种情况下，我们都会依靠原则，而不是死记硬背一套规则。</p>

<p>所以，让我们一起构建一个应用程序吧。</p>

<h2>介绍我们将要构建的应用程序</h2>

<p>我们将为行星观测者构建一款应用程序。它看起来会像这样：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:640/1*7C7vCDdsppHzE1DQkI3QJA.gif" alt="应用程序（全球排名第一的行星观测应用程序）演示：添加示例行星、添加自定义行星、删除行星以及刷新" /></p>

<p>我们的应用程序将具有以下功能：</p>

<ul>
<li>列出你之前发现的所有行星</li>
<li>添加新发现的行星</li>
<li>删除行星（以防你意识到你的发现实际上只是望远镜镜头上的一小块痕迹）</li>
<li>添加一些示例行星，以便用户了解应用程序的工作原理</li>
</ul>


<p>它将具有离线数据缓存以及在线数据库访问功能。</p>

<p>与我的演示一样，我鼓励你尝试不同的做法：添加额外功能，考虑未来可能出现的规格变更，挑战自我。在这里，学习的重点在于<em>代码背后的思考过程</em>，而不是代码本身。所以，如果你想从本教程中获得最大收获，不要盲目地复制代码。</p>

<p>这是我们最终的仓库：<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>。</p>

<h2>介绍我们将要使用的架构原则</h2>

<p>我们将参考 SOLID 原则、整洁架构原则以及 Google 自己的现代应用架构原则。</p>

<p>我们不会将这些原则视为硬性规定，因为我们足够聪明，能够构建更适合我们应用（尤其是更符合我们预期应用增长方式）的架构。例如，如果你严格遵循整洁架构，你将开发出稳定、可靠、可扩展的软件，但对于单一用途的应用来说，你的代码可能会过于复杂。Google 的原则可以生成更简单的代码，但如果有一天该应用可能由多个大型开发团队维护，则这些原则就不太适用了。</p>

<p>我们将从 Google 的拓扑结构开始，并在此过程中参考整洁架构。</p>

<p>Google 的拓扑结构如下：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1200/1*tuohW6OJuZD8tMcAYjPBSg.png" alt="" /></p>

<p>我们将逐步实现这些功能，<a href="https://juejin.cn/post/7553894051460694055">我的上一篇文章</a> 对每个部分都进行了更深入的介绍。这里再简单地概述一下：</p>

<h3>UI 层</h3>

<p>UI 层实现用户界面。它分为：</p>

<ul>
<li><strong>UI 元素</strong>，即用于在屏幕上绘制内容的所有专有代码。在 Android 中，主要选择是 Jetpack Compose（此处使用 <code>@Composable</code>）或 XML（此处包含你的 XML 文件和资源）。</li>
<li><strong>状态持有者</strong>，用于实现你偏好的 MVVM / MVC / MVP / &hellip; 拓扑结构。在此应用中，我们将使用视图模型。</li>
</ul>


<h3>领域层</h3>

<p>领域层用于包含高级业务逻辑的<strong>用例</strong>。例如​​，当我们想要添加一个星球时，AddPlanetUseCase 将描述执行此操作所需的一系列步骤。它只是“做什么”的列表，而不是“怎么做”的列表：例如，我们会说“保存 Planet 对象的数据”。这是一个高级指令。我们不会说“将其保存到本地缓存”，更不用说“使用 Room 数据库将其保存到本地缓存”了——这些底层实现细节应该放在其他地方。</p>

<h3>数据层</h3>

<p>Google 敦促我们为应用中的所有数据提供单一可信来源；也就是说，一种获取最终“正确”数据版本的方法。这就是数据层将要提供的内容（涵盖除描述用户刚刚输入内容的数据结构之外的所有数据结构）。它分为：</p>

<ul>
<li><strong>存储库</strong>，用于管理各种类型的数据。例如，我们将有一个行星数据存储库，它将提供对已发现行星的 CRUD（创建、读取、更新、删除）操作。它还将处理数据存储在本地缓存和远程缓存中的情况，为不同类型的操作选择合适的数据源，并管理当两个数据源包含不同数据副本时的处理方式。这里我们将讨论本地缓存，但我们不会讨论我们将使用哪些第三方技术来实现它。</li>
<li><strong>数据源</strong>，用于管理数据存储的具体细节。当存储库请求“远程存储 X”时，它会请求数据源执行此操作。数据源仅包含驱动专有技术所需的代码——可能是 Firebase、HTTP API 或其他技术。</li>
</ul>


<h2>良好的架构允许延迟决策</h2>

<p>在此阶段，我们已经了解了应用的功能，以及一些关于如何管理数据的基本想法。</p>

<p>还有一些事情我们尚未确定。我们还不知道 UI 的具体外观，也不知道将使用什么技术来构建它（Jetpack Compose、XML 等）。我们不知道本地缓存将采用何种形式。我们不知道将使用哪种专有解决方案来访问在线数据。我们不知道是否支持手机、平板电脑或其他设备。</p>

<p><strong>_问题：我们需要了解以上任何内容才能制定架构吗？</strong></p>

<p><strong>_答案：不需要！</strong></p>

<p>以上都是底层考虑因素（在整洁架构中，它们的代码位于最外层）。它们是<em>实现细节</em>，而不是<em>逻辑</em>。SOLID 的依赖倒置原则告诉我们，任何代码都不应依赖于它们。</p>

<p>换句话说，我们应该能够在不了解上述任何知识的情况下编写（并测试！）应用程序的其余代码。当我们了解上述问题的答案时，我们已经编写的任何代码都无需更改。</p>

<p>这意味着代码生产阶段可以在设计师完成设计之前以及利益相关者决定使用第三方技术之前开始。因此，<em>良好的架构允许延迟决策</em>。（并且能够灵活地撤销任何此类决策，而不会导致严重的代码问题）。</p>

<h2>我们项目的架构图</h2>

<p>这是我们将行星观测员的应用程序融入 Google 拓扑结构的初步尝试。</p>

<h3>数据层</h3>

<p>我们将有一个用于行星数据的<strong>存储库</strong>，以及两个<strong>数据源</strong>：一个用于本地缓存，一个用于远程数据。</p>

<h3>UI 层</h3>

<p>将​​有两个<strong>状态持有者</strong>，一个用于行星列表页面，另一个用于添加行星页面。每个页面还会有一组<strong>UI 元素</strong>，这些元素将使用目前尚待确定的技术编写。</p>

<h3>领域层</h3>

<p>有两种非常有效的领域层架构方法：</p>

<ol>
<li>我们可以只在重复业务逻辑的地方添加用例。在我们的应用中，唯一重复的逻辑是添加行星：用户添加示例行星列表和手动输入自己的行星详细信息时都需要它。因此，我们只创建一个用例：AddPlanetUseCase。在其他情况下（例如删除行星），状态持有者将直接与存储库交互。</li>
<li>我们可以为与存储库的每次交互添加用例，这样状态持有者和存储库之间就不会有任何直接联系。在这种情况下，我们将有添加行星、删除行星和列出行星的用例。</li>
</ol>


<p>第二种方法的好处是它遵循了整洁架构的规则。我个人认为这种方法对于大多数应用来说有点太重了，所以我倾向于选择第一种。这就是我们要做的。</p>

<p>这给了我们以下架构图：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*69Zaett5v82b0uzpF1dgOg.png" alt="我们应用的架构图：显示 UI、领域和数据层的架构图" /></p>

<h2>我们应该从哪些代码开始？</h2>

<p>规则是：</p>

<blockquote><p>从高层代码开始，然后逐步向下。</p></blockquote>

<p>这意味着首先要写出用例，因为这样做可以告诉我们存储库层有哪些需求。一旦我们知道存储库需要什么，我们就可以写出数据源需要什么来支持它。</p>

<p>同样，由于用例告诉我们用户可能采取的所有操作，我们就可以了解 UI 的所有输入和输出。由此，我们可以知道 UI 需要包含哪些内容，从而可以编写状态持有者（视图模型）。有了状态持有者，我们就知道需要编写哪些 UI 元素。</p>

<p>当然，一旦高级工程师和项目利益相关者就将要使用的技术达成一致，我们就可以无限期地推迟编写 UI 元素和数据源（即所有底层代码）。</p>

<p>理论到此结束。现在让我们开始构建应用程序。我会向你们详细介绍我们做出的决定。</p>

<h2>步骤 0：创建项目</h2>

<p>打开 Android Studio 并创建一个“无活动”项目：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*SQ52XlNqWwTEQ9GfsluAQA.png" alt="Android Studio“No Activity”项目" /></p>

<p>在下一个屏幕上，将其命名为 PlanetSpotters，其他内容保持不变：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*wkq8joirefCSsxeR-y3bnw.png" alt="Android Studio“新建项目”屏幕显示输入的名称为“PlanetSpotters”" /></p>

<h3>添加依赖注入</h3>

<p>我们需要一个依赖注入框架，它有助于应用 SOLID 的依赖倒置原则。 Hilt 是我最喜欢的选择，而且值得庆幸的是，它也是 Google 特别推荐的。</p>

<p>要 <a href="https://developer.android.com/training/dependency-injection/hilt-android">添加 Hilt</a>，请在根 Gradle 文件中添加以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span> <span class="n">version</span> <span class="s1">&#39;2.44.2&#39;</span> <span class="n">apply</span> <span class="kc">false</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>并在 app/build.gradle 文件中添加以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;kotlin-kapt&#39;</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">compileOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sourceCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>    <span class="n">targetCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">kotlinOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">jvmTarget</span> <span class="o">=</span> <span class="s1">&#39;17&#39;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">implementation</span> <span class="s2">&quot;com.google.dagger:hilt-android:2.44.2&quot;</span>
</span><span class='line'>  <span class="n">kapt</span> <span class="s2">&quot;com.google.dagger:hilt-compiler:2.44.2&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Allow references to generated code</span>
</span><span class='line'><span class="n">kapt</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">correctErrorTypes</span> <span class="kc">true</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>（请注意，我们在此处将兼容性设置为 Java 17，这是 Hilt 使用的 Kapt 的要求。你需要 Android Studio Flamingo 或更高版本）。</p>

<p>最后，添加 Application 类的重写，其中包含 <code>@HiltAndroidApp</code> 注解。也就是说，在应用的包文件夹（此处为 <code>com.tdcolvin.planetspotters</code>）中创建一个名为 PlanetSpottersApplication 的文件，内容如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">android.app.Application</span>
</span><span class='line'><span class="k">import</span> <span class="nn">dagger.hilt.android.HiltAndroidApp</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltAndroidApp</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetSpottersApplication</span><span class="p">:</span> <span class="n">Application</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>……然后，通过将文件添加到清单中，告诉操作系统实例化它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;application</span>
</span><span class='line'>        <span class="err">....</span>
</span><span class='line'>        <span class="na">android:name=</span><span class="s">&quot;.PlanetSpottersApplication&quot;</span>
</span><span class='line'>        <span class="err">...</span>
</span><span class='line'>    <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    ...
</span><span class='line'><span class="nt">&lt;/manifest&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>一旦我们有了主 Activity，我们就需要为其添加 <code>@AndroidEntryPoint</code>。但现在，我们的 Hilt 设置就完成了。</p>

<p>最后，我们将通过在 app/build.gradle 中添加以下代码来添加对其他有用库的支持：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Coroutines</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//viewModelScope</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 1：列出用户可以执行和查看的所有功能</h2>

<p>此步骤是编写用例和存储库的准备工作。回想一下，用例是用户可以执行的单个任务，并以高层次描述（描述“什么”，而不是“如何”）。</p>

<p>因此，让我们从写出这些任务开始；列出用户可以在应用中执行和查看的所有功能的详尽列表。</p>

<p>其中一些任务最终会被编码为用例。（事实上，在清晰架构下，所有此类任务都必须以用例的形式编写）。其他任务将由 UI 层直接与存储库层通信来完成。</p>

<p>这里需要一份书面规范。它不需要 UI 设计，但如果有的话，它无疑有助于可视化。</p>

<p>我们的列表如下：</p>

<h3>获取已发现行星的列表，该列表会自动更新</h3>

<p><strong>输入</strong>：无</p>

<p><strong>输出</strong>：Flow&lt;List<Planet>></p>

<p><strong>操作</strong>：从存储库请求当前已发现行星的列表，该列表必须以表单形式提供，以便在发生变更时及时通知我们。</p>

<h3>获取单个已发现行星的详细信息，该列表会自动更新</h3>

<p><strong>输入</strong>：String — 我们要获取的行星的 ID</p>

<p><strong>输出</strong>：Flow<Planet></p>

<p><strong>操作</strong>：从存储库请求具有指定 ID 的行星，并在发生变更时通知我们。</p>

<h3>添加/编辑新发现的行星</h3>

<p><strong>输入</strong>：</p>

<ul>
<li>planetId: String? — 如果非空，则为要编辑的行星的 ID。如果为空，则表示我们正在添加一颗新行星。</li>
<li>name：字符串 — 行星名称</li>
<li>distanceLy：浮点型 — 行星与地球的距离（光年）</li>
<li>discover：日期 — 发现日期</li>
</ul>


<p><strong>输出</strong>：无（完成即成功，无异常）</p>

<p><strong>操作</strong>：根据输入创建一个 Planet 对象，并将其传递给存储库（以添加到其数据源）</p>

<h3>添加一些示例行星</h3>

<p><strong>输入</strong>：无</p>

<p><strong>输出</strong>：无（出错时抛出）</p>

<p><strong>操作</strong>：请求存储库添加三颗示例行星，其发现日期为当前时间：Trenzalore（300 光年）、Skaro（0.5 光年）、Gallifrey（40 光年）。</p>

<h3>删除行星</h3>

<p><strong>输入</strong>：字符串 — 待删除行星的 ID</p>

<p><strong>输出</strong>：无（出错时抛出）</p>

<p><strong>操作</strong>：请求存储库删除具有指定 ID 的行星。</p>

<p>现在我们有了这个列表，我们就可以开始编写用例和存储库了。</p>

<h2>步骤 2：编写用例（Usec ases）</h2>

<p>从步骤 1 开始，我们得到了一个用户可以执行的任务列表。之前我们决定，在这些任务中，唯一要编写为用例的任​​务是“添加星球”。（我们决定只添加那些在应用的不同区域重复执行任务的用例）。</p>

<p>这样我们就有了一个可以在这里编写的用例：<strong>AddPlanetUseCase</strong>。</p>

<p>一个很棒的 Kotlin 技巧是将用例的逻辑放在 <code>operator fun invoke(…)</code> 函数中。这样就可以像调用函数一样调用代码来“调用”类实例，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span> <span class="p">=</span> <span class="err">…</span><span class="c1">//Use our instance as if it were a function:</span>
</span><span class='line'><span class="n">addPlanetUseCase</span><span class="p">(</span><span class="err">…</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是我们使用该技巧编写的 AddPlanetUseCase 代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddPlanetUseCase</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please specify a planet name&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a positive distance&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">discovered</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="n">Date</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a discovery date in the past&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的 PlanetsRepository 是一个接口，它列出了存储库将拥有的方法。稍后会详细介绍（特别是为什么我们要创建接口而不是类）。但现在我们先创建它，这样我们的代码就能编译了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>描述 Planet 的数据类型：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Planet</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">discovered</span><span class="p">:</span> <span class="n">Date</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>addPlanet 方法（类似于用例中的 invoke 函数）被声明为 <code>suspend</code>，因为我们知道它会涉及后台工作。稍后我们会向此接口添加更多方法，但目前这已经足够了。</p>

<p>顺便说一句，你可能会问，我们为什么要费心创建一个如此简单的用例？答案在于它可能会如何发展。未来它可能会变得更加复杂，而外部代码可以与这种复杂性隔离开来。</p>

<h2>步骤 2.1：测试用例</h2>

<p>我们现在已经编写了用例，但无法运行它。首先，它依赖于 <code>PlanetsRepository</code> 接口，而我们还没有它的实现。Hilt 不知道该如何处理它。</p>

<p>但我们可以编写测试，提供一个伪造的 <code>PlanetsRepository</code> 实例，并使用我们的测试框架运行它。这就是你现阶段应该做的事情。</p>

<p>由于这是一个关于架构的教程，测试的具体细节超出了范围，所以这一步留作练习。但请注意，良好的架构设计使我们能够将组件拆分成易于测试的部分。</p>

<h2>步骤 3：数据层，编写 PlanetsRepository</h2>

<p>请记住，存储库的作用是整理不同的数据源，管理它们之间的差异，并提供 CRUD 操作。</p>

<h3>使用依赖倒置和依赖注入</h3>

<p>根据整洁架构和依赖倒置原则（更多信息请参阅我的上一篇文章），我们希望避免外部代码依赖于存储库实现内部的代码。这样，用例或视图模型（例如）就不会受到存储库代码更改的影响。</p>

<p>这也解释了为什么我们之前将 PlanetsRepository 创建为接口（而不是类）。调用代码将仅依赖于接口，但它将通过依赖注入接收实现。现在我们将向接口添加更多方法，并创建它的实现，我们将其命名为 <strong>DefaultPlanetsRepository</strong>。</p>

<p>（补充：一些开发团队习惯将实现命名为 <code>&lt;接口名称&gt;Impl</code>；例如 <code>PlanetsRepositoryImpl</code>。我认为这种约定不利于代码可读性：类名应该能够说明实现接口的原因。所以我避免使用这种方式。但我还是提到了它，因为它的使用非常广泛。）</p>

<h3>使用 Kotlin Flows 实现数据可用</h3>

<p>如果你还没有接触过 <a href="https://developer.android.com/kotlin/flow">Kotlin Flows</a>，那就赶紧停下手头的工作，现在就去了解一下吧。它们将改变你的生活。</p>

<p>它们提供了一个数据“管道”，会随着新结果的出现而变化。只要调用者注册了该管道，他们就会在发生变更时收到更新。现在，我们的 UI 可以随着数据更新而自动更新，几乎无需任何额外操作。相比之下，过去我们必须手动向 UI 标记数据已更改。</p>

<p>其他解决方案，例如 RxJava 和 MutableLiveData，它们具有类似的功能，但它们不如 Flows 灵活易用。</p>

<h3>添加无处不在的 WorkResult 类</h3>

<p>WorkResult 类是数据层的常见返回值。它允许我们描述特定请求是否成功，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">WorkResult</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">exception</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用代码可以检查给定的 WorkResult 是“Success”、“Error”还是“Loading”对象（后者表示请求尚未完成），从而确定请求是否成功。</p>

<h3>我们的存储库接口</h3>

<p>让我们将以上所有内容结合起来，制定构成 PlanetsRepository 的方法和属性的规范。</p>

<p>它有两种获取行星的方法。第一个方法通过 ID 获取单个行星：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>第二个方法获取一个代表行星列表的 Flow：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这两个方法都是各自数据的唯一真实来源。每次我们都会返回存储在本地缓存中的数据，因为我们需要处理这些方法的频繁运行，而且本地数据比访问远程数据源更快、更便宜。但我们需要一个方法来刷新本地缓存。这将从远程数据源更新本地数据源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来我们需要添加、更新和删除行星的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以我们的界面现在看起来像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>边写边写数据源接口</h3>

<p>为了编写实现接口的类，我们需要关注数据源需要哪些方法。回想一下，我们有两个数据源：LocalDataSource 和 RemoteDataSource。我们还没有决定使用哪种第三方技术——而且现在也不需要。</p>

<p>现在让我们创建接口定义，以便我们边写边添加方法签名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.local</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.remote</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>准备好填充这些接口后，我们现在可以编写 DefaultPlanetsRepository 了。让我们逐一调用这些方法：</p>

<h3>编写 getPlanetFlow() 和 getPlanetsFlow()</h3>

<p>这两个方法都很简单；我们返回本地数据源中的数据。 （为什么不使用远程数据源？因为本地数据源的存在是为了快速、轻量地访问数据。远程数据源可能始终是最新的，但速度很慢。如果我们确实需要最新的数据，那么我们可以在调用 getPlanetsFlow() 之前使用下面的 refershPlanets()。）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以这依赖于 LocalDataSource 中的 getPlanetFlow() 和 getPlanetsFlow() 函数。我们现在将它们添加到接口中，以便代码能够编译。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>编写 refreshPlanets()</h3>

<p>要更新本地缓存，我们从远程数据源获取当前的行星列表，并将其保存到本地数据源。（然后，本地数据源可以“注意到”更改，并通过 getPlanetsFlow() 返回的 Flow 发出新的行星列表。）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">getPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这需要在每个数据源接口中创建一个新方法，现在如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意所有这些方法都被声明为“suspend fun”。这将线程和协程上下文的责任转交给调用者。</p>

<h3>编写 addPlanet() 和 deletePlanet()</h3>

<p>这两个函数都遵循相同的模式：对远程数据源执行写入操作，如果成功，则将更改镜像到本地缓存。</p>

<p>我们期望远程数据源在 Planet 对象写入数据库后为其分配一个唯一的 ID，因此 RemoteDataSource 的 addPlanet() 函数返回一个更新后的 Planet 对象，该对象具有非空的ID（NonNull ID）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetWithId</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planetWithId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>完成所有这些之后，最终的数据源接口如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">):</span> <span class="n">Planet</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们稍后会编写实现这些接口的代码，但现在，我们先来看看 UI。</p>

<h2>步骤 4：状态持有者，编写 PlanetsListViewModel</h2>

<p>回想一下，UI 层由 UI 元素和状态持有者层组成：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*Z0Px8K4iaChOzLPxDd9GPw.png" alt="UI层" /></p>

<p>目前我们还不知道要使用什么技术来绘制 UI，所以还不能编写 UI 元素层。但这没关系；我们可以继续编写状态持有者，而且一旦我们做出决定，它们就无需更改。这就是优秀架构的更多优势！</p>

<h3>编写 PlanetsListViewModel 的规范</h3>

<p>UI 将包含两个页面，一个用于列出和删除行星，另一个用于添加或编辑行星。PlanetsListViewModel 为前者提供支持。这意味着它需要将数据暴露给行星列表屏幕的 UI 元素，并且必须准备好在用户执行操作时接收来自 UI 元素的事件。</p>

<p>具体来说，我们的 PlanetsListViewModel 需要暴露：</p>

<ul>
<li>描述页面当前状态的 Flow（至关重要的是，它包含行星列表）</li>
<li>刷新列表的方法</li>
<li>删除行星的方法</li>
<li>添加示例行星的方法，帮助用户了解应用的功能</li>
</ul>


<h3>PlanetsListUiState 对象：页面的当前状态</h3>

<p>我发现将页面的整个状态包含在一个数据类中很有帮助：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">PlanetsListUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意，我已将其与视图模型定义在同一个文件中。它仅包含简单对象：没有 Flow 等，只有原始类型、数组和简单的数据类。另请注意，所有字段都有默认值——这将在后面帮助我们。</p>

<p>（有一些很好的理由让你甚至不希望 Planet 对象出现在上面的代码中。整洁架构的纯粹主义者会指出，在 Planet 的定义和使用之间，层级跳跃太多了。状态提升原则告诉我们，只提供我们需要的精确数据。例如，现在我们只需要 Planet 的名称和距离，所以我们应该只提供这些，而不是整个 Planet 对象。我个人认为这不必要地增加了代码的复杂性，并使未来的修改更加困难，但你可以不同意！）</p>

<p>定义好之后，我们现在可以在视图模型中创建一个状态变量来暴露它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.ui.planetslist</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetsListViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">planets</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">planets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">planets</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">initialValue</span> <span class="p">=</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>看看如何根据刚从存储库收到的不同类型的结果来创建“下一个”UI 状态？</p>

<p><code>.stateIn(…)</code> 的 <code>scope</code> 和 <code>started</code> 参数安全地限制了此 StateFlow 的生命周期。更多信息，请参阅 <a href="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3">Manual Vivo 的精彩文章</a>。</p>

<h3>添加示例行星</h3>

<p>为了添加这 3 个示例行星，我们反复调用为此创建的用例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">addSamplePlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Skaro&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">0.5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Trenzalore&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Galifrey&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">80F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">planets</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">addPlanetUseCase</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>刷新和删除</h3>

<p>刷新和删除函数的结构非常相似，只需调用相应的存储库函数即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">refreshPlanetsList</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 5：编写 AddEditPlanetViewModel</h2>

<p>AddEditPlanetViewModel 为用于添加新行星或编辑现有行星的屏幕提供支持。</p>

<p>正如我们之前所做的那样——事实上，这也是任何视图模型的良好实践——我们将为 UI 显示的所有内容定义一个数据类，并为其定义一个单一的数据源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">AddEditPlanetUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetName</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDistanceLy</span><span class="p">:</span> <span class="n">Float</span> <span class="p">=</span> <span class="m">1.0F</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDiscovered</span><span class="p">:</span> <span class="n">Date</span> <span class="p">=</span> <span class="n">Date</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isPlanetSaved</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">():</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们正在编辑一个星球（而不是添加一个新的星球），我们希望视图的初始状态代表该星球的当前状态。</p>

<p>按照良好实践，此屏幕只会传递我们正在编辑的星球的 ID。（我们不会传递整个 Planet 对象——这可能会变得太大太复杂）。Android 的 Lifecycle 组件为我们提供了一个 SavedStateHandle，我们可以从中获取星球 ID 并加载 Planet 对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">savedStateHandle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">[</span><span class="n">PlanetsDestinationsArgs</span><span class="p">.</span><span class="n">PLANET_ID_ARG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planetId</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!</span><span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">||</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">planet</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetName</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDiscovered</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">discovered</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意我们如何使用这种模式更新 UI 状态：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span> <span class="p">...</span> <span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>只需一行简单的代码，即可创建一个新的 AddEditPlanetUiState，其值从前一个复制而来，并通过 uiState Flow 将其发送出去。</p>

<p>以下是使用该技术更新行星各项属性的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">setPlanetName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetName</span> <span class="p">=</span> <span class="n">name</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">setPlanetDistanceLy</span><span class="p">(</span><span class="n">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">distanceLy</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，我们使用 AddPlanetUseCase 保存行星对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">savePlanet</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">addPlanetUseCase</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Planet</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">planetId</span> <span class="p">=</span> <span class="n">planetId</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">name</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetName</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">distanceLy</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDistanceLy</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">discovered</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDiscovered</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isPlanetSaved</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 6：编写数据源和 UI 元素</h2>

<p>现在我们已经完成了整个架构，可以编写最底层的代码了。也就是 UI 元素和数据源。对于 UI 元素，我们可以选择使用 Jetpack Compose 来支持手机和平板电脑。对于本地数据源，我们可以使用 Room DB 编写缓存；对于远程数据源，我们可以模拟访问远程 API。</p>

<p>这些层应该尽可能精简。例如，UI 元素代码不应包含任何计算或逻辑，而应仅包含获取视图模型给定状态并将其显示在屏幕上所需的代码。逻辑是为视图模型编写的。</p>

<p>对于数据源，只需编写实现 LocalDataSource 和 RemoteDataSource 接口中函数所需的最少代码即可。</p>

<p>具体的第三方技术（例如 Compose 和 Room）不在本教程的讨论范围内，但你可以在<a href="https://github.com/tdcolvin/PlanetSpotters">代码仓库</a> 中查看这些层的示例实现。</p>

<h3>将底层代码留到最后</h3>

<p>请注意，我们能够将应用程序的这些部分留到最后。这非常有益，因为它为利益相关者提供了充足的时间来决定使用哪些第三方技术以及应用程序的外观。即使在编写代码之后，我们也可以撤销这些决定，而不会影响应用程序的任何其他部分。</p>

<p>完整的代码库位于：<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>。</p>

<p>本教程有很多内容需要学习；祝贺你坚持到最后。希望本教程对你有所帮助。我没有徽章（更不用说文凭）可以颁发——但请随意（甚至鼓励）自己制作一个，并将结果发布在这里。</p>

<p>当然，如果你有任何问题或意见，或者你不同意某些观点（实际上<em>特别是</em>如果你不同意某些观点），请分享！请在此处留言，我会尽力回复所有人。</p>

<p>最后，我目前每周提供几节免费课程，帮助任何有 Android 开发或应用业务相关经验的人士。你可以在这里预约：<a href="https://calendly.com/tdcolvin/android-assistance">calendly.com/tdcolvin/android-assistance</a>。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alex Hilton</span></span>

      




<time class='entry-date' datetime='2025-10-13T23:05:25+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2025</span></span> <span class='time'>11:05 pm</span></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/architecture/'>architecture</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
  
    <!-- JiaThis Button BEGIN -->
<div class="jiathis_style_32x32">
	<a class="jiathis_button_qzone"></a>
	<a class="jiathis_button_tsina"></a>
	<a class="jiathis_button_tqq"></a>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_renren"></a>
	<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2025/10/11/how-to-architect-an-android-app/" title="Previous Post: 如何构建Android应用：深入探讨原则而非规则">&laquo; 如何构建Android应用：深入探讨原则而非规则</a>
      
      
        <a class="basic-alignment right" href="/blog/2025/10/14/non-blocking-splash/" title="Next Post: 突破速度障碍：非阻塞启动画面如何将Android 应用启动时间缩短90%">突破速度障碍：非阻塞启动画面如何将Android 应用启动时间缩短90% &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="comments"></div>
    <!-- Duoshuo COMMENT BEGIN -->
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script>
    var clientId = 'bc66a01ef24d14fc282b'
    var clientSecret = 'c7fd5e55db1776204fe201fe20c050b140982884'
    var gitment = new Gitment({
      id: 'toughcoder.net',
      owner: 'alexhilton',
      repo: 'alexhilton.github.io',
      oauth: {
        client_id: clientId,
        client_secret: clientSecret,
      },
    })

    gitment.render('comments')
</script>
<!-- Duoshuo COMMENT END -->

  </section>

</div>

<aside class="sidebar">
  
    <section>
    <div class="
        col-lg-2 col-lg-offset-0
        visible-lg-block
        sidebar-container
        catalog-container">
        <div class="side-catalog">
            <hr class="hidden-sm hidden-xs">
            <h3>
                <a class="catalog-toggle" href="#">CATALOG</a>
            </h3>
            <ul class="catalog-body"></ul>
        </div>
    </div>
</section>
<!-- Back to top and Scroll to bottom -->
<a href="#" class="cd-top"></a>
<a href="#" class="cd-bottom"></a>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - Alex Hilton -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<script type="text/javascript">
    //async load function 
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }

    function generateCatalog (selector) {
        var P = $('article'),a,n,t,l,i,c, id;
        a = P.find('h2,h3,h4,h5,h6');
        var index = 0;
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            id = $(this).prop('id');
            if (!id) {
                var nid = 'catalog-section-' + index;
                $(this).attr('id', nid);
                i = '#' + nid;
            } else {
                i = '#' + id;
            }
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
            index++;
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/javascripts/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });

// Navigation Scripts to Show Header on Scroll-Up
jQuery(document).ready(function($) {
    var MQL = 1170;

    //primary navigation slide-in effect
    if ($(window).width() > MQL) {
        // We do not have the sticky nav bar so, first can be zero
        var headerHeight = 0;
        $('nav').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $('header').each(function() {
            var h = $(this).outerHeight(true);
            headerHeight += h;
        });
        $(window).on('scroll', {
                previousTop: 0
            },
            function() {
                var currentTop = $(window).scrollTop(),
                    $catalog = $('.side-catalog');

                this.previousTop = currentTop;

                //adjust the appearance of side-catalog
                $catalog.show()
                if (currentTop > (headerHeight + 42)) {
                    $catalog.addClass('fixed')
                } else {
                    $catalog.removeClass('fixed')
                }
            });
    }
});
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3fab3b1bae08e6d4a5e638d9e8c6f40a";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>


</body>
</html>
