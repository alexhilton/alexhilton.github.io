<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[ç¨€æœ‰çŒ¿è¯‰]]></title>
  <link href="https://alexhilton.github.io/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2025-07-17T23:15:53+08:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[SnapshotFlowè¿˜æ˜¯collectAsStateï¼Ÿå¯¹äºJetpack Composeæ¥è¯´å“ªä¸ªæ›´é¦™ï¼Ÿ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"/>
    <updated>2025-07-16T22:31:22+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒSnapshotFlow or collectAsState? How to pick the right tool for Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123">https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123</a>ï¼Œç”±Dmitry Glazunovå‘å¸ƒäº2025å¹´7æœˆ7æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P0darOG2IeBIDWdY" title="auto auto" ></a></p>

<!-- more -->


<p>æ„å»º UI å¯èƒ½æ„Ÿè§‰å¾ˆç®€å•ï¼Œç›´åˆ°éœ€è¦è®¢é˜…çŠ¶æ€å˜åŒ–å¹¶æœ‰æ•ˆå¤„ç†å‰¯ä½œç”¨æ—¶ä¹‹å‰ã€‚è®¸å¤šå¼€å‘è€…è¿‡åº¦ä½¿ç”¨ collectAsStateï¼Œå¯¼è‡´å»¶è¿Ÿå’Œæ„å¤–çš„é‡ç»„ï¼ˆreCompositionï¼‰ã€‚è¿˜æœ‰ä¸€äº›äººå¬è¯´è¿‡ snapshotFlowï¼Œä½†å´ä¸å¤ªæ˜ç™½æ—¢ç„¶ StateFlow å’Œ collectAsState å·²ç»å­˜åœ¨ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å®ƒï¼Ÿ</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†é€šè¿‡æ¢ç´¢å®é™…é¡¹ç›®ä¸­ç®€çŸ­ä¸”å®ç”¨çš„ç¤ºä¾‹ï¼Œåˆ†äº«æˆ‘å¯¹ä½•æ—¶ä½¿ç”¨ snapshotFlow ä»¥åŠä½•æ—¶æ›´é€‚åˆä½¿ç”¨ collectAsState çš„çœ‹æ³•ï¼Œå¸®åŠ©ä½ é¿å…é¡¹ç›®ä¸­éšè—çš„ bug å’Œæ€§èƒ½é—®é¢˜ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>

<h2>collectAsState çš„ä½œç”¨</h2>

<p>collectAsState åœ¨ Compose ä¸­è®¢é˜… Flowï¼Œå¹¶è‡ªåŠ¨å°†å…¶å…¬å¼€ä¸ºStateï¼Œä»¥ä¾¿åœ¨ UI ä¸­è½»æ¾æ˜¾ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">uiState</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiStateFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸æ˜“äºä½¿ç”¨ã€‚</li>
<li>é‡ç»„æ—¶è‡ªåŠ¨å–æ¶ˆå¹¶é‡æ–°å¼€å§‹æ”¶é›†ã€‚</li>
<li>éå¸¸é€‚åˆ ViewModel â†’ UI æ•°æ®ç»‘å®šã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>æ¯æ¬¡å‘å‡ºæ–°æ•°æ®æ—¶éƒ½ä¼šè§¦å‘é‡ç»„ï¼Œå“ªæ€•åªæ˜¯å‘ç”Ÿäº†å¾®å°çš„å˜åŒ–ã€‚</li>
<li>å¯ç»„åˆé¡¹è¿›å…¥é‡ç»„çŠ¶æ€åç«‹å³å¼€å§‹æ”¶é›†ã€‚</li>
<li>ä¸é€‚ç”¨äºè§‚å¯Ÿ Compose ç‰¹æœ‰çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ»šåŠ¨æˆ–æ‰‹åŠ¿ã€‚</li>
</ul>


<h2>å¿«ç…§æµ (snapshotFlow) çš„ä½œç”¨</h2>

<p>å¿«ç…§æµ (snapshotFlow) å°† Compose çŠ¶æ€ï¼ˆä¾‹å¦‚ LazyListState ã€ derivedStateOf ï¼‰è½¬æ¢ä¸ºå†·æµ (cold Flow)ï¼Œè®©ä½ æ— éœ€è¿›è¡Œä¸å¿…è¦çš„é‡ç»„å³å¯å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">listState</span> <span class="p">=</span> <span class="n">rememberLazyListState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">listState</span><span class="p">.</span><span class="n">firstVisibleItemIndex</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">index</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">analytics</span><span class="p">.</span><span class="n">logScrollPosition</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸é€‚åˆ Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ã€‚</li>
<li>ä¸ä¼šè§¦å‘é‡ç»„ã€‚</li>
<li>å¯åœ¨ LaunchedEffect æˆ–åç¨‹ä¸­ä½¿ç”¨ã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>ä¸ä¼šå…¬å¼€çŠ¶æ€ä»¥è¿›è¡Œç›´æ¥ UI æ¸²æŸ“ã€‚</li>
<li>ä¸ä¼šæ›¿ä»£ CollectAsState æ¥å®ç° ViewModel â†’ UI æ›´æ–°ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ collectAsState</h2>

<ul>
<li>ä» ViewModel è®¢é˜… UI çš„ Flow æˆ– StateFlowã€‚</li>
<li>åœ¨ UI ä¸­æ˜¾ç¤ºæ•°æ®ï¼ˆæ–‡æœ¬ã€åŠ è½½çŠ¶æ€ã€è·å–çš„æ•°æ®ï¼‰ã€‚</li>
<li>ç”¨æˆ·éœ€è¦çœ‹åˆ°çš„ä½é¢‘æ›´æ–°ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>é«˜é¢‘æ›´æ–°ï¼ˆæ»šåŠ¨åç§»ã€ä¼ æ„Ÿå™¨æ•°æ®ï¼‰ã€‚</li>
<li>è§¦å‘ä¸éœ€è¦ UI æ›´æ–°çš„å‰¯ä½œç”¨ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ snaphotFlow</h2>

<ul>
<li>å“åº” Compose çŠ¶æ€ï¼ˆæ»šåŠ¨ã€æ‰‹åŠ¿ã€åŠ¨ç”»ï¼‰ã€‚</li>
<li>è§¦å‘å‰¯ä½œç”¨ä½†ä¸ä¼šå¯¼è‡´é‡ç»„ã€‚</li>
<li>ä» Compose çŠ¶æ€æ„å»º Flow ç®¡é“ï¼ˆåˆ†æã€å»¶è¿ŸåŠ è½½è§¦å‘å™¨ï¼‰ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>ç›´æ¥ UI æ•°æ®æ¸²æŸ“ã€‚</li>
<li>ç”¨ viewModel â†’ UI æµæ›¿æ¢ collectAsStateã€‚</li>
</ul>


<h2>snapshotFlow çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šä½¿ç”¨ snaphotFlow.collectAsState è¿›è¡ŒåŠ¨ç”»è¿›åº¦</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">progress</span> <span class="k">by</span> <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">animationState</span><span class="p">.</span><span class="n">progress</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Progress: ${(progress * 100).toInt()}%&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨ snaphotFlow å’Œ collectAsState æ¥é©±åŠ¨åŠ¨ç”»è¿›åº¦çš„ UI æ›´æ–°ä¼šå¯¼è‡´æ¯ä¸€å¸§éƒ½é‡æ–°åˆæˆï¼Œä»è€Œå¯¼è‡´å¡é¡¿ï¼Œè¿èƒŒäº† snaphotFlow çš„åˆè¡·ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ snaphotFlow åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¿›è¡Œåˆ†æ</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">animationState</span><span class="p">.</span><span class="n">progress</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span> <span class="p">{</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="p">(</span><span class="n">old</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span> <span class="p">==</span> <span class="p">(</span><span class="n">new</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">progress</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">analytics</span><span class="p">.</span><span class="n">logAnimationProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šè·Ÿè¸ªåŠ¨ç”»è¿›åº¦ï¼Œä»¥ä¾¿è¿›è¡Œåˆ†ææˆ–è®°å½•ï¼Œè€Œä¸ä¼šè§¦å‘ UI é‡æ„ã€‚</p>

<h2>collectAsState çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šå°† collectAsState ç”¨äºé«˜é¢‘æ»šåŠ¨æ•°æ®</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">scrollOffset</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">scrollOffsetFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Offset: $scrollOffset&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šåœ¨æ»šåŠ¨çš„æ¯ä¸ªåƒç´ ä¸Šè§¦å‘é‡æ–°åˆæˆï¼Œå¯¼è‡´ CPU è¿‡è½½ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ collectAsState è·å–æœ‰æ„ä¹‰çš„ UI æ•°æ®</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">userName</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">userNameFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hello, $userName!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é€‚ç”¨äºæ˜¾ç¤ºç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸”ä¸ç»å¸¸æ›´æ”¹çš„æ•°æ®ã€‚</p>

<h2>ç»“è®º</h2>

<p>collectAsState å’Œ snapshotFlow ç›¸è¾…ç›¸æˆï¼š</p>

<ul>
<li>ä½¿ç”¨ collectAsState åœ¨ UI ä¸­æ˜¾ç¤º ViewModel æ•°æ®ã€‚</li>
<li>ä½¿ç”¨ snapshotFlow å“åº” Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ï¼Œè€Œæ— éœ€è§¦å‘é‡ç»„ã€‚</li>
</ul>


<p>æ­£ç¡®ä½¿ç”¨å®ƒä»¬å°†å¸®åŠ©ä½ é¿å…ä¸å¿…è¦çš„é‡ç»„ï¼Œæå‡åº”ç”¨çš„å“åº”é€Ÿåº¦ï¼Œå¹¶ä¿æŒ Compose ä»£ç ç®€æ´ã€å¯æ‰©å±•ä¸”å¯é¢„æµ‹ã€‚</p>

<p>å¦‚æœä½ è§‰å¾—æœ¬æ–‡åˆ†ææœ‰ç”¨ï¼Œè¯·éšæ—¶å…³æ³¨æˆ‘ä»¥è·å–æ›´å¤šè§è§£ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä¸ºä»€ä¹ˆä½ çš„Appæ€»æ˜¯å¿˜è®°æ‰€æœ‰äº‹æƒ…]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting/"/>
    <updated>2025-07-11T23:20:20+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒWhy Your App Keeps Forgetting Everythingã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/mobile-app-development-publication/why-your-app-keeps-forgetting-everything-aa9ad8dd8f6b">https://medium.com/mobile-app-development-publication/why-your-app-keeps-forgetting-everything-aa9ad8dd8f6b</a>ï¼Œç”±Android Dev Nexuså‘å¸ƒäº2025å¹´6æœˆ13æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OqqSvUytY9D0D4EIX_Cn0A.png" title="auto auto" ></a></p>

<!-- more -->


<p>ä¸çŸ¥ä½ æœ‰æ²¡æœ‰å‘ç°äº†ä¸€ä¸ªè®©è®¸å¤š Android å¼€å‘è€…å›°æƒ‘çš„å…³é”®é—®é¢˜ï¼šViewModel å’Œ savedInstanceState è§£å†³çš„æ˜¯ä¸åŒçš„é—®é¢˜ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>è®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ä½ çš„æµ‹è¯•ä¸­ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆè¿™ä¸¤ç§æœºåˆ¶éƒ½å­˜åœ¨ã€‚</p>

<h2>Android ä¸­çš„ä¸¤ç§â€œæ­»äº¡â€ç±»å‹</h2>

<p>Android åº”ç”¨å¯ä»¥é€šè¿‡ä¸¤ç§æˆªç„¶ä¸åŒçš„æ–¹å¼â€œæ­»äº¡â€ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1-DtrKgBiEVyWj0RgbaNoQ.png" alt="" /></p>

<h3>1. é…ç½®å˜æ›´ï¼ˆå±å¹•æ—‹è½¬ç­‰ï¼‰</h3>

<ul>
<li>Activity/Fragmentï¼šæ­»äº¡å¹¶é‡å»º</li>
<li>ViewModelï¼šå¹¸å­˜ï¼ğŸ‰</li>
<li>savedInstanceStateï¼šä¹Ÿå¹¸å­˜ï¼Œä½†æ­¤æ—¶ä½ å¹¶ä¸éœ€è¦å®ƒ</li>
</ul>


<h3>2. è¿›ç¨‹æ­»äº¡ï¼ˆåº”ç”¨æœ€å°åŒ–ã€å†…å­˜ä¸è¶³ç­‰ï¼‰</h3>

<ul>
<li>Activity/Fragmentï¼šæ­»äº¡</li>
<li>ViewModelï¼šä¹Ÿæ­»äº¡ï¼ğŸ’€</li>
<li>savedInstanceStateï¼šå¹¸å­˜å¹¶æˆä¸ºä½ çš„ç”Ÿå‘½çº¿</li>
</ul>


<h2>æµ‹è¯•ç»“æœä¸æ’’è°</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¿›ç¨‹æ­»äº¡æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ:</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// æœ€å°åŒ–åº”ç”¨ç¨‹åºä¹‹å‰:</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span> <span class="p">=</span> <span class="s">&quot;Important data&quot;</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">42</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// é‡æ–°æ‰“å¼€åº”ç”¨ç¨‹åºå:</span>
</span><span class='line'><span class="c1">// - æ–°çš„ ViewModel å®ä¾‹å·²åˆ›å»ºï¼ˆæ—§æ•°æ®å·²æ¶ˆå¤±ï¼‰</span>
</span><span class='line'><span class="c1">// - ä½†æ˜¯ onCreate() æ¥æ”¶äº†å·²ä¿å­˜æ•°æ®çš„ savedInstanceState åŒ…</span>
</span><span class='line'><span class="c1">// - ä½ éœ€è¦æ‰‹åŠ¨ä» savedInstanceState æ¢å¤ ViewModel</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ çŒœæµ‹çš„å®Œå…¨æ­£ç¡®ï¼šViewModel éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥å­˜å‚¨/æ¢å¤æ•°æ®ï¼Œå³ä½¿è¿›ç¨‹ç»ˆæ­¢ã€‚</p>

<h2>å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼šä¸¤è€…ç»“åˆ</h2>

<p>ä»¥ä¸‹æ˜¯ç°ä»£ Android å¼€å‘å¤„ç†è¿™ä¸ªåŒå±‚ç³»ç»Ÿçš„æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">MyViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span> <span class="p">=</span> <span class="n">ViewModelProvider</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="n">MyViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æ­£åœ¨ä»è¿›ç¨‹æ­»äº¡ä¸­æ¢å¤</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">savedInstanceState</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ä» savedInstanceState æ¢å¤ ViewModel</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">userData</span> <span class="p">=</span> <span class="n">savedInstanceState</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">savedInstanceState</span><span class="p">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">viewModel</span><span class="p">.</span><span class="n">restoreFromSavedState</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// ä¿å­˜å…³é”®çš„ ViewModel æ•°æ®ä»¥é¿å…è¿›ç¨‹æ­»äº¡</span>
</span><span class='line'>        <span class="n">outState</span><span class="p">.</span><span class="n">putString</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">userData</span><span class="p">)</span>
</span><span class='line'>        <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">counter</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">isEmpty</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">userData</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">counter</span> <span class="p">==</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">restoreFromSavedState</span><span class="p">(</span><span class="n">userData</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">counter</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userData</span> <span class="p">=</span> <span class="n">userData</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">counter</span> <span class="p">=</span> <span class="n">counter</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å½“æ¯ä¸ªæœºåˆ¶ç”Ÿæ•ˆæ—¶</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dmQnYfNrJik_bbpuNT7bzQ.png" alt="" /></p>

<p>è®©æˆ‘æ¥å‘ä½ å±•ç¤ºä¸€ä¸‹ä¸åŒåœºæ™¯ä¸‹çš„å…·ä½“æƒ…å†µï¼š</p>

<h3>åœºæ™¯ 1ï¼šå±å¹•æ—‹è½¬</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before rotation:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>- savedInstanceState: Gets saved but not really needed
</span><span class='line'>
</span><span class='line'>After rotation:
</span><span class='line'>- ViewModel: Same instance, data intact âœ…
</span><span class='line'>- savedInstanceState: Available but redundant
</span><span class='line'>- Result: ViewModel data is immediately available
</span></code></pre></td></tr></table></div></figure>


<h3>åœºæ™¯2ï¼šåº”ç”¨ç¨‹åºæœ€å°åŒ–â†’é‡æ–°æ‰“å¼€ï¼ˆè¿›ç¨‹æ­»äº¡ï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before minimizing:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>- onSaveInstanceState<span class="o">()</span>: Saves critical data to Bundle
</span><span class='line'>After reopening:
</span><span class='line'>- ViewModel: NEW instance, no data âŒ
</span><span class='line'>- savedInstanceState: Contains saved data âœ…
</span><span class='line'>- Result: Must restore ViewModel from savedInstanceState
</span></code></pre></td></tr></table></div></figure>


<h3>åœºæ™¯ 3ï¼šåº”ç”¨ç¨‹åºæœ€å°åŒ– â†’ é‡æ–°æ‰“å¼€ï¼ˆè¿›ç¨‹å­˜æ´»ï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before minimizing:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>After reopening:
</span><span class='line'>- ViewModel: Same instance, data intact âœ…
</span><span class='line'>- savedInstanceState: null <span class="o">(</span>no recreation happened<span class="o">)</span>
</span><span class='line'>- Result: ViewModel data is immediately available
</span></code></pre></td></tr></table></div></figure>


<h2>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå­˜åœ¨è¿™ä¸ªåŒå±‚ç³»ç»Ÿï¼Ÿ</h2>

<p>ViewModel å¤„ç†å¸¸è§æƒ…å†µï¼š</p>

<ul>
<li>å¤æ‚çš„ UI çŠ¶æ€ï¼Œä½ ä¸å¸Œæœ›åœ¨é¢‘ç¹æ—‹è½¬å±å¹•æ—¶ä¸¢å¤±ã€‚</li>
<li>ä»»ä½•éœ€è¦è€—è´¹å¤§é‡èµ„æºé‡æ–°åˆ›å»ºçš„å†…å®¹ã€‚</li>
</ul>


<p>savedInstanceState å¤„ç†ç‰¹æ®Šæƒ…å†µï¼š</p>

<ul>
<li>è¿›ç¨‹æ­»äº¡éš¾ä»¥é¢„æµ‹ã€‚ä½†å½“å®ƒå‘ç”Ÿæ—¶ï¼Œç”¨æˆ·å¸Œæœ›å…¶çŠ¶æ€èƒ½å¤ŸæŒä¹…ä¿å­˜ã€‚</li>
<li>å°è€Œå…³é”®çš„æ•°æ®ç‰‡æ®µï¼ˆä¾‹å¦‚ç”¨æˆ·è¾“å…¥ã€æ»šåŠ¨ä½ç½®ï¼‰ã€‚</li>
<li>ç®€å•çš„ UI çŠ¶æ€ï¼Œå¯¹ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦ã€‚</li>
</ul>


<h2>Bundle å¤§å°çš„ç°å®æ£€éªŒ</h2>

<p>ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä»¥å¸®ä½ å…å»è°ƒè¯•éº»çƒ¦çš„äº‹æƒ…ï¼šBundle å¹¶éæ— é™å¤§çš„å­˜å‚¨ç©ºé—´ã€‚ä½ å¤§çº¦æœ‰ 1MB çš„ç©ºé—´å¯ç”¨ï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶ä¼šå¯¼è‡´
å´©æºƒï¼Œè®©ä½ è´¨ç–‘è‡ªå·±çš„äººç”Ÿé€‰æ‹©ã€‚</p>

<p>ä¿æŒ onSavedInstanceState æ•°æ®ç²¾ç®€ã€‚ä¿å­˜ç”¨æˆ·å†™åˆ°ä¸€åŠçš„ç”µå­é‚®ä»¶è‰ç¨¿ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè”ç³»äººåˆ—è¡¨ã€‚</p>

<h2>ç°ä»£æ–¹æ³•ï¼šSavedStateHandle</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ThuE7YpnrtfFQe2fwDlbDg.png" alt="" /></p>

<p>Google æ„è¯†åˆ°è¿™ç§æ‰‹åŠ¨æ“ä½œéå¸¸ç¹çï¼Œå› æ­¤ä»–ä»¬åˆ›å»ºäº† SavedStateHandle ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">savedStateHandle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è¿™å°†è‡ªåŠ¨ä¿ç•™é…ç½®æ›´æ”¹å’Œè¿›ç¨‹ç»ˆæ­¢ï¼</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;(</span><span class="s">&quot;user_data&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span><span class="p">:</span> <span class="n">Int</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;(</span><span class="s">&quot;counter&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// æ— éœ€æ‰‹åŠ¨æ¢å¤ï¼</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¯¹äºä»¥ä¸‹æƒ…å†µï¼Œä¸ºä»€ä¹ˆä»ç„¶éœ€è¦æ‰‹åŠ¨ onSaveInstanceStateï¼Ÿ</h2>

<h3>1. ä¸å±äº ViewModel çš„ UI ç‰¹å®šçŠ¶æ€</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// è¿™äº›ä¸å±äºä½ çš„ä¸šåŠ¡é€»è¾‘å±‚</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;scroll_position&quot;</span><span class="p">,</span> <span class="n">recyclerView</span><span class="p">.</span><span class="n">computeVerticalScrollOffset</span><span class="p">())</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putBoolean</span><span class="p">(</span><span class="s">&quot;is_toolbar_expanded&quot;</span><span class="p">,</span> <span class="n">collapsingToolbar</span><span class="p">.</span><span class="n">isExpanded</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putParcelable</span><span class="p">(</span><span class="s">&quot;dialog_state&quot;</span><span class="p">,</span> <span class="n">currentDialog</span><span class="o">?.</span><span class="n">onSaveInstanceState</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. Fragment å‚æ•°å’Œ Activity Extras</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¿™äº›éœ€è¦åœ¨è¿›ç¨‹ç»ˆæ­¢åç»§ç»­å­˜åœ¨ï¼Œä½†ä¸æ˜¯ ViewModel çŠ¶æ€</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DetailFragment</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">newInstance</span><span class="p">(</span><span class="n">itemId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">DetailFragment</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">arguments</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>  <span class="c1">// è¿™åœ¨å†…éƒ¨ä½¿ç”¨ savedInstanceState</span>
</span><span class='line'>                <span class="n">putString</span><span class="p">(</span><span class="s">&quot;item_id&quot;</span><span class="p">,</span> <span class="n">itemId</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. è§†å›¾çŠ¶æ€è¿‡äºç‰¹å®šäº UI</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¯¸å¦‚ EditText å…‰æ ‡ä½ç½®ã€ç„¦ç‚¹çŠ¶æ€ç­‰ã€‚</span>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;edit_text_selection_start&quot;</span><span class="p">,</span> <span class="n">editText</span><span class="p">.</span><span class="n">selectionStart</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;edit_text_selection_end&quot;</span><span class="p">,</span> <span class="n">editText</span><span class="p">.</span><span class="n">selectionEnd</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æŠŠæ‰‹å¼„è„ï¼ˆåŠ¨æ‰‹è¯•ä¸€è¯•ï¼‰</h2>

<p>ä½ å¯ä»¥å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹è¿›è¡Œæµ‹è¯•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Kill your app process </span>
</span><span class='line'>adb shell am <span class="nb">kill </span>com.yourpackage.name
</span><span class='line'><span class="c"># Or use &quot;Don&#39;t keep activities&quot; in Developer Options</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°†å¸®åŠ©ä½ éªŒè¯çŠ¶æ€æ¢å¤æ˜¯å¦æ­£ç¡®è¿›è¡Œã€‚</p>

<h2>å…³é”®æ´å¯Ÿ</h2>

<p>ViewModel éå¸¸é€‚åˆé…ç½®æ›´æ”¹ï¼Œä½†éœ€è¦å¸®åŠ©åº”å¯¹è¿›ç¨‹æ­»äº¡ã€‚</p>

<p>ç°ä»£æ–¹æ³•æ˜¯åœ¨ ViewModel ä¸­ä½¿ç”¨ SavedStateHandleï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å¤„ç†è¿™ä¸¤ç§æƒ…å†µã€‚å¦‚æœä½ å°šæœªä½¿ç”¨å®ƒï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ savedInstanceState â†’ ViewModel çš„æ¢å¤è¿‡ç¨‹ã€‚</p>

<p>è¿™ä¸ªåŒå±‚ç³»ç»Ÿçœ‹ä¼¼å¤æ‚ï¼Œä½†å®é™…ä¸Šéå¸¸ä¼˜é›…ï¼šå¸¸è§æƒ…å†µï¼ˆé…ç½®æ›´æ”¹ï¼‰çš„å¿«é€Ÿæ¢å¤ï¼Œä»¥åŠç½•è§æƒ…å†µï¼ˆè¿›ç¨‹æ­»äº¡ï¼‰çš„å¯é æ¢å¤ã€‚</p>

<p>ç¥ä½ ç¼–ç æ„‰å¿«ï¼Œæ„¿ä½ çš„çŠ¶æ€å§‹ç»ˆæŒä¹…ï¼ğŸš€</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç”¨ä¼˜é›…çš„å§¿å¼åº”å¯¹Kotlin Flowçš„å›å‹]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress/"/>
    <updated>2025-07-03T22:09:26+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒHow to Manage Backpressure in Kotlin Flow: collect â€¢ buffer â€¢ conflate â€¢ collectLatestã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/how-to-manage-backpressure-in-kotlin-flow-collect-buffer-conflate-collectlatest-b8102284d968">https://proandroiddev.com/how-to-manage-backpressure-in-kotlin-flow-collect-buffer-conflate-collectlatest-b8102284d968</a>ï¼Œç”±Shbazhenovå‘å¸ƒäº2025å¹´6æœˆ13æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress/"><img src="https://blog.mindorks.com/images/kotlin-flow-banner-image.png" title="auto auto" ></a></p>

<!-- more -->


<p>ä½ æ˜¯å¦æ›¾é‡åˆ°è¿‡å¿«é€Ÿæ•°æ®æºå‘é€çš„æ•°æ®é‡è¶…å‡ºåº”ç”¨å¤„ç†èƒ½åŠ›çš„æƒ…å†µï¼Œå¯¼è‡´åº”ç”¨é€Ÿåº¦å˜æ…¢ç”šè‡³å´©æºƒï¼ŸKotlin Flow å†…ç½®äº†ä¸€äº›æ–¹æ³•ï¼Œå¯è®©ä½ çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¿æŒåŒæ­¥ã€‚æœ¬æ–‡å°†ä»‹ç»ï¼š</p>

<ol>
<li>å›å‹çš„å«ä¹‰</li>
<li>Flow é»˜è®¤çš„â€œäº’ç›¸ç­‰å¾…â€æ¨¡å¼å¦‚ä½•å·¥ä½œ</li>
<li>ä½•æ—¶ä½¿ç”¨ buffer() æ·»åŠ å°å‹é˜Ÿåˆ—</li>
<li>conflate() å¦‚ä½•è·³è¿‡æ—§æ•°æ®é¡¹</li>
<li>ä¸ºä»€ä¹ˆ collectLatest { } ä¼šåœæ­¢æ—§æ•°æ®å¤„ç†</li>
<li>å¦‚ä½•æ ¹æ®ä½ çš„æƒ…å†µé€‰æ‹©åˆé€‚çš„é€‰é¡¹</li>
</ol>


<h2>å›å‹çš„å«ä¹‰</h2>

<p>å›å‹çš„ä½œç”¨æ˜¯ç¡®ä¿å¿«é€Ÿçš„æ•°æ®å‘é€æ–¹ä¸ä¼šå‹å®è¾ƒæ…¢çš„æ¥æ”¶æ–¹ã€‚å¦‚æœæ²¡æœ‰å›å‹ï¼Œä½ å¯èƒ½ä¼šåœ¨å†…å­˜ä¸­å­˜å‚¨è¿‡å¤šçš„æ•°æ®ï¼Œæˆ–è€…æµªè´¹æ—¶é—´å¤„ç†è¿‡æ—¶çš„ä¿¡æ¯ã€‚</p>

<p>å›å‹å¯ä»¥å¸®åŠ©ä½ ï¼š</p>

<ul>
<li>æ§åˆ¶å†…å­˜ä½¿ç”¨é‡</li>
<li>é¿å…ä¸å¿…è¦çš„å·¥ä½œ</li>
<li>ä½¿åº”ç”¨æ€§èƒ½æ›´å¯é¢„æµ‹</li>
</ul>


<h2>1. é»˜è®¤â€œäº’ç›¸ç­‰å¾…â€æ¨¡å¼</h2>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ æ‰§è¡Œä»¥ä¸‹æ“ä½œæ—¶ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">repeat</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">emit</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Sent $it&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>            <span class="c1">// å¿«é€Ÿçš„å‘é€è€…</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>  <span class="n">println</span><span class="p">(</span><span class="s">&quot;Handling $value&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>             <span class="c1">// æ…¢é€Ÿçš„å¤„ç†è€…</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‘é€æ–¹ ( emit ) å°†æš‚åœï¼Œç›´åˆ°å¤„ç†æ–¹ ( collect ) å¤„ç†å®Œæœ€åä¸€ä¸ªå€¼ã€‚æ²¡æœ‰é˜Ÿåˆ—ï¼Œæ¯ä¸ªå€¼éƒ½æ˜¯ä¸€æ¬¡å‘é€å’Œå¤„ç†ä¸€ä¸ªã€‚</p>

<h2>2. ä½¿ç”¨ buffer() æ·»åŠ ä¸€ä¸ªå°é˜Ÿåˆ—</h2>

<p>å¦‚æœä½ å¸Œæœ›å‘é€æ–¹æå‰ä¸€ç‚¹ï¼Œè¯·ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">capacity</span> <span class="p">=</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="c1">// slow work here</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ç°åœ¨ï¼Œå‘é€è€…æœ€å¤šå¯ä»¥å°† 2 ä¸ªé¡¹ç›®æ”¾å…¥ä¸€ä¸ªå°é˜Ÿåˆ—ä¸­ã€‚</li>
<li>ä¸€æ—¦é˜Ÿåˆ—æ»¡äº†ï¼Œå®ƒå°±ä¼šå†æ¬¡æš‚åœã€‚</li>
</ul>


<p>è¿™ç»™äº†ä½ ä¸€ä¸ªæœ‰é™çš„é˜Ÿåˆ—ï¼šä½ ä»ç„¶å¯ä»¥å¤„ç†æ¯ä¸ªé¡¹ç›®ï¼Œä½†å¯ä»¥å¹³æ»‘é€Ÿåº¦å³°å€¼ã€‚</p>

<h2>3. ä½¿ç”¨ conflate() è·³è¿‡æ—§é¡¹ç›®</h2>

<p>å½“ä½ åªå…³å¿ƒæœ€æ–°æ•°æ®ï¼ˆä¾‹å¦‚æ›´æ–°è¿›åº¦æ¡ï¼‰æ—¶ï¼Œä½ å¯ä»¥è¿™æ ·å†™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">conflate</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Update to $value&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>å¦‚æœå¤„ç†ç¨‹åºç¹å¿™ï¼Œåˆ™ä»…ä¿ç•™æœ€æ–°æœªå¤„ç†çš„é¡¹ç›®ã€‚</li>
<li>è¾ƒæ—§çš„é¡¹ç›®å°†è¢«ä¸¢å¼ƒï¼Œå› æ­¤ä½ æ— éœ€å¤„ç†è¿‡æ—¶çš„æ›´æ–°ã€‚</li>
</ul>


<p>æ³¨æ„ï¼šconflate() ä¸ä¼šåœæ­¢å½“å‰å·¥ä½œï¼›å®ƒåªæ˜¯åœ¨ä¸‹æ¬¡è¯»å–æ—¶è·³è¿‡æ—§å€¼ã€‚</p>

<h2>4. ä½¿ç”¨ collectLatest { } åœæ­¢æ—§å·¥ä½œ</h2>

<p>è¦è¿›ä¸€æ­¥æ“ä½œå¹¶åœ¨æ–°æ•°æ®è¿›å…¥æ—¶å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œè¯·ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collectLatest</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Start $value&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>    <span class="c1">// å¯èƒ½ä¼šè¢«åˆ‡æ–­</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Done $value&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>æ¯æ¬¡å‘å‡ºï¼ˆemitï¼‰æ–°çš„æ•°æ®æ—¶ï¼Œå¤„ç†å‰ä¸€ä¸ªå€¼çš„å—éƒ½ä¼šç«‹å³è¢«ä¸¢å¼ƒã€‚</li>
<li>åªæœ‰å½“å‘é€æ–¹çš„å‘é€é€Ÿåº¦æŒç»­è¶…å‡ºä½ çš„å¤„ç†èƒ½åŠ›æ—¶ï¼Œä½ æ‰éœ€è¦å®Œæˆæœ€åä¸€ä¸ªå€¼çš„å·¥ä½œã€‚</li>
</ul>


<p>è¿™éå¸¸é€‚åˆè¾¹è¾“å…¥è¾¹æœç´¢çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¸Œæœ›åœ¨ç”¨æˆ·å†æ¬¡è¾“å…¥æ—¶ç«‹å³ä¸¢å¼ƒæ—§è¯·æ±‚ã€‚</p>

<h2>5. é€‰æ‹©åˆé€‚çš„å·¥å…·</h2>

<h3>æ™®é€š collect</h3>

<ul>
<li>åŠŸèƒ½ï¼šå‘é€æ–¹å’Œå¤„ç†æ–¹äº’ç›¸ç­‰å¾…ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ å¿…é¡»æŒ‰é¡ºåºå¤„ç†æ¯ä¸ªé¡¹ç›®

<h3>.buffer(n)</h3></li>
<li>åŠŸèƒ½ï¼šå¤§å°ä¸º n çš„å°é˜Ÿåˆ—ï¼›ä¸ä¸¢å¼ƒä»»ä½•é¡¹ç›®</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ éœ€è¦å°‘é‡ç¼“å†²ï¼Œä½†ä»è¦å¤„ç†æ‰€æœ‰é¡¹ç›®

<h3>.conflate()</h3></li>
<li>åŠŸèƒ½ï¼šå¦‚æœå¤„ç†æ–¹ç¹å¿™ï¼Œåˆ™ä»…ä¿ç•™æœ€æ–°é¡¹ç›®</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ éœ€è¦æœ€æ–°æ•°æ®ï¼Œä½†ä»è¦å®Œæˆå½“å‰å·¥ä½œ

<h3>collectLatest { }</h3></li>
<li>åŠŸèƒ½ï¼šæ–°æ•°æ®åˆ°è¾¾åç«‹å³å–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šåªè€ƒè™‘æœ€æ–°çš„ç»“æœï¼›ç«‹å³æ”¾ä¸‹å…¶ä»–ä¸€åˆ‡

<h2>6. æ€»ç»“</h2></li>
<li>å›å‹æœºåˆ¶å¯é˜²æ­¢å¿«é€Ÿæ•°æ®æµè¿‡è½½æ…¢é€Ÿå¤„ç†å™¨ã€‚</li>
<li>é»˜è®¤æ¨¡å¼æ²¡æœ‰é˜Ÿåˆ—ï¼šå®‰å…¨ä½†é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ã€‚</li>
<li>buffer() å‡½æ•°æ·»åŠ äº†ä¸€ä¸ªå°é˜Ÿåˆ—ï¼šæ›´çµæ´»ï¼Œä¸ä¼šä¸¢åŒ…ã€‚</li>
<li>conflate() å‡½æ•°è·³è¿‡æ—§å€¼ï¼šå§‹ç»ˆä¿æŒæœ€æ–°ï¼Œä½†è®©å½“å‰å·¥ä½œå®Œæˆã€‚</li>
<li>collectLatest { } å‡½æ•°åœæ­¢æ—§å·¥ä½œï¼šä»…å®Œæˆæœ€æ–°é¡¹ã€‚</li>
</ul>


<p>ä¸‹æ¬¡ä½ çš„ Flow æ„Ÿè§‰å¤ªå¿«æˆ–å¤ªæ…¢æ—¶ï¼Œè¯·é—®è‡ªå·±ï¼š</p>

<ol>
<li>æˆ‘éœ€è¦å¤„ç†æ¯ä¸ªå€¼å—ï¼Ÿ</li>
<li>å°å‹é˜Ÿåˆ—æœ‰å¸®åŠ©å—ï¼Ÿ</li>
<li>åªæœ‰æœ€æ–°æ•°æ®æ‰é‡è¦å—ï¼Ÿ</li>
<li>å½“æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œæˆ‘åº”è¯¥å–æ¶ˆæ—§å·¥ä½œå—ï¼Ÿ</li>
</ol>


<p>é€‰æ‹©æœ€åˆé€‚çš„ç®€å•é€‰é¡¹ï¼ŒKotlin Flow ä¼šå¤„ç†ä½™ä¸‹çš„äº‹æƒ…ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Kotlin ViewModelä¸­æ­£ç¡®å¤„ç†ç›¸åŒçš„UIç»„ä»¶äº¤äº’]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/01/handling-ui-action/"/>
    <updated>2025-07-01T22:34:20+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/01/handling-ui-action</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒHandling UI Actions the Right Way in Kotlin ViewModelsã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/handling-ui-actions-the-right-way-in-kotlin-viewmodels-119a06bb43ef">https://proandroiddev.com/handling-ui-actions-the-right-way-in-kotlin-viewmodels-119a06bb43ef</a>ï¼Œç”±Vaibhav Jaiswalå‘å¸ƒäº2025å¹´4æœˆ16æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/01/handling-ui-action/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MLROq8NAKOSnutBMj3WivQ.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç¼˜èµ·</h2>

<p>ä½œä¸ºAndroidå¼€å‘è€…ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°éœ€è¦åœ¨å¤šä¸ªViewModelä¸­å®ç°ç›¸åŒæˆ–è€…éå¸¸ç±»ä¼¼UIåŠŸèƒ½çš„æƒ…å†µã€‚</p>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰å¤šä¸ªé¡µé¢ï¼Œå®ƒä»¬å…·æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æ˜¾ç¤ºå¸–å­ã€æ’°å†™è¯„è®ºæˆ–å¤„ç†ç”¨æˆ·äº¤äº’ã€‚</p>

<p>åœ¨æ¯ä¸ªViewModelä¸­åˆ†åˆ«å¤„ç†è¿™äº›UIäº¤äº’å¾ˆå¿«å°±ä¼šå˜å¾—æ··ä¹±ï¼Œå¯¼è‡´å¤§é‡çš„ä»£ç é‡å¤ã€‚éšç€åº”ç”¨è§„æ¨¡çš„æ‰©å¤§å’Œé¡µé¢æ•°é‡çš„å¢åŠ ï¼Œè¿™ä¸ªé—®é¢˜ä¼šå˜å¾—æ›´åŠ æ£˜æ‰‹ï¼Œå¯¼è‡´ä»£ç åº“éš¾ä»¥ç»´æŠ¤ï¼Œå¹¶å¸¦æ¥å¯æ‰©å±•æ€§é—®é¢˜ã€‚</p>

<p>å¯¹äºè¿™ç§ä»£ç é‡å¤é—®é¢˜ï¼Œæˆ‘ä»¬Androidå¼€å‘è€…å¸¸ç”¨çš„å‡ ç§å¸¸è§è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š</p>

<ul>
<li>é¢å¤–çš„è¾…åŠ©ç±»æ–¹æ³•</li>
<li>â€œç»§æ‰¿â€æˆ–â€œä½¿ç”¨å§”æ‰˜çš„ç»„åˆâ€æ–¹æ³•</li>
</ul>


<p>åœ¨ä»¥ä¸‹ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æ¢è®¨è¿™äº›è§£å†³æ–¹æ¡ˆï¼Œäº†è§£æ¯ç§æ–¹æ³•å¦‚ä½•è§£å†³ä»£ç é‡å¤é—®é¢˜ï¼Œå¹¶é‡ç‚¹ä»‹ç»æ¯ç§æ–¹æ³•çš„å±€é™æ€§ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒåŸºäºè¿™äº›æƒ³æ³•ï¼Œå¹¶è§£å†³äº†å®ƒä»¬çš„å±€é™æ€§ï¼Œä»è€Œå®ç°äº†æ›´é«˜æ•ˆçš„UIäº¤äº’ç®¡ç†ã€‚</p>

<blockquote><p>è¿™ä¸ªè§£å†³æ–¹æ¡ˆæˆ‘å·²ç»åœ¨<a href="https://medial.app/"> Medial çš„åº”ç”¨</a>ï¼ˆé“¾æ¥ <a href="https://medial.app/%EF%BC%89%E4%BB%A3%E7%A0%81%E5%BA%93%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E4%BA%86%E2%80%94%E2%80%94%E5%B0%86">https://medial.app/%EF%BC%89%E4%BB%A3%E7%A0%81%E5%BA%93%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E4%BA%86%E2%80%94%E2%80%94%E5%B0%86</a> UIäº¤äº’å¤„ç†ä»£ç å˜æˆäº†è¿‘ä¹å³æ’å³ç”¨çš„ä½“éªŒã€‚</p></blockquote>

<p>æˆ‘çš„è§£å†³æ–¹æ¡ˆæ ¹æœ¬ä¸å»ºè®®ä½¿ç”¨ BaseViewModelï¼Œä¹Ÿä¸åŸºäº BaseViewModelã€‚BaseViewModel åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œç”¨æ¥è¯´æ˜æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»ä»»ä½•å…¶ä»–ç±»/æ¥å£ç»§æ‰¿çš„åŠŸèƒ½ï¼Œè¿™äº›ç±»/æ¥å£å¯ä»¥æ˜¯ BaseViewModelã€ViewModelã€Decompose çš„ ComponentContext æˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚</p>

<h2>âš¡ï¸ TL;DR: å¤„ç†ViewModelä¸­çš„å…±äº«UIäº¤äº’</h2>

<p>å½“åœ¨å¤šä¸ªé¡µé¢ä¸Šæ˜¾ç¤ºç›¸åŒçš„UIç»„ä»¶æ—¶ï¼Œåœ¨æ¯ä¸ªViewModelä¸­å¤„ç†å®ƒä»¬çš„äº¤äº’ä¼šå¯¼è‡´é‡å¤å’Œé€»è¾‘æ··ä¹±ã€‚æˆ‘ä»¬æ¢ç´¢äº†ä¸‰ç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>è¾…åŠ©ç±»æ–¹æ³•</li>
<li>â– ç®€å•ï¼Œä½†æ— æ³•è¦†å†™ä»»ä½•è¡Œä¸º</li>
<li>â– å¹¶éViewModelçš„ç›´æ¥åŠŸèƒ½</li>
<li>é€šè¿‡ Kotlin å§”æ‰˜è¿›è¡Œç»„åˆ</li>
<li>âœ… æ›´å¥½çš„è®¾è®¡ï¼Œæ”¯æŒè¦†å†™è¡Œä¸ºã€‚</li>
<li>â– æ— æ³•è®¿é—®viewModelScopeæˆ–å…¶ä»–ViewModelåŠŸèƒ½ã€‚</li>
<li>â– æ— æ³•ä»ä»»ä½•å…¶ä»–ç»§æ‰¿ç±»è®¿é—®ä»»ä½•å†…å®¹ã€‚</li>
<li>ğŸ’¡ æˆ‘çš„è§£å†³æ–¹æ¡ˆ â€” ä½¿ç”¨å¸¦æœ‰é»˜è®¤å‡½æ•°çš„æ¥å£</li>
<li>âœ… ç®€æ´ã€å¯å¤ç”¨ï¼Œæ”¯æŒè¦†å†™ï¼ˆOverrideï¼‰è¡Œä¸ºã€‚</li>
<li>âœ… å®Œå…¨è®¿é—®ViewModelåŠŸèƒ½æˆ–ä»»ä½•å…¶ä»–ç»§æ‰¿ç±»çš„åŠŸèƒ½ã€‚</li>
<li>âœ… åªéœ€ä»æ¥å£å®ç°å³å¯è½»æ¾æ’å…¥ä»»ä½• ViewModel</li>
</ol>


<p>æœ¬åšå®¢ä¸­çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆå‡åœ¨<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample">æ­¤ç¤ºä¾‹é¡¹ç›®</a>ï¼ˆé“¾æ¥ <a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E5%AE%9E%E7%8E%B0%EF%BC%9A">https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E5%AE%9E%E7%8E%B0%EF%BC%9A</a></p>

<h2>ğŸ—ï¸ è®¾ç½®</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåç½®UI å…ƒç´ ï¼Œå®ƒæœ‰ä¸€äº›UI äº¤äº’ï¼Œå¹¶åƒ MVI å»ºè®®çš„é‚£æ ·ï¼Œåœ¨ä¸€ä¸ªå¯†å°çš„ç•Œé¢ä¸­å‘ˆç°ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PostAction</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ShareClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª BaseViewModel ç±»ï¼Œç”¨äºä¿å­˜æ¯ä¸ªViewModelæ‰€éœ€çš„é€šç”¨åŠŸèƒ½</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">showShackBar</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showBottomSheet</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">navigate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// å®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">showSnackbar</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">showSnackBar</span> <span class="p">=</span> <span class="n">message</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>é¢å¤–çš„è¾…åŠ©ç±»æ–¹æ³•</h3>

<p>åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¾…åŠ©ç±»æ¥å°è£…UIäº¤äº’çš„å¤„ç†ã€‚æˆ‘ä»¬å°†è¿™ä¸ªç±»ä½œä¸ºViewModelçš„ä¸€ä¸ªå±æ€§ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¾…åŠ©ç±» PostActionHandler æ¥å¤„ç†äº¤äº’ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostActionHandler</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">()</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackBar</span><span class="p">(</span><span class="s">&quot;Liked&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="cm">/* å®ç° */</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œåœ¨ PostScreenViewModel ä¸­æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª PostActionHandler å®ä¾‹</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostScreenViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">actionHandler</span> <span class="p">=</span> <span class="n">PostActionHandler</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostScreenViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">actionHandler</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span><span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è™½ç„¶è¿™ç§æ–¹æ³•ç¡®å®è§£å†³äº†è·¨å¤šä¸ªViewModelé‡å¤ä»£ç çš„é—®é¢˜ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›ä¸»è¦ç¼ºç‚¹ï¼Œè¿™äº›ç¼ºç‚¹åŒ…æ‹¬ï¼š</p>

<ul>
<li>ğŸš« è‡ªå®šä¹‰åŠŸèƒ½æœ‰é™ï¼šç”±äº PostActionHandler æ˜¯ä¸€ä¸ªå°è£…ç±»ï¼Œæˆ‘ä»¬æ— æ³•è¦†å†™ä»»ä½•è¡Œä¸ºã€‚</li>
<li>ğŸš« é€šè¿‡å±æ€§è®¿é—®ï¼šæˆ‘ä»¬ä¸æ˜¯å°†åŠŸèƒ½æ·»åŠ åˆ°ViewModelæœ¬èº«ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºViewModelçš„ä¸€ä¸ªå±æ€§æ·»åŠ ã€‚</li>
</ul>


<p><strong>æ— æ³•è¦†å†™ï¼ˆOverrideï¼‰è¡Œä¸ºæ˜¯è¿™ç§æ–¹æ³•ä¸å»ºè®®ç”¨äºUIäº¤äº’å¤„ç†çš„ä¸»è¦åŸå› ã€‚</strong></p>

<h2>ğŸ§¬ ä½¿ç”¨ Kotlin å§”æ‰˜è¿›è¡Œç»„åˆï¼ˆä¼˜é›…ä½†å—é™çš„è§£å†³æ–¹æ¡ˆï¼‰</h2>

<p>è¿™æ˜¯äº’è”ç½‘ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜çš„æ ‡å‡†æ–¹æ³•ï¼Œä¹Ÿæ˜¯æœ€å—æ¨èçš„æ–¹æ³•ã€‚è¯¥è§£å†³æ–¹æ¡ˆåŸºäºç»§æ‰¿ï¼Œä½†ä¸æ˜¯ç»§æ‰¿è‡ªæŸä¸ªç±»ï¼Œè¿™æ ·å°±æ— æ³•å†æ‰©å±•ä»»ä½•ç±»ã€‚æˆ‘ä»¬åˆ©ç”¨ Kotlin å§”æ‰˜å°†å®ç°å§”æ‰˜ç»™å¦ä¸€ä¸ªç±»ï¼Œè¿™æ ·å°±æ— éœ€æ‰©å±•æŸä¸ªç±»ï¼Œä¹Ÿæ— éœ€å†ç»ˆæ­¢ç»§æ‰¿ã€‚</p>

<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬å®ç°è¯¥è§£å†³æ–¹æ¡ˆçš„æ–¹æ³•</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PostActionHandlerImpl</span> <span class="p">:</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="n">handleShareClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±æ˜¯æˆ‘ä»¬çš„ä½¿ç”¨æ–¹æ³•</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span> <span class="k">by</span> <span class="n">PostActionHandlerImpl</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span><span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•è§£å†³äº†é¢å¤–è¾…åŠ©ç±»æ–¹æ³•ä¸­å­˜åœ¨çš„æ‰€æœ‰é—®é¢˜ã€‚</p>

<ul>
<li>âœ… è¦†å†™è¡Œä¸ºï¼šé€šè¿‡ä½¿ç”¨æ¥å£å’Œå§”æ‰˜ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¦†å†™ä»»ä½•è¡Œä¸ºã€‚</li>
<li>âœ… æ›´ç®€æ´çš„è®¾è®¡ï¼šåŠŸèƒ½ç›´æ¥æˆä¸ºViewModelçš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸æˆ‘ä»¬åƒè°ƒç”¨åŸç”ŸViewModelæ–¹æ³•ä¸€æ ·è°ƒç”¨è¿™äº›å‡½æ•°ã€‚</li>
</ul>


<p>ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªä¸»è¦ç¼ºç‚¹ï¼Œä½¿å…¶åœ¨å¤„ç†UIäº¤äº’å’ŒUIé€»è¾‘æ–¹é¢ä¸å¤Ÿå®Œå–„ã€‚</p>

<h3>è®¿é—®ä»å…¶ä»–ç±»ç»§æ‰¿çš„åŠŸèƒ½</h3>

<p>æ­¤æ¨¡å¼çš„ä¸€ä¸ªä¸»è¦æŒ‘æˆ˜æ˜¯æˆ‘ä»¬æ— æ³•è®¿é—®ä»å…¶ä»–ç±»ç»§æ‰¿çš„åŠŸèƒ½ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä¼ é€’å¼•ç”¨ã€‚</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªé™åˆ¶å¸¦æ¥äº†å“ªäº›æŒ‘æˆ˜ï¼š</p>

<ul>
<li>æ— æ³•è®¿é—®ViewModelåŠŸèƒ½ï¼šæˆ‘ä»¬æ— æ³•ä»å®ç°ç±»è®¿é—®ä»»ä½•ViewModelåŠŸèƒ½ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•åœ¨å®ç°ç±»ä¸­ä¼ é€’å½“å‰ç±»çš„å¼•ç”¨ã€‚</li>
<li>æ— æ³•ä½¿ç”¨ viewModelScopeï¼šæ­¤é™åˆ¶å¸¦æ¥çš„ä¸€ä¸ªä¸»è¦è­¦å‘Šæ˜¯ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨ viewModelScopeï¼Œå› æ­¤æ— æ³•ç›´æ¥å¯åŠ¨åç¨‹ã€‚æˆ‘ä»¬å¿…é¡»åœ¨ viewModel ä¸­åˆ›å»ºåŒ…è£…å‡½æ•°ï¼Œè¿™ä¼šç ´åå¯é‡ç”¨æ€§ï¼Œå› ä¸ºç°åœ¨å¯ç»„åˆå‡½æ•°ä¼šè°ƒç”¨æˆ‘ä»¬çš„ViewModelå‡½æ•°ã€‚</li>
</ul>


<p>å½“æˆ‘ä»¬å°è¯•å°†å…¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼ŒAndroid Studio ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xcJAyapM8023-hqu06vwUw.png" alt="Kotlin Compiler showing error when passing â€œthisâ€" /></p>

<h2>ğŸ§© æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ¥å£é»˜è®¤å‡½æ•°è¿›è¡Œç»„åˆ</h2>

<p>åœ¨æˆ‘è‡ªå·±å®ç°ä½¿ç”¨å§”æ‰˜çš„ Composition æ–¹æ¡ˆæ—¶ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªéš¾é¢˜ï¼šå¦‚ä½•ä¼ é€’å½“å‰ViewModelçš„å¼•ç”¨æ¥è®¿é—®viewModelScope å’Œæˆ‘çš„ BaseViewModel åŠŸèƒ½ã€‚åæ¥æˆ‘æƒ³èµ·äº† Kotlin æ¥å£ä¸­çš„é»˜è®¤å‡½æ•°ï¼Œäºæ˜¯å°è¯•äº†è¿™ä¸ªæ–¹æ¡ˆï¼Œå®Œç¾åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥ï¼š</p>

<ul>
<li>ğŸ’¡ æ”¯æŒåŠŸèƒ½é‡å†™</li>
<li>ğŸ”— å®Œå…¨è®¿é—®æˆ‘çš„BaseViewModelå’ŒViewModel çš„åŠŸèƒ½ï¼Œä¾‹å¦‚viewModelScope ç­‰ï¼Œæˆ–ä»»ä½•å…¶ä»–ç±»çš„åŠŸèƒ½ã€‚</li>
<li>âŒ æ— éœ€å•ç‹¬çš„å®ç°ç±»</li>
</ul>


<blockquote><p>åœ¨æˆ‘ä»¬<a href="https://medial.app/"> Medial çš„åº”ç”¨</a>ï¼ˆé“¾æ¥ <a href="https://medial.app/%EF%BC%89%E7%94%9F%E4%BA%A7%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8C%E6%88%91%E9%9B%86%E6%88%90%E4%BA%86%E8%BF%99%E4%B8%AA%E6%96%B9%E6%A1%88%EF%BC%8C%E4%BB%A5%E7%AE%80%E5%8C%96ViewModel%E5%A4%84%E7%90%86UI%E4%BA%A4%E4%BA%92%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82%E7%BB%93%E6%9E%9C%E5%A6%82%E4%BD%95%EF%BC%9F%E6%AF%8F%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%E5%8F%AA%E9%9C%80%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%8C%E5%AE%83%E5%B0%B1%E5%B9%B2%E5%87%80%E5%88%A9%E8%90%BD%E5%9C%B0%E8%8E%B7%E5%BE%97%E4%BA%86%E5%8A%9F%E8%83%BD%E3%80%82">https://medial.app/%EF%BC%89%E7%94%9F%E4%BA%A7%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8C%E6%88%91%E9%9B%86%E6%88%90%E4%BA%86%E8%BF%99%E4%B8%AA%E6%96%B9%E6%A1%88%EF%BC%8C%E4%BB%A5%E7%AE%80%E5%8C%96ViewModel%E5%A4%84%E7%90%86UI%E4%BA%A4%E4%BA%92%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82%E7%BB%93%E6%9E%9C%E5%A6%82%E4%BD%95%EF%BC%9F%E6%AF%8F%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%E5%8F%AA%E9%9C%80%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%8C%E5%AE%83%E5%B0%B1%E5%B9%B2%E5%87%80%E5%88%A9%E8%90%BD%E5%9C%B0%E8%8E%B7%E5%BE%97%E4%BA%86%E5%8A%9F%E8%83%BD%E3%80%82</a></p></blockquote>

<p>è®©æˆ‘ä»¬æ¥æ¢ç´¢ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦‚ä½•è§£å†³æˆ‘ä»¬çš„é—®é¢˜çš„ã€‚</p>

<h3>è®¾è®¡ ActionHandler æ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="n">handleShareClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">showToast</span><span class="p">(</span><span class="s">&quot;Liked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// å®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è®©æˆ‘ä»¬çš„ViewModelå®ç°è¿™ä¸ªæ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ä¼ å…¥å½“å‰çš„baseViewModel</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">valViewModel</span><span class="p">=</span> <span class="k">this</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// æ·»åŠ  overrideå®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è¿™æ˜¯å®ƒåœ¨ Composable ä¸­çš„ä½¿ç”¨æ–¹å¼</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span>
</span><span class='line'>    <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ‰€ä»¥ï¼Œæ­£å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ viewModel å˜é‡ï¼Œå°±å¤§åŠŸå‘Šæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ViewModelå’Œ BaseViewModel æä¾›çš„æ‰€æœ‰åŠŸèƒ½äº†ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•è§£å†³ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆçš„ä¸»è¦ç¼ºç‚¹çš„ï¼š</p>

<ul>
<li>é€šè¿‡å°† viewModel å¼•ç”¨ä¿ç•™ä¸ºæ¥å£å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨ViewModelä¸­å®šä¹‰å®ƒã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥è®¿é—® BaseViewModel æˆ–ä»»ä½•å…¶ä»–ViewModelæä¾›çš„æ‰€æœ‰åŠŸèƒ½ã€‚</li>
<li>æˆ‘ä»¬ç®€åŒ–äº† viewModelScope çš„ä½¿ç”¨ã€‚ç°åœ¨ï¼Œå¯åŠ¨åç¨‹ã€æ”¶é›†æµç¨‹ä»¥åŠæ‰§è¡Œå…¶ä»–ä»»åŠ¡éƒ½å˜å¾—éå¸¸ç®€å•ï¼Œæ— éœ€ä»»ä½•å¤æ‚çš„å˜é€šæ–¹æ³•æˆ– hackã€‚è¿™å°±æ˜¯æ­¤è§£å†³æ–¹æ¡ˆå¸¦æ¥çš„ä¼˜é›…å’Œç®€æ´ä¹‹å¤„ã€‚</li>
</ul>


<p>è¿™ç§æ–¹æ³•åªæœ‰ä¸€ä¸ªå°ç¼ºç‚¹ï¼Œé‚£å°±æ˜¯</p>

<ul>
<li>æˆ‘ä»¬å¿…é¡»åœ¨ViewModelä¸­å®šä¹‰æ‰€æœ‰æ¥å£å±æ€§ï¼Œè¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦ä¼šå¼•ç”¨ Repository æˆ– Domain Layer ç±»ï¼Œä»¥åŠä¸€äº›å¯å˜çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</li>
</ul>


<p>è¿™ä¸ªé—®é¢˜æ¯”æˆ‘ä»¬åœ¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸­å…‹æœçš„ç¼ºç‚¹è¦å°å¾—å¤šï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºå¤„ç†ä»»ä½•å…±äº«UIäº¤äº’æˆ–ä»»ä½•å…±äº«UIä¸šåŠ¡é€»è¾‘çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚</p>

<blockquote><p>å—¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ¯”å‰é¢å‡ éƒ¨åˆ†ç®€å•å¾—å¤šã€‚è¿™é‡Œæ²¡æœ‰å¤æ‚çš„é—®é¢˜éœ€è¦æ·±å…¥ç ”ç©¶â€”â€”åªæ˜¯ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒç¡®å®åšåˆ°äº†å®ƒåº”è¯¥åšçš„äº‹æƒ…ï¼Œå¹¶è§£å†³äº†æˆ‘ä»¬æ‰€æœ‰çš„é—®é¢˜ã€‚</p></blockquote>

<h2>ğŸ¥·ğŸ» è®©æˆ‘ä»¬åœ¨å®é™…ç”¨ä¾‹ä¸­çœ‹çœ‹è¿™ä¸ªè§£å†³æ–¹æ¡ˆçš„å®é™…åº”ç”¨ã€‚</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»é¡µé¢ï¼Œå®ƒä»¥åˆ—è¡¨å½¢å¼æ˜¾ç¤ºå„ç§UIå…ƒç´ ï¼Œä¾‹å¦‚åŒ…å«å¸–å­å’Œæ–°é—»ç­‰é¡¹ç›®çš„åŠ¨æ€ã€‚æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ç»„ç”¨æˆ·äº¤äº’ï¼Œä¾‹å¦‚ç‚¹èµå¸–å­ã€åˆ†äº«æ–°é—»æ–‡ç« æˆ–å¯¼èˆªåˆ°è¯¦æƒ…è§†å›¾ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå¯ä»¥å¸®åŠ©æˆ‘ä»¬é«˜æ•ˆåœ°å¤„ç†è·¨ä¸åŒViewModelçš„è¿™äº›äº¤äº’ï¼Œç¡®ä¿ä»¥å¯æ‰©å±•çš„æ–¹å¼å¤„ç†é€šç”¨åŠŸèƒ½ã€‚</p>

<h3>ä¸ºæ¯ä¸ªUIç»„ä»¶è®¾è®¡UIäº¤äº’</h3>

<p>ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ Kotlin çš„ Sealed æ¥å£ï¼Œåƒåœ¨å…¸å‹çš„ MVI æ¶æ„ä¸­ä¸€æ ·è®¾è®¡UIäº¤äº’ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PostAction</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ShareClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">NewsAction</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">BookmarkClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>åˆ›å»ºæˆ‘ä»¬çš„åŠ¨ä½œå¤„ç†ç¨‹åºæ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">postRepo</span><span class="p">:</span> <span class="n">PostRepository</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>          <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">(......)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">postRepo</span><span class="p">.</span><span class="n">like</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span><span class="s">&quot;Post Liked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">NewsActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">newsRepo</span><span class="p">:</span> <span class="n">NewsRepository</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">NewsAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">NewsAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handleNewsClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">NewsAction</span><span class="p">.</span><span class="n">Bookmark</span> <span class="p">-&gt;</span> <span class="n">handleNewsBookmark</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleNewsClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">(.....)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleNewsBookmark</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">newsRepo</span><span class="p">.</span><span class="n">bookmark</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackBar</span><span class="p">(</span><span class="s">&quot;News Bookmarked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæ•°æ®æ¨¡å‹åˆ›å»ºäº†ä¸€ä¸ª Action Handler æ¥å£ã€‚</p>

<p>æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„å°±æ˜¯éµå¾ªä¸Šä¸€èŠ‚æ‰€ç¤ºçš„æ¥å£è®¾è®¡ã€‚</p>

<ul>
<li>æˆ‘ä»¬æœ‰ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯ViewModelå’ŒRepository ç±»ã€‚</li>
<li>æˆ‘ä»¬åˆ†åˆ«åˆ›å»ºäº†å¤„ç†æ¯ä¸ª Action çš„å‡½æ•°ã€‚å½“ç„¶ï¼Œè¿™æ˜¯å¯é€‰çš„ã€‚æˆ‘ä¿ç•™è¿™ç§æ–¹å¼æ˜¯ä¸ºäº†æ–¹ä¾¿è¦†å†™ä»»ä½•ç‰¹å®šçš„è¡Œä¸ºï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸ºæ¯ä¸ª Action ç±»å‹åˆ†åˆ«è°ƒç”¨ç›¸åº”çš„ Action å¤„ç†å‡½æ•°ã€‚</li>
</ul>


<h3>åˆ›å»º ViewModel</h3>

<p>è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªå®ç°è¿™ä¸¤ä¸ªæ¥å£çš„ ViewModelï¼Œä»¥ç»§æ‰¿å®ƒä»¬çš„åŠŸèƒ½ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">HomeViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span><span class="p">,</span> <span class="n">NewsActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="k">this</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">postRepo</span> <span class="p">=</span> <span class="n">PostRepository</span><span class="p">()</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">newsRepo</span> <span class="p">=</span> <span class="n">NewsRepository</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">      ViewModelå…¶ä½™ä»£ç </span>
</span><span class='line'><span class="cm">    **/</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œæˆ‘ä»¬åœ¨ViewModelä¸­å®šä¹‰å¿…è¦çš„å±æ€§ï¼ˆ viewModel ã€ postRepo å’Œ newsRepo ï¼‰ï¼Œè¿™äº›å±æ€§ä¼šè¢«ä¸¤ä¸ªæ¥å£ä½¿ç”¨ã€‚</p>

<p>è¿™ç§è®¾è®¡æ¶ˆé™¤äº†å†—ä½™ï¼Œå¹¶ä¿æŒäº†ä»£ç çš„ç®€æ´æ€§ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è®¾ç½®ä¸€æ¬¡å±æ€§ï¼Œåªè¦å±æ€§åç§°ç›¸åŒï¼Œä¸¤ä¸ªæ¥å£å°±å¯ä»¥æ— ç¼åœ°ä¸å…¶äº¤äº’ã€‚
è¿™ç§æ–¹æ³•ä¿æŒäº†ViewModelçš„ä¸­å¿ƒåœ°ä½ï¼ŒåŒæ—¶åˆå¯ä»¥è½»æ¾å¤„ç†ä¸åŒç»„ä»¶çš„UIäº¤äº’å’Œä¸šåŠ¡é€»è¾‘ã€‚</p>

<h2>ğŸªè¿æ¥ä¸€åˆ‡ï¼šå°†æ“ä½œè¿æ¥åˆ° UI</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">HomeViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LazyColumn</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">items</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">items</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">when</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">News</span> <span class="p">-&gt;</span> <span class="n">NewsCard</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">Post</span> <span class="p">-&gt;</span> <span class="n">PostCard</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">NewsCard</span><span class="p">(</span>
</span><span class='line'>  <span class="n">news</span><span class="p">:</span> <span class="n">News</span><span class="p">,</span>
</span><span class='line'>  <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">NewsAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostCard</span><span class="p">(</span>
</span><span class='line'>  <span class="n">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">,</span>
</span><span class='line'>  <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨æˆ‘ä»¬çš„UIç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¿™äº›å‡½æ•°ç”¨ä½œViewModelæœ¬èº«çš„å‡½æ•°ï¼Œè¿™æ ·å°±å®Œæˆäº†åœ¨ Screen ä¸­æ·»åŠ äº¤äº’å¤„ç†çš„åŠŸèƒ½ã€‚</p>

<ul>
<li>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦ä¸€ä¸ªåªæ˜¾ç¤ºæ–°é—»çš„é¡µé¢ï¼ˆScreenï¼‰ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨ViewModelä¸­å®ç° NewsActionHandler æ¥å£â€”â€”å°±è¿™æ ·ï¼Œä¸€åˆ‡å°±ç»ªã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥æ— ç¼åœ°ä» BaseViewModel æˆ–ViewModelè°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œä»è€Œèƒ½å¤Ÿåœ¨ä¸€ä¸ªå•ä¸€çš„ã€é›†ä¸­çš„ä½ç½®å®ç°å®Œæ•´çš„ç«¯åˆ°ç«¯åŠŸèƒ½ã€‚å¦‚æœæˆ‘ä»¬åœ¨å¤šä¸ªä½ç½®æ˜¾ç¤ºç›¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œè¿™å°†éå¸¸æœ‰åˆ©ã€‚</li>
</ul>


<h2>ğŸ“¦ æ•´åˆæ‰€æœ‰åŠŸèƒ½</h2>

<p>åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†åœ¨æ‰©å±•Android UIï¼ˆåŸºæœ¬ä¸Šæ˜¯ä»»ä½• UIï¼‰æ—¶æœ€å®¹æ˜“è¢«å¿½è§†çš„é—®é¢˜ä¹‹ä¸€ï¼Œå³è·¨ViewModelçš„é‡å¤UIäº¤äº’é€»è¾‘ã€‚æˆ‘ä»¬æ¢ç´¢äº†ä¸‰ç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>è¾…åŠ©ç±» - ä¸€ç§å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼Œä½†å­˜åœ¨ä¸¥æ ¼çš„é™åˆ¶ã€‚</li>
<li>ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆâ€”â€”ä¸€ç§æ›´ç°ä»£çš„ç»§æ‰¿é©±åŠ¨è§£å†³æ–¹æ¡ˆï¼Œ
ä½†å®ƒéš¾ä»¥ä»å¤–éƒ¨è®¿é—®åŠŸèƒ½ã€‚</li>
<li>ä½¿ç”¨é»˜è®¤å‡½æ•°çš„æ¥å£ï¼ˆæˆ‘çš„è§£å†³æ–¹æ¡ˆï¼‰â€”â€”ä¸€ç§å®ç”¨ã€ä¼˜é›…ä¸”çµæ´»çš„æ–¹æ³•ï¼Œå…‹æœäº†å‰ä¸¤ç§æ–¹æ³•çš„æ‰€æœ‰é™åˆ¶ã€‚</li>
</ol>


<p>é€šè¿‡åˆ©ç”¨ Kotlin çš„æ¥å£é»˜è®¤æ–¹æ³•å¹¶å°†ViewModelä½œä¸ºæ¥å£å†…éƒ¨çš„å±æ€§ï¼Œæˆ‘ä»¬è§£é”äº†å®Œæ•´çš„å¯æ‰©å±•æ€§ï¼Œå¹¶èƒ½å¤Ÿä»å…¶ä»–ç»§æ‰¿çš„ç±»/æ¥å£è®¿é—®æ‰©å±•åŠŸèƒ½ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥è¡¨æ ¼çš„å½¢å¼æ¯”è¾ƒä¸€ä¸‹æ¯ä¸ªè§£å†³æ–¹æ¡ˆï¼š</p>

<table>
<thead>
<tr>
<th> å¥½å¤„                           </th>
<th> é€šè¿‡è¾…åŠ©ç±»                                       </th>
<th> ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆ                             </th>
<th> å¸¦æœ‰é»˜è®¤å‡½æ•°çš„æ¥å£ (âœ… æœ€å¥½)         </th>
</tr>
</thead>
<tbody>
<tr>
<td> ğŸ” å¯é‡ç”¨æ€§                                 </td>
<td>  âœ… Yes        </td>
<td>  âœ… Yes         </td>
<td>  âœ… Yes </td>
</tr>
<tr>
<td> ğŸ§  è¦†å†™è¡Œä¸º                        </td>
<td> âŒ ä¸å¯èƒ½          </td>
<td> âœ… å¯ä»¥ï¼Œç”±äºç»§æ‰¿        </td>
<td> âœ…  å¯ä»¥ï¼Œç”±äºç»§æ‰¿           </td>
</tr>
<tr>
<td> ğŸ”— è®¿é—®ä»å…¶ä»–æ¥æºç»§æ‰¿çš„åŠŸèƒ½                 </td>
<td> âŒ ä¸å¯ä»¥ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå°è£…ç±»      </td>
<td> âŒ  ä¸å¯ä»¥ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä¼ é€’å½“å‰å¼•ç”¨       </td>
<td> âœ…  å¯ä»¥ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å°†ç»§æ‰¿ç±»ä¿ç•™ä¸ºæ¥å£å±æ€§    </td>
</tr>
<tr>
<td> ğŸ—ï¸ è·¨é¡µé¢å¯æ‰©å±•æ€§                  </td>
<td> âš ï¸ å·®â€”â€”å½“é€»è¾‘è¿˜æ¶‰åŠè§†å›¾æ¨¡å‹ç‰¹å®šåŠŸèƒ½æ—¶ä¼šå˜å¾—å›°éš¾               </td>
<td> âœ… æ›´å¥½â€”â€”å¯é‡å¤ä½¿ç”¨çš„é€»è¾‘                    </td>
<td> âœ… æœ€ä½³â€”â€”è·¨é¡µé¢å³æ’å³ç”¨            </td>
</tr>
<tr>
<td> âœ… æœ€ä½³ç”¨ä¾‹                               </td>
<td> å¯¹äºéUIäº¤äº’å°è£…åŠŸèƒ½                   </td>
<td> ä¸šåŠ¡é€»è¾‘é‡ç”¨ï¼ŒéUIä¸Šä¸‹æ–‡            </td>
<td> å¤šä¸ªViewModelä¸­éœ€è¦çš„UIäº¤äº’ </td>
</tr>
</tbody>
</table>


<p>ä½ å¯ä»¥åœ¨<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample">ä¸“ç”¨çš„ GitHub ä»£ç åº“</a>ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E6%8E%A2%E7%B4%A2%E6%9C%AC%E5%8D%9A%E5%AE%A2%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82%E6%AC%A2%E8%BF%8E%E9%9A%8F%E6%84%8Fclone%E3%80%81fork%E6%88%96%E8%AF%95%E7%94%A8%E3%80%82">https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E6%8E%A2%E7%B4%A2%E6%9C%AC%E5%8D%9A%E5%AE%A2%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82%E6%AC%A2%E8%BF%8E%E9%9A%8F%E6%84%8Fclone%E3%80%81fork%E6%88%96%E8%AF%95%E7%94%A8%E3%80%82</a></p>

<h2>âœŒï¸ å‘Šåˆ«</h2>

<p>æ€»è€Œè¨€ä¹‹ï¼Œå¸Œæœ›è¿™ç¯‡åšå®¢èƒ½å¸®åŠ©ä½ è§£é”ä¸€äº›å¼ºå¤§çš„æŠ€å·§ï¼Œæå‡ä½ çš„Kotlin å’ŒUIå¤„ç†çŸ¥è¯†ã€‚æœ‰äº†Kotlin çš„ç•Œé¢é»˜è®¤å‡½æ•°ï¼Œä½ çš„æ„å»ºå°†æ›´åŠ ç®€æ´ã€å¿«é€Ÿï¼Œå¹¶å…¼é¡¾é•¿æœŸå¯æ‰©å±•æ€§ã€‚</p>

<p>å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« å¹¶æƒ³éšæ—¶äº†è§£æœ€æ–°åŠ¨æ€ï¼š</p>

<ul>
<li>æŸ¥çœ‹æˆ‘çš„ LinkedInã€GitHub å’Œ X ä¸ªäººèµ„æ–™ï¼Œäº†è§£æˆ‘æ­£åœ¨åšçš„äº‹æƒ…ã€‚</li>
<li>æƒ³è¦æ›´å¤š Kotlin çš„é­”æ³•ï¼Ÿé˜…è¯»æˆ‘ä¹‹å‰çš„åšå®¢ï¼Œäº†è§£å¦ä¸€ç§å¯ä»¥è®©ä½ çš„ä»£ç åº“æ›´ç²¾ç®€ã€æ›´æ™ºèƒ½çš„æŠ€æœ¯ã€‚</li>
</ul>


<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¸Œæœ›ä½ å–œæ¬¢ï¼ğŸš€</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MVIæ¶æ„ï¼šComposeä¸­çš„å“åº”å¼çŠ¶æ€ç®¡ç†]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose/"/>
    <updated>2025-06-25T22:32:21+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒReactive State Management in Compose â€” MVI Architectureã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/reactive-state-management-in-compose-mvi-architecture-71546c9f1b52">https://proandroiddev.com/reactive-state-management-in-compose-mvi-architecture-71546c9f1b52</a>ï¼Œç”±Davies Adedayo AbdulGafarå‘å¸ƒäº2025å¹´4æœˆ22æ—¥ã€‚</p></blockquote>

<p>è¯‘æ³¨ï¼šåŸæ–‡ä½œè€…è™½ç„¶æ˜¯åŸºäºJetpack Composeæ¥å†™çš„ï¼Œä½†é‡ç‚¹è®¨è®ºçš„æ˜¯åº”ç”¨çš„MVIæ¶æ„æ–¹å¼ï¼Œæ¶‰åŠçš„éƒ½æ˜¯çº¯Kotlinè¯­è¨€å±‚é¢çš„ï¼Œä»¥åŠComposeå±‚é¢çš„ï¼Œå¹¶ä¸æ¶‰åŠå¹³å°ç‰¹æ€§ï¼Œå› æ­¤å®Œå…¨é€‚ç”¨äºè·¨å¹³å°çš„Compose Multiplatformã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose/"><img src="https://alexhilton.github.io/Users/alexhilton/Downloads/banner_reactive.png" title="auto auto" ></a></p>

<!-- more -->


<h2>MVIæ˜¯ä»€ä¹ˆé¬¼</h2>

<h3>MVIæ¶æ„çš„åŸºæœ¬æ¦‚å¿µ</h3>

<p>MVIï¼ˆæ¨¡å‹-è§†å›¾-æ„å›¾ï¼‰æ¶æ„ä¸º Android åº”ç”¨ç¨‹åºä¸­å¯æ‰©å±•ã€ç¨³å¥ä¸”å¯æµ‹è¯•çš„ UI çŠ¶æ€ç®¡ç†æä¾›äº†ä¸€ç§ç»“æ„è‰¯å¥½çš„æ–¹æ³•ã€‚å®ƒå¼ºè°ƒä»£ç ç®€æ´å’Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰ï¼Œå°†åº”ç”¨ç¨‹åºåˆ’åˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç»„ä»¶â€”â€”æ¨¡å‹(Model)ã€è§†å›¾(View)å’Œæ„å›¾(Intent)â€”â€”å®ƒä»¬å…±åŒæ„æˆä¸€ä¸ªå¾ªç¯ï¼šæ„å›¾ -> è§†å›¾æ¨¡å‹ -> æ¨¡å‹ -> è§†å›¾ï¼Œä»è€Œå®šä¹‰å•å‘æ•°æ®æµï¼ˆ<strong>è¯‘æ³¨ï¼š</strong>è¿™é‡Œçš„æ„å›¾Intentæ˜¯æ¶æ„ä¸­çš„ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œä¸Androidç³»ç»Ÿä¸­çš„Intentæ²¡æœ‰å…³ç³»ï¼‰ã€‚æ­¤æ¶æ„æ¨¡å¼æä¾›çš„ä¸åŒè§’è‰²æœ‰åŠ©äºæ›´è½»æ¾åœ°ç†è§£å’Œç»´æŠ¤ UI çŠ¶æ€ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼ŒMVI ä¸ä»…ä»…æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œè€Œæ˜¯ä¸€ä¸ªæ—¨åœ¨æµç•…å“åº”å˜åŒ–çš„å“åº”å¼ç³»ç»Ÿã€‚è¿™ç§å“åº”æ€§æ˜¯å…¶å®šä¹‰ç‰¹å¾ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å…¶æœ€å¤§çš„ä¼˜åŠ¿ã€‚</p>

<ul>
<li>å•å‘æ•°æ®æµï¼šæŒ‡æ•°æ®ä»¥å•å‘æµåŠ¨â€”â€”ä»æ¨¡å‹æµå‘è§†å›¾ï¼Œå¹¶ä»¥æ„å›¾çš„å½¢å¼è¿”å›ã€‚è¿™ç¡®ä¿äº†æ¶æ„çš„æ¸…æ™°åº¦ã€å¯é¢„æµ‹æ€§å’Œæ˜“ç»´æŠ¤æ€§ã€‚</li>
<li>å…³æ³¨ç‚¹åˆ†ç¦»ï¼šæŒ‡æ¨¡å‹ã€è§†å›¾å’Œæ„å›¾ç»„ä»¶å…·æœ‰ä¸åŒçš„è§’è‰²ã€‚æ¨¡å‹ç®¡ç†çŠ¶æ€ï¼Œè§†å›¾å¤„ç† UI æ¸²æŸ“ï¼Œæ„å›¾æ•è·å¹¶ä¼ è¾¾ç”¨æˆ·æ“ä½œã€‚</li>
<li>ä¸å¯å˜æ€§ï¼ˆImmutabilityï¼‰ï¼šç¡®ä¿æ¨¡å‹çš„çŠ¶æ€ä¸€æ—¦è®¾ç½®ä¾¿ä¿æŒä¸å˜ã€‚è¿™ä¿è¯äº†å¯é¢„æµ‹æ€§ï¼Œæ¶ˆé™¤äº†æ„å¤–çš„å‰¯ä½œç”¨ï¼Œå¹¶ä¿ƒè¿›äº†ç¨³å®šå¯é çš„åº”ç”¨çŠ¶æ€ã€‚</li>
<li>å“åº”å¼ï¼šå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒUI ä¼šè‡ªåŠ¨æ›´æ–°ã€‚</li>
</ul>


<p>è¯¥æ¶æ„åˆ†è§£ä¸ºä¸‰ä¸ªå’Œè°çš„ç»„ä»¶ï¼Œå®ƒä»¬ä»¥å“åº”å¼æµç¨‹ååŒå·¥ä½œï¼š</p>

<ul>
<li>æ¨¡å‹ (Model) æ˜¯å•ä¸€äº‹å®æ¥æºï¼Œå®ƒæ˜¯åº”ç”¨ç¨‹åºåœ¨ä»»ä½•ç‰¹å®šæ—¶åˆ»çš„çŠ¶æ€å¿«ç…§ã€‚å½“æ­¤çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šè§¦å‘æ•´ä¸ªç³»ç»Ÿçš„çº§è”å“åº”å¼æ›´æ–°ã€‚UI ä¼šåœ¨çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œè¿™å‡¸æ˜¾äº†è¿™ä¸€æ ¸å¿ƒçš„å“åº”å¼åŸåˆ™ã€‚</li>
<li>è§†å›¾ (View) æ ¹æ®å½“å‰æ¨¡å‹çŠ¶æ€ä»¥å“åº”å¼æ–¹å¼æ¸²æŸ“ç”¨æˆ·æ‰€è§å†…å®¹ã€‚å®ƒè®¢é˜…çŠ¶æ€å˜åŒ–å¹¶è‡ªåŠ¨è¿›è¡Œè½¬æ¢ä»¥åæ˜ è¿™äº›å˜åŒ–ï¼Œè€Œæ— éœ€ä»»ä½•å‘½ä»¤å¼æ›´æ–°è°ƒç”¨ã€‚è¿™ç§å“åº”å¼æ¸²æŸ“æ­£æ˜¯ MVI å¦‚æ­¤å¼ºå¤§çš„åŸå› â€”â€”è§†å›¾å§‹ç»ˆä¸çŠ¶æ€åŒæ­¥ã€‚</li>
<li>æ„å›¾ (Intent) å®Œå–„äº†å“åº”å¼ç”µè·¯ï¼Œæ•è·ç”¨æˆ·äº¤äº’å¹¶å°†å…¶åé¦ˆå›ç³»ç»Ÿä»¥åˆ›å»ºæ–°çŠ¶æ€ã€‚è¿™å½¢æˆäº†ä¸€ä¸ªæŒç»­çš„åé¦ˆå¾ªç¯ï¼šç”¨æˆ·æ“ä½œè§¦å‘æ„å›¾ï¼Œæ„å›¾äº§ç”Ÿæ–°çŠ¶æ€ï¼Œæ–°çŠ¶æ€è§¦å‘ UI æ›´æ–°ã€‚</li>
</ul>


<p>å½“æˆ‘ä»¬è¯´ MVI å…·æœ‰å“åº”å¼ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯æ•´ä¸ªç³»ç»Ÿéƒ½æ˜¯å›´ç»•è‡ªåŠ¨å“åº”å˜åŒ–è€Œæ„å»ºçš„ã€‚æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒUI æ— éœ€æ‰‹åŠ¨æ›´æ–°ï¼Œè€Œæ˜¯ä¼šè‡ªåŠ¨åæ˜ å½“å‰çŠ¶æ€ã€‚è¿™ç§å“åº”å¼ç‰¹æ€§èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªåŠ¨æ€ã€å“åº”è¿…é€Ÿçš„åº”ç”¨ç¨‹åºï¼Œè®©ç”¨æˆ·æ„Ÿè§‰ç”ŸåŠ¨æ´»æ³¼ã€‚</p>

<h3>MVIæ¶æ„çš„å…¸å‹å®ç°æ–¹å¼</h3>

<p>åœ¨åŸç”Ÿ Android å¼€å‘ä¸­ï¼ŒMVI çš„å¤§éƒ¨åˆ†å®ç°éƒ½æ”¾åœ¨ ViewModel ç±»ä¸­ã€‚ä»¥ä¸‹æ˜¯å®ç° MVI æ¨¡å¼çš„ä¸€ç§ç®€å•æ–¹æ³•ï¼š</p>

<ol>
<li>æˆ‘ä»¬æ‰“ç®—å»ºæ¨¡çš„ UI çŠ¶æ€å°†å®ç°ä¸ºä¸€ä¸ªä¸å¯å˜çš„ Kotlin æ•°æ®ç±»ï¼ˆdata classï¼‰ï¼Œå…¶å­—æ®µä¿å­˜ç€æˆ‘ä»¬æƒ³è¦åœ¨è§†å›¾ä¸­æ˜¾ç¤ºçš„çŠ¶æ€ã€‚</li>
<li>StateFlow æ˜¯å°†æ•´ä¸ªæ¶æ„ç»‘å®šåœ¨ä¸€èµ·çš„å“åº”å¼ç²˜åˆå‰‚ã€‚è¿™ä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒ…è£…äº†æ¨¡å‹ï¼Œå¹¶å°†å˜åŒ–é€šçŸ¥ç»™è§†å›¾ï¼Œä»¥ä¾¿å®ƒåæ˜ æ–°çš„çŠ¶æ€ã€‚è¿™ä¸ªå“åº”å¼ç®¡é“ç¡®ä¿ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½ä¼šè‡ªåŠ¨ä¼ æ’­åˆ° UIã€‚</li>
<li>ç›®å‰ï¼Œæˆ‘ä»¬çš„æ„å›¾å¯ä»¥å®ç°ä¸º ViewModel ä¸­çš„å…¬å…±å‡½æ•°ã€‚è¿™äº›å‡½æ•°åº”è¯¥æ²¡æœ‰è¿”å›å€¼ï¼Œä»¥ç¡®ä¿è§†å›¾åªæ¥æ”¶æ¥è‡ªè§‚å¯Ÿè€…çš„çŠ¶æ€æ›´æ–°ã€‚ç±»ä¼¼äºå¯¹è±¡ä½œä¸ºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥é€šè¿‡å¼•ç”¨ä¼ é€’ï¼ŒåŒæ ·ï¼Œå‡½æ•°ä¹Ÿä¾èµ–äºæ–¹æ³•å¼•ç”¨ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸€ç‚¹å°†æ„å›¾ä¼ é€’ç»™ä½¿ç”¨å®ƒçš„ UI èŠ‚ç‚¹ã€‚æˆ‘ä»¬æ— éœ€ç¼–å†™å¤æ‚çš„ç±»æ¥å»ºæ¨¡æ„å›¾ï¼Œå› ä¸ºé‚£æ ·éœ€è¦é¢å¤–å®ç°æ„å›¾å¤„ç†ç¨‹åºã€‚</li>
</ol>


<p>ä»¥ä¸‹æ˜¯åœ¨ ViewModel ä¸­å®ç° MVI æ¨¡å¼çš„æ¨¡æ¿ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ScreenViewModel</span><span class="p">()</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span><span class="p">:</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(...))</span> <span class="c1">// private observer object</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span> <span class="c1">// observer object exposed as an immutable instance</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">doUpdateOnState</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="c1">// public function serves as an intent</span>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">doAnotherUpdate</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">MyModel</span><span class="p">(...)</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ–°çŠ¶æ€åœ¨ ViewModel ä¸­ç”Ÿæˆï¼Œç„¶åç”±è§‚å¯Ÿ uiState çš„è§†å›¾ä½¿ç”¨ã€‚è¯·æ³¨æ„ï¼ŒIntent æ˜¯å¦‚ä½•ä½œä¸ºè§¦å‘çŠ¶æ€æ›´æ”¹çš„å›è°ƒä¼ é€’åˆ°å¯ç»„åˆé¡¹é¡µé¢çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'> <span class="k">fun</span> <span class="nf">MyScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">ScreenViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">MyModel</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifeCycle</span><span class="p">()</span> <span class="c1">// consumes the state produced in the viewModel</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">MyScreenContent</span><span class="p">(</span>
</span><span class='line'>     <span class="n">uiState</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">,</span>
</span><span class='line'>     <span class="n">doUpdate</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">doUpdateOnState</span><span class="p">,</span> <span class="c1">// intent to do update</span>
</span><span class='line'>     <span class="n">doAnotherUpdate</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">doAnotherUpdate</span> <span class="c1">// intent to do another update</span>
</span><span class='line'>   <span class="p">)</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§ååº”æ¨¡å¼é€šè¿‡ Kotlin çš„ StateFlow å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span><span class="p">:</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(...))</span>
</span><span class='line'><span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ UI æ–¹é¢ï¼Œè¿™ç§ååº”æ€§é€šè¿‡æ”¶é›†æ“ä½œæ¥è¡¨è¾¾ï¼Œè¯¥æ“ä½œæ¶ˆè€—ä» viewModel ç”Ÿæˆçš„æ–°çŠ¶æ€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">uiState</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifeCycle</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™è¡Œä»£ç å»ºç«‹äº†ä¸€ä¸ªå“åº”å¼è¿æ¥ï¼Œæ¯å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šè‡ªåŠ¨åˆ·æ–° UIã€‚æ— éœ€æ‰‹åŠ¨åˆ·æ–°è°ƒç”¨æˆ–å¤æ‚çš„æ›´æ–°é€»è¾‘â€”â€”ç³»ç»Ÿæœ¬èº«å°±æ˜¯å“åº”å¼çš„ã€‚</p>

<h2>æ¡ˆä¾‹ç ”ç©¶</h2>

<p>è®©æˆ‘ä»¬é‡‡ç”¨æ›´å®ç”¨çš„æ–¹æ³•ï¼Œå®ç° MVI æ¨¡å¼æ¥ç®¡ç†é¡µé¢ çŠ¶æ€ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œç”¨æˆ·å¯ä»¥ä»ç»™å®šçš„é€‰é¡¹ä¸­é€‰æ‹©æ‰€æ˜¾ç¤ºé—®é¢˜çš„ç­”æ¡ˆã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:838/format:webp/0*uwa_-6EYNOhyNuNJ" alt="Case study" /></p>

<p>å›¾ç‰‡æ¥æº â€” <a href="https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey">Compose ç¤ºä¾‹ Jetsurvey</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey%EF%BC%89%E3%80%82%E7%82%B9">https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey%EF%BC%89%E3%80%82%E7%82%B9</a><a href="https://github.com/SahDavies/mvi-architecture-sample/">å‡»æ­¤</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://github.com/SahDavies/mvi-architecture-sample/%EF%BC%89%E5%A4%84%E6%9F%A5%E7%9C%8B%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E3%80%82">https://github.com/SahDavies/mvi-architecture-sample/%EF%BC%89%E5%A4%84%E6%9F%A5%E7%9C%8B%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E3%80%82</a></p>

<p>é¡µé¢åŒ…å«ä»¥ä¸‹çŠ¶æ€ï¼š</p>

<ol>
<li>é—®é¢˜</li>
<li>é€‰é¡¹åˆ—è¡¨</li>
<li>é—®é¢˜è®¡æ•°</li>
<li>é€‰æ‹©æŒ‡ç¤ºå™¨</li>
<li>å¯ç”¨/ç¦ç”¨æŒ‰é’®</li>
</ol>


<p>æ­¤å¤–ï¼Œé¡µé¢è¿˜æä¾›ä»¥ä¸‹ç”¨æˆ·æ“ä½œçš„è¾“å…¥ï¼š</p>

<ol>
<li>è·å–ä¸‹ä¸€ä¸ªé—®é¢˜</li>
<li>è·å–ä¸Šä¸€ä¸ªé—®é¢˜</li>
<li>é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</li>
<li>å…³é—­/ç»“æŸæ“ä½œã€‚è¿™äº›æ“ä½œç”¨äºå°†ç”¨æˆ·çš„æ„å›¾ä¼ è¾¾ç»™åº”ç”¨ç¨‹åºã€‚</li>
</ol>


<p>ä¿å­˜é¡µé¢çŠ¶æ€çš„æ¨¡å‹å¯ä»¥è¿™æ ·å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UiState</span><span class="p">(</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">questionCount</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">totalQuestion</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">question</span><span class="p">:</span> <span class="n">Question</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">userSelection</span><span class="p">:</span> <span class="n">Option</span><span class="p">?</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">hasNext</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">questionCount</span> <span class="p">&lt;</span> <span class="n">totalQuestion</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">hasPrevious</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">questionCount</span> <span class="p">&gt;</span> <span class="m">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚å‰æ‰€è¿°ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨å…¬å…±å‡½æ•°æ¥æè¿°æ„å›¾ï¼Œè¿™äº›å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢åˆ—ä¸¾äº†å°†åœ¨ ViewModel ä¸­å®ç°çš„å‡½æ•°ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">next</span><span class="p">()</span> <span class="c1">// åŠ è½½ä¸‹ä¸€ä¸ªé—®é¢˜</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">previous</span><span class="p">()</span> <span class="c1">// åŠ è½½ä¸Šä¸€ä¸ªé—®é¢˜</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onOptionSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">:</span> <span class="n">Option</span><span class="p">)</span> <span class="c1">// æ¿€æ´»é€‰ä¸­é€‰é¡¹çš„æ ‡è¯†</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨è§†å›¾ä¸­è°ƒç”¨çš„æ¯ä¸ªå‡½æ•°éƒ½ä¼šè§¦å‘ä¸€ä¸ªæ–°çš„çŠ¶æ€ä»¥ä¾›è§†å›¾ä½¿ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬çš„é¡µé¢å°±æ˜¯å¯é¢„æµ‹å’Œå¯æµ‹è¯•çš„ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·äº¤äº’éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¸å¯å˜çŠ¶æ€ï¼Œå¯ä»¥åœ¨æµ‹è¯•æœŸé—´è¿›è¡Œæ¯”è¾ƒã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">QuestionScreen</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onDone</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">BackHandler</span> <span class="p">{</span> <span class="cm">/* Do nothing */</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">QuestionViewModel</span><span class="p">(</span><span class="n">getQuestions</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifecycle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">QuestionScreenContent</span><span class="p">(</span>
</span><span class='line'>        <span class="n">uiState</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onClickNext</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">next</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onClickPrevious</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">previous</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onOptionSelected</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">onOptionSelected</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onDone</span> <span class="p">=</span> <span class="n">onDone</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„ï¼šå¹¶éæ‰€æœ‰å¸¦æœ‰çŠ¶æ€çš„é¡µé¢ç»„ä»¶éƒ½èƒ½ç”¨ MVI ç®¡ç†ã€‚æœ‰äº›ç»„ä»¶ç”±å•ç‹¬çš„çŠ¶æ€æŒæœ‰ç±»ç®¡ç†ï¼Œæœ‰äº›åˆ™ç”±å¯ç»„åˆç»„ä»¶æœ¬èº«çš„å†…éƒ¨çŠ¶æ€ç®¡ç†â€”â€”ä¾‹å¦‚ä¸Šå›¾ä¸­çš„è¿›åº¦æŒ‡ç¤ºå™¨ã€‚ä¸çœŸæ­£å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çŠ¶æ€ä¸åº”è¯¥ä½¿ç”¨ MVI ç®¡ç†ã€‚</p>

<h2>è¶…è¶ŠåŸºæœ¬å“åº”å¼</h2>

<p>ä¸Šè¿°æ¡ˆä¾‹ç ”ç©¶åŸºäºæˆ‘ä»¬çš„é¡µé¢éœ€æ±‚ï¼Œä½¿ç”¨äº†ä¸€ä¸ªæ¨¡å‹çš„ç®€å•å®ç°ã€‚ç¼–å†™ MVI æ¨¡å¼çš„æ¨¡å‹å®ç°æœ‰å¾ˆå¤šæ–¹æ³•â€”â€”æ ¹æ®é¡µé¢éœ€æ±‚è¿›è¡Œå®ç°â€”â€”ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å«åŠ è½½å’Œé”™è¯¯çŠ¶æ€çš„é¡µé¢ã€‚é€šå¸¸ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å¯†å°çš„ç±»å±‚æ¬¡ç»“æ„æ¥å®ç°â€”â€”å°½ç®¡å¦‚æ­¤ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä»¥ä¸åŒçš„æ–¹å¼å®ç°ä½ è‡ªå·±çš„æ¨¡å‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è€ƒè™‘åŠ è½½å’Œé”™è¯¯çŠ¶æ€çš„æ¨¡å‹</span>
</span><span class='line'><span class="k">internal</span> <span class="n">sealed</span> <span class="k">class</span> <span class="nc">UiState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Content</span><span class="p">(</span><span class="k">val</span> <span class="py">myModel</span><span class="p">:</span> <span class="n">UiModel</span><span class="p">)</span> <span class="p">:</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">error</span><span class="p">:</span> <span class="n">ErrorUiModel</span><span class="p">):</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è§†å›¾ä½¿ç”¨è¿™ç§æ–°ç±»å‹çš„æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'> <span class="n">@Composable</span>
</span><span class='line'> <span class="k">fun</span> <span class="nf">MyScreenContent</span><span class="p">(</span><span class="n">uiState</span><span class="p">:</span> <span class="n">UiState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">when</span><span class="p">(</span><span class="n">uiState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">LoadingScreen</span><span class="p">()</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">ErrorScreen</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Content</span> <span class="p">-&gt;</span> <span class="n">ContentScreen</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">myModel</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">LoadingScreen</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ErrorScreen</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="n">ErrorUiModel</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ContentScreen</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">UiModel</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ¨¡å‹æ˜¯äº’æ–¥çš„â€”â€”å®ƒä¿è¯ä¸‰ä¸ªçŠ¶æ€ä¸ä¼šåŒæ—¶å‘ç”Ÿï¼Œè€Œæ˜¯ä¸€æ¬¡å‘ç”Ÿä¸€ä¸ªï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢ UI çŠ¶æ€æ¸²æŸ“ä¸­å¸¸è§çš„é”™è¯¯ã€‚</p>

<h3>é‡å†™ Intent å®ç°</h3>

<p>Intent å®ç°ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ  Reducer/Handler æ¥ä¿®æ”¹ï¼ŒReducer/Handler æ˜¯ ViewModel ä¸­çš„ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨ç§æœ‰å®ç°ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰æ¥æ‰§è¡Œæ“ä½œï¼Œå¹¶ä½¿ç”¨ when è¡¨è¾¾å¼åˆ†æ”¯åˆ°ç›¸åº”çš„æ“ä½œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">Class</span> <span class="n">HomeScreenViewModel</span><span class="p">()</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Some class properties</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// our reducer/handler</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">onHomeAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">HomeAction</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">CategorySelected</span> <span class="p">-&gt;</span> <span class="n">onCategorySelected</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">TopicFollowed</span> <span class="p">-&gt;</span> <span class="n">onTopicFollowed</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">topic</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span> <span class="p">-&gt;</span> <span class="n">onHomeCategorySelected</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">ToggleTopicFollowed</span> <span class="p">-&gt;</span> <span class="n">onToggleTopicFollowed</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">topic</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onCategorySelected</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n">CategoryInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onTopicFollowed</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onToggleTopicFollowed</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onHomeCategorySelected</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n">HomeCategory</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†ä½¿æ­¤è®¾ç½®æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¯†å°çš„æ¥å£å±‚æ¬¡ç»“æ„ï¼Œå¯¹åº”äºæ¯ä¸ªæ“ä½œï¼Œå…¶å­ç±»å±æ€§ç”¨äºä¿å­˜å‚æ•°ï¼Œç„¶åè¿™äº›å‚æ•°å°†é€šè¿‡è§†å›¾ä¸­çš„ reducer/handler ä¼ é€’ç»™è¿™äº›æ“ä½œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">HomeAction</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">CategorySelected</span><span class="p">(</span><span class="k">val</span> <span class="py">category</span><span class="p">:</span> <span class="n">CategoryInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">HomeCategorySelected</span><span class="p">(</span><span class="k">val</span> <span class="py">category</span><span class="p">:</span> <span class="n">HomeCategory</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">TopicFollowed</span><span class="p">(</span><span class="k">val</span> <span class="py">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleTopicFollowed</span><span class="p">(</span><span class="k">val</span> <span class="py">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸æˆ‘ä»¬ç¬¬ä¸€æ¬¡å®ç° Intent æ—¶éœ€è¦åœ¨è§†å›¾ä¸­ä½¿ç”¨æ–¹æ³•å¼•ç”¨ä¼ é€’æ‰€æœ‰æ“ä½œä¸åŒï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä¼ é€’ Reducer/Handlerã€‚ç„¶åï¼Œå†³å®šéœ€è¦è°ƒç”¨å“ªä¸ªæ“ä½œçš„è´£ä»»å°±è½åœ¨äº†è°ƒç”¨è€…èº«ä¸Šã€‚</p>

<p>è¿™æ˜¯è§†å›¾ä¸­çš„æ ·å­</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">HomeScreenViewModel</span><span class="p">,</span> <span class="n">onNavigate</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">HomeContent</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">contentPadding</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onHomeAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">onHomeAction</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onNavigate</span> <span class="p">=</span> <span class="n">onNavigate</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>HomeContent å¯ç»„åˆå‡½æ•°ç°åœ¨è´Ÿè´£å†³å®šè°ƒç”¨å“ªä¸ªæ“ä½œï¼Œæ–¹æ³•æ˜¯å®ä¾‹åŒ–ä»¥ä¸‹ä»»æ„å¯¹è±¡ï¼Œç„¶åä½¿ç”¨å®ä¾‹åŒ–çš„å¯¹è±¡è°ƒç”¨ onHomeAction</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">CategorySelected</span><span class="p">(</span><span class="n">category</span> <span class="p">=</span> <span class="n">CategoryInfo</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span><span class="p">(</span><span class="n">category</span> <span class="p">=</span> <span class="n">HomeCategory</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">TopicFollowed</span><span class="p">(</span><span class="n">topic</span> <span class="p">=</span> <span class="n">TopicInfo</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">ToggleTopicFollowed</span><span class="p">(</span><span class="n">topic</span> <span class="p">=</span> <span class="n">TopicInfo</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯·å‚é˜…ä¸‹é¢çš„å®é™…æ“ä½œï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">HomeContent</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onHomeAction</span><span class="p">:</span> <span class="p">(</span><span class="n">HomeAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span> <span class="c1">// HomeActionæ˜¯ä¸€ä¸ªå¯†å°ç±»å‹å±‚æ¬¡</span>
</span><span class='line'>    <span class="n">onNavigate</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">homeCategory</span> <span class="p">=</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span><span class="p">(</span><span class="n">CategoryInfo</span><span class="p">())</span>
</span><span class='line'>  <span class="n">onHomeAction</span><span class="p">(</span><span class="n">homeCategory</span><span class="p">)</span> <span class="c1">// triggers a state change</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å³ä½¿å¢åŠ äº†å¤æ‚åº¦ï¼Œæ ¸å¿ƒçš„å“åº”å¼åŸåˆ™ä¾ç„¶ä¿æŒä¸å˜ã€‚Reducer åªæ˜¯æä¾›äº†ä¸€ç§æ›´æœ‰æ¡ç†çš„æ–¹å¼æ¥å¤„ç†æ„å›¾å¹¶ç”Ÿæˆæ–°çš„çŠ¶æ€ï¼Œè€Œä»çŠ¶æ€åˆ° UI çš„å“åº”å¼æµç¨‹ä¿æŒä¸å˜ã€‚</p>

<p>è¿™ç§å®ç°æ–¹å¼ä½¿å¾—è¿­ä»£æ„å»ºå˜å¾—ç®€å•â€”â€”æ— è®ºæˆ‘ä»¬éœ€è¦å¯¹æ„å›¾è¿›è¡Œä»€ä¹ˆæ›´æ”¹ï¼ˆæ— è®ºæ˜¯æ·»åŠ æ–°çš„æ„å›¾è¿˜æ˜¯åˆ é™¤ç°æœ‰çš„æ„å›¾ï¼‰ï¼Œéƒ½ä¸éœ€è¦åƒæˆ‘ä»¬æœ€åˆçš„å®ç°é‚£æ ·åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œé‡å†™ï¼›æˆ‘ä»¬åªéœ€åœ¨å¤„ç†ç¨‹åºä¸­æ³¨å†Œæ–°çš„æ“ä½œï¼Œç„¶ååœ¨è°ƒç”¨å¤„ç†ç¨‹åºæ—¶æ ¹æ®å…·ä½“æƒ…å†µå®ä¾‹åŒ–ä¸åŒçš„å¯¹è±¡å³å¯ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼ŒMVI æœ€ä¼˜é›…çš„æ–¹é¢åœ¨äºå®ƒå¦‚ä½•åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å“åº”å¼é“¾è·¯ï¼š</p>

<ol>
<li>æ¨¡å‹å‘å‡ºçŠ¶æ€</li>
<li>è§†å›¾ä½¿ç”¨çŠ¶æ€å¹¶æ¸²æŸ“ UI</li>
<li>ç”¨æˆ·ä¸è§†å›¾çš„äº¤äº’ç”Ÿæˆæ„å›¾</li>
<li>æ„å›¾è¢«å¤„ç†ä»¥åˆ›å»ºæ–°çš„æ¨¡å‹</li>
<li>è¿™ä¸ªå¾ªç¯ä»¥å“åº”å¼çš„æ–¹å¼æŒç»­è¿›è¡Œ</li>
</ol>


<p>è¿™ç§ä¸é—´æ–­çš„å“åº”å¼å¾ªç¯ç¡®ä¿ä½ çš„åº”ç”¨ç¨‹åºå§‹ç»ˆä¸ç”¨æˆ·æ“ä½œå’Œåç«¯æ•°æ®ä¿æŒåŒæ­¥ã€‚è¿™ä¸ä»…ä»…æ˜¯å“åº”å˜åŒ–â€”â€”è€Œæ˜¯åˆ›å»ºä¸€ä¸ªç³»ç»Ÿï¼Œè®©å˜åŒ–è‡ªç„¶åœ°é€šè¿‡é¢„å®šä¹‰çš„å“åº”å¼è·¯å¾„è¿›è¡Œã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰ä»¥è®©Androidä»£ç æ›´ç®€æ´]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases/"/>
    <updated>2025-06-16T22:20:33+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒMaking Android Code Cleaner with Use Cases: A Practical Approach Using Kotlin Coroutinesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/making-android-code-cleaner-with-use-cases-a-practical-approach-using-kotlin-coroutines-2700e724c4fd">https://proandroiddev.com/making-android-code-cleaner-with-use-cases-a-practical-approach-using-kotlin-coroutines-2700e724c4fd</a>ï¼Œç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´4æœˆ11æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eVj9Vuqq31RUWd2y" title="auto auto" ></a></p>

<!-- more -->


<h2>ä»‹ç»</h2>

<p>ä¹‹å‰ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ª Android åº”ç”¨ï¼Œé‡ç‚¹å…³æ³¨äº†æ•´æ´æ¶æ„ (Clean Architecture)ã€è¾“å…¥/è¾“å‡º MVVM æ‹†åˆ†å’Œ Repository æ¨¡å¼ã€‚è¿™ç§æ–¹æ³•éµå¾ªäº† Google Android å›¢é˜Ÿæ¨èçš„æœ€ä½³å®è·µï¼Œä½¿ä»£ç åº“å…·æœ‰å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªé‡è¦æ¦‚å¿µâ€”â€”ç”¨ä¾‹ (Use Case)ï¼Œå¹¶å‘ä½ ä»‹ç»å®ƒçš„ç”¨æ³•åŠå…¶èƒŒåçš„èƒŒæ™¯ã€‚é‡‡ç”¨è¿™ç§æ¨¡å¼å°†ä½¿ä½ çš„ä»£ç æ›´å…·å¯è¯»æ€§å’Œå¯æµ‹è¯•æ€§â€”â€”è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ã€‚</p>

<h3>ä½¿ç”¨Interactorså¸¦æ¥çš„é—®é¢˜</h3>

<p>è¿‡å»ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ Interactors ä½œä¸ºå±‚ä¸å±‚ä¹‹é—´çš„ä¸­é—´ä»¶ç»„ä»¶â€”â€”ä¾‹å¦‚ï¼ŒPresenter å¯ä»¥ä½¿ç”¨ Interactors ä¸é¢†åŸŸå±‚ï¼ˆDomain layerï¼‰è¿›è¡Œé€šä¿¡ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†ä¸€äº›é€»è¾‘ä» Presenter ä¸­ç§»å‡ºï¼Œå¹¶æ”¾å…¥å•ç‹¬çš„å¯å¤ç”¨ç»„ä»¶ä¸­ã€‚åœ¨å½“æ—¶ï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„é€»è¾‘æ‹†åˆ†è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿä¿æŒä»£ç ç®€æ´ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Interactor</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserInteractor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">username</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;Guest&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getUsername</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">username</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">username</span> <span class="p">=</span> <span class="n">name</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Presenter</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserPresenter</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">view</span><span class="p">:</span> <span class="n">UserView</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">interactor</span><span class="p">:</span> <span class="n">UserInteractor</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadUsername</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">interactor</span><span class="p">.</span><span class="n">getUsername</span><span class="p">()</span>
</span><span class='line'>        <span class="n">view</span><span class="p">.</span><span class="n">showUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">interactor</span><span class="p">.</span><span class="n">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">view</span><span class="p">.</span><span class="n">showSavedMessage</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>éšç€ Presenter çš„å¢é•¿ï¼Œé€»è¾‘çš„å¤æ‚æ€§ä¹Ÿä¼šéšä¹‹å¢åŠ â€”â€”è¿™é€šå¸¸ä¼šå¯¼è‡´ Interactor ä¸­æ–¹æ³•æ•°é‡çš„å¢åŠ ã€‚Presenter è¶Šå¤§ï¼ŒInteractor ä¹Ÿå°±è¶Šåºå¤§ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€å¨å¡æ»¡çŠ¶æ€ã€æ–¹æ³•å’Œå˜é‡çš„å±å †ï¼Œå®ƒä»¬éƒ½å †æŒ¤åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚</p>

<p>æ˜¾ç„¶ï¼Œè¿™æ ·çš„ä»£ç åº“ç»´æŠ¤èµ·æ¥å¾ˆå›°éš¾ï¼Œæµ‹è¯•èµ·æ¥ä¹Ÿå¾ˆå›°éš¾ï¼Œç”šè‡³æ›´éš¾ç”¨åˆé€‚çš„å•å…ƒæµ‹è¯•æ¥è¦†ç›–ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ç§æ¶æ„ä¼šé™·å…¥åæ¨¡å¼çš„å¢ƒåœ°ï¼Œè¿å <strong>SOLIDï¼ˆå°¤å…¶æ˜¯å•ä¸€èŒè´£åŸåˆ™ï¼‰</strong> å’Œ <strong>KISS</strong> ç­‰æ ¸å¿ƒåŸåˆ™ã€‚</p>

<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦å¼ºè°ƒä½¿ç”¨ Interactor æ–¹æ³•æ—¶å®¹æ˜“é‡åˆ°çš„ä»¥ä¸‹å‘ï¼š</p>

<ul>
<li>ä¸€å¤„å¡å¤ªå¤šä¸œè¥¿</li>
</ul>


<p>å½“ä¸€ä¸ªç±»å¤„ç†æ‰€æœ‰æ“ä½œâ€”â€”è¯»å–ã€å†™å…¥ã€åˆ é™¤â€”â€”å®ƒæœ€ç»ˆä¼šåšå¤ªå¤šäº‹æƒ…ã€‚è¿™ä¼šå¯¼è‡´æµ‹è¯•æ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”å¾ˆéš¾åœ¨ä¸ç ´åå…¶ä»–åŠŸèƒ½çš„æƒ…å†µä¸‹è¿›è¡Œæ›´æ”¹ã€‚</p>

<ul>
<li>åŠŸèƒ½ä¸æ˜ç¡®</li>
</ul>


<p>åƒ LoginUser() è¿™æ ·çš„ç”¨ä¾‹ä¼šæ¸…æ¥šåœ°å‘Šè¯‰ä½ å‘ç”Ÿäº†ä»€ä¹ˆã€‚ä½†æ˜¯ï¼Œå¦‚æœäº¤äº’å™¨ï¼ˆinteractorï¼‰å¾ˆå¤§ï¼Œå°±å¾ˆéš¾åŒºåˆ†å®ƒçš„ä½œç”¨â€”â€”å®ƒæ˜¯å…³äºç”¨æˆ·çš„ã€è®¾ç½®çš„è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆçš„ï¼Ÿ</p>

<ul>
<li>æ— æ³•å¤ç”¨</li>
</ul>


<p>åªå®Œæˆä¸€é¡¹å·¥ä½œçš„ç”¨ä¾‹å¾ˆå®¹æ˜“æ’å…¥åˆ°ä»»ä½•éœ€è¦çš„åœ°æ–¹ã€‚äº¤äº’å™¨ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¢é•¿ï¼Œå˜å¾—è¿‡äºæ··ä¹±ï¼Œæ— æ³•å¤ç”¨ã€‚</p>

<ul>
<li>æ‰©å±•æ€§å·®</li>
</ul>


<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰ 10 ä¸ªåŠŸèƒ½ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½æœ‰è‡ªå·±çš„äº¤äº’å™¨ï¼Œå¹¶ä¸”åŒ…å« 5 ä¸ªä»¥ä¸Šçš„æ–¹æ³•ã€‚è¿™éœ€è¦è®°ä½å¾ˆå¤šä¸œè¥¿ï¼Œä¹Ÿéœ€è¦ç®¡ç†å¾ˆå¤šä»£ç ã€‚</p>

<ul>
<li>é€»è¾‘æ··ä¹±</li>
</ul>


<p>å½“æ‰€æœ‰å†…å®¹éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æ—¶ï¼Œå¾ˆå®¹æ˜“æ„å¤–åœ°å°†ä¸è¯¥æ”¾åœ¨ä¸€èµ·çš„å†…å®¹æ”¾åœ¨ä¸€èµ·â€”â€”ä¾‹å¦‚ï¼Œç™»å½•é€»è¾‘ä¸ä¸ªäººèµ„æ–™æ›´æ–°é€»è¾‘å°±ä¼šæ··æ‚åœ¨ä¸€èµ·ã€‚</p>

<h2>ç”¨ä¾‹ï¼ˆUse Caseï¼‰ï¼šä» UML åˆ° Android</h2>

<p>æˆ‘ä»¬åˆšæ‰è®¨è®ºçš„æ‰€æœ‰é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰æ–¹æ³•å®Œå…¨è§£å†³æˆ–è‡³å°‘éƒ¨åˆ†è§£å†³ã€‚ä½†åœ¨æ·±å…¥æ¢è®¨åœ¨Androidä¸Šçš„å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå¿«é€Ÿäº†è§£ä¸€ä¸‹ç”¨ä¾‹åœ¨ UML æœ¯è¯­ä¸­çš„å«ä¹‰ã€‚åœ¨ UML ä¸­ï¼Œç”¨ä¾‹æ˜¯å…³äºä¸€ä¸ªæ˜ç¡®çš„æ„å›¾â€”â€”å®ƒä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘æˆ–åŠŸèƒ½ã€‚</p>

<p>æŸ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼Œäº†è§£å®ƒé€šå¸¸æ˜¯å¦‚ä½•å¯è§†åŒ–çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CK9zG_B9spS8JQ8-" alt="Use Case" /></p>

<p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬å³å°†å®ç°çš„ç”¨ä¾‹éµå¾ªä¸ UML ç›¸åŒçš„ç†å¿µï¼šä¸€ä¸ªæ„å›¾ï¼Œä¸€ä¸ªç”¨ä¾‹ï¼ˆOne Intent, one Use Caseï¼‰ã€‚è¿™ä¸ªç®€å•çš„è§„åˆ™å¸®åŠ©æˆ‘ä»¬è§£å†³äº†ä¹‹å‰çš„æ‰€æœ‰é—®é¢˜â€”â€”æµ‹è¯•å˜å¾—æ›´ç®€å•ï¼Œä»£ç æ›´å…·å¯æ‰©å±•æ€§ï¼Œæ•´ä½“ä¹Ÿæ›´æ˜“äºç»´æŠ¤ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ç”¨ä¾‹æ–¹æ³•æ”¹è¿›ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Use-Case 1</span>
</span><span class='line'><span class="k">class</span> <span class="nc">GetUserNameUseCase</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">repository</span><span class="p">.</span><span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Use-Case 2</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SaveUsernameUseCase</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">repository</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å› æ­¤ï¼Œæˆ‘ä»¬åˆšåˆšå°† Interactor æ‹†åˆ†æˆäº†ä¸¤ä¸ªç”¨ä¾‹ã€‚æˆ‘å»ºè®®ä½¿ç”¨ Invoke æ“ä½œå‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬çš„ç”¨ä¾‹åç§°è§†ä¸ºå‡½æ•°ã€‚æ­¤å¤–ï¼Œè¿™ç§æ–¹å¼æµ‹è¯•èµ·æ¥ä¹Ÿæ›´åŠ å®¹æ˜“ã€‚</p>

<p>ä»¥ä¸‹ ViewModel æ¼”ç¤ºäº†ç”¨ä¾‹çš„ç”¨æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ViewModel</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUsername</span><span class="p">:</span> <span class="n">GetUserNameUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">saveUsername</span><span class="p">:</span> <span class="n">SaveUsernameUseCase</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userName</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadUsername</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userName</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">getUsername</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç®€å•çš„æµ‹è¯•å¯ä»¥å†™å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Before</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">useCase</span> <span class="p">=</span> <span class="n">GetUserNameUseCase</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="k">return</span> <span class="n">username</span> <span class="n">from</span> <span class="n">repository</span><span class="err">`</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">`when`</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">getUserName</span><span class="p">()).</span><span class="n">thenReturn</span><span class="p">(</span><span class="s">&quot;JohnDoe&quot;</span><span class="p">)</span>
</span><span class='line'>     <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">useCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;JohnDoe&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span><span class='line'>     <span class="n">verify</span><span class="p">(</span><span class="n">repository</span><span class="p">).</span><span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">save</span> <span class="n">username</span> <span class="n">to</span> <span class="n">repository</span><span class="err">`</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">testName</span> <span class="p">=</span> <span class="s">&quot;JaneDoe&quot;</span>
</span><span class='line'>    <span class="n">useCase</span><span class="p">(</span><span class="n">testName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">verify</span><span class="p">(</span><span class="n">repository</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">testName</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¦‚ä½•å°†å…¶çº³å…¥çœŸæ­£çš„ Repos åº”ç”¨ç¨‹åº</h2>

<p>æˆ‘çš„å»ºè®®æ˜¯å§‹ç»ˆä»æŠ½è±¡å¼€å§‹ã€‚é‰´äºç”¨ä¾‹çš„æ€§è´¨ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªå…¬å…±æ–¹æ³•ï¼‰ï¼Œæˆ‘å»ºè®®ä½¿ç”¨è¿ç®—ç¬¦å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œinvoke åœ¨è¿™é‡Œå°±å¾ˆæœ‰æ•ˆï¼‰ã€‚å¯ä»¥å®ç°ä»¥ä¸‹æŠ½è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ¨¡æ¿æ¥å£ä½œä¸ºæ‰€æœ‰ç”¨ä¾‹çš„æŠ½è±¡</span>
</span><span class='line'><span class="n">interface</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span> <span class="n">O</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®ƒçš„åç§°å¸¦æœ‰å‰ç¼€Suspendï¼ˆè¯‘æ³¨ï¼šè¿™é‡Œåº”è¯¥æ˜¯å‰ç¼€ï¼ŒåŸæ–‡æœ‰é”™è¯¯ï¼‰ï¼Œè¡¨ç¤ºå®ƒå¤„ç†æš‚åœçš„ç»“æœã€‚è¿™ç§é€šç”¨æ–¹æ³•å…è®¸æˆ‘ä»¬ä¸ºå‚æ•°å’Œè¿”å›ç±»å‹å®šä¹‰ç‰¹å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç‰¹å®šçš„ç”¨ä¾‹æ¥å£å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç‰¹å®šçš„ç”¨ä¾‹æ¥å£</span>
</span><span class='line'><span class="n">interface</span> <span class="n">GetReposUseCase</span><span class="p">:</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ ¹æ®å…¶åç§°ï¼Œå®ƒå¯ä»¥ç”¨äºè·å– Reposï¼Œå¹¶æŠ›å‡ºå…¶ Result åŒ…è£…å™¨ã€‚å®¢æˆ·ç«¯å¯ä»¥ä»¥å‡½æ•°å¼çš„æ–¹å¼ä½¿ç”¨å®ƒï¼ˆä¾‹å¦‚ï¼Œval repos = getRepos(&hellip;)ï¼‰ã€‚å®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// GetReposUseCase çš„ç®€å•å®ç°</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetReposUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">ReposRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetReposUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>
</span><span class='line'>      <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>          <span class="n">repository</span><span class="p">.</span><span class="n">getRepos</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">mapper</span><span class="o">::</span><span class="n">map</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è®©ä»»åŠ¡æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå¹¶åœ¨ç”¨ä¾‹ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„æŠ½è±¡å±‚ã€‚æˆ‘æƒ³è¦å®ç°ä»…ä¸å­˜å‚¨åº“äº¤äº’çš„ç”¨ä¾‹ã€‚è¿™äº›ç”¨ä¾‹å°†åŒ…å«å­˜å‚¨åº“çš„å®ä¾‹ä½œä¸ºæ³›å‹ä¸­çš„é™„åŠ å‚æ•°ç±»å‹ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ¨¡æ¿æ¥å£ä½œä¸ºæ‰€æœ‰ç”¨ä¾‹çš„æŠ½è±¡</span>
</span><span class='line'><span class="n">interface</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span> <span class="n">O</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä¿®æ”¹äº†executeæ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿä»å¦ä¸€ä¸ªæŠ½è±¡å­ç±»ä¸­è°ƒç”¨ã€‚ä»¥ä¸‹æ˜¯æ›´æ–°åçš„ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ‰©å±• SuspendUseCase æ¥å£</span>
</span><span class='line'><span class="n">interface</span> <span class="n">RepositoryUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">I</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&gt;</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">repository</span><span class="p">:</span> <span class="n">R</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ªå®ç°ç±»å‹Rçš„å­˜å‚¨åº“çš„å­ç±»éƒ½å°†éµå®ˆè¯¥æ¥å£ï¼ˆContractï¼‰ã€‚æœ€åˆé€‚çš„æ–¹æ³•æ˜¯ä½¿ç”¨æŠ½è±¡ç±»ã€‚è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªæŠ½è±¡ç±»æ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç¡®ä¿éµå®ˆæ¥å£çš„æŠ½è±¡ç±»</span>
</span><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseRepositoryUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">I</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&gt;(</span><span class="k">override</span> <span class="k">var</span> <span class="py">repository</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">RepositoryUseCase</span><span class="p">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">I</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">):</span> <span class="n">O</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// è¿™æ˜¯å¯¹ SuspendUseCase æ¥å£çš„è°ƒç”¨</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">execute</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ‰©å±• BaseRepositoryUseCase ï¼Œéµå¾ªå…¶æ³›å‹æ¥å£ï¼Œæä¾›ä¸€ä¸ªè¾“å…¥ç±»ã€ä¸€ä¸ªè¾“å‡ºç±»ä»¥åŠä¸€ä¸ªè¢«è¦†å†™çš„Repoå®ä¾‹ã€‚ä»¥ä¸‹å®ç°å·²ç»è¶³å¤Ÿï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç”¨ä¾‹çš„å®ç°</span>
</span><span class='line'><span class="k">class</span> <span class="nc">GetReposUseCase</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">RepoRepository</span><span class="p">):</span>
</span><span class='line'>    <span class="n">BaseRepositoryUseCase</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">,</span><span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;,</span> <span class="n">RepoRepository</span><span class="p">&gt;(</span><span class="n">repository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>        <span class="c1">// ä½¿ç”¨å­˜å‚¨åº“è·å–å¹¶è¿”å›ç»“æœï¼Œå¦‚ repository.getData()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»“è®º</h2>

<p>å› æ­¤ï¼Œæˆ‘ä»¬æ¢ç´¢äº†ä»é›¶å¼€å§‹ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰ã€æ•æ‰å®¢æˆ·æ„å›¾ï¼ˆClient Intentï¼‰çš„æœ€ä½³æ–¹æ³•ã€‚æˆ‘æ¼”ç¤ºäº†å¦‚ä½•ä»¥åŠŸèƒ½æ€§çš„æ–¹å¼å®ç°å’Œä½¿ç”¨å®ƒä»¬ï¼Œä½¿å…¶æ˜“äºæµ‹è¯•å’Œé›†æˆã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Androidåº”ç”¨ä¸­å®æˆ˜Repositoryæ¨¡å¼]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository/"/>
    <updated>2025-06-13T22:57:11+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒIncorporating the Repository Pattern into a Real-World Androidã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@siarhei.krupenich/incorporating-the-repository-pattern-into-a-real-world-android-app-739f2fee1460">https://medium.com/@siarhei.krupenich/incorporating-the-repository-pattern-into-a-real-world-android-app-739f2fee1460</a>ï¼Œç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´4æœˆ4æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkmRcr1xl7uFYPUfNyk2rw.png" title="auto auto" ></a></p>

<!-- more -->


<h2>å¼•è¨€</h2>

<p>ä¹‹å‰ï¼Œæˆ‘ä»¬æ¢è®¨äº†æ•´æ´æ¶æ„ (Clean Architecture) ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¯èƒ½ä¼šæŸå®³ SOLID åŸåˆ™ã€å¢åŠ ç´§å¯†è€¦åˆæˆ–ä½¿å¯æµ‹è¯•æ€§å¤æ‚åŒ–ã€‚æˆ‘ä»‹ç»äº†ä¸€ç§è§£å†³è¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©æˆ‘ä»¬ç»´æŠ¤æ›´å¯æ‰©å±•çš„ä»£ç åº“å¹¶æ›´é«˜æ•ˆåœ°æ·»åŠ æ–°åŠŸèƒ½ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¿˜æ¼”ç¤ºäº†å¦‚ä½•å°† ViewModel æ‹†åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†â€”â€”è¾“å…¥æµå’Œè¾“å‡ºæµâ€”â€”ä»¥å‡å°‘ç´§å¯†è€¦åˆå¹¶æé«˜ ViewModel çš„çµæ´»æ€§ã€‚</p>

<p>æœ¬æ–‡å»¶ç»­äº†è¿™ä¸€æ€è·¯ï¼Œé€šè¿‡æ„å»ºä¸€ä¸ªç¤ºä¾‹åº”ç”¨æ¥å±•ç¤º Android å¼€å‘çš„æœ€ä½³å®è·µï¼Œè¯¥åº”ç”¨é€šè¿‡ API è¯·æ±‚è·å–å¹¶æ˜¾ç¤º Git ä»“åº“åˆ—è¡¨ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ç¦»çº¿æ¨¡å¼èå…¥åˆ°é¡¹ç›®ä¸­ã€‚å®ç°è¿™ä¸€ç›®æ ‡æœ€åˆé€‚çš„æ–¹æ³•æ˜¯å®ç° Repository æ¨¡å¼ã€‚Repository æ¨¡å¼å……å½“ Facadeï¼ˆå¦‚ GoF è®¾è®¡æ¨¡å¼ä¸­æ‰€è¿°ï¼‰ï¼Œåœ¨ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨ä¹‹é—´è¿›è¡Œåè°ƒï¼Œç¡®ä¿é«˜æ•ˆçš„æ•°æ®è®¿é—®ã€‚</p>

<p>ä¸ºäº†å……åˆ†ç†è§£æœ¬æ–‡ä¸­çš„æ¦‚å¿µï¼Œå»ºè®®ä½ ç†Ÿæ‚‰åç¨‹æˆ– RxJavaï¼Œå°½ç®¡è¿™äº›ä¸»é¢˜è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ã€‚</p>

<h2>å­˜å‚¨åº“æ–¹æ³•ï¼šç¦»çº¿æ¨¡å¼çš„æœ€ä½³è§£å†³æ–¹æ¡ˆ</h2>

<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨åº”ç”¨ä¸­å®ç°ç¦»çº¿æ¨¡å¼ï¼Œç¡®ä¿å³ä½¿åœ¨æ²¡æœ‰äº’è”ç½‘è¿æ¥çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è®¿é—®æ•°æ®ã€‚åº”ç”¨é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå®ƒä¼šä»ç½‘ç»œè·å–æ•°æ®ï¼Œå°†å…¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œç„¶åä½¿ç”¨ç¼“å­˜çš„æ•°æ®æ¥æœ€å¤§é™åº¦åœ°å‡å°‘ç½‘ç»œä½¿ç”¨é‡å¹¶é™ä½æµé‡ã€‚</p>

<p>å¦ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯æä¾›åœ¨éœ€è¦æ—¶æ‰‹åŠ¨åˆ·æ–°ç½‘ç»œæ•°æ®çš„åŠŸèƒ½ã€‚æœ€åï¼Œä¸ºäº†å¸®åŠ©ç”¨æˆ·åœ¨è¿æ¥é—®é¢˜åè¯†åˆ«åº”ç”¨ä½•æ—¶æ¢å¤äº’è”ç½‘è¿æ¥ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¼“å­˜æ•°æ®æ—è¾¹æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œç›´åˆ°è¿æ¥æ¢å¤ã€‚</p>

<p>ç°åœ¨ä»»åŠ¡å·²ç»æ˜ç¡®ï¼Œè®©æˆ‘ä»¬æ·±å…¥æ¢è®¨å³ç”¨å‹è§£å†³æ–¹æ¡ˆèƒŒåçš„ç†è®ºã€‚å…¶æ ¸å¿ƒæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ç»å…¸çš„æ•°æ®åŒæ­¥é—®é¢˜â€”â€”ä»ç½‘ç»œè·å–æ•°æ®ï¼Œå°†å…¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œå¹¶ç¡®ä¿è®¿é—®æœ€æ–°ä¿¡æ¯ã€‚</p>

<p>è¿™æ„å‘³ç€æˆ‘ä»¬çš„åº”ç”¨è‡³å°‘éœ€è¦ä¸¤ä¸ªæ•°æ®æºï¼šä¸€ä¸ªç”¨äºç½‘ç»œ API é€šä¿¡ï¼Œå¦ä¸€ä¸ªç”¨äºæœ¬åœ°å­˜å‚¨è®¿é—®ã€‚æ ¹æ®åº”ç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½ä¼šç”¨åˆ°å…¶ä»–æ•°æ®æºï¼Œä¾‹å¦‚ Firebaseï¼ˆå†…ç½®åŒæ­¥åŠŸèƒ½ï¼‰ã€BLE æ•°æ®ç­‰ç­‰ã€‚</p>

<p>ä¸ºäº†åè°ƒè¿™äº›æ•°æ®æºï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨ï¼‰ï¼Œæœ€ç›´è§‚çš„è®¾è®¡æ¨¡å¼æ˜¯å››äººå¸® (GoF) çš„ Facade æ¨¡å¼ã€‚</p>

<p>Facade æ¨¡å¼æ˜¯ä¸€ç§é€šè¿‡æä¾›ç»Ÿä¸€æ¥å£æ¥ç®€åŒ–ä¸å¤æ‚ç³»ç»Ÿäº¤äº’çš„è®¾è®¡æ¨¡å¼ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨å°è£…åœ¨ä¸€ä¸ªæŠ½è±¡å±‚ä¹‹åã€‚</p>

<p>æˆ‘ä»¬æ–°åˆ›å»ºçš„ Facade å°†åŒæ—¶ä¿å­˜ API ç½‘ç»œæ¥å£å’Œæœ¬åœ°å­˜å‚¨æ¥å£çš„å®ä¾‹ã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒå°†å…¬å¼€å•ä¸€çš„è®¿é—®æ–¹æ³•ï¼Œå¤„ç†è¯¸å¦‚å¼ºåˆ¶ä»ç½‘ç»œæ›´æ–°æ•°æ®ã€æœ¬åœ°å­˜å‚¨æ•°æ®ä»¥åŠç®¡ç†é”™è¯¯ç­‰ä»»åŠ¡ï¼ŒåŒæ—¶éšè—å†…éƒ¨å¤æ‚æ€§ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„å›¾è¡¨ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1070/format:webp/0*FF1TQeYdw1F60rOZ" alt="å›¾ 1ï¼šå¤–è§‚æ¨¡å¼" /></p>

<p>è¯¥å›¾å‘ˆç°äº†ä¸€ç§ç®€å•çš„é€»è¾‘ï¼šå®¢æˆ·ç«¯ä»…ä¸Facade å®ä¾‹äº¤äº’ä»¥è®¿é—®æ•°æ®ï¼Œè€Œæ‰€æœ‰åº•å±‚å¤æ‚æ€§éƒ½éšè—åœ¨å…¶èƒŒåã€‚è¿™ç§æ–¹æ³•å®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£è¡¨è¯¥å›¾çš„ä»¥ä¸‹ä¼ªä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// API Network</span>
</span><span class='line'><span class="n">interface</span> <span class="n">Network</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Local Storage</span>
</span><span class='line'><span class="n">interface</span> <span class="n">Storage</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">save</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Facade</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DataFacade</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">network</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="n">storage</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">storage</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Client</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>        <span class="n">testScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">facade</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºäº†è¿™ç§æ–¹æ³•ï¼šå®¢æˆ·ç«¯æŒæœ‰ä¸€ä¸ª DataFacade å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶obtainData() æ–¹æ³•ã€‚å½“ç„¶ï¼Œåœ¨å®é™…åœºæ™¯ä¸­ï¼ŒobtainData() æ–¹æ³•ä¼šåŒ…å«æ›´å¤æ‚çš„é€»è¾‘â€”â€”å¤„ç†é”™è¯¯ã€æ˜ å°„æ•°æ®ã€å°†ç»“æœåŒ…è£…åˆ° Result ç±»ä¸­ï¼Œä»¥åŠå†³å®šæ˜¯è·å–æ–°æ•°æ®è¿˜æ˜¯ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œå°†è¿™ä¸ª Facade è½¬æ¢ä¸º Repository ç±»ã€‚
Repository æ¨¡å¼æ—¨åœ¨é€šè¿‡æ¸…æ™°çš„æ¥å£ç®¡ç†æ•°æ®è®¿é—®ï¼ŒåŒæ—¶éšè—åº•å±‚çš„å¤æ‚æ€§ã€‚ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œ
æ²¡æœ‰ä»»ä½•å˜åŒ–â€”â€”ç”¨æ³•ä¿æŒä¸å˜â€”â€”ä½†åœ¨å†…éƒ¨ï¼Œé€»è¾‘ç»“æ„è‰¯å¥½ä¸”å°è£…å®Œæ•´ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸‹å›¾æ¥æŸ¥çœ‹ Repository æ¨¡å¼çš„ç»“æ„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1070/format:webp/0*_A5f_Tv_9UhUuFqz" alt="å›¾ 2ï¼šå­˜å‚¨åº“æ¨¡å¼" /></p>

<p>ä¸Šå›¾è¡¨æ˜ï¼ŒRepository æ¨¡å¼æœ‰æ•ˆåœ°æ•æ‰äº† Facade æ¨¡å¼ï¼›ç„¶è€Œï¼Œâ€œRepositoryâ€ä¸€è¯æ›´èƒ½ä½“ç°è®¿é—®æ•°æ®çš„é€»è¾‘ï¼Œ
å› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨â€œRepositoryâ€ç‰ˆæœ¬ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®ç°è¯¥æ¨¡å¼çš„å¢å¼ºç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Repository Interface</span>
</span><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Repository</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DataRepositoryImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">network</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="n">storage</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">storage</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Client</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">testScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å­˜å‚¨åº“æ¨¡å¼ï¼šä¼˜åŠ¿ä¸åŠ£åŠ¿</h2>

<h3>å­˜å‚¨åº“çš„ä¼˜åŠ¿</h3>

<ol>
<li>ä¿æŒäº•ç„¶æœ‰åºâ€”â€”ä½ çš„ä¸šåŠ¡é€»è¾‘æ— éœ€å¤„ç†æ•°æ®åº“æŸ¥è¯¢ã€‚</li>
<li>æ˜“äºæµ‹è¯•â€”â€”ä½ å¯ä»¥å°†çœŸå®æ•°æ®åº“ä¸æ¨¡æ‹Ÿæ•°æ®åº“äº¤æ¢ä»¥è¿›è¡Œæµ‹è¯•ã€‚</li>
<li>é¢å‘æœªæ¥â€”â€”å¦‚æœä½ ä» SQLite åˆ‡æ¢åˆ° Firebaseï¼Œåªéœ€æ›´æ–°å­˜å‚¨åº“å³å¯ã€‚</li>
<li>å¯é‡ç”¨â€”â€”åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨åº“ï¼Œè€Œæ— éœ€ç¼–å†™é‡å¤çš„ä»£ç ã€‚</li>
<li>ä»£ç æ›´ç®€æ´â€”â€”å®ƒéšè—äº†å¤æ‚çš„æŸ¥è¯¢ï¼Œå› æ­¤å…¶ä½™ä»£ç ä¿æŒç®€æ´ã€‚</li>
</ol>


<h3>ä¸ºä»€ä¹ˆå®ƒå¯èƒ½å¾ˆç¹ç</h3>

<ol>
<li>å¢åŠ é¢å¤–ä»£ç â€”â€”å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¾ˆå°ï¼Œä½¿ç”¨å­˜å‚¨åº“å¯èƒ½ä¼šæœ‰äº›è¿‡åº¦ã€‚</li>
<li>å¯èƒ½ä¼šé™ä½é€Ÿåº¦â€”â€”æ›´å¤šçš„å±‚çº§æ„å‘³ç€æ›´å¤šçš„å¯¹è±¡å’Œæ–¹æ³•è°ƒç”¨ã€‚</li>
<li>ç¼“å­˜ä¸æ˜¯è‡ªåŠ¨çš„â€”â€”å¦‚æœä½ æƒ³é¿å…ä¸å¿…è¦çš„æ•°æ®åº“è°ƒç”¨ï¼Œåˆ™éœ€è¦ä»˜å‡ºé¢å¤–çš„åŠªåŠ›ã€‚</li>
<li>å¯èƒ½è¿‡äºä¾èµ–æ•°æ®æ¨¡å‹â€”â€”å¦‚æœè®¾è®¡ä¸å½“ï¼Œæ›´æ”¹æ•°æ®åº“ç»“æ„å¯èƒ½ä¼šå¾ˆéº»çƒ¦ã€‚</li>
<li>å¹¶éæ€»æ˜¯å¿…è¦â€”â€”æœ‰æ—¶ï¼Œä»…ä½¿ç”¨ DAO å°±è¶³å¤Ÿäº†ã€‚</li>
</ol>


<p>Repository æ¨¡å¼éå¸¸é€‚åˆä¿æŒç®€æ´æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä½†å®ƒå¹¶éæ€»æ˜¯æœ€ç®€å•çš„é€‰æ‹©ã€‚å¦‚æœä½ çš„åº”ç”¨è§„æ¨¡è¾ƒå°ï¼Œè·³è¿‡å®ƒå¯èƒ½ä¼šæ›´è½»æ¾ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯ä¸ºå¿«é€Ÿå¢é•¿ä¸”å¯æ‰©å±•çš„åº”ç”¨æä¾›è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©äº†å®ƒã€‚</p>

<p>ç°åœ¨ï¼Œæ˜¯æ—¶å€™ç¼–å†™ä»£ç å¹¶å¢å¼º Repo åº”ç”¨äº†ã€‚</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ”¹è¿› Repository ç»“æ„å¹¶ä½¿å…¶é€‚åº”åº”ç”¨ã€‚ç”±äºæ²¡æœ‰å¤ªå¤šç»†èŠ‚éœ€è¦æ•´åˆï¼Œå› æ­¤æœ€ç»ˆçš„å›¾è¡¨ä¸ä¹‹å‰çš„ç‰ˆæœ¬éå¸¸ç›¸ä¼¼ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1144/format:webp/0*aH3Jd9RK9EI0AA9I" alt="å›¾3ï¼šè·å–Reposçš„Repositoryå®ç°" /></p>

<h2>å¼€æ’¸</h2>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®ç° Repository å¹¶å°†å…¶é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// The Repository pattern implementation</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">ReposRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">reposNetworkApi</span><span class="p">:</span> <span class="n">ReposNetworkApi</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">reposDao</span><span class="p">:</span> <span class="n">ReposDao</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// mappers may be placed here</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ReposRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getRepos</span><span class="p">(</span><span class="n">i</span>
</span><span class='line'>        <span class="n">sRefreshing</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">runCatching</span> <span class="p">{</span>
</span><span class='line'>             <span class="k">val</span> <span class="py">dbRepos</span> <span class="p">=</span> <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>             <span class="k">if</span> <span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                 <span class="n">reposNetworkApi</span><span class="p">.</span><span class="n">getRepos</span><span class="p">().</span><span class="n">fold</span><span class="p">({</span> <span class="n">result</span> <span class="p">-&gt;</span>
</span><span class='line'>                     <span class="n">reposDao</span><span class="p">.</span><span class="n">insertReposWithRelations</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>                     <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span>
</span><span class='line'>                         <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                     <span class="p">)</span>
</span><span class='line'>                  <span class="p">},</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                     <span class="n">error</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span><span class="n">dbRepos</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">})</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">dbRepos</span><span class="p">)</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}.</span><span class="n">getOrElse</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>              <span class="n">error</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>                  <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearRepos</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposDao</span><span class="p">.</span><span class="n">clearRepos</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•å°† Repository æ¨¡å¼é›†æˆåˆ°åº”ç”¨ä¸­ã€‚å®ƒåŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªç”¨äºæ¸…é™¤æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ•°æ®ã€‚getRepos(isRefreshing: Boolean) æ–¹æ³•åŒ…å«ä¸€ä¸ªæ ‡å¿—ï¼Œç”¨äºå¼ºåˆ¶ä»ç½‘ç»œåˆ·æ–°æ•°æ®ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå¯èƒ½ä»ç¼“å­˜ä¸­è¿”å›æ•°æ®ï¼ˆä¾‹å¦‚ï¼ŒRoom DB ç”¨ä½œç¼“å­˜ï¼‰ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå³ä½¿æ•°æ®å·²ç¼“å­˜ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šè¿”å›ä¸€ä¸ªåŒ…å«å¤±è´¥ä¿¡æ¯çš„å“åº”ã€‚</p>

<p>ç”±äºæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯åç¨‹ï¼Œå› æ­¤è®©æˆ‘ä»¬ä½¿ç”¨ RxJava é‡å†™ getRepos(isRefreshing: Boolean) æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getRepos</span><span class="p">(</span>
</span><span class='line'>    <span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'><span class="p">):</span> <span class="n">Single</span><span class="p">&lt;</span><span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposNetworkApi</span><span class="p">.</span><span class="n">getRepos</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">insertReposWithRelations</span><span class="p">(</span><span class="n">networkReposToDbReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onErrorResumeNext</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">error</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onErrorReturn</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">error</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¼‚å¸¸å¤„ç†çš„æ‰©å±•å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Throwable</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">RepoWithRelations</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;(</span>
</span><span class='line'>            <span class="n">data</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»“æœé”™è¯¯å¤„ç†æ‰©å±•å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Throwable</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>        <span class="n">localData</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">RepoWithRelations</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">repoError</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">IOException</span> <span class="p">-&gt;</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">NetworkLost</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HttpException</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">()</span> <span class="p">==</span> <span class="m">401</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">RepoError</span><span class="p">.</span><span class="n">Unauthorized</span>
</span><span class='line'>                <span class="k">else</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">localData</span><span class="p">),</span>
</span><span class='line'>            <span class="n">repoError</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŒ…è£…çš„æ•…éšœæ•°æ®ç±»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">ResultWithFallback</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Failure</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">?,</span> <span class="k">val</span> <span class="py">error</span><span class="p">:</span> <span class="n">RepoError</span><span class="p">)</span> <span class="p">:</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶ä¸”è½¬æ¢æ˜ å°„æ‰©å±•å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">map</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span> <span class="p">-&gt;</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">data</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">transform</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">error</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»“è®º</h2>

<p>æˆ‘ä»¬å·²æˆåŠŸå°†å­˜å‚¨åº“æ¨¡å¼(Repository pattern)é›†æˆåˆ°åº”ç”¨ä¸­ï¼Œäº‹å®è¯æ˜ï¼Œè¿™æ˜¯ä¸€ç§ç»´æŠ¤ç¦»çº¿æ¨¡å¼çš„ç»ä½³æ–¹æ³•ã€‚æ­¤æ¨¡å¼ä¸ä»…ç®€åŒ–äº†æ•°æ®ç®¡ç†ï¼Œè¿˜ç¡®ä¿äº†å¯æ‰©å±•æ€§ã€‚å®ƒæ˜¯å®ç°æ•°æ®æ£€ç´¢å’Œå­˜å‚¨åŠŸèƒ½çš„æœ€æœ‰æ•ˆæ–¹æ³•ä¹‹ä¸€ï¼Œéšç€é¡¹ç›®è§„æ¨¡çš„å¢é•¿ï¼Œä½ å¯ä»¥æ›´è½»æ¾åœ°ç®¡ç†æœ¬åœ°å’Œè¿œç¨‹æ•°æ®æºã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥æ¢ç´¢ä¸æœ¬æ–‡ä¸»é¢˜ç›¸å…³çš„ GitHub ä»£ç åº“ï¼š<a href="https://github.com/sergeykrupenich/TestRepo/tree/repository">https://github.com/sergeykrupenich/TestRepo/tree/repository</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetpack Compose ä¸­ViewModelçš„æœ€ä½³å®è·µ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/11/mvvm-inputs-outputs-jetpack-compose/"/>
    <updated>2025-06-11T22:20:55+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/11/mvvm-inputs-outputs-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒMVVM Inputs/Outputs: Best Practices and Implementation in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@siarhei.krupenich/mvvm-inputs-outputs-best-practices-and-implementation-in-jetpack-compose-18966d4d914e">https://medium.com/@siarhei.krupenich/mvvm-inputs-outputs-best-practices-and-implementation-in-jetpack-compose-18966d4d914e</a>ï¼Œ ç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´3æœˆ16æ—¥ã€‚</p></blockquote>

<p><strong>è¯‘æ³¨ï¼š</strong> å› ä¸ºæ–‡ç« é‡ç‚¹è®¨è®ºçš„æ˜¯ViewModelçš„å®ç°æ–¹å¼ï¼Œå¹¶ä¸æ¶‰åŠå¹³å°ç‰¹æ€§ï¼Œæ‰€ä»¥å®Œå…¨é€‚ç”¨äºè·¨å¹³å°çš„Compose Multiplatformã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/11/mvvm-inputs-outputs-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vIJH8waAV-986AZatyXxwA.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç®€ä»‹</h2>

<p>åœ¨æˆ‘<a href="https://juejin.cn/post/7509376843951554596">ä¹‹å‰çš„æ–‡ç« </a>ä¸­ï¼Œæˆ‘æ¢è®¨äº†â€œæ•´æ´æ¶æ„â€ï¼ˆClean Architectureï¼‰ä½œä¸ºä¸€ç§å®ç”¨çš„ Android å¼€å‘æ–¹æ³•ã€‚è¿™ç§æ¶æ„è§£å†³æ–¹æ¡ˆä¾§é‡äºå°†é€»è¾‘ç»„ä»¶åˆ’åˆ†ä¸ºä¸åŒçš„å±‚ï¼Œæ¯ä¸€å±‚è´Ÿè´£å„è‡ªçš„ä»»åŠ¡ã€‚</p>

<p>æœ¬æ–‡ä»¥æ­¤ä¸ºåŸºç¡€ï¼Œé€šè¿‡ä¸€ä¸ªçœŸå®çš„åº”ç”¨ç¤ºä¾‹ä»‹ç»å¦ä¸€ç§æœ€ä½³å®è·µã€‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä½¿ç”¨ ViewModel æ—¶çš„ä¸€ä¸ªå¸¸è§é—®é¢˜ï¼Œæ¦‚è¿°ä¸€ä¸ªç»“æ„åŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æ·±å…¥æ¢è®¨å…¶èƒŒåçš„ç†è®ºã€‚æ­¤å¤–ï¼Œæˆ‘å°†æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ Jetpack Compose æœ‰æ•ˆåœ°å®ç°è¿™ç§æ–¹æ³•ï¼Œå¹¶æä¾›å„ç§ç¤ºä¾‹ã€‚æ‰€æœ‰ä»£ç ç‰‡æ®µéƒ½å‡è®¾è¯»è€…ç†è§£ä½¿ç”¨ Hilt çš„ä¾èµ–æ³¨å…¥ (DI - Dependency Injection)ã€‚</p>

<h2>ViewModelæ¦‚è¿°</h2>

<p>MVVM çš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡å°† UI é€»è¾‘ç§»å…¥çŠ¶æ€æ¥å°†å…¶ä¸è§†å›¾åˆ†ç¦»ã€‚è¿™ç¡®ä¿äº†è§†å›¾åœ¨ä¿æŒé€»è¾‘äº•ç„¶æœ‰åºçš„åŒæ—¶ä¿æŒç®€æ´ã€‚é¦–å…ˆï¼Œè¿™ç§æ–¹æ³•ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ï¼Œä»è€Œå¢å¼ºäº†å¯æµ‹è¯•æ€§å’Œå¯æ‰©å±•æ€§ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜è§£å†³äº†ä¸€ä¸ªå…¸å‹çš„ Android æŒ‘æˆ˜â€”â€”åœ¨ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼ˆä¾‹å¦‚é…ç½®æ›´æ”¹ï¼‰æœŸé—´å¤„ç† UI çŠ¶æ€ã€‚</p>

<p>ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä½¿ç”¨ ViewModel æ¥ç®¡ç†å¹¶ä¿ç•™å…¶çŠ¶æ€ï¼Œå³ä½¿å…³è”çš„ Activity è¢«é‡æ–°åˆ›å»ºã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ViewModel ä¾‹å­</span>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">ScreenViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetUiDataUseCase</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_state</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;(</span><span class="n">State</span><span class="p">.</span><span class="n">Loading</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Loading</span>
</span><span class='line'>        <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†ä¸€ä¸ªç®€å•çš„ ViewModelï¼Œå®ƒåªæœ‰ä¸€ä¸ªçŠ¶æ€å’Œä¸€ä¸ªç”± init è§¦å‘çš„æ–¹æ³•ã€‚loadData() æ–¹æ³•å¯åŠ¨çŠ¶æ€æ›´æ–°è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ç”±åç¨‹ StateFlow ç®¡ç†ã€‚</p>

<p>ä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°†æ‰€æœ‰å¯èƒ½çš„é¡µé¢çŠ¶æ€åˆå¹¶åˆ°ä¸€ä¸ªå¯†å°ç±»ä¸­ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿä»¥ç»“æ„åŒ–çš„å•æ–¹æ³•é£æ ¼å¤„ç† UI çŠ¶æ€å˜åŒ–ï¼Œä»è€Œä½¿ä½ çš„ä»£ç æ›´å…·å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>

<p>ä»¥ä¸‹ç¤ºä¾‹è¯´æ˜äº†è¿™ä¸€æ¦‚å¿µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// State</span>
</span><span class='line'><span class="k">internal</span> <span class="n">sealed</span> <span class="n">interface</span> <span class="n">State</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">(</span><span class="k">val</span> <span class="py">repos</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DataUi</span><span class="p">&gt;):</span> <span class="n">State</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Empty</span><span class="p">:</span> <span class="n">State</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span><span class="p">:</span> <span class="n">State</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">message</span><span class="p">:</span> <span class="n">String</span><span class="p">?):</span> <span class="n">State</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»¥ä¸‹ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Composable View that uses the ViewModel:</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">Screen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">ScreenViewModel</span> <span class="p">=</span> <span class="n">hiltViewModel</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">loadRepos</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">RepoState</span><span class="p">(</span><span class="n">repoState</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">RepoState</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">:</span> <span class="n">ScreenViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">when</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">State</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">items</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">count</span><span class="p">())</span> <span class="p">{</span> <span class="n">index</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">Item</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">State</span><span class="p">.</span><span class="n">Empty</span> <span class="p">-&gt;</span> <span class="n">EmptyState</span><span class="p">(</span>
</span><span class='line'>            <span class="n">stateMessage</span> <span class="p">=</span> <span class="err">â€œ</span><span class="n">Empty</span> <span class="n">message</span><span class="err">â€</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">emptyButtonAction</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">State</span><span class="p">.</span><span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">RepoEmptyState</span><span class="p">(</span>
</span><span class='line'>            <span class="n">stateMessage</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">message</span><span class="p">,</span>
</span><span class='line'>            <span class="n">emptyButtonAction</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">State</span><span class="p">.</span><span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">LoadingState</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Screen() å¯ç»„åˆå‡½æ•°ä» StateFlow ä¸­è§‚å¯ŸçŠ¶æ€ï¼Œå¹¶åœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶è¿›è¡Œæ›´æ–°ã€‚æ ¹æ®å…·ä½“çŠ¶æ€ï¼ˆDataã€Emptyã€Error æˆ– Loadingï¼‰ï¼Œå°†ä½¿ç”¨å•å‡½æ•°æ–¹æ³•è§¦å‘ç›¸åº”çš„å¯ç»„åˆå‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>

<p>æ€»ä½“è€Œè¨€ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆç¨³å®šâ€”â€”çŠ¶æ€åœ¨ ViewModel ä¸­ç®¡ç†ï¼Œå¹¶ä¸”è§†å›¾ï¼ˆActivity çš„ä¸€éƒ¨åˆ†ï¼‰å¯ä»¥å®‰å…¨åœ°é‡æ–°åˆ›å»ºè€Œä¸ä¼šä¸¢å¤±æ•°æ®ã€‚æ­¤å¤–ï¼Œè¿™ç§æ–¹æ³•è¿˜å¯ä»¥æ›´è½»æ¾åœ°ç¼–å†™çŠ¶æ€å¤„ç†ã€ViewModel å‡½æ•°è°ƒç”¨å’Œ UI å¤–è§‚çš„å•å…ƒæµ‹è¯•ã€‚</p>

<h2>å¸¸è§„ViewModelçš„ä¸è¶³ä¹‹å¤„</h2>

<p>çºµè§‚å½“å‰çš„å®ç°ï¼Œé¦–å…ˆçªå‡ºçš„é—®é¢˜æ˜¯ ViewModel å¯èƒ½ä¼šä¸å ªé‡è´Ÿã€‚éšç€åº”ç”¨çš„å¢é•¿ï¼Œæˆ‘ä»¬å°†å¤šä¸ªçŠ¶æ€å’Œé€»è¾‘æ‰“åŒ…åœ¨ä¸€ä¸ª ViewModel ä¸­å¤„ç†ï¼Œè¿™å¯èƒ½ä¼šè¿åå•ä¸€èŒè´£åŸåˆ™ã€‚</p>

<p>å¦ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯ UI å’Œé€»è¾‘ä¹‹é—´çš„ç´§å¯†è€¦åˆã€‚ç›´æ¥æ“ä½œ ViewModel çš„å®ä¾‹ä¼šä½¿ UI æ›´åŠ ä¾èµ–äºå…¶å…·ä½“å®ç°ï¼Œä»è€Œé™ä½çµæ´»æ€§å’Œå¯å¤ç”¨æ€§ã€‚</p>

<h2>ä¸ºä»€ä¹ˆå¸¸è§„ ViewModel ä¼šæˆä¸ºé—®é¢˜</h2>

<p>ä½¿ç”¨å¸¸è§„ ViewModelï¼ˆä¸åˆ†ç¦»è¾“å…¥å’Œè¾“å‡ºï¼‰ä¹ä¸€çœ‹ä¼¼ä¹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†éšç€åº”ç”¨è§„æ¨¡çš„å¢é•¿ï¼Œæƒ…å†µå¯èƒ½ä¼šå˜å¾—æ··ä¹±ã€‚åŸå› å¦‚ä¸‹ï¼š</p>

<ol>
<li>UI å’Œé€»è¾‘è¿‡äºæ··æ‚</li>
<li>ViewModel åŒæ—¶å¤„ç†ä¸šåŠ¡é€»è¾‘å’Œ UI æ›´æ–°ï¼Œä½¿å®ƒä»¬ç´§å¯†ç›¸è¿ã€‚</li>
<li>å¦‚æœéœ€è¦æ›´æ”¹ UIï¼Œé€šå¸¸ä¹Ÿéœ€è¦ä¿®æ”¹ ViewModelï¼Œè¿™ä¸åº”è¯¥å‘ç”Ÿã€‚</li>
<li><p>ğŸ’¡ ä¾‹å¦‚ï¼šä½ çš„ UI å¯èƒ½åœ¨ä¸€ä¸ªåœ°æ–¹å¤„ç†éªŒè¯ã€æ•°æ®è½¬æ¢å’ŒåŠ è½½çŠ¶æ€ã€‚</p></li>
<li><p>æµ‹è¯•éš¾åº¦åŠ å¤§</p></li>
<li>åŠŸèƒ½è¿‡å¤šçš„ ViewModel ä¼šä½¿æµ‹è¯•ç¼–å†™å˜å¾—å¤æ‚ã€‚</li>
<li>ä¸åŒæ—¶å¤„ç†æ•°æ®å’ŒçŠ¶æ€ï¼Œå°±æ— æ³•è½»æ¾æµ‹è¯• UI è¡Œä¸ºã€‚</li>
<li><p>ğŸ’¡ ä¾‹å¦‚ï¼šå³ä½¿æ˜¯ç®€å•çš„ UI æµ‹è¯•ä¹Ÿä¼šå˜å¾—æ£˜æ‰‹ï¼Œå› ä¸º ViewModel æ§åˆ¶ç€ä¸€åˆ‡ã€‚</p></li>
<li><p>æ›´æ”¹ UI å˜å¾—ä»¤äººå¤´ç–¼</p></li>
<li>å¦‚æœä½ çš„ ViewModel æ²¡æœ‰æ­£ç¡®åˆ†ç¦»ï¼Œæ›´æ”¹ä¸€ä¸ª UI å…ƒç´ å°±ä¼šå½±å“æ‰€æœ‰ UI å…ƒç´ ã€‚</li>
<li><p>ğŸ’¡ ç¤ºä¾‹ï¼šå°† TextView æ›¿æ¢ä¸º RecyclerView ä¼šè¿«ä½¿ä½ ä¿®æ”¹ ViewModelï¼Œå³ä½¿å®ƒä¸åº”è¯¥å…³å¿ƒ UI ç»†èŠ‚ã€‚</p></li>
<li><p>ViewModel å˜å¾—è¿‡å¤§</p></li>
<li>éšç€æ—¶é—´çš„æ¨ç§»ï¼ŒViewModel ä¼šå˜å¾—åºå¤§ä¸”éš¾ä»¥ç®¡ç†ã€‚</li>
<li><p>å®ƒä»¬ä¼šåŒæ—¶å¤„ç†ç”¨æˆ·è¾“å…¥ã€API è°ƒç”¨å’ŒçŠ¶æ€æ›´æ–°ã€‚ğŸ’¡ ğŸ’¡ ç¤ºä¾‹ï¼šåŒ…å«æ•°ç™¾è¡Œä»£ç çš„ ViewModel éš¾ä»¥é˜…è¯»ã€è°ƒè¯•æˆ–æ›´æ–°ã€‚</p></li>
<li><p>é€»è¾‘éš¾ä»¥å¤ç”¨</p></li>
<li>å¦‚æœ ViewModel æ··åˆäº†è¾“å…¥å¤„ç†ï¼ˆæŒ‰é’®ç‚¹å‡»ï¼‰å’Œè¾“å‡ºé€»è¾‘ï¼ˆæ•°æ®æ ¼å¼åŒ–ï¼‰ï¼Œé‚£ä¹ˆå¤ç”¨å…¶ä¸­çš„éƒ¨åˆ†å†…å®¹ä¼šå˜å¾—éå¸¸éº»çƒ¦ã€‚</li>
<li><p>ğŸ’¡ ç¤ºä¾‹ï¼šä½ æƒ³åœ¨å¦ä¸€ä¸ªé¡µé¢ä¸Šå¤ç”¨æŸäº›ä¸šåŠ¡é€»è¾‘ï¼Œä½†å®ƒä¸ç‰¹å®šäº UI çš„ä»£ç çº ç¼ åœ¨ä¸€èµ·ã€‚</p></li>
<li><p>UI çŠ¶æ€ç®¡ç†å˜å¾—æ··ä¹±</p></li>
<li>åœ¨ ViewModel å†…éƒ¨å¤„ç†åŠ è½½ã€æˆåŠŸå’Œé”™è¯¯çŠ¶æ€ä¼šè®©äº‹æƒ…å˜å¾—æ··ä¹±ã€‚</li>
<li><p>ğŸ’¡ ç¤ºä¾‹ï¼šå¤„ç†å¤±è´¥çš„ç½‘ç»œè¯·æ±‚å¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ä¸åº”ä¸å…¶ä»–é€»è¾‘æ··æ·†ã€‚</p></li>
<li><p>å¤§å‹åº”ç”¨ä¸­éš¾ä»¥æ‰©å±•</p></li>
<li>å¦‚æœå¤šä¸ªé¡µé¢å…±äº«ä¸€ä¸ª ViewModelï¼Œå®ƒå°±ä¼šè¶…è½½ã€‚</li>
<li>åœ¨ä¸€ä¸ª ViewModel ä¸­ç®¡ç†è®¸å¤šä¸åŒçš„ UI çŠ¶æ€ä¼šå¯¼è‡´æ··ä¹±ã€‚</li>
<li>ğŸ’¡ ç¤ºä¾‹ï¼šç®¡ç† 10 ä¸ªä»¥ä¸Šé¡µé¢çš„ ViewModel å¾ˆå¿«å°±ä¼šæˆä¸ºç»´æŠ¤çš„å™©æ¢¦ã€‚</li>
</ol>


<h2>çµä¸¹å¦™è¯ï¼šè¾“å…¥/è¾“å‡ºå¼ViewModel</h2>

<p>æˆ‘ä»¬è®¨è®ºçš„è®¸å¤šé—®é¢˜éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨è¾“å…¥/è¾“å‡º ViewModel æ–¹æ³•å¾—åˆ°æœ€å°åŒ–ï¼Œç”šè‡³å®Œå…¨è§£å†³ã€‚æ­¤æ–¹æ³•å°† ViewModel ä¸­çš„â€œè¾“å…¥â€æµå’Œâ€œè¾“å‡ºâ€æµåˆ†ç¦»ã€‚</p>

<ul>
<li>è¾“å‡ºå¤„ç† UI çš„æ›´æ–°ï¼ˆä¾‹å¦‚ï¼Œå…¬å¼€çŠ¶æ€ï¼‰ã€‚</li>
<li>è¾“å…¥æ¥æ”¶æ¥è‡ª UI çš„æ¶ˆæ¯ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·äº¤äº’ï¼‰ã€‚</li>
</ul>


<p>ä¾‹å¦‚ï¼Œåœ¨å…¸å‹çš„ ViewModel ä¸­ï¼ŒStateFlow ä»£è¡¨â€œè¾“å‡ºâ€æµï¼Œå› ä¸ºå®ƒå‘ UI æä¾›çŠ¶æ€æ›´æ–°ã€‚ç›¸åï¼Œåƒ reloadData(refreshing: Boolean) è¿™æ ·çš„æ–¹æ³•å……å½“â€œè¾“å…¥â€æµï¼Œå¤„ç† UI è§¦å‘çš„æ“ä½œã€‚</p>

<p>æ­¤æ¨¡å¼ä¸æ˜¯ç›´æ¥ä¸ ViewModel äº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡è¾“å…¥å’Œè¾“å‡ºæ¥å£å¼ºåˆ¶è¿›è¡Œç»“æ„åŒ–è®¿é—®ï¼Œä»è€Œæ˜ç¡®ä¾èµ–å…³ç³»å¹¶å‡å°‘ç´§å¯†è€¦åˆã€‚</p>

<p>ä½¿ç”¨æ­¤æ¨¡å¼çš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// å–ä»£viewModel.reloadData(refreshing = true)</span>
</span><span class='line'><span class="n">input</span><span class="p">.</span><span class="n">reloadData</span><span class="p">(</span><span class="n">refreshing</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// å–ä»£val dataState by viewModel.data.collectAsState()</span>
</span><span class='line'><span class="k">val</span> <span class="py">dataState</span> <span class="k">by</span> <span class="n">output</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§ç»“æ„åŒ–æ–¹æ³•æé«˜äº†ä»£ç çš„æ¸…æ™°åº¦ã€å¯æµ‹è¯•æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œä½¿ ViewModel æ›´åŠ æ¨¡å—åŒ–å’Œå¯æ‰©å±•ã€‚</p>

<p>æˆ‘ä»¬æ¥ç”»ä¸ªå›¾ï¼Œç›´è§‚åœ°äº†è§£ä¸€ä¸‹å®ƒçš„å·¥ä½œåŸç†ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1082/format:webp/0*aOEwjnoh4uw8_C9y" alt="ViewModel" /></p>

<p>è¯¥å›¾å±•ç¤ºäº†è¯¥æ¨¡å¼ã€‚ViewModel å®ç°äº† ScreenViewModel æ¥å£ï¼Œè¯¥æ¥å£è¿›ä¸€æ­¥ç»†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æ¥å£â€”â€”ä¸€ä¸ªç”¨äºå¤„ç†è¾“å…¥ï¼ˆæ“ä½œï¼‰ï¼Œå¦ä¸€ä¸ªç”¨äºæä¾›è¾“å‡ºï¼ˆæ•°æ®ï¼‰ã€‚è¿™ç§è®¾ç½®å¦‚åŒå¥‘çº¦ï¼Œç¡®ä¿äº†æ¸…æ™°çš„ç»“æ„å’Œåˆ†ç¦»ã€‚ViewModel æœ¬èº«ä»ç„¶æ˜¯ä¸€ä¸ªå®ä¾‹ï¼Œé¿å…åœ¨å…¶å±‚é¢ç›´æ¥æ“ä½œã€‚æ‰€æœ‰æ“ä½œéƒ½é€šè¿‡è¾“å…¥å’Œè¾“å‡ºæ¥å£è¿›è¡Œï¼Œä»è€Œå¼ºåŒ–äº†å•ä¸€èŒè´£åŸåˆ™ã€‚æœ€åï¼ŒView ä»…ä¸ ScreenViewModel æ¥å£äº¤äº’ï¼Œåœ¨æŠ½è±¡å±‚è¿›è¡Œæ“ä½œã€‚æ­¤å¤–ï¼ŒView è¿˜å¯ä»¥è¿›ä¸€æ­¥ç»†åˆ†ä¸ºè¾“å…¥å’Œè¾“å‡ºæ¥å£ï¼Œä»è€Œå…è®¸ä»¥ç®€æ´ã€æ¨¡å—åŒ–çš„æ–¹å¼è®¿é—®æ–¹æ³•å’Œæ•°æ®ã€‚</p>

<h2>å¼€æ’¸å§ï¼</h2>

<p>é¦–å…ˆï¼Œåº”è¯¥é‡æ„ ViewModelï¼Œå°†å…¶å°è£…åœ¨ä¸€ä¸ªæ¥å£ä¸­ï¼Œå¹¶å°†å…¶åŠŸèƒ½åˆ†ç¦»åˆ°ä¸“ç”¨çš„è¾“å…¥å’Œè¾“å‡ºæ¥å£ä¸­ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ViewModel</span>
</span><span class='line'><span class="k">internal</span> <span class="n">interface</span> <span class="n">ScreenViewModel</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">interface</span> <span class="n">Input</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">loadData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">interface</span> <span class="n">Output</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@HiltViewModel</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">ViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetUiDataUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">Input</span><span class="p">,</span> <span class="n">Output</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">input</span><span class="p">:</span> <span class="n">Input</span> <span class="p">=</span> <span class="k">this</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">output</span><span class="p">:</span> <span class="n">Output</span> <span class="p">=</span> <span class="k">this</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">private</span> <span class="k">val</span> <span class="py">_state</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;(</span><span class="n">State</span><span class="p">.</span><span class="n">Loading</span><span class="p">)</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">override</span> <span class="k">fun</span> <span class="nf">loadData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">private</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">State</span><span class="p">.</span><span class="n">Loading</span>
</span><span class='line'>            <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å®ç°ä¸ ViewModel äº¤äº’çš„è§†å›¾ã€‚ä»¥ä¸‹ä»£ç ç‰‡æ®µæä¾›äº†ä¸€ä¸ªä½¿ç”¨ Jetpack Compose çš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">Screen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">ReposScreenViewModel</span><span class="p">.</span><span class="n">ViewModel</span> <span class="p">=</span> <span class="n">hiltViewModel</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">repoState</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">input</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">UIState</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// UiStateä½¿ç”¨æ¥å£ ScreenViewModel.Inputæ¥æ“ä½œViewModelçš„è¾“å…¥</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">UIState</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">,</span> <span class="n">input</span><span class="p">:</span> <span class="n">ScreenViewModel</span><span class="p">.</span><span class="n">Input</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">when</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">State</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">LazyColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">items</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">count</span><span class="p">())</span> <span class="p">{</span> <span class="n">index</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">UIItem</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">State</span><span class="p">.</span><span class="n">Empty</span> <span class="p">-&gt;</span> <span class="n">EmptyState</span><span class="p">(</span>
</span><span class='line'>          <span class="n">emptyButtonAction</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// å–ä»£ viewModel.loadData(true)</span>
</span><span class='line'>            <span class="n">input</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">RepoState</span><span class="p">.</span><span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">EmptyState</span><span class="p">(</span><span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>        <span class="n">RepoState</span><span class="p">.</span><span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">LoadingState</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä½¿ç”¨è¾“å…¥/è¾“å‡ºå¼ViewModel çš„ä¼˜åŠ¿</h2>

<p>é€šè¿‡å°† ViewModel æ„å»ºä¸ºè¾“å…¥å’Œè¾“å‡ºæ¥å£ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´ç®€æ´ã€æ›´é«˜æ•ˆçš„æ¶æ„ã€‚å…¶ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p>

<h3>âœ… æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSoC - Separation of Concernsï¼‰</h3>

<p>è¾“å…¥å¤„ç†ç”¨æˆ·æ“ä½œï¼ˆä¾‹å¦‚ï¼ŒæŒ‰é’®ç‚¹å‡»ã€æ–‡æœ¬è¾“å…¥ï¼‰ï¼Œè€Œè¾“å‡ºç®¡ç† UI çŠ¶æ€å’Œæ•°æ®ã€‚è¿™ä½¿å¾—ä½ çš„ä»£ç åº“æ›´åŠ ç»“æ„åŒ–ï¼Œæ›´æ˜“äºå¯¼èˆªã€‚</p>

<h3>âœ… æ›´è½»æ¾çš„æµ‹è¯•</h3>

<p>é€šè¿‡æ¸…æ™°çš„åˆ†ç¦»ï¼Œä½ å¯ä»¥åˆ†åˆ«æµ‹è¯•è¾“å…¥ï¼ˆç”¨æˆ·äº¤äº’ï¼‰å’Œè¾“å‡ºï¼ˆçŠ¶æ€æ›´æ–°ï¼‰ï¼Œä»è€Œä½¿å•å…ƒæµ‹è¯•æ›´åŠ ä¸“æ³¨å’Œå¯é ã€‚</p>

<h3>âœ… æ›´å¥½çš„å¯é‡ç”¨æ€§å’Œå¯æ‰©å±•æ€§</h3>

<p>è¾“å…¥å’Œè¾“å‡ºå¯ä»¥åœ¨å¤šä¸ªé¡µé¢æˆ–åŠŸèƒ½ä¹‹é—´é‡å¤ä½¿ç”¨ï¼Œè€Œæ— éœ€é‡å¤é€»è¾‘ï¼Œä»è€Œå¸®åŠ©ä½ çš„åº”ç”¨åœ¨æ‰©å±•è¿‡ç¨‹ä¸­é¿å…ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚</p>

<h3>âœ… ç®€åŒ–çš„çŠ¶æ€ç®¡ç†</h3>

<p>å°† UI çŠ¶æ€ï¼ˆåŠ è½½ã€æˆåŠŸã€é”™è¯¯ï¼‰ä¿ç•™åœ¨è¾“å‡ºä¸­ï¼Œå¯ä»¥é˜²æ­¢ ViewModel è¢«æ— å…³çš„é€»è¾‘æ·¹æ²¡ï¼Œä»è€Œä½¿çŠ¶æ€å¤„ç†æ›´åŠ ç›´è§‚ã€‚</p>

<h2>ç»“è®º</h2>

<p>æˆ‘ä»¬æ¢ç´¢äº†å¦ä¸€ä¸ªå¯ä»¥æ— ç¼é›†æˆåˆ°ä½ é¡¹ç›®ä¸­çš„å¼ºå¤§å·¥å…·ã€‚é€šè¿‡é‡‡ç”¨è¿™ç§æ–¹æ³•ï¼Œä½ å¯ä»¥å¢å¼ºåº”ç”¨çš„å¯æ‰©å±•æ€§ï¼Œä¿æŒä»£ç åº“ç®€æ´ï¼Œå¹¶æé«˜æµ‹è¯•æ•ˆç‡ã€‚è¿™æ˜¯ä¸€ç§ç®€å•è€Œæœ‰æ•ˆçš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜å¯ç»´æŠ¤æ€§ï¼Œå¹¶è®©ä½ çš„å¼€å‘æµç¨‹é¢å‘æœªæ¥ã€‚</p>

<p>æ¬¢è¿æŸ¥çœ‹åŒ…å«ç°æˆè§£å†³æ–¹æ¡ˆçš„ä»£ç åº“ï¼š<a href="https://github.com/sergeykrupenich/TestRepo/tree/inputs-outputs">https://github.com/sergeykrupenich/TestRepo/tree/inputs-outputs</a>ã€‚</p>

<p>æ–‡ç« æ›´æ–°ï¼šæœ‰äººæŒ‡å‡ºï¼Œæœ€å¥½é¿å…åœ¨ ViewModel çš„ init å—ä¸­åŠ è½½æ•°æ®ã€‚ç›¸åï¼Œä¸€ç§æ›´çµæ´»çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Composable ä¸­çš„ LaunchedEffect() å»¶è¿Ÿè§¦å‘æ•°æ®åŠ è½½ã€‚è¿™å¯ä»¥ç¡®ä¿ ViewModel ä¸ä¼šè¿‡æ—©è·å–æ•°æ®ï¼Œå¹¶æ›´å¥½åœ°ä¸ Compose çš„ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´ã€‚ï¼ˆè¯‘æ³¨ï¼šå…³äºå‰¯ä½œç”¨å‡½æ•°å¯å‚è€ƒä¹‹å‰çš„æ–‡ç« <a href="https://juejin.cn/post/7405158681078104127">é™Composeåå…«æŒä¹‹ã€é¾™æˆ˜äºé‡ã€| Side Effects</a>ï¼‰</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨ç°ä»£Androidå¼€å‘ä¸­å®æˆ˜Clean Architecture]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/10/clean-architecture-for-android/"/>
    <updated>2025-06-10T22:33:00+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/10/clean-architecture-for-android</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒRefining Clean Architecture for Android: A
Practical Approachã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@siarhei.krupenich/refining-clean-architecture-for-android-a-practical-approach-32ce966f8ba3">https://medium.com/@siarhei.krupenich/refining-clean-architecture-for-android-a-practical-approach-32ce966f8ba3</a>ï¼Œç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´2æœˆ23æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/06/10/clean-architecture-for-android/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*964gi7PELf9cc4CQwp6XBA.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç®€ä»‹</h2>

<p>æœ¬æ–‡æ˜¯ä¸“æ³¨äº Android å¼€å‘å’Œè®¾è®¡ä¸­å®é™…é—®é¢˜ä¸€ç³»åˆ—æ–‡ç« ä¸­çš„ç¬¬ä¸€ç¯‡ï¼Œè¿™äº›æ–‡ç« å°†ä¼šæ¶µç›–æ•´æ´æ¶æ„ (Clean Architecture)ã€ViewModel è¾“å…¥/è¾“å‡ºæ‹†åˆ†ã€Repository æ¨¡å¼ç­‰ï¼Œå¹¶åŸºäºæœ€ä½³å®è·µæä¾›è§£å†³æ–¹æ¡ˆã€‚æ¯ç¯‡éƒ½å°†èšç„¦äºä¸€ä¸ªç‰¹å®šä¸»é¢˜ï¼Œå¹¶åŒ…å«ä¸€ä¸ª GitHub åˆ†æ”¯çš„é“¾æ¥ï¼Œç”¨äºæ¼”ç¤ºè¯¥ä¸»é¢˜çš„å®è·µä»£ç ã€‚ä½œä¸ºå¼€ç¯‡ï¼Œæœ¬æ–‡å°†æ¢è®¨æ•´æ´æ¶æ„ã€å…¶é¢ä¸´çš„æŒ‘æˆ˜ä»¥åŠå¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ç”¨çš„å®ç”¨è§£å†³æ–¹æ¡ˆã€‚</p>

<h2>æ•´æ´æ¶æ„ï¼ˆClean Architectureï¼‰ç®€ä»‹</h2>

<p>æ•´æ´æ¶æ„æ˜¯ä¸€ç§ç»“æ„åŒ–çš„æ–¹æ³•ï¼Œé€šè¿‡å°†åº”ç”¨ç¨‹åºçš„ä»£ç åº“åˆ’åˆ†ä¸ºæ•°æ®å±‚ã€é¢†åŸŸå±‚å’Œå±•ç°å±‚æ¥ç»„ç»‡å®ƒã€‚</p>

<ul>
<li>æ•°æ®å±‚ï¼ˆData Layerï¼‰ï¼šå¤„ç†æ•°æ®æ£€ç´¢å’Œå­˜å‚¨ï¼Œæ— éœ€äº†è§£åŸŸå±‚æˆ–è¡¨ç¤ºå±‚ã€‚</li>
<li>é¢†åŸŸå±‚ï¼ˆDomain Layerï¼‰ï¼šåŒ…å«ä¸šåŠ¡é€»è¾‘å’Œç”¨ä¾‹ï¼Œä¸æ•°æ®å±‚äº¤äº’ï¼Œä½†ç‹¬ç«‹äºè¡¨ç¤ºå±‚ã€‚</li>
<li>å±•ç°å±‚ï¼ˆPresentation Layerï¼‰ï¼šä¸“æ³¨äº UIï¼Œä»é¢†åŸŸå±‚æ¥æ”¶çŠ¶æ€ï¼Œå¹¶ä¿æŒé€»è¾‘æœ€å°åŒ–ã€‚</li>
</ul>


<p>è¿™é‡Œå…³é”®åŸåˆ™æ˜¯ä¾èµ–å…³ç³»åªå‘å†…æµåŠ¨â€”â€”æ¯ä¸€å±‚åªäº†è§£å…¶ä¸‹ä¸€å±‚ï¼Œä»è€Œç¡®ä¿å¯ç»´æŠ¤æ€§å’Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰ã€‚ä¸‹å›¾å±•ç¤ºäº† Android ä¸­ä¸€ä¸ªç®€å•çš„æ•´æ´æ¶æ„ (Clean Architecture) å®ç°ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1064/format:webp/0*iND5nS_w8q9O_o2z" alt="å›¾ 1ï¼šAndroid çš„ç®€å•æ•´æ´æ¶æ„å®ç°" /></p>

<h2>è®©æˆ‘ä»¬å¼€å§‹æ’¸å§ï¼</h2>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æŒ‰ç…§å›¾ 1æ„å»ºé¡¹ç›®ç»“æ„ã€‚è™½ç„¶åŠŸèƒ½æ¨¡å—é€šå¸¸æ˜¯å¤§å‹é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œä½†ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†å°½é‡ç®€åŒ–ï¼Œä»…å…³æ³¨æ•´æ´æ¶æ„ã€‚</p>

<p>æˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå°å‹åº”ç”¨ï¼Œè¯¥åº”ç”¨ä½¿ç”¨æ•´æ´æ¶æ„ + MVVM + åç¨‹ï¼Œè¿›è¡Œå•ä¸ª API è°ƒç”¨å¹¶æ˜¾ç¤ºä¸€ä¸ªç®€å•çš„åˆ—è¡¨ã€‚</p>

<p>ä¸ºäº†ä¿æŒç‹¬ç«‹æ€§ï¼Œæ¯ä¸ªå±‚å°†è¢«æ‹†åˆ†ä¸ºç‹¬ç«‹çš„æ¨¡å—ï¼š</p>

<ul>
<li>æ•°æ®å±‚(Data Layer)ï¼šåŒ…å« Retrofit ä¾èµ–é¡¹ã€ç½‘ç»œæ¨¡å‹å’Œç”¨äºæ•°æ®è®¿é—®çš„å­˜å‚¨åº“ã€‚ï¼ˆä¹Ÿå¯ä»¥é€‰æ‹©æ·»åŠ æœ¬åœ°å­˜å‚¨å®ç°ã€‚ï¼‰</li>
<li>é¢†åŸŸå±‚(Domain Layer)ï¼šåŒ…å«ç”¨ä¾‹ï¼ˆæˆ–äº¤äº’å™¨ï¼‰ã€é¢†åŸŸæ¨¡å‹å’Œç”¨äºå°†ç½‘ç»œæ¨¡å‹è½¬æ¢ä¸ºé¢†åŸŸæ¨¡å‹çš„æ˜ å°„å™¨ã€‚å®ƒä¾èµ–äºæ•°æ®æ¨¡å—ï¼Œå› ä¸ºå®ƒä½¿ç”¨å…¶å­˜å‚¨åº“ã€‚</li>
<li>è¡¨ç¤ºå±‚(Presentation Layer)ï¼šåŒ…å«ä¸é¢†åŸŸæ¨¡å—ä¸­çš„ç”¨ä¾‹äº¤äº’çš„ ViewModelï¼Œç”¨äºå¤„ç† UI æ•°æ®ã€‚</li>
</ul>


<p>é¡¹ç›®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>- Data
</span><span class='line'>  API Interface <span class="o">(</span>Retrofit<span class="o">)</span>
</span><span class='line'>  DAO
</span><span class='line'>  Repository Interface
</span><span class='line'>  Repository Instance
</span><span class='line'>- Domain
</span><span class='line'>  Use-cases and their interfaces
</span><span class='line'>  Domain models
</span><span class='line'>  Mappers from Network to Domain models
</span><span class='line'>- Presentation
</span><span class='line'>  ViewModels
</span><span class='line'>  Views
</span></code></pre></td></tr></table></div></figure>


<h3>æ•°æ®æ¨¡å—ï¼ˆData Moduleï¼‰:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">DataNetworkApi</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">@GET</span><span class="p">(</span><span class="n">API_DATA</span><span class="p">)</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">ApiEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">companion</span> <span class="k">object</span> <span class="err">{ </span>
</span><span class='line'>    <span class="k">private</span> <span class="n">const</span> <span class="k">val</span> <span class="py">API_DATA</span> <span class="p">=</span> <span class="s">&quot;/api/data&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Keep</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">DataApiEntity</span><span class="p">(</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="n">@SerializedName</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">)</span> <span class="k">val</span> <span class="py">description</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataApiEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">dataNetworkApi</span><span class="p">:</span> <span class="n">DataNetworkApi</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">dataLocalStorage</span><span class="p">:</span> <span class="n">DataLocalStorage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>
</span><span class='line'>    <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataApiEntity</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// dataLocalStorage and dataLocalStorage usage </span>
</span><span class='line'>    <span class="err">â€¦</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">dataNetworkApi</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ˜¾ç„¶ï¼Œè¿™ä¸æ˜¯å­˜å‚¨åº“æ¨¡å¼(Repository Pattern)çš„ç»å…¸å®ç°â€”â€”å®ƒçº¯ç²¹æ˜¯ä¸ºäº†æ¼”ç¤ºè€Œè®¾è®¡çš„ï¼Œä»¥è®©æˆ‘ä»¬èƒ½ä¸“æ³¨äºæ•´æ´æ¶æ„ã€‚</p>

<h3>é¢†åŸŸæ¨¡å—ï¼ˆDomain Moduleï¼‰ï¼š</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">DataEntity</span><span class="p">(</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">title</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">description</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataEntityMapperImpl</span><span class="p">:</span> <span class="n">DataEntityMapper</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">fun</span> <span class="nf">map</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">DataApiEntity</span><span class="p">):</span> <span class="n">DataEntity</span> <span class="p">=</span> <span class="n">with</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DataEntity</span><span class="p">(</span>
</span><span class='line'>      <span class="err">â€¦</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>  <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetDataUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">DataEntityMapper</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">DataRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span>
</span><span class='line'>    <span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>  <span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">repository</span><span class="p">.</span><span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">map</span> <span class="p">{</span> <span class="n">repositoryData</span> <span class="p">-&gt;</span>
</span><span class='line'>      <span class="n">repositoryData</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">data</span> <span class="p">-&gt;</span> <span class="n">mapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å±•ç°æ¨¡å—ï¼ˆPresentation Moduleï¼‰ï¼š</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="n">sealed</span> <span class="n">interface</span> <span class="n">UiDataState</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">(</span><span class="k">val</span> <span class="py">repos</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">&gt;):</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">object</span> <span class="nc">Empty</span><span class="p">:</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span><span class="p">:</span> <span class="n">UiDataState</span>
</span><span class='line'>   <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">message</span><span class="p">:</span> <span class="n">String</span><span class="p">?):</span> <span class="n">UiDataState</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">GetUiDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">UiDataState</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetUiDataUseCaseImpl</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetDataUseCase</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapUiData</span><span class="p">:</span> <span class="n">MapDataUiModelUseCase</span><span class="p">,</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">mapUiStateData</span><span class="p">:</span> <span class="n">MapDataUiStateUseCase</span>
</span><span class='line'><span class="p">):</span> <span class="n">GetUiDataUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">UiDataState</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">mapUiStateData</span><span class="p">(</span>
</span><span class='line'>      <span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">mapCatching</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">it</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapUiRepos</span><span class="o">::</span><span class="n">invoke</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…³äº GetUiDataUseCaseImpl æœ‰å‡ ä¸ªå…³é”®ç‚¹éœ€è¦æ³¨æ„ã€‚å¦‚ä½ æ‰€è§ï¼Œå®ƒåŒ…å«ä¸€ä¸ªä¸Šè¿° GetDataUseCase å®ç°çš„å®ä¾‹ä»¥åŠä¸¤ä¸ªé¢å¤–çš„æ˜ å°„å™¨ã€‚MapDataUiModelUseCase å¯ä»¥å°†é¢†åŸŸæ¨¡å‹è½¬æ¢ä¸º UI æ¨¡å‹ï¼ˆå±äºè¡¨ç¤ºå±‚ï¼‰ã€‚åŒæ—¶ï¼ŒMapDataUiStateUseCase ç¡®å®šç›¸åº”çš„ UI çŠ¶æ€ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹ä¹‹ä¸€ï¼š</p>

<ul>
<li>æ­£åœ¨åŠ è½½(Loading)</li>
<li>ç©ºæ•°æ®(Empty)</li>
<li>éç©º(Non-Empty)</li>
<li>é”™è¯¯(Error)</li>
</ul>


<h4>ViewModelï¼š</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">TestViewModel</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">getData</span><span class="p">:</span> <span class="n">GetUiDataUseCase</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">refresh</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">RepoState</span><span class="p">.</span><span class="n">Loading</span>
</span><span class='line'>     <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>GitHub é¡¹ç›®ä¸æä¾›çš„ä»£ç ç‰‡æ®µç•¥æœ‰ä¸åŒï¼Œå› ä¸ºå®ƒä½¿ç”¨äº† ViewModel è¾“å…¥/è¾“å‡ºæ¨¡å¼å’Œ Hilt ä¾èµ–æ³¨å…¥â€”â€”è¿™ä¸¤è€…éƒ½æ˜¯å¯æ‰©å±•å¼€å‘çš„åŸºæœ¬åŸåˆ™ï¼Œæˆ‘ä»¬å°†åœ¨åç»­æ–‡ç« ä¸­æ¢è®¨ã€‚æ­¤å¤–ï¼Œæ‰€æœ‰ç»„ä»¶éƒ½ç”¨æ¥å£åŒ…è£…ï¼Œç¡®ä¿å¯æµ‹è¯•æ€§ï¼ŒåŒæ—¶å…è®¸åœ¨æ¥å£çº§åˆ«è¿›è¡Œæ— ç¼æ“ä½œã€‚åç»­æ–‡ç« å°†æ·±å…¥æ¢è®¨è¿™äº›æ–¹é¢ã€‚</p>

<p>æˆ‘ä»¬æˆåŠŸäº†ï¼ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥ç ”ç©¶ä»£ç ã€‚æ¯ä¸€å±‚éƒ½è´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½ï¼Œä½¿å…¶æ—¢æ¨¡å—åŒ–åˆæ˜“äºæµ‹è¯•ã€‚æ•°æ®å±‚çš„å­˜å‚¨åº“ä¾èµ–äº API å’Œæœ¬åœ°å­˜å‚¨ï¼Œè€Œé¢†åŸŸç”¨ä¾‹ä¾èµ–äºå­˜å‚¨åº“ã€‚è¡¨ç¤ºå±‚ä¸é¢†åŸŸç”¨ä¾‹äº¤äº’ã€‚</p>

<p>å¦‚æœæˆ‘éœ€è¦æ›¿æ¢ HTTP å®¢æˆ·ç«¯ï¼Œæˆ‘åªéœ€å°†æ–°çš„ä¾èµ–é¡¹æ³¨å…¥å­˜å‚¨åº“ï¼ŒåŒæ—¶ä¿æŒå¥‘çº¦ï¼Œç¡®ä¿åŠŸèƒ½æ— ç¼è¡”æ¥ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªç»„ä»¶éƒ½å¯ä»¥è¢«å•å…ƒæµ‹è¯•è¦†ç›–ï¼Œä»è€Œä½¿æ¶æ„å¯æ‰©å±•ä¸”æ˜“äºç»´æŠ¤ã€‚</p>

<p>åŒæ ·éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œæ¥å£åº”è¯¥å±äºä½¿ç”¨å®ƒä»¬çš„å±‚ã€‚ä¹ä¸€çœ‹ï¼Œä¸€åˆ‡éƒ½äº•äº•æœ‰æ¡ï¼Œä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆéœ€è¦æ”¹è¿›çš„åœ°æ–¹ã€‚ä½†è®©æˆ‘ä»¬ä»”ç»†çœ‹çœ‹ã€‚</p>

<h2>ç»å…¸æ•´æ´æ¶æ„å®ç°çš„ç¼ºç‚¹</h2>

<h3>è§‚å¯Ÿç»“æœå’Œæ½œåœ¨é—®é¢˜</h3>

<p>æˆ‘ä»¬ä¸Šé¢å¼€å‘çš„å®ç°å…è®¸ç›´æ¥è®¿é—®åº•å±‚æ¨¡å—ç»„ä»¶ï¼Œä¾‹å¦‚ API å®ç°æˆ–æ•°æ®åº“å­˜å‚¨ã€‚ä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯å°†å®ƒä»¬å†…éƒ¨åŒ–ï¼Œå¹¶ç¡®ä¿åªèƒ½é€šè¿‡å­˜å‚¨åº“è®¿é—®æ•°æ®ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä»ç„¶å­˜åœ¨ä¸€ä¸ªå…³é”®çš„ç¼ºç‚¹ï¼šå­˜å‚¨åº“çš„æ¥å£åŠå…¶å®ä¾‹éƒ½ä¿å­˜åœ¨åŒä¸€ä¸ªæ•°æ®æ¨¡å—ä¸­ã€‚è¿™ä¼šå¯¼è‡´ä¸€äº›æ½œåœ¨çš„é£é™©ï¼š</p>

<ol>
<li>è¿åå°è£…â€”â€”ç›´æ¥ä½¿ç”¨å…·ä½“å®ä¾‹è€Œä¸æ˜¯æ¥å£å­˜åœ¨é£é™©ï¼Œè¿™ä¹Ÿä¼šå½±å“æ¥å£éš”ç¦»åŸåˆ™ã€‚</li>
<li>è¿åæ•´æ´æ¶æ„å¥‘çº¦â€”â€”éšç€é¡¹ç›®çš„å‘å±•ï¼Œå¯èƒ½ä¼šå‡ºç°å·å·¥å‡æ–™çš„å€¾å‘ï¼Œä¾‹å¦‚å…è®¸é¢†åŸŸç”¨ä¾‹ä¸æ•°æ®åº“å®ä¾‹è€Œä¸æ˜¯å­˜å‚¨åº“æ¥å£äº¤äº’ã€‚</li>
<li>å­˜å‚¨åº“å§”æ‰˜çš„å¤æ‚æ€§å¢åŠ â€”â€”å°†ç»„ä»¶ç»‘å®šåœ¨ä¸€èµ·å˜å¾—æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå°¤å…¶æ˜¯åœ¨ä¾èµ–å…³ç³»å¢åŠ çš„æƒ…å†µä¸‹ã€‚</li>
<li>æ›´é«˜çš„ç»´æŠ¤æˆæœ¬â€”â€”éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿åæ¶æ„å¥‘çº¦ä¼šå¯¼è‡´ç»´æŠ¤å·¥ä½œé‡å¢åŠ ï¼Œå¹¶é™ä½ä»£ç çš„å¯æ‰©å±•æ€§ã€‚</li>
<li>æ›´å¤æ‚çš„å•å…ƒæµ‹è¯•â€”â€”å¯¹ä½çº§ç»„ä»¶çš„æ— é™åˆ¶è®¿é—®ä½¿æµ‹è¯•å˜å¾—å¤æ‚ï¼Œå› ä¸ºä¾èµ–é¡¹å¯èƒ½ä¼šä»¥éé¢„æœŸçš„æ–¹å¼ä½¿ç”¨ã€‚</li>
</ol>


<p>ç¼“è§£ä¸Šè¿°é£é™©çš„å”¯ä¸€æ–¹æ³•æ˜¯å°†èŒè´£è¿›ä¸€æ­¥æ‹†åˆ†æˆæ›´å¤šç‹¬ç«‹çš„å±‚å’Œæ¨¡å—ã€‚æ•°æ®æ¨¡å—åº”ç»§ç»­åŒ…å« API å’Œæ•°æ®å­˜å‚¨çš„å®ä¾‹ï¼Œä½†æ‰€æœ‰å­˜å‚¨åº“æ¥å£éƒ½åº”ç§»å‡ºã€‚å»ºè®®åœ¨é¢†åŸŸæ¨¡å—å†…åˆ›å»ºå­æ¨¡å—ï¼Œå¹¶ç¡®ä¿å®ƒä»¬ä¿æŒç‹¬ç«‹ã€‚</p>

<p>æ­¤å¤–ï¼ŒAPI å’Œæ•°æ®åº“å®ä¾‹å¯ä»¥é€šè¿‡ä¸“ç”¨æœåŠ¡å±‚ï¼ˆä¾‹å¦‚ API æœåŠ¡å’Œæœ¬åœ°å­˜å‚¨æœåŠ¡ï¼‰è®¿é—®ã€‚è¿™ä¸ä»…å¢å¼ºäº†å¯æµ‹è¯•æ€§ï¼Œè¿˜å¼ºåˆ¶æ‰§è¡Œäº†é€‚å½“çš„æŠ½è±¡ã€‚æ­¤å¤–ï¼Œæ•°æ®å®ä½“åº”æ”¾ç½®åœ¨æ•°æ®å­æ¨¡å—ä¸­ï¼Œè¿™äº›å­æ¨¡å—ä»ä¸åŸŸå±‚ä¿æŒè¿æ¥ã€‚</p>

<p>é€šè¿‡éµå¾ªè¿™ç§æ–¹æ³•ï¼Œæ‰€æœ‰ç»„ä»¶ä»…é€šè¿‡å„è‡ªçš„æ¥å£è¿›è¡Œäº¤äº’ï¼Œè€Œæ— éœ€ç›´æ¥äº†è§£å®ƒä»¬çš„å®é™…å®ç°ã€‚è¿™ç¡®ä¿äº†æ›´å¥½çš„æ¨¡å—åŒ–ã€å¯ç»´æŠ¤æ€§ï¼Œå¹¶éµå¾ªäº†æ•´æ´æ¶æ„åŸåˆ™ã€‚</p>

<p>ä¸‹å›¾å±•ç¤ºäº†æ”¹è¿›çš„è§£å†³æ–¹æ¡ˆï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6pQ1HngSx6WIwaZx" alt="å›¾ 2. å¢å¼ºå‹ Android Clean Architecture å®ç°" /></p>

<p>ä»¥ä¸‹é¡¹ç›®ç»“æ„è¯´æ˜äº†å¢å¼ºçš„æ¶æ„ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>- Data
</span><span class='line'>  API Interface <span class="o">(</span>Retrofit<span class="o">)</span>
</span><span class='line'>  DAO
</span><span class='line'>  Data Services
</span><span class='line'>  API Services
</span><span class='line'>  Repositories implementations of Domain.Repository
</span><span class='line'>- Domain
</span><span class='line'>  Use-cases
</span><span class='line'>  Domain Entities
</span><span class='line'>  Mappers from Network models to Domain ones
</span><span class='line'>  -- Repository
</span><span class='line'>     Repository Interface
</span><span class='line'>     API Entity
</span><span class='line'>- Presentation
</span><span class='line'>  ViewModels
</span><span class='line'>  Views
</span></code></pre></td></tr></table></div></figure>


<h3>é‡æ–°å¼€å§‹ç¼–ç </h3>

<p>ç°åœ¨ï¼Œæˆ‘ä»¬å°†é‡ç‚¹å…³æ³¨æ¶æ„çš„æ”¹è¿›éƒ¨åˆ†ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥åœ¨ GitHub ä¸Šæ‰¾åˆ°å®Œæ•´çš„ç¤ºä¾‹ã€‚</p>

<h4>Domain.Repository å­æ¨¡å—ï¼š</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Data Module:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">DataRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">dataNetworkApi</span><span class="p">:</span> <span class="n">DataNetworkApi</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">(</span><span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span>
</span><span class='line'>       <span class="n">dataNetworkApi</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Domain Module:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetDataUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">DataEntityMapper</span><span class="p">,</span>
</span><span class='line'>   <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">DataRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetDataUseCase</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DataEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>       <span class="n">repository</span><span class="p">.</span><span class="n">getData</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span><span class='line'>           <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">listOfData</span> <span class="p">-&gt;</span>
</span><span class='line'>               <span class="n">listOfData</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">data</span> <span class="p">-&gt;</span> <span class="n">mapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>           <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»“è®º</h2>

<p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬å®ç°äº†å¢å¼ºç‰ˆçš„æ•´æ´æ¶æ„ã€‚é€»è¾‘å¯ä»¥æŒ‰åŠŸèƒ½è¿›ä¸€æ­¥åˆ’åˆ†ï¼Œæ¯ä¸ªåŠŸèƒ½æ¨¡å—éƒ½éµå¾ªå…¶è‡ªèº«çš„æ•´æ´æ¶æ„ç»“æ„ã€‚æ­¤å¤–ï¼Œè¿™ç§åˆ’åˆ†å¯ä»¥æ‰©å±•åˆ°å±•ç°å±‚ï¼Œç¡®ä¿é¢†åŸŸå±‚å’Œå±•ç°å±‚ä¹‹é—´çš„ç•Œé™æ¸…æ™°åŒºåˆ†ã€‚è¿™ç§æ–¹æ³•å…è®¸ UIç”¨ä¾‹ä¸¥æ ¼é€šè¿‡æ¥å£ä¸é¢†åŸŸç”¨ä¾‹äº¤äº’ï¼Œä»è€Œä¿æŒæ¨¡å—åŒ–å’Œå¯æ‰©å±•æ€§ã€‚</p>

<h2>é¢å¤–æ³¨æ„äº‹é¡¹</h2>

<p>é¡¹ç›®ç¤ºä¾‹æ¼”ç¤ºäº†è¿™ç§æ–¹æ³•ã€‚é€šè¿‡å®ç°äº†ä¸€ä¸ªç®€å•çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è¿›è¡Œ API è°ƒç”¨ã€æ¥æ”¶æ•°æ®å¹¶æ˜¾ç¤ºåˆ—è¡¨ã€‚ä¸ºäº†ä½¿åº”ç”¨ç¨‹åºåŠŸèƒ½é½å…¨ï¼Œå®ƒè¿˜ä½¿ç”¨äº†æœ¬æ–‡æœªæ¶‰åŠçš„å…¶ä»–ç»„ä»¶ï¼šRetrofitã€Hilt ä»¥åŠåŒ…å«é€šç”¨ç»„ä»¶çš„æ ¸å¿ƒæ¨¡å—ã€‚è¿™äº›é¢å¤–ç»„ä»¶ä¸ä¼šå½±å“ä½ å¯¹æœ¬æ–‡ä¸»é¢˜çš„ç†è§£ã€‚</p>

<p>å®Œæ•´å®ä¾‹ä»£ç ï¼š<a href="https://github.com/sergeykrupenich/TestRepo/tree/clean-architecture">https://github.com/sergeykrupenich/TestRepo/tree/clean-architecture</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[é•¿é©»UIå…ƒç´ çš„UIå±‚ä½“ç³»ç»“æ„]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/07/ui-layer-architecture/"/>
    <updated>2025-06-07T22:47:48+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/07/ui-layer-architecture</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒUI layer architecture for persistent UI elementsã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://www.tunjid.com/articles/ui-layer-architecture-for-persistent-ui-elements-68248e8ecc8e85f53ce1aa46">https://www.tunjid.com/articles/ui-layer-architecture-for-persistent-ui-elements-68248e8ecc8e85f53ce1aa46</a>ï¼Œç”±TJ Dahunsi</p>

<p>å‘å¸ƒäº2025å¹´5æœˆ14æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/07/ui-layer-architecture/"><img src="file:///Users/alexhilton/Downloads/navi.png" title="auto auto" ></a></p>

<!-- more -->


<p>åœ¨ç§»åŠ¨åº”ç”¨ä¸­ï¼ŒæŸäº› UI å…ƒç´ ä¼šåœ¨å¤šç§ä¸Šä¸‹æ–‡ä¸­è´¯ç©¿æ•´ä¸ªç”¨æˆ·ç•Œé¢ã€‚å¯¹äºç”¨äºå¯¼èˆªçš„ UI å…ƒç´ å°¤å…¶å¦‚æ­¤ï¼Œä¾‹å¦‚ï¼š</p>

<ol>
<li>å¯¼èˆªæ å’Œå¯¼èˆªæ ã€‚</li>
<li>é¡¶éƒ¨å’Œåº•éƒ¨åº”ç”¨æ ã€‚</li>
<li>æµ®åŠ¨æ“ä½œæŒ‰é’®ã€‚</li>
</ol>


<p>åœ¨ä¸ºè¿™äº›å±å¹•æ„å»º UI æ—¶ï¼Œé€šå¸¸æœ‰ä¸¤ç§å¸ƒå±€æ–¹å¼ï¼š</p>

<ol>
<li>æ ¹çº§ UI å…ƒç´ ï¼šæ•´ä¸ªåº”ç”¨åœ¨æ ¹çº§è„šæ‰‹æ¶å¸ƒå±€ä¸­å…±äº«è¿™äº›å…ƒç´ çš„å•ä¸ªå®ä¾‹ã€‚åœ¨ Android ä¸Šï¼Œè¿™é€šå¸¸å¤„äº Activity æˆ– NavHostFragment çº§åˆ«ã€‚</li>
<li>æ¯ä¸ªå±å¹•çš„ UI å…ƒç´ ï¼šæ¯ä¸ªå¯¼èˆªç›®æ ‡è´Ÿè´£ç»˜åˆ¶è‡ªå·±çš„ UI å…ƒç´ ã€‚</li>
</ol>


<p>å› æ­¤ï¼Œé—®é¢˜æ˜¯ï¼Œä¸€ç§æ–¹æ³•é€šå¸¸æ¯”å¦ä¸€ç§æ›´å¥½å—ï¼Ÿå®ƒä»¬å¯ä»¥å…±å­˜å—ï¼Ÿä»¤äººæ»¡æ„çš„æ˜¯ï¼Œæˆ‘è®¤ä¸ºè¿™æ˜¯ç»å…¸çš„è½¯ä»¶å·¥ç¨‹â€œè§†æƒ…å†µè€Œå®šâ€ç­”æ¡ˆä¸é€‚ç”¨çš„å°‘æ•°æƒ…å†µä¹‹ä¸€ã€‚æˆ‘åšä¿¡ï¼Œå¯¹äº Jetpack Compose åº”ç”¨ï¼Œåº”è¯¥å§‹ç»ˆä¼˜å…ˆé‡‡ç”¨æ¯ä¸ªå±å¹•çš„ UI å…ƒç´ æ–¹æ³•ã€‚è®©æˆ‘ä»¬ç®€è¦å›é¡¾ä¸€ä¸‹è¿‡å»ã€‚</p>

<h2>æ ¹çº§ UI å…ƒç´ </h2>

<p>åœ¨ Android ä¸Šï¼Œæ ¹çº§ UI å…ƒç´ çš„èµ·æºå¯ä»¥è¿½æº¯åˆ°æœ€åˆçš„ Activity ActionBar API ä»¥åŠéšåå¼•å…¥çš„ Fragment APIã€‚Fragment å¯ä»¥è°ƒç”¨ï¼š</p>

<ol>
<li>getSupportActionBar() åœ¨å…¶çˆ¶ Activity ä¸­è®¾ç½®æ ‡é¢˜å’Œå…¶ä»– ActionBar å±æ€§ã€‚</li>
<li>setHasOptionsMenu() åœ¨å…¶çˆ¶ Activity ä¸­æ›´æ–°èœå•é¡¹ã€‚</li>
</ol>


<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/action-bar.png" alt="ç»å…¸çš„ActionBar" /></p>

<p>ç”±äº Activity æ‹¥æœ‰ ActionBarï¼Œè¿™éšå¼åœ°å»ºç«‹äº†å±‚çº§å…³ç³»ã€‚è¿™ä¸è½¬å‘å• Activity æ¶æ„ç›¸ç»“åˆï¼Œä¸ºåœ¨æŸä¸ªæ ¹çº§åˆ«ç®¡ç†é¡¶çº§è£…é¥°ï¼ˆä¾‹å¦‚æµ®åŠ¨æ“ä½œæŒ‰é’®ã€AppBar å’Œå¯¼èˆªæ ï¼‰å¥ å®šäº†åŸºè°ƒã€‚å½“ç„¶ï¼Œè¿™æœ‰åˆ©æœ‰å¼Šï¼š</p>

<h3>ä¼˜ç‚¹</h3>

<ul>
<li>çœŸæ­£çš„æŒä¹…æ€§ï¼šUI å…ƒç´ æ˜¯åŒä¸€ä¸ªå®ä¾‹ï¼Œä¿è¯äº†è§†è§‰ä¸€è‡´æ€§ï¼Œæ— éœ€åœ¨å®ä¾‹ä¹‹é—´è¿›è¡Œå¤æ‚çš„è¿‡æ¸¡ã€‚è¿™å¯¹äºä½¿ç”¨æµ®åŠ¨æ“ä½œæŒ‰é’®çš„åº”ç”¨å°¤å…¶æœ‰åˆ©ï¼Œå› ä¸ºå±å¹•è¿‡æ¸¡ä¸ä¼šå› ä¸ºæ¯ä¸ªå±å¹•ä½¿ç”¨ä¸åŒçš„ FAB å®ä¾‹è€Œå¼•å…¥ UI/UX å™ªéŸ³ã€‚</li>
</ul>


<h3>ç¼ºç‚¹</h3>

<ul>
<li>ç´§å¯†è€¦åˆï¼šå±å¹•ä¸å®¿ä¸» Activity çš„å®ç°ç»†èŠ‚å’Œæ¡†æ¶ API ç´§å¯†è€¦åˆã€‚</li>
<li>å¤æ‚çš„çŠ¶æ€ç®¡ç†ï¼šå®¿ä¸» Activity æˆä¸ºç“¶é¢ˆï¼Œéœ€è¦å¤æ‚çš„é€»è¾‘æ¥æ›´æ–°æ¯ä¸ªç‰¹å®šå±å¹•çš„æ ‡é¢˜ã€èœå•é€‰é¡¹ã€FAB å¯è§æ€§/å›¾æ ‡/æ“ä½œï¼Œå°¤å…¶æ˜¯åœ¨å±å¹•è¿›è¡ŒåŠ¨ç”»å¤„ç†æ—¶ã€‚è¿™ä¼šå¯¼è‡´æ‰©å±•æ€§ä¸ä½³ã€‚</li>
<li>çµæ´»æ€§å—é™ï¼šæ›´æ”¹å·¥å…·æ æ ·å¼ã€åœ¨ç‰¹å®šå±å¹•ä¸Šå½»åº•ç§»é™¤å·¥å…·æ æˆ–å¤„ç†è¾¹ç¼˜æƒ…å†µï¼ˆå¦‚æœä¸ç»™ä¸»æœºå¢åŠ æ›´å¤šæ¡ä»¶å¤æ‚æ€§ï¼‰å˜å¾—å›°éš¾ã€‚</li>
<li>æµ‹è¯•æŒ‘æˆ˜ï¼šç”±äºå±å¹•ä¾èµ–äºä¸»æœº Activity æä¾›å¿…è¦çš„ UI ç»„ä»¶å’Œé…ç½®é’©å­ï¼Œå› æ­¤å•ç‹¬æµ‹è¯•å±å¹•å˜å¾—æ›´åŠ å›°éš¾ã€‚</li>
</ul>


<h2>æ¯ä¸ªå±å¹•çš„ UI å…ƒç´ </h2>

<p>æ ¹çº§ UI å…ƒç´ çš„å¼Šç«¯éå¸¸ä¸¥é‡ï¼Œä»¥è‡³äº fragment çš„ setHasOptionsMenu() æ–¹æ³•åœ¨ 2022 å¹´è¢«å¼ƒç”¨ã€‚å°½ç®¡ MenuHost å’Œ MenuProvider API ä¸­æä¾›äº†æ›¿ä»£æ–¹æ¡ˆï¼Œä½†è¿™ä¸»è¦æ˜¯ä¸ºäº†ä¿æŒå‘åå…¼å®¹æ€§ã€‚</p>

<p>è‡³å…³é‡è¦çš„æ˜¯ï¼ŒJetpack Compose å·²ç»å‘å¸ƒäº† 1.1.1 ç‰ˆæœ¬ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰æä¾› ActionBar æˆ–ç±»ä¼¼ MenuHost çš„ APIã€‚äº‹å®ä¸Šï¼Œæœ€æ¥è¿‘äºæä¾›å¦‚ä½•ç®¡ç†å¯¼èˆªç›®çš„åœ°é€šç”¨æ¡†æ¶åŠŸèƒ½çš„ API æ˜¯ Scaffold å¯ç»„åˆç»„ä»¶ã€‚æœ‰è¶£çš„æ˜¯ï¼Œå®ƒï¼š</p>

<ul>
<li>material3 Compose åº“ä¸­çš„ä¸€ä¸ªè‡ªæˆä½“ç³»çš„å®ç°ã€‚</li>
<li>æ˜¯ä¸€ä¸ªåŸºäºæ¯ä¸ªå±å¹•çš„ UI å…ƒç´ å®ç°ï¼Œä¸ºåº”ç”¨æ ã€æµ®åŠ¨æ“ä½œæŒ‰é’®ç­‰æä¾›æ’æ§½ã€‚</li>
<li>éšå¼åœ°é¼“åŠ±åº”ç”¨ä¸­çš„å¯¼èˆªç›®çš„åœ°æ›¿æ¢æ•´ä¸ªå±å¹•å†…å®¹ï¼ŒåŒ…æ‹¬å…¶ç‰¹å®šçš„åº”ç”¨æ ã€æµ®åŠ¨æ“ä½œæŒ‰é’®ç­‰ã€‚</li>
</ul>


<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/scaffold_resized.png" alt="Now In Android åº”ç”¨ä¸­è„šæ‰‹æ¶" /></p>

<p>åŒæ ·ï¼Œæˆ‘ä»¬å¯ä»¥åˆ—å‡ºä¼˜ç¼ºç‚¹ï¼š</p>

<h3>ä¼˜ç‚¹</h3>

<ul>
<li>å°è£…å’Œæ¨¡å—åŒ–ï¼šæ¯ä¸ªå¯¼èˆªç›®çš„åœ°éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œå¹¶ç®¡ç†å…¶è‡ªèº«çš„UIå…ƒç´ åŠå…¶çŠ¶æ€ã€‚è¿™ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™ã€‚</li>
<li>é«˜åº¦çµæ´»æ€§ï¼šå¯¼èˆªç›®çš„åœ°å¯ä»¥è½»æ¾è‡ªå®šä¹‰æŒä¹…UIå…ƒç´ ï¼Œè€Œä¸ä¼šå½±å“å…¶ä»–å…ƒç´ ã€‚éœ€è¦å®Œå…¨è‡ªå®šä¹‰çš„åº”ç”¨æ ï¼Ÿæ²¡é—®é¢˜ã€‚ä¸éœ€è¦æµ®åŠ¨æ“ä½œæŒ‰é’®ï¼Ÿé‚£å°±ä¸è¦æ·»åŠ å®ƒã€‚</li>
<li>ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼šUIçŠ¶æ€ï¼ˆæ ‡é¢˜ã€èœå•é¡¹ã€å¯¼èˆªæ çŠ¶æ€ï¼‰åœ¨å±å¹•çš„ViewModelæˆ–å¯ç»„åˆçŠ¶æ€ä¸­è¿›è¡Œæœ¬åœ°ç®¡ç†ï¼Œä½¿å…¶æ›´æ˜“äºæ¨ç†ã€‚</li>
<li>æé«˜å¯æµ‹è¯•æ€§ï¼šå¯¼èˆªç›®çš„åœ°å¯ä»¥æ›´è½»æ¾åœ°è¿›è¡Œç‹¬ç«‹æµ‹è¯•ã€‚</li>
<li>è§£è€¦ï¼šå¯¼èˆªç›®çš„åœ°ä¸å®¿ä¸»Activityåœ¨è¿™äº›ç‰¹å®šçš„UIå…ƒç´ æ–¹é¢è§£è€¦ã€‚</li>
</ul>


<h3>ç¼ºç‚¹</h3>

<ul>
<li>ä»£ç é‡å¤ï¼šå¦‚æœæ²¡æœ‰é€‚å½“çš„ç»“æ„åŒ–ï¼Œå¯¼èˆªç›®çš„åœ°ä¹‹é—´å¯èƒ½ä¼šé‡å¤ä½¿ç”¨å¸¸ç”¨çš„UIå…ƒç´ ã€‚</li>
<li>æ²‰æµ¸æ„Ÿå—æŸï¼šè¦ä½¿ç›¸åŒçš„åº”ç”¨æ æˆ–æµ®åŠ¨æ“ä½œæŒ‰é’®åœ¨å±å¹•ä¹‹é—´é¡ºåˆ©ä¿æŒ/è½¬æ¢ï¼Œéœ€è¦æ˜ç¡®çš„è¿‡æ¸¡å¤„ç†ã€‚</li>
</ul>


<h2>æŒä¹… UI çš„ UI å±‚æ¶æ„</h2>

<p>é€šè¿‡æ¯”è¾ƒè¿™ä¸¤ç§å®ç°æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºè¿™æ ·çš„å°è±¡ï¼šæ— è®ºæˆ‘ä»¬åœ¨ Compose ä¸­ä½¿ç”¨æ¯ä¸ªå±å¹•çš„ UI æ¥é™ä½å¤æ‚æ€§æ–¹é¢è·å¾—äº†ä»€ä¹ˆå¥½å¤„ï¼Œæˆ‘ä»¬éƒ½éœ€è¦ä»˜å‡ºä»£ä»·æ‰èƒ½åœ¨ UX ä¸­çœŸæ­£ä¼ è¾¾å‡º UI å…ƒç´ æ˜¯æŒä¹…çš„ï¼Œå¦‚ä¸‹é¢çš„å±å¹•è®°å½•æ‰€ç¤ºã€‚</p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/noise_cropped.gif" alt="Bluesky åº”ç”¨ç¨‹åºä¸­çš„å¤šä¸ª FAB" /></p>

<p>ä¸è¿‡ï¼Œæœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼šCompose å…±äº«å…ƒç´ è¿‡æ¸¡å’ŒåŠ¨ç”»ä¿®æ”¹å™¨ APIï¼Œä»¥åŠç²¾å¿ƒè®¾è®¡çš„ UI å±‚æ¶æ„ã€‚</p>

<h3>æŒä¹…åŒ– UI å’Œ UI é€»è¾‘</h3>

<p>ä¸Šè¿°åŠ¨ç”» API çš„å…¥å£ç‚¹ä½äºå®ƒä»¬æä¾›çš„ä½œç”¨åŸŸä¸­ï¼šSharedTransitionScope å’Œ AnimatedVisibilityScopeã€‚å¯¹äºå¯¼èˆªç›®çš„åœ°è¿‡æ¸¡ï¼Œä¸¤è€…å‡ ä¹æ€»æ˜¯ä¸²è”ä½¿ç”¨ï¼Œå› æ­¤åˆ›å»ºä¸€ä¸ªç»§æ‰¿è‡ªä¸¤è€…çš„ UI é€»è¾‘çŠ¶æ€æŒæœ‰è€…éå¸¸æœ‰ç”¨ã€‚æˆ‘ä¸ªäººå–œæ¬¢å°†å…¶ç§°ä¸º ScaffoldStateã€‚æ­¤ ScaffoldState åº”è¯¥ä½äºä¸€ä¸ªå…¬å…±æ¨¡å—ä¸­ï¼Œåº”ç”¨ä¸­æ‰€æœ‰æ˜¾ç¤ºå¯¼èˆªç›®çš„åœ°çš„æ¨¡å—éƒ½å¯ä»¥è®¿é—®ã€‚æˆ‘é€šå¸¸å°†æ­¤æ¨¡å—ç§°ä¸ºè„šæ‰‹æ¶ã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> è¯·å‹¿å°†æ­¤å¤„æåˆ°çš„ ScaffoldState ä¸åŸå§‹ Material Compose åº“ä¸­çš„ ScaffoldState æ··æ·†ã€‚å®ƒæ˜¯ä¸€ä¸ªé—ç•™å®ç°ï¼Œåœ¨ Compose Material3 ä¸­æ²¡æœ‰ç­‰æ•ˆå®ç°ã€‚</p>

<p>ScaffoldState çš„å®šä¹‰å¯ä»¥ç®€å•å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ScaffoldState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">animatedVisibilityScope</span><span class="p">:</span> <span class="n">AnimatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="n">sharedTransitionScope</span><span class="p">:</span> <span class="n">SharedTransitionScope</span><span class="p">,</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">isMediumScreenWidthOrWider</span><span class="p">:</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">AnimatedVisibilityScope</span> <span class="k">by</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SharedTransitionScope</span> <span class="k">by</span> <span class="n">sharedTransitionScope</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">canShowBottomNavigation</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">!</span><span class="n">isMediumScreenWidthOrWider</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">canShowNavRail</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">isMediumScreenWidthOrWider</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>                                            <span class="c1">// implementation omitted</span>
</span><span class='line'>                                            <span class="p">&amp;&amp;</span> <span class="n">isAtDeviceEdge</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> canShowBottomNavigation å’Œ canShowNavRail å¹¶ä¸ä¸€å®šæ„å‘³ç€å®ƒä»¬å„è‡ªçš„ç•Œé¢å…ƒç´ ä¸€å®šä¼šæ˜¾ç¤ºï¼›è¿™å–å†³äºåœ¨è„šæ‰‹æ¶å†…å®é™…è°ƒç”¨ Composable çš„æƒ…å†µï¼ˆå¦‚ä¸‹æ‰€è¿°ï¼‰ã€‚ç›¸åï¼Œå®ƒä»¬å®šä¹‰äº†ç•Œé¢å…ƒç´ åœ¨è¢«è°ƒç”¨æ—¶èƒ½å¤Ÿæ˜¾ç¤ºçš„ç•Œé¢é€»è¾‘ã€‚</p>

<p>ScaffoldState æœ‰ä¸€ä¸ªå†…éƒ¨æ„é€ å‡½æ•°ï¼Œå…¶ä»–æ¨¡å—å¯èƒ½æ— æ³•åˆ›å»ºå®ƒã€‚ç›¸åï¼Œå®ƒä»¬ä¼šä½¿ç”¨åŒæ ·åœ¨ scaffold æ¨¡å—ä¸­å®šä¹‰çš„å®ç”¨æ–¹æ³•æ¥è®°ä½å®ƒåœ¨ç»„åˆä¸­çš„å®ä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberScaffoldState</span><span class="p">(</span>
</span><span class='line'>    <span class="n">animatedVisibilityScope</span><span class="p">:</span> <span class="n">AnimatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="n">sharedTransitionScope</span><span class="p">:</span> <span class="n">SharedTransitionScope</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ScaffoldState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isMediumScreenWidthOrWider</span> <span class="p">=</span> <span class="n">isMediumScreenWidthOrWider</span><span class="p">()</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ScaffoldState</span><span class="p">(</span>
</span><span class='line'>            <span class="n">animatedVisibilityScope</span> <span class="p">=</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">sharedTransitionScope</span> <span class="p">=</span> <span class="n">sharedTransitionScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isMediumScreenWidthOrWider</span> <span class="p">=</span> <span class="n">isMediumScreenWidthOrWider</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">isMediumScreenWidthOrWider</span><span class="p">():</span> <span class="n">State</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isMediumScreenWidthOrWider</span> <span class="p">=</span> <span class="n">currentWindowAdaptiveInfo</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">windowSizeClass</span>
</span><span class='line'>        <span class="p">.</span><span class="n">isWidthAtLeastBreakpoint</span><span class="p">(</span><span class="n">WindowSizeClass</span><span class="p">.</span><span class="n">WIDTH_DP_MEDIUM_LOWER_BOUND</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">rememberUpdatedState</span><span class="p">(</span><span class="n">isMediumScreenWidthOrWider</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šæ–‡ä¸­ï¼Œå®šä¹‰æ˜¾ç¤ºå“ªä¸ªå¯¼èˆª UI å…ƒç´ çš„ UI é€»è¾‘æ˜¯é€šè¿‡ ScaffoldState ä¸­çš„ WindowSizeClass å®ç°çš„ã€‚AnimatedVisibilityScope å’Œ SharedTransitionScope å‚æ•°è¢«æ˜¾å¼ä¼ å…¥ã€‚å‰è€…é€šå¸¸ç”±å¯¼èˆªåº“åœ¨å®šä¹‰ç›®çš„åœ°æ—¶æä¾›ï¼Œåè€…åˆ™ç”± CompositionLocal æˆ– prop drilling æä¾›ã€‚åé¢ä¼šä»‹ç» CompositionLocal çš„ä½¿ç”¨ç¤ºä¾‹ã€‚</p>

<h3>æŒä¹…åŒ– UI è„šæ‰‹æ¶</h3>

<p>é€šè¿‡å®šä¹‰è®°ä½ç»„åˆä¸­ ScaffoldState çš„æ–¹æ³•ï¼Œå®é™…çš„ PersistentScaffold Composable å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ScaffoldState</span><span class="p">.</span><span class="n">PersistentScaffold</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">topBar</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ScaffoldState</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'>    <span class="n">floatingActionButton</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ScaffoldState</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'>    <span class="n">navigationBar</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ScaffoldState</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'>    <span class="n">navigationRail</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ScaffoldState</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ScaffoldState</span><span class="p">.(</span><span class="n">PaddingValues</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NavigationRailScaffold</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">,</span>
</span><span class='line'>        <span class="n">navigationRail</span> <span class="p">=</span> <span class="n">navigationRail</span><span class="p">,</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Scaffold</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">animateBounds</span><span class="p">(</span><span class="n">lookaheadScope</span> <span class="p">=</span> <span class="k">this</span><span class="p">),</span>
</span><span class='line'>                <span class="n">topBar</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">topBar</span><span class="p">()</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="n">floatingActionButton</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">floatingActionButton</span><span class="p">()</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="n">bottomBar</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">navigationBar</span><span class="p">()</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="n">content</span> <span class="p">=</span> <span class="p">{</span> <span class="n">paddingValues</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">content</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> åœ¨ä¸Šé¢çš„å®šä¹‰ä¸­ï¼ŒæŒä¹… UI å…ƒç´ çš„æ¯ä¸ªå¯ç»„åˆæ’æ§½éƒ½ä»¥ ScaffoldState ä½œä¸ºæ¥æ”¶å™¨ï¼Œå¹¶ä¸”å½“ navigationRail æˆ– navigationBar éšè—æˆ–æ˜¾ç¤ºæ—¶ï¼Œä½¿ç”¨ Modifier.animateBounds() å¯¹ Scaffold è¿›è¡ŒåŠ¨ç”»å¤„ç†ã€‚</p>

<p>ä¸Šé¢ä½¿ç”¨äº†ä¸€ä¸ªä¸­é—´å¯ç»„åˆé¡¹ï¼šNavigationRailScaffoldã€‚è¿™åªæ˜¯ä¸€ä¸ªç®€å•çš„ Rowï¼ŒåŒ…å«ä¸¤ä¸ªé¡¹ç›®ï¼šnavigationRail å’Œ contentï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="n">inline</span> <span class="k">fun</span> <span class="nf">NavigationRailScaffold</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">navigationRail</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">,</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">widthIn</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="m">80.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">zIndex</span><span class="p">(</span><span class="m">2f</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">navigationRail</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">zIndex</span><span class="p">(</span><span class="m">1f</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">content</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> å¯¼èˆªè½¨é“çš„ z ç´¢å¼•æ¯”å†…å®¹æ›´é«˜ã€‚</p>

<p>é—æ†¾çš„æ˜¯ï¼ŒNavigationSuiteScaffold çš„ API é›†æ— æ³•åœ¨æ­¤å¤„ä½¿ç”¨ï¼Œå› ä¸ºä¸æ™®é€šçš„ Scaffold å¯ç»„åˆå‡½æ•°ä¸åŒï¼Œå®ƒä»¬ä¸å…è®¸é€šè¿‡æ’æ§½è®¿é—®æ„æˆè„šæ‰‹æ¶çš„æŒä¹…åŒ– UI å…ƒç´ ï¼Œå› æ­¤æ— æ³•å°† Modifier å®ä¾‹ä¼ é€’ç»™å®ƒä»¬ã€‚è¿™ä½¿å¾—æœ¬æ–‡çš„å…¶ä½™éƒ¨åˆ†ä¸é€‚ç”¨äº NavigationSuiteScaffoldã€‚</p>

<h3>æŒä¹…åŒ– UI å…ƒç´ ä½œä¸º UI é€»è¾‘çš„æ‰©å±•</h3>

<p>ä¸ºäº†è¥é€ è¿™äº› UI å…ƒç´ åœ¨å¯¼èˆªç›®æ ‡ä¹‹é—´æŒä¹…åŒ–çš„è§†è§‰æ•ˆæœï¼Œå¯ä»¥å°†è¿™äº› UI å…ƒç´ çš„å¯ç»„åˆå‡½æ•°ç¼–å†™ä¸º ScaffoldState çš„æ‰©å±•ï¼Œä»è€Œæä¾›å¯¹ SharedTransitionScope çš„è®¿é—®æƒé™ï¼Œä»¥ä¾¿ä¸ºå…ƒç´ æä¾›å…±äº«å…ƒç´ ä¿®é¥°ç¬¦ã€‚è¿™äº›å®šä¹‰ä¹Ÿåº”ä½äºè„šæ‰‹æ¶æ¨¡å—ä¸­ã€‚ä¾‹å¦‚ï¼ŒPersistentNavigationAppBar å¯ä»¥æ˜¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ScaffoldState</span><span class="p">.</span><span class="n">PersistentNavigationBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">enterTransition</span><span class="p">:</span> <span class="n">EnterTransition</span> <span class="p">=</span> <span class="n">slideInVertically</span><span class="p">(</span><span class="n">initialOffsetY</span> <span class="p">=</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}),</span>
</span><span class='line'>    <span class="n">exitTransition</span><span class="p">:</span> <span class="n">ExitTransition</span> <span class="p">=</span> <span class="n">slideOutVertically</span><span class="p">(</span><span class="n">targetOffsetY</span> <span class="p">=</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}),</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">RowScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">AnimatedVisibility</span><span class="p">(</span>
</span><span class='line'>       <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">sharedElement</span><span class="p">(</span>
</span><span class='line'>                <span class="n">sharedContentState</span> <span class="p">=</span> <span class="n">rememberSharedContentState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">BottomNavSharedElementKey</span>
</span><span class='line'>                <span class="p">),</span>
</span><span class='line'>                <span class="n">animatedVisibilityScope</span> <span class="p">=</span> <span class="k">this</span><span class="p">,</span>
</span><span class='line'>                <span class="n">zIndexInOverlay</span> <span class="p">=</span> <span class="n">BottomNavSharedElementZIndex</span><span class="p">,</span>
</span><span class='line'>            <span class="p">),</span>
</span><span class='line'>        <span class="n">visible</span> <span class="p">=</span> <span class="n">canShowBottomNavigation</span><span class="p">,</span>
</span><span class='line'>        <span class="n">enter</span> <span class="p">=</span> <span class="n">enterTransition</span><span class="p">,</span>
</span><span class='line'>        <span class="n">exit</span> <span class="p">=</span> <span class="n">exitTransition</span><span class="p">,</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">NavigationBar</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="n">data</span> <span class="k">object</span> <span class="nc">BottomNavSharedElementKey</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> canShowBottomNavigation æ˜¯ä» ScaffoldState è¯»å–çš„ï¼Œç”¨äº AnimatedVisibilityã€‚</p>

<p>å¯ä»¥ä¸ºå…¶ä»–æŒä¹…æ€§ UI å…ƒç´ ï¼ˆä¾‹å¦‚å¯¼èˆªæ æˆ–æµ®åŠ¨æ“ä½œæŒ‰é’®ï¼‰ç¼–å†™åŒç±»æ‰©å±•ã€‚åŠŸèƒ½æ¨¡å—å¯ä»¥ä¾èµ–äºè„šæ‰‹æ¶æ¨¡å—ï¼Œå¹¶æŒ‰å¦‚ä¸‹æ–¹å¼ä½¿ç”¨è„šæ‰‹æ¶ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">FeedRoute</span><span class="p">(</span>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">:</span> <span class="n">ListingFeedViewModel</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">//ä»å¯¼èˆªåº“ä¸­è·å–ã€‚</span>
</span><span class='line'>    <span class="c1">// åœ¨ Navigation Compose ä¸­ï¼Œå®ƒç”±composable&lt;Destination&gt; { } lambda æä¾›ã€‚</span>
</span><span class='line'>    <span class="n">animatedVisibilityScope</span><span class="p">:</span> <span class="n">AnimatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// ä»å¯¼èˆªç›®çš„åœ°å£°æ˜ä¸­ä¼ é€’ã€‚</span>
</span><span class='line'>    <span class="n">sharedTransitionScope</span><span class="p">:</span> <span class="n">SharedTransitionScope</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span> <span class="n">route</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">rememberScaffoldState</span><span class="p">(</span>
</span><span class='line'>        <span class="n">animatedVisibilityScope</span> <span class="p">=</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">sharedTransitionScope</span> <span class="p">=</span> <span class="n">sharedTransitionScope</span><span class="p">,</span>
</span><span class='line'>    <span class="p">).</span><span class="n">PersistentScaffold</span><span class="p">(</span>
</span><span class='line'>        <span class="n">topBar</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">TopAppBar</span><span class="p">(</span>
</span><span class='line'>                <span class="n">title</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="n">stringResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">listing_app</span><span class="p">))</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span> <span class="n">paddingValues</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">ListingFeedScreen</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">),</span>
</span><span class='line'>                <span class="n">scaffoldState</span> <span class="p">=</span> <span class="k">this</span><span class="p">,</span>
</span><span class='line'>                <span class="n">state</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">collectAsStateWithLifecycle</span><span class="p">().</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>                <span class="n">actions</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">accept</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">navigationBar</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>           <span class="n">PersistentNavigationAppBar</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">animateEnterExit</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">enter</span> <span class="p">=</span> <span class="n">slideInVertically</span><span class="p">(</span><span class="n">initialOffsetY</span> <span class="p">=</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}),</span>
</span><span class='line'>                        <span class="n">exit</span> <span class="p">=</span> <span class="n">slideOutVertically</span><span class="p">(</span><span class="n">targetOffsetY</span> <span class="p">=</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}),</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">navigationRail</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">PersistentNavigationNavRail</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ªä½¿ç”¨çš„ API ä»¥åŠå®ƒä»¬æ”¯æŒçš„ UI/UX å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/shared_elements_cropped.gif" alt="A" /></p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/navigation_changes_cropped.gif" alt="B" /></p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/local_changes_cropped.gif" alt="C" /></p>

<p>ä»ä¸Šåˆ°ä¸‹ï¼šè·¨å¯¼èˆªç›®çš„åœ°çš„æŒä¹… UI å…±äº«å…ƒç´ ã€è·¨å¯¼èˆªç›®çš„åœ°çš„æŒä¹… UI è¿›å…¥å’Œé€€å‡ºä»¥åŠåŒä¸€ç›®çš„åœ°å†…çš„æŒä¹… UI è¿›å…¥å’Œé€€å‡ºã€‚</p>

<p>å¦‚ä¸Šè¡¨æ‰€ç¤ºï¼Œä½¿ç”¨ ScaffoldState ä½œä¸ºç•Œé¢çŠ¶æ€å®¹å™¨ï¼Œå¯ä»¥æ ¹æ® Jetpack Compose åŠ¨ç”» API çš„ä¼˜åŠ¿è¿›è¡Œå®šåˆ¶ï¼ŒåŒæ—¶å°†å®ƒä»¬ç»„åˆæˆä¸€ä¸ªæ•´ä½“ã€‚æ›´è¯¦ç»†åœ°è¯´ï¼š</p>

<ol>
<li>ScaffoldState å’Œ Modifier.sharedElement()ï¼šåœ¨ä¸åŒå¯¼èˆªç›®æ ‡ä¸Šè°ƒç”¨çš„æŒä¹…åŒ–ç•Œé¢å…ƒç´ å°†ä½¿ç”¨å…±äº«å…ƒç´  API æ¥ä¿æŒè§†è§‰è¿ç»­æ€§ã€‚åœ¨æ‰€ç¤ºçš„ç¤ºä¾‹ä¸­ï¼Œæ¯ä¸ªå¯¼èˆªç›®æ ‡éƒ½è´Ÿè´£å…¶è‡ªèº«çš„æµ®åŠ¨æ“ä½œæŒ‰é’®ï¼Œä½†ä»ä¿æŒäº†æŒä¹…åŒ–çš„æ•ˆæœã€‚åœ¨æ­¤ç‰¹å®šç¤ºä¾‹ä¸­ï¼Œå›¾åº“ç›®æ ‡è„šæ‰‹æ¶ä¸è¯¦æƒ…ç›®æ ‡å®Œå…¨ç›¸åŒï¼Œåªæ˜¯å®ƒä½¿ç”¨ä¸åŒçš„å‚æ•°è°ƒç”¨ PersistentFabã€‚</li>
<li>ScaffoldState å’Œ AnimatedContentï¼šæŒä¹…åŒ–ç•Œé¢å…ƒç´ çš„è°ƒç”¨å¯ä»¥ä½¿ç”¨ Modifier.animateEnterExit() æ¥å®šä¹‰ EnterTransition å’Œ/æˆ– ExitTransition æ¥ç”¨äºå¯¼èˆªæ›´æ”¹ã€‚åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒæŒä¹…åŒ–å¯¼èˆªæ é€šè¿‡å‚ç›´æ»‘åŠ¨æ¥åŠ¨ç”»åŒ–åœ°æ˜¾ç¤ºå’Œéšè—ã€‚åœ¨æ­¤ç‰¹å®šç¤ºä¾‹ä¸­ï¼Œè¯¦æƒ…ç›®æ ‡è„šæ‰‹æ¶ä¸åŠ¨æ€ç›®æ ‡å®Œå…¨ç›¸åŒï¼Œä½†ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š</li>
<li>ä¸è°ƒç”¨ PersistentNavigationAppBarã€‚</li>
<li>è°ƒç”¨ PersistentFabã€‚</li>
<li>ScaffoldStateã€AnimatedVisibility å’Œ Modifier.animateBounds()ï¼šè°ƒç”¨ PersistentNavigationAppBar å’Œ/æˆ– PersistentNavigationNavRail ä¼šæ ¹æ®å½“å‰ WindowSizeClassï¼ˆå³æœ¬åœ°å±å¹•å˜åŒ–ï¼‰è‡ªåŠ¨éšè—æˆ–æ˜¾ç¤ºã€‚å½“å…¶ä¸­ä¸€ä¸ªæ˜¾ç¤ºæˆ–éšè—æ—¶ï¼Œå†…å®¹å¯ç»„åˆé¡¹ä¼šæ ¹æ®å˜åŒ–è°ƒæ•´å…¶å¤§å°å’Œä½ç½®ã€‚ç”¨æˆ·è¿˜å¯ä»¥ç›´æ¥å°† EnterTransition æˆ– ExitTransition ä¼ é€’ç»™å¯ç»„åˆé¡¹æ¥è‡ªå®šä¹‰åŠ¨ç”»ã€‚</li>
</ol>


<h3>æŒä¹…çš„ UI å’Œä¸šåŠ¡é€»è¾‘</h3>

<p>åƒå¯¼èˆªæ æˆ–å¯¼èˆªæ è¿™æ ·çš„æŒä¹…æ€§ UI æœ‰æ—¶éœ€è¦æ˜¾ç¤ºä¸å…¶æœ¬åœ°ä¸Šä¸‹æ–‡ç›¸è·ç”šè¿œçš„çŠ¶æ€ï¼›è¿™å°±æ˜¯ä¸šåŠ¡é€»è¾‘ã€‚æœ‰æ—¶ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½ä½äºä¸åŒçš„æ¨¡å—ä¸­ã€‚ä¾‹å¦‚ï¼š</p>

<ul>
<li>æœªæ˜¾ç¤ºé€šçŸ¥çš„é€šçŸ¥æ ‡è®°ã€‚</li>
<li>æ¶ˆæ¯çš„æœªè¯»è®¡æ•°ã€‚</li>
<li>ç”¨æˆ·ä¸ªäººèµ„æ–™è­¦æŠ¥æˆ–æé†’ã€‚</li>
</ul>


<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ çš„åº”ç”¨åº”è¯¥å®šä¹‰ä¸€ä¸ª AppStateã€‚åœ¨ Now In Android ç¤ºä¾‹ä¸­ï¼Œè¿™ä¸ª AppState æ˜¯ NiaAppStateã€‚åœ¨è·¨å¯¼èˆªç›®æ ‡ä½¿ç”¨æŒä¹…æ€§ UI æ—¶ï¼Œè¿™ä¸ª AppState è‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒå¯ä»¥è®¿é—®åº”ç”¨çš„å¯¼èˆªè¯­ä¹‰ä»¥åŠå¡«å……å¯¼èˆªæ ä¸­å½“å‰é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰èµ„æºã€‚æœ€ç®€å•çš„ AppState å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AppState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">navigationStateHolder</span><span class="p">:</span> <span class="n">NavigationStateHolder</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">navState</span> <span class="k">by</span> <span class="n">navigationStateHolder</span><span class="p">.</span><span class="n">state</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lateinit</span> <span class="k">var</span> <span class="py">sharedTransitionScope</span><span class="p">:</span> <span class="n">SharedTransitionScope</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">navItems</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">NavItem</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">navItemsFrom</span><span class="p">(</span><span class="n">navState</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> åœ¨ä¸Šé¢ï¼Œå¯¼èˆªçŠ¶æ€ç”± Compose çŠ¶æ€æ”¯æŒï¼Œä½†æ˜¯å½“ä½¿ç”¨å¸¦æœ‰ NavigationController çš„å¯¼èˆª API æ—¶ï¼Œè¿™ä»ç„¶é€‚ç”¨ã€‚</p>

<p>AppState æ˜¯åº”ç”¨å±‚çº§æœåŠ¡çš„å…¥å£ç‚¹ã€‚åº”ç”¨çš„å¯¼èˆªçŠ¶æ€ã€åº”ç”¨èƒ½å¤Ÿæ˜¾ç¤ºçš„çª—æ ¼æ•°é‡ç­‰ç­‰éƒ½é©»ç•™åœ¨ AppState ä¸­ã€‚å®ƒå¯èƒ½éœ€è¦è®¿é—®ä¸šåŠ¡é€»è¾‘ï¼Œå¹¶ä¸”é€šå¸¸éœ€è¦ä¾èµ–æ³¨å…¥çš„æ•°æ®æºã€‚åœ¨ Now In Android ç¤ºä¾‹ä¸­ï¼ŒNiaAppState ä½¿ç”¨æ•°æ®æºæ¥ç¡®å®šå“ªäº›é€‰é¡¹å¡å¸¦æœ‰é€šçŸ¥æ ‡è®°ã€‚</p>

<p>ä¸ºäº†ä» AppState ä¸ºæŒä¹…åŒ– UI å…ƒç´ æä¾›çŠ¶æ€ï¼ŒScaffoldState åº”è¯¥ä¾èµ– AppState ä½œä¸ºå†…éƒ¨å®ç°ç»†èŠ‚ï¼Œå¹¶ä½œä¸ºçŠ¶æ€æŒæœ‰è€…å¤åˆçš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ScaffoldState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">appState</span><span class="p">:</span> <span class="n">AppState</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">AnimatedVisibilityScope</span> <span class="k">by</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// ä» AppState ä¸­æ£€ç´¢ SharedTransitionScope</span>
</span><span class='line'>    <span class="n">SharedTransitionScope</span> <span class="k">by</span> <span class="n">appState</span><span class="p">.</span><span class="n">sharedTransitionScope</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">canShowNavRail</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">appState</span><span class="p">.</span><span class="n">isInEdgePane</span> <span class="p">&amp;&amp;</span> <span class="n">isMediumScreenWidthOrWider</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">val</span> <span class="py">LocalAppState</span> <span class="p">=</span> <span class="n">staticCompositionLocalOf</span><span class="p">&lt;</span><span class="n">AppState</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;AppState must be provided in the app scaffolding.&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¦æ£€ç´¢è¦ä½¿ç”¨çš„ AppStateï¼Œè„šæ‰‹æ¶æ¨¡å—ä¸­åº”è¯¥æœ‰ä¸€ä¸ªå†…éƒ¨ LocalAppState å®šä¹‰ä»¥åŠä¸€ä¸ª App Composableã€‚ç„¶åï¼Œæ­¤ AppState ä¼šåœ¨åº”ç”¨çš„å…¥å£ç‚¹æä¾›ç»™ç»„åˆæ ‘ï¼Œä»¥ä¾¿è¿›è¡Œ Composingã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">App</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">appState</span><span class="p">:</span> <span class="n">AppState</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AppTheme</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Surface</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// æ ¹ LookaheadScope ç”¨äºé”šå®šæ‰€æœ‰å…±äº«å…ƒç´ è½¬æ¢</span>
</span><span class='line'>            <span class="n">SharedTransitionLayout</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// ä½ å¯ä»¥é€‰æ‹©ä¿ç•™å¯¹ SharedElementTransitionScope çš„å¼•ç”¨</span>
</span><span class='line'>                <span class="n">appState</span><span class="p">.</span><span class="n">sharedElementTransitionScope</span> <span class="p">=</span> <span class="k">this</span><span class="n">@SharedTransitionLayout</span>
</span><span class='line'>                <span class="n">CompositionLocalProvider</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">LocalAppState</span> <span class="n">provides</span> <span class="n">appState</span><span class="p">,</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// åº”ç”¨ UI çš„å…¶ä½™éƒ¨åˆ†éƒ½æ”¾åœ¨è¿™é‡Œï¼Œä¾‹å¦‚ `NavHost`ï¼Œç­‰ç­‰ã€‚</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">val</span> <span class="py">LocalAppState</span> <span class="p">=</span> <span class="n">staticCompositionLocalOf</span><span class="p">&lt;</span><span class="n">AppState</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;CompositionLocal LocalAppState not present&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ Android åº”ç”¨ç¨‹åºä¸­ï¼Œä¸Šè¿°å†…å®¹å°†åœ¨æ´»åŠ¨ä¸­ä½¿ç”¨ï¼Œç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">enableEdgeToEdge</span><span class="p">()</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// åœ¨æ­¤å¤„åˆ›å»ºä½ çš„åº”ç”¨çŠ¶æ€ã€‚å¦‚æœå®ƒéœ€è¦ä¾èµ–æ³¨å…¥çš„æ•°æ®æº</span>
</span><span class='line'>        <span class="c1">// æˆ–è®¿é—®å¯¼èˆªæ§åˆ¶å™¨æˆ–å¯¼èˆªçŠ¶æ€ï¼Œä¹Ÿè¯·åœ¨æ­¤å¤„æä¾›æˆ–åœ¨ Composition ä¸­æä¾›ã€‚</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">appState</span><span class="p">:</span> <span class="n">AppState</span> <span class="p">=</span> <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">App</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>                <span class="n">appState</span> <span class="p">=</span> <span class="n">appState</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œç”¨äºè®°ä½ ScaffoldState çš„è°ƒç”¨ç«™ç‚¹å°†æ›´æ–°ä¸ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberScaffoldState</span><span class="p">(</span>
</span><span class='line'>    <span class="c1">// è¿™æ˜¯ç”±å¯¼èˆªåº“æä¾›çš„</span>
</span><span class='line'>    <span class="n">animatedVisibilityScope</span><span class="p">:</span> <span class="n">AnimatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ScaffoldState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isMediumScreenWidthOrWider</span> <span class="p">=</span> <span class="n">isMediumScreenWidthOrWider</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">appState</span> <span class="p">=</span> <span class="n">LocalAppState</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ScaffoldState</span><span class="p">(</span>
</span><span class='line'>            <span class="n">animatedVisibilityScope</span> <span class="p">=</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isMediumScreenWidthOrWider</span> <span class="p">=</span> <span class="n">isMediumScreenWidthOrWider</span><span class="p">,</span>
</span><span class='line'>            <span class="c1">// SharedTransitionScope ç°åœ¨ç”± AppState æä¾›</span>
</span><span class='line'>            <span class="n">appState</span> <span class="p">=</span> <span class="n">appState</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> LocalAppState åº”è¯¥ä½äºè„šæ‰‹æ¶æ¨¡å—å†…éƒ¨ã€‚</p>

<p>åªéœ€æŒ‡å®šè¦è¿è¡Œçš„ä¿®é¥°ç¬¦æˆ–è½¬æ¢å³å¯å£°æ˜ PersistentNavigationAppBarï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">ScaffoldState</span><span class="p">.</span><span class="n">PersistentNavigationAppBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AnimatedVisibility</span><span class="p">(</span>
</span><span class='line'>       <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">sharedElement</span><span class="p">(...),</span>
</span><span class='line'>        <span class="p">...,</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">NavigationBar</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">appState</span> <span class="p">=</span> <span class="n">LocalAppState</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>                <span class="n">appState</span><span class="p">.</span><span class="n">navItems</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">item</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">NavigationBarItem</span><span class="p">(...)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>çœŸæ­£çš„æŒä¹…åŒ– UI</h2>

<p>å¦‚æœæŒä¹…åŒ– UI å…ƒç´ ä¸­å­˜åœ¨ä¸€äº›æ— æ³•é€šè¿‡å…±äº«å…ƒç´ ä¿å­˜çš„å±€éƒ¨ç¬æ—¶çŠ¶æ€ï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¯ç§»åŠ¨å…±äº«å…ƒç´ ã€‚è¯·è€ƒè™‘æ­¤å¤„æè¿°å’Œå®ç°çš„å¯¼èˆªæ è®¾è®¡ï¼Œå…¶ä¸­é€‰ä¸­æŸä¸ªé€‰é¡¹å¡æ—¶ï¼Œé€‰é¡¹å¡ä¹‹é—´ä¼šå‘ˆç°åŠ¨ç”»æ•ˆæœï¼š</p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/transient_animation.gif" alt="å¯¼èˆªæ ä¸­çš„å±€éƒ¨ç¬æ€åŠ¨ç”»" /></p>

<p>å¹»æƒ³åªèƒ½åˆ°æ­¤ä¸ºæ­¢ï¼Œæ­¤æ—¶éœ€è¦çœŸæ­£çš„æŒä¹…æ€§ã€‚è¿™å¯ä»¥é€šè¿‡æ·»åŠ å¯ç§»åŠ¨å†…å®¹ API æ¥åˆ›å»ºå¯ç§»åŠ¨çš„å…±äº«å…ƒç´ æ¥å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶æ„å°†æå‡çš„ä¸ä»…ä»…æ˜¯ UI çŠ¶æ€ï¼Œè€Œæ˜¯æ•´ä¸ª UI å…ƒç´ åŠå…¶çŠ¶æ€ã€‚è¦äº†è§£æ›´å¤šå…³äºä¸ºä»€ä¹ˆæ­¤æ—¶éœ€è¦å¯ç§»åŠ¨å†…å®¹ API çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯»ä»¥ä¸‹è¯¦ç»†ä»‹ç»<a href="https://www.tunjid.com/articles/3-neat-animations-you-can-create-with-modifieranimatebounds-67e474130e9ba862fe18b5e5?open-graph-scrape=true">ç»„åˆæŒä¹…æ€§æ¦‚å¿µçš„æ–‡ç« </a>ã€‚</p>

<p>åœ¨ Compose ä¸­ä½¿ç”¨ movedContentOf æ—¶ï¼Œå¿…é¡»æ³¨æ„ç¡®ä¿å¯ç§»åŠ¨å†…å®¹æ¯æ¬¡åªåœ¨ä¸€ä¸ªä½ç½®è¿›è¡Œç»„åˆã€‚ä¾‹å¦‚ï¼Œä»ç›®çš„åœ° A å¯¼èˆªåˆ°ç›®çš„åœ° B æ—¶ï¼Œåœ¨åŠ¨ç”»æŒç»­æ—¶é—´å†…ï¼Œæœ‰ä¸¤ä¸ªç›®çš„åœ°å¯ç»„åˆé¡¹å…±å­˜ï¼š</p>

<ol>
<li>ç›®çš„åœ° A åŠ¨ç”»é€€å‡ºã€‚</li>
<li>ç›®çš„åœ° B åŠ¨ç”»è¿›å…¥ã€‚</li>
</ol>


<p>åŠ¨ç”»å¯åŠ¨åï¼Œå¯ç§»åŠ¨å¯¼èˆªæ å¿…é¡»ç«‹å³ä¸ç›®çš„åœ° A ä¸­çš„è¯±é¥µå¯¼èˆªæ è¿›è¡Œäº¤æ¢ï¼ŒåŒæ—¶ï¼Œå¿…é¡»ç«‹å³åœ¨ç›®çš„åœ° B å¼€å§‹ç»„åˆã€‚ä»¥ä¸‹æ¦‚è¿°äº†å®ç°æ­¤ç›®çš„çš„ç•Œé¢é€»è¾‘ã€‚</p>

<h3>å®šä¹‰å¯ç§»åŠ¨æŒä¹…ç•Œé¢</h3>

<p>ScaffoldState å¯¼èˆªæ é¦–å…ˆå°†å…¶å£°æ˜æ‹†åˆ†ã€‚ä»…ä¾èµ–äº AppState çš„éƒ¨åˆ†ä½œä¸º AppState çš„æ‰©å±•å•ç‹¬ç¼–å†™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">AppState</span><span class="p">.</span><span class="n">NavigationBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NavigationBar</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">navItems</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">item</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">NavigationBarItem</span><span class="p">(...)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>æå‡å¯ç§»åŠ¨æŒä¹…åŒ– UI</h3>

<p>çœŸæ­£æŒä¹…åŒ–çš„å¯¼èˆªæ  (NavigationBar) å¯ä»¥ä½¿ç”¨å¯ç§»åŠ¨å†…å®¹ (movableContentOf) æå‡åˆ° AppState ä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">AppState</span><span class="p">(</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">movableNavigationBar</span> <span class="p">=</span> <span class="n">movableContentOf</span><span class="p">&lt;</span><span class="n">Modifier</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">modifier</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">NavigationBar</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å¯ç§»åŠ¨æŒä¹… UI çš„ UI é€»è¾‘</h3>

<p>å®šä¹‰å¯ç§»åŠ¨å¯¼èˆªæ åï¼Œå°†ç¡®å®šä½•æ—¶å¯ä»¥å®‰å…¨ç»„åˆçš„é€»è¾‘æ·»åŠ åˆ° ScaffoldState ä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ScaffoldState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">appState</span><span class="p">:</span> <span class="n">AppState</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">AnimatedVisibilityScope</span> <span class="k">by</span> <span class="n">animatedVisibilityScope</span><span class="p">,</span>
</span><span class='line'>    <span class="n">SharedTransitionScope</span> <span class="k">by</span> <span class="n">appState</span><span class="p">.</span><span class="n">sharedTransitionScope</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">canShowNavigationBar</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">!</span><span class="n">isMediumScreenWidthOrWider</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">canUseMovableNavigationBar</span>
</span><span class='line'>        <span class="c1">// ä» AnimatedVisibility Scope è¯»å–è¿‡æ¸¡ç›®æ ‡çŠ¶æ€</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">canShowNavigationBar</span> <span class="p">&amp;&amp;</span> <span class="n">transition</span><span class="p">.</span><span class="n">targetState</span> <span class="p">==</span> <span class="n">EnterExitState</span><span class="p">.</span><span class="n">Visible</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>æ„å»ºå¯ç§»åŠ¨çš„æŒä¹…åŒ– UI</h3>

<p>æœ€åï¼Œåœ¨ ScaffoldState çš„å…¬å…±æ‰©å±•æ–¹æ³•ä¸­ï¼Œæ ¹æ® ScaffoldState ä¸­å®šä¹‰çš„ UI é€»è¾‘ï¼Œåœ¨ AppState ä¸­çš„æŒä¹…åŒ– UI å…ƒç´ ä¸å…¶è¯±é¥µå…ƒç´ ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ScaffoldState</span><span class="p">.</span><span class="n">PeristentNavigationBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AnimatedVisibility</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">sharedElement</span><span class="p">(...),</span>
</span><span class='line'>        <span class="n">visible</span> <span class="p">=</span> <span class="n">canShowNavigationBar</span><span class="p">,</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">canUseMovableNavigationBar</span><span class="p">)</span> <span class="n">appState</span><span class="p">.</span><span class="n">movableNavigationBar</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="k">else</span> <span class="n">appState</span><span class="p">.</span><span class="n">NavigationBar</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…¶ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://storage.googleapis.com/tunji-web-public/articles/68248e8ecc8e85f53ce1aa46/cropped_persistent_navigation_bar.gif" alt="ä½¿ç”¨å¯ç§»åŠ¨å†…å®¹ (movableContentOf) åœ¨å¯¼èˆªæ ä¸­ä¿ç•™å±€éƒ¨ç¬æ€åŠ¨ç”»" /></p>

<h2>æ€»ç»“</h2>

<p>ä»¥ä¸Šæè¿°äº†ä¸€ç§ç”¨äºåº”ç”¨æŒä¹…åŒ– UI çš„æ¶æ„æ¨¡å¼ã€‚è¯¥æ¶æ„çš„ä¸€å¤§ä¼˜åŠ¿åœ¨äºå®ƒèƒ½å¤Ÿæ‰©å±•åˆ°å¹³æ¿ç”µè„‘å’Œæ¡Œé¢è®¾å¤‡ï¼›è¿™å°†åœ¨åç»­çš„åšå®¢æ–‡ç« ä¸­ä»‹ç»ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œè¯¥æ¶æ„æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
<li>å¯¼èˆªç›®æ ‡æ§åˆ¶æŒä¹…åŒ– UI åŠ¨ç”»ï¼Œç”¨äºå¯¼èˆªç›®æ ‡å†…éƒ¨çš„å±€éƒ¨å˜åŒ–ï¼Œä¾‹å¦‚çª—å£å¤§å°å˜åŒ–ã€‚</li>
<li>å¯¼èˆªç›®æ ‡æ§åˆ¶æŒä¹…åŒ– UI åŠ¨ç”»ï¼Œç”¨äºè·¨å¯¼èˆªç›®æ ‡è¿›è¡Œå¯¼èˆªå˜åŒ–ã€‚</li>
<li>å®Œå…¨è‡ªå®šä¹‰æ¯ä¸ªå¯¼èˆªç›®æ ‡ä¸Šå“ªäº› UI å…ƒç´ æ˜¯æŒä¹…åŒ–çš„ï¼Œå“ªäº›ä¸æ˜¯ã€‚</li>
<li>ä¸€ç§å°†æŒä¹…åŒ– UI å…ƒç´ æè¿°ä¸ºå¯¼èˆªç›®æ ‡ ScaffoldState å‡½æ•°çš„æ¨¡å¼ã€‚</li>
<li>èƒ½å¤Ÿå°†å…·æœ‰å†…éƒ¨ç¬æ€çŠ¶æ€çš„ UI å…ƒç´ æå‡åˆ° AppStateï¼Œè¿™äº› UI å…ƒç´ é©±åŠ¨çš„åŠ¨ç”»æ— æ³•é€šè¿‡ä¸åŒå®ä¾‹ä¹‹é—´çš„å…±äº«å…ƒç´ è¿‡æ¸¡æ¥è¿‘ä¼¼å®ç°ã€‚</li>
</ul>


<p>ä½¿ç”¨è„šæ‰‹æ¶æ¨¡å—æˆ–ç±»ä¼¼ç»„ä»¶ï¼Œå°† AppState çš„ç»†ç²’åº¦æ§åˆ¶åˆ†å‘åˆ°å¯¼èˆªç›®æ ‡ã€‚</p>

<p><a href="https://github.com/tunjid/listingApp?open-graph-scrape=true">è¿™é‡Œ</a>å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¸¦æœ‰è„šæ‰‹æ¶æ¨¡å—ã€AppState å’Œæ¯ä¸ªå¯¼èˆªç›®çš„åœ°å®šåˆ¶çš„åº”ç”¨ç¨‹åºä¸­ä¸Šè¿°å†…å®¹çš„ç¤ºä¾‹ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Kotlin Multiplatformé¡¹ç›®ä¸­ä½¿ç”¨DataStore]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/04/datastore-in-kmp/"/>
    <updated>2025-06-04T23:05:35+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/04/datastore-in-kmp</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒImplementing DataStore in Kotlin Multiplatform Projectsã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://carrion.dev/en/posts/datastore-in-kmp/">https://carrion.dev/en/posts/datastore-in-kmp/</a>ï¼Œç”± Ignacio CarriÃ³nå‘å¸ƒäº2025å¹´5æœˆ9æ—¥ã€‚</p></blockquote>

<p>DataStore æ˜¯ Google å¼€å‘çš„ä¸€ç§ç°ä»£æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œç”¨äºæ›¿ä»£ SharedPreferencesã€‚å®ƒæä¾›äº†ä¸€ä¸ªä¸€è‡´ã€ç±»å‹å®‰å…¨çš„ APIï¼Œç”¨äºå­˜å‚¨é”®å€¼å¯¹å’Œç±»å‹åŒ–å¯¹è±¡ï¼Œå¹¶æ”¯æŒ Kotlin åç¨‹å’Œ Flowã€‚éšç€ Kotlin Multiplatform (KMP) çš„æœ€æ–°è¿›å±•ï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°† DataStore é›†æˆåˆ° KMP é¡¹ç›®ä¸­ï¼Œä»è€Œå®ç°è·¨å¹³å°å…±äº«åå¥½è®¾ç½®å’Œæ•°æ®å­˜å‚¨ä»£ç ã€‚è¿™ç¯‡åšæ–‡æ¢è®¨äº†å¦‚ä½•åœ¨ KMP ç¯å¢ƒä¸­é…ç½®ã€å®ç°å’Œä¼˜åŒ– DataStoreã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/04/datastore-in-kmp/"><img src="file:///Users/alexhilton/Downloads/datastore.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç†è§£ Kotlin å¤šå¹³å°ç¯å¢ƒä¸­çš„ DataStore</h2>

<p>KMP ä¸­çš„ DataStore æ—¨åœ¨æä¾›è·¨å¹³å°ä¸€è‡´çš„ APIï¼ŒåŒæ—¶åˆ©ç”¨å¹³å°ç‰¹å®šçš„å­˜å‚¨æœºåˆ¶ã€‚DataStore æœ‰ä¸¤ç§ç±»å‹ï¼š</p>

<ol>
<li>Preferences DataStoreï¼šç”¨äºå­˜å‚¨é”®å€¼å¯¹</li>
<li>Proto DataStoreï¼šç”¨äºä½¿ç”¨åè®®ç¼“å†²åŒºå­˜å‚¨ç±»å‹åŒ–å¯¹è±¡</li>
</ol>


<p>åœ¨ KMP ä¸Šä¸‹æ–‡ä¸­ï¼ŒDataStoreï¼š</p>

<ol>
<li>å¹³å°ç‰¹å®šçš„å®ç°æä¾›å®é™…çš„å­˜å‚¨æœºåˆ¶</li>
<li>API ä½¿ç”¨åç¨‹å’Œ Flowï¼Œè·¨å¹³å°ä¿æŒä¸€è‡´</li>
</ol>


<p>è¿™ç§æ–¹æ³•ä½¿æˆ‘ä»¬èƒ½å¤Ÿç”¨é€šç”¨ä»£ç å®šä¹‰æ•°æ®è®¿é—®æ¨¡å¼ï¼Œè€Œåº•å±‚å­˜å‚¨æ“ä½œåˆ™ç”±å¹³å°ç‰¹å®šçš„å®ç°å¤„ç†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// In commonMain - DataStore interface</span>
</span><span class='line'><span class="n">interface</span> <span class="n">UserPreferences</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userData</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">UserData</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateEmail</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearData</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// In commonMain - Data model</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UserData</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">username</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">email</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoggedIn</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>åœ¨ KMP é¡¹ç›®ä¸­è®¾ç½®æ•°æ®å­˜å‚¨</h2>

<p>è¦å°† DataStore é›†æˆåˆ°ä½ çš„ KMP é¡¹ç›®ä¸­ï¼Œä½ éœ€è¦æ­£ç¡®é…ç½®æ„å»ºæ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯åˆ†æ­¥æŒ‡å—ï¼š</p>

<h3>1. åœ¨å…±äº«æ¨¡å—ä¸­é…ç½® build.gradle.kts æ–‡ä»¶</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">plugins</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">id</span><span class="p">(</span><span class="s">&quot;com.android.library&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">id</span><span class="p">(</span><span class="s">&quot;com.google.devtools.ksp&quot;</span><span class="p">)</span> <span class="n">version</span> <span class="s">&quot;2.1.20-2.0.1&quot;</span> <span class="c1">// For Proto DataStore</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">kotlin</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">androidTarget</span><span class="p">()</span>
</span><span class='line'>    <span class="n">iosX64</span><span class="p">()</span>
</span><span class='line'>    <span class="n">iosArm64</span><span class="p">()</span>
</span><span class='line'>    <span class="n">iosSimulatorArm64</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sourceSets</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">commonMain</span> <span class="k">by</span> <span class="n">getting</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// For Preferences DataStore</span>
</span><span class='line'>                <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.datastore:datastore-preferences-core:1.1.0&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// For coroutines</span>
</span><span class='line'>                <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. ä»é€šç”¨ä»£ç åˆ›å»º DataStore å®ä¾‹</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * è·å–å•ä¾‹ DataStore å®ä¾‹ï¼Œå¦‚æœ‰å¿…è¦åˆ™åˆ›å»ºå®ƒã€‚</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">createDataStore</span><span class="p">(</span><span class="n">producePath</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">String</span><span class="p">):</span> <span class="n">DataStore</span><span class="p">&lt;</span><span class="n">Preferences</span><span class="p">&gt;</span> <span class="p">=</span>
</span><span class='line'>   <span class="n">PreferenceDataStoreFactory</span><span class="p">.</span><span class="n">createWithPath</span><span class="p">(</span>
</span><span class='line'>      <span class="n">produceFile</span> <span class="p">=</span> <span class="p">{</span> <span class="n">producePath</span><span class="p">().</span><span class="n">toPath</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>   <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="n">const</span> <span class="k">val</span> <span class="py">dataStoreFileName</span> <span class="p">=</span> <span class="s">&quot;dice.preferences_pb&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç‰¹å®šå¹³å°çš„è€ƒè™‘å› ç´ </h2>

<h3>Android å®ç°</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// shared/src/androidMain/kotlin/DataStore.kt</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">createDataStoreAndroid</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">):</span> <span class="n">DataStore</span><span class="p">&lt;</span><span class="n">Preferences</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">createDataStore</span><span class="p">(</span>
</span><span class='line'>   <span class="n">producePath</span> <span class="p">=</span> <span class="p">{</span> <span class="n">context</span><span class="p">.</span><span class="n">filesDir</span><span class="p">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">dataStoreFileName</span><span class="p">).</span><span class="n">absolutePath</span> <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>iOS å®ç°</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// shared/src/iosMain/kotlin/DataStore.kt</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">createDataStoreIOS</span><span class="p">():</span> <span class="n">DataStore</span><span class="p">&lt;</span><span class="n">Preferences</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">createDataStore</span><span class="p">(</span>
</span><span class='line'>   <span class="n">producePath</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">val</span> <span class="py">documentDirectory</span><span class="p">:</span> <span class="n">NSURL</span><span class="p">?</span> <span class="p">=</span> <span class="n">NSFileManager</span><span class="p">.</span><span class="n">defaultManager</span><span class="p">.</span><span class="n">URLForDirectory</span><span class="p">(</span>
</span><span class='line'>         <span class="n">directory</span> <span class="p">=</span> <span class="n">NSDocumentDirectory</span><span class="p">,</span>
</span><span class='line'>         <span class="n">inDomain</span> <span class="p">=</span> <span class="n">NSUserDomainMask</span><span class="p">,</span>
</span><span class='line'>         <span class="n">appropriateForURL</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>         <span class="n">create</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>         <span class="n">error</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>      <span class="p">)</span>
</span><span class='line'>      <span class="n">requireNotNull</span><span class="p">(</span><span class="n">documentDirectory</span><span class="p">).</span><span class="n">path</span> <span class="p">+</span> <span class="s">&quot;/$dataStoreFileName&quot;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å®é™…ç¤ºä¾‹ï¼šå®ç°ç”¨æˆ·åå¥½å­˜å‚¨åº“</h2>

<p>ä¸ºäº†æ¼”ç¤ºå®Œæ•´çš„å®ç°ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä½¿ç”¨ DataStore çš„å­˜å‚¨åº“ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// In commonMain</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserPreferencesRepository</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">dataStore</span><span class="p">:</span> <span class="n">PreferencesDataStore</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//å®šä¹‰preferencesçš„é”®</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">object</span> <span class="nc">PreferenceKeys</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">USERNAME</span> <span class="p">=</span> <span class="n">stringPreferencesKey</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">EMAIL</span> <span class="p">=</span> <span class="n">stringPreferencesKey</span><span class="p">(</span><span class="s">&quot;email&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">IS_LOGGED_IN</span> <span class="p">=</span> <span class="n">booleanPreferencesKey</span><span class="p">(</span><span class="s">&quot;is_logged_in&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get user data as a Flow</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userData</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">UserData</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">dataStore</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">UserData</span><span class="p">(</span>
</span><span class='line'>            <span class="n">username</span> <span class="p">=</span> <span class="n">preferences</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">USERNAME</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="n">preferences</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">EMAIL</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isLoggedIn</span> <span class="p">=</span> <span class="n">preferences</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">IS_LOGGED_IN</span><span class="p">]</span> <span class="o">?:</span> <span class="k">false</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Update username</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dataStore</span><span class="p">.</span><span class="n">updateData</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">preferences</span><span class="p">.</span><span class="n">toMutablePreferences</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">this</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">USERNAME</span><span class="p">]</span> <span class="p">=</span> <span class="n">name</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Update email</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateEmail</span><span class="p">(</span><span class="n">email</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dataStore</span><span class="p">.</span><span class="n">updateData</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">preferences</span><span class="p">.</span><span class="n">toMutablePreferences</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">this</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">EMAIL</span><span class="p">]</span> <span class="p">=</span> <span class="n">email</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Set login status</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setLoggedIn</span><span class="p">(</span><span class="n">isLoggedIn</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dataStore</span><span class="p">.</span><span class="n">updateData</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">preferences</span><span class="p">.</span><span class="n">toMutablePreferences</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">this</span><span class="p">[</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">IS_LOGGED_IN</span><span class="p">]</span> <span class="p">=</span> <span class="n">isLoggedIn</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Clear all data</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">dataStore</span><span class="p">.</span><span class="n">updateData</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">preferences</span><span class="p">.</span><span class="n">toMutablePreferences</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">remove</span><span class="p">(</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">USERNAME</span><span class="p">)</span>
</span><span class='line'>                <span class="n">remove</span><span class="p">(</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">EMAIL</span><span class="p">)</span>
</span><span class='line'>                <span class="n">remove</span><span class="p">(</span><span class="n">PreferenceKeys</span><span class="p">.</span><span class="n">IS_LOGGED_IN</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// In commonMain - ViewModel or Presenter</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserViewModel</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">userPreferencesRepository</span><span class="p">:</span> <span class="n">UserPreferencesRepository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userData</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">UserData</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">userData</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUserProfile</span><span class="p">(</span><span class="n">username</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">email</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">username</span><span class="p">.</span><span class="n">isNotBlank</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">updateUsername</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">email</span><span class="p">.</span><span class="n">isNotBlank</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">updateEmail</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">login</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">setLoggedIn</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">logout</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">setLoggedIn</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearUserData</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userPreferencesRepository</span><span class="p">.</span><span class="n">clearData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>KMP ä¸­çš„é«˜çº§æ•°æ®å­˜å‚¨åŠŸèƒ½</h2>

<p>DataStore æä¾›äº†å‡ ç§å¯åœ¨ KMP ç¯å¢ƒä¸­åˆ©ç”¨çš„é«˜çº§åŠŸèƒ½ï¼š</p>

<h3>1. ç”¨äºç±»å‹åŒ–å¯¹è±¡çš„ Proto DataStore</h3>

<p>å¦‚æœä½ éœ€è¦å­˜å‚¨å¤æ‚å¯¹è±¡ï¼ŒProto DataStore æä¾›äº†ä¸€ä¸ªç±»å‹å®‰å…¨çš„è§£å†³æ–¹æ¡ˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='proto'><span class='line'><span class="c1">// åœ¨ .proto æ–‡ä»¶ä¸­å®šä¹‰æ•°æ®ç»“æ„</span>
</span><span class='line'><span class="na">syntax</span> <span class="o">=</span> <span class="s">&quot;proto3&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">option</span> <span class="na">java_package</span> <span class="o">=</span> <span class="s">&quot;com.example.app&quot;</span><span class="p">;</span>
</span><span class='line'><span class="k">option</span> <span class="na">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">message</span> <span class="nc">UserPreferences</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">string</span> <span class="na">username</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">string</span> <span class="na">email</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="na">is_logged_in</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// In commonMain - åˆ›å»ºåºåˆ—åŒ–å™¨</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserPreferencesSerializer</span> <span class="p">:</span> <span class="n">Serializer</span><span class="p">&lt;</span><span class="n">UserPreferences</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">defaultValue</span><span class="p">:</span> <span class="n">UserPreferences</span> <span class="p">=</span> <span class="n">UserPreferences</span><span class="p">.</span><span class="n">getDefaultInstance</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">readFrom</span><span class="p">(</span><span class="n">input</span><span class="p">:</span> <span class="n">InputStream</span><span class="p">):</span> <span class="n">UserPreferences</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">UserPreferences</span><span class="p">.</span><span class="n">parseFrom</span><span class="p">(</span><span class="n">input</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">writeTo</span><span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">UserPreferences</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span> <span class="n">OutputStream</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">t</span><span class="p">.</span><span class="n">writeTo</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Proto DataStore çš„å¹³å°ç‰¹å®šå®ç°</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.æ•°æ®è¿ç§»</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// In androidMain - ä» SharedPreferences è¿ç§»åˆ° DataStore</span>
</span><span class='line'><span class="k">val</span> <span class="py">dataStore</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">createDataStore</span><span class="p">(</span>
</span><span class='line'>    <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;user_preferences&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">produceMigrations</span> <span class="p">=</span> <span class="p">{</span> <span class="n">context</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>            <span class="n">SharedPreferencesMigration</span><span class="p">(</span>
</span><span class='line'>                <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
</span><span class='line'>                <span class="n">sharedPreferencesName</span> <span class="p">=</span> <span class="s">&quot;legacy_preferences&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3.å¤„ç†å¼‚å¸¸</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// In commonMain - æ•°æ®æ“ä½œè¿‡ç¨‹ä¸­çš„å¼‚å¸¸å¤„ç†</span>
</span><span class='line'><span class="k">val</span> <span class="py">userData</span> <span class="p">=</span> <span class="n">dataStore</span><span class="p">.</span><span class="n">data</span>
</span><span class='line'>    <span class="p">.</span><span class="k">catch</span> <span class="p">{</span> <span class="n">exception</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// å¤„ç†å¼‚å¸¸ï¼ˆä¾‹å¦‚æ•°æ®æŸåï¼‰</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="k">is</span> <span class="n">IOException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">emptyPreferences</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">exception</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">preferences</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// Map preferences to your data model</span>
</span><span class='line'>        <span class="n">UserData</span><span class="p">(</span>
</span><span class='line'>            <span class="n">username</span> <span class="p">=</span> <span class="n">preferences</span><span class="p">[</span><span class="n">USERNAME</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="n">preferences</span><span class="p">[</span><span class="n">EMAIL</span><span class="p">]</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>KMP ä¸­æ•°æ®å­˜å‚¨çš„æœ€ä½³å®è·µ</h2>

<ol>
<li>åˆ©ç”¨åç¨‹å’Œ Flow è¿›è¡Œå¼‚æ­¥æ“ä½œ

<ul>
<li>DataStore æ“ä½œæœ¬è´¨ä¸Šæ˜¯å¼‚æ­¥çš„</li>
<li>ä½¿ç”¨ Flow è§‚å¯Ÿå­˜å‚¨æ•°æ®çš„å˜åŒ–</li>
<li>åº”ç”¨ Mapã€Filter å’Œ Combine ç­‰ Flow æ“ä½œç¬¦è¿›è¡Œæ•°æ®è½¬æ¢</li>
</ul>
</li>
<li>åˆ›å»ºå­˜å‚¨åº“å±‚

<ul>
<li>å°† DataStore æ“ä½œæŠ½è±¡åˆ°å­˜å‚¨åº“åé¢</li>
<li>è¿™æ ·å¯ä»¥æ›´è½»æ¾åœ°æ ¹æ®éœ€è¦åˆ‡æ¢å®ç°</li>
<li>ä¸ºä½ çš„ä¸šåŠ¡é€»è¾‘æä¾›ç®€æ´çš„ API</li>
</ul>
</li>
<li>ä¼˜é›…åœ°å¤„ç†é”™è¯¯

<ul>
<li>ä½¿ç”¨ catch æ“ä½œç¬¦å¤„ç† Flow ä¸­çš„å¼‚å¸¸</li>
<li>åœ¨æ— æ³•è¯»å–æ•°æ®æ—¶æä¾›å›é€€å€¼</li>
<li>è€ƒè™‘ä¸ºå…³é”®æ“ä½œå®ç°é‡è¯•æœºåˆ¶</li>
</ul>
</li>
<li>ä¼˜åŒ–æ€§èƒ½

<ul>
<li>æœ€å¤§é™åº¦åœ°å‡å°‘ DataStore æ›´æ–°æ¬¡æ•°</li>
<li>å°†ç›¸å…³çš„æ›´æ”¹é›†ä¸­å¤„ç†</li>
<li>ä½¿ç”¨ distinctUntilChanged() é¿å…ä¸å¿…è¦çš„æ’æ”¾</li>
</ul>
</li>
<li>å½»åº•æµ‹è¯•ä½ çš„ DataStore ä»£ç 

<ul>
<li>åœ¨ commonTest ä¸­ä¸ºä½ çš„å­˜å‚¨åº“ç¼–å†™æµ‹è¯•</li>
<li>ä½¿ç”¨æµ‹è¯•æ›¿èº«æ¨¡æ‹Ÿä¸åŒçš„åœºæ™¯</li>
</ul>
</li>
</ol>


<h2>ç»“è®º</h2>

<p>å°† DataStore é›†æˆåˆ° Kotlin Multiplatform é¡¹ç›®ä¸­ï¼Œæä¾›äº†ä¸€ç§ç°ä»£åŒ–ã€ç±»å‹å®‰å…¨çš„è·¨å¹³å°æ•°æ®å­˜å‚¨å’Œè®¿é—®æ–¹æ³•ã€‚</p>

<p>æœ¬æ–‡æ¦‚è¿°çš„æ–¹æ³•æä¾›äº†ä¸€ç§å®ç”¨çš„æ–¹æ³•ï¼Œå¯ä»¥è·¨å¹³å°å…±äº«é¦–é€‰é¡¹å’Œæ•°æ®å­˜å‚¨é€»è¾‘ï¼Œå¹¶ä¸”åªéœ€æå°‘çš„å¹³å°ç‰¹å®šä»£ç ã€‚DataStore å¯¹åç¨‹å’Œ Flow çš„æ”¯æŒä½¿å…¶ä¸ KMP é¡¹ç›®å®Œç¾å¥‘åˆï¼Œèƒ½å¤Ÿé€šè¿‡ä¸€è‡´çš„ API å®ç°å“åº”å¼å’Œå¼‚æ­¥æ•°æ®æ“ä½œã€‚</p>

<p>é€šè¿‡éµå¾ªæœ¬æ–‡æ¦‚è¿°çš„é…ç½®æ­¥éª¤ã€å¹³å°ç‰¹å®šæ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥åœ¨ KMP é¡¹ç›®ä¸­æˆåŠŸå®ç° DataStoreï¼Œå¹¶åˆ›å»ºç¨³å®šã€é«˜æ•ˆçš„è·¨å¹³å°æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå¹¶ä¸”åªéœ€æå°‘çš„å¹³å°ç‰¹å®šä»£ç ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ­ç§˜åŸç”ŸViewä¸Jetpack Composeä¹‹é—´çš„ä¼ é€é—¨]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/02/android-vies-in-compose/"/>
    <updated>2025-06-02T21:44:19+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/02/android-vies-in-compose</id>
    <content type="html"><![CDATA[<p>èŠ³è²éšæ˜¥å»ï¼Œç¢§ç»¿å…¥å¤æ¥ï¼Œä¸çŸ¥ä¸è§‰ä¸­<a href="https://juejin.cn/column/7367555191338467337">Composeä¸“é¢˜</a>å·²ç»å†™äº†è¿‘40ç¯‡æ–‡ç« äº†ï¼Œä»Composeå„ç»„ä»¶çš„ä½¿ç”¨æ–¹æ³•ï¼Œåˆ°Composeçš„ç¼–ç¨‹æ€æƒ³ï¼Œå†åˆ°å†…éƒ¨åŸç†å’Œæœ€ä½³å®è·µã€‚é€šè¿‡<a href="https://juejin.cn/column/7367555191338467337">è¿™ä¸€ç³»åˆ—çš„æ–‡ç« </a>ç›¸ä¿¡å¯¹Composeå·²ç»æœ‰äº†è¶³å¤Ÿçš„ç†è§£ï¼Œèƒ½å¤Ÿåœ¨é¡¹ç›®ä¸­è¿›è¡Œå®æˆ˜å’Œè¿ç”¨ã€‚å­¦æ— æ­¢å¢ƒï¼Œä»Šå¤©å°†ç»§ç»­å­¦ä¹ ï¼Œé‡ç‚¹æ¢è®¨å¦‚ä½•åœ¨å·²æœ‰çš„é¡¹ç›®ä¸­ä½¿ç”¨Composeã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/02/android-vies-in-compose/"><img src="file:///Users/alexhilton/Downloads/portal_2.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç¼˜èµ·</h2>

<p>æ— ç–‘Jetpack Composeæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å£°æ˜å¼UIæ¡†æ¶ï¼Œå®ƒä¸åŸç”Ÿçš„Viewæ–¹å¼æœ€å¤§çš„åŒºåˆ«ï¼Œåœ¨äºæ€è€ƒé—®é¢˜çš„æ–¹å¼ä¸Šå¹¶ä¸ä¸€æ ·ã€‚å£°æ˜å¼æ¡†æ¶èƒ½æŠŠå¼€å‘è€…ä»ç¹æ‚çš„å‘½ä»¤å¼çš„UIç»†èŠ‚ä¸­è§£æ”¾å‡ºæ¥ï¼Œé‡ç‚¹æ€è€ƒä¸€ä¸ªå¥½çš„ä½“éªŒåº”è¯¥æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œè€Œå…·ä½“çš„UIç»†èŠ‚ç”±æ¡†æ¶æ¥å¤„ç†ã€‚å°½ç®¡å¦‚æ­¤ï¼Œæ¯•ç«ŸComposeæ˜¯è¿‘å‡ å¹´æ¥å‘å±•èµ·æ¥çš„ï¼Œç°ä»Šå¤§é‡çš„é¡¹ç›®ä»æ˜¯åŸç”ŸViewä¸»å¯¼çš„ã€‚æ­¤å¤–ï¼ŒComposeä¹Ÿè¿˜åœ¨å‘å±•ä¸­ï¼Œæœ‰äº›ç‰¹å®šä¸šåŠ¡é¢†åŸŸå¦‚Cameraï¼Œè§†é¢‘ï¼Œ3Dæ¸²æŸ“ï¼Œè¿˜æ²¡æœ‰èƒ½åŠ›æ”¯æŒã€‚å› æ­¤ï¼Œæ•´åˆåŸç”ŸViewå’ŒComposeæ˜¯é¡¹ç›®ä¸­å¾ˆç°å®çš„ä¸€ä¸ªéš¾é¢˜ï¼Œæœ¬æ–‡å°†é‡ç‚¹è®¨è®ºä¸¤ä¸ªè®®é¢˜ï¼šä¸€ä¸ªæ˜¯å¦‚ä½•åœ¨åŸç”ŸViewä¸­åµŒå…¥Composeï¼Œå¦ä¸€ä¸ªå°±æ˜¯å¦‚ä½•åœ¨Composeä¸­åµŒå…¥åŸç”ŸViewã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> æœ¬æ–‡ä¸­æåˆ°çš„ä¸¤ä¸ªç»„ä»¶ComposeViewå’ŒAndroidViewéƒ½ä»…åœ¨Jetpack Composeï¼ˆfor Androidï¼‰ç”Ÿæ•ˆï¼Œå¹¶ä¸é€‚ç”¨äºè·¨å¹³å°çš„Compose Multiplatformã€‚</p>

<h2>åœ¨åŸç”ŸViewä¸­åµŒå…¥Compose</h2>

<p>ç¬¬ä¸€ä¸ªä¼ é€é—¨æ˜¯å¦‚ä½•è¿›å…¥Composeçš„ä¸–ç•Œã€‚ç›¸ä¿¡ç°åœ¨ç»å¤§å¤šæ•°é¡¹ç›®éƒ½æ˜¯åŸºäºåŸç”ŸViewçš„ï¼Œå€ŸåŠ©<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/platform/ComposeView">ComposeView</a>å°±å¯ä»¥è¿›å…¥åˆ°Composeçš„ä¸–ç•Œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">composeView</span> <span class="p">=</span> <span class="n">ComposeView</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// è¿™é‡Œè°ƒç”¨Composables</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ComposeViewæ˜¯Viewçš„ä¸€ä¸ªå­ç±»ï¼Œèƒ½å¤Ÿä½œä¸ºComposeçš„å®¹å™¨ï¼Œåœ¨<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/platform/ComposeView#setContent(kotlin.Function0">å…¶setContentæ–¹æ³•</a>)ä¸­æä¾›ä¸€ä¸ªComposableå³å¯ã€‚ComposeViewä¸å…¶ä»–Viewä¸€æ ·ï¼Œå¯ä»¥ç”¨åœ¨View treeä¸­ï¼Œç”¨åœ¨Fragmenté‡Œå’ŒActivityé‡Œé¢ã€‚å®é™…ä¸Šä½œä¸ºå¹³å°çš„å…¥å£ComponentActivityç”¨çš„ä¹Ÿæ˜¯ComposeViewã€‚</p>

<h3>åœ¨Viewå±‚çº§ä¸­ç›´æ¥åµŒå…¥</h3>

<p>ComposeViewå°±æ˜¯ä¸€ä¸ªæ™®é€šçš„Android Viewï¼Œè·Ÿå…¶ä»–Viewçš„å­ç±»æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯ä»¥æŠŠå®ƒæ”¾åœ¨ä»»ä½•å¯ä»¥ä½¿ç”¨Viewçš„åœ°æ–¹ï¼Œæ¯”å¦‚ä¸€ä¸ªå¸ƒå±€é‡Œé¢ï¼Œä½œä¸ºä¸€ä¸ªé¡µé¢çš„ä¸€éƒ¨åˆ†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;LinearLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
</span><span class='line'>    <span class="na">android:id=</span><span class="s">&quot;@+id/container&quot;</span>
</span><span class='line'>    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="na">android:orientation=</span><span class="s">&quot;vertical&quot;</span>
</span><span class='line'>    <span class="na">tools:context=</span><span class="s">&quot;.MainActivity&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;androidx.compose.ui.platform.ComposeView</span>
</span><span class='line'>        <span class="na">android:id=</span><span class="s">&quot;@+id/compose_view&quot;</span>
</span><span class='line'>        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;Button</span>
</span><span class='line'>        <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
</span><span class='line'>        <span class="na">android:text=</span><span class="s">&quot;WidgetButton&quot;</span>
</span><span class='line'>        <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/LinearLayout&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> å°½ç®¡å¯ä»¥æŠŠComposeViewå½“æˆæ™®é€šçš„Viewï¼Œç›´æ¥åµŒå…¥åˆ°å¸ƒå±€ä¸­ï¼Œä½œä¸ºé¡µé¢ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œä½†è¿™å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„åšæ³•ï¼Œä¸€æ¥æ˜¯ä¸èƒ½å‘æŒ¥Composeçš„ä¼˜åŠ¿ï¼Œå¦å¤–Composeæœ¬èº«æ˜¯æœ‰ç‰¹å®šçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼ˆé‡ç»„ï¼‰ï¼Œå®ƒéœ€è¦çŸ¥é“å¹³å°çš„ç”Ÿå‘½å‘¨æœŸï¼Œä»¥ç®¡æ§å®ƒè‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸã€‚è€Œå¸¸è§„çš„View treeä¹‹ä¸­æ˜¯æ²¡æœ‰å¹³å°ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå› ä¸ºå¸¸è§„çš„View treeå¹¶ä¸å…³å¿ƒå¹³å°çš„ç”Ÿå‘½å‘¨æœŸï¼Œview treeä¸»è¦å—çª—å£å½±å“ï¼ˆattachToWindowï¼ŒdetachFromWindowï¼‰ï¼Œè¿™ä¸ªä¸å¹³å°ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰å…³ç³»ã€‚</p>

<h3>ç”¨åœ¨Fragmentä¸­</h3>

<p>æƒ³è¦åœ¨æŸä¸ªFragmentä¸­é›†æˆComposeçš„æ–¹å¼å°±æ˜¯æŠŠComposeViewä½œä¸ºFragmentçš„æ ¹Viewå³å¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ExampleFragmentNoXml</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreateView</span><span class="p">(</span>
</span><span class='line'>        <span class="n">inflater</span><span class="p">:</span> <span class="n">LayoutInflater</span><span class="p">,</span>
</span><span class='line'>        <span class="n">container</span><span class="p">:</span> <span class="n">ViewGroup</span><span class="p">?,</span>
</span><span class='line'>        <span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">View</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ComposeView</span><span class="p">(</span><span class="n">requireContext</span><span class="p">()).</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// å½“Viewçš„å®¿ä¸»destroyæ—¶é”€æ¯ç»„åˆ</span>
</span><span class='line'>            <span class="n">setViewCompositionStrategy</span><span class="p">(</span><span class="n">ViewCompositionStrategy</span><span class="p">.</span><span class="n">DisposeOnViewTreeLifecycleDestroyed</span><span class="p">)</span>
</span><span class='line'>            <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">MaterialTheme</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// è¿›å…¥åˆ°Composeä¸–ç•Œ</span>
</span><span class='line'>                    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hello Compose!&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ç”¨åœ¨Activityä¸­</h3>

<p>è¿™å…¶å®æ˜¯æœ€å¥½çš„æ–¹å¼ï¼Œåœ¨ä¸€ä¸ªæ–°çš„é¡µé¢çª—å£ä¸­ä½¿ç”¨Composeï¼Œè¿™å°±èƒ½ä¸å…¶ä½™viewç‹¬ç«‹å¼€æ¥ï¼Œæ˜¯æœ€ä¸ºç†æƒ³çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ExampleActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">MaterialTheme</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Greeting</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;compose&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">Greeting</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Hello $name!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ä½¿ç”¨å»ºè®®</h3>

<p>è™½ç„¶ComposeViewå¯ä»¥å½“æˆä¸€ä¸ªæ™®é€šçš„Viewæ¥ä½¿ç”¨ï¼Œä½†æœ€ä¸ºåˆç†çš„æ–¹å¼å°±æ˜¯åœ¨ä¸€ä¸ªæ–°çš„Activityä¸­æ‰ä½¿ç”¨Composeï¼Œä¹Ÿå°±æ˜¯è¯´å½“æœ‰ä¸€ä¸ªå…¨æ–°çš„é¡µé¢æ—¶ï¼Œè€ƒè™‘ä½¿ç”¨Composeæ¥å¼€å‘ï¼Œè¿™æ ·æ‰èƒ½å‘æŒ¥å‡ºå®ƒçš„ä»·å€¼ã€‚</p>

<p>é™¤éæœ‰ç‰¹åˆ«çš„éœ€æ±‚ï¼Œå¦åˆ™ä¸è¦æŠŠComposeViewä½œä¸ºç°æœ‰é¡µé¢çš„ä¸€éƒ¨åˆ†åµŒå…¥åˆ°View treeä¸­ï¼ˆä¹Ÿå°±æ˜¯ä½œä¸ºé¡µé¢çš„ä¸€éƒ¨åˆ†ï¼‰ã€‚</p>

<p>è‡³äºåœ¨Fragmentä¸­ä½¿ç”¨ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå…¨æ–°çš„é¡µé¢ï¼Œè€Œéç°æœ‰å¸ƒå±€çš„ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨Composeã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> å…¶æ ¹æœ¬åŸå› åœ¨äºï¼Œæˆ‘ä»¬ä½¿ç”¨Jetpack Composeå¹¶ä¸æ˜¯å›¾å®ƒèƒ½å®ç°ä»€ä¹ˆç‰¹åˆ«çš„UIæ•ˆæœï¼ŒComposeèƒ½åšçš„äº‹æƒ…Viewéƒ½èƒ½åšï¼Œç”šè‡³å®ƒä¸èƒ½åšçš„äº‹æƒ…Viewä¹Ÿèƒ½åšã€‚ç”¨Composeæ˜¯å› ä¸ºå®ƒæ˜¯å£°æ˜å¼çš„UIæ¡†æ¶ï¼Œåœ¨å¼€å‘æ•ˆç‡å’Œå¯æ‰©å±•æ€§ä¸Šé¢æœ‰å·¨å¤§çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥ï¼Œåªåº”è¯¥åœ¨æƒ³è¦å‘æŒ¥å£°æ˜å¼æ¡†æ¶ä¼˜åŠ¿çš„æ—¶å€™ï¼Œæ‰è€ƒè™‘ä½¿ç”¨å®ƒï¼Œå¹¶ä¸”åº”è¯¥ä»ä¸€ä¸ªå…¨æ–°çš„é¡µé¢å¼€å§‹ã€‚</p>

<h2>åœ¨Composeä¸­åµŒå…¥åŸç”ŸView</h2>

<p>Jetpack Composeæä¾›äº†è¶³å¤Ÿä¸°å¯Œçš„ç»„ä»¶ï¼Œè¶³ä»¥åº”å¯¹å¸¸è§„çš„UIï¼Œä½†å®ƒæ¯•ç«Ÿè¿˜ä¸æ˜¯ç‰¹åˆ«çš„æˆç†Ÿï¼Œæ€»ä¼šé‡åˆ°ä¸€äº›åœºæ™¯ï¼Œå‘ç°Composeæ— æ³•èƒœä»»ï¼Œè€Œä¸”å¹¶ä¸æ˜¯é€šè¿‡è‡ªå®šä¹‰ç»„ä»¶å°±èƒ½å¤Ÿè§£å†³çš„ï¼Œæ¯”å¦‚ä¸€äº›ç‰¹å®šé¢†åŸŸçš„UIï¼Œå¦‚cameraï¼Œå¦‚è§†é¢‘ï¼Œå¦‚3Dæ¸²æŸ“ã€‚æˆ–è€…è¯´ï¼Œå·²ç»æœ‰äº†è‡ªå®šä¹‰å¥½çš„Viewï¼Œå¹¶ä¸æƒ³é‡å¤å¼€å‘ã€‚å†æˆ–è€…è¯´å¯¹äºä¸€äº›ä¸‰æ–¹çš„åº“ï¼Œå®ƒå¹¶æ²¡æœ‰å¯¹åº”çš„Composeç»„ä»¶ã€‚è¿™äº›åœºæ™¯å°±éœ€è¦æŠŠåŸç”Ÿçš„ViewåµŒå…¥åˆ°Composeä¹‹ä¸­ã€‚</p>

<p><a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/viewinterop/package-summary#AndroidView(kotlin.Function1,androidx.compose.ui.Modifier,kotlin.Function1,kotlin.Function1,kotlin.Function1">AndroidView</a>)å°±æ˜¯ä¸“é—¨ç”¨äºæŠŠåŸç”ŸViewåµŒå…¥åˆ°Composeä¸­çš„ä¸€ä¸ªç‰¹æ®Šcomposableã€‚å®ƒå°±åƒä¸€ä¸ªä¼ é€é—¨ä¸€æ ·ï¼Œèƒ½æŠŠåŸç”Ÿçš„Viewï¼Œæ— è®ºæ˜¯ä¸€ä¸ªç°æˆçš„è‡ªå®šä¹‰Viewï¼Œè¿˜æ˜¯ç‰¹å®šé¢†åŸŸçš„Viewæˆ–è€…ä¸‰æ–¹åº“çš„Viewï¼Œå¸¦å…¥åˆ°Composeä¸­ï¼Œå˜æˆä¸€ä¸ªcomposableã€‚</p>

<h3>AndroidViewçš„ä½¿ç”¨æ–¹æ³•</h3>

<p>AndroidViewæ˜¯ä¸€ä¸ªcomposableï¼ŒæŠŠå®ƒæ”¾åœ¨æƒ³è¦çš„ä½ç½®å³å¯ã€‚å®ƒæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯å¸¸è§„çš„Modifierç”¨ä»¥çº¦æŸè¿™ä¸ªcomposableçš„ï¼›å¦ä¸¤ä¸ªæ˜¯lambdaï¼Œä¸€ä¸ªæ˜¯ç”¨äºåˆ›å»ºViewçš„ï¼Œè¿”å›ä¸€ä¸ªViewçš„å®ä¾‹ï¼Œåªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼›å¦ä¸€ä¸ªå°±æ˜¯ç”¨äºæ›´æ–°Viewçš„ï¼Œä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CustomView</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">selectedItem</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// æ·»åŠ åŸç”ŸViewåˆ°Compose</span>
</span><span class='line'>    <span class="n">AndroidView</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">factory</span> <span class="p">=</span> <span class="p">{</span> <span class="n">context</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// åˆ›å»ºViewçš„å®ä¾‹</span>
</span><span class='line'>            <span class="n">MyView</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// è®¾ç½®Viewçš„ç‚¹å‡»äº‹ä»¶ï¼Œæ›´æ–°çŠ¶æ€ï¼Œè¿™ä¼šè§¦å‘é‡ç»„</span>
</span><span class='line'>                <span class="n">setOnClickListener</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">selectedItem</span> <span class="p">=</span> <span class="m">1</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">update</span> <span class="p">=</span> <span class="p">{</span> <span class="n">view</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// æ›´æ–°Viewçš„çŠ¶æ€</span>
</span><span class='line'>            <span class="c1">// è¿™é‡Œè¯»äº†çŠ¶æ€ï¼Œæ‰€ä»¥é‡ç»„æ—¶updateä¼šè¢«å†æ¬¡è°ƒç”¨ï¼Œviewèƒ½æ‹¿åˆ°æœ€æ–°çš„çŠ¶æ€</span>
</span><span class='line'>            <span class="n">view</span><span class="p">.</span><span class="n">selectedItem</span> <span class="p">=</span> <span class="n">selectedItem</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ContentExample</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Look at this CustomView!&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">CustomView</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>æ³¨æ„ï¼š</strong> factoryä»…ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ï¼Œç”¨äºåˆ›å»ºViewå®ä¾‹ï¼Œupdateä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼Œç”¨äºæ›´æ–°viewçš„çŠ¶æ€ï¼ŒåŒ…æ‹¬åˆæ¬¡ç»„åˆæ—¶ï¼Œä¹Ÿå°±æ˜¯factoryæ‰§è¡Œä¹‹åï¼Œå°±ä¼šè°ƒç”¨updateã€‚AndroidViewå‡½æ•°ä¼šå¸®åŠ©æä¾›Viewéœ€è¦çš„å‚æ•°contextï¼Œä»¥åŠç®¡ç†Viewçš„å®ä¾‹ï¼Œæ‰€ä»¥updateä¸­ä¼šæŠŠviewå½“ä½œå‚æ•°ä¼ ç»™æˆ‘ä»¬ï¼Œæ‰€ä»¥æˆ‘ä»¬å®Œå…¨æ²¡æœ‰å¿…è¦å†ç”¨é¢å¤–çš„çŠ¶æ€ï¼ˆrememberï¼‰å»ç¼“å­˜Viewçš„å®ä¾‹äº†ã€‚</p>

<h3>ä½¿ç”¨å»ºè®®</h3>

<p>è™½ç„¶AndroidViewæ˜¯ä¸€ä¸ªä¼ é€é—¨ï¼Œå¯ä»¥è¿æ¥ä¸¤ä¸ªä¸–ç•Œï¼Œä½†æ˜¯èƒ½ä¸ç”¨è¿˜æ˜¯ä¸è¦ç”¨ï¼Œéå¿…è¦ä¸ä½¿ç”¨ã€‚å¦‚æœèƒ½ç”¨Composeæå®šçš„äº‹æƒ…ï¼Œè¿˜æ˜¯è¦ç”¨Composeæ¥æï¼Œæ¯”å¦‚ç”¨Canvaså»å®ç°è‡ªå®šä¹‰ç»„ä»¶ã€‚</p>

<p>éœ€è¦ä½¿ç”¨AndroidViewçš„åœºæ™¯åªæœ‰ä¸‰ä¸ªï¼šä¸€æ˜¯æœ‰ç°æˆçš„è‡ªå®šä¹‰Viewï¼Œæ‹¿è¿‡æ¥å°±å¯ä»¥ç”¨ï¼Œä¸æƒ³äºŒæ¬¡å¼€å‘ï¼›äºŒæ˜¯ä¸‰æ–¹åº“çš„Viewï¼›ä¸‰å°±æ˜¯Composeç¡®å®æä¸å®šçš„ç‰¹å®šé¢†åŸŸï¼Œå¦‚WebViewï¼Œå¦‚è§†é¢‘ï¼Œå¦‚SurfaceViewæˆ–è€…3Dæ¸²æŸ“ï¼ˆOpenGL ESï¼‰ç­‰ç­‰ã€‚é™¤ä»¥ä¹‹å¤–ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>

<p>è¿˜éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœåŸç”Ÿçš„Viewäº¤äº’æ¯”è¾ƒå¤æ‚ï¼Œä¸å…‰æ˜¯ç‚¹å‡»ï¼Œè¿˜æ¶‰åŠTouchäº‹ä»¶å¤„ç†ï¼Œå¤„ç†äº‹ä»¶çš„åŒæ—¶è¿˜è¦ä¸æ–­æ›´æ–°Viewçš„çŠ¶æ€ï¼Œé‚£ä¹Ÿä¸åº”è¯¥ä½¿ç”¨å®ƒã€‚æ¯”è¾ƒç†æƒ³çš„æƒ…å†µæ˜¯ï¼ŒåµŒå…¥çš„è¿™ä¸ªViewæ˜¯ä¸€ä¸ªæ¯”è¾ƒçº¯ç²¹çš„ç”Ÿäº§è€…ï¼Œæ¯”å¦‚å®ƒåªäº§ç”Ÿäº‹ä»¶ï¼Œä¸éœ€è¦å†å¾€å›æ›´æ–°çŠ¶æ€ï¼›æˆ–è€…æ˜¯ä¸€ä¸ªæ¯”è¾ƒçº¯ç²¹çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚å®ƒå°±è´Ÿè´£å±•ç¤ºï¼Œåªéœ€è¦å¡æ•°æ®å°±è¡Œäº†ã€‚</p>

<h2>æ€»ç»“</h2>

<p>ç½‘ä¸Šçš„æ•™ç¨‹æˆ–è€…Demoä¸­çš„ä¸–ç•Œæ˜¯å¾ˆç¾å¥½çš„ï¼Œå¾€å¾€éƒ½æ˜¯ä¸€ä¸ªæ–°å»ºçš„é¡¹ç›®ï¼Œä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œç›´æ¥å°±è¿›å…¥äº†Composeä¸–ç•Œï¼Œä¹Ÿéƒ½åœ¨è®²Composeèƒ½åšçš„äº‹æƒ…ã€‚ä½†ç°å®çš„ä¸–ç•Œå¾€å¾€ä¸æ˜¯è¿™æ ·å­çš„ï¼Œæå°‘æƒ…å†µä¸‹æ˜¯å…¨æ–°å¼€å§‹çš„é¡¹ç›®ï¼Œå¾€å¾€éœ€è¦ä¸é—ç•™ä»£ç æ‰“äº¤é“ï¼Œéœ€è¦å®ç°çš„éœ€æ±‚ä¹Ÿæ˜¯å¤šç§å¤šæ ·çš„ã€‚æœ¬æ–‡ä¸­ä»‹ç»äº†ä¸¤ä¸ªä¼ é€é—¨ï¼ŒComposeViewå’ŒAndroidViewå¯ä»¥æ–¹ä¾¿åœ°è¿æ¥åŸç”ŸViewå’ŒComposeä¸¤ä¸ªä¸–ç•Œï¼Œä¸ºç°å®é¡¹ç›®ä¸­é‡åˆ°çš„é—®é¢˜æä¾›äº†ä¸€ä¸ªå¯è¡Œçš„è§£å†³æ–¹æ¡ˆã€‚</p>

<h3>è®©Composeæ”¯æŒOpenGL ES</h3>

<ul>
<li><a href="https://stackoverflow.com/questions/78796021/how-to-render-opengl-alongside-jetpack-compose-ui-without-covering-other-element">How to render OpenGL alongside Jetpack Compose UI without covering other elements</a></li>
<li><a href="https://www.reddit.com/r/Kotlin/comments/on36sy/experiment_to_make_opengl_work_together_with/?rdt=62185">Experiment to make OpenGL work together with Jetpack Compose</a></li>
<li><a href="https://composables.com/foundation/androidexternalsurface">AndroidExternalSurface</a></li>
<li><a href="https://youtrack.jetbrains.com/issue/CMP-3810/Using-Open-GL-with-Compose-Multiplatform">Using Open GL with Compose Multiplatform</a></li>
</ul>


<h2>References</h2>

<ul>
<li><a href="https://developer.android.com/develop/ui/compose/migrate/interoperability-apis/compose-in-views">Using Compose in Views</a></li>
<li><a href="https://developer.android.com/develop/ui/compose/migrate/interoperability-apis/views-in-compose">Using Views in Compose</a></li>
<li><a href="https://medium.com/@seungbae2/jetpack-compose-androidview-seamless-integration-of-android-views-into-compose-ui-644f217437d3">Jetpack Compose AndroidView: Seamless Integration of Android Views into Compose UI</a></li>
<li><a href="https://stackoverflow.com/questions/59995970/using-custom-views-with-jetpack-compose">Using Custom Views with Jetpack Compose</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä½¿ç”¨Jetpack Composeæ„å»ºåˆ›æ„åŠ¨ç”»]]></title>
    <link href="https://alexhilton.github.io/blog/2025/05/31/animations-in-jetpack-compose/"/>
    <updated>2025-05-31T23:19:03+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/05/31/animations-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒAnimating Inside and Outside the Box with Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/proandroiddev/animating-inside-and-outside-the-box-with-jetpack-compose-a56eba1b6af6">https://medium.com/proandroiddev/animating-inside-and-outside-the-box-with-jetpack-compose-a56eba1b6af6</a>ï¼Œç”±Nirbhay Pherwaniå‘å¸ƒäº2023å¹´12æœˆ13æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/05/31/animations-in-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDhqS2nzvjXmvlC58vcDNQ.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç¼˜èµ·</h2>

<p>åŠ¨ç”»èƒ½å¤Ÿè®©ç”¨æˆ·ç•Œé¢å……æ»¡æ´»åŠ›ã€å¼•äººå…¥èƒœã€‚åœ¨Androidä¸­ï¼ŒJetpack Composeæä¾›é«˜çº§å·¥å…·ï¼Œè®©ä½ è½»æ¾æŒæ¡è¿™é¡¹å¼ºå¤§åŠŸèƒ½ï¼Œæ‰“é€ çœŸæ­£çš„åŠ¨æ€UIã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ Jetpack Compose ä¸­åŠ¨ç”»çš„æ·±å±‚æŠ€æœ¯ã€‚</p>

<p><strong>è¯‘æ³¨ï¼š</strong> è™½ç„¶åŸæ–‡æ˜¯ä»¥Jetpack Composeä¸ºåŸºç¡€æ¥å†™çš„ï¼Œä½†å…¶å®åŠ¨ç”»è¿™å—å¹¶ä¸æ¶‰åŠå¹³å°ç‰¹æ€§ï¼Œä¹Ÿé€‚ç”¨äºCompose Multiplatformã€‚</p>

<p>æˆ‘ä»¬å°†æ¶µç›–ä¸€ç³»åˆ—æŠ€å·§ï¼Œä»åˆ›å»ºæµç•…çš„ã€åŸºäºç‰©ç†çš„åŠ¨æ•ˆï¼ˆå¢æ·»çœŸå®æ„Ÿï¼‰åˆ°åˆ›å»ºå¤æ‚çš„ç¼–æ’åºåˆ—ï¼ˆä¸ºç•Œé¢å¢æ·»å™äº‹è´¨æ„Ÿï¼‰ã€‚æ— è®ºä½ æ˜¯æƒ³æå‡æŠ€èƒ½ï¼Œè¿˜æ˜¯ä»…ä»…æƒ³æ¢ç´¢æ— é™å¯èƒ½ï¼Œæœ¬æ•™ç¨‹éƒ½å°†æä¾›å®ç”¨çš„è§è§£ï¼Œå¸®åŠ©ä½ çš„åº”ç”¨ä¸ä»…è¿è¡Œæµç•…ï¼Œè¿˜èƒ½è®©ç”¨æˆ·åœ¨æ¯æ¬¡äº¤äº’ä¸­éƒ½æ„Ÿåˆ°æ„‰æ‚¦ã€‚</p>

<p>è®©æˆ‘ä»¬æ·±å…¥æ¢ç´¢è¿™äº›åŠ¨ç”»å¦‚ä½•æ”¹å˜ä½ çš„ UIè®¾è®¡æ–¹æ³•ï¼Œä½¿å…¶æ›´åŠ ç›´è§‚ã€å“åº”è¿…é€Ÿï¼Œå¹¶ä¸ºç”¨æˆ·å¸¦æ¥æ„‰æ‚¦çš„ä½“éªŒã€‚</p>

<h2>ç¬¬ 1 éƒ¨åˆ† â€” Jetpack Composeä¸­çš„è‡ªå®šä¹‰åŠ¨ç”»</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C1_mzDHNHOfSZkIiULgRzw.gif" alt="æ¸¸æˆè§’è‰²çš„ç§»åŠ¨" /></p>

<h3>åˆ©ç”¨è‡ªå®šä¹‰åŠ¨ç”»å®ç°åŠ¨æ€äº¤äº’</h3>

<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•åœ¨ Jetpack Composeä¸­ä½¿ç”¨é«˜çº§è‡ªå®šä¹‰åŠ¨ç”»æ¥åˆ›å»ºåŠ¨æ€ä¸”å¯äº¤äº’çš„ UI å…ƒç´ ã€‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸€ä¸ªçœŸå®ç¤ºä¾‹ï¼Œè¯¥ç¤ºä¾‹æ¼”ç¤ºäº†ç”¨æˆ·äº¤äº’å¦‚ä½•ä»¥æœ‰æ„ä¹‰çš„æ–¹å¼å½±å“åŠ¨ç”»ã€‚</p>

<h3>æ¡ˆä¾‹ - äº¤äº’å¼æ¸¸æˆè§’è‰²ç§»åŠ¨</h3>

<p>æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥è¯´æ˜è¿™ä¸€æ¦‚å¿µï¼Œå…¶ä¸­æ¸¸æˆè§’è‰²ï¼ˆç”±é¢éƒ¨å›¾æ ‡è¡¨ç¤ºï¼‰æ²¿ç€ç”±ç”¨æˆ·å¯æ‹–åŠ¨æ§åˆ¶ç‚¹ç¡®å®šçš„è·¯å¾„ç§»åŠ¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">GameCharacterMovement</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">startPosition</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="m">100f</span><span class="p">,</span> <span class="m">100f</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">endPosition</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="m">250f</span><span class="p">,</span> <span class="m">400f</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">controlPoint</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">(</span><span class="m">200f</span><span class="p">,</span> <span class="m">300f</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">position</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Animatable</span><span class="p">(</span><span class="n">startPosition</span><span class="p">,</span> <span class="n">Offset</span><span class="p">.</span><span class="n">VectorConverter</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">position</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span>
</span><span class='line'>            <span class="n">targetValue</span> <span class="p">=</span> <span class="n">endPosition</span><span class="p">,</span>
</span><span class='line'>            <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">keyframes</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">durationMillis</span> <span class="p">=</span> <span class="m">5000</span>
</span><span class='line'>                <span class="n">controlPoint</span><span class="p">.</span><span class="n">value</span> <span class="n">at</span> <span class="m">2500</span> <span class="c1">// å¯æ‹–åŠ¨æ§åˆ¶ç‚¹æ§åˆ¶çš„ä¸­é—´ç‚¹</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">onControlPointChange</span><span class="p">:</span> <span class="p">(</span><span class="n">offset</span><span class="p">:</span> <span class="n">Offset</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">controlPoint</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Face</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Localized description&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="n">position</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">dp</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">position</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">DraggableControlPoint</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">onControlPointChange</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>GameCharacterMovement ä¸ºä»£è¡¨æ¸¸æˆè§’è‰²çš„å›¾æ ‡è®¾ç½®åŠ¨ç”»ã€‚åŠ¨ç”»è·¯å¾„ç”± controlPoint æ§åˆ¶ï¼Œè¯¥æ§åˆ¶ç‚¹é€šè¿‡ç”¨æˆ·äº¤äº’è®¾ç½®å’Œæ›´æ–°ã€‚</li>
<li>Animatable ç”¨äºå°†å›¾æ ‡çš„ä½ç½®ä» startPosition å¹³æ»‘è¿‡æ¸¡åˆ° endPositionã€‚</li>
<li>LaunchedEffect ç›‘å¬ controlPoint å€¼çš„å˜åŒ–ï¼Œå¹¶åœ¨æ§åˆ¶ç‚¹ç§»åŠ¨æ—¶é‡æ–°è§¦å‘åŠ¨ç”»ã€‚</li>
<li>animationSpec â€” è¿™æ˜¯ä¸€ç§é…ç½®é¡¹ï¼Œç”¨äºå®šä¹‰åŠ¨ç”»çš„æŒç»­æ—¶é—´ã€å»¶è¿Ÿå’Œç¼“åŠ¨ã€‚å®ƒå†³å®šäº†åŠ¨ç”»å€¼å¦‚ä½•éšæ—¶é—´å˜åŒ–ã€‚</li>
<li>keyframes â€” å…è®¸ä½ åœ¨åŠ¨ç”»çš„ç‰¹å®šæ—¶é—´ç‚¹æŒ‡å®šå€¼ï¼Œä»è€Œæ§åˆ¶åŠ¨ç”»çš„ä¸­é—´ç‚¹ã€‚è¿™å¯¹äºåˆ›å»ºå¤æ‚çš„ã€ç²¾å¿ƒè®¾è®¡çš„åŠ¨ç”»ç‰¹åˆ«æœ‰ç”¨ã€‚</li>
<li>keyframes å—å°†åŠ¨ç”»å®šä¹‰ä¸ºä¸€ç³»åˆ—å…³é”®å¸§ã€‚åœ¨ 2500 æ¯«ç§’ï¼ˆä¸­é—´ç‚¹ï¼‰æ—¶ï¼Œè§’è‰²åˆ°è¾¾æ§åˆ¶ç‚¹ï¼Œç„¶åç»§ç»­ç§»åŠ¨åˆ°ç»“æŸä½ç½®ã€‚</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DraggableControlPoint</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span> <span class="n">onControlPointChange</span><span class="p">:</span> <span class="p">(</span><span class="n">Offset</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">localPosition</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">controlPoint</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">offset</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">IntOffset</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">x</span> <span class="p">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">()</span> <span class="p">-</span> <span class="m">15</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">y</span> <span class="p">=</span> <span class="n">localPosition</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">roundToInt</span><span class="p">()</span> <span class="p">-</span> <span class="m">15</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">30.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">detectDragGestures</span><span class="p">(</span><span class="n">onDragEnd</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">onControlPointChange</span><span class="p">(</span><span class="n">localPosition</span><span class="p">)</span>
</span><span class='line'>                <span class="p">})</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">dragAmount</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="c1">// adjust based on screen bounds</span>
</span><span class='line'>                    <span class="k">val</span> <span class="py">newX</span> <span class="p">=</span> <span class="p">(</span><span class="n">localPosition</span><span class="p">.</span><span class="n">x</span> <span class="p">+</span> <span class="n">dragAmount</span><span class="p">.</span><span class="n">x</span><span class="p">).</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">600f</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">val</span> <span class="py">newY</span> <span class="p">=</span> <span class="p">(</span><span class="n">localPosition</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">dragAmount</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">600f</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">localPosition</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="n">newX</span><span class="p">,</span> <span class="n">newY</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>DraggableControlPoint æ˜¯ä¸€ä¸ªå¯ç»„åˆé¡¹ï¼Œå…è®¸ç”¨æˆ·ä»¥äº¤äº’æ–¹å¼æ›´æ”¹æ§åˆ¶ç‚¹çš„ä½ç½®ã€‚</li>
<li>æ‹–åŠ¨æ§åˆ¶ç‚¹ä¼šæ›´æ–° localPositionï¼Œå¹¶åœ¨æ‹–åŠ¨æ‰‹åŠ¿å®Œæˆï¼ˆonDragEndï¼‰åå°†å…¶åé¦ˆå› GameCharacterMovementã€‚æ­¤äº¤äº’ä¼šæ”¹å˜åŠ¨ç”»å›¾æ ‡çš„è·¯å¾„ã€‚</li>
</ul>


<h3>å®é™…ç”¨ä¾‹</h3>

<ol>
<li>äº¤äº’å¼æ•™è‚²åº”ç”¨ï¼šåœ¨æ•™è‚²åº”ç”¨ä¸­ï¼ŒåŠ¨ç”»å¯ç”¨äºæå‡å­¦ä¹ çš„å¸å¼•åŠ›ã€‚ä¾‹å¦‚ï¼Œåœ¨å¤©æ–‡å­¦åº”ç”¨ä¸­ï¼Œæ‹–åŠ¨è¡Œæ˜Ÿæ²¿å…¶è½¨é“è¿è¡Œå³å¯æŸ¥çœ‹ä¸åŒçš„æ˜Ÿåº§ã€‚</li>
<li>äº¤äº’å¼æ•…äº‹å™è¿°å’Œæ¸¸æˆï¼šåœ¨æ•°å­—æ•…äº‹å™è¿°æˆ–æ¸¸æˆåº”ç”¨ä¸­ï¼Œå…è®¸ç”¨æˆ·é€šè¿‡å¯æ‹–åŠ¨å…ƒç´ æ¥å½±å“æ•…äº‹æˆ–æ¸¸æˆç¯å¢ƒï¼Œå¯ä»¥åˆ›é€ æ›´å…·æ²‰æµ¸æ„Ÿçš„ä½“éªŒã€‚</li>
</ol>


<h2>ç¬¬ 2 éƒ¨åˆ† â€” åœ¨ Jetpack Composeä¸­ç¼–æ’å¤æ‚åŠ¨ç”»</h2>

<h3>åŒæ­¥å¤šä¸ªå…ƒç´ ä»¥å®ç°å’Œè°æ•ˆæœ</h3>

<p>åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨åœ¨ Jetpack Compose ä¸­ç¼–æ’ï¼ˆChoreographingï¼‰å¤æ‚åŠ¨ç”»çš„è‰ºæœ¯ã€‚æˆ‘ä»¬ä¸“æ³¨äºåˆ›å»ºåŒæ­¥åŠ¨ç”»ï¼Œä½¿å¤šä¸ªå…ƒç´ èƒ½å¤Ÿæ— ç¼äº¤äº’ï¼Œä»è€Œæå‡æ•´ä½“ç”¨æˆ·ä½“éªŒã€‚</p>

<h3>A) è¿é”ååº”åŠ¨ç”» â€” å¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”</h3>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iNeJJU3ixcdcZnQFHHSWYw.gif" alt="å¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”" /></p>

<p>é€šè¿‡è®¾ç½®ä¸€ç³»åˆ—åŠ¨ç”»å¯ä»¥åœ¨ UI ä¸­åˆ›å»ºå¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”ï¼Œå…¶ä¸­ä¸€ä¸ªåŠ¨ç”»çš„å®Œæˆä¼šè§¦å‘ä¸‹ä¸€ä¸ªåŠ¨ç”»çš„å¼€å§‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DominoEffect</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">animatedValues</span> <span class="p">=</span> <span class="n">List</span><span class="p">(</span><span class="m">6</span><span class="p">)</span> <span class="p">{</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Animatable</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">animatedValues</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">animate</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">animate</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span>
</span><span class='line'>                <span class="n">targetValue</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span>
</span><span class='line'>                <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span> <span class="n">delayMillis</span> <span class="p">=</span> <span class="n">index</span> <span class="p">*</span> <span class="m">100</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span> <span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()){</span>
</span><span class='line'>      <span class="n">animatedValues</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="p">((</span><span class="n">index</span><span class="p">+</span><span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">50</span><span class="p">).</span><span class="n">dp</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="p">((</span><span class="n">index</span><span class="p">+</span><span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="m">30</span><span class="p">).</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">getRandomColor</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">value</span><span class="p">.</span><span class="n">value</span><span class="p">))</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">getRandomColor</span><span class="p">(</span><span class="n">seed</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">Color</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">random</span> <span class="p">=</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span> <span class="p">=</span> <span class="n">seed</span><span class="p">).</span><span class="n">nextInt</span><span class="p">(</span><span class="m">256</span><span class="p">)</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Color</span><span class="p">(</span><span class="n">random</span><span class="p">,</span> <span class="n">random</span><span class="p">,</span> <span class="n">random</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>animatedValues æ˜¯ä¸€ä¸ªAnimatableå¯¹è±¡çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå€¼æ§åˆ¶ä¸€ä¸ªæ¡†çš„ Alphaï¼ˆä¸é€æ˜åº¦ï¼‰ã€‚</li>
<li>LaunchedEffect ä¼šè§¦å‘è¿™äº›å€¼çš„ä¸€ç³»åˆ—åŠ¨ç”»ï¼Œä»è€Œåˆ›å»ºä¸€ç§äº¤é”™æ•ˆæœï¼Œå³æ¯ä¸ªæ¡†åœ¨å‰ä¸€ä¸ªæ¡†ä¹‹åæ·¡å…¥ï¼Œç±»ä¼¼äºå¤šç±³è¯ºéª¨ç‰Œå€’ä¸‹ã€‚</li>
<li>getRandomColor å‡½æ•°ä¼šä¸ºæ¯ä¸ªæ¡†ç”Ÿæˆéšæœºçš„ç°è‰²é˜´å½±ï¼Œä¸ºåºåˆ—ä¸­çš„æ¯ä¸ªç»„ä»¶æ·»åŠ ç‹¬ç‰¹çš„è§†è§‰å…ƒç´ ã€‚</li>
<li>è¿™äº›æ¡†æ²¿å±å¹•å¯¹è§’çº¿æ”¾ç½®ï¼Œå¢å¼ºäº†å¤šç±³è¯ºéª¨ç‰Œæ•ˆåº”ã€‚</li>
</ul>


<h3>B) äº¤äº’å¼æ»šåŠ¨æ—¶é—´è½´</h3>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kk-V0g5pEqy83NajRy_6lA.gif" alt="äº¤äº’å¼æ»šåŠ¨æ—¶é—´è½´" /></p>

<p>åœ¨è¿™ä¸ªæ—¶é—´è½´ä¸­ï¼Œæ¯ä¸ªå…ƒç´ éƒ½ä¼šéšç€ç”¨æˆ·æ»šåŠ¨è€Œæ·¡å…¥å¹¶ç§»åŠ¨åˆ°ä½ã€‚æˆ‘ä»¬å°†ä½¿ç”¨ LazyColumnæ¥å‘ˆç°å¯æ»šåŠ¨åˆ—è¡¨ï¼Œå¹¶ä½¿ç”¨Animatableæ¥å‘ˆç°åŠ¨ç”»ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">InteractiveTimeline</span><span class="p">(</span><span class="n">timelineItems</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">scrollState</span> <span class="p">=</span> <span class="n">rememberLazyListState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LazyColumn</span><span class="p">(</span><span class="n">state</span> <span class="p">=</span> <span class="n">scrollState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">itemsIndexed</span><span class="p">(</span><span class="n">timelineItems</span><span class="p">)</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">item</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">animatableAlpha</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Animatable</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">isVisible</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">derivedStateOf</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">scrollState</span><span class="p">.</span><span class="n">firstVisibleItemIndex</span> <span class="p">&lt;=</span> <span class="n">index</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isVisible</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">isVisible</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">animatableAlpha</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span>
</span><span class='line'>                        <span class="m">1f</span><span class="p">,</span> <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1000</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">TimelineItem</span><span class="p">(</span>
</span><span class='line'>                <span class="n">text</span> <span class="p">=</span> <span class="n">item</span><span class="p">,</span>
</span><span class='line'>                <span class="n">alpha</span> <span class="p">=</span> <span class="n">animatableAlpha</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TimelineItem</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="n">Float</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">DarkGray</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">text</span><span class="p">,</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">textAlign</span> <span class="p">=</span> <span class="n">TextAlign</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontSize</span> <span class="p">=</span> <span class="m">18.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">SemiBold</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>animatableAlpha æ§åˆ¶æ¯ä¸ªæ—¶é—´è½´é¡¹ç›®çš„ Alphaï¼ˆä¸é€æ˜åº¦ï¼‰ï¼Œåˆå§‹è®¾ç½®ä¸º 0ï¼ˆå®Œå…¨é€æ˜ï¼‰ã€‚</li>
<li>isVisible çŠ¶æ€æºè‡ªå½“å‰æ»šåŠ¨ä½ç½®ï¼Œç”¨äºç¡®å®šé¡¹ç›®æ˜¯å¦å¯è§ã€‚</li>
<li>å½“ç”¨æˆ·æ»šåŠ¨æ—¶ï¼ŒLaunchedEffectä¼šè§¦å‘è¿›å…¥è§†å£çš„é¡¹ç›®çš„æ·¡å…¥åŠ¨ç”»ã€‚</li>
</ul>


<h4>ç”¨ä¾‹</h4>

<p>æ­¤äº¤äº’å¼æ—¶é—´è½´éå¸¸é€‚åˆé‚£äº›å¸Œæœ›ä»¥è§†è§‰å¸å¼•åŠ›åè¶³çš„æ–¹å¼å‘ˆç°ä¸€ç³»åˆ—äº‹ä»¶æˆ–æ­¥éª¤çš„åº”ç”¨ã€‚åŠ¨ç”»é€šè¿‡åœ¨é¡¹ç›®è¿›å…¥è§†é‡æ—¶å¸å¼•ç”¨æˆ·çš„æ³¨æ„åŠ›æ¥å¢å¼ºç”¨æˆ·çš„å‚ä¸åº¦ã€‚</p>

<p><strong>æ­¤ç±»åŠ¨ç”»ä¸ä»…å¼•äººå…¥èƒœï¼Œè¿˜å¯ä»¥ç”¨æ¥å¼•å¯¼ç”¨æˆ·å…³æ³¨åº”ç”¨ä¸­çš„ä¸€ç³»åˆ—äº‹ä»¶æˆ–æ“ä½œã€‚</strong></p>

<h2>ç¬¬ 3 éƒ¨åˆ† â€” Jetpack Composeä¸­åŸºäºç‰©ç†çš„çœŸå®åŠ¨ç”»</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZ_rpGorcFzewpUJN6WPAQ.gif" alt="å¼¹æ€§æ‹–æ‹½åŠ¨ç”»" /></p>

<h3>åˆ©ç”¨ç‰©ç†åŸç†å¢å¼ºUIåŠ¨æ€æ•ˆæœ</h3>

<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•ä½¿ç”¨ Jetpack Composeå°†ç‰©ç†åŸç†èå…¥åŠ¨ç”»ï¼Œä¸º UI å¢æ·»ä¸€å±‚çœŸå®æ„Ÿå’Œäº¤äº’æ€§ã€‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸€ä¸ªå¼¹æ€§æ‹–æ‹½äº¤äº’ç¤ºä¾‹ã€‚</p>

<h3>æ‹–æ‹½æ—¶çš„å¼¹æ€§æ•ˆæœ</h3>

<p>æ­¤ç¤ºä¾‹æ¼”ç¤ºäº†å›¾æ ‡ä¸Šçš„å¼¹æ€§æ‹–æ‹½äº¤äº’ã€‚å‚ç›´æ‹–åŠ¨æ—¶ï¼Œå›¾æ ‡ä¼šæ‹‰ä¼¸å¹¶å›å¼¹ï¼Œäº§ç”Ÿå¼¹æ€§æ•ˆæœï¼Œæ¨¡æ‹Ÿå¼¹ç°§æˆ–æ©¡çš®ç­‹â€‹â€‹çš„è¡Œä¸ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ElasticDraggableBox</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">animatableOffset</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Animatable</span><span class="p">(</span><span class="m">0f</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFFFA732</span><span class="p">)),</span> <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">offset</span><span class="p">(</span><span class="n">y</span> <span class="p">=</span> <span class="n">animatableOffset</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">draggable</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">orientation</span> <span class="p">=</span> <span class="n">Orientation</span><span class="p">.</span><span class="n">Vertical</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">state</span> <span class="p">=</span> <span class="n">rememberDraggableState</span> <span class="p">{</span> <span class="n">delta</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">animatableOffset</span> <span class="p">=</span> <span class="n">Animatable</span><span class="p">(</span><span class="n">animatableOffset</span><span class="p">.</span><span class="n">value</span> <span class="p">+</span> <span class="n">delta</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="n">onDragStopped</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">animatableOffset</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">spring</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">350.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Favorite</span><span class="p">,</span>
</span><span class='line'>                <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;heart&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">animatableOffset</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">dp</span> <span class="p">+</span> <span class="m">150.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                <span class="n">tint</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>è¯´æ˜</h4>

<ul>
<li>ä½¿ç”¨ draggable ä¿®é¥°ç¬¦å°†åŒ…å«å›¾æ ‡çš„ Box å¯ç»„åˆé¡¹è®¾ç½®ä¸ºå¯æ‹–åŠ¨ã€‚</li>
<li>animatableOffset è·Ÿè¸ªå›¾æ ‡å› æ‹–åŠ¨è€Œäº§ç”Ÿçš„å‚ç›´åç§»ã€‚</li>
<li>åœ¨æ‹–åŠ¨è¿‡ç¨‹ä¸­ï¼Œå›¾æ ‡çš„å¤§å°ä¼šæ ¹æ®æ‹–åŠ¨é‡è€Œå˜åŒ–ï¼Œä»è€Œäº§ç”Ÿæ‹‰ä¼¸æ•ˆæœã€‚</li>
<li>å½“æ‹–åŠ¨åœæ­¢ï¼ˆonDragStoppedï¼‰æ—¶ï¼ŒanimatableOffset ä¼šä½¿ç”¨å¼¹ç°§åŠ¨ç”»è¿”å›åˆ° 0fï¼Œä»è€Œä½¿å›¾æ ‡å¼¹å›å…¶åŸå§‹å¤§å°å’Œä½ç½®ã€‚</li>
</ul>


<h2>ç¬¬ 4 èŠ‚ â€” Jetpack Compose ä¸­çš„æ‰‹åŠ¿åŠ¨ç”»</h2>

<h3>é€šè¿‡å“åº”å¼æ‰‹åŠ¿æå‡ç”¨æˆ·ä½“éªŒ</h3>

<p>åœ¨æœ¬éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ¢ç´¢å¦‚ä½•ä½¿ç”¨ Jetpack Compose åˆ›å»ºç”±ç”¨æˆ·æ‰‹åŠ¿æ§åˆ¶çš„åŠ¨ç”»ã€‚æˆ‘ä»¬å°†é‡ç‚¹ä»‹ç»ä¸¤ä¸ªç¤ºä¾‹â€”â€”ä¸€ä¸ªæ”¯æŒå¤šç‚¹è§¦æ§çš„å¯å˜å½¢å›¾åƒå’Œä¸€ä¸ªç”±æ‰‹åŠ¿æ§åˆ¶çš„éŸ³é¢‘æ³¢å½¢ã€‚</p>

<h3>A) å¤šç‚¹è§¦æ§å¯å˜å½¢å›¾åƒ</h3>

<p>åœ¨æœ¬ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå›¾åƒè§†å›¾ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨æåˆã€ç¼©æ”¾å’Œæ—‹è½¬ç­‰å¤šç‚¹è§¦æ§ï¼ˆMulti-touchï¼‰æ‰‹åŠ¿è¿›è¡Œäº¤äº’ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*34WxcBivTWhiCY6KVSVelQ.gif" alt="å¤šç‚¹è§¦æ§å¯å˜å½¢å›¾åƒ" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TransformableImage</span><span class="p">(</span><span class="n">imageId</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">android</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">scale</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">rotation</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">offset</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">DarkGray</span><span class="p">),</span> <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>            <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">imageId</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Transformable image&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">300.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">scaleX</span> <span class="p">=</span> <span class="n">scale</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">scaleY</span> <span class="p">=</span> <span class="n">scale</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">rotationZ</span> <span class="p">=</span> <span class="n">rotation</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">translationX</span> <span class="p">=</span> <span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">translationY</span> <span class="p">=</span> <span class="n">offset</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">detectTransformGestures</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">pan</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">rotate</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">scale</span> <span class="p">*=</span> <span class="n">zoom</span>
</span><span class='line'>                        <span class="n">rotation</span> <span class="p">+=</span> <span class="n">rotate</span>
</span><span class='line'>                        <span class="n">offset</span> <span class="p">+=</span> <span class="n">pan</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>Image å¯ç»„åˆé¡¹é€šè¿‡ graphicsLayer è¿›è¡Œä¿®æ”¹ï¼Œä»¥åº”ç”¨ç¼©æ”¾ã€æ—‹è½¬å’Œå¹³ç§»ç­‰å˜æ¢ã€‚</li>
<li>pointerInput å¸¦æœ‰ detectTransformGestures æ¥å£ï¼Œç”¨äºå¤„ç†å¤šç‚¹è§¦æ§æ‰‹åŠ¿ï¼Œå¹¶ç›¸åº”åœ°æ›´æ–°ç¼©æ”¾ã€æ—‹è½¬å’Œåç§»ã€‚</li>
</ul>


<h3>B) æ‰‹åŠ¿æ§åˆ¶æ³¢å½¢</h3>

<p>è¿™æ˜¯ä¸€ä¸ªæ³¢å½¢å¯è§†åŒ–æ•ˆæœï¼Œå®ƒæ ¹æ®ç”¨æˆ·æ‰‹åŠ¿ï¼ˆä¾‹å¦‚æ»‘åŠ¨å’Œæåˆï¼‰æ”¹å˜å¤–è§‚ï¼Œä»¥æ§åˆ¶å¹…åº¦å’Œé¢‘ç‡ç­‰æ–¹é¢ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qKzb1XpUrSGKdCL-OxhtLw.gif" alt="æ‰‹åŠ¿æ§åˆ¶æ³¢å½¢" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">GestureControlledWaveform</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">amplitude</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">100f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">frequency</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Canvas</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">detectDragGestures</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">dragAmount</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">amplitude</span> <span class="p">+=</span> <span class="n">dragAmount</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                <span class="n">frequency</span> <span class="p">+=</span> <span class="n">dragAmount</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="m">500f</span>
</span><span class='line'>                <span class="c1">// æ ¹æ®æ‹–æ‹½è°ƒæ•´é¢‘ç‡</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Brush</span><span class="p">.</span><span class="n">verticalGradient</span><span class="p">(</span>
</span><span class='line'>                <span class="n">colors</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF003366</span><span class="p">),</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF66B2FF</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">width</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">height</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">path</span> <span class="p">=</span> <span class="n">Path</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">halfHeight</span> <span class="p">=</span> <span class="n">height</span> <span class="p">/</span> <span class="m">2</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">waveLength</span> <span class="p">=</span> <span class="n">width</span> <span class="p">/</span> <span class="n">frequency</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">path</span><span class="p">.</span><span class="n">moveTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">halfHeight</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="k">in</span> <span class="m">0</span> <span class="n">until</span> <span class="n">width</span><span class="p">.</span><span class="n">toInt</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">theta</span> <span class="p">=</span> <span class="p">(</span><span class="m">2.0</span> <span class="p">*</span> <span class="n">Math</span><span class="p">.</span><span class="n">PI</span> <span class="p">*</span> <span class="n">x</span> <span class="p">/</span> <span class="n">waveLength</span><span class="p">).</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">y</span> <span class="p">=</span> <span class="n">halfHeight</span> <span class="p">+</span> <span class="n">amplitude</span> <span class="p">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">.</span><span class="n">toDouble</span><span class="p">()).</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>            <span class="n">path</span><span class="p">.</span><span class="n">lineTo</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">gradient</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">horizontalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="n">colors</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Cyan</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Magenta</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">drawPath</span><span class="p">(</span>
</span><span class='line'>            <span class="n">path</span> <span class="p">=</span> <span class="n">path</span><span class="p">,</span>
</span><span class='line'>            <span class="n">brush</span> <span class="p">=</span> <span class="n">gradient</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>amplitude å’Œ frequency æ˜¯çŠ¶æ€å˜é‡ï¼Œåˆ†åˆ«æ§åˆ¶æ³¢å½¢çš„å¹…åº¦å’Œé¢‘ç‡ã€‚</li>
<li>Canvas å¯ç»„åˆé¡¹ç”¨äºç»˜åˆ¶æ³¢å½¢ã€‚Canvas å†…éƒ¨çš„ç»˜åˆ¶é€»è¾‘æ ¹æ®æ­£å¼¦å‡½æ•°è®¡ç®—æ¯ä¸ª X ä½ç½®çš„ Y ä½ç½®ï¼Œä»è€Œåˆ›å»ºæ³¢æµªæ•ˆæœã€‚</li>
<li>detectDragGestures ä¿®é¥°ç¬¦ç”¨äºæ ¹æ®ç”¨æˆ·æ‹–åŠ¨æ‰‹åŠ¿æ›´æ–°å¹…åº¦å’Œé¢‘ç‡ã€‚æ°´å¹³æ‹–åŠ¨è°ƒæ•´é¢‘ç‡ï¼Œå‚ç›´æ‹–åŠ¨è°ƒæ•´å¹…åº¦ã€‚</li>
<li>å½“ç”¨æˆ·åœ¨å±å¹•ä¸Šæ‹–åŠ¨æ—¶ï¼Œæ³¢å½¢çš„å½¢çŠ¶ä¼šç›¸åº”å˜åŒ–ï¼Œä»è€Œè¥é€ å‡ºäº’åŠ¨ä½“éªŒã€‚</li>
</ul>


<h4>æ³¨æ„äº‹é¡¹</h4>

<ul>
<li>è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„å®ç°ã€‚ä¸ºäº†è·å¾—æ›´é€¼çœŸçš„éŸ³é¢‘æ³¢å½¢ï¼Œä½ éœ€è¦é›†æˆå®é™…çš„éŸ³é¢‘æ•°æ®ã€‚</li>
<li>å¯ä»¥é€šè¿‡è°ƒæ•´æ‹–åŠ¨è¿‡ç¨‹ä¸­å¹…åº¦å’Œé¢‘ç‡çš„ä¿®æ”¹æ–¹å¼æ¥å¾®è°ƒæ³¢å½¢å¯¹æ‰‹åŠ¿çš„å“åº”èƒ½åŠ›ã€‚</li>
</ul>


<p>æ­¤ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•åœ¨ Compose ä¸­åˆ›å»ºåŸºæœ¬çš„äº¤äº’å¼æ³¢å½¢ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å…¶è¿›è¡Œæ‰©å±•æˆ–ä¿®æ”¹ï¼Œä»¥ç”¨äºæ›´å¤æ‚çš„ç”¨ä¾‹æˆ–å¤„ç†æ›´å¤æ‚çš„æ‰‹åŠ¿ã€‚</p>

<h2>ç¬¬ 5 èŠ‚ â€” Jetpack Compose ä¸­çš„çŠ¶æ€é©±åŠ¨åŠ¨ç”»æ¨¡å¼</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nkfhmC6JjQnshL3y_izhKg.gif" alt="å¸¦åŠ¨ç”»çº¿å›¾" /></p>

<h3>åŸºäºæ•°æ®å’ŒçŠ¶æ€å˜åŒ–çš„UIåŠ¨ç”»</h3>

<p>æœ¬éƒ¨åˆ†é‡ç‚¹ä»‹ç»å¦‚ä½•åˆ›å»ºç”±æ•°æ®æˆ–UI çŠ¶æ€å˜åŒ–é©±åŠ¨çš„åŠ¨ç”»ï¼Œä»è€Œå¢å¼ºåº”ç”¨çš„äº¤äº’æ€§å’Œå“åº”èƒ½åŠ›ã€‚æˆ‘ä»¬å°†æ¢è®¨ä¸¤ä¸ªå…·ä½“ç¤ºä¾‹â€”â€”æ•°æ®å›¾åŠ¨ç”»å’Œåœ¨å¤šçŠ¶æ€ UI ä¸­å®ç°çŠ¶æ€è½¬æ¢ã€‚</p>

<h3>A) æ•°æ®é©±åŠ¨çš„å›¾å½¢åŠ¨ç”»</h3>

<p>æœ¬ç¤ºä¾‹æ¼”ç¤ºäº†ä¸€ä¸ªåŠ¨ç”»çº¿å›¾ï¼Œå…¶ä¸­å›¾å½¢çš„è·¯å¾„ï¼ˆPathï¼‰ä¼šéšç€æ•°æ®é›†çš„å˜åŒ–è€Œå˜åŒ–ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AnimatedGraphExample</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">dataPoints</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">generateRandomDataPoints</span><span class="p">(</span><span class="m">5</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">DarkGray</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">AnimatedLineGraph</span><span class="p">(</span><span class="n">dataPoints</span> <span class="p">=</span> <span class="n">dataPoints</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">dataPoints</span> <span class="p">=</span> <span class="n">generateRandomDataPoints</span><span class="p">(</span><span class="m">5</span><span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">CenterHorizontally</span><span class="p">),</span>
</span><span class='line'>            <span class="n">colors</span> <span class="p">=</span> <span class="n">ButtonDefaults</span><span class="p">.</span><span class="n">buttonColors</span><span class="p">(</span><span class="n">containerColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                <span class="s">&quot;Update Data&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Bold</span><span class="p">,</span>
</span><span class='line'>                <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">DarkGray</span><span class="p">,</span>
</span><span class='line'>                <span class="n">fontSize</span> <span class="p">=</span> <span class="m">18.</span><span class="n">sp</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AnimatedLineGraph</span><span class="p">(</span><span class="n">dataPoints</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Float</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">animatableDataPoints</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">dataPoints</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">Animatable</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">path</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Path</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">dataPoints</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">animatableDataPoints</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">animatable</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">animatable</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span><span class="n">dataPoints</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">TweenSpec</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">500</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Canvas</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">400.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">path</span><span class="p">.</span><span class="n">reset</span><span class="p">()</span>
</span><span class='line'>        <span class="n">animatableDataPoints</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">animatable</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">x</span> <span class="p">=</span> <span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">/</span> <span class="p">(</span><span class="n">dataPoints</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="m">1</span><span class="p">))</span> <span class="p">*</span> <span class="n">index</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">y</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">-</span> <span class="p">(</span><span class="n">animatable</span><span class="p">.</span><span class="n">value</span> <span class="p">*</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span> <span class="n">path</span><span class="p">.</span><span class="n">moveTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">else</span> <span class="n">path</span><span class="p">.</span><span class="n">lineTo</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">drawPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">Stroke</span><span class="p">(</span><span class="m">5f</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">generateRandomDataPoints</span><span class="p">(</span><span class="n">size</span><span class="p">:</span> <span class="n">Int</span><span class="p">):</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Float</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">List</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>AnimatedGraphExample å¯ç»„åˆé¡¹åˆ›å»ºäº†ä¸€ä¸ªå¯ä»¥æ›´æ–°æŠ˜çº¿å›¾æ•°æ®ç‚¹çš„ç¯å¢ƒã€‚</li>
<li>è¯¥å›¾è¡¨ç»˜åˆ¶åœ¨ Canvas ä¸­ï¼Œå…¶ä¸­ drawPath æ–¹æ³•ä½¿ç”¨æ¥è‡ª animatableDataPoints çš„åŠ¨ç”»å€¼ã€‚</li>
<li>å¯¹äºå›¾è¡¨ä¸­çš„æ¯ä¸ªæ•°æ®ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—å…¶åœ¨ç”»å¸ƒä¸Šå¯¹åº”çš„ xï¼ˆæ°´å¹³ï¼‰å’Œ yï¼ˆå‚ç›´ï¼‰ä½ç½®ã€‚</li>
<li>x è®¡ç®— - x ä½ç½®æ˜¯æ ¹æ®æ•°æ®ç‚¹çš„ç´¢å¼•å’Œç”»å¸ƒçš„æ€»å®½åº¦è®¡ç®—å¾—å‡ºçš„ã€‚æˆ‘ä»¬å°†æ•°æ®ç‚¹æ²¿ç”»å¸ƒçš„å®½åº¦å‡åŒ€åˆ†å¸ƒã€‚</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">x</span> <span class="p">=</span> <span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">/</span> <span class="p">(</span><span class="n">dataPoints</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="m">1</span><span class="p">))</span> <span class="p">*</span> <span class="n">index</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>y è®¡ç®—â€”â€”y ä½ç½®æ˜¯æ ¹æ®æ•°æ®ç‚¹ï¼ˆanimatable.valueï¼‰çš„å€¼å’Œç”»å¸ƒçš„é«˜åº¦è®¡ç®—çš„ã€‚</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">y</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">-</span> <span class="p">(</span><span class="n">animatable</span><span class="p">.</span><span class="n">value</span> <span class="p">*</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>è·¯å¾„ä»ç¬¬ä¸€ä¸ªæ•°æ®ç‚¹å¼€å§‹ï¼Œç„¶åä½¿ç”¨ lineTo ç»˜åˆ¶ä¸€æ¡çº¿åˆ°æ¯ä¸ªåç»­ç‚¹ï¼Œä»è€Œåˆ›å»ºå›¾å½¢çº¿ã€‚</li>
<li>è·¯å¾„åŸºäºæ•°æ®ç‚¹çš„åŠ¨ç”»å€¼ç»˜åˆ¶ï¼Œä»è€Œåœ¨æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶åˆ›å»ºåŠ¨ç”»æ•ˆæœã€‚</li>
</ul>


<h3>B) å¤šçŠ¶æ€ UI ä¸­çš„çŠ¶æ€è½¬æ¢</h3>

<p>å¯ä»¥ä½¿ç”¨ Animatable åœ¨å¤šçŠ¶æ€ UI ä¸­å®ç°çŠ¶æ€è½¬æ¢ï¼Œä»è€Œåœ¨ä¸åŒ UI çŠ¶æ€ä¹‹é—´è¿›è¡ŒåŠ¨ç”»å¤„ç†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">enum</span> <span class="k">class</span> <span class="nc">UIState</span> <span class="p">{</span> <span class="n">StateA</span><span class="p">,</span> <span class="n">StateB</span><span class="p">,</span> <span class="n">StateC</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">StateTransitionUI</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">currentState</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">UIState</span><span class="p">.</span><span class="n">StateA</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">getBackgroundColorForState</span><span class="p">(</span><span class="n">currentState</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">AnimatedContent</span><span class="p">(</span><span class="n">currentState</span> <span class="p">=</span> <span class="n">currentState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">=</span> <span class="n">getNextState</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomCenter</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Next State&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AnimatedContent</span><span class="p">(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">UIState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">AnimatedVisibility</span><span class="p">(</span>
</span><span class='line'>        <span class="n">visible</span> <span class="p">=</span> <span class="n">currentState</span> <span class="p">==</span> <span class="n">UIState</span><span class="p">.</span><span class="n">StateA</span><span class="p">,</span>
</span><span class='line'>        <span class="n">enter</span> <span class="p">=</span> <span class="n">fadeIn</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">))</span> <span class="p">+</span> <span class="n">expandVertically</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">exit</span> <span class="p">=</span> <span class="n">fadeOut</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">2000</span><span class="p">))</span> <span class="p">+</span> <span class="n">shrinkVertically</span><span class="p">()</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;This is ${currentState.name}&quot;</span><span class="p">,</span> <span class="n">fontSize</span> <span class="p">=</span> <span class="m">32.</span><span class="n">sp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ä¸B å’Œ C çš„ç±»ä¼¼çš„ä»£ç å—</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">getBackgroundColorForState</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">UIState</span><span class="p">):</span> <span class="n">Color</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateA</span> <span class="p">-&gt;</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateB</span> <span class="p">-&gt;</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateC</span> <span class="p">-&gt;</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">getNextState</span><span class="p">(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">UIState</span><span class="p">):</span> <span class="n">UIState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">currentState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateA</span> <span class="p">-&gt;</span> <span class="n">UIState</span><span class="p">.</span><span class="n">StateB</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateB</span> <span class="p">-&gt;</span> <span class="n">UIState</span><span class="p">.</span><span class="n">StateC</span>
</span><span class='line'>        <span class="n">UIState</span><span class="p">.</span><span class="n">StateC</span> <span class="p">-&gt;</span> <span class="n">UIState</span><span class="p">.</span><span class="n">StateA</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼ŒAnimatedVisibility ç”¨äºä¸ºæ¯ä¸ªçŠ¶æ€ä¸‹å†…å®¹çš„å‡ºç°å’Œæ¶ˆå¤±æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚è¿™ä¼šåœ¨çŠ¶æ€å˜åŒ–æ—¶æ·»åŠ å¹³æ»‘çš„è¿‡æ¸¡æ•ˆæœã€‚</li>
<li>å¯¹äºæ¯ä¸ªçŠ¶æ€ï¼ˆStateAã€StateBã€StateCï¼‰ï¼Œéƒ½æœ‰ä¸€ä¸ª AnimatedVisibility å—ï¼Œç”¨äºé€šè¿‡æ·¡å…¥æ·¡å‡ºå’Œå±•å¼€/æ”¶ç¼©åŠ¨ç”»æ§åˆ¶å…¶å†…å®¹çš„å¯è§æ€§ã€‚</li>
<li>AnimatedVisibility çš„è¿›å…¥å’Œé€€å‡ºå‚æ•°åˆ†åˆ«å®šä¹‰äº†å†…å®¹å¯è§æˆ–éšè—æ—¶çš„åŠ¨ç”»ã€‚</li>
</ul>


<h2>ç¬¬ 6 èŠ‚ â€” åœ¨ Composeä¸­æ”¹å˜ï¼ˆMorphingï¼‰å½¢çŠ¶</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q82EIocVzR8XBMuG_14mdg.gif" alt="å½¢çŠ¶å˜å½¢" /></p>

<p>åŠ¨ç”»å½¢çŠ¶ä¹‹é—´çš„å˜æ¢æ¶‰åŠè¿™äº›å½¢çŠ¶çš„å±æ€§çš„æ’å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ShapeMorphingAnimation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">animationProgress</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">Animatable</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">animationProgress</span><span class="p">.</span><span class="n">animateTo</span><span class="p">(</span>
</span><span class='line'>            <span class="n">targetValue</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">infiniteRepeatable</span><span class="p">(</span>
</span><span class='line'>                <span class="n">animation</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">2000</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">LinearOutSlowInEasing</span><span class="p">),</span>
</span><span class='line'>                <span class="n">repeatMode</span> <span class="p">=</span> <span class="n">RepeatMode</span><span class="p">.</span><span class="n">Reverse</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Canvas</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">40.</span><span class="n">dp</span><span class="p">).</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">sizeValue</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">coerceAtMost</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">squareRect</span> <span class="p">=</span> <span class="n">Rect</span><span class="p">(</span><span class="n">center</span> <span class="p">=</span> <span class="n">center</span><span class="p">,</span> <span class="n">sizeValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">morphedPath</span> <span class="p">=</span> <span class="n">interpolateShapes</span><span class="p">(</span><span class="n">progress</span> <span class="p">=</span> <span class="n">animationProgress</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">squareRect</span> <span class="p">=</span> <span class="n">squareRect</span><span class="p">)</span>
</span><span class='line'>        <span class="n">drawPath</span><span class="p">(</span><span class="n">morphedPath</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">Fill</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">interpolateShapes</span><span class="p">(</span><span class="n">progress</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">squareRect</span><span class="p">:</span> <span class="n">Rect</span><span class="p">):</span> <span class="n">Path</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">path</span> <span class="p">=</span> <span class="n">Path</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">cornerRadius</span> <span class="p">=</span> <span class="n">CornerRadius</span><span class="p">(</span>
</span><span class='line'>        <span class="n">x</span> <span class="p">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">squareRect</span><span class="p">.</span><span class="n">width</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">stop</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">fraction</span> <span class="p">=</span> <span class="n">progress</span><span class="p">),</span>
</span><span class='line'>        <span class="n">y</span> <span class="p">=</span> <span class="n">lerp</span><span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="n">squareRect</span><span class="p">.</span><span class="n">height</span> <span class="p">/</span> <span class="m">2</span><span class="p">,</span> <span class="n">stop</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">fraction</span> <span class="p">=</span> <span class="n">progress</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">path</span><span class="p">.</span><span class="n">addRoundRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">roundRect</span> <span class="p">=</span> <span class="n">RoundRect</span><span class="p">(</span><span class="n">rect</span> <span class="p">=</span> <span class="n">squareRect</span><span class="p">,</span> <span class="n">cornerRadius</span> <span class="p">=</span> <span class="n">cornerRadius</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">path</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">lerp</span><span class="p">(</span><span class="n">start</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">fraction</span><span class="p">:</span> <span class="n">Float</span><span class="p">):</span> <span class="n">Float</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="m">1</span> <span class="p">-</span> <span class="n">fraction</span><span class="p">)</span> <span class="p">*</span> <span class="n">start</span> <span class="p">+</span> <span class="n">fraction</span> <span class="p">*</span> <span class="n">stop</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>ShapeMorphingAnimation è®¾ç½®äº†ä¸€ä¸ªæ— é™åŠ¨ç”»ï¼Œå°† animationProgress çš„å€¼åœ¨ 0 å’Œ 1 ä¹‹é—´åˆ‡æ¢ã€‚</li>
<li>Canvas å¯ç»„åˆé¡¹ç”¨äºç»˜åˆ¶å½¢çŠ¶ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æ ¹æ®ç”»å¸ƒå¤§å°å®šä¹‰æ­£æ–¹å½¢ (squareRect) çš„å°ºå¯¸ã€‚</li>
<li>interpolateShapes æ¥æ”¶å½“å‰åŠ¨ç”»è¿›åº¦å’Œæ­£æ–¹å½¢çš„çŸ©å½¢ï¼Œåœ¨åœ†å½¢å’Œæ­£æ–¹å½¢ä¹‹é—´è¿›è¡Œæ’å€¼ã€‚å®ƒä½¿ç”¨ lerpï¼ˆçº¿æ€§æ’å€¼ï¼‰é€æ­¥è°ƒæ•´åœ†è§’çŸ©å½¢çš„ cornerRadiusï¼Œè¯¥çŸ©å½¢ä»£è¡¨æˆ‘ä»¬çš„å˜å½¢å½¢çŠ¶ã€‚</li>
<li>å½“ progress ä¸º 0 æ—¶ï¼ŒcornerRadius æ˜¯çŸ©å½¢å¤§å°çš„ä¸€åŠï¼Œä½¿å½¢çŠ¶å˜ä¸ºåœ†å½¢ã€‚å½“ progress ä¸º 1 æ—¶ï¼ŒcornerRadius ä¸º 0ï¼Œä½¿å½¢çŠ¶å˜ä¸ºæ­£æ–¹å½¢ã€‚</li>
</ul>


<h4>å®é™…ç”¨ä¾‹</h4>

<ul>
<li>åŠ è½½å’Œè¿›åº¦æŒ‡ç¤ºå™¨â€”â€”å˜å½¢å½¢çŠ¶å¯ç”¨äºåˆ›å»ºæ›´å…·å¸å¼•åŠ›çš„åŠ è½½æˆ–è¿›åº¦æŒ‡ç¤ºå™¨ï¼Œä»¥è§†è§‰ä¸Šå¼•äººå…¥èƒœçš„æ–¹å¼æŒ‡ç¤ºè¿›åº¦æˆ–åŠ è½½çŠ¶æ€ã€‚</li>
<li>UI ä¸­çš„å›¾æ ‡è¿‡æ¸¡â€”â€”å˜å½¢å›¾æ ‡å¯ç”¨äºæ ¹æ®ç”¨æˆ·æ“ä½œæä¾›è§†è§‰åé¦ˆã€‚ä¾‹å¦‚ï¼Œç‚¹å‡»æ’­æ”¾æŒ‰é’®æ—¶ä¼šå˜å½¢ä¸ºæš‚åœæŒ‰é’®ï¼Œæ±‰å ¡èœå•å›¾æ ‡ä¼šå˜å½¢ä¸ºåé€€ç®­å¤´ã€‚</li>
<li>æ•°æ®å¯è§†åŒ–â€”â€”åœ¨å¤æ‚çš„æ•°æ®å¯è§†åŒ–ä¸­ï¼Œå˜å½¢å¯ä»¥å¸®åŠ©åœ¨ä¸åŒè§†å›¾æˆ–æ•°æ®çŠ¶æ€ä¹‹é—´è¿‡æ¸¡ï¼Œä½¿ç”¨æˆ·æ›´å®¹æ˜“è·Ÿè¸ªå’Œç†è§£éšæ—¶é—´æˆ–ç±»åˆ«å˜åŒ–çš„å˜åŒ–ã€‚</li>
</ul>


<h2>æƒ³çœ‹é›ªèŠ±ç‰¹æ•ˆå—ï¼Ÿ</h2>

<p>æˆ‘ä»¬å°†æ¼”ç¤ºä¸€ä¸ªç®€å•çš„ç²’å­ç³»ç»Ÿï¼ˆParticle systemï¼‰æ¥åˆ›å»ºé›ªèŠ±æ•ˆæœã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E26GhhxDZLGTpE8gMvJoHw.gif" alt="é›ªèŠ±ç‰¹æ•ˆ" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Snowflake</span><span class="p">(</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">x</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">y</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">radius</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">speed</span><span class="p">:</span> <span class="n">Float</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">SnowfallEffect</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowflakes</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">List</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">{</span> <span class="n">generateRandomSnowflake</span><span class="p">()</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">infiniteTransition</span> <span class="p">=</span> <span class="n">rememberInfiniteTransition</span><span class="p">(</span><span class="n">label</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">offsetY</span> <span class="k">by</span> <span class="n">infiniteTransition</span><span class="p">.</span><span class="n">animateFloat</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialValue</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>        <span class="n">targetValue</span> <span class="p">=</span> <span class="m">1000f</span><span class="p">,</span>
</span><span class='line'>        <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">infiniteRepeatable</span><span class="p">(</span>
</span><span class='line'>            <span class="n">animation</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">5000</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">LinearEasing</span><span class="p">),</span>
</span><span class='line'>            <span class="n">repeatMode</span> <span class="p">=</span> <span class="n">RepeatMode</span><span class="p">.</span><span class="n">Restart</span>
</span><span class='line'>        <span class="p">),</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Canvas</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">snowflakes</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">snowflake</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">drawSnowflake</span><span class="p">(</span><span class="n">snowflake</span><span class="p">,</span> <span class="n">offsetY</span> <span class="p">%</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">generateRandomSnowflake</span><span class="p">():</span> <span class="n">Snowflake</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">Snowflake</span><span class="p">(</span>
</span><span class='line'>        <span class="n">x</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">y</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">()</span> <span class="p">*</span> <span class="m">1000f</span><span class="p">,</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">()</span> <span class="p">*</span> <span class="m">2f</span> <span class="p">+</span> <span class="m">2f</span><span class="p">,</span> <span class="c1">// Snowflake size</span>
</span><span class='line'>        <span class="n">speed</span> <span class="p">=</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">()</span> <span class="p">*</span> <span class="m">1.2f</span> <span class="p">+</span> <span class="m">1f</span>  <span class="c1">// Falling speed</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">drawSnowflake</span><span class="p">(</span><span class="n">snowflake</span><span class="p">:</span> <span class="n">Snowflake</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">:</span> <span class="n">Float</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">newY</span> <span class="p">=</span> <span class="p">(</span><span class="n">snowflake</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">offsetY</span> <span class="p">*</span> <span class="n">snowflake</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="p">%</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span>
</span><span class='line'>    <span class="n">drawCircle</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">radius</span> <span class="p">=</span> <span class="n">snowflake</span><span class="p">.</span><span class="n">radius</span><span class="p">,</span> <span class="n">center</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span><span class="n">snowflake</span><span class="p">.</span><span class="n">x</span> <span class="p">*</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">newY</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>ä»£ç è¯´æ˜</h4>

<ul>
<li>SnowfallEffect è®¾ç½®äº†ä¸€ä¸ªåŒ…å«å¤šä¸ªé›ªèŠ±ï¼ˆSnowflake å¯¹è±¡ï¼‰çš„ç²’å­ç³»ç»Ÿã€‚</li>
<li>æ¯ä¸ªé›ªèŠ±éƒ½å…·æœ‰ä½ç½® (x, y)ã€åŠå¾„ï¼ˆå¤§å°ï¼‰å’Œé€Ÿåº¦ç­‰å±æ€§ã€‚</li>
<li>rememberInfiniteTransition å’Œ animateFloat ç”¨äºåˆ›å»ºè¿ç»­çš„å‚ç›´è¿åŠ¨æ•ˆæœï¼Œæ¨¡æ‹Ÿé™é›ªã€‚</li>
<li>Canvas å¯ç»„åˆå‡½æ•°ç”¨äºç»˜åˆ¶æ¯ç‰‡é›ªèŠ±ã€‚drawSnowflake å‡½æ•°æ ¹æ®æ¯ç‰‡é›ªèŠ±çš„é€Ÿåº¦å’ŒåŠ¨ç”»çš„ offsetY è®¡ç®—å…¶æ–°çš„ä½ç½®ã€‚</li>
<li>é›ªèŠ±ä»åº•éƒ¨è½ä¸‹åä¼šé‡æ–°å‡ºç°åœ¨é¡¶éƒ¨ï¼Œä»è€Œäº§ç”Ÿå¾ªç¯é™é›ªæ•ˆæœã€‚</li>
</ul>


<h2>æ€»ç»“</h2>

<p>éšç€æˆ‘ä»¬å¯¹ Jetpack Compose åŠ¨ç”»çš„æ¢ç´¢é€æ¸æ·±å…¥ï¼Œæˆ‘ä»¬æ¸…æ¥šåœ°è®¤è¯†åˆ°ï¼ŒåŠ¨ç”»ä¸ä»…ä»…æ˜¯è§†è§‰ä¸Šçš„ç‚¹ç¼€ã€‚å®ƒä»¬æ˜¯æ‰“é€ å¼•äººå…¥èƒœã€ç›´è§‚ä¸”èµå¿ƒæ‚¦ç›®çš„ç”¨æˆ·ä½“éªŒçš„å…³é”®å·¥å…·ã€‚</p>

<h3>æ‹¥æŠ±äº’åŠ¨æ€§</h3>

<p>ä»åŠ¨æ€æ¸¸æˆè§’è‰²è¿åŠ¨åˆ°äº¤äº’å¼æ—¶é—´è½´ï¼Œæˆ‘ä»¬è§è¯äº†åŠ¨ç”»å¦‚ä½•è®©ç”¨æˆ·äº¤äº’æ›´å…·å¸å¼•åŠ›å’Œä¿¡æ¯é‡ã€‚</p>

<h3>æ‰“é€ é€¼çœŸçš„ä½“éªŒ</h3>

<p>é›ªèŠ±é£˜è½æ•ˆæœå’Œå˜å½¢å½¢çŠ¶å±•ç°äº†è¯¥å·¥å…·åŒ…å°†çœŸå®æ„Ÿå’Œæµç•…æ€§å¸¦å…¥æ•°å­—ä¸–ç•Œçš„èƒ½åŠ›ã€‚è¿™äº›åŠ¨ç”»æœ‰åŠ©äºæ‰“é€ ä¸ç”¨æˆ·äº§ç”Ÿå…±é¸£çš„æ²‰æµ¸å¼ä½“éªŒã€‚</p>

<h3>ç®€åŒ–å¤æ‚æ€§</h3>

<p>æ— è®ºæ˜¯ç¼–æ’å¤šä¸ªå…ƒç´ è¿˜æ˜¯åˆ¶ä½œçŠ¶æ€è½¬æ¢åŠ¨ç”»ï¼Œå…¶ç®€å•æ˜“ç”¨æ€§éƒ½ä»¤äººç©ç›®ã€‚</p>

<h2>ç»“æŸè¯­</h2>

<p>å¦‚æœä½ å–œæ¬¢æœ¬æ–‡ï¼Œè¯·éšæ—¶ç•™ä¸‹å®è´µçš„åé¦ˆæˆ–èµèµã€‚æˆ‘ä¸€ç›´æœŸå¾…ä¸å…¶ä»–å¼€å‘è€…ä¸€èµ·å­¦ä¹ ã€åˆä½œã€å…±åŒæˆé•¿ã€‚</p>

<p>å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·éšæ—¶ç»™æˆ‘ç•™è¨€ï¼</p>

<p>åœ¨ Medium ä¸Šå…³æ³¨æˆ‘ï¼Œè·å–æ›´å¤šæ–‡ç«  â€” <a href="https://medium.com/@pherwani37">Medium ä¸ªäººèµ„æ–™</a>ï¼ˆé“¾æ¥ï¼š<a href="https://medium.com/@pherwani37%EF%BC%89">https://medium.com/@pherwani37%EF%BC%89</a></p>

<p>åœ¨<a href="https://linkedin.com/in/nirbhaypherwani">LinkedIn</a>ï¼ˆé“¾æ¥ï¼š<a href="https://linkedin.com/in/nirbhaypherwani%EF%BC%89%E5%92%8C">https://linkedin.com/in/nirbhaypherwani%EF%BC%89%E5%92%8C</a><a href="https://twitter.com/nirbhayph">Twitter</a>ï¼ˆé“¾æ¥ï¼š<a href="https://twitter.com/nirbhayph%EF%BC%89%E4%B8%8A%E4%B8%8E%E6%88%91%E8%81%94%E7%B3%BB%EF%BC%8C%E4%BB%A5%E4%BE%BF%E6%88%91%E4%BB%AC%E8%BF%9B%E8%A1%8C%E5%90%88%E4%BD%9C%E3%80%82">https://twitter.com/nirbhayph%EF%BC%89%E4%B8%8A%E4%B8%8E%E6%88%91%E8%81%94%E7%B3%BB%EF%BC%8C%E4%BB%A5%E4%BE%BF%E6%88%91%E4%BB%AC%E8%BF%9B%E8%A1%8C%E5%90%88%E4%BD%9C%E3%80%82</a></p>

<p>ç¥ä½ åŠ¨ç”»åˆ¶ä½œæ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç†è§£Jetpack Composeä¸­å‰¯ä½œç”¨å‡½æ•°çš„å†…éƒ¨åŸç†]]></title>
    <link href="https://alexhilton.github.io/blog/2025/05/01/understanding-side-effect-handlers/"/>
    <updated>2025-05-01T11:05:24+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/05/01/understanding-side-effect-handlers</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒUnderstanding the Internals of Side-Effect Handlers in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/understanding-the-internals-of-side-effect-handlers-in-jetpack-compose-d55fbf914fde">https://proandroiddev.com/understanding-the-internals-of-side-effect-handlers-in-jetpack-compose-d55fbf914fde</a>ï¼Œç”±Jaewoong Eumå‘å¸ƒäº2025å¹´4æœˆ10æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/05/01/understanding-side-effect-handlers/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GNgL_XzYpw16hn6BxocOww.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>è¿‘å¹´æ¥ï¼ŒJetpack Composeç”Ÿæ€å‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œç°å·²è¢«å¹¿æ³›ç”¨äºæ„å»º Android åº”ç”¨çš„äº§å“çº§UIã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ Jetpack Compose ä»£è¡¨äº† Android UI å¼€å‘çš„æœªæ¥ã€‚</p>

<p>Compose æœ€å¤§çš„ä¼˜åŠ¿ä¹‹ä¸€æ˜¯å…¶å£°æ˜å¼ï¼ˆdeclarativeï¼‰æ–¹æ³•â€”â€”å®ƒå…è®¸å¼€å‘è€…æè¿° UI åº”è¯¥æ˜¾ç¤ºçš„å†…å®¹ï¼Œè€Œæ¡†æ¶åˆ™è´Ÿè´£å¤„ç† UI åœ¨åº•å±‚çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶åº”å¦‚ä½•æ›´æ–°ã€‚è¿™ç§æ¨¡å‹å°†ç„¦ç‚¹ä»å‘½ä»¤å¼ï¼ˆimperativeï¼‰UI è½¬ç§»åˆ°æ›´ç›´è§‚ã€æ›´å…·å“åº”å¼çš„æ€ç»´æ–¹å¼ã€‚</p>

<p>ç„¶è€Œï¼Œå°½ç®¡å£°æ˜å¼ UIæœ‰å¾ˆå¤šä¼˜åŠ¿ï¼Œä½†å¦¥å–„ç®¡ç†å‰¯ä½œç”¨ä¹Ÿè‡³å…³é‡è¦ã€‚å¯ç»„åˆå‡½æ•°å¯èƒ½ä¼šå› å„ç§åŸå› ï¼ˆä¾‹å¦‚çŠ¶æ€æˆ–å‚æ•°çš„å˜åŒ–ï¼‰è€Œè¢«é‡ç»„ï¼Œå¦‚æœå‰¯ä½œç”¨å¤„ç†ä¸å½“ï¼Œåº”ç”¨çš„è¡Œä¸ºå¯èƒ½ä¼šå˜å¾—ä¸å¯é¢„æµ‹ã€‚</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å°†æ¢ç´¢ Jetpack Compose é»˜è®¤æä¾›çš„å‰¯ä½œç”¨å¤„ç† APIã€‚ä½ è¿˜å°†ç ”ç©¶å®ƒä»¬çš„å†…éƒ¨å·¥ä½œæµç¨‹ï¼Œä»¥æ›´å¥½åœ°äº†è§£ Compose å¦‚ä½•åœ¨åº•å±‚ç®¡ç†è¿™äº›æ“ä½œã€‚</p>

<h2>å‰¯ä½œç”¨ï¼ˆSide Effectï¼‰æ˜¯å•¥ï¼Ÿ</h2>

<p>å‰¯ä½œç”¨ï¼ˆSide Effectï¼‰æ˜¯æŒ‡å‘ç”Ÿåœ¨å¯ç»„åˆå‡½æ•°ä½œç”¨åŸŸä¹‹å¤–çš„åº”ç”¨çŠ¶æ€å˜åŒ–ã€‚åœ¨ Jetpack Compose ä¸­ï¼Œç”±äºçŠ¶æ€å˜åŒ–ã€å‚æ•°æ›´æ–°æˆ–å…¶ä»–äº‹ä»¶è§¦å‘çš„é‡ç»„ï¼Œå¯ç»„åˆå‡½æ•°å¯èƒ½ä¼šé¢‘ç¹ä¸”ä¸å¯é¢„æµ‹åœ°é‡æ–°æ‰§è¡Œï¼ˆè¯‘æ³¨ï¼šä¹Ÿå°±æ˜¯è¯´Composeçš„é‡ç»„æ˜¯ä¸å—å¼€å‘è€…æ§åˆ¶çš„ï¼‰ã€‚å› æ­¤ï¼Œä½ ä¸èƒ½å‡è®¾ä¸€ä¸ªå¯ç»„åˆå‡½æ•°åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>

<p>æ¢å¥è¯è¯´ï¼Œåœ¨å¯ç»„åˆå‡½æ•°å†…éƒ¨ç›´æ¥è°ƒç”¨ä¸šåŠ¡é€»è¾‘ï¼ˆä¾‹å¦‚ä»ç½‘ç»œè·å–æ•°æ®æˆ–æŸ¥è¯¢æ•°æ®åº“ï¼‰æ˜¯æœ‰é£é™©çš„ã€‚ç”±äºæ½œåœ¨çš„é‡ç»„ï¼Œè¿™äº›æ“ä½œå¯èƒ½ä¼šæ— æ„ä¸­è¿è¡Œå¤šæ¬¡ï¼Œä»è€Œå¯¼è‡´é”™è¯¯æˆ–æ€§èƒ½é—®é¢˜ã€‚</p>

<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJetpack Compose æä¾›äº†ä¸€ç»„ä¸“é—¨ç”¨äºä»¥å®‰å…¨å¯æ§çš„æ–¹å¼ç®¡ç†å‰¯ä½œç”¨çš„APIã€‚è¿™äº› APIåŒ…æ‹¬ LaunchedEffect ã€ DisposableEffect ã€ SideEffect ã€ rememberCoroutineScope ç­‰ç­‰ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å°†é‡ç‚¹ä»‹ç»ä¸‰ä¸ªæœ€å¸¸ç”¨çš„å¤„ç†ç¨‹åºâ€”â€” LaunchedEffect ã€ DisposableEffect å’Œ SideEffect â€”â€”å¹¶ä»”ç»†ç ”ç©¶å®ƒä»¬çš„å†…éƒ¨å®ç°ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£å®ƒä»¬çš„åº•å±‚å·¥ä½œåŸç†ã€‚</p>

<h2>LaunchedEffect</h2>

<p>LaunchedEffectæ˜¯Jetpack Composeä¸­æœ€å¸¸ç”¨çš„å‰¯ä½œç”¨å¤„ç† APIä¹‹ä¸€ã€‚å®ƒå…è®¸ä½ ä»¥å¯ç»„åˆç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥çš„æ–¹å¼ï¼ˆè€Œé Android ç”Ÿå‘½å‘¨æœŸï¼‰å¯åŠ¨åç¨‹ï¼Œå¹¶ç¡®ä¿é™¤éæŒ‡å®šçš„å…³é”®å‚æ•°ï¼ˆkeysï¼‰ä¹‹ä¸€å‘ç”Ÿå˜åŒ–ï¼Œå¦åˆ™ä¸ä¼šé‡æ–°æ‰§è¡Œæä¾›çš„ä»£ç å—ã€‚è¿™ç§è¡Œä¸ºä½¿å¾— LaunchedEffect ç‰¹åˆ«é€‚åˆæ‰§è¡Œä¸ç‰¹å®šçŠ¶æ€ç›¸å…³çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¾‹å¦‚æ˜¾ç¤º Toastæˆ–Snackbarã€è®°å½•äº‹ä»¶æˆ–è§¦å‘ä¸šåŠ¡é€»è¾‘ï¼Œæ­£å¦‚ä½ åœ¨ Now in Android é¡¹ç›®ä¸­çš„ç¤ºä¾‹ä»£ç ä¸­æ‰€è§ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">snackbarHostState</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">SnackbarHostState</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">isOffline</span> <span class="k">by</span> <span class="n">appState</span><span class="p">.</span><span class="n">isOffline</span><span class="p">.</span><span class="n">collectAsStateWithLifecycle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// å¦‚æœç”¨æˆ·æœªè¿æ¥åˆ°äº’è”ç½‘ï¼Œåˆ™æ˜¾ç¤ºä¸€ä¸ªSnackbaræ¥é€šçŸ¥ä»–ä»¬ã€‚</span>
</span><span class='line'><span class="k">val</span> <span class="py">notConnectedMessage</span> <span class="p">=</span> <span class="n">stringResource</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">not_connected</span><span class="p">)</span>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isOffline</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">isOffline</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">snackbarHostState</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span>
</span><span class='line'>            <span class="n">message</span> <span class="p">=</span> <span class="n">notConnectedMessage</span><span class="p">,</span>
</span><span class='line'>            <span class="n">duration</span> <span class="p">=</span> <span class="n">Indefinite</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒLaunchedEffect ä¼šåœ¨åº•å±‚åˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ä½œç”¨åŸŸã€‚è¿™æ„å‘³ç€å®ƒä¸»è¦ç”¨äºåœ¨å¯ç»„åˆå‡½æ•°ä½œç”¨åŸŸå†…æ‰§è¡ŒåŸºäºåç¨‹çš„ä»»åŠ¡ï¼Œå¹¶åœ¨å¯ç»„åˆå‡½æ•°ç¦»å¼€ç»„åˆæ—¶è‡ªåŠ¨å–æ¶ˆå…¶åç¨‹ã€‚å› æ­¤ï¼ŒLaunchedEffect æœ€é€‚åˆç”¨äºä¸åç¨‹ç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚æ•°æ®è·å–ã€å»¶è¿Ÿæ•ˆæœæˆ–äº‹ä»¶å¤„ç†ï¼Œè€Œä¸æ˜¯ç®€å•åœ°æ‰§è¡Œéæš‚åœå‡½æ•°ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥æ¢ç©¶ä¸€ä¸‹ï¼Œä»¥æ›´å¥½åœ°ç†è§£ LaunchedEffect çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">LaunchedEffect</span><span class="p">(</span>
</span><span class='line'>    <span class="n">key1</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span>
</span><span class='line'>    <span class="n">block</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">applyContext</span> <span class="p">=</span> <span class="n">currentComposer</span><span class="p">.</span><span class="n">applyCoroutineContext</span>
</span><span class='line'>    <span class="n">remember</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="p">{</span> <span class="n">LaunchedEffectImpl</span><span class="p">(</span><span class="n">applyContext</span><span class="p">,</span> <span class="n">block</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">LaunchedEffectImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="n">parentCoroutineContext</span><span class="p">:</span> <span class="n">CoroutineContext</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">task</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RememberObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="n">CoroutineScope</span><span class="p">(</span><span class="n">parentCoroutineContext</span><span class="p">)</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">job</span><span class="p">:</span> <span class="n">Job</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRemembered</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// è¿™ä¸åº”è¯¥å‘ç”Ÿï¼Œä½†ä¸ºäº†å®‰å…¨èµ·è§ç•™åœ¨è¿™é‡Œ</span>
</span><span class='line'>        <span class="n">job</span><span class="o">?.</span><span class="n">cancel</span><span class="p">(</span><span class="s">&quot;Old job was still running!&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">job</span> <span class="p">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">launch</span><span class="p">(</span><span class="n">block</span> <span class="p">=</span> <span class="n">task</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onForgotten</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">job</span><span class="o">?.</span><span class="n">cancel</span><span class="p">(</span><span class="n">LeftCompositionCancellationException</span><span class="p">())</span>
</span><span class='line'>        <span class="n">job</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAbandoned</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">job</span><span class="o">?.</span><span class="n">cancel</span><span class="p">(</span><span class="n">LeftCompositionCancellationException</span><span class="p">())</span>
</span><span class='line'>        <span class="n">job</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­£å¦‚ä½ åœ¨LaunchedEffectçš„å†…éƒ¨å®ç°ä¸­æ‰€çœ‹åˆ°çš„ï¼Œå®ƒä¼šåˆ›å»ºLaunchedEffectImplå¹¶å°†å…¶å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¹¶å°†ç»™å®šçš„é”®å€¼ä½œä¸ºå‚æ•°ï¼Œä»¥ä¾¿åœ¨é”®å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°åˆ›å»º LaunchedEffectImpl å®ä¾‹ã€‚</p>

<p>å¦‚æœä½ æŸ¥çœ‹å†…éƒ¨ LaunchedEffectImpl ç±»ï¼Œä½ ä¼šå‘ç°å®ƒå®ç°äº†RememberObserveræ¥å£ï¼Œå¹¶é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„ CoroutineScopeã€‚ç„¶åï¼Œå½“å¯ç»„åˆé¡¹è¿›å…¥ç»„åˆé˜¶æ®µæ—¶ï¼Œæä¾›çš„ lambda ä¼šåœ¨æ­¤èŒƒå›´å†…å¯åŠ¨ã€‚å½“å¯ç»„åˆé¡¹ç¦»å¼€ç»„åˆé˜¶æ®µæ—¶ï¼Œåç¨‹èŒƒå›´ä¼šè‡ªåŠ¨å–æ¶ˆï¼Œä»è€Œç¡®ä¿èµ„æºå¾—åˆ°æ­£ç¡®æ¸…ç†ï¼Œå¹¶é¿å…æ½œåœ¨çš„å†…å­˜æ³„æ¼æˆ–æ€§èƒ½é—®é¢˜ã€‚</p>

<p>è¯è™½å¦‚æ­¤ï¼Œå¦‚æœä½ çš„ä»»åŠ¡ä¸æ¶‰åŠä»»ä½•ä¸åç¨‹ç›¸å…³çš„æ“ä½œï¼Œè€Œåªæ˜¯éœ€è¦åœ¨é”®å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°æ‰§è¡Œï¼Œé‚£ä¹ˆä½¿ç”¨ LaunchedEffect å¯èƒ½ç•¥æ˜¾å¤šä½™ã€‚è™½ç„¶åˆ›å»ºåç¨‹ä½œç”¨åŸŸçš„å¼€é”€é€šå¸¸å¾ˆå°ï¼Œä½†åœ¨å®é™…ä¸ä½¿ç”¨åç¨‹çš„æƒ…å†µä¸‹ï¼Œå®ƒä»ç„¶æ˜¯ä¸å¿…è¦çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´è½»é‡çº§çš„å‰¯ä½œç”¨å¤„ç†library (<a href="https://github.com/skydoves/compose-effects?tab=readme-ov-file#rememberedeffect">RememberedEffect</a>)ï¼Œå®ƒæ›´é€‚åˆéæŒ‚èµ·ï¼ˆnon-suspendingï¼‰ä»»åŠ¡ã€‚</p>

<p>å¦ä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯LaunchedEffectèƒ½å¤Ÿæ„ŸçŸ¥ Androidç”Ÿå‘½å‘¨æœŸâ€”â€”ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚ä»å†…éƒ¨å®ç°å¯ä»¥çœ‹å‡ºï¼ŒLaunchedEffectçš„ä½œç”¨åŸŸå®Œå…¨é™å®šäºJetpack Composeç»„åˆç”Ÿå‘½å‘¨æœŸï¼Œä¸ Androidç»„ä»¶ï¼ˆActivityå’ŒFragmentï¼‰çš„ç”Ÿå‘½å‘¨æœŸæ²¡æœ‰ç›´æ¥å…³è”ã€‚</p>

<p>æ¢å¥è¯è¯´ï¼Œå®ƒæœ¬èº«å¹¶ä¸äº†è§£ä»»ä½•æœ‰å…³ Activityã€Fragment æˆ– onStop()æˆ– onDestroy()ç­‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„ä¿¡æ¯ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ åœ¨ LaunchedEffect ä¸­å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸” Android ç»„ä»¶ï¼ˆä¾‹å¦‚ Activityï¼‰åœ¨å¯ç»„åˆé¡¹æœªç¦»å¼€ç»„åˆçš„æƒ…å†µä¸‹è¢«åœæ­¢æˆ–é”€æ¯ï¼Œåˆ™è¯¥åç¨‹å¯èƒ½ä¼šç»§ç»­è¿è¡Œï¼Œé™¤éå®ƒæ˜ç¡®ä¸Androidç»„ä»¶ç”Ÿå‘½å‘¨æœŸç»‘å®šã€‚</p>

<h2>DisposableEffect</h2>

<p>DisposableEffectæ˜¯Jetpack Compose è¿è¡Œæ—¶æä¾›çš„å¦ä¸€ä¸ªå‰¯ä½œç”¨å¤„ç†APIã€‚å®ƒå…è®¸ä½ ä¸å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸåŒæ­¥æ‰§è¡Œè®¾ç½®å’Œæ¸…ç†é€»è¾‘ã€‚ä¸LaunchedEffectä¸åŒï¼Œå®ƒæä¾›äº†ä¸€ä¸ª DisposableEffectScope ä½œä¸ºæ¥æ”¶å™¨ï¼ˆreceiverï¼‰ï¼Œä½¿ä½ èƒ½å¤Ÿå®šä¹‰ä¸€ä¸ªæ¸…ç†ä»£ç å—ï¼ˆclean-up code blockï¼‰ï¼Œè¯¥ä»£ç å—åœ¨å¯ç»„åˆé¡¹ç¦»å¼€ç»„åˆæ—¶è‡ªåŠ¨è¿è¡Œã€‚è¿™ä½¿å¾—å®ƒéå¸¸é€‚åˆç®¡ç†éœ€è¦æ˜¾å¼å¸è½½çš„å¤–éƒ¨èµ„æºï¼Œä¾‹å¦‚ç›‘å¬å™¨ã€å›è°ƒæˆ–å¹¿æ’­æ¥æ”¶å™¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// å¦‚æœ `lifecycleOwner` å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é‡Šæ”¾å¹¶é‡ç½®æ•ˆæœ</span>
</span><span class='line'><span class="n">DisposableEffect</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…ï¼Œè§¦å‘æˆ‘ä»¬è®°ä½çš„å›è°ƒä»¥å‘é€åˆ†æäº‹ä»¶</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">observer</span> <span class="p">=</span> <span class="n">LifecycleEventObserver</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">event</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="p">==</span> <span class="n">Lifecycle</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">ON_RESUME</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// do something</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="p">==</span> <span class="n">Lifecycle</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">ON_PAUSE</span> <span class="p">||</span> <span class="n">event</span> <span class="p">==</span> <span class="n">Lifecycle</span><span class="p">.</span><span class="n">Event</span><span class="p">.</span><span class="n">ON_STOP</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// do something</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Add the observer to the lifecycle</span>
</span><span class='line'>  <span class="n">lifecycleOwner</span><span class="p">.</span><span class="n">lifecycle</span><span class="p">.</span><span class="n">addObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// å½“æ•ˆæœç¦»å¼€ Composition æ—¶ï¼Œç§»é™¤è§‚å¯Ÿè€…</span>
</span><span class='line'>  <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">lifecycleOwner</span><span class="p">.</span><span class="n">lifecycle</span><span class="p">.</span><span class="n">removeObserver</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢çš„ç¤ºä¾‹ä½¿ç”¨ DisposableEffect å°† LifecycleEventObserveræ³¨å†Œåˆ°lifecycleOwnerï¼Œä½¿å…¶èƒ½å¤Ÿè§‚å¯Ÿç”Ÿå‘½å‘¨æœŸå˜åŒ–å¹¶æ ¹æ®å½“å‰çŠ¶æ€æ‰§è¡Œç‰¹å®šé€»è¾‘ã€‚è§‚å¯Ÿè€…ä¼šåœ¨onDisposeå—å†…è¢«å®‰å…¨åœ°ç§»é™¤ï¼Œç¡®ä¿åœ¨å¯ç»„åˆé¡¹ç¦»å¼€ç»„åˆæ—¶è¿›è¡Œé€‚å½“çš„æ¸…ç†ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£DisposableEffectçš„å†…éƒ¨å·¥ä½œåŸç†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DisposableEffect</span><span class="p">(</span>
</span><span class='line'>    <span class="n">key1</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span>
</span><span class='line'>    <span class="n">effect</span><span class="p">:</span> <span class="n">DisposableEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">DisposableEffectResult</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">remember</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="p">{</span> <span class="n">DisposableEffectImpl</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">class</span> <span class="nc">DisposableEffectImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">effect</span><span class="p">:</span> <span class="n">DisposableEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">DisposableEffectResult</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RememberObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">onDispose</span><span class="p">:</span> <span class="n">DisposableEffectResult</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRemembered</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onDispose</span> <span class="p">=</span> <span class="n">InternalDisposableEffectScope</span><span class="p">.</span><span class="n">effect</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onForgotten</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onDispose</span><span class="o">?.</span><span class="n">dispose</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onDispose</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAbandoned</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ç”±äºæœªè°ƒç”¨ [onRemembered]ï¼Œå› æ­¤æ— éœ€æ‰§è¡Œä»»ä½•æ“ä½œã€‚</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">DisposableEffectScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">inline</span> <span class="k">fun</span> <span class="nf">onDispose</span><span class="p">(</span>
</span><span class='line'>        <span class="n">crossinline</span> <span class="n">onDisposeEffect</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">DisposableEffectResult</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">DisposableEffectResult</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">fun</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">onDisposeEffect</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚ DisposableEffect çš„å†…éƒ¨å®ç°æ‰€ç¤ºï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª DisposableEffectImpl å®ä¾‹ï¼Œå¹¶ä½¿ç”¨æä¾›çš„é”®å°†å…¶å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚
æ¯å½“é”®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„DisposableEffectImpl å®ä¾‹ï¼Œä»¥ä¾¿ç›¸åº”åœ°é‡æ–°æ‰§è¡Œè¯¥æ•ˆæœã€‚</p>

<p>DisposableEffectImplç±»å®ç°äº† RememberObserver æ¥å£ï¼Œå¹¶åˆå§‹åˆ›å»ºä¸€ä¸ª DisposableEffectResultã€‚å½“å¯ç»„åˆé¡¹è¿›å…¥ç»„åˆé˜¶æ®µæ—¶ï¼Œæ•ˆæœ lambda ä¼šåœ¨ DisposableEffectScope ä¸­å¯åŠ¨ã€‚é€€å‡ºç»„åˆæ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨ DisposableEffectResultçš„onDispose å‡½æ•°ï¼Œä»¥ç¡®ä¿åœ¨å¯ç»„åˆé¡¹å®Œå…¨ä»ç»„åˆä¸­ç§»é™¤ä¹‹å‰æ­£ç¡®æ¸…ç†èµ„æºå¹¶é˜²æ­¢å†…å­˜æ³„æ¼æˆ–æ€§èƒ½é—®é¢˜ã€‚</p>

<h2>SideEffect</h2>

<p>Jetpack Composeä¸­çš„SideEffect API ç”¨äºå®‰å…¨åœ°å°†å¯ç»„åˆé¡¹å†…å‘ç”Ÿçš„çŠ¶æ€å˜åŒ–é€šçŸ¥ç»™å¤–éƒ¨é Compose ç®¡ç†çš„å¯¹è±¡ã€‚å®ƒç¡®ä¿æ•ˆæœåœ¨é‡ç»„æˆåŠŸåè¿è¡Œï¼Œä½¿å…¶æˆä¸ºè§¦å‘ä¾èµ–äºç•Œé¢æœ€ç»ˆç¨³å®šçŠ¶æ€çš„å‰¯ä½œç”¨çš„ç†æƒ³é€‰æ‹©ã€‚</p>

<p>ä½¿ç”¨ SideEffectå¯ä»¥é¿å…åœ¨é‡ç»„é˜¶æ®µæ‰§è¡Œçš„æ“ä½œå¯èƒ½ä¼šè¢«ä¸¢å¼ƒçš„é£é™©ï¼Œå¦‚æœä½ åœ¨æœªé‡‡å–æ­¤ä¿æŠ¤æªæ–½çš„æƒ…å†µä¸‹ç›´æ¥åœ¨å¯ç»„åˆé¡¹ä¸­ç¼–å†™æ•ˆæœï¼Œåˆ™å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å› æ­¤ï¼Œå½“ä½ éœ€è¦å°† Compose çŠ¶æ€ä¸å¤–éƒ¨ç³»ç»Ÿï¼ˆä¾‹å¦‚æ—¥å¿—è®°å½•å·¥å…·ã€åˆ†æå·¥å…·æˆ–å‘½ä»¤å¼ç•Œé¢ç»„ä»¶ï¼‰åŒæ­¥æ—¶ï¼ŒSideEffect è‡³å…³é‡è¦ï¼Œå¦‚ä¸‹ä¾‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberFirebaseAnalytics</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span> <span class="n">FirebaseAnalytics</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">analytics</span><span class="p">:</span> <span class="n">FirebaseAnalytics</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">FirebaseAnalytics</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// æ¯æ¬¡æˆåŠŸç»„åˆåï¼Œä½¿ç”¨å½“å‰ç”¨æˆ·çš„ç”¨æˆ·ç±»å‹æ›´æ–° FirebaseAnalyticsï¼Œ</span>
</span><span class='line'>    <span class="c1">// ç¡®ä¿å°†æ¥çš„åˆ†æäº‹ä»¶å·²é™„åŠ æ­¤å…ƒæ•°æ®</span>
</span><span class='line'>    <span class="n">SideEffect</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">analytics</span><span class="p">.</span><span class="n">setUserProperty</span><span class="p">(</span><span class="s">&quot;userType&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">userType</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">analytics</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¢ç´¢ä¸€ä¸‹ SideEffect API çš„åº•å±‚å·¥ä½œåŸç†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">SideEffect</span><span class="p">(</span>
</span><span class='line'>    <span class="n">effect</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">currentComposer</span><span class="p">.</span><span class="n">recordSideEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** å½“æˆ‘ä»¬åº”ç”¨ç»„åˆå˜åŒ–æ—¶å®‰æ’è¿è¡Œå‰¯ä½œç”¨ã€‚ */</span>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">recordSideEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">changeListWriter</span><span class="p">.</span><span class="n">sideEffect</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¹ä¸€çœ‹ï¼Œä¸Šé¢çš„ä»£ç å¯èƒ½çœ‹ä¼¼ç®€å•ï¼Œä½†å®é™…ä¸Šå´éš¾ä»¥å®Œå…¨ç†è§£ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚è¿™æ˜¯å› ä¸º SideEffect APIä¸ Composeè¿è¡Œæ—¶åº•å±‚å†…éƒ¨æœºåˆ¶ç´§å¯†ç›¸å…³ï¼Œå°¤å…¶æ˜¯ ChangeListï¼Œå®ƒç”¨äºè·Ÿè¸ªå’Œç®¡ç†ç”¨äºæ›´æ–°æ¸²æŸ“UIçš„çŠ¶æ€é©±åŠ¨å˜æ›´åˆ—è¡¨ã€‚</p>

<p>æ ¹æ® Composeæºä»£ç ä¸­çš„å†…éƒ¨æ³¨é‡Šï¼ŒSideEffect APIçš„è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>

<blockquote><p>å®‰æ’æ•ˆæœåœ¨å½“å‰åˆæˆæˆåŠŸå®Œæˆå¹¶åº”ç”¨æ›´æ”¹æ—¶è¿è¡Œã€‚SideEffect å¯ç”¨äºå°†å‰¯ä½œç”¨åº”ç”¨äºåˆæˆç®¡ç†çš„ã€æœªå—å¿«ç…§æ”¯æŒçš„å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨å½“å‰åˆæˆæ“ä½œå¤±è´¥æ—¶é¿å…è¿™äº›å¯¹è±¡å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚</p>

<p>å‰¯ä½œç”¨å°†å§‹ç»ˆåœ¨åˆæˆçš„åº”ç”¨è°ƒåº¦ç¨‹åºä¸Šè¿è¡Œï¼Œå¹¶ä¸”åº”ç”¨å™¨æ°¸è¿œä¸ä¼šä¸è‡ªèº«ã€å½¼æ­¤å¹¶å‘è¿è¡Œï¼Œä¹Ÿä¸ä¼šå°†æ›´æ”¹åº”ç”¨äºåˆæˆæ ‘æˆ–è¿è¡Œ RememberObserver äº‹ä»¶å›è°ƒã€‚SideEffect å§‹ç»ˆåœ¨ RememberObserver äº‹ä»¶å›è°ƒä¹‹åè¿è¡Œã€‚</p></blockquote>

<p>å› æ­¤ï¼ŒSideEffect API ä¼šåœ¨æ¯æ¬¡æˆåŠŸé‡ç»„åè¿è¡Œã€‚</p>

<h2>ç»“è®º</h2>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œä½ æ¢ç´¢äº† Jetpack Compose ä¸­å¸¸ç”¨çš„ä¸‰ä¸ªä¸»è¦å‰¯ä½œç”¨å¤„ç†APIã€‚ç”±äºå£°æ˜å¼UIï¼ˆdeclarative UIï¼‰çš„ç‰¹æ€§ï¼ŒçŠ¶æ€ä¼šå½±å“è¿è¡Œæ—¶è¡Œä¸ºçš„è¯¸å¤šæ–¹é¢ï¼Œå› æ­¤æ­£ç¡®åœ°ä½¿ç”¨å‰¯ä½œç”¨å‡½æ•°å¯¹äºç¡®ä¿ä»»åŠ¡æ‰§è¡Œçš„æ­£ç¡®æ€§å’Œå¯é¢„æµ‹æ€§è‡³å…³é‡è¦ã€‚</p>

<p>æœ¬ä¸»é¢˜æœ€åˆåœ¨<a href="https://github.com/doveletter/">Dove Letter</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://github.com/doveletter/%EF%BC%89%E4%B8%AD%E4%BB%8B%E7%BB%8D%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E7%A7%81%E4%BA%BA%E4%BB%A3%E7%A0%81%E5%BA%93%EF%BC%8C%E6%8F%90%E4%BE%9B%E6%9C%89%E5%85%B3">https://github.com/doveletter/%EF%BC%89%E4%B8%AD%E4%BB%8B%E7%BB%8D%EF%BC%8C%E8%BF%99%E6%98%AF%E4%B8%80%E4%B8%AA%E7%A7%81%E4%BA%BA%E4%BB%A3%E7%A0%81%E5%BA%93%EF%BC%8C%E6%8F%90%E4%BE%9B%E6%9C%89%E5%85%B3</a> Android å’Œ Kotlin çš„æ¯æ—¥è§è§£ï¼Œæ¶µç›– Composeã€æ¶æ„ã€è¡Œä¸šé¢è¯•é—®é¢˜å’Œå®ç”¨ä»£ç æŠ€å·§ç­‰ä¸»é¢˜ã€‚è‡ªä¸Šçº¿ä»¥æ¥çš„çŸ­çŸ­ 37 å‘¨å†…ï¼ŒDove Letter å·²æ‹¥æœ‰è¶…è¿‡ 700 åä¸ªäººè®¢é˜…è€…å’Œ 20 åä¼ä¸š/ç»ˆèº«è®¢é˜…è€…ã€‚å¦‚æœä½ æ¸´æœ›æ·±å…¥äº†è§£ Androidã€Kotlin å’Œ Composeï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹<a href="https://medium.com/@skydoves/learn-kotlin-and-android-with-dove-letter-26265da11903">â€œé€šè¿‡ Dove Letter å­¦ä¹  Kotlin å’Œ Androidâ€</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://medium.com/@skydoves/learn-kotlin-and-android-with-dove-letter-26265da11903%EF%BC%89%E3%80%82">https://medium.com/@skydoves/learn-kotlin-and-android-with-dove-letter-26265da11903%EF%BC%89%E3%80%82</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Shortest Path in Graph]]></title>
    <link href="https://alexhilton.github.io/blog/2025/04/26/shortest-path-in-graph/"/>
    <updated>2025-04-26T21:28:55+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/04/26/shortest-path-in-graph</id>
    <content type="html"><![CDATA[<p>å›¾ä¸­çš„è·¯å¾„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯æœ€çŸ­è·¯å¾„é—®é¢˜æ˜¯å›¾è®ºä¸­ç®—æ³•çš„æ ¸å¿ƒï¼Œä»Šå¤© å°±æ¥æ€»ç»“ ä¸€ä¸‹ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/04/26/shortest-path-in-graph/"><img src="https://www.mbloging.com/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2Fyynr1uml%2Fproduction%2F0b7098c6c641f29656d920a12b6a36feade61e38-1024x576.jpg%3Fw%3D1024%26auto%3Dformat&w=1920&q=75" title="auto auto" ></a></p>

<!-- more -->


<h2>BFSæ±‚æ— æƒæœ€çŸ­å¾„</h2>

<p>å¯¹äº æ— æƒå›¾ï¼Œç”¨BFSå°±èƒ½æ‰¾åˆ°ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æœ€çŸ­è·¯å¾„ï¼Œè¿™æ˜¯BFSçš„å¤©ç„¶ä¼˜åŠ¿ã€‚éå† çš„æ—¶å€™ è¦æ³¨æ„ ç”¨ã€Œåœˆå±‚å¼ã€éå†ï¼Œä¹Ÿå°±æ˜¯è¯´å¯¹äº å½“å‰èŠ‚ç‚¹ï¼ŒæŠŠå…¶ç›¸é‚»èŠ‚ç‚¹éå† å®Œï¼Œæ‰èƒ½ç®—èµ°äº†ä¸€æ­¥ã€‚</p>

<h2>Dijkstraæ±‚æœ‰å‘æ— ç¯å¸¦æƒå›¾çš„æœ€çŸ­è·¯å¾„</h2>

<p>å¯¹äºæœ‰å‘æ— ç¯å›¾DAGï¼Œå¸¦æœ‰æƒé‡çš„æœ€çŸ­è·¯å¾„é—®é¢˜å¯ä»¥ç”¨Dijkstraç®—æ³•æ¥æ±‚è§£ã€‚å…·ä½“å‚è§<a href="https://alexhilton.github.io/blog/2022/09/12/understanding-dijkstra-algorithm/">Understanding Dijkstra Algorithm</a>ã€‚</p>

<h2>Floyd</h2>

<ul>
<li><p><a href="https://www.programiz.com/dsa/floyd-warshall-algorithm">Floyd-Warshall Algorithm</a></p></li>
<li><p><a href="https://en.wikipedia.org/wiki/Floyd%E2%80%93Warshall_algorithm">Floydâ€“Warshall algorithm(Wikipedia)</a></p></li>
<li><a href="https://www.tutorialspoint.com/data_structures_algorithms/floyd_warshall_algorithm.htm">Floyd Warshall Algorithm</a></li>
</ul>


<h2>Bellman Ford</h2>

<p>Bellman Fordç®—æ³•èƒ½å¤„ç†è´Ÿæƒé‡ï¼Œè¿™æ˜¯ä¸å…¶ä»–ç®—æ³•ä¸åŒä¹‹å¤„ã€‚</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Bellman%E2%80%93Ford_algorithm">Bellmanâ€“Ford algorithm(Wikipedia)</a></li>
<li><a href="https://www.programiz.com/dsa/bellman-ford-algorithm">Bellman Ford&rsquo;s Algorithm</a></li>
<li><a href="https://brilliant.org/wiki/bellman-ford-algorithm/">Bellman-Ford Algorithm</a></li>
</ul>


<h2>SPFA</h2>

<p>Shortest Path Faster Algorithmï¼ŒSPFAï¼ŒåŸºäºBellman Fordä¼˜åŒ–å‡ºæ¥çš„æ›´å¿«é€Ÿçš„ç®—æ³•ã€‚SPFA is an optimization of Bellman Ford algorithm.</p>

<ul>
<li><a href="https://cp-algorithms.com/graph/bellman_ford.html">Bellman-Ford Algorithm</a></li>
<li><a href="https://stackoverflow.com/questions/7710995/shortest-paths-faster-spfa-algorithm">Shortest Paths Faster - SPFA Algorithm?</a></li>
<li><a href="https://www.ultipa.com/document/ultipa-graph-analytics-algorithms/spfa/v5.0">Shortest Path Faster Algorithm (SPFA)</a></li>
</ul>


<h2>å…¸å‹é—®é¢˜</h2>

<table>
<thead>
<tr>
<th style="text-align:left;"> é¢˜ç›® </th>
<th style="text-align:left;"> é¢˜è§£ </th>
<th style="text-align:left;"> è¯´æ˜ </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"> <a href="https://leetcode.cn/problems/cheapest-flights-within-k-stops/description/">787. K ç«™ä¸­è½¬å†…æœ€ä¾¿å®œçš„èˆªç­</a></td>
<td style="text-align:left;"> <a href="https://leetcode.cn/problems/cheapest-flights-within-k-stops/solutions/3637197/xi-you-yuan-su-787-k-zhan-zhong-zhuan-ne-xik1/">é¢˜è§£</a> </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:left;"> <a href="https://leetcode.cn/problems/minimum-cost-to-reach-destination-in-time/description/">1928. è§„å®šæ—¶é—´å†…åˆ°è¾¾ç»ˆç‚¹çš„æœ€å°èŠ±è´¹</a></td>
<td style="text-align:left;"> <a href="https://leetcode.cn/problems/minimum-cost-to-reach-destination-in-time/solutions/3661240/xi-you-yuan-su-1928-gui-ding-shi-jian-ne-omo5/">é¢˜è§£</a> </td>
<td style="text-align:left;"> 787çš„å˜ç§ </td>
</tr>
<tr>
<td style="text-align:left;"> <a href=""></a></td>
<td style="text-align:left;"> <a href="">é¢˜è§£</a> </td>
<td style="text-align:left;"> </td>
</tr>
<tr>
<td style="text-align:left;"> <a href=""></a></td>
<td style="text-align:left;"> <a href="">é¢˜è§£</a> </td>
<td style="text-align:left;"> </td>
</tr>
</tbody>
</table>


<h2>References</h2>

<ul>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzU4NDE3MTEyMA==&amp;mid=2247488007&amp;idx=1&amp;sn=9d0dcfdf475168d26a5a4bd6fcd3505d&amp;chksm=fd9cb918caeb300e1c8844583db5c5318a89e60d8d552747ff8c2256910d32acd9013c93058f&amp;token=754098973&amp;lang=zh_CN&amp;poc_token=HBXK_Wej6Ul4b-A49RUuWn8ZDe0YvHMH9w7EGTxA">ã€æœ€çŸ­è·¯/å¿…èƒŒæ¨¡æ¿ã€‘æ¶µç›–æ‰€æœ‰çš„ã€Œå­˜å›¾æ–¹å¼ã€ä¸ã€Œæœ€çŸ­è·¯ç®—æ³•ï¼ˆè¯¦å°½æ³¨é‡Šï¼‰ã€</a></li>
<li><a href="https://leetcode.cn/problems/cheapest-flights-within-k-stops/solutions/955290/gong-shui-san-xie-xiang-jie-bellman-ford-dc94/">ã€å®«æ°´ä¸‰å¶ã€‘è¿ç”¨ Bellman Ford æ±‚è§£æœ‰é™åˆ¶çš„æœ€çŸ­è·¯é—®é¢˜</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ·±å…¥ç†è§£Jetpack Composeä¸­çš„å‡½æ•°çš„æ‰§è¡Œé¡ºåº]]></title>
    <link href="https://alexhilton.github.io/blog/2025/04/26/understanding-execution-order-in-jetpack-compose/"/>
    <updated>2025-04-26T21:21:31+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/04/26/understanding-execution-order-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒUnderstanding Execution Order in Jetpack Compose: DisposableEffect, LaunchedEffect, and Composablesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/understanding-execution-order-in-jetpack-compose-disposableeffect-launchedeffect-and-composables-d2d0b75b7ec8">https://proandroiddev.com/understanding-execution-order-in-jetpack-compose-disposableeffect-launchedeffect-and-composables-d2d0b75b7ec8</a>ï¼Œç”±Sahil Thakarå‘å¸ƒäº2025å¹´4æœˆ13æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/04/26/understanding-execution-order-in-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*44_HTD27S8k-mxkIc_A9zg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼Œä»Šå¤©æˆ‘ä»¬åˆæ¥èŠèŠJetpack-Composeçš„å°è¯é¢˜ã€‚æ— è®ºå¯¹äºæ–°æ‰‹è¿˜æ˜¯ç»éªŒä¸°å¯Œçš„å¼€å‘è€…æ¥è¯´ï¼Œè¿™éƒ½æ˜¯ä¸€ä¸ªå°è¯é¢˜ï¼Œä½†å´æ˜¯å¾ˆå…³é”®çš„ã€‚æˆ‘ä»¬å°†è®¨è®ºä¸€ä¸‹Jetpack Composeä¸­å‰¯ä½œç”¨å’Œå¯ç»„åˆé¡¹ï¼ˆcomposablesï¼‰çš„æ‰§è¡Œé¡ºåºï¼Œç‰¹åˆ«æ˜¯ DisposableEffectã€LaunchedEffect å’Œå¯ç»„åˆå‡½æ•°çš„æ‰§è¡Œé¡ºåºä»¥åŠå…¶ç”Ÿå‘½å‘¨æœŸäº¤äº’è¿‡ç¨‹ã€‚</p>

<p>æˆ‘ä»¬å°†ä»”ç»†æ¢ç©¶ DisposableEffect å’Œ LaunchedEffect åœ¨å¯ç»„åˆé¡¹ä¹‹é—´å¯¼èˆªåˆ‡æ¢æ—¶æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œç‰¹åˆ«å…³æ³¨å®ƒä»¬åœ¨è¿”å›ä¹‹å‰è®¿é—®è¿‡çš„é¡µé¢æ—¶çš„è¡Œä¸ºã€‚ï¼ˆè®¸å¤šç»éªŒä¸°å¯Œçš„å¼€å‘è€…ä¼šå‘Šè¯‰æˆ‘æˆ‘çŸ¥é“è¿™ä¸€ç‚¹ï¼Œä½†æˆ‘æ•¢æ‰“èµŒï¼Œä½ ä»¬ä¸­çš„å¾ˆå¤šäººå¹¶ä¸çŸ¥é“ï¼‰ã€‚</p>

<p>é‚£ä¹ˆï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MyComposable</span><span class="p">(</span><span class="n">cartId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// DisposableEffect observes the lifecycleOwner</span>
</span><span class='line'>    <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s">&quot;Init&quot;</span><span class="p">,</span> <span class="s">&quot;DisposableEffect&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s">&quot;Init&quot;</span><span class="p">,</span> <span class="s">&quot;DisposableEffect - onDispose&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// LaunchedEffect triggers when cartId changes</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">key1</span> <span class="p">=</span> <span class="n">cartId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s">&quot;Init&quot;</span><span class="p">,</span> <span class="s">&quot;LaunchedEffect&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Scaffold is the UI container</span>
</span><span class='line'>    <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="s">&quot;Init&quot;</span><span class="p">,</span> <span class="s">&quot;Column&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// You can add your screen content here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Output</span><span class="p">:-</span>
</span><span class='line'>
</span><span class='line'><span class="n">E</span><span class="p">/</span><span class="n">Init</span><span class="p">:</span> <span class="n">Column</span>
</span><span class='line'><span class="n">E</span><span class="p">/</span><span class="n">Init</span><span class="p">:</span> <span class="n">DisposableEffect</span>
</span><span class='line'><span class="n">E</span><span class="p">/</span><span class="n">Init</span><span class="p">:</span> <span class="n">LaunchedEffect</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ‰§è¡Œé¡ºåºè¿·é¢˜ï¼šä¸ºä»€ä¹ˆColumnå…ˆæ‰§è¡Œï¼Ÿ</h2>

<p>ç­”æ¡ˆåœ¨äºè¿™äº›å‰¯ä½œç”¨ APIï¼ˆDisposableEffectã€LaunchedEffectï¼‰ç›¸å¯¹äºç»„åˆ(Composition)çš„å®é™…æ‰§è¡Œæ—¶é—´ã€‚</p>

<h3>1. ç»„åˆé˜¶æ®µä¼˜å…ˆ</h3>

<ul>
<li>Jetpack Compose é¦–å…ˆåœ¨ç»„åˆæœŸé—´æ„å»ºUIæ ‘ã€‚</li>
<li>æ­¤æ—¶ï¼ŒColumn æ˜¯ä¸€ä¸ªå¯ç»„åˆå‡½æ•°ã€‚å®ƒä¼šåœ¨ç»„åˆé˜¶æ®µç«‹å³æ‰§è¡Œï¼Œä»¥æ„å»º UIã€‚</li>
<li>å› æ­¤ï¼šColumn() é¦–å…ˆè¿è¡Œ â†’ æ‰“å‡ºæ—¥å¿— â€œColumnâ€ã€‚</li>
</ul>


<h3>2. å‰¯ä½œç”¨åœ¨ç»„åˆæœŸé—´æ³¨å†Œï¼Œä½†åœ¨ç»„åˆå®Œæˆåæ‰§è¡Œ</h3>

<ul>
<li>DisposableEffect å’Œ LaunchedEffect åœ¨ç»„åˆæœŸé—´æ³¨å†Œå…¶å·¥ä½œï¼Œ
ä½†å®ƒä»¬çš„å®é™…æ‰§è¡Œå‘ç”Ÿåœ¨ç»„åˆå®Œæˆåã€‚</li>
<li>Compose ä½¿ç”¨å†…éƒ¨è°ƒåº¦ç¨‹åºï¼ˆé€šè¿‡ Recomposerï¼‰åœ¨æäº¤å¸§åè¿è¡Œå‰¯ä½œç”¨ã€‚</li>
</ul>


<p>å› æ­¤ï¼Œå®é™…æ—¶é—´çº¿å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>ç»„åˆï¼ˆCompositionï¼‰ å¼€å§‹
</span><span class='line'>   â†’ Column<span class="o">()</span> è¿è¡Œ â†’ æ‰“å°æ—¥å¿— <span class="s2">&quot;Column&quot;</span>
</span><span class='line'>   â†’ æ³¨å†Œ DisposableEffect ä»£ç å—
</span><span class='line'>   â†’ æ³¨å†Œ LaunchedEffect ä»£ç å—
</span><span class='line'>ç»„åˆ ç»“æŸ
</span><span class='line'>â†’ å‰¯ä½œç”¨å‡½æ•°å¼€å§‹æ‰§è¡Œ
</span><span class='line'>   â†’ DisposableEffect æ‰§è¡Œ â†’ æ‰“å°æ—¥å¿— <span class="s2">&quot;DisposableEffect&quot;</span>
</span><span class='line'>   â†’ LaunchedEffect å¯åŠ¨åç¨‹ â†’ æ‰“å°æ—¥å¿— <span class="s2">&quot;LaunchedEffect&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œæˆ‘ä»¬è®¨è®ºäº†composableså’Œå‰¯ä½œç”¨ä¹‹é—´çš„æ‰§è¡Œé¡ºåºã€‚
é‚£ä¹ˆåœ¨ LaunchedEffectå’Œ DisposableEffectå‰¯ä½œç”¨å‡½æ•°ä¹‹é—´ï¼Œè°åˆå°†å…ˆæ‰§è¡Œå‘¢ï¼Ÿ</p>

<p>è®©æˆ‘ä»¬æ¥ä»”ç»†çœ‹çœ‹ã€‚</p>

<p><strong>å‰¯ä½œç”¨å‡½æ•°çš„æ‰§è¡Œé¡ºåºï¼ˆç»„åˆå®Œæˆåï¼‰ï¼š</strong></p>

<ol>
<li>DisposableEffect â†’ é¦–å…ˆè¿è¡Œ</li>
<li>LaunchedEffect â†’ éšåè¿è¡Œ</li>
</ol>


<p>ä¸ºå•¥å­å‘¢ï¼Ÿ</p>

<p>æ­¤é¡ºåºç”±Composeè¿è¡Œæ—¶å®šä¹‰çš„ï¼š</p>

<ul>
<li>DisposableEffect æ˜¯åŒæ­¥çš„ï¼Œç”¨äºåœ¨ç»„åˆåç«‹å³å¤„ç†è®¾ç½®/æ¸…ç†ã€‚</li>
<li>LaunchedEffect ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œè€Œåç¨‹çš„å¯åŠ¨æ˜¯å¼‚æ­¥çš„ï¼Œè®¡åˆ’åœ¨å…¶ä»–åŒæ­¥æ•ˆæœï¼ˆä¾‹å¦‚ DisposableEffectï¼‰ä¹‹åè¿è¡Œã€‚</li>
</ul>


<p>å†…éƒ¨æœºåˆ¶ï¼šJetpack Compose ç»´æŠ¤äº†æ˜ç¡®å®šä¹‰çš„æ•ˆæœåº”ç”¨é¡ºåºã€‚</p>

<ol>
<li>DisposableEffectã€SideEffectã€SnapshotFlow ç­‰å‰¯ä½œç”¨ä¼šåœ¨ç»„åˆåç«‹å³è§¦å‘ï¼ˆåŒæ­¥ï¼‰ã€‚</li>
<li>ç„¶åï¼ŒåŸºäºåç¨‹çš„æ•ˆæœï¼ˆä¾‹å¦‚ LaunchedEffectï¼‰ä¼šè¢«è°ƒåº¦åˆ°ä¸‹ä¸€ä¸ªè¿è¡Œï¼ˆå¼‚æ­¥ï¼Œé€šè¿‡ Recomposerï¼‰ã€‚</li>
</ol>


<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨å¯ç»„åˆé¡¹ä¹‹é—´å¯¼èˆªåˆ‡æ¢æ—¶ DisposableEffect å’Œ LaunchedEffect æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Œå°¤å…¶å…³æ³¨å®ƒä»¬åœ¨è¿”å›ä¹‹å‰è®¿é—®è¿‡çš„å±å¹•æ—¶çš„è¡Œä¸ºã€‚</p>

<p>è¾“å‡ºç»“æœä¼šè®©ä½ å¤§åƒä¸€æƒŠã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MyApp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">navController</span> <span class="p">=</span> <span class="n">rememberNavController</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">NavHost</span><span class="p">(</span><span class="n">navController</span> <span class="p">=</span> <span class="n">navController</span><span class="p">,</span> <span class="n">startDestination</span> <span class="p">=</span> <span class="s">&quot;screenA&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;screenA&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ScreenA</span><span class="p">(</span>
</span><span class='line'>                <span class="n">cartId</span> <span class="p">=</span> <span class="s">&quot;123&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onNavigateToB</span> <span class="p">=</span> <span class="p">{</span> <span class="n">navController</span><span class="p">.</span><span class="n">navigate</span><span class="p">(</span><span class="s">&quot;screenB&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;screenB&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ScreenB</span><span class="p">(</span>
</span><span class='line'>                <span class="n">cartId</span> <span class="p">=</span> <span class="s">&quot;456&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onNavigateBack</span> <span class="p">=</span> <span class="p">{</span> <span class="n">navController</span><span class="p">.</span><span class="n">popBackStack</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ScreenA</span><span class="p">(</span><span class="n">cartId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">onNavigateToB</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ ScreenA -&gt; DisposableEffect&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ ScreenA -&gt; DisposableEffect - onDispose&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">cartId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ScreenA -&gt; LaunchedEffect&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">100.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="n">onNavigateToB</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Navigate To ScreenB&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ScreenB</span><span class="p">(</span><span class="n">cartId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">onNavigateBack</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ ScreenB -&gt; DisposableEffect&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ ScreenB -&gt; DisposableEffect - onDispose&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">cartId</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;ğŸ˜‡ ScreenB -&gt; LaunchedEffect&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="n">onNavigateBack</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Back to Screen A&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">Output</span><span class="p">:-</span>
</span><span class='line'>
</span><span class='line'><span class="k">when</span> <span class="n">ScreenA</span> <span class="n">init</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">DisposableEffect</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">LaunchedEffect</span>
</span><span class='line'>
</span><span class='line'><span class="n">Navigate</span> <span class="n">To</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">ScreenB</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenB</span> <span class="p">-&gt;</span> <span class="n">DisposableEffect</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenB</span> <span class="p">-&gt;</span> <span class="n">LaunchedEffect</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">DisposableEffect</span> <span class="p">-</span> <span class="n">onDispose</span>
</span><span class='line'>
</span><span class='line'><span class="n">Navigate</span> <span class="n">back</span> <span class="n">to</span> <span class="n">ScreenB</span> <span class="p">-&gt;</span> <span class="n">ScreenA</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">DisposableEffect</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenA</span> <span class="p">-&gt;</span> <span class="n">LaunchedEffect</span>
</span><span class='line'><span class="err">ğŸ˜‡</span> <span class="n">ScreenB</span> <span class="p">-&gt;</span> <span class="n">DisposableEffect</span> <span class="p">-</span> <span class="n">onDispose</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å®ƒï¼ˆJetpack Composeå¯¼èˆªï¼‰å†…éƒ¨å®é™…å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h2>

<p>Compose Navigationåœ¨ NavHostä¸­å›´ç»•å¯ç»„åˆé¡¹çš„è¡Œä¸ºéµå¾ªä»¥ä¸‹é€»è¾‘ï¼š</p>

<ol>
<li>é¦–å…ˆè¿›è¡Œæ–°ç›®çš„åœ°ï¼ˆæ­¤å¤„ä¸º ScreenAï¼‰çš„ç»„åˆã€‚

<ul>
<li>å¯¼èˆªåˆ‡æ¢æ—¶ï¼ŒComposeä¼šç«‹å³ä¸ºæ–°å±å¹•åˆ›å»ºUIã€‚</li>
<li>æ–°é¡µé¢ï¼ˆæ­¤å¤„ä¸º ScreenAï¼‰çš„ DisposableEffect å’Œ LaunchedEffect ä¼šåœ¨æ–°é¡µé¢ç»„åˆæœŸé—´æˆ–ä¹‹åç«‹å³æ‰§è¡Œã€‚</li>
</ul>
</li>
<li>åœ¨æ–°ç›®çš„åœ°æˆåŠŸç»„åˆå¹¶æäº¤åˆ° UI å±‚æ¬¡ç»“æ„åï¼Œä¼šå¤„ç†ä¸Šä¸€ä¸ªé¡µé¢çš„å¯ç»„åˆé¡¹ï¼ˆæ­¤å¤„ä¸º ScreenBï¼‰ã€‚

<ul>
<li>Compose ä¼šä¿æŒä¸Šä¸€ä¸ªå¯ç»„åˆé¡¹ï¼ˆæ­¤å¤„ä¸º ScreenBï¼‰çŸ­æš‚å¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°æ–°å¯ç»„åˆé¡¹ï¼ˆæ­¤å¤„ä¸º ScreenAï¼‰ç¨³å®šï¼Œä»¥ç¡®ä¿å¯¼èˆªé¡ºç•…ã€‚</li>
<li>åªæœ‰åœ¨æ–°çš„å¯ç»„åˆé¡¹ï¼ˆæ­¤å¤„ä¸º ScreenAï¼‰å®Œå…¨ç»„åˆåï¼ŒCompose æ‰ä¼šæ¸…ç†å¹¶ç§»é™¤ï¼ˆdisposeï¼‰ä¸Šä¸€ä¸ªå¯ç»„åˆé¡¹ï¼ˆæ­¤å¤„ä¸º ScreenBï¼‰ã€‚</li>
</ul>
</li>
</ol>


<p>å› æ­¤ï¼Œå¯¼èˆªæœŸé—´çš„å®é™…ç”Ÿå‘½å‘¨æœŸæµç¨‹æ˜¯é…±å©¶å„¿çš„ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>å¯¼èˆªè¿”å› <span class="o">(</span>ScreenB â†’ ScreenA<span class="o">)</span>
</span><span class='line'>â”‚
</span><span class='line'>â”œâ”€â”€ 1ï¸âƒ£ Compose ç«‹å³åˆ›å»º ScreenA
</span><span class='line'>â”‚      â”œâ”€ ScreenA DisposableEffect executes instantly.
</span><span class='line'>â”‚      â””â”€ ScreenA LaunchedEffect coroutine launched.
</span><span class='line'>â”‚
</span><span class='line'>â””â”€â”€ 2ï¸âƒ£ åœ¨ScreenAæˆåŠŸè¿è¡Œä¹‹å:
</span><span class='line'>       â””â”€ ScreenB DisposableEffect onDispose runs.
</span></code></pre></td></tr></table></div></figure>


<h2>ä¸ºå•¥Composeè¦é…±ç´« æï¼Ÿ</h2>

<p>Compose Navigation ä¼šè°¨æ…å¤„ç†é¡µé¢çš„ç»„åˆï¼Œä»¥ç¡®ä¿ä¸æ»‘ï¼ˆseamlessï¼‰çš„ç”¨æˆ·ä½“éªŒå’Œç¨³å®šæ€§ï¼š</p>

<ul>
<li>å®ƒä¸ä¼šåœ¨ç¡®ä¿ç›®æ ‡é¡µé¢ (ScreenA) å·²ç»„åˆå¹¶å‡†å¤‡å°±ç»ªä¹‹å‰è¿‡æ—©åœ°å¤„ç†ä¸Šä¸€ä¸ªå¯ç»„åˆé¡¹ (ScreenB)ã€‚</li>
<li>è¿™å¯ä»¥é¿å…åœ¨å¯¼èˆªåˆ‡æ¢è¿‡ç¨‹ä¸­å‡ºç°è§†è§‰æ•…éšœæˆ–ç©ºç™½å±å¹•ã€‚</li>
<li>åªæœ‰åœ¨ç¡®ä¿æ–°é¡µé¢å®‰å…¨åˆ°ä½åï¼ŒCompose æ‰ä¼šè§¦å‘å¤„ç†ä¸Šä¸€ä¸ªå±å¹•çš„æ“ä½œã€‚</li>
</ul>


<h2>Jetpack Compose NavHostå†…éƒ¨æœºåˆ¶ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰ï¼š</h2>

<p>åœ¨è°ƒç”¨ popBackStack() æˆ– navigate() æ—¶ï¼ŒCompose çš„ NavHost å†…éƒ¨çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š</p>

<ul>
<li>æ–°çš„è·¯ç”±ç»„åˆå¼€å§‹ï¼ˆå¯ç»„åˆé¡¹åˆ›å»ºï¼‰ã€‚</li>
<li>æˆåŠŸç»„åˆå¹¶æäº¤å¸§åï¼Œä¸å†ä½äº NavHost åæ ˆä¸­çš„æ—§å¯ç»„åˆé¡¹èŠ‚ç‚¹å°†è¢«æ ‡è®°ä¸ºå¾…å¤„ç†ã€‚</li>
<li>ç„¶åï¼ŒCompose ä¼šåœ¨ä¸‹ä¸€å¸§ä¸­è¿è¡Œè¿™äº›å·²ç§»é™¤å¯ç»„åˆé¡¹çš„å¤„ç½®é€»è¾‘ (onDispose)ã€‚</li>
</ul>


<p>å› æ­¤ï¼Œå³ä½¿ä½ åœ¨è§†è§‰ä¸Šç«‹å³å¯¼èˆªå›åŸç‚¹ï¼Œé”€æ¯å¼çš„æ“ä½œï¼ˆå¦‚onDisposeï¼‰ä¹Ÿä¼šç•¥å¾®å»¶è¿Ÿæ‰§è¡Œï¼Œä»¥ä¿è¯ç•Œé¢çš„æ•´ä½“ç¨³å®šæ€§ã€‚</p>

<p>å¦‚æœä½ æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·ç•™è¨€ï¼Œæˆ‘ä¼šå°½å¿«å›å¤ä½ ã€‚ğŸ’¬âœ¨
æˆ‘ä»¬å¾ˆå¿«ä¼šæ·±å…¥æ¢è®¨Jetpack Composeï¼Œæ•¬è¯·æœŸå¾…ï¼ğŸš€
åœ¨æ­¤ä¹‹å‰ï¼Œç¥ä½ codingæ„‰å¿«ï¼ğŸ‰ğŸ‘¨â€ğŸ’»</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetpack Composeçš„æ€§èƒ½ä¼˜åŒ–å»ºè®®]]></title>
    <link href="https://alexhilton.github.io/blog/2025/04/22/performance-optimization-in-jetpack-compose/"/>
    <updated>2025-04-22T22:34:25+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/04/22/performance-optimization-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒPerformance Optimization in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://carrion.dev/en/posts/performance-optimization-compose/">https://carrion.dev/en/posts/performance-optimization-compose/</a>ï¼Œç”±Ignacio CarriÃ³nï¼Œå‘å¸ƒäº2025å¹´4æœˆ8æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/04/22/performance-optimization-in-jetpack-compose/"><img src="https://www.itmob.cn/upload/2023/01/banner-jetpack-compose-a452c3e8f1ad489a8560a4f0a9f88e07.jpg" title="auto auto" ></a></p>

<!-- more -->


<p><strong>è¯‘è€…æŒ‰ï¼š</strong> Jetpack Composeæ˜¯ä¸€ä¸ªä¼˜ç§€çš„å£°æ˜å¼UIæ¡†æ¶ï¼Œå¯¹å¼€å‘è€…éå¸¸å‹å¥½ï¼Œå¯ä»¥é«˜æ•ˆç‡çš„æ’¸å„ç§UIé¡µé¢å’ŒUIå…ƒç´ ã€‚ä½†å®ƒä»ç„¶å¹¶ä¸æ˜¯å¾ˆæˆç†Ÿï¼Œæœ‰äº›äº‹æƒ…è¿˜åšä¸äº†ï¼Œè€Œä¸”æ¸²æŸ“æ€§èƒ½ä¹Ÿç•¥è¾“äºåŸç”Ÿçš„Viewæ–¹å¼ï¼Œæ¯•ç«Ÿå®ƒæ¯”åŸç”Ÿçš„Viewå¤šäº†ä¸€å±‚ç»„åˆæ ‘å’Œæ¸²æŸ“æ ‘ã€‚å› æ­¤ï¼Œåœ¨äº«å—å£°æ˜å¼UIå¸¦æ¥çš„ä¾¿æ·çš„åŒæ—¶ï¼Œå°±éœ€è¦æ·±å…¥åœ°äº†è§£å…¶å†…éƒ¨çš„å·¥ä½œæœºåˆ¶ï¼Œå’Œå­¦ä¹ ä¸€äº›é«˜çº§æŠ€å·§ï¼Œä»¥æå‡è¿è¡Œæ—¶çš„æ¸²æŸ“æ€§èƒ½ã€‚å¦å¤–ï¼Œéœ€è¦ æ³¨æ„è™½ç„¶è¿™ç¯‡æ–‡ç« æ˜¯é’ˆå¯¹for Androidçš„Jetpack Composeï¼Œä½†å¤§éƒ¨åˆ†ä¹Ÿé€‚ç”¨äºCompose Multiplatformã€‚</p>

<p>æ€§èƒ½ä¼˜åŒ–å¯¹äºåœ¨Jetpack Composeåº”ç”¨ä¸­æä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦ã€‚æœ¬æ–‡æ¢è®¨äº†å…³é”®æŠ€æœ¯å’Œæœ€ä½³å®è·µï¼Œä»¥ç¡®ä¿ä½ çš„å¯ç»„åˆå‡½æ•°é«˜æ•ˆä¸”æ€§èƒ½å“è¶Šã€‚</p>

<h2>ç†è§£ç»„åˆï¼ˆCompositionï¼‰å’Œé‡ç»„ï¼ˆReCompositionï¼‰</h2>

<p><strong>è¯‘æ³¨ï¼š</strong> ç»„åˆä¸é‡ç»„æ˜¯Composeä¸­éå¸¸é‡è¦ çš„æ¦‚å¿µï¼Œå¦‚æœä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥å¤ä¹ ä¸€ä¸‹ä¹‹å‰çš„æ–‡ç« <a href="https://juejin.cn/post/7379437165486112805">é™Composeåå…«æŒä¹‹ã€æ½œé¾™å‹¿ç”¨ã€| Thinking in Compose</a>å’Œ<a href="https://juejin.cn/post/7401358349877346338">é™Composeåå…«æŒä¹‹ã€æŸåˆ™æœ‰å­šã€| Lifecycle</a>ã€‚</p>

<p>Compose æ€§èƒ½çš„ä¸€ä¸ªåŸºæœ¬æ–¹é¢æ˜¯äº†è§£åˆæˆå’Œé‡ç»„çš„å·¥ä½œåŸç†ï¼š</p>

<h3>æ™ºèƒ½é‡ç»„ï¼ˆSmart Recompositionï¼‰</h3>

<p>Compose ä½¿ç”¨æ™ºèƒ½é‡ç»„åŠŸèƒ½ï¼Œä»…æ›´æ–°ç•Œé¢ä¸­éœ€è¦æ›´æ”¹çš„éƒ¨åˆ†ã€‚äº†è§£è§¦å‘é‡ç»„çš„åŸå› ä»¥åŠå¦‚ä½•æœ€å°åŒ–é‡ç»„çš„å½±å“èŒƒå›´å¯¹äºæ€§èƒ½ä¼˜åŒ–è‡³å…³é‡è¦ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ExpensiveCalculation</span><span class="p">(</span><span class="n">numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ä¸å¥½ï¼šæ¯æ¬¡é‡ç»„éƒ½ä¼šæ‰§è¡Œæ˜‚è´µçš„æ“ä½œ</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">average</span> <span class="p">=</span> <span class="n">numbers</span><span class="p">.</span><span class="n">takeIf</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">?.</span><span class="n">average</span><span class="p">()</span>
</span><span class='line'>        <span class="o">?:</span> <span class="m">0.0</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ä¼˜ç‚¹ï¼šæ˜‚è´µçš„æ“ä½œè¢«ç¼“å­˜ï¼Œå¹¶ä¸”ä»…åœ¨è¾“å…¥å‘ç”Ÿå˜åŒ–æ—¶é‡æ–°è®¡ç®—</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cachedAverage</span> <span class="p">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">numbers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">numbers</span><span class="p">.</span><span class="n">takeIf</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>            <span class="o">?.</span><span class="n">average</span><span class="p">()</span>
</span><span class='line'>            <span class="o">?:</span> <span class="m">0.0</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// æ¯æ¬¡é‡ç»„æ—¶éƒ½ä¼šé‡æ–°è®¡ç®—</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Current Average: ${&quot;</span><span class="p">%.</span><span class="m">2f</span><span class="s">&quot;.format(average)}&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// è¿™å°†ä½¿ç”¨ç¼“å­˜ä½çš„å€¼</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Cached Average: ${&quot;</span><span class="p">%.</span><span class="m">2f</span><span class="s">&quot;.format(cachedAverage)}&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ç¨³å®šç±»å‹ï¼ˆStable typesï¼‰å’Œä¸å¯å˜æ€§ï¼ˆImmutabilityï¼‰</h3>

<p>ç¨³å®šçš„ç±»å‹å¯¹äºComposeçš„æ™ºèƒ½é‡ç»„ç³»ç»Ÿè‡³å…³é‡è¦ã€‚å½“Composeèƒ½å¤Ÿä¿è¯å…¶ equals() æ–¹æ³•ä¸å…¶å±æ€§ä¸€è‡´ï¼Œå¹¶ä¸”å±æ€§æœ¬èº«ä¸ä¼šåœ¨ä¸è§¦å‘é‡ç»„çš„æƒ…å†µä¸‹å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè¯¥ç±»å‹å³è¢«è§†ä¸ºç¨³å®šç±»å‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ä¸å¥½ï¼šç±»å‹ä¸ç¨³å®š - å¯å˜å±æ€§å¯èƒ½ä¼šåœ¨ä¸é€šçŸ¥Composeçš„æƒ…å†µä¸‹å‘ç”Ÿå˜åŒ–</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UserState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="c1">// å¯å˜å±æ€§å¯ä»¥å·å·åœ°æ”¹å˜</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">age</span><span class="p">:</span> <span class="n">Int</span>      <span class="c1">// è€Œä¸”æ›´æ”¹ä¸ä¼šè§¦å‘é‡ç»„</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ä¼˜ç‚¹ï¼šç¨³å®šç±»å‹ - ä¸å¯å˜å±æ€§å’Œæ˜¾å¼ç¨³å®šæ€§</span>
</span><span class='line'><span class="n">@Stable</span>  <span class="c1">// å‘Šè¯‰Composeæ­¤ç±»å‹å…·æœ‰å¯é¢„æµ‹çš„ç›¸ç­‰æ€§</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UserState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>  <span class="c1">// ä¸å¯å˜å±æ€§</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">age</span><span class="p">:</span> <span class="n">Int</span>      <span class="c1">// å¦‚è¦æ›´æ”¹éœ€è¦åˆ›å»ºæ–°å®ä¾‹</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨ç¨³å®šç±»å‹æœ‰ä»¥ä¸‹å‡ ä¸ªå¥½å¤„ï¼š</p>

<ol>
<li>æ›´é«˜æ•ˆçš„é‡ç»„ - å½“Composeç¡®å®šæ•°æ®æœªå‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒå¯ä»¥è·³è¿‡é‡ç»„éƒ¨åˆ†UIï¼Œæ¢å¥è¯è¯´å¯ä»¥å‡å°‘å¾ˆå¤šä¸å¿…è¦çš„é‡ç»„ï¼Œè¿›è€Œæé«˜æ€§èƒ½</li>
<li>å¯é¢„æµ‹çš„è¡Œä¸º - æ•°æ®æ›´æ”¹å§‹ç»ˆä¼šè§¦å‘æ­£ç¡®çš„UIæ›´æ–°</li>
<li>çº¿ç¨‹å®‰å…¨ï¼ˆThread safetyï¼‰ - ä¸å¯å˜æ•°æ®å¯ä»¥å®‰å…¨åœ°åœ¨åç¨‹ä¹‹é—´å…±äº«</li>
</ol>


<p><strong>è¯‘æ³¨ï¼š</strong> è¿™é‡Œè¯´çš„åº”è¯¥æ˜¯å¯ä»¥åœ¨çº¿ç¨‹ä¹‹é—´å®‰å…¨åœ°å…±äº«ï¼Œåç¨‹å¦‚æœæ²¡æœ‰çº¿ç¨‹åˆ‡æ¢æ˜¯ä¸ä¼šæœ‰çº¿ç¨‹å®‰å…¨é—®é¢˜çš„ã€‚</p>

<h2>æ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç‚¹</h2>

<h3>1. åˆç†åœ°ä½¿ç”¨ remember å’Œ derivedStateOf è¿›è¡ŒçŠ¶æ€ï¼ˆStateï¼‰ç®¡ç†</h3>

<p>remember å’Œ derivedStateOf å‡½æ•°åœ¨çŠ¶æ€ç®¡ç†ä¸­èµ·åˆ°ä¸åŒçš„ä½œç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">UserProfile</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ç¼ºç‚¹ï¼šæ¯æ¬¡é‡æ–°ç»„åˆæ—¶éƒ½é‡æ–°è®¡ç®—</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">filteredItems</span> <span class="p">=</span> <span class="n">items</span><span class="p">.</span><span class="n">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">userId</span> <span class="p">==</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å¥½ï¼šä½¿ç”¨è®°å¿†ç¼“å­˜è®¡ç®—</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cachedItems</span> <span class="p">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">items</span><span class="p">.</span><span class="n">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">userId</span> <span class="p">==</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨ derivedStateOf è¿›è¡Œååº”å¼è®¡ç®—</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">reactiveItems</span> <span class="k">by</span> <span class="n">remember</span><span class="p">(</span><span class="n">items</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">derivedStateOf</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">items</span><span class="p">.</span><span class="n">filter</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">userId</span> <span class="p">==</span> <span class="n">user</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å½“ items å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒreactiveItems ä¼šè‡ªåŠ¨æ›´æ–°</span>
</span><span class='line'>    <span class="c1">// å¹¶ä¸”ä»…åœ¨è¿‡æ»¤ç»“æœå‘ç”Ÿå˜åŒ–æ—¶è§¦å‘é‡ç»„</span>
</span><span class='line'>    <span class="n">LazyColumn</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">itemsIndexed</span><span class="p">(</span>
</span><span class='line'>            <span class="n">items</span> <span class="p">=</span> <span class="n">reactiveItems</span><span class="p">,</span>
</span><span class='line'>            <span class="n">key</span> <span class="p">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span> <span class="p">-&gt;</span> <span class="n">item</span><span class="p">.</span><span class="n">id</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Item</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">ItemRow</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>è¯‘æ³¨ï¼š</strong> å¯¹äºçŠ¶æ€çš„ç®¡ç†ï¼Œå¯ä»¥å¤ä¹ ä¸€ä¸‹ä¹‹å‰ä¸“é—¨è®²è§£å‰¯ä½œç”¨(Side effects)çš„æ–‡ç« <a href="https://juejin.cn/post/7405158681078104127">é™Composeåå…«æŒä¹‹ã€é¾™æˆ˜äºé‡ã€| Side Effects</a>ã€‚</p>

<h3>2. åˆç†åœ°ä½¿ç”¨CompositionLocal</h3>

<p><strong>è¯‘æ³¨ï¼š</strong> å…³äºCompositionLocalçš„ä½¿ç”¨å¯ä»¥çœ‹å‰é¢å†™è¿‡çš„æ–‡ç« <a href="https://juejin.cn/post/7434543407636267071">ç”¨Composeä¸­çš„CompositionLocalæ¥æš—æ¸¡é™ˆä»“</a>ï¼Œä¸‹é¢çš„ç¤ºä¾‹æ˜¯æƒ³è¦è¯´æ˜ï¼Œåº”è¯¥åœ¨åˆç†çš„åœ°æ–¹è®¿é—®CompositionLocalé‡Œé¢çš„æ•°æ®ï¼Œå› æ•°å¯¹CompositionLocalçš„è®¿é—®åœ°æ–¹ä¼šè¢«è§¦å‘é‡ç»„ï¼ˆ<a href="https://juejin.cn/post/7401358349877346338">ä¹‹å‰çš„æ–‡ç« æœ‰è®²è¿‡</a>é‡ç»„çš„è§¦å‘æ˜¯çŠ¶æ€ä½¿ç”¨çš„åœ°æ–¹ï¼Œè€Œä¸æ˜¯å®šä¹‰çš„åœ°æ–¹ï¼‰ï¼Œå¦‚æœåœ¨æ‰€æœ‰çš„åœ°æ–¹éƒ½ ç›´æ¥è®¿é—®CompositionLocalï¼Œç‰¹åˆ«æ˜¯åµŒå¥—è¾ƒæ·±çš„åœ°æ–¹ä¹Ÿéƒ½ ç›´æ¥è®¿é—®ï¼Œé‚£éƒ½ä¼šè§¦å‘é‡ç»„ï¼Œä½†å¤§éƒ¨åˆ†å…¶å®æ˜¯ä¸å¿…è¦çš„ã€‚åƒä¸‹æ ·ç¤ºä¾‹å±•ç¤ºçš„é‚£æ ·ï¼Œåœ¨ä¸€å®šçš„çº§åˆ«ä¸­è®¿é—®CompositionLocalï¼Œç„¶åå®ƒçš„å†…éƒ¨åµŒå¥—è°ƒç”¨ç›´æ¥å¤ç”¨æ•°å€¼ï¼Œå¯ä»¥é¿å…è¿‡åº¦é‡ç»„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ä¸å¥½ï¼šæ¯ä¸ªå­ç»„ä»¶éƒ½è®¿é—® CompositionLocal</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DeepNestedContent</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">theme</span> <span class="p">=</span> <span class="n">LocalTheme</span><span class="p">.</span><span class="n">current</span>  <span class="c1">// ç›´æ¥è®¿é—®</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">strings</span> <span class="p">=</span> <span class="n">LocalStrings</span><span class="p">.</span><span class="n">current</span>  <span class="c1">// å¤šä¸ª CompositionLocal è®¿é—®</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">dimensions</span> <span class="p">=</span> <span class="n">LocalDimensions</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">strings</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
</span><span class='line'>            <span class="n">style</span> <span class="p">=</span> <span class="n">theme</span><span class="p">.</span><span class="n">textStyle</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">padding</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="c1">// å…·æœ‰é‡å¤ CompositionLocal è®¿é—®çš„æ›´å¤šåµŒå¥—å†…å®¹</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// å¥½ï¼šæå‡ CompositionLocalçš„å€¼ä»¥æœ€å°åŒ–æŸ¥æ‰¾</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ParentContent</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// å•ç‹¬è®¿é—® CompositionLocal å€¼</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">theme</span> <span class="p">=</span> <span class="n">LocalTheme</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">strings</span> <span class="p">=</span> <span class="n">LocalStrings</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">dimensions</span> <span class="p">=</span> <span class="n">LocalDimensions</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">DeepNestedContent</span><span class="p">(</span>
</span><span class='line'>        <span class="n">theme</span> <span class="p">=</span> <span class="n">theme</span><span class="p">,</span>
</span><span class='line'>        <span class="n">strings</span> <span class="p">=</span> <span class="n">strings</span><span class="p">,</span>
</span><span class='line'>        <span class="n">dimensions</span> <span class="p">=</span> <span class="n">dimensions</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DeepNestedContent</span><span class="p">(</span>
</span><span class='line'>    <span class="n">theme</span><span class="p">:</span> <span class="n">Theme</span><span class="p">,</span>
</span><span class='line'>    <span class="n">strings</span><span class="p">:</span> <span class="n">Strings</span><span class="p">,</span>
</span><span class='line'>    <span class="n">dimensions</span><span class="p">:</span> <span class="n">Dimensions</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ä½¿ç”¨ä¼ é€’çš„å‚æ•°è€Œä¸æ˜¯æŸ¥æ‰¾ CompositionLocal å€¼</span>
</span><span class='line'>    <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">strings</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
</span><span class='line'>            <span class="n">style</span> <span class="p">=</span> <span class="n">theme</span><span class="p">.</span><span class="n">textStyle</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">dimensions</span><span class="p">.</span><span class="n">padding</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="c1">// ä½¿ç”¨ä¼ é€’çš„å‚æ•°è¿›è¡Œæ›´å¤šåµŒå¥—å†…å®¹</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. LazyList ä¼˜åŒ–æŠ€å·§</h3>

<p>é«˜æ•ˆçš„åˆ—è¡¨æ¸²æŸ“å¯¹äºæµç•…çš„æ»šåŠ¨æ€§èƒ½è‡³å…³é‡è¦ã€‚ä»¥ä¸‹æ˜¯é’ˆå¯¹ LazyList ç»„ä»¶çš„å…³é”®ä¼˜åŒ–ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">Any</span><span class="p">&gt;</span> <span class="n">OptimizedList</span><span class="p">(</span><span class="n">items</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LazyColumn</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">itemsIndexed</span><span class="p">(</span>
</span><span class='line'>            <span class="n">items</span> <span class="p">=</span> <span class="n">items</span><span class="p">,</span>
</span><span class='line'>            <span class="c1">// ç¨³å®šçš„keyæœ‰åŠ©äºComposeåœ¨æ›´æ–°è¿‡ç¨‹ä¸­è·Ÿè¸ªé¡¹ç›®</span>
</span><span class='line'>            <span class="n">key</span> <span class="p">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">T</span> <span class="p">-&gt;</span> <span class="n">item</span><span class="p">.</span><span class="n">hashCode</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">T</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// æ¯ä¸ªitemçš„å†…å®¹</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>LazyList çš„å…³é”®ä¼˜åŒ–ç‚¹ï¼š</p>

<ol>
<li>æä¾›ç¨³å®šçš„é”®ï¼Œå¸®åŠ©Composeåœ¨æ›´æ–°è¿‡ç¨‹ä¸­è·Ÿè¸ªé¡¹ç›®</li>
<li>å°½å¯èƒ½ä½¿ç”¨å›ºå®šå¤§å°ä»¥é¿å…é‡æ–°æµ‹é‡</li>
<li>ä¿æŒé¡¹ç›®å¯ç»„åˆé¡¹çš„è½»é‡çº§</li>
<li>é¿å…åœ¨é¡¹ç›®å†…å®¹ä¸­è¿›è¡Œä¸å¿…è¦çš„åˆ†é…</li>
<li>è®°ä½è¦ä¸ºæ¯ä¸ªé¡¹ç›®ç¼“å­˜æ˜‚è´µçš„è®¡ç®—</li>
</ol>


<h2>æµ‹é‡å’Œç›‘æ§æ€§èƒ½</h2>

<h3>Layout Inspectorå’ŒComposition Traces</h3>

<p>Android Studio ä¸­çš„å¸ƒå±€æ£€æŸ¥å™¨æ˜¯ä¸€æ¬¾å¼ºå¤§çš„Composeç•Œé¢æ€§èƒ½è°ƒè¯•å·¥å…·ã€‚å®ƒèƒ½å¤Ÿå¸®åŠ©ä½ æ·±å…¥äº†è§£åº”ç”¨çš„è§†å›¾å±‚æ¬¡ç»“æ„ã€é‡ç»„è®¡æ•°ä»¥åŠåº”ç”¨äºæ¯ä¸ªå¯ç»„åˆé¡¹çš„ä¿®é¥°ç¬¦ã€‚</p>

<p>è¦å°†å¸ƒå±€æ£€æŸ¥å™¨ä¸Composeç»“åˆä½¿ç”¨ï¼Œè¯·æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>

<ol>
<li>åœ¨è°ƒè¯•æ¨¡å¼ä¸‹è¿è¡Œä½ çš„åº”ç”¨</li>
<li>åœ¨â€œæ­£åœ¨è¿è¡Œçš„è®¾å¤‡â€çª—å£ä¸­ï¼Œä½ å°†çœ‹åˆ°ä¸€ä¸ªç”¨äºåˆ‡æ¢å¸ƒå±€æ£€æŸ¥å™¨çš„æŒ‰é’®</li>
<li>æ£€æŸ¥Composeå±‚æ¬¡ç»“æ„ï¼š

<ul>
<li>æŸ¥çœ‹ç»„ä»¶æ ‘</li>
<li>æ£€æŸ¥é‡ç»„è®¡æ•°</li>
<li>åˆ†æä¿®é¥°ç¬¦é“¾</li>
<li>æ£€æŸ¥å¯ç»„åˆé¡¹å‚æ•°</li>
</ul>
</li>
</ol>


<p><img src="https://carrion.dev/images/kotlin/layout-inspector.png" alt="Layout Inspector" /></p>

<p>å¸ƒå±€æ£€æŸ¥å™¨ä¸­éœ€è¦ç›‘æ§çš„å…³é”®æŒ‡æ ‡ï¼š</p>

<ol>
<li>é‡ç»„è®¡æ•° - æ•°å€¼è¾ƒé«˜è¡¨ç¤ºå­˜åœ¨æ½œåœ¨çš„ä¼˜åŒ–æœºä¼š</li>
<li>è·³è¿‡è®¡æ•° - æ£€æŸ¥å¯ç»„åˆé¡¹æ˜¯å¦åœ¨åº”è¯¥è·³è¿‡é‡ç»„æ—¶è·³è¿‡</li>
<li>ä¿®é¥°ç¬¦é“¾å¤æ‚åº¦ - è¾ƒé•¿çš„ä¿®é¥°ç¬¦é“¾å¯èƒ½ä¼šå½±å“æµ‹é‡/å¸ƒå±€æ€§èƒ½</li>
</ol>


<h3>æ€§èƒ½æµ‹è¯•</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">performanceTest</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">benchmarkRule</span><span class="p">.</span><span class="n">measureRepeated</span><span class="p">(</span>
</span><span class='line'>        <span class="n">packageName</span> <span class="p">=</span> <span class="s">&quot;com.example.app&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">metrics</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="n">FrameTimingMetric</span><span class="p">()),</span>
</span><span class='line'>        <span class="n">iterations</span> <span class="p">=</span> <span class="m">5</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">composeTestRule</span><span class="p">.</span><span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">YourComposable</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æœ€ä½³å®è·µæ€»ç»“</h2>

<ol>
<li>ä½¿ç”¨ç¨³å®šç±»å‹(Stable types)å’Œä¸å¯å˜æ•°æ®ç»“æ„(Immutable data structures)</li>
<li>ä½¿ç”¨rememberæå‡é«˜å¼€é”€è®¡ç®—</li>
<li>åœ¨æƒ°æ€§åˆ—è¡¨(lazy list)ä¸­å®ç°åˆé€‚çš„é”®(key)</li>
<li>æœ€å°åŒ–é‡ç»„èŒƒå›´</li>
<li>å®šæœŸåˆ†æå’Œæµ‹é‡æ€§èƒ½</li>
</ol>


<p>éµå¾ªè¿™äº›ä¼˜åŒ–æŠ€å·§å°†æœ‰åŠ©äºç¡®ä¿ä½ çš„Compose UIä¿æŒå“åº”è¿…é€Ÿä¸”é«˜æ•ˆï¼Œä»è€Œä¸ºä½ çš„åº”ç”¨æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compose Multiplatformæ”¯æŒçƒ­é‡è½½(Hot Reload)äº†]]></title>
    <link href="https://alexhilton.github.io/blog/2025/04/12/compose-hot-reload/"/>
    <updated>2025-04-12T17:11:47+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/04/12/compose-hot-reload</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªCompose Hot Reload is Now Availableï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@wisemuji/compose-hot-reload-is-now-available-3a9aee58b0fe">Compose Hot Reload is Now Available</a>ï¼Œç”±<a href="https://medium.com/@wisemuji">Suhyeon Kim</a>ï¼Œå‘å¸ƒäº2025å¹´3æœˆ19æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/04/12/compose-hot-reload/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FMBFWn5vJOuaM41zKE6aTg.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p><strong>è¯‘æ³¨ï¼š</strong>  éœ€è¦æ³¨æ„çš„æ˜¯Googleé€šè¿‡Android Studio(after Giraffe)é‡Œé¢çš„<a href="https://developer.android.com/develop/ui/compose/tooling/iterative-development">Live Editç‰¹æ€§</a>æä¾›äº†å¯¹Androidä¸Šé¢çš„Jetpack Composeçš„å®æ—¶æ›´æ–°æ”¯æŒã€‚ä½†å®ƒä»…æ”¯æŒJetpack Compose (for Adnroid)ï¼Œå¹¶ä¸æ”¯æŒCMPï¼Œä¹Ÿå³ä¸æ”¯æŒJetBrainsçš„Composeã€‚ä¹Ÿæ­£å› ä¸ºå¦‚æ­¤JetBrainsæ‰ä¼šå¼€å‘é¢å‘CMPçš„Hot Reloadã€‚</p>

<p>åœ¨Compose UIå¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½ æ˜¯å¦ç»å¸¸éœ€è¦æ„å»ºè¿è¡Œï¼ŸCompose çƒ­é‡è½½ç°å·²åœ¨Maven Centralä¸­æ¨å‡ºï¼Œå¯ä¸ºComposeå¤šå¹³å°ï¼ˆæ¡Œé¢ï¼‰åº”ç”¨ä¸­çš„UIä»£ç æä¾›å®æ—¶æ›´æ–°ã€‚æˆ‘ä»¬æ— éœ€é‡å¯åº”ç”¨å³å¯ç«‹å³æŸ¥çœ‹UIä»£ç çš„æ›´æ”¹ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥ä¸€æ¢ç©¶ç«Ÿï¼</p>

<h2>çƒ­é‡è½½(Hot Reload)æ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</h2>

<p>è®¸å¤šå£°æ˜å¼UIæ¡†æ¶éƒ½æä¾›äº†ç±»ä¼¼æ¦‚å¿µï¼Œçƒ­é‡è½½ï¼Œå³å¯ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­æä¾›å¯¹UIæ›´æ”¹çš„è¿‘ä¹å³æ—¶çš„åé¦ˆï¼ˆå°½ç®¡å®ƒä»¬çš„åç§°ä¸åŒï¼ï¼‰ã€‚</p>

<p>ä¾‹å¦‚éš”å£çš„ä¸¤å®¶ï¼š</p>

<ul>
<li>Flutterçƒ­åŠ è½½ï¼š<a href="https://docs.flutter.dev/tools/hot-reload">https://docs.flutter.dev/tools/hot-reload</a></li>
<li>React Nativeå¿«é€Ÿåˆ·æ–°ï¼š<a href="https://reactnative.dev/docs/fast-refresh">https://reactnative.dev/docs/fast-refresh</a></li>
</ul>


<p>çƒ­é‡è½½å…è®¸å¼€å‘è€…å®æ—¶æŸ¥çœ‹ä»£ç æ›´æ”¹ï¼Œæ— éœ€é‡å¯åº”ç”¨æˆ–é‡æ–°ç¼–è¯‘æ•´ä¸ªé¡¹ç›®ã€‚åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œçƒ­é‡è½½ä¼šä¿ç•™åº”ç”¨çš„çŠ¶æ€ï¼Œå› æ­¤å¼€å‘è€…å¯ä»¥ç»§ç»­ä¸åº”ç”¨äº¤äº’ï¼Œè€Œä¸ä¼šä¸¢å¤±è¿›åº¦æˆ–ä¸Šä¸‹æ–‡ã€‚è¿™å¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ¼”ç¤ºä»£ç æ›´æ”¹å¯¹UIçš„å½±å“ï¼Œä»è€Œæé«˜å·¥ä½œæ•ˆç‡ï¼Œè€Œæ— éœ€ç­‰å¾…æ¼«é•¿çš„æ„å»ºã€‚</p>

<h2>Composeçš„çƒ­é‡è½½</h2>

<p>çœ‹ä¸€ä¸‹å®˜æ–¹çš„ä»‹ç»<a href="https://github.com/JetBrains/compose-hot-reload">https://github.com/JetBrains/compose-hot-reload</a>ï¼š</p>

<blockquote><p>åœ¨Composeå¤šå¹³å°åº”ç”¨ä¸­æ›´æ”¹ä½ çš„UIä»£ç ï¼Œå¹¶å®æ—¶æŸ¥çœ‹ç»“æœã€‚
æ— éœ€é‡å¯åº”ç”¨ã€‚</p></blockquote>

<p>ç›®å‰ï¼ŒCompose Hot Reload é€‚ç”¨äºé’ˆå¯¹æ¡Œé¢ JVM çš„å¤šå¹³å°é¡¹ç›®ï¼ˆæœªæ¥æ˜¯å¦æœ‰å¯èƒ½æ‰©å±•ï¼Ÿæˆ‘ä¸ç¡®å®šã€‚:Dï¼‰ã€‚Compose Hot Reload çš„æœ€æ–°ç‰ˆæœ¬æ˜¯ v1.0.0-alpha02ï¼Œäºæ˜¨å¤©ï¼ˆ2025 å¹´ 3 æœˆ 17 æ—¥ï¼‰å‘å¸ƒã€‚ç°åœ¨ï¼Œå¼€å‘è€…å¯ä»¥åœ¨Composeå¤šå¹³å°åº”ç”¨ä¸­æŸ¥çœ‹å…¶UIä»£ç çš„æ›´æ”¹ï¼Œè€Œæ— éœ€é‡å¯åº”ç”¨ã€‚è¿™æ„å‘³ç€å¼€å‘è€…å¯ä»¥ç«‹å³é¢„è§ˆæ›´æ”¹ï¼Œè€Œæ— éœ€ç¼“æ…¢çš„æ„å»ºå’Œé‡å¯ã€‚</p>

<p><strong>è¯‘æ³¨ï¼š</strong> ç°åœ¨ï¼ˆ2025å¹´4æœˆ9æ—¥ï¼‰æœ€æ–°ç‰ˆæœ¬æ˜¯ v1.0.0-alpha04ï¼Œä¸»è¦æ˜¯Bugfixï¼Œç›®å‰å¼€å‘ä¸­çš„ç‰ˆæœ¬æ˜¯ v1.0.0-alpha05 ã€‚</p>

<h2>å¦‚ä½•ä¸Šæ‰‹</h2>

<p>è¦å¼€å§‹ä½¿ç”¨Compose Hot Reloadï¼Œè¯·æŸ¥çœ‹<a href="https://github.com/JetBrains/compose-hot-reload">Compose Hot Reload</a>çš„ GitHub ä»£ç åº“ã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong> ä»¥ä¸‹å†…å®¹åŸºäº v1.0.0-alpha02 ç¼–å†™ã€‚</p>

<h3>ä¾èµ–è¦æ±‚</h3>

<ul>
<li>ä¸€ä¸ªä»¥æ¡Œé¢ä¸ºç›®æ ‡çš„Compose Multiplatform é¡¹ç›®ï¼ˆå‚è§<a href="https://github.com/JetBrains/compose-hot-reload#faq">å…¶FAQ</a>ï¼‰</li>
<li>Kotlin 2.1.20-Beta2 æˆ–æ›´é«˜ç‰ˆæœ¬</li>
</ul>


<p>å¯¹äº Android åº”ç”¨ï¼Œæœ‰ä¸€ä¸ªå°çš„è§£å†³æ–¹æ³•ï¼š
é¦–å…ˆï¼Œä½ éœ€è¦ä»Jetpack Composeæ’ä»¶åˆ‡æ¢åˆ°Compose Multiplatform æ’ä»¶ï¼Œ
ç„¶åæ·»åŠ ä¸€ä¸ªå•ç‹¬çš„ Gradle æ¨¡å—å¹¶é…ç½®æ¡Œé¢ç›®æ ‡ã€‚</p>

<h3>å°† Gradle æ’ä»¶åº”ç”¨åˆ°ä½ çš„é¡¹ç›®ä¸­</h3>

<p>å°† org.jetbrains.compose.hot-reload Gradle æ’ä»¶æ·»åŠ åˆ°ä½ çš„æ„å»ºè„šæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">plugins</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;multiplatform&quot;</span><span class="p">)</span> <span class="n">version</span> <span class="s">&quot;2.1.20-RC&quot;</span> <span class="c1">// &lt;- Use Kotlin 2.1.20-RC or higher!</span>
</span><span class='line'>    <span class="n">kotlin</span><span class="p">(</span><span class="s">&quot;plugin.compose&quot;</span><span class="p">)</span> <span class="n">version</span> <span class="s">&quot;2.1.20-RC&quot;</span> <span class="c1">// &lt;- Use Compose Compiler Plugin 2.1.20-RC or higher!</span>
</span><span class='line'>    <span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">id</span><span class="p">(</span><span class="s">&quot;org.jetbrains.compose.hot-reload&quot;</span><span class="p">)</span> <span class="n">version</span> <span class="s">&quot;1.0.0-alpha02&quot;</span> <span class="c1">// &lt;- add this additionally</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å¯ç”¨â€œOptimizeNonSkippingGroupsâ€ï¼š</h3>

<p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ°ä½ çš„ build.gradle.kts ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">import</span> <span class="nn">org.jetbrains.kotlin.compose.compiler.gradle.ComposeFeatureFlag</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="n">composeCompiler</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">featureFlags</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">ComposeFeatureFlag</span><span class="p">.</span><span class="n">OptimizeNonSkippingGroups</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ä¸ºUIçƒ­é‡è½½æä¾›å…¥å£ç‚¹</h3>

<p>åœ¨é¡¹ç›®çš„æ¡Œé¢æºä»£ç é›†ä¸­ï¼Œä½¿ç”¨ DevelopmentEntryPoint åŒ…è£…çª—å£å†…å®¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">import</span> <span class="nn">org.jetbrains.compose.reload.DevelopmentEntryPoint</span>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">singleWindowApplication</span><span class="p">(...)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">DevelopmentEntryPoint</span> <span class="p">{</span> <span class="c1">// add this line</span>
</span><span class='line'>            <span class="n">App</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±æ˜¯æˆ‘ä»¬éœ€è¦æŠ˜è…¾çš„å…¨éƒ¨å†…å®¹ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<h2>Demoæ¼”ç¤º</h2>

<p>è¦äº†è§£Compose çƒ­é‡è½½çš„å®é™…æ•ˆæœï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æˆ‘çš„ç¤ºä¾‹é¡¹ç›®<a href="https://github.com/wisemuji/compose-would-you-rather-game">â€œWould You Rather Gameâ€</a>ã€‚è¿™ä¸ªé¡¹ç›®æ˜¯ä¸€ä¸ªç®€å•çš„ Compose å¤šå¹³å°æ¡Œé¢åº”ç”¨ï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­å›ç­”æœ‰è¶£çš„â€œWould You Ratherâ€é—®é¢˜ã€‚Compose çƒ­é‡è½½æ’ä»¶æœ€è¿‘å·²å®ç°ã€‚</p>

<p>ä½ å¯ä»¥å‚è€ƒ Compose çƒ­é‡è½½çš„setupæäº¤ï¼š<a href="https://github.com/wisemuji/compose-would-you-rather-game/commit/937375cea9010733ee751dc2d464a0df21318cee">setupæäº¤</a>ã€‚</p>

<p>å¦‚æœä½ åœ¨é¡¹ç›®ä¸Šè¿è¡ŒdesktopRunï¼Œä½ ä¼šæ³¨æ„åˆ°æ¡Œé¢åº”ç”¨ç¨‹åºæ—è¾¹ä¼šå‡ºç°ä¸€ä¸ªå°çš„Composeå›¾æ ‡ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*TXn4jUzxwcSh5IfqRqFNkA.png" alt="HotReload Icon" /></p>

<p>è¿™å°†è§¦å‘ Compose Hot Reload Tooling æ¨¡å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*37gLudPijGvh3A-rKdK_kw.png" alt="HotReload Demo" /></p>

<h3>UIæ›´æ”¹ç¤ºä¾‹</h3>

<p>å‡è®¾æˆ‘ä»¬æƒ³è¦æ›´æ”¹<a href="https://github.com/wisemuji/compose-would-you-rather-game/blob/4e9bfc7172c7145f95190fd383169bbcdc25856f/composeApp/src/commonMain/kotlin/ui/game/GameScreen.kt#L226">GameScreen.kt</a>ä¸­çš„åŠ¨ç”»ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b4xJXpWH9oA5YohC1zsWng.gif" alt="Full Demo" /></p>

<p>çœ‹åˆ°æ²¡æœ‰ï¼ä¸€æ—¦æˆ‘ä»¬ä¿å­˜æ–‡ä»¶ï¼Œæ›´æ”¹å°±ä¼šç«‹å³æ˜¾ç¤ºåœ¨æ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºä¸­ã€‚æ— éœ€é‡å¯åº”ç”¨ï¼</p>

<h2>çƒ­é‡è½½å½“å‰æ”¯æŒçš„åœºæ™¯</h2>

<p>ç›®å‰ï¼Œå‡ ä¹æ‰€æœ‰ä»£ç æ›´æ”¹éƒ½æ”¯æŒçƒ­é‡è½½ï¼ˆé™¤äº†ä»ç±»ä¸­åˆ é™¤è¶…ç±»å‹ï¼‰ã€‚</p>

<p><a href="https://hashnode.com/@sellmair">Sebastian Sellmair çš„è§†é¢‘å’Œåšå®¢æ–‡ç« </a>é€šè¿‡å¤šä¸ªæ¼”ç¤ºå±•ç¤ºäº†è¿™äº›åŠŸèƒ½ï¼Œå¹¶è¯¦ç»†è§£é‡Šäº†é‡è½½çš„åº•å±‚å·¥ä½œåŸç†ã€‚</p>

<h2>å±€é™æ€§</h2>

<p>ç”±äºå®ƒä»…æ”¯æŒåŸºäº JVM çš„æ¡Œé¢åº”ç”¨ï¼Œå› æ­¤ç›®å‰å°šä¸æ”¯æŒ Android å’Œå…¶ä»–å¹³å°ã€‚
æ­¤å¤–ï¼Œæ„å»ºæ€§èƒ½æ–¹é¢å¯èƒ½å­˜åœ¨ä¸€äº›é—®é¢˜ã€‚åœ¨æˆ‘çš„æœ¬åœ°ç¯å¢ƒä¸­ï¼Œæ›´æ”¹å¤§çº¦éœ€è¦ 3 åˆ° 5 ç§’ï¼Œæ„Ÿè§‰æ¯”å…¶ä»–å£°æ˜å¼UIæ¡†æ¶ä¸­çš„çƒ­é‡è½½æ…¢ä¸å°‘ã€‚ä¼°è®¡å®ƒä¼šåœ¨åé¢å¾—åˆ°æ”¹å–„ã€‚</p>

<p>ç”±äºè¿™æ˜¯ä¸€ä¸ª Alpha ç‰ˆæœ¬ï¼Œå› æ­¤æ— æ³•ä¿è¯ç¨³å®šæ€§ã€‚å¼€å‘è€…åº”è¯¥é¢„æ–™åˆ°å¯èƒ½ä¼šå‡ºç°ä¸€äº›æ½œåœ¨çš„é”™è¯¯å’Œè¿ç§»æŒ‘æˆ˜ï¼Œæ­£å¦‚ JetBrains å›¢é˜Ÿæ‰€æŒ‡å‡ºçš„ï¼šâ€œAlpha ç‰ˆæœ¬æ„å‘³ç€ä½¿ç”¨é£é™©è‡ªè´Ÿï¼Œè¿ç§»é—®é¢˜ä¹Ÿéœ€è°¨æ…ã€‚æˆ‘ä»¬æ‰“ç®—å°†è¿™ä¸ªæƒ³æ³•äº§å“åŒ–ï¼Œä½†å°šæœªæœ€ç»ˆæˆå‹ã€‚â€ ç”±äºè¯¥åŠŸèƒ½ä»åœ¨ç§¯æå¼€å‘ä¸­ï¼Œå› æ­¤æˆ‘ä»¬åº”è¯¥åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­æŒç»­å…³æ³¨æ›´æ–°ã€‚</p>

<h2>æä¾›åé¦ˆ</h2>

<p>å¦‚æœä½ é‡åˆ°ä»»ä½•é—®é¢˜æˆ–æœ‰æ”¹è¿›å»ºè®®ï¼Œä½ å¯ä»¥é€šè¿‡<a href="https://slack-chats.kotlinlang.org/t/27038699/with-compose-hot-reload-now-being-available-on-maven-central"> Kotlinlang Slack - Compose Hot Reload </a>åˆ†äº«ä½ çš„æƒ³æ³•ã€‚</p>

<blockquote><p>å°¤å…¶æ¬¢è¿æï¼š</p>

<ul>
<li>è®¾ç½®æ—¶é‡åˆ°çš„é—®é¢˜</li>
<li>é‡æ–°åŠ è½½ç‰¹å®šä»£ç æ®µæ—¶é‡åˆ°çš„é—®é¢˜</li>
<li>å…³äºå¦‚ä½•æ”¹è¿›/åŠŸèƒ½è¯·æ±‚çš„æƒ³æ³•</li>
</ul>


<p>ç›®å‰ä¸å¤ªæ„Ÿå…´è¶£çš„å†…å®¹ï¼š</p>

<ul>
<li>æ„å»ºæ€§èƒ½ï¼šç›®å‰ï¼Œâ€œGradle é‡ç¼–è¯‘å™¨â€çš„é€Ÿåº¦å°†ä¸ä½ çš„é¡¹ç›®é€Ÿåº¦ä¸€æ ·å¿«ã€‚å¼ºçƒˆå»ºè®®
å¯ç”¨ Gradles é…ç½®ç¼“å­˜ï¼Œå¹¶ä¿æŒé¡¹ç›®éå¸¸å¹²å‡€ã€‚å…¶ä»–â€œé‡ç¼–è¯‘å™¨â€ä¹Ÿä¼šæœ‰æ‰€å¸®åŠ©ï¼ï¼ˆIntelliJã€Amper ç­‰ï¼‰</li>
</ul>
</blockquote>

<h2>æ€»ç»“</h2>

<p>æˆ‘ç›¸ä¿¡ Compose ä¸­çš„ Hot Reload æ˜¯å¼€å‘ Compose UIçš„ä¸€å¤§å˜é©ã€‚
å®ƒå¯ä»¥è®©å¼€å‘äººå‘˜åœ¨æ— éœ€é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹çœ‹åˆ°æ›´æ”¹ï¼Œä»è€ŒåŠ å¿«UIå¼€å‘é€Ÿåº¦ï¼Œä½†å®ƒä»å¤„äºå®éªŒé˜¶æ®µã€‚ç›®å‰ï¼Œå®ƒæœ€é€‚åˆä¸ªäººæˆ–æ—©æœŸé¡¹ç›®ï¼Œä½ å¯ä»¥ä½¿ç”¨ alpha ç‰ˆæœ¬è¿›è¡Œå¼€å‘ã€‚åœ¨ä½ è‡ªå·±çš„ Compose Multiplatform é¡¹ç›®ä¸­è¯•ç”¨å®ƒï¼Œä½“éªŒå³æ—¶UIåé¦ˆçš„å¥½å¤„ï¼</p>

<p>æˆ‘è¿«ä¸åŠå¾…åœ°æƒ³çœ‹åˆ°å³å°†åˆ°æ¥çš„æ›´æ–°ï¼XD</p>

<h2>å‚è€ƒèµ„æ–™</h2>

<ul>
<li><a href="https://github.com/JetBrains/compose-hot-reload">https://github.com/JetBrains/compose-hot-reload</a></li>
<li><a href="https://blog.sellmair.io/say-hello-to-compose-hot-reload-firework">https://blog.sellmair.io/say-hello-to-compose-hot-reload-firework</a></li>
<li><a href="https://www.youtube.com/watch?v=8Z-Vuo3wTd0">Firework: Introducing Compose Hot Reload</a></li>
<li><a href="https://www.youtube.com/watch?v=I_FMnPaEBEA">How â€˜Hot Reloadâ€™ is implemented for Compose</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å®æˆ˜ï¼šæ¢ç´¢Jetpack Composeä¸­çš„SearchBar]]></title>
    <link href="https://alexhilton.github.io/blog/2025/04/09/searchbar-in-jetpack-compose/"/>
    <updated>2025-04-09T22:40:46+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/04/09/searchbar-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªExploring Jetpack Compose: SearchBarï¼ŒåŸæ–‡é“¾æ¥ï¼š<a href="https://joebirch.co/android/exploring-the-searchbar-composable/">https://joebirch.co/android/exploring-the-searchbar-composable/</a>ï¼Œä½œè€…æ˜¯Joe Birchã€‚</p></blockquote>

<p>åœ¨åº”ç”¨å†…æœç´¢å†…å®¹æ˜¯ä¸€é¡¹å¸¸è§åŠŸèƒ½ï¼Œäº‹å®ä¸Šï¼Œä½ å¯ä»¥åœ¨è®¾å¤‡ä¸Šçš„å¤§å¤šæ•°åº”ç”¨ç¨‹åºä¸­å‘ç°æ­¤åŠŸèƒ½ã€‚åœ¨ Android ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ­¤åŠŸèƒ½çš„å¸¸è§ UI ç»„ä»¶æ˜¯æµ®åŠ¨æœç´¢æ ï¼Œæ”¾ç½®åœ¨å±å¹•çš„æ˜¾çœ¼ä½ç½®ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™è¿˜ä¼šå‘ç”¨æˆ·æä¾›æœç´¢å»ºè®®ï¼Œä»¥ç®€åŒ–æœç´¢è¿‡ç¨‹ã€‚Jetpack Compose Material3 è½¯ä»¶åŒ…æä¾›äº†å¯¹æä¾›æ­¤åŠŸèƒ½çš„ SearchBar å¯ç»„åˆé¡¹çš„è®¿é—®ï¼Œåœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åœ¨æˆ‘ä»¬è‡ªå·±çš„åº”ç”¨ä¸­ä½¿ç”¨å®ƒã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/04/09/searchbar-in-jetpack-compose/"><img src="https://joebirch.co/wp-content/uploads/2025/03/Group.png" title="auto auto" ></a></p>

<!-- more -->


<p>SearchBar å¯ç»„åˆé¡¹å…è®¸æˆ‘ä»¬æ˜¾ç¤ºä¸€ä¸ªæµ®åŠ¨çš„æœç´¢ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å±•å¼€åä¼šæ˜¾ç¤ºå¯é€‰çš„æ¨èã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œè¿™æ˜¯æˆ‘ä»¬åœ¨è®¸å¤šåº”ç”¨ä¸­çœ‹åˆ°çš„å¸¸è§æ¨¡å¼ï¼Œæ­¤å¯ç»„åˆé¡¹æä¾›äº†å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚SearchBar å¯ç»„åˆé¡¹æä¾›äº†è¶³å¤Ÿçš„è‡ªå®šä¹‰åŠŸèƒ½æ¥æ§åˆ¶ç»„ä»¶çš„å¤–è§‚å’Œæ„Ÿè§‰ï¼ŒåŒæ—¶ä½¿ç”¨åŸºäºæ’æ§½(slot)çš„æ–¹æ³•è®©æˆ‘ä»¬æä¾›è¾“å…¥å­—æ®µä»¥ä¾›ä½¿ç”¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">SearchBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">inputField</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">expanded</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onExpandedChange</span><span class="p">:</span> <span class="p">(</span><span class="n">Boolean</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span> <span class="p">=</span> <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">inputFieldShape</span><span class="p">,</span>
</span><span class='line'>    <span class="n">colors</span><span class="p">:</span> <span class="n">SearchBarColors</span> <span class="p">=</span> <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">colors</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">tonalElevation</span><span class="p">:</span> <span class="n">Dp</span> <span class="p">=</span> <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">TonalElevation</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shadowElevation</span><span class="p">:</span> <span class="n">Dp</span> <span class="p">=</span> <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">ShadowElevation</span><span class="p">,</span>
</span><span class='line'>    <span class="n">windowInsets</span><span class="p">:</span> <span class="n">WindowInsets</span> <span class="p">=</span> <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">windowInsets</span><span class="p">,</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="n">ColumnScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥ç»„ä»¶ä¸ºæˆ‘ä»¬å¤„ç†äº†å¤§éƒ¨åˆ†å†…éƒ¨å·¥ä½œâ€”â€”å…¶ä¸­ä¸¤ä¸ªå…³é”®éƒ¨åˆ†éœ€è¦æˆ‘ä»¬è‡ªå·±æä¾›ã€‚</p>

<ul>
<li>inputField â€“ è¿™æ˜¯è¡¨ç¤ºå†…å®¹è¾“å…¥çš„æœç´¢å­—æ®µçš„è¾“å…¥å¯ç»„åˆé¡¹</li>
<li>content â€“ è¿™æ˜¯æœç´¢æ å±•å¼€æ—¶ç”¨äºæ˜¾ç¤ºæ¨èçš„å†…å®¹åŒºåŸŸ</li>
</ul>


<p>é™¤äº†è¿™äº›å­—æ®µä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç»„å…¶ä»–å±æ€§ç”¨äºç¡®å®š SearchBar çš„å½“å‰çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå½“æœç´¢æ å¤„äºå±•å¼€çŠ¶æ€æ—¶ï¼Œå¯ç»„åˆé¡¹çš„å†…å®¹å°†æ˜¾ç¤ºåœ¨è¾“å…¥å­—æ®µä¸‹æ–¹ã€‚ä¸ºäº†èƒ½å¤Ÿç®¡ç†è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºå¯ç»„åˆé¡¹æä¾›ä¸€äº›å‚æ•°ï¼Œç”¨äºç®¡ç†æ­¤çŠ¶æ€ã€‚é¦–å…ˆï¼Œexpanded å‚æ•°ç”¨äºæè¿° SearchBar æ˜¯å¦å¤„äºå±•å¼€çŠ¶æ€ï¼ˆè¿™å°†å†³å®šæ˜¯å¦æ˜¾ç¤ºå†…å®¹åŒºåŸŸï¼‰ï¼Œä»¥åŠ onExpandedChange å‚æ•°ï¼Œç”¨äºä¸ºå®ç°æä¾›å±•å¼€çŠ¶æ€çš„æ›´æ–°å€¼ï¼ˆç„¶åå¯ç”¨äºåæ˜ æˆ‘ä»¬è‡ªå·±çš„çŠ¶æ€å®ç°ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">SearchBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onExpandedChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">expanded</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>é™¤äº†ç®¡ç†è¿™ç§å±•å¼€çŠ¶æ€å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æä¾›ç”¨äº SearchBar è¾“å…¥åŒºåŸŸçš„ inputFieldã€‚é™¤äº†éµå¾ªå¯ç»„åˆé¡¹çš„åŸºäºæ’æ§½çš„æ–¹æ³•ä¹‹å¤–ï¼Œè¿™è¿˜å…è®¸å¯ç»„åˆé¡¹éµå¾ªçŠ¶æ€æå‡çš„æ¦‚å¿µï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿå®Œå…¨ç®¡ç† SearchBar è¾“å…¥å­—æ®µçš„çŠ¶æ€æ¦‚å¿µã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">query</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">SearchBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onExpandedChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">expanded</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">inputField</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†ç®€åŒ–æ­¤æ“ä½œï¼ŒSearchBarDefaults ç±»ä¸ºæˆ‘ä»¬æä¾›äº†å¯¹ InputField å¯ç»„åˆé¡¹çš„è®¿é—® - è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®ä¸“é—¨ä¸º SearchBar å®ç°çš„å¯ç»„åˆé¡¹ã€‚ä¸éœ€è¦ä½¿ç”¨æ­¤ç‰¹å®šå¯ç»„åˆé¡¹ï¼Œä½†å®ƒæ˜¯ä¸“é—¨ä¸ºåŸºäºæœç´¢çš„è¾“å…¥å­—æ®µæä¾›çš„ä¾¿åˆ©å¯ç»„åˆé¡¹ã€‚æ­¤å¯ç»„åˆé¡¹é‡‡ç”¨ä¸€äº›å…³é”®å‚æ•°ï¼Œç”¨äºå°†å…¶é…ç½®ä¸ºåœ¨ SearchBar ä¸­ä½¿ç”¨ï¼š</p>

<ul>
<li>expanded å’Œ onExpandedChange - ç”¨äºç®¡ç†å­—æ®µçš„å±•å¼€çŠ¶æ€</li>
<li>query å’Œ onQueryChange - ç”¨äºç®¡ç†å­—æ®µä¸­æ˜¾ç¤ºçš„æŸ¥è¯¢çš„çŠ¶æ€</li>
</ul>


<p>é™¤äº†è¿™äº›æ ¸å¿ƒå±æ€§å¤–ï¼Œä½ è¿˜ä¼šæ³¨æ„åˆ°å¯¹æ ‡å‡†å­—æ®µå‚æ•°ï¼ˆå¦‚å ä½ç¬¦ã€leadingIcon å’Œ trailingIconï¼‰çš„æ”¯æŒã€‚é™¤äº†ç”¨äºæä¾›ä¿¡æ¯ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°æˆ‘å¦‚ä½•ä½¿ç”¨ trailingIcon å…è®¸ SearchBar åœ¨å•å‡»å–æ¶ˆæŒ‰é’®æ—¶æ¢å¤åˆ°æŠ˜å çŠ¶æ€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">InputField</span><span class="p">(</span>
</span><span class='line'>    <span class="n">onSearch</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span>
</span><span class='line'>    <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onExpandedChange</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="n">it</span> <span class="p">},</span>
</span><span class='line'>    <span class="n">placeholder</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;What are you looking for?&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>    <span class="n">leadingIcon</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Search</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>    <span class="n">trailingIcon</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">expanded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">IconButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>            <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Close</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">query</span> <span class="p">=</span> <span class="n">query</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onQueryChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">query</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åå¯ä»¥å°†æ­¤ InputField å¯ç»„åˆé¡¹çš„å®ç°æ’å…¥åˆ° SearchBar å¯ç»„åˆé¡¹çš„ inputField å‚æ•°ä¸­ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">query</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">SearchBar</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onExpandedChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">expanded</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="n">inputField</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SearchBarDefaults</span><span class="p">.</span><span class="n">InputField</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSearch</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onExpandedChange</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="n">it</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">placeholder</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;What are you looking for?&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">leadingIcon</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Search</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">trailingIcon</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">expanded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">IconButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>                    <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Close</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">query</span> <span class="p">=</span> <span class="n">query</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onQueryChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">query</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿç»„åˆ SearchBar å¹¶çœ‹åˆ°åœ¨æˆ‘ä»¬çš„ UI ä¸­æ˜¾ç¤ºçš„æµ®åŠ¨ç»„ä»¶ã€‚</p>

<p><img src="https://joebirch.co/wp-content/uploads/2025/03/sea.png" alt="SearchBar" /></p>

<p>æ­¤æ—¶æˆ‘ä»¬å‰©ä¸‹è¦å®ç°çš„å°±æ˜¯ SearchBar çš„å†…å®¹ï¼Œè¿™æ˜¯ SearchBar å¤„äºå±•å¼€çŠ¶æ€æ—¶æ˜¾ç¤ºçš„å†…å®¹ã€‚æ­¤å‚æ•°åˆ©ç”¨äº† ColumnScopeï¼Œå› æ­¤æ­¤å¤„æä¾›çš„ä»»ä½•å¯ç»„åˆé¡¹éƒ½å°†å‚ç›´å †å ã€‚æ­¤å†…å®¹åŒºåŸŸçš„é¢„æœŸå½¢å¼æ˜¯ç”¨æˆ·å¯ä»¥é€‰æ‹©çš„æ¨èåˆ—è¡¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ç»§ç»­ç¼–å†™å‡ ä¸ª ListItem å¯ç»„åˆé¡¹ï¼Œæ¯ä¸ªå¯ç»„åˆé¡¹éƒ½ç”¨äºå‘ç”¨æˆ·æ˜¾ç¤ºæœç´¢æ¨èã€‚å½“ç‚¹å‡»å…¶ä¸­ä»»ä½•ä¸€é¡¹æ—¶ï¼ŒæŸ¥è¯¢å°†æ›´æ–°ä¸ºé€‰å®šå€¼ï¼Œå¹¶ä¸” SearchBar çš„å±•å¼€çŠ¶æ€å°†é‡ç½®ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">query</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">SearchBar</span><span class="p">(</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;Result 1&quot;</span><span class="p">,</span> <span class="s">&quot;Result 2&quot;</span><span class="p">,</span> <span class="s">&quot;Result 3&quot;</span><span class="p">,</span> <span class="s">&quot;Result 4&quot;</span><span class="p">).</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">text</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">ListItem</span><span class="p">(</span>
</span><span class='line'>            <span class="n">headlineContent</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">colors</span> <span class="p">=</span> <span class="n">ListItemDefaults</span><span class="p">.</span><span class="n">colors</span><span class="p">(</span><span class="n">containerColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Transparent</span><span class="p">),</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">query</span> <span class="p">=</span> <span class="n">text</span>
</span><span class='line'>                <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>            <span class="p">}.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ‰äº†æ­¤åŠŸèƒ½ï¼Œæˆ‘ä»¬ç°åœ¨å°±èƒ½å¤Ÿçœ‹åˆ°åœ¨æµ®åŠ¨æœç´¢æ ä¸‹æ–¹æ˜¾ç¤ºçš„æ¨èã€‚</p>

<p><img src="https://joebirch.co/wp-content/uploads/2025/03/recs.png" alt="Recommendations" /></p>

<p>æœ‰äº†ä¸Šè¿°å†…å®¹ï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸€ä¸ªæµ®åŠ¨æœç´¢æ ï¼Œå‘ç”¨æˆ·æ˜¾ç¤ºæœç´¢å»ºè®®ã€‚ä½¿ç”¨ Material3 SearchBar å¯ç»„åˆé¡¹ï¼Œå®ç°åœ¨è¿™ä¸¤ç§ä¸åŒçŠ¶æ€ä¹‹é—´è½¬æ¢çš„å¯ç»„åˆé¡¹éå¸¸å®¹æ˜“ã€‚ä¹Ÿè®¸ä½ å·²ç»åœ¨åº”ç”¨ä¸­ä½¿ç”¨äº† SearchBarï¼Œæˆ–è€…ä¸€ç›´åœ¨å¯»æ‰¾ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ— è®ºå¦‚ä½•ï¼Œæˆ‘æœŸå¾…çœ‹åˆ°æ›´å¤šåº”ç”¨é€šè¿‡ Jetpack Compose ä¸­æ›´å¹¿æ³›çš„ç»„ä»¶æ”¯æŒæ¥èŠ‚çœæ—¶é—´ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å®æˆ˜ï¼šåœ¨Composeä¸­ä¼˜é›…åœ°å®ç°æç¤º]]></title>
    <link href="https://alexhilton.github.io/blog/2025/03/28/hints-in-compose/"/>
    <updated>2025-03-28T22:05:00+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/03/28/hints-in-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ª<a href="https://proandroiddev.com/hints-in-compose-10b6470acc58">Hints in Compose</a>ï¼ŒåŸæ–‡ç”±<a href="https://medium.com/@vitoksmile">Viktor Mykhailiv</a>å‘å¸ƒäº2025å¹´2æœˆ13æ—¥ï¼Œæ–‡ç« å†…å®¹å·¨è¯¦ç»†ï¼ŒTL;DR;ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/03/28/hints-in-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jBirMqQV-aXKXw5gekEkQ.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>æœ‰æ—¶æˆ‘ä»¬çš„åº”ç”¨éœ€è¦çªå‡ºæ˜¾ç¤ºæŸäº› UI ç»„ä»¶ï¼Œä¾‹å¦‚åœ¨é¦–æ¬¡ç™»å½•ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰æ—¶ï¼Œæˆ–è€…å½“æˆ‘ä»¬æ·»åŠ æ–°å†…å®¹ï¼ˆâ€œæ–°åŠŸèƒ½â€ï¼‰æ—¶ã€‚</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æŒ‡å¯¼å¦‚ä½•æ„å»ºè‡ªå®šä¹‰è§£å†³æ–¹æ¡ˆæ¥æ˜¾ç¤ºæç¤º/å·¥å…·æç¤ºï¼ŒæŒ‡å‘ Composeï¼ˆCompose Multiplatform å’Œ Jetpack Composeï¼‰ä¸­çš„ç‰¹å®š UI å…ƒç´ ã€‚</p>

<h2>å¸ƒå±€å±‚æ¬¡</h2>

<p>è¦çªå‡ºæ˜¾ç¤º UI å…ƒç´ ï¼Œé¦–å…ˆæˆ‘ä»¬åº”è¯¥äº†è§£â€œæç¤ºâ€(Hints)çš„ä¸»è¦æ¦‚å¿µã€‚
å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå¸¦æœ‰ TopBarã€BottomNavigation å’Œä¸»è¦æ“ä½œæŒ‰é’®çš„åº”ç”¨ç¨‹åºã€‚æˆ‘ä»¬æƒ³è¦çªå‡ºæ˜¾ç¤º TopBar çš„æ“ä½œã€ä¸»è¦æŒ‰é’®å’Œ BottomNavigation ä¸­çš„ä¸€ä¸ªé¡¹ç›®ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7K0zoXqZM0ajYYZARn6I5w.png" alt="Layout hierarchy" /></p>

<p>å¯¹äºæˆ‘ä»¬çš„â€œæç¤ºâ€ï¼Œæˆ‘ä»¬éœ€è¦ç»˜åˆ¶ä¸€ä¸ªæš—æ·¡çš„èƒŒæ™¯ï¼ˆä¹Ÿæ˜¯ä¸ºäº†æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼‰ï¼Œè®¡ç®—çªå‡ºæ˜¾ç¤ºçš„ UI å…ƒç´ çš„ä½ç½®ï¼Œå‰ªæ‰ï¼ˆå±è”½ï¼‰æˆ‘ä»¬çš„å…ƒç´ å½¢çŠ¶ä»¥å…å˜æš—ï¼Œæœ€åç»˜åˆ¶ä¸€ä¸ªæç¤ºï¼ˆä¾‹å¦‚å¸¦æœ‰èƒŒæ™¯çš„æ–‡æœ¬ï¼‰ã€‚</p>

<h2>1. æš—æ·¡çš„èƒŒæ™¯</h2>

<p>è¦åœ¨æ‰€æœ‰å†…å®¹ä¹‹ä¸Šç»˜åˆ¶ä¸€ä¸ªæš—æ·¡çš„èƒŒæ™¯ä½œä¸ºè¦†ç›–æˆ–å¼¹å‡ºçª—å£ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p>

<h3>a. ä½¿ç”¨è‡ªå®šä¹‰å¯ç»„åˆé¡¹åŒ…è£…æˆ‘ä»¬åº”ç”¨ï¼ˆæ ¹ç»„ä»¶ï¼‰çš„æ‰€æœ‰å†…å®¹ï¼ˆä¾‹å¦‚å¸¦æœ‰ Modifier.background çš„ Boxï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AppContent</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">HintOverlay</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">MaterialTheme</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">Scaffold</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// æˆ‘çš„åº”ç”¨å†…å®¹</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>b. ä½¿ç”¨å¯¹è¯æ¡†</h3>

<p>é€šè¿‡ä½¿ç”¨å¯¹è¯æ¡†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ‰€æœ‰å†…å®¹ä¹‹ä¸Šæ˜¾ç¤ºä¸€ä¸ªè¦†ç›–å±‚ï¼ˆä¾‹å¦‚ï¼Œåœ¨ Android ä¸Šï¼Œå¯¹è¯æ¡†æ˜¾ç¤ºåœ¨è‡ªå·±çš„çª—å£ä¸­ï¼‰ã€‚
ä½¿ç”¨å¯¹è¯æ¡†æ—¶ï¼ŒCompose Multiplatform ä¸­çš„ scrimColor ä¼šå‡ºç°é—®é¢˜ã€‚æˆ‘ä»¬æ— æ³•ä» Compose é€šç”¨ç›®æ ‡é…ç½® scrimColor ï¼Œä½†æ¯ä¸ªç›®æ ‡ï¼ˆAndroid é™¤å¤–ï¼‰éƒ½ä¸º scrimColor æä¾›äº†ä¸€ä¸ªå®é™…å€¼ã€‚ä½œä¸ºä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªä¾‹å¤–ç±»æ¥æä¾›å¯¹è¯æ¡†å±æ€§å¹¶ä¸ºæ¯ä¸ªç›®æ ‡æä¾›å®é™…å®ç°ã€‚</p>

<h3>c. ä½¿ç”¨ Popup</h3>

<p>Popup åœ¨è¿™é‡Œçœ‹èµ·æ¥æ›´å¥½ï¼Œå› ä¸ºå®ƒé»˜è®¤ä¸ç»˜åˆ¶ scrimColorï¼Œå¹¶ä¸”è¦†ç›–å±‚æ˜¾ç¤ºåœ¨æ‰€æœ‰å†…å®¹ä¹‹ä¸Šã€‚</p>

<p>æˆ‘ä¼šé‡‡ç”¨ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œä¸å¼ºåˆ¶æ‰‹åŠ¨ä½¿ç”¨ HintOverlayã€‚</p>

<p>æˆ‘è¿˜æƒ³ä¸ºè¦†ç›–å±‚èƒŒæ™¯æ·»åŠ  Brush æ”¯æŒï¼Œè€Œä¸ä»…ä»…æ˜¯ Color ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">LocalHintOverlayColor</span> <span class="p">=</span> <span class="n">staticCompositionLocalOf</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">x44000000</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">LocalHintOverlayBrush</span> <span class="p">=</span> <span class="n">staticCompositionLocalOf</span><span class="p">&lt;</span><span class="n">Brush</span><span class="p">?&gt;</span> <span class="p">{</span> <span class="k">null</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HintOverlay</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Popup</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">overlayBackground</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">),</span>
</span><span class='line'>                <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Draw hints here&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * ä» [LocalHintOverlayBrush] æˆ– [LocalHintOverlayColor] è®¾ç½® `background`ã€‚</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">overlayBackground</span><span class="p">():</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">composed</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LocalHintOverlayBrush</span><span class="p">.</span><span class="n">current</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">background</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="o">?:</span> <span class="n">background</span><span class="p">(</span><span class="n">LocalHintOverlayColor</span><span class="p">.</span><span class="n">current</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘å¯ä»¥ä½¿ç”¨CompositionLocalProvider è®¾ç½® Brush æ¥è¦†ç›–è¦†ç›–çš„èƒŒæ™¯ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">CompositionLocalProvider</span><span class="p">(</span>
</span><span class='line'>    <span class="n">LocalHintOverlayBrush</span> <span class="n">provides</span> <span class="n">Brush</span><span class="p">.</span><span class="n">linearGradient</span><span class="p">(</span>
</span><span class='line'>        <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.5f</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">HintOverlay</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KrHuSNZT0zE-Eddz1GBA2A.png" alt="Dimmed background" /></p>

<h2>2. è®¡ç®—é”šç‚¹åæ ‡</h2>

<p>è¦è·å– Compose ä¸­ UI å…ƒç´ çš„åæ ‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨OnGloballyPositionedModifier ï¼Œå½“å†…å®¹çš„å…¨å±€ä½ç½®å¯èƒ½å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šä½¿ç”¨å¸ƒå±€çš„æœ€ç»ˆâ€‹â€‹ LayoutCoordinates è°ƒç”¨è¯¥æ–¹æ³•ã€‚</p>

<p>ä½¿ç”¨ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">Column</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Modifier</span><span class="p">.</span><span class="n">onGloballyPositioned</span> <span class="p">{</span> <span class="n">coordinates</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// è¿™å°†æ˜¯Columnçš„å¤§å°ã€‚</span>
</span><span class='line'>        <span class="n">coordinates</span><span class="p">.</span><span class="n">size</span>
</span><span class='line'>        <span class="c1">// Columnç›¸å¯¹äºåº”ç”¨ç¨‹åºçª—å£çš„ä½ç½®ã€‚</span>
</span><span class='line'>        <span class="n">coordinates</span><span class="p">.</span><span class="n">positionInWindow</span><span class="p">()</span>
</span><span class='line'>        <span class="c1">// Columnç›¸å¯¹äº Compose æ ¹çš„ä½ç½®ã€‚</span>
</span><span class='line'>        <span class="n">coordinates</span><span class="p">.</span><span class="n">positionInRoot</span><span class="p">()</span>
</span><span class='line'>        <span class="c1">// è¿™äº›å°†æ˜¯æä¾›ç»™å¸ƒå±€çš„å¯¹é½çº¿ï¼ˆæ­¤å¤„çš„Columnä¸ºç©ºï¼‰ã€‚</span>
</span><span class='line'>        <span class="n">coordinates</span><span class="p">.</span><span class="n">providedAlignmentLines</span>
</span><span class='line'>        <span class="c1">// è¿™å°†æ˜¯ä¸ Column çš„çˆ¶çº§ç›¸å¯¹åº”çš„ LayoutCoordinates å®ä¾‹ã€‚</span>
</span><span class='line'>        <span class="n">coordinates</span><span class="p">.</span><span class="n">parentLayoutCoordinates</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">))</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¯¹äºæˆ‘ä»¬çš„æç¤ºï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªçŠ¶æ€æ¥ä¿å­˜é”šç‚¹çš„åæ ‡å’Œå¤§å°ï¼Œå¹¶å¼•å…¥ä¸€ä¸ªä¿®æ”¹å™¨æ¥æ›´æ–°çŠ¶æ€ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintAnchorState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">size</span><span class="p">:</span> <span class="n">IntSize</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">offset</span><span class="p">:</span> <span class="n">Offset</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintAnchorState</span><span class="p">():</span> <span class="n">HintAnchorState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">HintAnchorState</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">):</span> <span class="n">Modifier</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">size</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">offset</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInWindow</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å› æ­¤ï¼Œæˆ‘ä»¬åªéœ€è®¢é˜…æ‰€éœ€ UI å…ƒç´ çš„å¤§å°å’Œåæ ‡å˜åŒ–å³å¯æ›´æ–°é”šç‚¹çš„çŠ¶æ€ã€‚
ç°åœ¨æˆ‘ä»¬éœ€è¦å°†æ­¤ hintAnchor ä¿®é¥°ç¬¦åº”ç”¨äºæˆ‘ä»¬çš„å†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">topAppBarActionHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">()</span>
</span><span class='line'><span class="k">val</span> <span class="py">actionHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">()</span>
</span><span class='line'><span class="k">val</span> <span class="py">bottomNavigationHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">topAppBarActionHintAnchor</span><span class="p">),</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Button</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">actionHintAnchor</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Action&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">BottomNavigationItem</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">topAppBarActionHintAnchor</span><span class="p">),</span>
</span><span class='line'>    <span class="c1">//... ä¼ å…¥å…¶ä»–éœ€è¦çš„å‚æ•°</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>æ³¨æ„ï¼š</strong> ä¿®é¥°ç¬¦é¡ºåºåœ¨ Compose ä¸­å§‹ç»ˆå¾ˆé‡è¦ï¼Œæˆ‘ä»¬åœ¨ hintAnchor åè®¾ç½® 4.dpï¼Œä»¥ä¾¿åœ¨æ­¤æŒ‰é’®å‘¨å›´ç•™å‡ºé¢å¤–ç©ºé—´ï¼ˆé”šç‚¹çš„å°ºå¯¸å°†æ¯”å®é™…æŒ‰é’®çš„å°ºå¯¸å¤§ 4.dpï¼‰ã€‚</p></blockquote>

<p>HintOverlay å¯ç»„åˆé¡¹éœ€è¦è¿›è¡Œä¸€äº›æ›´æ”¹æ‰èƒ½ä½¿ç”¨ HintAnchorStateä¸ºæ­¤é”šç‚¹ç»˜åˆ¶æç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HintOverlay</span><span class="p">(</span>
</span><span class='line'>    <span class="n">anchors</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * ä» [LocalHintOverlayBrush] æˆ– [LocalHintOverlayColor] è®¾ç½®â€œbackgroundâ€ã€‚</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span>
</span><span class='line'>    <span class="n">anchors</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">):</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">composed</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">backgroundBrush</span> <span class="p">=</span> <span class="n">LocalHintOverlayBrush</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">backgroundColor</span> <span class="p">=</span> <span class="n">LocalHintOverlayColor</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">drawWithCache</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onDrawWithContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">backgroundBrush</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">drawRect</span><span class="p">(</span><span class="n">backgroundBrush</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">drawRect</span><span class="p">(</span><span class="n">backgroundColor</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">anchors</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">anchor</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">topLeft</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">size</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">toSize</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">style</span> <span class="p">=</span> <span class="n">Stroke</span><span class="p">(</span><span class="n">width</span> <span class="p">=</span> <span class="m">5f</span><span class="p">),</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">drawContent</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬åªéœ€åœ¨é”šç‚¹å‘¨å›´ç”»ä¸€ä¸ªçº¢è‰²çŸ©å½¢ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EqvV4AHsimwvwZxajIgtXg.png" alt="Anchors" /></p>

<p>ä½†å¦‚æœæˆ‘ä»¬åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šè¿è¡Œï¼Œæˆ‘ä»¬ä¼šåœ¨ Android ä¸Šå¾—åˆ°é”™è¯¯çš„æ•°å­—ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2wennrPOIcKArOK4MuayAQ.png" alt="With Window Insets" /></p>

<p>è¯¥é—®é¢˜ä¸ WindowInsets æœ‰å…³ã€‚è®©æˆ‘ä»¬å‡å»è¿™äº› insets æ¥ä¿®å¤å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">):</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">composed</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">statusBarInsets</span> <span class="p">=</span> <span class="n">WindowInsets</span><span class="p">.</span><span class="n">statusBars</span><span class="p">.</span><span class="n">getTop</span><span class="p">(</span><span class="n">LocalDensity</span><span class="p">.</span><span class="n">current</span><span class="p">).</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">size</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span>
</span><span class='line'>        <span class="n">state</span><span class="p">.</span><span class="n">offset</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInWindow</span><span class="p">()</span>
</span><span class='line'>            <span class="c1">// ä¿®å¤ Android ä¸Šçš„ WindowInsets</span>
</span><span class='line'>            <span class="p">.</span><span class="n">minus</span><span class="p">(</span><span class="n">Offset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">statusBarInsets</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LlrCLPAEgpk7q--X7i3UsA.png" alt="Fixed window insets" /></p>

<h2>3. å‰ªè¾‘å‡ºé”šç‚¹çš„å½¢çŠ¶</h2>

<p>è¦å‰ªè¾‘å½¢çŠ¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ Path å’Œ PathOperation ã€‚ä¿®æ”¹ hintAnchor Modifier ä»¥æ¥å— Shape ï¼Œå®ƒå°†ç”¨äºåœ¨é”šç‚¹å‘¨å›´è®¾ç½®æ‰€éœ€çš„å½¢çŠ¶ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">state</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span><span class="p">:</span> <span class="n">Shape</span> <span class="p">=</span> <span class="n">RectangleShape</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">Modifier</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">state</span><span class="p">.</span><span class="n">shape</span> <span class="p">=</span> <span class="n">shape</span>
</span><span class='line'>    <span class="c1">//..onGloballyPositioned</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintAnchorState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//...å…¶ä»–çš„çŠ¶æ€æ”¾è¿™é‡Œ</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">shape</span><span class="p">:</span> <span class="n">Shape</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">RectangleShape</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ ¹æ®æä¾›çš„å½¢çŠ¶ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªè½®å»“ï¼Œç”¨äºå°†é”šç‚¹çš„å½¢çŠ¶ä»èƒŒæ™¯ä¸­å‰ªæ‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">Modifier</span><span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span>
</span><span class='line'>    <span class="n">anchors</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">):</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">composed</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">backgroundBrush</span> <span class="p">=</span> <span class="n">LocalHintOverlayBrush</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">backgroundColor</span> <span class="p">=</span> <span class="n">LocalHintOverlayColor</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">layoutDirection</span> <span class="p">=</span> <span class="n">LocalLayoutDirection</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">density</span> <span class="p">=</span> <span class="n">LocalDensity</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">drawWithCache</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// å‡†å¤‡èƒŒæ™¯è·¯å¾„</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">path</span> <span class="p">=</span> <span class="n">Path</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">lineTo</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>            <span class="n">lineTo</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>            <span class="n">lineTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>            <span class="n">lineTo</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>            <span class="n">close</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">anchors</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">anchor</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// ä¸ºé”šç‚¹å‡†å¤‡è·¯å¾„</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">anchorPath</span> <span class="p">=</span> <span class="n">Path</span><span class="p">()</span>
</span><span class='line'>            <span class="n">anchorPath</span><span class="p">.</span><span class="n">addOutline</span><span class="p">(</span>
</span><span class='line'>                <span class="n">anchor</span><span class="p">.</span><span class="n">shape</span><span class="p">.</span><span class="n">createOutline</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">size</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">toSize</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">layoutDirection</span> <span class="p">=</span> <span class="n">layoutDirection</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">density</span> <span class="p">=</span> <span class="n">density</span><span class="p">,</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">anchorPath</span><span class="p">.</span><span class="n">translate</span><span class="p">(</span><span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">)</span>
</span><span class='line'>            <span class="n">anchorPath</span><span class="p">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// è£å‰ªæ‰é”šç‚¹</span>
</span><span class='line'>            <span class="n">path</span><span class="p">.</span><span class="n">op</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">anchorPath</span><span class="p">,</span> <span class="n">PathOperation</span><span class="p">.</span><span class="n">Xor</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">onDrawWithContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// æˆ‘ä»¬ä¸ä»…ä»…ç»˜åˆ¶è·¯å¾„ï¼Œè€Œä¸æ˜¯åƒä»¥å‰ä¸€æ ·ç»˜åˆ¶çŸ©å½¢</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">backgroundBrush</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">drawPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">backgroundBrush</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">drawPath</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">backgroundColor</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">drawContent</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è®©æˆ‘ä»¬ä¼ é€’ CircleShape å’Œ RoundedCornerShape æ¥çœ‹çœ‹æç¤ºç°åœ¨æ˜¯ä»€ä¹ˆæ ·å­ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i2dWMv3Wa9at-fzGiKm8KQ.png" alt="Clip" /></p>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚ä½•ç»˜åˆ¶èƒŒæ™¯è¦†ç›–å±‚ã€è®¡ç®—é”šç‚¹çš„ä½ç½®ä»¥åŠå¦‚ä½•å‰ªè£èƒŒæ™¯ã€‚</p>

<h2>4. ç»˜åˆ¶æç¤º</h2>

<p>åœ¨å®é™…ç»˜åˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥å®šä¹‰æç¤ºéœ€è¦å‘ˆç°å“ªäº›ä¿¡æ¯ã€‚</p>

<p>ä¸ºäº†ä¸å¼ºåˆ¶åªæä¾›æ–‡æœ¬ï¼Œæˆ‘ä»¬é‡‡ç”¨slotæ–¹æ³•ã€‚é€šè¿‡å®šä¹‰slotï¼Œæˆ‘ä»¬å…è®¸ä½¿ç”¨ä»»ä½•æ‰€éœ€çš„composablesã€‚</p>

<p>æˆ‘å°†ä»‹ç»ä¸€ä¸ªæ–°çš„ç±» Hint æ¥ä¿å­˜æˆ‘ä»¬çš„Composableå†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Hint</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">({})</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHint</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">Hint</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Hint</span><span class="p">().</span><span class="n">also</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">content</span> <span class="p">=</span> <span class="n">content</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶å°†æ­¤ Hint æ·»åŠ ä¸º HintAnchorState çš„ä¸€éƒ¨åˆ†ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintAnchorState</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">hint</span><span class="p">:</span> <span class="n">Hint</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//...å…¶ä»–çš„çŠ¶æ€æ”¾è¿™é‡Œ</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintAnchorState</span><span class="p">(</span><span class="n">hint</span><span class="p">:</span> <span class="n">Hint</span><span class="p">):</span> <span class="n">HintAnchorState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">remember</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">HintAnchorState</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ HintOverlay å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨æœ€ç®€å•çš„è§£å†³æ–¹æ¡ˆ â€” BoxWithConstraints ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HintOverlay</span><span class="p">(</span>
</span><span class='line'>    <span class="n">anchors</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">//...</span>
</span><span class='line'>    <span class="n">BoxWithConstraints</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span><span class="n">anchors</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">anchors</span><span class="p">().</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">anchor</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">translationX</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span>
</span><span class='line'>                        <span class="n">translationY</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">anchor</span><span class="p">.</span><span class="n">hint</span><span class="p">.</span><span class="n">content</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¿®æ”¹åº”ç”¨ç¨‹åºå†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">topAppBarHint</span> <span class="p">=</span> <span class="n">rememberHint</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">OutlinedButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{})</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hint for TopAppBar&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">topAppBarActionHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">(</span><span class="n">topAppBarHint</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">actionHint</span> <span class="p">=</span> <span class="n">rememberHint</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hint for Action&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">actionHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">(</span><span class="n">actionHint</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">bottomNavigationHint</span> <span class="p">=</span> <span class="n">rememberHint</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>        <span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Magenta</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hint for BottomNavigation&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">bottomNavigationHintAnchor</span> <span class="p">=</span> <span class="n">rememberHintAnchorState</span><span class="p">(</span><span class="n">bottomNavigationHint</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»“æœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mMenE2fp2jph6YUBlxX4pA.png" alt="Hint for action" /></p>

<p>è®©æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªåº”ç”¨ç¨‹åºç‰¹å®šçš„ä»£ç æ¥ç»˜åˆ¶æç¤ºèƒŒæ™¯ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintContainer</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">Hint</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">rememberHint</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Yellow</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">CompositionLocalProvider</span><span class="p">(</span>
</span><span class='line'>                <span class="n">LocalTextStyle</span> <span class="n">provides</span> <span class="n">TextStyle</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">fontSize</span> <span class="p">=</span> <span class="m">12.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Light</span><span class="p">,</span>
</span><span class='line'>                <span class="p">),</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">content</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xn8pxlU_nUQvywbtqVwUtw.png" alt="Hint2" /></p>

<p>æˆ‘ä»¬é‡åˆ°äº† 2 ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>æ°´å¹³å¯¹é½ï¼Œæç¤ºåº”ä¸å…¶é”šç‚¹å±…ä¸­å¯¹é½ã€‚</li>
<li>BottomNavigation çš„æç¤ºè¶…å‡ºäº†å±å¹•èŒƒå›´ã€‚</li>
</ol>


<p>è®©æˆ‘ä»¬æ”¹ç”¨è‡ªå®šä¹‰å¸ƒå±€å¹¶ä¿®å¤è¿™äº›é—®é¢˜ã€‚</p>

<p>è¦æµ‹é‡å’Œå¸ƒå±€å¤šä¸ªå¯ç»„åˆé¡¹ï¼Œè¯·ä½¿ç”¨ Layoutã€‚æ­¤composableå…è®¸æˆ‘ä»¬æ‰‹åŠ¨æµ‹é‡å’Œå¸ƒå±€å­é¡¹ã€‚æ‰€æœ‰æ›´é«˜çº§åˆ«çš„å¸ƒå±€ï¼ˆå¦‚ Column å’Œ Rowï¼‰éƒ½æ˜¯ä½¿ç”¨ Layout å®ç°çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">HintsContainer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">anchors</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">anchors</span> <span class="p">=</span> <span class="n">anchors</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Layout</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span><span class="n">anchors</span><span class="p">),</span>
</span><span class='line'>        <span class="n">content</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">anchors</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">hint</span><span class="p">.</span><span class="n">content</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span> <span class="n">measurables</span><span class="p">,</span> <span class="n">constraints</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// æµ‹é‡æ¯ä¸€ä¸ªæç¤º</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">placeables</span> <span class="p">=</span> <span class="n">measurables</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">measurable</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">measurable</span><span class="p">.</span><span class="n">measure</span><span class="p">(</span>
</span><span class='line'>                <span class="n">constraints</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">minWidth</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">minHeight</span> <span class="p">=</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// å°†å¸ƒå±€å°ºå¯¸è®¾ç½®å¾—å°½å¯èƒ½å¤§</span>
</span><span class='line'>        <span class="n">layout</span><span class="p">(</span><span class="n">constraints</span><span class="p">.</span><span class="n">maxWidth</span><span class="p">,</span> <span class="n">constraints</span><span class="p">.</span><span class="n">maxHeight</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// å°†æ¯ä¸ªæç¤ºç›¸å¯¹äºå…¶é”šç‚¹æ”¾ç½®</span>
</span><span class='line'>            <span class="n">placeables</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">placeable</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">anchor</span> <span class="p">=</span> <span class="n">anchors</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// å°†æ­¤æç¤ºå±…ä¸­å¯¹é½</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">x</span> <span class="p">=</span> <span class="p">(</span><span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">toInt</span><span class="p">()</span> <span class="p">-</span> <span class="p">(</span><span class="n">placeable</span><span class="p">.</span><span class="n">width</span> <span class="p">-</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="p">/</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>                    <span class="c1">// ä¿®å¤è¶…å‡ºå±å¹•çš„åæ ‡</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">coerceAtLeast</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">coerceAtMost</span><span class="p">(</span><span class="n">constraints</span><span class="p">.</span><span class="n">maxWidth</span> <span class="p">-</span> <span class="n">placeable</span><span class="p">.</span><span class="n">width</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// æŠŠè¿™ä¸ªæç¤ºæ”¾åœ¨å®ƒçš„é”šç‚¹ä¸‹é¢</span>
</span><span class='line'>                <span class="k">var</span> <span class="py">y</span> <span class="p">=</span> <span class="p">(</span><span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">toInt</span><span class="p">()</span> <span class="p">+</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>                    <span class="c1">// å¦‚æœè¶…å‡ºå±å¹•ï¼Œåˆ™ä¿®å¤ y åæ ‡</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">coerceAtMost</span><span class="p">(</span><span class="n">constraints</span><span class="p">.</span><span class="n">maxHeight</span> <span class="p">-</span> <span class="n">placeable</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="p">&lt;</span> <span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span> <span class="p">+</span> <span class="n">anchor</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// æç¤ºä¸é”šç‚¹é‡å ï¼Œè¯·å°†æ­¤æç¤ºæ”¾åœ¨å…¶é”šç‚¹ä¸Šæ–¹</span>
</span><span class='line'>                    <span class="n">y</span> <span class="p">=</span> <span class="n">anchor</span><span class="p">.</span><span class="n">offset</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="n">toInt</span><span class="p">()</span> <span class="p">-</span> <span class="n">placeable</span><span class="p">.</span><span class="n">height</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">placeable</span><span class="p">.</span><span class="n">placeRelative</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="p">=</span> <span class="n">y</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*syuJkuAd-_BgiYfFP8bKgQ.png" alt="Hint3" /></p>

<p>å› ä¸ºæˆ‘ä»¬å…è®¸ä¼ é€’ä»»ä½•å¯ç»„åˆé¡¹ä½œä¸ºæç¤ºï¼Œæ‰€ä»¥è°ƒç”¨è€…å¯ä»¥å®Œå…¨æ§åˆ¶æç¤ºçš„å¤–è§‚ï¼Œä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥åªä½¿ç”¨ Text ï¼Œæˆ–è€…ä½¿ç”¨åŒ…å«è®¸å¤šå­é¡¹çš„å¤æ‚ Row ã€‚</p>

<h2>5. å¦‚ä½•æ§åˆ¶æç¤ºï¼Ÿ</h2>

<p>æˆ‘ä»¬é™æ€åœ°æ·»åŠ äº†æç¤ºä»¥å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ä½†çœŸæ­£äº§å“åº”ç”¨ç¨‹åºå¹¶éå¦‚æ­¤ã€‚è®©æˆ‘ä»¬å¼•å…¥ HintController æ¥æ§åˆ¶ä½•æ—¶æ˜¾ç¤ºæç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintController</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">hint</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">show</span><span class="p">(</span><span class="n">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">hint</span> <span class="p">=</span> <span class="n">hint</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintController</span><span class="p">():</span> <span class="n">HintController</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">controller</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">HintController</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="p">.</span><span class="n">hint</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">hint</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">HintOverlay</span><span class="p">(</span><span class="n">anchor</span> <span class="p">=</span> <span class="n">hint</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">controller</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¿®æ”¹åº”ç”¨ç¨‹åºå†…å®¹ï¼Œä»¥ä¾¿åœ¨æˆ‘ä»¬ç‚¹å‡»é”šç‚¹æ—¶æ˜¾ç¤ºæç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">hintController</span> <span class="p">=</span> <span class="n">rememberHintController</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">topAppBarActionHintAnchor</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">),</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">topAppBarActionHintAnchor</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">BottomNavigationItem</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span>
</span><span class='line'>            <span class="n">bottomNavigationHintAnchor</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">50f</span><span class="p">),</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">bottomNavigationHintAnchor</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Button</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">hintAnchor</span><span class="p">(</span><span class="n">actionHintAnchor</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">actionHintAnchor</span><span class="p">)</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>æ³¨æ„ï¼šæˆ‘ä»¬ä¸å†éœ€è¦æ˜¾ç¤ºçš„ HintOverlay ï¼Œå®ƒç°åœ¨å˜å¾—å†…ç½®äº†ã€‚</p></blockquote>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jIOTXOSnHVeL_jjyEx1gdg.png" alt="Control" /></p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥é€ä¸€æ˜¾ç¤ºæç¤ºï¼Œä½†è¿˜æœ‰ä¸¤ä¸ªéƒ¨åˆ†ç¼ºå¤±ï¼šå¦‚ä½•å…³é—­æç¤ºï¼Œä»¥åŠå¦‚ä½•è¦†ç›–è¦†ç›–é¢œè‰²ã€‚</p>

<p>å¯¹æç¤ºæ§åˆ¶å™¨è¿›è¡Œæ›´æ”¹ä»¥å…è®¸ä¼ é€’è¦†ç›–é¢œè‰²ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintController</span><span class="p">(</span><span class="n">overlay</span><span class="p">:</span> <span class="n">Brush</span><span class="p">):</span> <span class="n">HintController</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">rememberHintController</span><span class="p">(</span><span class="n">overlay</span> <span class="p">=</span> <span class="n">LocalHintOverlayBrush</span> <span class="n">provides</span> <span class="n">overlay</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberHintController</span><span class="p">(</span><span class="n">overlay</span><span class="p">:</span> <span class="n">Color</span> <span class="p">=</span> <span class="n">HintOverlayColorDefault</span><span class="p">):</span> <span class="n">HintController</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">rememberHintController</span><span class="p">(</span><span class="n">overlay</span> <span class="p">=</span> <span class="n">LocalHintOverlayColor</span> <span class="n">provides</span> <span class="n">overlay</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">rememberHintController</span><span class="p">(</span><span class="n">overlay</span><span class="p">:</span> <span class="n">ProvidedValue</span><span class="p">&lt;*&gt;):</span> <span class="n">HintController</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">controller</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">HintController</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">controller</span><span class="p">.</span><span class="n">hint</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">hint</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span><span class="n">overlay</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">HintOverlay</span><span class="p">(</span><span class="n">anchor</span> <span class="p">=</span> <span class="n">hint</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">controller</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†æ¶ˆé™¤æˆ‘ä»¬çš„æç¤ºï¼Œè®©æˆ‘ä»¬å¼•å…¥ä»¥ä¸‹å˜åŒ–ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintController</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">var</span> <span class="py">hint</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">show</span><span class="p">(</span><span class="n">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">hint</span> <span class="p">=</span> <span class="n">hint</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">dismiss</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">hint</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬ä½¿ç”¨ Popup ä½œä¸ºè¦†ç›–å±‚çš„å®¹å™¨ï¼Œå¦‚æœç”¨æˆ·ç‚¹å‡» Android ä¸Šçš„è¿”å›æŒ‰é’®(BACK)ï¼ŒPopup å°±ä¼šè¢«å…³é—­ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">HintOverlay</span><span class="p">(</span>
</span><span class='line'>    <span class="n">anchor</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Popup</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="n">onDismiss</span><span class="p">,</span>
</span><span class='line'>        <span class="c1">// è®¾ç½®å¯èšç„¦ä»¥å¤„ç†æŒ‰å‹backäº‹ä»¶</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">PopupProperties</span><span class="p">(</span><span class="n">focusable</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//...åœ¨è¿™é‡Œç”»å‡ºæˆ‘ä»¬çš„æç¤º</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">HintsContainer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">anchor</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Layout</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">overlayBackground</span><span class="p">(</span><span class="n">anchor</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clickable</span><span class="p">(</span>
</span><span class='line'>                <span class="n">interactionSource</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>                <span class="c1">// ç¦ç”¨ripple</span>
</span><span class='line'>                <span class="n">indication</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onClick</span> <span class="p">=</span> <span class="n">onDismiss</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»“æœæ¼”ç¤ºè§†é¢‘ <a href="https://youtu.be/eo49PKlhO5Y">https://youtu.be/eo49PKlhO5Y</a></p>

<p>ç°åœ¨ï¼ŒHintController å…è®¸æˆ‘ä»¬æŒ‰æ—¶é—´æ˜¾ç¤ºä¸€ä¸ªæç¤ºï¼Œä½†å¦‚æœæˆ‘ä»¬æƒ³æŒ‰é¡ºåºæ˜¾ç¤ºå¤šä¸ªæç¤ºï¼Œåˆ™æ²¡æœ‰å®é™…çš„é˜Ÿåˆ—ã€‚</p>

<p>å¯ä»¥æ‰©å±• HintController å¹¶æ·»åŠ æš‚åœä¿®é¥°ç¬¦ä»¥çŸ¥é“æç¤ºçš„æ˜¾ç¤ºæ—¶é—´ï¼ˆä¾‹å¦‚ï¼Œåœ¨æ˜¾ç¤ºæç¤ºåç«‹å³æ‰§è¡ŒæŸé¡¹æ“ä½œï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Stable</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HintController</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">queue</span> <span class="p">=</span> <span class="n">mutableStateListOf</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">?</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">queue</span><span class="p">.</span><span class="n">firstOrNull</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">pendingRequests</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">,</span> <span class="n">Continuation</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">show</span><span class="p">(</span><span class="n">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">suspendCoroutine</span> <span class="p">{</span> <span class="n">continuation</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">pendingRequests</span><span class="p">[</span><span class="n">hint</span><span class="p">]</span> <span class="p">=</span> <span class="n">continuation</span>
</span><span class='line'>            <span class="n">queue</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">show</span><span class="p">(</span><span class="k">vararg</span> <span class="n">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">show</span><span class="p">(</span><span class="n">hint</span><span class="p">.</span><span class="n">toList</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">show</span><span class="p">(</span><span class="n">hints</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">HintAnchorState</span><span class="p">&gt;)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">suspendCoroutine</span> <span class="p">{</span> <span class="n">continuation</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">pendingRequests</span><span class="p">[</span><span class="n">hints</span><span class="p">.</span><span class="n">last</span><span class="p">()]</span> <span class="p">=</span> <span class="n">continuation</span>
</span><span class='line'>            <span class="n">queue</span><span class="p">.</span><span class="n">addAll</span><span class="p">(</span><span class="n">hints</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">internal</span> <span class="k">fun</span> <span class="nf">onDismissed</span><span class="p">(</span><span class="n">hint</span><span class="p">:</span> <span class="n">HintAnchorState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">pendingRequests</span><span class="p">[</span><span class="n">hint</span><span class="p">]</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">continuation</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">continuation</span><span class="p">.</span><span class="n">resume</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span><span class='line'>            <span class="n">pendingRequests</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">queue</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">hint</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">dismiss</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">pendingRequests</span><span class="p">.</span><span class="n">values</span>
</span><span class='line'>            <span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">continuation</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">continuation</span><span class="p">.</span><span class="n">resumeWithException</span><span class="p">(</span><span class="n">CancellationException</span><span class="p">(</span><span class="s">&quot;Hint was dismissed&quot;</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="n">pendingRequests</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>        <span class="n">queue</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ä¸ºäº†åœ¨åº”ç”¨ç¨‹åºå†…éƒ¨æ˜¾ç¤ºæç¤ºï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª CoroutineScope ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">coroutineScope</span> <span class="p">=</span> <span class="n">rememberCoroutineScope</span><span class="p">()</span>
</span><span class='line'><span class="k">val</span> <span class="py">hintController</span> <span class="p">=</span> <span class="n">rememberHintController</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ç°åœ¨æˆ‘ä»¬å¯ä»¥ä»æç¤ºæœ¬èº«ä¸­å¿½ç•¥æ‰€æœ‰å¾…å¤„ç†çš„æç¤º</span>
</span><span class='line'><span class="k">val</span> <span class="py">topAppBarHint</span> <span class="p">=</span> <span class="n">rememberHintContainer</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">OutlinedButton</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">hintController</span><span class="p">.</span><span class="n">dismiss</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hint for TopAppBar&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// æ˜¾ç¤º 1 æ¡æç¤º</span>
</span><span class='line'><span class="n">BottomNavigationItem</span><span class="p">(</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">coroutineScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">bottomNavigationHintAnchor</span><span class="p">)</span>
</span><span class='line'>            <span class="n">scaffoldState</span><span class="p">.</span><span class="n">snackbarHostState</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span><span class="s">&quot;One hint was shown&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// è¿ç»­æ˜¾ç¤ºå¤šä¸ªæç¤º</span>
</span><span class='line'><span class="n">Button</span><span class="p">(</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">coroutineScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span>
</span><span class='line'>                <span class="n">topAppBarActionHintAnchor</span><span class="p">,</span>
</span><span class='line'>                <span class="n">actionHintAnchor</span><span class="p">,</span>
</span><span class='line'>                <span class="n">bottomNavigationHintAnchor</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">scaffoldState</span><span class="p">.</span><span class="n">snackbarHostState</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span><span class="s">&quot;Many hints were shown&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>æ³¨æ„ï¼š</strong> å¦‚æœæˆ‘ä»¬é€šè¿‡è°ƒç”¨ hintController.dismiss() æ¥å…³é—­æç¤ºï¼Œåˆ™ hintController.show ä¹‹åçš„ä»£ç å°†ä¸ä¼šè¢«è°ƒç”¨ã€‚</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">coroutineScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">hintController</span><span class="p">.</span><span class="n">show</span><span class="p">(</span><span class="n">topAppBarActionHintAnchor</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// å¦‚æœé€šè¿‡è°ƒç”¨ hintController.dismiss å…³é—­äº†ä¹‹å‰çš„æç¤ºï¼Œåˆ™ä¸ä¼šæ˜¾ç¤º Snackbar</span>
</span><span class='line'>    <span class="n">scaffoldState</span><span class="p">.</span><span class="n">snackbarHostState</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span><span class="s">&quot;One hint was shown&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆç»“æœå¦‚è¿™ä¸ªè§†é¢‘æ¼”ç¤º <a href="https://youtu.be/tyZUNJLEVxQ">https://youtu.be/tyZUNJLEVxQ</a>ï¼šæˆ‘ä»¬å¯ä»¥æ˜¾ç¤ºå•ä¸ªæç¤ºï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºæç¤ºåˆ—è¡¨ã€‚</p>

<p>ç”±äºè¯¥é¡¹ç›®ä½¿ç”¨ Compose Multiplatformï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹ä¸åŒçš„ç›®æ ‡è¿è¡Œè¯¥åº”ç”¨ç¨‹åºï¼š</p>

<ul>
<li>Androidç»“æœæ¼”ç¤º <a href="https://youtu.be/BVBCipnbIUc">https://youtu.be/BVBCipnbIUc</a></li>
<li>iOSç»“æœæ¼”ç¤º <a href="https://youtu.be/Z1uasddgqwo">https://youtu.be/Z1uasddgqwo</a></li>
</ul>


<h2>æ€»ç»“</h2>

<p>Compose å’Œ Kotlin Multiplatform æ˜¯ä¸€ä¸ªå¼ºå¤§çš„ç»„åˆï¼Œå®ƒå…è®¸æˆ‘ä»¬ä½¿ç”¨ Kotlin æ¥å®ç° UI å’Œä¸šåŠ¡é€»è¾‘ã€‚CMP åº“ä»…ä¸Jetpack Compose Android é¡¹ç›®å®Œå…¨å…¼å®¹ã€‚</p>

<p>å¯ä»¥åœ¨ GitHub ä¸ŠæŸ¥çœ‹æˆ‘çš„repoï¼š<a href="https://github.com/vitoksmile/ComposeHints">https://github.com/vitoksmile/ComposeHints</a>ã€‚</p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼ŒæœŸå¾…åœ¨ GitHub ä¸Šè·å¾—ä½ çš„Star :)ã€‚</p>
]]></content>
  </entry>
  
</feed>
