<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[ç¨€æœ‰çŒ¿è¯‰]]></title>
  <link href="https://alexhilton.github.io/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2025-09-24T22:42:05+08:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[é¢å‘å¼€å‘è€…çš„ç³»ç»Ÿè®¾è®¡ï¼šåƒå»ºç­‘å¸ˆä¸€æ ·æ€è€ƒ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"/>
    <updated>2025-09-24T22:31:48+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒSystem Design for Developers: Think Like an Architectã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28">https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28</a>ï¼Œç”±Saurabh Singhå‘å¸ƒäº2025å¹´8æœˆ25æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*b1eSMQdryXSteTJredbMtA.png" title="auto auto" ></a></p>

<!-- more -->


<blockquote><p>â€œå»ºç­‘æ˜¯ä¸€ç§ç¤¾ä¼šè¡Œä¸ºï¼Œä¹Ÿæ˜¯äººç±»æ´»åŠ¨çš„ç‰©è´¨èˆå°ã€‚â€â€”â€” Spiro Kostof</p></blockquote>

<p>æ­£å¦‚å»ºç­‘å¸ˆä¸ä¼šåœ¨æ²¡æœ‰è“å›¾çš„æƒ…å†µä¸‹å¼€å§‹å»ºé€ ä¸€æ ·ï¼Œå¼€å‘è€…ä¹Ÿä¸åº”è¯¥åœ¨æ²¡æœ‰ç³»ç»Ÿè®¾è®¡çš„æƒ…å†µä¸‹å¼€å§‹ç¼–ç ã€‚ç„¶è€Œï¼Œè®¸å¤šå¼€å‘è€…ç›´æ¥è¿›å…¥å®ç°é˜¶æ®µï¼Œå´å‘ç°è‡ªå·±é™·å…¥äº†æŠ€æœ¯å€ºåŠ¡ã€æ€§èƒ½ç“¶é¢ˆå’Œæ¶æ„å™©æ¢¦çš„è¿·å®«ä¹‹ä¸­ï¼Œè€Œè¿™äº›æœ¬å¯ä»¥é€šè¿‡é€‚å½“çš„è§„åˆ’æ¥é¿å…ã€‚</p>

<p>ç³»ç»Ÿè®¾è®¡æ˜¯ä¸€é—¨è‰ºæœ¯å’Œç§‘å­¦ï¼Œå®ƒå®šä¹‰ç³»ç»Ÿçš„æ¶æ„ã€ç»„ä»¶ã€æ¨¡å—ã€æ¥å£å’Œæ•°æ®ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚å®ƒå°±åƒä¸€åº§å±¹ç«‹ç™¾å¹´çš„æˆ¿å±‹å’Œä¸€åº§å› è‡ªèº«é‡é‡è€Œå€’å¡Œçš„æˆ¿å±‹ä¹‹é—´çš„åŒºåˆ«ã€‚</p>

<h2>å»ºç­‘å¸ˆçš„æ€ç»´æ–¹å¼ï¼šåˆ†è§£å¤æ‚é—®é¢˜</h2>

<h2>åˆ†å±‚æ€è€ƒï¼Œè€Œéç›´çº¿æ€è€ƒ</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨è®¾è®¡ä¸€åº§æ‘©å¤©å¤§æ¥¼ã€‚ä½ ä¸ä¼šå…ˆå†³å®šç¬¬ 47 å±‚çš„å¢™å£è¦åˆ·ä»€ä¹ˆé¢œè‰²ã€‚ä½ ä¼šå…ˆä»åœ°åŸºå¼€å§‹ï¼Œç„¶åæ˜¯ç»“æ„æ¡†æ¶ï¼Œæ¥ç€æ˜¯ç”µæ°”å’Œç®¡é“ç³»ç»Ÿï¼Œæœ€åæ˜¯å®¤å†…è®¾è®¡ã€‚</p>

<p>è½¯ä»¶ç³»ç»Ÿä¹Ÿéµå¾ªåŒæ ·çš„åŸåˆ™ã€‚æƒ³è±¡ä¸€ä¸‹<strong>å¯è§†åŒ–é¡µé¢æ„å»ºå™¨åº”ç”¨ç¨‹åº</strong>â€”â€”æƒ³æƒ³ Webflowã€Wix æˆ– Squarespace ç­‰å·¥å…·ï¼Œå®ƒä»¬å…è®¸ç”¨æˆ·é€šè¿‡æ‹–æ”¾ç•Œé¢åˆ›å»ºç½‘é¡µï¼Œè€Œæ— éœ€ç¼–å†™ä»£ç ã€‚è¿™äº›ç³»ç»Ÿéå¸¸å¤æ‚ï¼Œç”¨æˆ·å¯ä»¥ï¼š</p>

<ul>
<li>å°†ç»„ä»¶ï¼ˆæŒ‰é’®ã€å›¾ç‰‡ã€æ–‡æœ¬å—ï¼‰ä»åº“æ‹–æ”¾åˆ°ç”»å¸ƒä¸Š</li>
<li>é€šè¿‡å¯è§†åŒ–æ§ä»¶è‡ªå®šä¹‰å±æ€§ï¼ˆé¢œè‰²ã€å­—ä½“ã€å¤§å°ï¼‰</li>
<li>åœ¨æ„å»ºè¿‡ç¨‹ä¸­å®æ—¶é¢„è§ˆé¡µé¢</li>
<li>å°†ç½‘ç«™ç›´æ¥å‘å¸ƒåˆ° Web ä¸Š</li>
<li>ä¸å›¢é˜Ÿæˆå‘˜å®æ—¶åä½œ</li>
</ul>


<p>æ¶æ„å¸ˆæ— éœ€æ·±å…¥ç ”ç©¶æ‹–æ”¾åŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯é¦–å…ˆæ€è€ƒï¼š</p>

<p>åŸºç¡€å±‚ï¼šæ ¸å¿ƒå®ä½“æœ‰å“ªäº›ï¼Ÿ</p>

<p>é¡µé¢ã€ç»„ä»¶ã€æ¨¡æ¿ã€ç”¨æˆ·ã€é¡¹ç›®</p>

<p>ç»“æ„å±‚ï¼šè¿™äº›å®ä½“ä¹‹é—´å¦‚ä½•å…³è”ï¼Ÿ</p>

<p>ç”¨æˆ·åˆ›å»ºé¡¹ç›®
é¡¹ç›®åŒ…å«é¡µé¢
é¡µé¢ç”±ç»„ä»¶ç»„æˆ
ç»„ä»¶å¯ä»¥ä¿å­˜ä¸ºæ¨¡æ¿</p>

<p>ç³»ç»Ÿå±‚ï¼šå®ƒä»¬å¦‚ä½•é€šä¿¡ï¼Ÿ</p>

<ul>
<li>ç”¨äº CRUD æ“ä½œçš„ RESTful API</li>
<li>ç”¨äºå®æ—¶åä½œçš„ WebSocket è¿æ¥</li>
<li>ç”¨äºç»„ä»¶æ›´æ–°çš„äº‹ä»¶é©±åŠ¨æ¶æ„</li>
</ul>


<p><strong>ç•Œé¢å±‚</strong>ï¼šç”¨æˆ·å¦‚ä½•äº¤äº’ï¼Ÿ</p>

<ul>
<li>ç”¨äºé¡¹ç›®ç®¡ç†çš„ä»ªè¡¨ç›˜</li>
<li>ç”¨äºé¡µé¢ç¼–è¾‘çš„ç”»å¸ƒ</li>
<li>ç”¨äºé€‰æ‹©çš„ç»„ä»¶åº“</li>
<li>ç”¨äºæµ‹è¯•çš„é¢„è§ˆæ¨¡å¼</li>
</ul>


<p>æ­£å¦‚è½¯ä»¶å·¥ç¨‹å¸ˆ Grady Booch æ›¾ç»è¯´è¿‡çš„ï¼šâ€œä¼˜ç§€è½¯ä»¶çš„åŠŸèƒ½åœ¨äºåŒ–ç¹ä¸ºç®€ã€‚â€ è¿™ç§åˆ†å±‚æ–¹æ³•å°†æå…¶å¤æ‚çš„å†…å®¹è½¬åŒ–ä¸ºæ˜“äºç®¡ç†çš„æ¨¡å—ã€‚</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šåˆ†å±‚æ¶æ„</h2>

<p><strong>ç°åœ¨å°±æ‹¿èµ·çº¸ç¬”ï¼</strong>åœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œè¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ol>
<li><strong>ç”»å››ä¸ªæ°´å¹³çŸ©å½¢</strong>ï¼Œå¹¶å°†å®ƒä»¬å æ”¾åœ¨ä¸€èµ·</li>
<li><strong>ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ ‡æ³¨</strong>ï¼šç•Œé¢ã€ç³»ç»Ÿã€ç»“æ„ã€åŸºç¡€</li>
<li><strong>é€‰æ‹©ä½ æ—¥å¸¸ä½¿ç”¨çš„ä»»ä½•åº”ç”¨</strong>ï¼ˆNetflixã€Amazonã€WhatsAppï¼‰</li>
<li><strong>åœ¨æ¯ä¸€å±‚</strong>ä¸­å¡«å…¥ä½ è®¤ä¸ºåº”è¯¥å¡«å…¥çš„å†…å®¹</li>
</ol>


<p>Netflix ç¤ºä¾‹ï¼š_</p>

<ul>
<li>ç•Œé¢ï¼šæœç´¢æ ã€è§†é¢‘æ’­æ”¾å™¨ã€æ¨è</li>
<li>ç³»ç»Ÿï¼šæµåª’ä½“æœåŠ¡ã€æ¨èå¼•æ“ã€ç”¨æˆ·èº«ä»½éªŒè¯</li>
<li>ç»“æ„ï¼šç”¨æˆ·è§‚çœ‹ç”µå½±ï¼Œç”µå½±æœ‰è¯„åˆ†</li>
<li>åŸºç¡€ï¼šç”¨æˆ·ã€ç”µå½±ã€è¯„åˆ†ã€è®¢é˜…</li>
</ul>


<p><strong>ä¸ºä»€ä¹ˆè¦ç”»è¿™ä¸ªï¼Ÿ</strong>ä½ çš„å¤§è„‘å¯¹ä½ æ‰‹ç»˜å†…å®¹çš„è®°å¿†åŠ›æ¯”ä½ åˆšåˆšé˜…è¯»çš„å†…å®¹å¼º 6 å€ã€‚è¿™å¼ ç®€å•çš„è‰å›¾ä¼šè®©ä½ ç«‹åˆ»ç†è§£æ–‡ç« çš„å…¶ä½™éƒ¨åˆ†ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:2000/1*k5g3kjh3ugcfUf5CWJjoFw.jpeg" alt="æˆ‘åœ¨é‡æ–°è®¾è®¡è§†é¢‘å¹³å°æ¶æ„æ—¶ç”»äº†è¿™å¼ è‰å›¾ã€‚äº§å“ç»ç†ç»ˆäºæ˜ç™½äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç®€å•åœ°â€œæ·»åŠ ä¸€ä¸ªåŠŸèƒ½â€â€”â€”ä»–èƒ½çœ‹åˆ°å®ƒä¼šå½±å“åˆ°å“ªä¸ªå±‚çº§ã€‚è¿™å¼ å›¾é¿å…äº†3ä¸ªæœˆçš„æŠ€æœ¯å€ºåŠ¡ï¼" /></p>

<h2>åˆ†è§£ç­–ç•¥</h2>

<p>åˆ†è§£å¤æ‚é—®é¢˜å°±åƒè§£å‰–æ‰‹è¡¨ã€‚ä½ éœ€è¦äº†è§£æ¯ä¸ªé½¿è½®ã€å¼¹ç°§å’Œæœºæ¢°è£…ç½®ï¼Œç„¶åæ‰èƒ½æ„å»ºæˆ–ä¿®å¤æ•´ä¸ªé’Ÿè¡¨ã€‚</p>

<p><strong>åŠŸèƒ½åˆ†è§£ç¤ºä¾‹</strong>ï¼šå¯è§†åŒ–é¡µé¢æ„å»ºå™¨</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Page</span> <span class="n">Builder</span> <span class="n">System</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Authentication</span> <span class="o">&amp;</span> <span class="n">Authorization</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">User</span> <span class="n">registration</span><span class="o">/</span><span class="n">login</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Role</span><span class="o">-</span><span class="n">based</span> <span class="n">permissions</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Session</span> <span class="n">management</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Project</span> <span class="n">Management</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Project</span> <span class="n">CRUD</span> <span class="n">operations</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Version</span> <span class="n">control</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Collaboration</span> <span class="n">features</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Page</span> <span class="n">Editor</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Canvas</span> <span class="n">rendering</span> <span class="n">engine</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Component</span> <span class="n">management</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Drag</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">drop</span> <span class="n">interface</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Real</span><span class="o">-</span><span class="n">time</span> <span class="n">preview</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Component</span> <span class="n">Library</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Built</span><span class="o">-</span><span class="ow">in</span> <span class="n">components</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Custom</span> <span class="n">components</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Template</span> <span class="n">system</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="n">Export</span> <span class="o">&amp;</span> <span class="n">Publishing</span>
</span><span class='line'>    <span class="err">â”œâ”€â”€</span> <span class="n">Static</span> <span class="n">site</span> <span class="n">generation</span>
</span><span class='line'>    <span class="err">â”œâ”€â”€</span> <span class="n">Hosting</span> <span class="n">integration</span>
</span><span class='line'>    <span class="err">â””â”€â”€</span> <span class="n">SEO</span> <span class="n">optimization</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ªåˆ†æ”¯éƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ã€å•ç‹¬æµ‹è¯•ï¼Œå¹¶ç³»ç»Ÿåœ°é›†æˆã€‚è¿™ç§æ–¹æ³•éµå¾ª Unix å“²å­¦ï¼šâ€œä¸“å¿ƒåšå¥½ä¸€ä»¶äº‹ã€‚â€</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šç³»ç»Ÿåˆ†è§£æ ‘</h2>

<p><strong>åˆè¯¥ç”»è‰å›¾äº†ï¼</strong> è¿™ä¸ªç»ƒä¹ å¯ä»¥è®­ç»ƒä½ çš„â€œæ¶æ„å¸ˆå¤§è„‘â€ï¼š</p>

<ol>
<li><strong>ç”»ä¸€ä¸ªæ ‘å½¢ç»“æ„</strong>ï¼Œä»¥â€œé¡µé¢æ„å»ºå™¨â€ä¸ºæ ¹</li>
<li><strong>æ·»åŠ  5 ä¸ªä¸»è¦åˆ†æ”¯</strong>ï¼ˆæ€è€ƒï¼šå“ªäº›æ˜¯å¤§å—ï¼Ÿï¼‰</li>
<li><strong>åœ¨æ¯ä¸ªåˆ†æ”¯ä¸‹ï¼Œæ·»åŠ  2-3 ä¸ªå¶å­</strong>ï¼ˆè¾ƒå°çš„éƒ¨åˆ†ï¼‰</li>
<li><strong>ä½¿ç”¨ç®€å•çš„æ–¹æ¡†å’Œçº¿æ¡</strong>â€”â€”æ— éœ€å¤æ‚çš„å›¾è¡¨ï¼</li>
</ol>


<p><em>ä½ çš„ç»˜å›¾å¯èƒ½çœ‹èµ·æ¥åƒï¼š</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="nf">Page Builder</span>
</span><span class='line'><span class="nf">   /</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   \</span>
</span><span class='line'><span class="nf"> Auth  Pages  Components  Export</span>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span><span class="nf"></span>
</span><span class='line'><span class="nf">Login  Create   Library   HTML</span>
</span><span class='line'><span class="nf">Signup Edit</span>
</span><span class='line'>
</span><span class='line'><span class="nf">Custom</span>
</span><span class='line'>
</span><span class='line'><span class="nf">PDF</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ç¥å¥‡æ—¶åˆ»</strong>ï¼šå½“ä½ æ— æ³•è¿›ä¸€æ­¥åˆ†è§£ä¸€ä¸ªæ–¹æ¡†æ—¶ï¼Œè¿™å¯èƒ½å°±æ˜¯ä¸€ä¸ªå¼€å‘äººå‘˜ä¸€å‘¨çš„å·¥ä½œã€‚å¦‚æœè§‰å¾—æ–¹æ¡†å¤ªå¤§ï¼Œå°±è¿›ä¸€æ­¥åˆ†è§£å®ƒï¼</p>

<h2>å¯æ‰©å±•æ€§ï¼šä»Šå¤©æ„å»ºï¼Œåº”å¯¹æœªæ¥çš„é—®é¢˜</h2>

<h2>æˆé•¿å‹æ€ç»´</h2>

<blockquote><p>â€œç§ä¸€æ£µæ ‘çš„æœ€ä½³æ—¶æœºæ˜¯20å¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚â€â€”â€”ä¸­å›½è°šè¯­</p></blockquote>

<p>å¯æ‰©å±•æ€§è§„åˆ’å°±åƒä¸ºæˆ¿å­é€‰æ‹©åœ°åŸºã€‚ä½ å¯èƒ½ä»ä¸€æ ‹å°å±‹å¼€å§‹ï¼Œä½†å¦‚æœä½ è®¡åˆ’æ‰©å»ºæˆä¸€åº§è±ªå®…ï¼Œä½ å°±éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿæ”¯æ’‘æœªæ¥å‘å±•çš„åœ°åŸºã€‚</p>

<p>è€ƒè™‘ä¸‰ä¸ªå¯æ‰©å±•æ€§ç»´åº¦ï¼š</p>

<p><strong>å‚ç›´æ‰©å±•ï¼ˆå‘ä¸Šæ‰©å±•ï¼‰</strong>ï¼šå°±åƒåœ¨å»ºç­‘ç‰©ä¸­å¢åŠ æ›´å¤šæ¥¼å±‚</p>

<ul>
<li>å¢åŠ ç°æœ‰æœåŠ¡å™¨ä¸Šçš„ CPUã€RAM æˆ–å­˜å‚¨ç©ºé—´</li>
<li>ç®€å•ä½†å­˜åœ¨ç‰©ç†é™åˆ¶</li>
<li>å•ç‚¹æ•…éšœ</li>
</ul>


<p><strong>æ°´å¹³æ‰©å±•ï¼ˆå‘å¤–æ‰©å±•ï¼‰</strong>ï¼šå°±åƒåœ¨ç»¼åˆä½“ä¸­å»ºé€ æ›´å¤šå»ºç­‘ç‰©</p>

<ul>
<li>æ·»åŠ æ›´å¤šæœåŠ¡å™¨ä»¥åˆ†æ•£è´Ÿè½½</li>
<li>æ›´å¤æ‚ä½†å‡ ä¹ä¸å—é™åˆ¶</li>
<li>æ›´å¥½çš„å®¹é”™èƒ½åŠ›</li>
</ul>


<p><strong>åŠŸèƒ½æ‰©å±•</strong>ï¼šå°±åƒä¸ºä¸åŒç”¨é€”å»ºé€ ä¸“ç”¨å»ºç­‘ç‰©</p>

<ul>
<li>å¾®æœåŠ¡æ¶æ„</li>
<li>æ¯ä¸ªæœåŠ¡å¤„ç†ç‰¹å®šåŠŸèƒ½</li>
<li>ç‹¬ç«‹æ‰©å±•å’Œéƒ¨ç½²</li>
</ul>


<h2>å¯æ‰©å±•æ€§çš„çº¢ç»¿ç¯ç³»ç»Ÿ</h2>

<p><strong>ğŸŸ¢ ç»¿ç¯å†³ç­–ï¼ˆç¬¬ä¸€å¤©ï¼‰</strong>ï¼š</p>

<ul>
<li>ç®€å•çš„å•ä½“æ¶æ„</li>
<li>å•ä¸€æ•°æ®åº“</li>
<li>ä½¿ç”¨ Redis è¿›è¡ŒåŸºæœ¬ç¼“å­˜</li>
<li>é™æ€èµ„æºçš„ CDN</li>
</ul>


<p><strong>ğŸŸ¡ é»„ç¯å†³ç­–ï¼ˆæµé‡å¢é•¿ï¼‰</strong>ï¼š</p>

<ul>
<li>æ•°æ®åº“åªè¯»å‰¯æœ¬</li>
<li>åº”ç”¨æœåŠ¡å™¨é›†ç¾¤</li>
<li>API é€Ÿç‡é™åˆ¶</li>
<li>ç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿ</li>
</ul>


<p><strong>ğŸ”´ çº¢ç¯å†³ç­–ï¼ˆé«˜æµé‡ï¼‰</strong>ï¼š</p>

<ul>
<li>å¾®æœåŠ¡æ¶æ„</li>
<li>æ•°æ®åº“åˆ†ç‰‡</li>
<li>ç”¨äºå¼‚æ­¥å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>è‡ªåŠ¨æ‰©å±•åŸºç¡€è®¾æ–½</li>
</ul>


<p>å¯¹äºæˆ‘ä»¬çš„é¡µé¢æ„å»ºå™¨ç¤ºä¾‹ï¼Œä½ å¯ä»¥ä»ä¸€ä¸ªç®€å•çš„ Python FastAPI æœåŠ¡å™¨å’Œ PostgreSQL æ•°æ®åº“å¼€å§‹ã€‚éšç€æµé‡çš„å¢é•¿ï¼Œä½ å°†å¼•å…¥ï¼š</p>

<ol>
<li><strong>ç¼“å­˜å±‚</strong>ï¼šç”¨äºä¼šè¯å­˜å‚¨å’Œé¢‘ç¹è®¿é—®çš„æ¨¡æ¿çš„ Redis</li>
<li><strong>CDN</strong>ï¼šç”¨äºæœåŠ¡ç»„ä»¶èµ„æºå’Œç”Ÿæˆé¡µé¢çš„ CloudFront</li>
<li><strong>æ•°æ®åº“ä¼˜åŒ–</strong>ï¼šç”¨äºåˆ†æçš„è¯»å–å‰¯æœ¬ï¼Œä¸ºä¸åŒåŸŸæä¾›ç‹¬ç«‹çš„æ•°æ®åº“</li>
<li><strong>æœåŠ¡åˆ†ç¦»</strong>ï¼šç”¨äºæ¸²æŸ“ã€æ–‡ä»¶ç®¡ç†å’Œç”¨æˆ·ç®¡ç†çš„ä¸“ç”¨å¾®æœåŠ¡</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*93OTsJ_L4-7WhICsL2EL4w.jpeg" alt="æˆ‘ç»˜åˆ¶äº§å“ç›®æ ‡çš„è‰å›¾" /></p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ‰©å±•æ¼”è¿›</h2>

<p><strong>è¿™å¼ å›¾å°†æˆä¸ºä½ çš„æ‰©å±•è·¯çº¿å›¾ï¼</strong></p>

<ol>
<li>åœ¨ä½ çš„çº¸ä¸Š<strong>ç”»ä¸‰åˆ—</strong>ï¼Œåˆ†åˆ«æ ‡è®°ä¸ºï¼šâ€œç¬¬ 1 å¤©â€ã€â€œç¬¬ 6 ä¸ªæœˆâ€ã€â€œç¬¬ 2 å¹´â€</li>
<li><p><strong>åœ¨æ¯ä¸€åˆ—ä¸­ï¼Œç”»å‡ºä½ çš„æ¶æ„å›¾ï¼š</strong></p></li>
<li><p>ç¬¬ 1 å¤©ï¼šç”»ä¸¤ä¸ªæ–¹æ¡†ï¼ˆå‰ç«¯ã€APIï¼‰ï¼Œä¸‹æ–¹ç”»ä¸€ä¸ªåœ†æŸ±ä½“ï¼ˆæ•°æ®åº“ï¼‰</p></li>
<li>ç¬¬ 6 ä¸ªæœˆï¼šæ·»åŠ æ›´å¤šæ–¹æ¡†ï¼ˆRedis ç¼“å­˜ã€CDN äº‘ã€è´Ÿè½½å‡è¡¡å™¨ï¼‰</li>
<li>ç¬¬ 2 å¹´ï¼šå°† API æ–¹æ¡†æ‹†åˆ†æˆå¤šä¸ªå°æ–¹æ¡†ï¼ˆç”¨æˆ·æœåŠ¡ã€é¡¹ç›®æœåŠ¡ç­‰ï¼‰</li>
</ol>


<p><strong>3. åœ¨å„åˆ—ä¹‹é—´ç”»ç®­å¤´</strong>ï¼Œå±•ç¤ºæ¼”è¿›è¿‡ç¨‹</p>

<p><strong>4. åœ¨æ¯åˆ—ä¸Šæ–¹ç”»ä¸€äº›ç®€ç¬”ç”»</strong>ï¼Œå±•ç¤ºç”¨æˆ·æ•°é‡ï¼š100 â†’ 1 ä¸‡ â†’ 100 ä¸‡</p>

<p><strong>ä»ä½ çš„å›¾ä¸­å¾—å‡ºçš„å…³é”®æ´å¯Ÿï¼š</strong>æ³¨æ„å¤æ‚æ€§æ˜¯å¦‚ä½•é€æ¸å¢é•¿çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸‹å­å¢é•¿çš„ã€‚è¿™å°±æ˜¯çœŸå®ç³»ç»Ÿæ¼”è¿›çš„æ–¹å¼ï¼</p>

<h2>èŒè´£ä¸‰ä½ä¸€ä½“ï¼šæ•°æ®åº“ã€API å’Œå‰ç«¯</h2>

<h2>ä¸‰å±‚æ¶æ„ç†å¿µ</h2>

<p>å°† Web åº”ç”¨ç¨‹åºæƒ³è±¡æˆä¸€å®¶é¤å…ï¼š</p>

<p><strong>å‰ç«¯ï¼ˆé¤å…ï¼‰</strong>ï¼šå®¢æˆ·äº’åŠ¨çš„åœ°æ–¹</p>

<ul>
<li>ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ</li>
<li>è¾“å…¥éªŒè¯å’Œæ ¼å¼åŒ–</li>
<li>çŠ¶æ€ç®¡ç†å’Œè·¯ç”±</li>
</ul>


<p><strong>APIï¼ˆå¨æˆ¿ï¼‰</strong>ï¼šé­”æ³•å‘ç”Ÿçš„åœ°æ–¹</p>

<ul>
<li>ä¸šåŠ¡é€»è¾‘å¤„ç†</li>
<li>æ•°æ®è½¬æ¢å’ŒéªŒè¯</li>
<li>ä¸å¤–éƒ¨æœåŠ¡é›†æˆ</li>
</ul>


<p><strong>æ•°æ®åº“ï¼ˆé£Ÿå“å‚¨è—å®¤ï¼‰</strong>ï¼šé£Ÿæå­˜å‚¨çš„åœ°æ–¹</p>

<ul>
<li>æ•°æ®æŒä¹…åŒ–å’Œæ£€ç´¢</li>
<li>æ•°æ®å®Œæ•´æ€§å’Œå…³ç³»</li>
<li>æ€§èƒ½ä¼˜åŒ–</li>
</ul>


<blockquote><p>â€œå¥½çš„æ¶æ„ä¸åœ¨äºç»“æ„æœ¬èº«ï¼Œè€Œåœ¨äºå®ƒæ‰€åˆ›é€ çš„ç©ºé—´ã€‚â€ â€” å®‰è—¤å¿ é›„</p></blockquote>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šé¤å…æ¶æ„</h2>

<p><strong>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»˜ç”»ç»ƒä¹ æ¥å…·ä½“åŒ–è¿™ä¸€ç‚¹ï¼š</strong></p>

<ol>
<li><p><strong>ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„é¤å…å¹³é¢å›¾</strong>ï¼Œå…¶ä¸­åŒ…å«ä¸‰ä¸ªåŒºåŸŸï¼š</p></li>
<li><p>é¤å…ï¼ˆé¡¾å®¢å°±åº§çš„åœ°æ–¹ï¼‰</p></li>
<li>å¨æˆ¿ï¼ˆå‡†å¤‡é£Ÿç‰©çš„åœ°æ–¹ï¼‰</li>
<li>å‚¨è—å®¤ï¼ˆå­˜æ”¾é£Ÿæçš„åœ°æ–¹ï¼‰</li>
</ol>


<p><strong>2. ç°åœ¨ç»˜åˆ¶ç®­å¤´è¡¨ç¤ºæ•°æ®æµå‘ï¼š</strong></p>

<ul>
<li>é¡¾å®¢ç‚¹é¤ â†’ å¨æˆ¿</li>
<li>å¨æˆ¿ç´¢å–é£Ÿæ â†’ å‚¨è—å®¤</li>
<li><p>å¨æˆ¿é€å‡ºå‡†å¤‡å¥½çš„é£Ÿç‰© â†’ é¤å…</p></li>
<li><p><strong>ä¸ºæ¯ä¸ªåŒºåŸŸæ ‡æ³¨ç›¸åº”çš„ Web å¯¹åº”é¡¹ï¼š</strong></p></li>
<li><p>é¤å… = å‰ç«¯</p></li>
<li>å¨æˆ¿ = API</li>
<li>å‚¨è—å®¤ = æ•°æ®åº“</li>
</ul>


<p><strong>ä¸ºä»€ä¹ˆè¿™æ ·åšæœ‰æ•ˆï¼š</strong>ç°åœ¨ä½ çš„å¤§è„‘å·²ç»å¯¹æŠ½è±¡çš„ç³»ç»Ÿæ¦‚å¿µæœ‰äº†ç‰©ç†éšå–»ã€‚æ¯æ¬¡è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™å®¶é¤å…çš„åœºæ™¯ï¼</p>

<h2>èŒè´£è¾¹ç•Œ</h2>

<p><strong>æ•°æ®åº“èŒè´£</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">âœ…</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">handles</span> <span class="n">data</span> <span class="n">integrity</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">email</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">UNIQUE</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">created_at</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">NOW</span><span class="p">()</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">âœ…</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">enforces</span> <span class="n">relationships</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">pages</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="n">INTEGER</span> <span class="n">REFERENCES</span> <span class="n">projects</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="n">ON</span> <span class="n">DELETE</span> <span class="n">CASCADE</span><span class="p">,</span>
</span><span class='line'>    <span class="n">title</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>API èŒè´£</strong>ï¼ˆPython å’Œ FastAPIï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># âœ… Good: API handles business logic</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span><span class="nd">@app.post</span><span class="p">(</span><span class="s">&quot;/api/pages&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">create_page</span><span class="p">(</span>
</span><span class='line'>    <span class="n">page_data</span><span class="p">:</span> <span class="n">PageCreateModel</span><span class="p">,</span>
</span><span class='line'>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
</span><span class='line'><span class="p">):</span>
</span><span class='line'>    <span class="c"># Validate user permissions</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_user_edit_project</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">page_data</span><span class="o">.</span><span class="n">project_id</span><span class="p">):</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s">&quot;Unauthorized&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Apply business rules</span>
</span><span class='line'>    <span class="n">page</span> <span class="o">=</span> <span class="n">await</span> <span class="n">create_page_with_defaults</span><span class="p">(</span><span class="n">page_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Return appropriate response</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Page created successfully&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>å‰ç«¯èŒè´£</strong>ï¼ˆAngularï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// âœ… Good: Frontend handles user interaction</span>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;app-page-editor&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;./page-editor.component.html&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageEditorComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">components</span><span class="o">:</span> <span class="nx">Component</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Handle user interactions</span>
</span><span class='line'>  <span class="nx">onComponentDrop</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">Position</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">addComponent</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">next</span><span class="o">:</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateComponents</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">error</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">complete</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ¶æ„æ¨¡å¼ï¼šä¼Ÿå¤§ç³»ç»Ÿçš„åŸºçŸ³</h2>

<h2>æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ (MVC)ï¼šç»å…¸æ¨¡å¼</h2>

<p>MVC å°±åƒç»„ç»‡ä¸€åœºæˆå‰§æ¼”å‡ºï¼š</p>

<ul>
<li><strong>æ¨¡å‹</strong>ï¼šå‰§æœ¬å’Œæ•…äº‹ï¼ˆæ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼‰</li>
<li><strong>è§†å›¾</strong>ï¼šèˆå°å’Œæ¼”å‘˜ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰</li>
<li><strong>æ§åˆ¶å™¨</strong>ï¼šå¯¼æ¼”ï¼ˆæ¨¡å‹å’Œï¼ˆæŸ¥çœ‹ï¼‰</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># Model: Page data and operations</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span> <span class="nx">import</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">Integer</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">JSON</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">declarative</span> <span class="nx">import</span> <span class="nx">declarative_base</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span><span class="k">class</span> <span class="nc">PageModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;pages&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">components</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
</span><span class='line'>        <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="o">//</span> <span class="nv">View: </span><span class="nx">Page</span> <span class="nx">rendering</span> <span class="p">(</span><span class="nx">Angular</span> <span class="nx">Component</span><span class="p">)</span>
</span><span class='line'><span class="nx">@Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nv">selector: </span><span class="s">&#39;app-page-view&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">template: </span><span class="o">`</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;page&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span>
</span><span class='line'>        <span class="o">*</span><span class="nx">ngFor</span><span class="o">=</span><span class="s">&quot;let component of pageModel.components&quot;</span>
</span><span class='line'>        <span class="p">[</span><span class="nx">componentData</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;component&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;/</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="nx">export</span> <span class="k">class</span> <span class="nx">PageViewComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">@Input</span><span class="p">()</span> <span class="nv">pageModel: </span><span class="nx">PageModel</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Controller: Coordination logic (Angular Service)</span>
</span><span class='line'><span class="err">@</span><span class="nx">Injectable</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">providedIn</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageController</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">async</span> <span class="nx">updateTitle</span><span class="p">(</span><span class="nx">pageId</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">newTitle</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">updatedPage</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">updatePage</span><span class="p">(</span><span class="nx">pageId</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
</span><span class='line'>    <span class="c1">// Emit event to refresh view</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">pageUpdated</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">updatedPage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>äº‹ä»¶é©±åŠ¨æ¶æ„ï¼šç¥ç»ç³»ç»Ÿ</h2>

<p>äº‹ä»¶é©±åŠ¨æ¶æ„å°±åƒäººç±»çš„ç¥ç»ç³»ç»Ÿâ€”â€”å½“æŸä¸ªéƒ¨åˆ†å‘ç”Ÿäº‹ä»¶æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè‡ªåŠ¨åšå‡ºååº”ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Event system for page builder</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">asyncio</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">EventBus</span><span class="p">:</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">async</span> <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span class='line'>        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="p">[])</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">])</span><span class="c"># Usage</span>
</span><span class='line'><span class="n">event_bus</span> <span class="o">=</span> <span class="n">EventBus</span><span class="p">()</span><span class="c"># Auto-save feature</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">auto_save_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">auto_save</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">show_save_indicator</span><span class="p">()</span><span class="c"># Analytics tracking</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">analytics_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">analytics</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&#39;Component Added&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;component_type&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;component&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;page_id&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¾®æœåŠ¡ï¼šä¸“ä¸šå›¢é˜Ÿ</h2>

<p>å¾®æœåŠ¡å°±åƒä¸€ä¸ªçˆµå£«ä¹å›¢â€”â€”æ¯ä¸ªéŸ³ä¹å®¶ï¼ˆæœåŠ¡ï¼‰éƒ½æ˜¯å„è‡ªä¹å™¨çš„ä¸“å®¶ï¼Œä½†ä»–ä»¬å…±åŒåŠªåŠ›ï¼Œåˆ›é€ å‡ºç¾å¦™çš„éŸ³ä¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Docker Compose for Page Builder Microservices</span>
</span><span class='line'>version: <span class="s1">&#39;3.8&#39;</span>
</span><span class='line'>services:
</span><span class='line'>  user-service:
</span><span class='line'>    image: pagebuilder/user-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://users_db
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8001:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      project-service:
</span><span class='line'>    image: pagebuilder/project-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://projects_db
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8002:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      rendering-service:
</span><span class='line'>    image: pagebuilder/rendering-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>      - <span class="nv">S3_BUCKET</span><span class="o">=</span>pagebuilder-assets
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8003:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      frontend:
</span><span class='line'>    image: pagebuilder/angular-frontend
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;4200:80&quot;</span>
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">API_GATEWAY_URL</span><span class="o">=</span>http://api-gateway:8080
</span><span class='line'>
</span><span class='line'>      api-gateway:
</span><span class='line'>    image: pagebuilder/api-gateway:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">USER_SERVICE_URL</span><span class="o">=</span>http://user-service:8000
</span><span class='line'>      - <span class="nv">PROJECT_SERVICE_URL</span><span class="o">=</span>http://project-service:8000
</span><span class='line'>      - <span class="nv">RENDERING_SERVICE_URL</span><span class="o">=</span>http://rendering-service:8000
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8080:8000&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä½•æ—¶ä½¿ç”¨æ¯ç§æ¨¡å¼</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Kx0t7cKSgdtO0Q1PpRiLXg.jpeg" alt="è¿™æ˜¯æˆ‘åœ¨ä¸€æ¬¡æ¶æ„è¯„å®¡ä¼šä¸Šç”»çš„è‰å›¾ï¼Œå½“æ—¶å›¢é˜Ÿå°±å„ç§æ¨¡å¼äº‰è®ºäº†ä¸¤ä¸ªå°æ—¶ã€‚è¿™å¼ å›¾åœ¨5åˆ†é’Ÿå†…å°±ç»“æŸäº†è¿™åœºäº‰è®ºâ€”â€”æ¯ä¸ªäººéƒ½æ¸…æ¥šåœ°çœ‹åˆ°äº†ä»–ä»¬çš„é¡¹ç›®ä¸ä¸€ä¸ªæ¨¡å¼çš„å¯¹åº”å…³ç³»ã€‚ç°åœ¨ï¼Œæˆ‘æŠŠè¿™å¼ ç…§ç‰‡ä¿å­˜åœ¨æ‰‹æœºé‡Œï¼Œæ¯æ¬¡æ¶æ„è®¨è®ºæ—¶éƒ½ä¼šæ‹¿å‡ºæ¥ç”¨ã€‚" /></p>

<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ MVC</strong>ï¼š</p>

<ul>
<li>æ„å»ºä¼ ç»Ÿ Web åº”ç”¨ç¨‹åº</li>
<li>å›¢é˜Ÿç†Ÿæ‚‰è¯¥æ¨¡å¼</li>
<li>éœ€è¦æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»</li>
</ul>


<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨äº‹ä»¶é©±åŠ¨</strong>ï¼š</p>

<ul>
<li>å®æ—¶åŠŸèƒ½å¾ˆé‡è¦</li>
<li>éœ€è¦å¤šä¸ªç³»ç»Ÿå“åº”å˜åŒ–</li>
<li>éœ€è¦æ¾æ•£è€¦åˆ</li>
</ul>


<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨å¾®æœåŠ¡</strong>ï¼š</p>

<ul>
<li>å›¢é˜Ÿè§„æ¨¡ > 10 åå¼€å‘äººå‘˜</li>
<li>ä¸åŒéƒ¨åˆ†çš„æ‰©å±•èƒ½åŠ›ä¸åŒ</li>
<li>ç‹¬ç«‹éƒ¨ç½²è‡³å…³é‡è¦</li>
</ul>


<p>æ­£å¦‚ Martin Fowler æ‰€è¨€ï¼šâ€œå‚»ç“œä¹Ÿèƒ½å†™å‡ºè®¡ç®—æœºèƒ½ç†è§£çš„ä»£ç ã€‚ä¼˜ç§€çš„ç¨‹åºå‘˜å†™å‡ºäººç±»èƒ½ç†è§£çš„ä»£ç ã€‚â€</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ¶æ„æ¨¡å¼æ¯”è¾ƒ</h2>

<p><strong>åˆ›å»ºä½ çš„ä¸ªäººæ¶æ„æ¨¡å¼é€ŸæŸ¥è¡¨ï¼š</strong></p>

<ol>
<li>åœ¨ä½ çš„çº¸ä¸Š<strong>ç”»å‡ºä¸‰ä¸ªéƒ¨åˆ†</strong>ï¼šâ€œMVCâ€ã€â€œäº‹ä»¶é©±åŠ¨â€ã€â€œå¾®æœåŠ¡â€</li>
<li><p><strong>å¯¹äº MVCï¼š</strong>ç”»å‡ºä¸‰ä¸ªç›¸è¿çš„æ–¹æ¡†ï¼ˆæ¨¡å‹ â†” æ§åˆ¶å™¨ â†” è§†å›¾ï¼‰</p></li>
<li><p>åœ¨ä¸‹é¢å†™ä¸Šï¼šâ€œé€‚åˆï¼šä¼ ç»Ÿåº”ç”¨ï¼Œæ¸…æ™°çš„åˆ†ç¦»â€</p></li>
</ol>


<p><strong>3.å¯¹äºäº‹ä»¶é©±åŠ¨ï¼š</strong> ç”»ä¸€ä¸ªä¸­å¿ƒåœ†åœˆï¼Œæ ‡è®°ä¸ºâ€œäº‹ä»¶æ€»çº¿â€ï¼Œå¹¶ç”¨ç®­å¤´å‘å¤–è¾å°„åˆ°å¤šä¸ªæ–¹æ¡†ã€‚</p>

<ol>
<li>åœ¨ä¸‹é¢å†™ï¼šâ€œé€‚ç”¨äºï¼šå®æ—¶åŠŸèƒ½ï¼Œæ¾è€¦åˆâ€</li>
</ol>


<p><strong>5. å¯¹äºå¾®æœåŠ¡ï¼š</strong> ç”» 6-8 ä¸ªç‹¬ç«‹çš„å°æ–¹æ¡†ï¼Œå¹¶ç”¨è™šçº¿è¿æ¥å®ƒä»¬ã€‚</p>

<ul>
<li>åœ¨ä¸‹é¢å†™ï¼šâ€œé€‚ç”¨äºï¼šå¤§å‹å›¢é˜Ÿï¼Œç‹¬ç«‹æ‰©å±•â€</li>
</ul>


<p><strong>6. æ·»åŠ å†³ç­–æ ‘ï¼š</strong> ä»é—®é¢˜åˆ°æ¨¡å¼ç”»ç®­å¤´ï¼š</p>

<ul>
<li>â€œå›¢é˜Ÿå°‘äº 5 äººï¼Ÿâ€ â†’ MVC</li>
<li>â€œéœ€è¦å®æ—¶åŠŸèƒ½å—ï¼Ÿâ€ â†’ äº‹ä»¶é©±åŠ¨</li>
<li>â€œå¤šä¸ªå›¢é˜Ÿï¼Ÿâ€ â†’ å¾®æœåŠ¡</li>
</ul>


<p><strong> å°†æ­¤å›¾æ”¾åœ¨æ‰‹è¾¹ï¼</strong> è¿™æ˜¯ä½ æœªæ¥ä»»ä½•é¡¹ç›®çš„æ¶æ„å†³ç­–æµç¨‹å›¾ã€‚</p>

<h2>ç»˜åˆ¶çœŸæ­£æœ‰ç”¨çš„ç³»ç»Ÿå›¾</h2>

<h2>è§†è§‰ä¼ è¾¾çš„è‰ºæœ¯</h2>

<blockquote><p>â€œä¸€å›¾èƒœåƒè¨€ï¼Œä½†ä¸€å¼ å¥½çš„å›¾è¡¨èƒœè¿‡åƒæ¬¡ä¼šè®®ã€‚â€ â€” æœªçŸ¥</p></blockquote>

<p>ç³»ç»Ÿå›¾æ˜¯è½¯ä»¶æ¶æ„çš„è“å›¾ã€‚å®ƒä»¬åº”è¯¥è®²è¿°ä¸€ä¸ªæ•…äº‹ï¼Œè€Œä¸æ˜¯åˆ¶é€ æ··ä¹±ã€‚</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šå›¾è¡¨å±‚æ¬¡ç»“æ„</h2>

<p><strong>ç»ƒä¹ ä¸‰å±‚ç³»ç»Ÿå›¾ç»˜åˆ¶æ–¹æ³•ï¼š</strong></p>

<p><strong>ç¬¬ä¸€å±‚ - ä¸Šä¸‹æ–‡ï¼ˆ30 ç§’ç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>ç»˜åˆ¶ä¸‰ä¸ªå½¢çŠ¶</strong>ï¼šåœ†å½¢ï¼ˆç”¨æˆ·ï¼‰ã€çŸ©å½¢ï¼ˆä½ çš„ç³»ç»Ÿï¼‰ã€äº‘ï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰</li>
<li><strong>ç”¨å¸¦æ ‡ç­¾çš„ç®­å¤´è¿æ¥</strong>ï¼šâ€œHTTP è¯·æ±‚â€ã€â€œAPI è°ƒç”¨â€ã€â€œæ•°æ®åŒæ­¥â€</li>
<li><strong>è¿™å›ç­”äº†</strong>â€œæˆ‘ä»¬çš„ç³»ç»Ÿè¿æ¥åˆ°ä»€ä¹ˆï¼Ÿâ€</li>
</ol>


<p><strong>ç¬¬äºŒå±‚ - å®¹å™¨ï¼ˆ2 åˆ†é’Ÿç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>å°†ç³»ç»ŸçŸ©å½¢åˆ†æˆå››ä¸ªéƒ¨åˆ†</strong>ï¼šå‰ç«¯ã€API ç½‘å…³ã€æœåŠ¡ã€æ•°æ®åº“</li>
<li><strong>ç”¨ç®­å¤´</strong>æ˜¾ç¤ºå®ƒä»¬ä¹‹é—´çš„æ•°æ®æµ**</li>
<li><strong>è¿™å›ç­”äº†</strong>â€œä¸»è¦éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿâ€</li>
</ol>


<p><strong>ç¬¬ä¸‰çº§â€”â€”ç»„ä»¶ï¼ˆ5 åˆ†é’Ÿç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>é€‰æ‹©ä¸€ä¸ªå®¹å™¨ï¼ˆä¾‹å¦‚å‰ç«¯ï¼‰å¹¶å°†å…¶åˆ†è§£</strong>ä¸ºæ¨¡å—</li>
<li><strong>å±•ç¤ºæ¨¡å—å¦‚ä½•åœ¨è¯¥å®¹å™¨å†…äº¤äº’</strong></li>
<li><strong>è¿™å°†å›ç­”</strong>â€œè¿™ä¸ªç»„ä»¶å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿâ€</li>
</ol>


<p><strong>æœ¬ç»ƒä¹ çš„å¼ºå¤§ä¹‹å¤„ï¼š</strong>åªéœ€é€‰æ‹©è¦ç»˜åˆ¶çš„å›¾çº¸ï¼Œå³å¯åœ¨ä»»ä½•ç»†èŠ‚å±‚é¢è§£é‡Šä»»ä½•ç³»ç»Ÿï¼</p>

<h2>å›¾è¡¨çš„å±‚æ¬¡ç»“æ„</h2>

<p><strong>ä¸Šä¸‹æ–‡å›¾</strong>ï¼š30,000 è‹±å°ºçš„è§†è§’</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Users]</span> --&gt; <span class="cm">[Page Builder System]</span> --&gt; <span class="cm">[CDN]</span>
</span><span class='line'>           |
</span><span class='line'>           v
</span><span class='line'>      <span class="cm">[Database]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>å®¹å™¨å›¾</strong>ï¼šæ„å»ºæ¨¡å—</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Web Browser]</span> --&gt; <span class="cm">[Load Balancer]</span> --&gt; <span class="cm">[Web Application]</span>
</span><span class='line'>                                         |
</span><span class='line'>                                         v
</span><span class='line'><span class="cm">[File Storage]</span> &lt;-- <span class="cm">[API Gateway]</span> &lt;-- <span class="cm">[Cache Layer]</span>
</span><span class='line'>                        |
</span><span class='line'>                        v
</span><span class='line'>                   <span class="cm">[Database Cluster]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ç»„ä»¶å›¾</strong>ï¼šå†…éƒ¨ç»“æ„</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='mathematica'><span class='line'><span class="n">Web</span><span class="w"> </span><span class="n">Application</span><span class="err">:</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Project</span><span class="w"> </span><span class="n">Management</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Page</span><span class="w"> </span><span class="n">Editor</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Canvas</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Toolbar</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Properties</span><span class="w"> </span><span class="n">Panel</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="n">Library</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Export</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>æœ‰æ•ˆçš„å›¾è¡¨ç»˜åˆ¶åŸåˆ™</h2>

<ol>
<li><strong>ä»ç”¨æˆ·æ—…ç¨‹å¼€å§‹</strong>ï¼šæ¯ä¸ªå›¾è¡¨éƒ½åº”è¯¥å›ç­”â€œæ•°æ®å¦‚ä½•ä»ç”¨æˆ·æ“ä½œæµå‘ç»“æœï¼Ÿâ€</li>
<li><strong>ä½¿ç”¨ä¸€è‡´çš„ç¬¦å·</strong>ï¼šçŸ©å½¢è¡¨ç¤ºè¿›ç¨‹ï¼Œåœ†æŸ±ä½“è¡¨ç¤ºæ•°æ®å­˜å‚¨ï¼Œåœ†å½¢è¡¨ç¤ºå¤–éƒ¨å®ä½“</li>
<li><strong>æ¸…æ™°åœ°æ˜¾ç¤ºå…³ç³»</strong>ï¼šç®­å¤´åº”æŒ‡ç¤ºæ•°æ®æµæ–¹å‘å¹¶è¿›è¡Œæ ‡è®°</li>
<li><strong>åˆ†å±‚å›¾è¡¨</strong>ï¼šä»é«˜å±‚å¼€å§‹ï¼Œç„¶åæ”¾å¤§åˆ°ç‰¹å®šåŒºåŸŸ</li>
<li><strong>åŒ…å«ä¸æ„‰å¿«çš„è·¯å¾„</strong>ï¼šæ˜¾ç¤ºé”™è¯¯å¤„ç†å’Œæ•…éšœåœºæ™¯</li>
</ol>


<h2>æ•´åˆï¼šå¯è§†åŒ–é¡µé¢æ„å»ºå™¨æ¡ˆä¾‹ç ”ç©¶</h2>

<p>è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„å¯è§†åŒ–é¡µé¢æ„å»ºå™¨è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿæ¶æ„ï¼š</p>

<h2>é«˜å±‚æ¶æ„</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coq'><span class='line'><span class="nc">Frontend</span> <span class="o">(</span><span class="nc">Angular</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Editor</span> <span class="nc">Canvas</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Component</span> <span class="nc">Library</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Project</span> <span class="nc">Dashboard</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nc">Shared</span> <span class="nc">Services</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nt">API</span> <span class="nt">Gateway</span> <span class="o">(</span><span class="nt">Python</span><span class="o">/</span><span class="nt">FastAPI</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Authentication</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Project</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Component</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">Rendering</span> <span class="nt">ServiceData</span> <span class="nt">Layer</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">PostgreSQL</span> <span class="o">(</span><span class="nt">structured</span> <span class="nt">data</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Redis</span> <span class="o">(</span><span class="nt">caching</span><span class="o">)</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">S3</span> <span class="o">(</span><span class="nt">file</span> <span class="nt">storage</span><span class="o">)</span><span class="nt">Infrastructure</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">CDN</span> <span class="o">(</span><span class="nt">CloudFront</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Load</span> <span class="nt">Balancer</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">Auto-scaling</span> <span class="nt">Groups</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»„ä»¶æ·»åŠ çš„æ•°æ®æµ</h2>

<ol>
<li><strong>ç”¨æˆ·æ“ä½œ</strong>ï¼šå°†ç»„ä»¶ä»åº“æ‹–åˆ°ç”»å¸ƒ</li>
<li><strong>å‰ç«¯</strong>ï¼šéªŒè¯ä½ç½®ï¼Œå‘é€ API è¯·æ±‚</li>
<li><strong>API ç½‘å…³</strong>ï¼šéªŒè¯è¯·æ±‚ï¼Œè·¯ç”±åˆ°ç»„ä»¶æœåŠ¡</li>
<li><strong>ç»„ä»¶æœåŠ¡</strong>ï¼šéªŒè¯ä¸šåŠ¡è§„åˆ™ï¼Œæ›´æ–°æ•°æ®åº“</li>
<li><strong>äº‹ä»¶æ€»çº¿</strong>ï¼šå‘å‡ºâ€œcomponent_addedâ€äº‹ä»¶</li>
<li><strong>æ¸²æŸ“æœåŠ¡</strong>ï¼šç”Ÿæˆæ›´æ–°åçš„é¡µé¢é¢„è§ˆ</li>
<li><strong>WebSocket</strong>ï¼šé€šçŸ¥å…¶ä»–åä½œè€…</li>
<li><strong>å‰ç«¯</strong>ï¼šä½¿ç”¨æ–°ç»„ä»¶æ›´æ–° UI</li>
</ol>


<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ•°æ®æµæ˜ å°„</h2>

<p><strong>å°†è¿™ä¸ªæŠ½è±¡çš„æµç¨‹è½¬åŒ–ä¸ºä¸€ä¸ªå¯è§†åŒ–çš„æ•…äº‹ï¼š</strong></p>

<ol>
<li><strong>åœ¨ä¸€ä¸ªæµç¨‹ä¸­ç”»å‡º 8 ä¸ªæ–¹æ¡†</strong>ï¼ˆæ¯ä¸ªæ–¹æ¡†å¯¹åº”ä¸Šé¢çš„æ¯ä¸ªæ­¥éª¤ï¼‰</li>
<li><strong>ç”¨ç®­å¤´è¿æ¥å®ƒä»¬</strong>ä»¥æ˜¾ç¤ºé¡ºåº</li>
<li><strong>åœ¨æ¯ä¸ªæ–¹æ¡†ä¸Šæ–¹å†™å‡ºæ‰€éœ€æ—¶é—´</strong>ï¼šâ€œ50 æ¯«ç§’â€ã€â€œ200 æ¯«ç§’â€ã€â€œ100 æ¯«ç§’â€ç­‰ã€‚</li>
<li><strong>åœ¨æ¯ä¸ªæ–¹æ¡†ä¸‹æ–¹ï¼Œæ³¨æ˜å¯èƒ½å‡ºç°çš„é—®é¢˜</strong>ï¼šâ€œç½‘ç»œè¶…æ—¶â€ã€â€œèº«ä»½éªŒè¯å¤±è´¥â€ã€â€œæ•°æ®åº“å®•æœºâ€</li>
<li><p><strong>ç°åœ¨ç”»å‡ºç¬¬äºŒä¸ªç‰ˆæœ¬</strong>ï¼Œå±•ç¤ºæ­¥éª¤ 4 å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p></li>
<li><p>ç”¨çº¢è‰²è™šçº¿ç”»ä¸€æ¡â€œæ‚²ä¼¤çš„è·¯å¾„â€ç®­å¤´</p></li>
<li>æ˜¾ç¤ºè¿”å›ç»™ç”¨æˆ·çš„é”™è¯¯æ¶ˆæ¯</li>
<li>æ·»åŠ é‡è¯•é€»è¾‘å’Œå›é€€é€‰é¡¹</li>
</ol>


<p><strong>æœ¬ç»ƒä¹ å°†æ•™ä¼šä½ ï¼š</strong>æ¯ä¸ªç”¨æˆ·æ“ä½œå®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿç¼–æ’ã€‚ç»˜åˆ¶ç®­å¤´å¯ä»¥å¸®åŠ©ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‘ç”Ÿæ½œåœ¨æ•…éšœä¹‹å‰å‘ç°å®ƒä»¬ï¼</p>

<p><strong>é¢å¤–æç¤ºï¼š</strong> ä¸ºç®­å¤´æ·»åŠ é¢œè‰²ä»£ç â€”â€”ç»¿è‰²ä»£è¡¨æ­£å¸¸è·¯å¾„ï¼Œçº¢è‰²ä»£è¡¨é”™è¯¯ï¼Œè“è‰²ä»£è¡¨é‡è¯•ã€‚</p>

<h2>å¯æ‰©å±•æ€§è€ƒè™‘å› ç´ </h2>

<p><strong>æµé‡æ¨¡å¼</strong>ï¼š</p>

<ul>
<li>é«˜è¯»å–æ“ä½œï¼ˆæµè§ˆé¡µé¢ï¼‰</li>
<li>çªå‘å†™å…¥æ“ä½œï¼ˆç¼–è¾‘ä¼šè¯ï¼‰</li>
<li>å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡ã€èµ„æºï¼‰</li>
</ul>


<p><strong>æ‰©å±•ç­–ç•¥</strong>ï¼š</p>

<ul>
<li>å°†æ¸²æŸ“åçš„é¡µé¢ç¼“å­˜åœ¨ CDN ä¸­</li>
<li>ä½¿ç”¨åªè¯»å‰¯æœ¬è¿›è¡Œé¡µé¢æµè§ˆ</li>
<li>å°†å¤§æ–‡ä»¶å¤„ç†æ’é˜Ÿ</li>
<li>å®ç° WebSocket è¿æ¥æ± </li>
</ul>


<h2>è¦ç‚¹ï¼šé€‚ç”¨äºä»»ä½• Web åº”ç”¨ç¨‹åºçš„åŸåˆ™</h2>

<h2>ç³»ç»Ÿè®¾è®¡çš„é»„é‡‘æ³•åˆ™</h2>

<ol>
<li><strong>ä»ç®€å•å¼€å§‹ï¼Œè§„åˆ’å¤æ‚</strong>ï¼šä»å•ä½“åº”ç”¨å¼€å§‹ï¼Œä½†è¦é’ˆå¯¹å¾®æœåŠ¡è¿›è¡Œè®¾è®¡</li>
<li><strong>å¿«é€Ÿå¤±è´¥ï¼Œå¿«é€Ÿå­¦ä¹ </strong>ï¼šä»ç¬¬ä¸€å¤©å¼€å§‹æ„å»ºç›‘æ§å’ŒæŠ¥è­¦åŠŸèƒ½</li>
<li><strong>æ•°æ®ä¸ºç‹</strong>ï¼šå…ˆè®¾è®¡æ•°æ®æ¨¡å‹ï¼Œå…¶ä»–ä¸€åˆ‡éƒ½æ°´åˆ°æ¸ æˆ</li>
<li><strong>å®‰å…¨æ€§ä¸å¯æˆ–ç¼º</strong>ï¼šåœ¨æ¯ä¸€å±‚éƒ½æ„å»ºèº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶</li>
<li><strong>æ€§èƒ½æ˜¯å…³é”®ç‰¹æ€§</strong>ï¼šç”¨æˆ·æ›´å®¹æ˜“æ³¨æ„åˆ°åº”ç”¨ç¨‹åºè¿è¡Œç¼“æ…¢ï¼Œè€Œä¸æ˜¯åŠŸèƒ½ç¼ºå¤±</li>
</ol>


<h2>æ¶æ„æ¸…å•</h2>

<p>åœ¨ç¼–å†™ç¬¬ä¸€è¡Œä»£ç ä¹‹å‰ç¼–å†™ä»£ç æ—¶ï¼Œè¯·é—®è‡ªå·±ï¼š</p>

<ul>
<li>[ ] æ ¸å¿ƒå®ä½“åŠå…¶å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>[ ] è¯¥ç³»ç»Ÿå¦‚ä½•å¤„ç† 10 å€äºå½“å‰æµé‡çš„æƒ…å†µï¼Ÿ</li>
<li>[ ] å•ç‚¹æ•…éšœç‚¹åœ¨å“ªé‡Œï¼Ÿ</li>
<li>[ ] ä¸åŒçš„å›¢é˜Ÿå°†å¦‚ä½•åœ¨è¯¥ç³»ç»Ÿä¸Šåä½œï¼Ÿ</li>
<li>[ ] å‡ºç°é—®é¢˜æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
<li>[ ] æˆ‘ä»¬å°†å¦‚ä½•ç›‘æ§å’Œè°ƒè¯•é—®é¢˜ï¼Ÿ</li>
<li>[ ] å®‰å…¨éšæ‚£æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>


<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šä½ çš„ç³»ç»Ÿè®¾è®¡æ¨¡æ¿</h2>

<p><strong>åˆ›å»ºä½ çš„ä¸ªäººç³»ç»Ÿè®¾è®¡æ¨¡æ¿ï¼Œå¯ç”¨äºä»»ä½•é¡¹ç›®ï¼š</strong></p>

<ol>
<li><strong>ç»˜åˆ¶ä¸€ä¸ªåŒ…å«ä»¥ä¸‹éƒ¨åˆ†çš„ç©ºç™½æ¨¡æ¿ï¼š</strong></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”Œâ”€â”€â”€â”€â”€â”€ å®ä½“ä¸å…³ç³» â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€ æµé‡ä¸æ‰©å±• â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
</span><span class='line'>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€ æ•…éšœç‚¹ â”€â”€â”€â”€â”€â”€
</span><span class='line'>â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€ å›¢é˜Ÿè¾¹ç•Œ â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
</span><span class='line'>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p><strong>å¡«å†™æˆ‘ä»¬çš„é¡µé¢æ„å»ºå™¨ç¤ºä¾‹ï¼š</strong></p></li>
<li><p>å®ä½“ï¼šç”¨æˆ·ã€é¡¹ç›®ã€é¡µé¢ã€ç»„ä»¶</p></li>
<li>æµé‡ï¼šæµè§ˆæ—¶è¯»å–é‡å¤§ï¼Œç¼–è¾‘æ—¶å†™å…¥é‡å¤§</li>
<li>æ•…éšœï¼šæ•°æ®åº“å®•æœºã€CDN é€Ÿåº¦æ…¢ã€WebSocket æ–­å¼€è¿æ¥</li>
<li>å›¢é˜Ÿï¼šå‰ç«¯å›¢é˜Ÿã€API å›¢é˜Ÿã€åŸºç¡€è®¾æ–½å›¢é˜Ÿ</li>
</ol>


<p><strong>2. å¤åˆ¶æ­¤æ¨¡æ¿</strong> â€” å°†å…¶ç”¨äºæœªæ¥çš„æ¯ä¸ªé¡¹ç›®</p>

<p><strong>ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼š</strong> æ‹¥æœ‰ä¸€è‡´çš„æ€ç»´æ¡†æ¶å¯ä»¥é˜²æ­¢ä½ å¿˜è®°å…³é”®æ–¹é¢ã€‚ä½ çš„ç»˜å›¾å°†æˆä¸ºä½ çš„ç³»ç»Ÿè®¾è®¡æ¸…å•ï¼</p>

<h2>ä½ çš„ç»˜å›¾ä¹‹æ—…ï¼šä»è‰å›¾åˆ°ç³»ç»Ÿ</h2>

<p>å¦‚æœä½ å®Œæˆäº†æœ¬æ–‡çš„ç»˜å›¾ç»ƒä¹ ï¼Œé‚£ä¹ˆä½ ç°åœ¨æ‹¥æœ‰ï¼š</p>

<ol>
<li><strong>åˆ†å±‚æ¶æ„æ¨¡æ¿</strong>ï¼ˆç”¨äºåˆ†è§£ä»»ä½•å¤æ‚ç³»ç»Ÿï¼‰</li>
<li><strong>åˆ†è§£æ ‘æ–¹æ³•</strong>ï¼ˆç”¨äºç»„ç»‡å¼€å‘å·¥ä½œï¼‰</li>
<li><strong>æ‰©å±•æ¼”è¿›è·¯çº¿å›¾</strong>ï¼ˆç”¨äºè§„åˆ’å‘å±•é˜¶æ®µï¼‰</li>
<li><strong>é¤å…éšå–»å›¾</strong>ï¼ˆç”¨äºè§£é‡Šä¸‰å±‚æ¶æ„ï¼‰</li>
<li><strong>æ¶æ„æ¨¡å¼å¯¹æ¯”å›¾</strong>ï¼ˆç”¨äºé€‰æ‹©æ­£ç¡®çš„æ–¹æ³•ï¼‰</li>
<li><strong>ä¸‰å±‚å›¾è¡¨ç³»ç»Ÿ</strong>ï¼ˆç”¨äºåœ¨ä»»ä½•ç»†èŠ‚å±‚é¢è¿›è¡Œæ²Ÿé€šï¼‰</li>
<li><strong>æ•°æ®æµæ˜ å°„æŠ€æœ¯</strong>ï¼ˆç”¨äºç†è§£ç³»ç»Ÿäº¤äº’ï¼‰</li>
<li><strong>å¯å¤ç”¨ç³»ç»Ÿè®¾è®¡æ¨¡æ¿</strong>ï¼ˆç”¨äºä¸€è‡´çš„é¡¹ç›®è§„åˆ’ï¼‰</li>
</ol>


<p><strong>è¿™äº›æ‰‹ç»˜å›¾è¡¨æ¯”ä»»ä½•æ˜‚è´µçš„å·¥å…·éƒ½æ›´æœ‰ä»·å€¼</strong>ï¼Œå› ä¸ºï¼š</p>

<ul>
<li>é€šè¿‡ç»˜åˆ¶å®ƒä»¬ï¼Œä½ çš„å¤§è„‘å»ºç«‹äº†æ›´æ·±å±‚æ¬¡çš„è”ç³»</li>
<li>ä½ å¯ä»¥éšæ—¶éšåœ°é‡æ–°åˆ›å»ºå®ƒä»¬</li>
<li>å®ƒä»¬æ ¹æ®ä½ å¯¹ç³»ç»Ÿçš„ç†è§£è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶</li>
<li>å®ƒä»¬å¼¥åˆäº†æŠ½è±¡æ¦‚å¿µä¸å®è·µä¹‹é—´çš„å·®è·å®æ–½</li>
</ul>


<p><strong>ä¿ç•™ä½ çš„å›¾çº¸ï¼</strong> æŠŠå®ƒä»¬è´´åœ¨ä½ çš„æ˜¾ç¤ºå™¨ä¸Šï¼Œç”¨æ‰‹æœºæ‹ç…§ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªâ€œç³»ç»Ÿè®¾è®¡é€Ÿå†™æœ¬â€ï¼Œè®©å®ƒéšç€æ¯ä¸ªé¡¹ç›®çš„è¿›å±•è€Œä¸æ–­æ›´æ–°ã€‚</p>

<h2>æ€»ç»“</h2>

<blockquote><p>â€œæ¶æ„å¸ˆèº«å¤„ä¸¤ä¸ªä¸–ç•Œä¹‹é—´ã€‚ä½ å¿…é¡»æ„¿æ„æ‰“ç ´åŸºæœ¬çš„å‡è®¾ã€‚â€â€”â€”å®‰è—¤å¿ é›„</p></blockquote>

<p>ç³»ç»Ÿè®¾è®¡å¹¶éè¦åˆ›é€ å®Œç¾çš„æ¶æ„ï¼Œè€Œæ˜¯è¦åšå‡ºæ˜æ™ºçš„æƒè¡¡ã€‚æ¯ä¸ªå†³ç­–éƒ½æœ‰å…¶åæœï¼Œæ¯ä¸ªæ¨¡å¼éƒ½æœ‰å…¶åˆ©å¼Šï¼Œæ¯ä¸ªè§£å†³æ–¹æ¡ˆéƒ½ä¼šäº§ç”Ÿæ–°çš„é—®é¢˜éœ€è¦è§£å†³ã€‚</p>

<p>æœ€å¥½çš„æ¶æ„å¸ˆå¹¶éç²¾é€šæ‰€æœ‰æ¨¡å¼å’ŒæŠ€æœ¯ï¼Œè€Œæ˜¯èƒ½å¤Ÿå€¾å¬éœ€æ±‚ã€ç†è§£çº¦æŸï¼Œå¹¶è®¾è®¡å‡ºèƒ½å¤Ÿä¸ç”¨æˆ·å’Œç»„ç»‡å’Œè°å…±å­˜çš„ç³»ç»Ÿã€‚</p>

<p>è®°ä½ï¼šä½ ä¸ä»…ä»…æ˜¯åœ¨æ„å»ºè½¯ä»¶ï¼Œä½ è¿˜åœ¨ä¸ºå›¢é˜Ÿæœªæ¥çš„æˆåŠŸå¥ å®šåŸºç¡€ã€‚æ„å»ºå¥½å®ƒï¼Œæ¸…æ™°åœ°è®°å½•å®ƒï¼Œå¹¶å§‹ç»ˆåšå¥½æ¼”è¿›çš„å‡†å¤‡ã€‚</p>

<p>ä¿—è¯è¯´ï¼Œâ€œå‡ å‘¨çš„ç¼–ç æ—¶é—´å¯ä»¥èŠ‚çœæ•°å°æ—¶çš„è§„åˆ’æ—¶é—´ã€‚â€ æŠ•èµ„äºç³»ç»Ÿè®¾è®¡ï¼Œæœªæ¥çš„ä½ ï¼ˆå’Œå›¢é˜Ÿï¼‰ä¼šæ„Ÿè°¢ä½ ã€‚</p>

<p>åƒä¸ªåº”ç”¨ç¨‹åºçš„æ—…ç¨‹å§‹äºä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿã€‚ä»Šå¤©å°±å¼€å§‹åƒæ¶æ„å¸ˆä¸€æ ·æ€è€ƒï¼Œè§è¯ä½ çš„åº”ç”¨ç¨‹åºä»è„†å¼±çš„åŸå‹è½¬å˜ä¸ºç»å¾—èµ·æ—¶é—´è€ƒéªŒçš„å¼ºå¤§ã€å¯æ‰©å±•çš„å¹³å°ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[runBlockingå®è·µï¼šå“ªé‡Œè¯¥ä½¿ç”¨ï¼Œå“ªé‡Œä¸è¯¥ç”¨]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"/>
    <updated>2025-09-23T22:34:01+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒrunBlocking in practice: Where it should be used and where notã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://kt.academy/article/run_blocking">https://kt.academy/article/run_blocking</a>ï¼Œç”±Marcin MoskaÅ‚aå‘å¸ƒäº2025å¹´9æœˆ1æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"><img src="https://kt.academy/_next/image?url=https%3A%2F%2Fmarcinmoskala.com%2Fkt-academy-articles%2Fpromotion%2Frun_blocking.png&w=3840&q=75" title="auto auto" ></a></p>

<!-- more -->


<p>ä¼ ç»Ÿæ„ä¹‰ä¸Šè®²ï¼ŒJava å’Œ Kotlin é¡¹ç›®éƒ½åŸºäºé˜»å¡è°ƒç”¨(blocking)ã€‚æˆ‘æ‰€è¯´çš„é˜»å¡è°ƒç”¨æ˜¯æŒ‡å‡½æ•°åœ¨ç­‰å¾…æŸäº›æ“ä½œï¼ˆä¾‹å¦‚ï¼Œç­‰å¾…ç½‘ç»œå“åº”ï¼‰æ—¶ä¼šé˜»å¡è°ƒç”¨è€…çš„çº¿ç¨‹ã€‚Kotlin åç¨‹æœ€é‡è¦çš„è§„åˆ™ä¹‹ä¸€æ˜¯ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨æŒ‚èµ·å‡½æ•°(suspending function)ä¸Šè¿›è¡Œé˜»å¡è°ƒç”¨ï¼ˆé™¤éæˆ‘ä»¬ä½¿ç”¨å…è®¸é˜»å¡è°ƒç”¨çš„è°ƒåº¦ç¨‹åºï¼Œä¾‹å¦‚ <code>Dispatchers.IO</code>ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using withContext(Dispatchers.IO) to make a blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">=</span> <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½†æ˜¯å¦‚ä½•åå…¶é“è€Œè¡Œä¹‹å‘¢ï¼Ÿå¦‚ä½•å°†æŒ‚èµ·è°ƒç”¨è½¬æ¢ä¸ºé˜»å¡è°ƒç”¨ï¼Ÿä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>runBlocking</code>ï¼</p>

<h2><a href="#how-runblocking-works"><code>runBlocking</code> çš„å·¥ä½œåŸç†</a></h2>

<p><code>runBlocking</code> åœ¨è°ƒç”¨å®ƒçš„çº¿ç¨‹ä¸Šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶é˜»å¡è¯¥çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆã€‚å› æ­¤ï¼ŒrunBlocking æœ¬è´¨ä¸Šæ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨å®ƒï¼Œç¬¬äºŒä¸ªè°ƒç”¨è¦ç­‰åˆ°ç¬¬ä¸€ä¸ªè°ƒç”¨å®Œæˆåæ‰ä¼šå¯åŠ¨ã€‚ä½œä¸ºä¸€ä¸ªåŒæ­¥åç¨‹æ„å»ºå™¨ï¼Œ<code>runBlocking</code> è¿”å›å®ƒå¯åŠ¨çš„åç¨‹çš„ç»“æœã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting main&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Finishing first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">result</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting second runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;ABCD&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Second runBlocking finished with result: $result&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;[${Thread.currentThread().name}] $message&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// [main] Starting main</span>
</span><span class='line'><span class="c1">// [main] Starting first runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Finishing first runBlocking</span>
</span><span class='line'><span class="c1">// [main] Starting second runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Second runBlocking finished with result: ABCD</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç”±äº <code>runBlocking</code> å¯åŠ¨äº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œå®ƒä¼šç­‰å¾…å…¶ä¸­å¯åŠ¨çš„æ‰€æœ‰åç¨‹å®Œæˆã€‚è¿™æ„å‘³ç€å®ƒä¼šç­‰å¾…æ‰€æœ‰å­åç¨‹å®Œæˆã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸‹é¢çš„ç¨‹åºè¦ç­‰åˆ°æ‰€æœ‰ä¸‰ä¸ªå¼‚æ­¥åç¨‹éƒ½å®Œæˆæ‰ä¼šå®Œæˆã€‚ä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>runBlocking</code> å®šä¹‰ç»“æœï¼Œæˆ‘è¿˜è®©è¿™ä¸ªç¨‹åºä» <code>main</code> å‡½æ•°è¿”å› <code>0</code>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="m">0</span> <span class="c1">// result from main</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">delayAndPrintHello</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">1000L</span><span class="p">)</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;World!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// Hello</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> çš„è¡Œä¸ºå¯èƒ½ä¼šè®©ä½ æƒ³èµ· <code>coroutineScope</code>ï¼Œè¿™å¹¶éå·§åˆï¼Œå› ä¸ºå®ƒä»¬éƒ½å¯åŠ¨åŒæ­¥åç¨‹ï¼Œä½† <code>runBlocking</code> æ˜¯é˜»å¡çš„ï¼Œè€Œ <code>coroutineScope</code> æ˜¯æš‚åœçš„ã€‚è¿™æ„å‘³ç€å®Œå…¨ä¸åŒçš„ç”¨æ³•ï¼Œæˆ‘ä»¬åªåœ¨æš‚åœå‡½æ•°ä¸­ä½¿ç”¨ <code>coroutineScope</code>ï¼Œè€Œæˆ‘ä»¬æ°¸è¿œä¸åº”è¯¥åœ¨æš‚åœå‡½æ•°ä¸­ä½¿ç”¨ <code>runBlocking</code>ã€‚è¿™ä¹Ÿæ„å‘³ç€ <code>coroutineScope</code> ä¸å…¶è°ƒç”¨è€…å»ºç«‹å…³ç³»ï¼Œå¹¶ä¸”å§‹ç»ˆå¤„äºåç¨‹å±‚æ¬¡ç»“æ„çš„ä¸­é—´ï¼Œè€Œ <code>runBlocking</code> åˆ™å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹å±‚æ¬¡ç»“æ„ã€‚</p>

<h2><a href="#the-practice-of-using-runblocking">ä½¿ç”¨ <code>runBlocking</code> çš„å®è·µ</a></h2>

<p>åœ¨æ­£ç¡®å®ç°çš„åŸºäºåç¨‹çš„é¡¹ç›®ä¸­ï¼Œå¹¶ä½¿ç”¨è®¾è®¡è‰¯å¥½çš„åç¨‹å‹å¥½åº“ï¼Œæˆ‘ä»¬å‡ ä¹ä¸éœ€è¦ä½¿ç”¨ <code>runBlocking</code>ã€‚å¦‚æœæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨å®ƒï¼Œé‚£å°±è¢«è®¤ä¸ºæ˜¯ä»£ç å¼‚å‘³ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒrunBlocking æ˜¯æœ‰ç”¨çš„ï¼Œç”šè‡³æ˜¯å¿…è¦çš„ã€‚ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¸‹ï¼ŒrunBlocking ä¸åº”è¯¥è¢«ä½¿ç”¨ã€‚æˆ‘ä»¬è¿˜ä¼šè®¨è®ºé‚£äº›æ›¾ç»éœ€è¦ runBlocking ä½†ç°åœ¨æœ‰äº†æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆçš„æƒ…å†µã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚</p>

<h2><a href="#where-to-use-runblocking">åœ¨å“ªé‡Œä½¿ç”¨ <code>runBlocking</code></a></h2>

<p><code>runBlocking</code> åº”è¯¥ç”¨äºéœ€è¦å¯åŠ¨åç¨‹å¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å…¶å®Œæˆçš„æƒ…å†µã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ï¼š</p>

<ul>
<li>æˆ‘ä»¬éœ€è¦ç­‰å¾…åç¨‹çš„ç»“æœã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ã€‚</li>
</ul>


<p>ä¸€ä¸ªå¸¸è§çš„ Android ç¤ºä¾‹æ˜¯åœ¨ Retrofit å®¢æˆ·ç«¯ä¸­è®¾ç½®ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå°†ä»¤ç‰Œé™„åŠ åˆ°ç½‘ç»œè°ƒç”¨ã€‚è·å–ä»¤ç‰Œå¯èƒ½éœ€è¦å‘èµ·ç½‘ç»œè°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è·å–ä»¤ç‰Œã€‚åŒæ—¶ï¼Œæ‹¦æˆªå™¨éœ€è¦ç»“æœæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªæ‹¦æˆªå™¨åœ¨ Retrofit çš„æ± ä¸­å¯åŠ¨ï¼Œå› æ­¤å¯ä»¥è°ƒç”¨å®ƒçš„è°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒæˆä¸ºä½¿ç”¨ <code>runBlocking</code> çš„ç†æƒ³åœºæ‰€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddTokenInterceptor</span><span class="p">:</span> <span class="n">Interceptor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">Interceptor</span><span class="p">.</span><span class="n">Chain</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getToken</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">request</span><span class="p">().</span><span class="n">newBuilder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Bearer $token&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨åç«¯ç³»ç»Ÿä¸Šï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ä»¥ç­‰å¾…åç¨‹å®Œæˆï¼Œä¾‹å¦‚ä¸ºäº†è®©æˆ‘ä»¬çš„å·¥å…·æ­£ç¡®æµ‹é‡æ­¤è¿›ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œæˆ–è€…å½“æˆ‘ä»¬éœ€è¦è°ƒç”¨æŸäº›é˜»å¡è„šæœ¬å¹¶è·å–å…¶ç»“æœæ—¶ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@MeasureExecutionTime</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">runDataMigrationScript</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">sourceData</span> <span class="p">=</span> <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">transformedData</span> <span class="p">=</span> <span class="n">transformData</span><span class="p">(</span><span class="n">sourceData</span><span class="p">)</span>
</span><span class='line'>    <span class="n">writeDataToTarget</span><span class="p">(</span><span class="n">transformedData</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™äº›æƒ…å†µå¾ˆå°‘è§ï¼Œå¤§å¤šæ•°åç«¯é¡¹ç›®ä¸éœ€è¦ä½¿ç”¨ <code>runBlocking</code>ã€‚é™¤éå®ƒä»¬æœ‰ä¸€äº›åŸºäºé˜»å¡è°ƒç”¨çš„é—ç•™ä»£ç ã€‚è€ƒè™‘ä»¥ä¸‹ <code>UserService</code>ï¼Œå®ƒåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ç”¨äºç®¡ç†ç”¨æˆ·ã€‚æˆ‘ä»¬å·²ç»å°†å…¶è¿ç§»åˆ°æš‚åœè°ƒç”¨ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰ä¸€äº›åŸºäºé˜»å¡è°ƒç”¨çš„é—ç•™æ§åˆ¶å™¨å’ŒæœåŠ¡ã€‚ä¸ºäº†é¿å…é‡å†™æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæš‚åœå‡½æ•°æä¾›é˜»å¡æ›¿ä»£æ–¹æ¡ˆã€‚è¿™äº›æ›¿ä»£æ–¹æ¡ˆå¯ä»¥é€šè¿‡ä½¿ç”¨ <code>runBlocking</code> åŒ…è£…æš‚åœå‡½æ•°æ¥å®ç°ï¼ˆä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›è°ƒåº¦å™¨ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserService</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">userRepository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Blocking alternative for legacy parts of our application</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">findUserByIdBlocking</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å¯èƒ½æ˜¯ <code>runBlocking</code> æœ€é‡è¦çš„ç”¨é€”ï¼Œå®ƒå……å½“äº†ä»é˜»å¡åˆ°æš‚åœçš„æ¡¥æ¢ã€‚ä¸€äº›åº“ä¸º Java å®šä¹‰äº†é˜»å¡æ›¿ä»£æ–¹æ¡ˆã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">readDataFromSource</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">readDataFromSourceBlocking</span><span class="p">():</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#where-not-to-use-runblocking">å“ªäº›æƒ…å†µä¸‹ä¸åº”ä½¿ç”¨ <code>runBlocking</code></a></h2>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸åº”ä½¿ç”¨ <code>runBlocking</code>ã€‚æ­¤å¤–ï¼Œåˆ‡å‹¿åœ¨æŒ‚èµ·å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>runBlocking</code>ã€‚<code>runBlocking</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå› æ­¤ä¸åº”åœ¨æŒ‚èµ·å‡½æ•°ä¸­è¿›è¡Œé˜»å¡è°ƒç”¨ï¼ˆé™¤éä½¿ç”¨å…è®¸é˜»å¡è°ƒç”¨çš„è°ƒåº¦ç¨‹åºï¼Œä¾‹å¦‚ <code>Dispatchers.IO</code>ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆå¯èƒ½ä¸éœ€è¦ <code>runBlocking</code>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// runBlocking is most likely not needed</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸åº”åœ¨ä¸éœ€è¦ç­‰å¾…ç»“æœçš„å‡½æ•°ä¸­ä½¿ç”¨ <code>runBlocking</code>ã€‚å¦‚æœä½ åªéœ€è¦å¯åŠ¨åç¨‹ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨ <code>launch</code> å¯åŠ¨å¼‚æ­¥åç¨‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking used where we do not need to await result</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜åº”æ³¨æ„ï¼Œä¸è¦åœ¨ä¸åº”è¢«é˜»å¡çš„çº¿ç¨‹ä¸Šä½¿ç”¨ <code>runBlocking</code>ã€‚è¿™åœ¨ Android ä¸Šå°¤å…¶æˆé—®é¢˜ï¼Œå› ä¸ºé˜»å¡ä¸»çº¿ç¨‹ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå¡æ­»ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking on the main thread</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨åç«¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>synchronized</code> å—ä¸­ä½¿ç”¨å®ƒï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ä¸€ä¸ªæŠ€å·§æ˜¯ä½¿ç”¨ <code>launch</code> å®ç°å›è°ƒå‡½æ•°ã€‚ä½†æ˜¯ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæœ€å¥½é‡æ–°è®¾è®¡ä»£ç ï¼Œä½¿ç”¨æš‚åœè€Œä¸æ˜¯é˜»å¡è°ƒç”¨ï¼Œå¹¶ä½¿ç”¨åç¨‹å‹å¥½çš„å·¥å…·ï¼ˆæˆ‘ä»¬å°†åœ¨<em>åŒæ­¥åç¨‹</em>è¯¾ç¨‹ä¸­è®¨è®ºï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Possibly incorrect: runBlocking inside synchronized block</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getUser</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// One solution: use launch to implement a callback</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>        <span class="n">callback</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">getUser</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#outdated-runblocking-uses">è¿‡æ—¶çš„ <code>runBlocking</code> ç”¨æ³•</a></h2>

<p><code>runBlocking</code> ä¼ ç»Ÿä¸Šç”¨äºåŒ…è£… <code>main</code> å‡½æ•°ä½“ã€‚å®ƒçš„å±æ€§éå¸¸é€‚åˆæ­¤ç›®çš„ï¼šå®ƒå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å®ƒå¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°æˆ–å¯åŠ¨å…¶ä»–åç¨‹ï¼Œå¹¶ä¸”å®ƒä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç¡®ä¿ç¨‹åºä¸ä¼šåœ¨æ‰€æœ‰è¿™äº›è¿›ç¨‹å®Œæˆä¹‹å‰ç»“æŸã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> ä»ç„¶å¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°ç°ä»£æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢ä½¿ç”¨ Kotlin 1.3 ä¸­å¼•å…¥çš„æŒ‚èµ· <code>main</code> å‡½æ•°ã€‚æ­¤ç±»å‡½æ•°åœ¨åº•å±‚è¢«ä¸€ä¸ªç±»ä¼¼äº <code>runBlocking</code> çš„é˜»å¡æ„å»ºå™¨åŒ…è£…ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…³é”®åŒºåˆ«åœ¨äº <code>runBlocking</code> è®¾ç½®äº†ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œä½¿å…¶æ‰€æœ‰å­åç¨‹åœ¨å…¶æ­£åœ¨ä½¿ç”¨çš„åŒä¸€çº¿ç¨‹ä¸Šè¿è¡Œã€‚æŒ‚èµ· main å‡½æ•°ä¸ä¼šè®¾ç½®è°ƒåº¦å™¨ï¼Œå› æ­¤å…¶å­åç¨‹é»˜è®¤åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚å¼•å…¥æ­¤æ›´æ”¹æ˜¯å› ä¸º <code>runBlocking</code> ä½¿ç”¨çš„å•çº¿ç¨‹è°ƒåº¦å™¨ç»å¸¸å¯¼è‡´æ„å¤–è¡Œä¸ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// main</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// DefaultDispatcher-worker-1</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> çš„ç¬¬äºŒä¸ªä¼ ç»Ÿç”¨é€”æ˜¯åœ¨æµ‹è¯•ä¸­ã€‚å®ƒè¢«ç”¨æ¥åŒ…è£…æµ‹è¯•ä¸»ä½“ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°å¹¶åœ¨å…¶ä¸­å¯åŠ¨åç¨‹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨ <code>kotlinx-coroutines-test</code> åº“ä¸­çš„ <code>runTest</code>ï¼Œå®ƒæ˜¯ <code>runBlocking</code> çš„ä¸€ä¸ªæ›´å¼ºå¤§ã€æ›´çµæ´»çš„æ›¿ä»£æ–¹æ¡ˆã€‚å®ƒå…è®¸æˆ‘ä»¬æ§åˆ¶æ—¶é—´ã€ç”Ÿæˆåå°ä½œç”¨åŸŸå¹¶è·Ÿè¸ªå­åç¨‹ä¸Šçš„å¼‚å¸¸ã€‚<code>runTest</code> å°†åœ¨<em>æµ‹è¯•åç¨‹</em>è¯¾ç¨‹ä¸­è®¨è®ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserRepositoryTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userRepository</span> <span class="p">=</span> <span class="n">InMemoryUserRepository</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userService</span> <span class="p">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">userRepository</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Test</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">testGetUser</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span> <span class="c1">// previously runBlocking</span>
</span><span class='line'>        <span class="c1">// given</span>
</span><span class='line'>        <span class="n">userRepository</span><span class="p">.</span><span class="n">hasUser</span><span class="p">(</span><span class="n">UserEntity</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">,</span> <span class="s">&quot;John Doe&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// when</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userService</span><span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// then</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></h2>

<ul>
<li><code>runBlocking</code> æ˜¯ä¸€ä¸ªé˜»å¡åç¨‹æ„å»ºå™¨ï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªåç¨‹å¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å®ƒå®Œæˆã€‚</li>
<li><code>runBlocking</code> æ˜¯ä»é˜»å¡ä¸–ç•Œ(blocking)åˆ°æŒ‚èµ·ä¸–ç•Œ(suspending)çš„æ¡¥æ¢ï¼Œå®ƒç”¨äºåœ¨éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆçš„åœ°æ–¹å¯åŠ¨åç¨‹ã€‚</li>
<li>å¦‚æœä½ éœ€è¦åœ¨é¡¹ç›®ä¸­é¢‘ç¹ä½¿ç”¨ <code>runBlocking</code>ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ç§ä»£ç å¼‚å‘³ã€‚åœ¨è®¾è®¡åˆç†çš„åŸºäºåç¨‹çš„é¡¹ç›®ä¸­ï¼Œåº”è¯¥å°½é‡å°‘ç”¨ï¼Œæˆ–è€…å¹²è„†ä¸ç”¨ã€‚</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android ViewModelæ•°æ®åŠ è½½ï¼šåŸºäºFlowæ¶æ„çš„æœ€ä½³å®è·µ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"/>
    <updated>2025-09-22T22:50:00+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒAndroid ViewModel Data Loading: Best Practices and Flow-Based Architectureã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://funkymuse.dev/posts/properly-load-data/">https://funkymuse.dev/posts/properly-load-data/</a>ï¼Œç”±FunkyMuseäº2025å¹´8æœˆ29æ—¥ã€‚</p></blockquote>

<p>Android å¼€å‘ä¸­çš„æ¶æ„è®¨è®ºç»å¸¸å¼•å‘æ¿€çƒˆçš„äº‰è®ºâ€”â€”æœ‰æ—¶è¤’è´¬ä¸ä¸€ã€‚æ’°å†™è¿™äº›ä¸»é¢˜çš„æ–‡ç« å¹¶ä¸å®¹æ˜“ï¼Œä½†è¿™æ­£æ˜¯å®ƒçš„ä»·å€¼æ‰€åœ¨ã€‚</p>

<p>æœ¬æ–‡é˜è¿°äº†æˆ‘å¯¹æ•°æ®åŠ è½½æ¨¡å¼çš„ç‹¬åˆ°è§è§£ï¼Œè¿™äº›è§è§£æºäºæˆ‘çš„ç»éªŒä»¥åŠè¿‘æœŸæ‰‹æœ¯åçš„æ¢å¤ï¼ˆå…¶ä¸­ä¸€æ¬¡æ‰‹æœ¯ä»åœ¨è¿›è¡Œä¸­ï¼‰ã€‚</p>

<p>ä¸å¦¨å°†æ­¤è§†ä¸ºæˆ‘åœ¨ 2025 å¹´å¯¹æ•°æ®åŠ è½½æ¨¡å¼çš„ç†è§£å’ŒæŠ€èƒ½çš„æ¦‚è¿°ã€‚</p>

<p>æˆ‘å¯èƒ½æ¯”å…¶ä»–äººæ›´æ™šåŠ å…¥è¿™åœºè®¨è®ºï¼Œä½†è¿Ÿåšæ€»æ¯”ä¸åšå¥½ã€‚</p>

<h2>æŒ‘æˆ˜ï¼šAndroid ViewModel ä¸­å¸¸è§çš„æ•°æ®åŠ è½½åæ¨¡å¼</h2>

<p>â€œå¤§å¤šæ•°â€Android å¼€å‘è€…ä½¿ç”¨ ViewModel æ¥ç®¡ç† UI çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ç”±è§†å›¾ï¼ˆFragmentã€Activity æˆ–å¯ç»„åˆç»„ä»¶ï¼‰æ”¶é›†ã€‚ä¸ºäº†æ˜¾ç¤ºæœ‰æ„ä¹‰çš„å†…å®¹ï¼Œä½ éœ€è¦ä»çœŸå®æ•°æ®æºåŠ è½½æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºè§†å›¾çŠ¶æ€ï¼Œç„¶åå…¬å¼€ä»¥ä¾›ä½¿ç”¨ã€‚</p>

<p>ä»¥å‰æ˜¯ LiveDataï¼Œç°åœ¨æ˜¯ Flowï¼Œå®ƒå……å½“è§†å›¾å’Œ ViewModel ä¹‹é—´çš„ç²˜åˆå‰‚ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹ï¼‰ã€‚æœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆä½¿ç”¨ <a href="https://github.com/cashapp/molecule">molecule</a>ï¼Œä½†è¿™è¶…å‡ºäº†æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"><img src="https://funkymuse.dev/assets/img/load_data/zhui.png" title="auto auto" ></a></p>

<!-- more -->


<p>æ­£å¦‚è¿™ç¯‡ <a href="https://x.com/github_skydoves/status/1829315087611707848">Twitter è®¨è®º</a> æ‰€ç¤ºï¼Œå¤§å¤šæ•°å¼€å‘è€…åœ¨ <code>ViewModel</code> çš„ init {} å—ä¸­åŠ è½½æ•°æ®ã€‚è™½ç„¶è¿™ç§æ–¹æ³•çœ‹ä¼¼åˆä¹é€»è¾‘ï¼Œä½†å®ƒå¸¦æ¥äº†ä¸€äº›æ¶æ„é—®é¢˜ï¼ŒIan Lake å’Œå…¶ä»–äººè®¤ä¸ºè¿™æ˜¯åæ¨¡å¼â€”â€”åŒ…æ‹¬ä½¿ç”¨ <code>LaunchedEffect</code> è¿›è¡Œæ•°æ®åŠ è½½ã€‚</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/jokes.png"><img src="https://funkymuse.dev/assets/img/load_data/jokes.png" alt="Irony" /></a></p>

<p>è®½åˆºçš„æ˜¯ï¼Œå³ä½¿æ˜¯å®˜æ–¹ç¤ºä¾‹æœ‰æ—¶ä¹Ÿä¼šä¸è¿™äº›æœ€ä½³åšæ³•ç›¸çŸ›ç›¾ï¼š</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/irony.png"><img src="https://funkymuse.dev/assets/img/load_data/irony.png" alt="Irony" /></a></p>

<h3>å¼€å‘è€…ä¸ºä½•é€‰æ‹© init {} å—ï¼ˆä»¥åŠå®ƒä¸ºä½•å­˜åœ¨é—®é¢˜ï¼‰</h3>

<p>ViewModel çš„ init {} å—çš„å¸å¼•åŠ›æ˜¾è€Œæ˜“è§â€”â€”å®ƒç¡®ä¿æ•°æ®åŠ è½½åœ¨é…ç½®æ›´æ”¹åä¾ç„¶æœ‰æ•ˆï¼Œä»è€Œé¿å…äº†ä¸å¿…è¦çš„ API è°ƒç”¨æˆ–æ•°æ®åº“è¯»å–ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä¹Ÿå¸¦æ¥äº†å››ä¸ªå…³é”®é—®é¢˜ï¼š</p>

<h4>é—®é¢˜ 1ï¼šå¯¼èˆªè¿”å›æ ˆå¤æ‚åŒ–</h4>

<p>ä½¿ç”¨ init {} è¿›è¡Œæ•°æ®åŠ è½½æ—¶ï¼Œè¿”å›åˆ°åŒ…å«ç°æœ‰ ViewModel çš„å±å¹•ä¸ä¼šè§¦å‘é‡æ–°åˆå§‹åŒ–ã€‚è¿™è¿«ä½¿å¼€å‘è€…åœ¨ onStart æˆ– onResume ä¸­æ·»åŠ å˜é€šé€»è¾‘æ¥æ£€æŸ¥æ•°æ®æ–°é²œåº¦ï¼Œä»è€Œåˆ›å»ºéš¾ä»¥ç»´æŠ¤çš„æ„å¤§åˆ©é¢æ¡å¼ä»£ç ã€‚</p>

<h4>é—®é¢˜ 2ï¼šè°ƒåº¦ç¨‹åºç«äº‰æ¡ä»¶</h4>

<p>åœ¨ init {} ä¸­åŠ è½½æ•°æ®é€šå¸¸ä½¿ç”¨ viewModelScopeï¼Œå®ƒåœ¨ Dispatchers.Main.immediate ä¸Šè¿è¡Œã€‚è¿™ç§å³æ—¶è°ƒåº¦ç¨‹åºå¯èƒ½ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶ï¼Œå³æ•°æ®å¤„ç†åœ¨ UI ç»„åˆä¹‹å‰å°±å·²å®Œæˆï¼Œå°¤å…¶æ˜¯åœ¨ Jetpack Compose åº”ç”¨ä¸­ã€‚</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/darkness.png"><img src="https://funkymuse.dev/assets/img/load_data/darkness.png" alt="Darkness" /></a></p>

<h4>é—®é¢˜ #3ï¼šæ•°æ®è¿‡æœŸé—®é¢˜</h4>

<p>ç°ä»£ CRUD åº”ç”¨ç¨‹åºéœ€è¦æ›´æ–°æ•°æ®ã€‚ç”¨æˆ·å¯èƒ½ä¼šä»å…¶ä»–å±å¹•è¿”å›ï¼Œæˆ–è€…åœ¨ç›¸å½“é•¿ä¸€æ®µæ—¶é—´åä»æš‚åœçŠ¶æ€æ¢å¤ã€‚<code>init {}</code> æ–¹æ³•æ²¡æœ‰æä¾›å†…ç½®çš„æ•°æ®æ–°é²œåº¦éªŒè¯æœºåˆ¶ã€‚</p>

<h4>é—®é¢˜ #4ï¼šæµ‹è¯•å›°éš¾</h4>

<p>æ¯æ¬¡è¿è¡Œæµ‹è¯•æ—¶ï¼Œä½ éƒ½å¿…é¡»æ„å»º ViewModel æ‰èƒ½æˆåŠŸè¿è¡Œè¯¥ç‰¹å®šæµ‹è¯•ç”¨ä¾‹çš„ <code>init {}</code> ä»£ç å—ã€‚</p>

<h2>åŸºäº Flow çš„è§£å†³æ–¹æ¡ˆï¼šå°†å†·æµè½¬æ¢ä¸ºçƒ­æµ</h2>

<p>è¯¥è§£å†³æ–¹æ¡ˆåˆ©ç”¨ Kotlin Flowsâ€”â€”å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨ StateFlow å’Œé€‚å½“çš„å…±äº«ç­–ç•¥å°†å†·æµè½¬æ¢ä¸ºçƒ­æµã€‚å¯ä»¥å°†å…¶è§†ä¸º Katy Perry çš„â€œHot N Coldâ€æ–¹æ³•ï¼Œä½†æ‰€æœ‰è¾¹ç¼˜æƒ…å†µçš„è¡Œä¸ºéƒ½æ˜¯å¯é¢„æµ‹çš„ã€‚</p>

<h3>æ„å»ºåŸºç¡€ï¼šç”¨ä¾‹å’Œ ViewModel ç»“æ„</h3>

<p><strong>è¯·æ³¨æ„ï¼Œæ­¤ä»£ç ä»…ç”¨äºæ¼”ç¤ºç›®çš„ï¼Œå¦‚ä½•æ„å»ºç”±ä½ å†³å®šï¼Œé™¤åŠ è½½éƒ¨åˆ†å¤–ï¼Œå¹¶éæœ€ä½³å®è·µ</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">provideFactory</span><span class="p">(</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">creator</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span>
</span><span class='line'><span class="p">)</span> <span class="p">=</span> <span class="n">viewModelFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">initializer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">creator</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>æ³¨æ„ï¼šæ­¤å·¥å‚æ¨¡å¼ä»…ç”¨äºæ¼”ç¤ºç›®çš„</em></p>

<p>æˆ‘ä»¬çš„ç”¨ä¾‹å¤„ç†æ•°æ®æ£€ç´¢ã€æ ¼å¼åŒ–å’Œä¸šåŠ¡é€»è¾‘è½¬æ¢ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">GetUserDetailsUseCase</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">authRepository</span><span class="p">:</span> <span class="n">AuthRepository</span> <span class="p">=</span> <span class="n">AuthRepository</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dispatcher</span><span class="p">:</span> <span class="n">CoroutineDispatcher</span> <span class="p">=</span> <span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">billingCache</span><span class="p">:</span> <span class="n">BillingCache</span> <span class="p">=</span> <span class="n">BillingCache</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dateFormatter</span><span class="p">:</span> <span class="n">DateFormatter</span> <span class="p">=</span> <span class="n">DataFormatter</span><span class="p">()</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">withContext</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetailsResponseModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">authRepository</span><span class="p">.</span><span class="n">getUserDetails</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">userDetails</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">details</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">creationDate</span> <span class="p">=</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">format</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">details</span><span class="p">.</span><span class="n">creationDate</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">DateFormatter</span><span class="p">.</span><span class="n">Format</span><span class="p">.</span><span class="n">UTC_SHORT</span>
</span><span class='line'>                    <span class="p">).</span><span class="n">getOrNull</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">avatar</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isPremium</span> <span class="p">=</span> <span class="n">billingCache</span><span class="p">.</span><span class="n">isPremium</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">email</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">email</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">create</span><span class="p">()</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤ç”¨ä¾‹å°è£…äº†ä»å­˜å‚¨åº“æ£€ç´¢æ•°æ®ã€æ—¥æœŸæ ¼å¼åŒ–ã€é«˜çº§çŠ¶æ€éªŒè¯ä»¥åŠå‡†å¤‡ç”¨æˆ·ä¿¡æ¯ä»¥ä¾›æ˜¾ç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span>
</span><span class='line'>            <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªå…³é”®ä¼˜åŠ¿ï¼š</p>

<ul>
<li><strong>æ•°æ®æ–°é²œåº¦</strong>ï¼š5 ç§’è¶…æ—¶æ—¶é—´ä¸ Android çš„ ANR é˜ˆå€¼ä¸€è‡´ï¼Œç¡®ä¿åœ¨è¶…æ—¶åæ”¶é›†å™¨é‡æ–°å‡ºç°æ—¶æ•°æ®èƒ½å¤Ÿåˆ·æ–°ã€‚</li>
<li><strong>é…ç½®å˜æ›´å¤„ç†</strong>ï¼šåœ¨è¶…æ—¶çª—å£å†…ï¼Œå³ä½¿é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œæ•°æ®ä¹Ÿèƒ½æŒä¹…ä¿å­˜ã€‚</li>
<li><strong>èµ„æºæ•ˆç‡</strong>ï¼šé¿å…ä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨ï¼Œä»¥å®ç°å¿«é€Ÿå¯¼èˆªæ¨¡å¼ã€‚</li>
</ul>


<p><em>ä¸“ä¸šæç¤ºï¼šå¯¹äºéœ€è¦å®æ—¶æ•°æ®æ–°é²œåº¦çš„åº”ç”¨ç¨‹åºï¼Œè¯·å°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 0</em></p>

<h3>æ·»åŠ ç”¨æˆ·äº¤äº’ï¼šå®ç°åˆ·æ–°åŠŸèƒ½</h3>

<p>å®é™…åº”ç”¨ç¨‹åºéœ€è¦ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„æ•°æ®åˆ·æ–°åŠŸèƒ½ã€‚äº§å“ç»ç†å–œæ¬¢æ»‘åŠ¨åˆ·æ–°ï¼Œä½†æˆ‘ä»¬çš„åŸºæœ¬æµç¨‹æ— æ³•é€‚åº”è¿™ç§æ¨¡å¼ã€‚è®©æˆ‘ä»¬æ¥å¢å¼ºæˆ‘ä»¬çš„æ¶æ„ï¼š</p>

<p>æˆ‘ä»¬ä½¿ç”¨åœ¨ä¸»æµç¨‹æ”¶é›†å™¨ä¸­è§¦å‘çš„ <code>MutableSharedFlow</code> æ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®Œç¾ï¼æˆ‘ä»¬æˆåŠŸé‡æ„äº†é‡å¤çš„æ•°æ®åŠ è½½é€»è¾‘ï¼Œå¹¶å®ç°äº†åˆ·æ–°åŠŸèƒ½ã€‚ç„¶è€Œï¼Œè¿™è¿˜ä¸ç®—å®Œã€‚</p>

<h3>ä¼˜åŒ–çŠ¶æ€ç®¡ç†ï¼šæ¶ˆé™¤å†—ä½™çŠ¶æ€è¾“å‡º</h3>

<p>ä¸ºäº†é¿å…ä¸å¿…è¦çš„ UI æ›´æ–°ï¼Œæˆ‘ä»¬å°†æ·»åŠ  <code>distinctUntilChanged()</code> æ¥è¿‡æ»¤é‡å¤çš„çŠ¶æ€è¾“å‡ºã€‚</p>

<h3>å¤„ç†å¤æ‚çš„çŠ¶æ€æ›´æ–°</h3>

<p>å¯¹äºæ„å›¾ä¿®æ”¹ UI çŠ¶æ€è€Œä¸éœ€è¦é‡æ–°åŠ è½½æ•°æ®çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æµç¨‹æ“ä½œä¸­è®¿é—®å½“å‰çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œåˆ‡æ¢ç”µå­é‚®ä»¶å¯è§æ€§â€”â€”è¿™éœ€è¦ä¿®æ”¹çŠ¶æ€è€Œä¸æ˜¯é‡æ–°åŠ è½½æ•°æ®ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateParameters</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//do some changes here</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œçš„æŒ‘æˆ˜åœ¨äºå¦‚ä½•åœ¨æµç¨‹ä¸­è®¿é—®å½“å‰çŠ¶æ€ã€‚è®©æˆ‘ä»¬é€šè¿‡å†…éƒ¨è·Ÿè¸ªçŠ¶æ€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>æ™ºèƒ½æ•°æ®ç¼“å­˜ï¼šæ¡ä»¶åŠ è½½ç­–ç•¥</h3>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°å¤æ‚çš„ç¼“å­˜è¡Œä¸ºäº†ã€‚ç”±äº <code>currentState</code> åœ¨ ViewModel ç”Ÿå‘½å‘¨æœŸå†…æŒç»­å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å‘å‡ºç¼“å­˜æ•°æ®ï¼Œå¹¶ä»…åœ¨å¿…è¦æ—¶æœ‰æ¡ä»¶åœ°åŠ è½½æ–°æ•°æ®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//i added error check just because this is for demonstration of this edge case</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤æ¨¡å¼æä¾›æ™ºèƒ½ç¼“å­˜â€”â€”å³ä½¿åœ¨ 5 ç§’è¶…æ—¶åï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©æ˜¯å¦é‡æ–°è·å–æ•°æ®ï¼š</p>

<ul>
<li><strong>æ˜‚è´µçš„ API è°ƒç”¨</strong>ï¼šåœ¨ ViewModel ä¸­ç¼“å­˜æ•°æ®ä»¥å‡å°‘ç½‘ç»œå¼€é”€</li>
<li><strong>é™æ€åç«¯æ•°æ®</strong>ï¼šé¿å…å¯¹å¾ˆå°‘æ›´æ”¹çš„ä¿¡æ¯è¿›è¡Œä¸å¿…è¦çš„è¯·æ±‚</li>
<li><strong>å®æ—¶éœ€æ±‚</strong>ï¼šå¼ºåˆ¶åˆ·æ–°éœ€è¦æ›´æ–°æ•°æ®çš„åº”ç”¨ç¨‹åº</li>
</ul>


<h3>åˆ›å»ºå¯å¤ç”¨çš„æŠ½è±¡</h3>

<p>é‡å¤ç¼–å†™æ­¤æ¨¡å¼ä¼šå˜å¾—éå¸¸ç¹çã€‚è®©æˆ‘ä»¬ä» ViewModel æ‰©å±•å‡½æ•°å¼€å§‹ï¼Œåˆ›å»ºå¯å¤ç”¨çš„æŠ½è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshMechanism</span><span class="p">:</span> <span class="n">SharedFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshMechanism</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh mechanism but no way to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshMechanism</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh data but no mechanism to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshMechanism</span><span class="o">?.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">refreshData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ‰äº†æˆ‘ä»¬æŠ½è±¡çš„æ‰©å±•å‡½æ•°ï¼ŒViewModel å˜å¾—æ›´åŠ ç®€æ´ï¼š</p>

<p><em>æ³¨æ„ï¼šæ­¤æŠ½è±¡æ¶µç›–äº† 90% çš„å¸¸è§ç”¨ä¾‹ï¼Œä½†ä¸æ”¯æŒå¤æ‚çš„æµç¨‹é“¾å¼æ“ä½œ</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">refreshMechanism</span> <span class="p">=</span> <span class="n">refreshListener</span><span class="p">,</span>
</span><span class='line'>        <span class="n">refreshData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºæ›´å¤æ‚çš„åŸºç±»æ¥æ¶ˆé™¤é‡å¤çš„ <code>refreshListener</code> å£°æ˜ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">ViewModelLoader</span><span class="p">&lt;</span><span class="n">State</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Intent</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Trigger</span> <span class="p">:</span> <span class="n">Any</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_trigger</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Trigger</span><span class="p">&gt;()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>        <span class="n">triggerData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5000L</span><span class="p">,</span> <span class="c1">//matching ANR timeout in Android</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">triggerData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_trigger</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">triggerParams</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">triggerData</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>                <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>                <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">abstract</span> <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">currentState</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">open</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">Intent</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">fun</span> <span class="nf">sendTrigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_trigger</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬çš„æœ€ç»ˆå®ç°å°†å˜å¾—éå¸¸ç®€æ´ä¸”æ˜“äºç»´æŠ¤ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModelLoader</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">triggerData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å¤„ç† UI çŠ¶æ€å¤æ‚æ€§</h3>

<p>æ­¤æŠ½è±¡ä½¿ç”¨å¸ƒå°”æ ‡å¿—ï¼ˆ<code>isLoading</code>ã€<code>isError</code>ï¼‰ï¼Œè¿™äº›æ ‡å¿—å¯èƒ½ä¼šåˆ›å»ºæ¨¡ç³ŠçŠ¶æ€ã€‚ä¸ºäº†æ›´æ¸…æ™°åœ°ç®¡ç†çŠ¶æ€ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¯†å°ç±»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">UIState</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Success</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Error</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Idle</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¯¹äºéœ€è¦åŒæ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆä¾‹å¦‚ Snackbarsï¼‰å’Œç°æœ‰æ•°æ®çš„åœºæ™¯ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´å¤æ‚çš„çŠ¶æ€æŒæœ‰è€…ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UIStateHolder</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">UIState</span> <span class="p">=</span> <span class="n">UIState</span><span class="p">.</span><span class="n">Idle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">payload</span><span class="p">:</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•å¯ä»¥å®ç°çµæ´»çš„ UI çŠ¶æ€ç®¡ç†ï¼ŒåŒæ—¶ä¿æŒ UI çŠ¶æ€å’Œæ•°æ®è´Ÿè½½ä¹‹é—´çš„æ˜ç¡®åˆ†ç¦»ï¼Œä½†å¯èƒ½ä¼šå¢åŠ è®¤çŸ¥è´Ÿè·ï¼Œå¹¶å¼•å…¥æ›´å¤šçš„æ˜ å°„è¡Œä¸ºå’Œè§£åŒ…é€»è¾‘ã€‚</p>

<h3>è¶…è¶Š ViewModel</h3>

<p>æ­¤æ¨¡å¼ä¸ä»…é™äº ViewModelã€‚é€šè¿‡æä¾›è‡ªå®šä¹‰åç¨‹ä½œç”¨åŸŸï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶ï¼ˆå¯ç»„åˆç»„ä»¶ã€å­˜å‚¨åº“æˆ–ä¸šåŠ¡é€»è¾‘å±‚ï¼‰ä¸­ä½¿ç”¨æ­¤æ•°æ®åŠ è½½æ–¹æ³•ã€‚</p>

<h2>æµç»„åˆæ¨¡å¼</h2>

<p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹è¿˜åœ¨äºå¯ä»¥ç»„åˆå¤šä¸ªæ•°æ®æºã€‚ä»¥ä¸‹æ˜¯å¤„ç†å•æµå’ŒåŒæµçš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span>
</span><span class='line'>        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">newValue</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">transform</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»„åˆåŒæµçš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T1</span><span class="p">,</span> <span class="k">reified</span> <span class="n">T2</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow1</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T1</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">flow2</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T2</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue1</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span> <span class="n">newValue2</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">combine</span><span class="p">(</span><span class="n">flow1</span><span class="p">,</span> <span class="n">flow2</span><span class="p">)</span> <span class="p">{</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">transform</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™äº›æ‰©å±•å…è®¸ä½ è½»æ¾ç»„åˆå¤šä¸ªæ•°æ®æºï¼ŒåŒæ—¶ä¿æŒç›¸åŒçš„æ™ºèƒ½ç¼“å­˜å’ŒçŠ¶æ€ç®¡ç†åŸåˆ™ã€‚</p>

<h3>æµ‹è¯•åŸºäºæµçš„ ViewModel</h3>

<p>åœ¨ç»“æŸä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¢ç´¢å¦‚ä½•ä½¿ç”¨ fakes å’Œ Turbine è¿›è¡Œæµæµ‹è¯•ï¼Œæ­£ç¡®åœ°æµ‹è¯•æˆ‘ä»¬çš„ <code>UserAccountDetailsViewModel</code> å®ç°ã€‚</p>

<h4>ä½¿ç”¨ Fakes å’Œ Turbine è®¾ç½®æµ‹è¯•ä¾èµ–é¡¹</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@OptIn</span><span class="p">(</span><span class="n">ExperimentalCoroutinesApi</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccountDetailsViewModelTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">testDispatcher</span> <span class="p">=</span> <span class="n">StandardTestDispatcher</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">fakeGetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">FakeGetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">UserAccountDetailsViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Before</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">setMain</span><span class="p">(</span><span class="n">testDispatcher</span><span class="p">)</span>
</span><span class='line'>        <span class="n">viewModel</span> <span class="p">=</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@After</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">resetMain</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fake implementation for realistic testing, this sounds funny to write haha</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FakeGetUserDetailsUseCase</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">userDetailsToReturn</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setSuccessResponse</span><span class="p">(</span><span class="n">userDetails</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="n">userDetails</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setErrorResponse</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Expose execution count when testing caching/performance behavior</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getExecutionCount</span><span class="p">()</span> <span class="p">=</span> <span class="n">executionCount</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span><span class="p">++</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span> <span class="c1">// Simulate network delay</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">shouldReturnError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Network error&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">userDetailsToReturn</span> <span class="o">?:</span> <span class="n">createDefaultUserDetails</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createDefaultUserDetails</span><span class="p">()</span> <span class="p">=</span> <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>        <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;default@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æˆåŠŸå’Œå¤±è´¥åœºæ™¯çš„å‚æ•°åŒ–æµ‹è¯•</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@ParameterizedTest</span>
</span><span class='line'><span class="n">@ValueSource</span><span class="p">(</span><span class="n">booleans</span> <span class="p">=</span> <span class="p">[</span><span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">])</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">handle</span> <span class="n">both</span> <span class="n">success</span> <span class="n">and</span> <span class="n">error</span> <span class="n">scenarios</span><span class="err">`</span><span class="p">(</span><span class="n">shouldSucceed</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;success@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Focus on behavior, not implementation details</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">successState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;success@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">userInfo</span><span class="p">).</span><span class="n">isNull</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">refresh</span> <span class="n">data</span> <span class="k">when</span> <span class="n">refresh</span> <span class="n">intent</span> <span class="k">is</span> <span class="n">triggered</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial successful load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;initial@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2022-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">initialState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">initialState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;initial@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Change response and trigger refresh</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;refreshed@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://new-avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">refreshedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// New Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;refreshed@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Verify both initial load and refresh were called</span>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•ä»… UI çŠ¶æ€å˜åŒ–</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">toggle</span> <span class="n">email</span> <span class="n">visibility</span> <span class="n">without</span> <span class="n">triggering</span> <span class="n">data</span> <span class="n">reload</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Successful initial load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;test@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">loadedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Toggle email visibility</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="k">true</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">toggledState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•æ•°æ®ç¼“å­˜è¡Œä¸º</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">use</span> <span class="n">cached</span> <span class="n">data</span> <span class="k">when</span> <span class="n">returning</span> <span class="n">to</span> <span class="n">screen</span> <span class="n">quickly</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;cached@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When First collection</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">firstState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">firstState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cancel</span><span class="p">()</span> <span class="c1">// Simulate leaving screen</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When Quick return (simulating navigation back within timeout)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should have cached data immediately (no Loadin)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">cachedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">expectNoEvents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•é”™è¯¯æ¢å¤</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">recover</span> <span class="n">from</span> <span class="n">Error</span> <span class="n">on</span> <span class="n">successful</span> <span class="n">refresh</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial error</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Error</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Fix the response and refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;recovered@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should recover successfully</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">recoveredState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;recovered@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ä¸ºä»€ä¹ˆè¦æµ‹è¯•åŸºäºæµçš„ ViewModel çš„åŸåˆ™</h3>

<p>å“¦â€¦â€¦è¿™å¯èƒ½ä¼šå¼•å‘ä¸€äº›äº‰è®ºï¼Œä½†è¿™é‡Œæœ‰ä¸€ç¯‡å¾ˆæ£’çš„æ–‡ç« ï¼Œå®ƒæä¾›äº†æ›´å¥½çš„æè¿°ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“æœ¬æ–‡å…³äºæˆ‘ä¸ºä»€ä¹ˆä½¿ç”¨ Fakes çš„ç›®çš„ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç®€çŸ­çš„æ€»ç»“ï¼Œå¯ä»¥è¡¥å……æ–‡ç« é¡¶éƒ¨</p>

<ol>
<li><strong>ä½¿ç”¨ Fakes è€Œé Mocks</strong>ï¼šFake æä¾›é€¼çœŸçš„è¡Œä¸ºï¼Œå¹¶ä¸”æ›´æ˜“äºç»´æŠ¤ï¼Œå°¤å…¶æ˜¯åœ¨å¦‚ä»Š LLM çš„å¸®åŠ©ä¸‹â€¦â€¦</li>
<li><strong>å‚æ•°åŒ–æµ‹è¯•</strong>ï¼šç”¨ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åŒæ—¶æµ‹è¯•æˆåŠŸå’Œå¤±è´¥è·¯å¾„</li>
<li><strong>ä½¿ç”¨ Turbine è¿›è¡Œæµç¨‹æµ‹è¯•</strong>ï¼šç®€æ´ã€å¯Œæœ‰è¡¨ç°åŠ›çš„æµç¨‹æµ‹è¯•ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„çŠ¶æ€éªŒè¯</li>
<li><strong>æµ‹è¯•çŠ¶æ€è½¬æ¢</strong>ï¼šéªŒè¯å®Œæ•´çš„çŠ¶æ€æµç¨‹ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ€ç»ˆçŠ¶æ€</li>
<li><strong>è°¨æ…æ‰§è¡Œè®¡æ•°</strong>ï¼šä»…åœ¨æµ‹è¯•ç¼“å­˜ã€æ€§èƒ½æˆ–é‡è¯•è¡Œä¸ºæ—¶éªŒè¯è°ƒç”¨è®¡æ•°</li>
<li><strong>å…³æ³¨è¡Œä¸º</strong>ï¼šæµ‹è¯•ç”¨æˆ·ä½“éªŒï¼Œè€Œä¸æ˜¯å®ç°ç»†èŠ‚ï¼ˆæˆ‘æƒ³è¿™ä¸€ç‚¹æ˜¾è€Œæ˜“è§ï¼‰</li>
</ol>


<h3>ç»“è®º</h3>

<p>æœ¬æ–‡å¯¹ Android ViewModel ä¸­åŸºäºæµç¨‹çš„æ•°æ®åŠ è½½çš„æ¢ç´¢ï¼Œè§£å†³äº†ä¼ ç»Ÿ <code>init {}</code> å—æ–¹æ³•çš„æ ¹æœ¬æŒ‘æˆ˜ã€‚è™½ç„¶æ¶µç›–æ‰€æœ‰æ¶æ„å˜ä½“ä¼šå¾ˆç¹çï¼Œä½†è¯¥æ¨¡å¼æˆåŠŸå¤„ç†äº†å¤§çº¦ 90% çš„å¸¸è§ç”¨ä¾‹ã€‚</p>

<p>æŠ½è±¡åŸºç±»æ–¹æ³•ï¼ˆ<code>ViewModelLoader</code>ï¼‰æä¾›äº†æœ€å¯é¢„æµ‹å’Œå¯ç»´æŠ¤çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›ï¼š</p>

<ul>
<li><strong>å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†</strong>ï¼šæ¸…æ™°çš„çŠ¶æ€è§¦å‘å™¨å’Œæ„å›¾å¤„ç†</li>
<li><strong>å†…ç½®æµ‹è¯•æ”¯æŒ</strong>ï¼šå…·æœ‰é€‚å½“åç¨‹å¤„ç†çš„å¯æµ‹è¯•æ¶æ„</li>
<li><strong>çµæ´»æ€§</strong>ï¼šæ˜“äºæ‰©å±•æ•ˆæœå’Œæ··åˆ MVI æ¨¡å¼</li>
<li><strong>ç¼“å­˜å’Œåˆ·æ–°</strong>ï¼šç¼“å­˜å’Œåˆ·æ–°æœºåˆ¶ï¼ˆæœ¬æ–‡å°†å°½å¯èƒ½è¯¦ç»†åœ°ä»‹ç»ï¼‰</li>
</ul>


<h3>å…³é”®è¦ç‚¹</h3>

<ol>
<li><strong>åŸºäºæµçš„åŠ è½½</strong>æ¶ˆé™¤äº†ç«äº‰æ¡ä»¶ï¼Œæé«˜äº†æµ‹è¯•çš„ç®€æ˜“æ€§ï¼Œå¹¶è§£å†³äº† <code>init {}</code> å—ä¸­å›ºæœ‰çš„å›æ ˆé—®é¢˜</li>
<li><strong>å…·æœ‰é€‚å½“å…±äº«ç­–ç•¥çš„ StateFlow</strong> æä¾›äº†æœ€ä½³çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥æ•°æ®ç®¡ç†</li>
<li><strong>æŠ½è±¡å±‚</strong>å‡å°‘äº†æ ·æ¿ä»£ç ï¼ŒåŒæ—¶ä¿æŒäº†çµæ´»æ€§</li>
<li><strong>å…¨é¢çš„æµ‹è¯•</strong>ç¡®ä¿æ‰€æœ‰ç”¨ä¾‹çš„å¯é æ€§</li>
</ol>


<p>è¯·è®°ä½ï¼Œè¿™åªæ˜¯ä¼—å¤šæ¶æ„æ–¹æ³•ä¸­çš„ä¸€ç§ï¼Œå®ƒè§£å†³äº†æˆ‘çš„é—®é¢˜ï¼Œä½†å¯èƒ½æ— æ³•è§£å†³ä½ çš„é—®é¢˜ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯äº†è§£æ½œåœ¨é—®é¢˜å¹¶è¯„ä¼°æ­¤è§£å†³æ–¹æ¡ˆæ˜¯å¦ç¬¦åˆä½ çš„ç‰¹å®šéœ€æ±‚ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå°†ç»å†è®¸å¤šå˜åŒ–ï¼Œç”šè‡³å¯èƒ½è¢«æ·˜æ±°ã€‚æœ€è¿‘ï¼Œæˆ‘æ›´å¤šåœ°æŠ•å…¥åˆ°ä½¿ç”¨ Ktor è¿›è¡Œåç«¯å¼€å‘ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€æ¬¡å¾ˆæ£’çš„ä½“éªŒã€‚</p>

<p>è¯¥æ¶æ„æˆåŠŸåœ°ä¸º iOS å’Œ Android å¹³å°ä¸Šçš„ <a href="https://wallhub.app/">WallHub</a> æä¾›äº†æ”¯æŒï¼Œè¯æ˜äº†å…¶åœ¨ç°å®ä¸–ç•Œä¸­çš„â€œå¯è¡Œæ€§â€ä»¥åŠè·¨å¹³å°é€‚åº”æ€§ï¼ˆå¦‚æœå¯ä»¥è¿™ä¹ˆè¯´çš„è¯ï¼‰ã€‚</p>

<p>ç»§ç»­æ½œæ°´ï¼Œç›´åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« â€¦â€¦</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Androidåº”ç”¨çš„æ¶æ„æ¼”è¿›]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"/>
    <updated>2025-09-13T20:34:01+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒArchitectural Evolution of and Android appã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://herrbert74.github.io/posts/architectural-evolution-of-an-app/">https://herrbert74.github.io/posts/architectural-evolution-of-an-app/</a>ï¼Œç”±Zsolt Bertalanå‘å¸ƒäº20258æœˆ19æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"><img src="https://herrbert74.github.io/assets/img/posts/20250818_arch_evolution.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>æœ¬æ–‡å°†è§£é‡Š Android åº”ç”¨åœ¨å‘å±•è¿‡ç¨‹ä¸­å¯èƒ½ç»å†çš„å„ä¸ªé˜¶æ®µã€‚ä¸åŒçš„æ¶æ„å¯èƒ½çœ‹èµ·æ¥æˆªç„¶ä¸åŒï¼ˆæ›´ä¸ç”¨è¯´å¯¹ç»†èŠ‚çš„ä¸åŒçœ‹æ³•ï¼‰ï¼Œä½†å…¶èƒŒåçš„ç†å¿µæ˜¯ç›¸åŒçš„ã€‚æˆ‘å°†é€šè¿‡æ•´æ´æ¶æ„ (Clean Architecture) å’Œæˆ‘çš„ <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> ä»£ç åº“ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82</a></p>

<p>æˆ‘è¿˜æƒ³ä»‹ç»ä¸€ä¸‹å¤§å‹åº”ç”¨ä¸­çš„å¸¸è§æ¨¡å¼ï¼š<strong>è¶…çº§å±‚</strong> å’Œ <strong>åŠŸèƒ½ç»„</strong>ã€‚æ¯å½“æˆ‘å¼€å‘çš„åº”ç”¨è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œéƒ½ä¼šç”¨åˆ°è¿™äº›æ¨¡å¼ï¼Œä½†æˆ‘ä»æœªåˆ¶å®šè¿‡ç›¸å…³çš„åŸºæœ¬è§„åˆ™ã€‚æˆ‘å¸Œæœ›æŠŠå®ƒä»¬å†™ä¸‹æ¥ï¼Œèƒ½è®©æˆ‘å’Œå…¶ä»–äººæ›´å®¹æ˜“ç†è§£ã€‚</p>

<h3>è¶…çº§å±‚</h3>

<p>ä½ å¯èƒ½è¿˜è®°å¾—æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼Œæˆ‘çš„åº”ç”¨æœ‰ä¸€ä¸ªç‹¬ç«‹çš„<strong>é¢†åŸŸå±‚</strong>ï¼Œ<strong>æ•°æ®å±‚å’Œå±•ç°å±‚ï¼ˆä»ç°åœ¨å¼€å§‹æ˜¯UIå±‚ï¼‰</strong>éƒ½ä¾èµ–äºå®ƒã€‚è¿™äº›æ˜¯åŸºæœ¬çš„æ°´å¹³å±‚ã€‚åŒ…å«å®ƒä»¬çš„å‚ç›´å±‚ä¹Ÿç§°ä¸ºåŠŸèƒ½å±‚ã€‚</p>

<p>æˆ‘åˆ›é€ äº† <strong>â€œè¶…çº§å±‚â€</strong> è¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸ºäº†åœ¨åŸºæœ¬æ°´å¹³å±‚ä¹‹ä¸Šå¼•å…¥ä¸€ä¸ªæ›´å¹¿æ³›çš„å±‚æ¬¡ç»“æ„ã€‚æˆ‘ä»¬éœ€è¦å®ƒä»¬ï¼Œå› ä¸ºæ°´å¹³å±‚çš„èŒƒå›´å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸ä»…å¯ä»¥æ¶µç›–åŠŸèƒ½å±‚ï¼Œè¿˜å¯ä»¥æ¶µç›–æ›´å¹¿æ³›çš„èŒƒå›´ã€‚æˆ‘å°†å®šä¹‰<strong>åŠŸèƒ½å±‚</strong>ã€<strong>åŠŸèƒ½ç»„</strong>ã€<strong>åº”ç”¨çº§ï¼ˆå…±äº«ï¼‰</strong>å’Œ<strong>å¤šåº”ç”¨çº§ï¼ˆåŸºç¡€ï¼‰</strong> è¶…çº§å±‚ã€‚</p>

<p>è¯·å‚é˜…ä¸‹å›¾ã€‚</p>

<p><img src="file:///Users/alexhilton/Downloads/arch-envolve-1.png" alt="" /></p>

<p>åœ¨æˆ‘ä¸Šé¢è§£é‡Šçš„åŸºæœ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰<strong>åŠŸèƒ½å±‚</strong>ï¼Œå…¶ä¸­æ•´æ´æ¶æ„å±‚ä»…åœ¨åŠŸèƒ½å±‚å†…éƒ¨å¯è§ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œ<strong>åŠŸèƒ½ç»„</strong>å±‚æ˜¯ä»‹äºåº”ç”¨èŒƒå›´å±‚å’ŒåŠŸèƒ½èŒƒå›´å±‚ä¹‹é—´çš„ä¸­é—´å±‚ã€‚ç”±äºå®ƒæ˜¯å¯¹è¶…çº§å±‚çš„æœ€åä¸”æœ€ä¸æ˜æ˜¾çš„è¡¥å……ï¼Œæˆ‘å°†åœ¨ç¨åè¯¦ç»†è®¨è®ºã€‚</p>

<p><strong>å…±äº«ã€é€šç”¨æˆ–åº”ç”¨èŒƒå›´å±‚</strong>é€šå¸¸åŒ…å«ä¸ä¸šåŠ¡ç›¸å…³æˆ–æ•´ä¸ªåº”ç”¨ç‹¬æœ‰çš„ç±»ã€‚è¿™æ˜¯å¯ä»¥æ·»åŠ é¢†åŸŸã€æ•°æ®å’Œ UI æ¨¡å—çš„æœ€ä½å±‚ã€‚</p>

<p><strong>åŸºç¡€å±‚ã€åŸºç¡€è®¾æ–½å±‚æˆ–åŸºç¡€ç»“æ„å±‚</strong>å¯ä»¥è·¨å¤šä¸ªåº”ç”¨ä½¿ç”¨ã€‚å®ƒä¸åŒ…å«é¢†åŸŸã€æ•°æ®æˆ– UI å±‚ï¼Œä½†åŒ…å«è¿™äº›å±‚ä¹‹é—´é€šç”¨çš„ç±»ã€‚æˆ‘é€šå¸¸æœ‰ä¸€ä¸ª<strong>Kotlin æ¨¡å—å’Œä¸€ä¸ª Android åŸºç¡€æ¨¡å—</strong>ã€‚æˆ‘åˆ›å»ºäº† <a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/">BaBeStudios-Base</a> åº“é¡¹ç›®ï¼ˆ<a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82">https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82</a> BaBeStudios-Base ä¹Ÿå¯ä» <a href="https://mvnrepository.com/artifact/io.bitbucket.babestudios">MavenCentral</a> è·å–ï¼Œä½†ç›®å‰å°šæ— ç›¸å…³æ–‡æ¡£ã€‚</p>

<p>éšç€åº”ç”¨ç¨‹åºè§„æ¨¡çš„æ‰©å¤§å’Œæ¨¡å—çš„å¼•å…¥ï¼Œä½ éœ€è¦å¼•å…¥ä¸Šè¿°å„å±‚ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹éšç€åº”ç”¨ç¨‹åºè§„æ¨¡çš„æ‰©å¤§ï¼Œæˆ‘é€šå¸¸é‡‡å–çš„æ¨¡å—åŒ–æ­¥éª¤ã€‚</p>

<h3>æ­¥éª¤ 1ï¼šå•æ¨¡å—</h3>

<p>å½“ä½ ç¡®å®šåº”ç”¨ç¨‹åºè§„æ¨¡ä¸ä¼šè¶…è¿‡<strong>æœ€å¤§è§„æ¨¡</strong>ï¼Œæˆ–è€…æ—¶é—´ç´§è¿«æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©å•æ¨¡å—åº”ç”¨ç¨‹åºæˆ–å•ä½“åº”ç”¨ã€‚æˆ‘ä¸ç¡®å®šå•æ¨¡å—åº”ç”¨ç¨‹åºçš„æœ€å¤§è§„æ¨¡æ˜¯å¤šå°‘ã€‚è¿™å¯èƒ½å› äººè€Œå¼‚ã€‚</p>

<p>æ­¤æœ€å¤§è§„æ¨¡ä¹Ÿä¸åŒäº<strong>é˜ˆå€¼è§„æ¨¡ï¼Œä½ åº”è¯¥ä»è¯¥é˜ˆå€¼å¼€å§‹æ¨¡å—åŒ–åº”ç”¨ç¨‹åº</strong>ï¼Œæˆ–è€…æ›´é€šä¿—åœ°è¯´ï¼Œä½ åº”è¯¥ä»è¯¥é˜ˆå€¼åˆ‡æ¢åˆ°æµç¨‹çš„ä¸‹ä¸€æ­¥ã€‚æˆ‘è®¤ä¸ºé˜ˆå€¼å¤§å°è¿œå°äºå•æ¨¡å—åº”ç”¨ç¨‹åºçš„æœ€å¤§å¤§å°ï¼Œè¿™æ„å‘³ç€ä½ åº”è¯¥åœ¨è¾¾åˆ°è¯¥é™åˆ¶ä¹‹å‰å°±å¼€å§‹æ¨¡å—åŒ–ã€‚</p>

<p>å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºï¼Œæˆ‘ç”šè‡³å»ºè®®<strong>ä»æ¨¡å—åŒ–å¼€å§‹</strong>ï¼Œè€Œä¸æ˜¯ä»å•ä¸ªæ¨¡å—å¼€å§‹ï¼Œå› ä¸ºä¸æ¥è¿‘é™åˆ¶ï¼ˆæ¯”å¦‚ 10 æˆ– 20 kLOCï¼‰æ—¶æ‰å¼€å§‹æ¨¡å—åŒ–ç›¸æ¯”ï¼Œè¿™æ ·åšçš„å¼€é”€å’Œå¹²æ‰°ç¨‹åº¦è¦å°å¾—å¤šã€‚</p>

<p>è¿™æ˜¯ä¸€ä¸ªå•æ¨¡å—åº”ç”¨ç¨‹åºçš„åŒ…æ ‘ç¤ºä¾‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”œâ”€â”€ data
</span><span class='line'>â”‚   â”œâ”€â”€ database
</span><span class='line'>â”‚   â”œâ”€â”€ <span class="nb">local</span>
</span><span class='line'>â”‚   â”œâ”€â”€ repository
</span><span class='line'>â”‚   â””â”€â”€ remote
</span><span class='line'>â”œâ”€â”€ domain
</span><span class='line'>â”‚   â”œâ”€â”€ api
</span><span class='line'>â”‚   â”œâ”€â”€ model
</span><span class='line'>â”‚   â””â”€â”€ usecase
</span><span class='line'>â”œâ”€â”€ presentation
</span><span class='line'>â”‚   â”œâ”€â”€ master
</span><span class='line'>â”‚   â””â”€â”€ detail
</span><span class='line'>â””â”€â”€ shared
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢å›¾ä¸­çš„å¶å­èŠ‚ç‚¹ä»£è¡¨åŒ…ï¼Œå®ƒä»¬å¯ä»¥åŒ…å«æ­¤å¤„æœªæ˜¾ç¤ºçš„å…¶ä»–åŒ…ã€‚ä¸‹é¢æˆ‘å°†å±•ç¤ºä¸€ä¸ªç±»ä¼¼çš„æ¨¡å—ç»“æ„ï¼Œå…¶ä¸­ä»¥å†’å·å¼€å¤´çš„åç§°ä»£è¡¨æ¨¡å—ï¼ŒåŒå†’å·ä»£è¡¨æ ¹æ¨¡å—ã€‚</p>

<h3>æ­¥éª¤ 2ï¼šç®€å•æ¨¡å—åŒ–</h3>

<p>å¯¹äº<strong>å°å‹åº”ç”¨ç¨‹åº</strong>ï¼Œæˆ‘ä½¿ç”¨ç®€å•æ¨¡å—åŒ–ï¼Œè€Œä¸æ˜¯ä¸‹ä¸€ç« çš„å®Œå…¨æ¨¡å—åŒ–ã€‚è¿™é‡Œæˆ‘ä»¬åªä»‹ç»<strong>æ¯ä¸ªåŠŸèƒ½çš„æ¨¡å—</strong>ã€‚æ¯ä¸ªåŠŸèƒ½å°†åŒ…å«ä¸€ä¸ªé¢†åŸŸæ¨¡å—ï¼Œä»¥åŠä¾èµ–äºé¢†åŸŸæ¨¡å—çš„æ•°æ®å’Œå‘ˆç°æ¨¡å—ï¼ˆåœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼‰ã€‚</p>

<p>æˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ä¸ª<strong>å…±äº«æ¨¡å—</strong>ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„é€šç”¨ä»£ç ã€‚</p>

<p>åº”ç”¨ç¨‹åºçš„è¶…å±‚ç”±ä¸€æ¡<strong>æ°´å¹³çº¿</strong>åˆ†éš”ã€‚æ¯ä¸ªå±‚éƒ½ä¾èµ–äºå…¶ä¸‹æ–¹çš„æ‰€æœ‰å±‚ã€‚æ•°æ®å’Œå‘ˆç°ä¾èµ–äºé¢†åŸŸæ¨¡å—ï¼Œä½†è¿™å¹¶æœªåœ¨å›¾ä¸­æ˜¾ç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>::feature:Feature A
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featurea/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featurea/:domain
</span><span class='line'>â””â”€â”€ :feature/:featurea/:presentation
</span><span class='line'>
</span><span class='line'>::feature:Feature B
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featureb/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featureb/:domain
</span><span class='line'>â””â”€â”€ :feature/:featureb/:presentation
</span><span class='line'>
</span><span class='line'> ::feature:Feature C
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featurec/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featurec/:domain
</span><span class='line'>â””â”€â”€ :feature/:featurec/:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::shared:data
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ database
</span><span class='line'>â”œâ”€â”€ <span class="nb">local</span>
</span><span class='line'>â”œâ”€â”€ repository
</span><span class='line'>â””â”€â”€ remote
</span><span class='line'>
</span><span class='line'>::shared:domain
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ api
</span><span class='line'>â”œâ”€â”€ model
</span><span class='line'>â””â”€â”€ usecase
</span><span class='line'>
</span><span class='line'>::shared:presentation
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ compose
</span><span class='line'>â”œâ”€â”€ design
</span><span class='line'>â””â”€â”€ util
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::base:kotlin
</span></code></pre></td></tr></table></div></figure>


<h3>æ­¥éª¤ 4ï¼šåŠŸèƒ½ç»„</h3>

<p>å½“ä½ çš„åº”ç”¨å®Œå…¨æ¨¡å—åŒ–åï¼Œå…±äº«å±‚ä¼šé€æ¸æˆä¸ºå•ä½“åº”ç”¨ï¼Œå¹¶æˆä¸ºæ„å»ºè¿‡ç¨‹ä¸­çš„<strong>ç“¶é¢ˆ</strong>ã€‚</p>

<p>æˆ‘ç»å¸¸åœ¨è¶…è¿‡ä¸€å®šè§„æ¨¡çš„åº”ç”¨ï¼ˆå¤§çº¦ 50 åˆ° 80 kLOCï¼‰æ—¶é‡åˆ°è¿™ç§æƒ…å†µã€‚ä½ éœ€è¦å…±äº«å¤ªå¤šå†…å®¹ï¼Œå› æ­¤ä½ çš„<strong>å…±äº«é¢†åŸŸæ¨¡å—å’Œå±•ç¤ºæ¨¡å—</strong>å˜å¾—è¿‡å¤§ã€‚ä½ å¼€å§‹æ³¨æ„åˆ°ï¼Œåœ¨æ‰€æœ‰å‚ç›´æ¨¡å—ä¹‹é—´å…±äº«ä»£ç ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸ºä½ åªæƒ³åœ¨ä¸¤ä¸ªæˆ–æœ€å¤šä¸‰ä¸ªæˆ–å››ä¸ªæ¨¡å—ä¹‹é—´å…±äº«ä»£ç ã€‚ä½ ä¼šå‘ç°è¶Šæ¥è¶Šå¤šçš„æ–°ä»£ç è¢«æ·»åŠ åˆ°è¿™äº›æ¨¡å—ä¸­ï¼Œè€Œ<strong>å¢é‡ç¼“å­˜</strong>çš„æ•ˆç‡è¶Šæ¥è¶Šä½ï¼Œå› ä¸ºä½ é¢‘ç¹åœ°ä¿®æ”¹ä»£ç ï¼Œå¯¼è‡´å®ƒä»¬å¤±æ•ˆã€‚</p>

<p>ä½ å¯èƒ½ä¼šè¯´ï¼Œå¯ä»¥é€šè¿‡é€‚å½“åœ°é‡æ„å’Œæ„å»ºåº”ç”¨ç¨‹åºï¼Œæˆ–è€…å¤åˆ¶ä¸€äº›ä»£ç æ¥é¿å…è¿™ç§æƒ…å†µï¼Œä½†è¿™å¯èƒ½æ¯”ä½ æƒ³è±¡çš„è¦éš¾ã€‚æˆ‘å‘ç°è¿™äº›å»ºè®®å¹¶æ²¡æœ‰èµ·åˆ°ä»€ä¹ˆå¸®åŠ©ä½œç”¨ã€‚æˆ–è€…ä½ å¯èƒ½æ‰‹å¤´æœ‰ä¸€ä¸ªé—ç•™åº”ç”¨ï¼Œæ²¡æœ‰æ—¶é—´å®Œç¾åœ°é‡æ„æ‰€æœ‰å†…å®¹ã€‚</p>

<p>æˆ‘ç›®å‰è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯è¯†åˆ«<strong>åŠŸèƒ½ç»„</strong>ï¼Œå³ä¸€ç»„å…·æœ‰å¤§é‡å…¬å…±ä¾èµ–é¡¹çš„åŠŸèƒ½ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥é€šè¿‡åˆ›å»º<strong>æ›´å…·å‡èšåŠ›</strong>çš„æ¨¡å—ï¼Œæ°´å¹³æ‹†åˆ†å…±äº«å±‚ä¸­çš„éƒ¨åˆ†ä»£ç ã€‚</p>

<p>æˆ‘æœ€è¿‘å¼€å‘çš„æ‰€æœ‰å¤§å‹åº”ç”¨ä¸­éƒ½æœ‰ä¸¤ä¸ªä¸åŒçš„åŠŸèƒ½ç»„ã€‚</p>

<p>ç¬¬ä¸€ä¸ªåŠŸèƒ½ç»„ä¸<strong>æ ¸å¿ƒä¸šåŠ¡</strong>åŠŸèƒ½ç›¸å…³ï¼šä¾‹å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å›´ç»•äº§å“åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ¨¡å—å›´ç»•äº§å“è¯¦æƒ…ï¼Œç¬¬ä¸‰ä¸ªæ¨¡å—å›´ç»•æ”¶è—äº§å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªåŠŸèƒ½ç»„å‘½åä¸º<strong>äº§å“</strong>ã€‚å¦ä¸€ä¸ªåŠŸèƒ½ç»„å›´ç»•<strong>æ”¯ä»˜ã€å¹¿å‘Šæˆ–è®¢é˜…</strong>ï¼Œæˆ–è€…æœ‰æ—¶æ˜¯è¿™äº›åŠŸèƒ½çš„ç»„åˆã€‚è¿™å…³ç³»åˆ°åº”ç”¨çš„ç›ˆåˆ©æ–¹å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠŸèƒ½ç»„å‘½åä¸º<strong>â€œæ”¯ä»˜â€</strong>ã€‚</p>

<p>å¤§å‹åº”ç”¨ä¸­å¯èƒ½ä¼šæœ‰äº”ä¸ªæˆ–æ›´å¤šåŠŸèƒ½ç»„ã€‚æ¯ä¸ªåŠŸèƒ½ç»„å°†åŒ…å«é¢†åŸŸæ¨¡å—ã€æ•°æ®æ¨¡å—å’Œæ¼”ç¤ºæ¨¡å—ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>feature/Feature A
</span><span class='line'>
</span><span class='line'>feature/Feature B
</span><span class='line'>
</span><span class='line'>feature/Feature C
</span><span class='line'>
</span><span class='line'>feature/Feature D
</span><span class='line'>
</span><span class='line'>feature/Feature E
</span><span class='line'>
</span><span class='line'>feature/Feature F
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:data
</span><span class='line'>
</span><span class='line'>:domain
</span><span class='line'>
</span><span class='line'>:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:kotlin-base
</span></code></pre></td></tr></table></div></figure>


<h3>ä½•æ—¶ä½¿ç”¨å“ªä¸€æ­¥ï¼Ÿ</h3>

<p>ä½ è‚¯å®šå¸Œæœ›å°†å•ä½“åº”ç”¨ç”¨äºæ°¸è¿œä¸ä¼šæŠ•å…¥ç”Ÿäº§æˆ–ä¸€æ¬¡æ€§ä½¿ç”¨çš„åº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥æ˜¯<strong>æ¦‚å¿µéªŒè¯</strong> (PoC, Proof of Concept) åº”ç”¨ç¨‹åºã€ç”¨äºç¬¬ä¸‰æ–¹é”™è¯¯çš„<strong>æœ€å°å¯å¤ç°ç¤ºä¾‹</strong> (MRE, Minimum Reproducible Example) åº”ç”¨ç¨‹åºï¼Œæˆ–ç”¨äºæ±‚èŒç”³è¯·çš„<strong>æµ‹è¯•æŒ‘æˆ˜</strong>åº”ç”¨ç¨‹åºã€‚</p>

<p>å¯¹äºæ‰€æœ‰å…¶ä»–æƒ…å†µï¼Œæˆ‘å»ºè®®å…ˆä»éƒ¨åˆ†æˆ–å®Œå…¨æ¨¡å—åŒ–å¼€å§‹ï¼Œç„¶åæ ¹æ®éœ€è¦å‡çº§åˆ°ä¸‹ä¸€æ­¥ï¼Œæˆ–è€…å°½å¯èƒ½æå‰å‡çº§ï¼Œä»¥å‡å°‘ä»¥åçš„éº»çƒ¦ã€‚</p>

<p>ä½ å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> ä»£ç åº“ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82</a></p>

<p>FlickSlate å°šæœªå‡çº§åˆ°åŠŸèƒ½ç»„ã€‚è¿™æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºå…±äº«å±‚è¿˜æ— æ³•æ‹†åˆ†ä¸ºåŠŸèƒ½ç»„ã€‚è¯¥åº”ç”¨æ²¡æœ‰ç›ˆåˆ©åŠŸèƒ½ï¼Œæ‰€ä»¥åªèƒ½å¯¹èŠ‚ç›®è¿›è¡Œåˆ†ç»„ï¼Œä¸è¿‡ç›®å‰å…±äº«å±‚å·²ç»å®Œç¾åœ°å®ç°äº†è¿™ä¸€ç‚¹ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æºäºæˆ‘å¯¹äº’è”ç½‘ä¸Šå…³äºä½•æ—¶ä»¥åŠå¦‚ä½•æ¨¡å—åŒ–çš„å»ºè®®ä¸€æ¦‚è€Œè®ºçš„ä¸æ»¡ï¼šè¦ä¹ˆå»ºè®®ä¸åŠ åŒºåˆ†åœ°è¿›è¡Œæ¨¡å—åŒ–ï¼Œè¦ä¹ˆæœ‰äººå¯¹ä»»ä½•è¿›è¡Œæ¨¡å—åŒ–çš„äººå¤§å–Šâ€œè¿‡åº¦å·¥ç¨‹â€ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ åœ¨ä½•æ—¶ä»¥åŠå¦‚ä½•è¿›è¡Œæ¨¡å—åŒ–æ–¹é¢åšå‡ºæ›´æ˜æ™ºçš„å†³å®šã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compose Unstyledï¼šCompose UIä¸­å¤±ä¼ â€‹â€‹çš„è®¾è®¡ç³»ç»Ÿå±‚]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/11/compose-unstyled/"/>
    <updated>2025-09-11T00:17:33+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/11/compose-unstyled</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCompose Unstyled: The missing Design System layer for Compose UIã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://composables.com/blog/introducing-compose-unstyled">https://composables.com/blog/introducing-compose-unstyled</a>ï¼Œç”±Alex Stylå‘å¸ƒäº2025å¹´8æœˆ7æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/11/compose-unstyled/"><img src="https://composables.com/og_unstyled.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>ä½¿ç”¨ Compose UI æ„å»ºåº”ç”¨çš„æœ€å¤§é—®é¢˜æ˜¯ Material Compose çš„çµæ´»æ€§ä¸è¶³ã€‚Material Compose çš„å¯å®šåˆ¶æ€§ä¸è¶³ä»¥è®©ä½ åœ¨å…¶ä¸Šæ„å»ºè‡ªå·±çš„è®¾è®¡ç³»ç»Ÿï¼Œå› æ­¤ä½ æœ€ç»ˆåªèƒ½å¯¹å…¶ç»„ä»¶è¿›è¡Œä¿®æ”¹ã€‚å¦ä¸€æ–¹é¢ï¼ŒCompose Foundation åˆè¿‡äºâ€œåŸå§‹â€â€”â€”å®ƒæœ‰è¡Œå’Œåˆ—ï¼Œä½†æ²¡æœ‰æŒ‰é’®æˆ–åº•éƒ¨è¡¨å•ã€‚è€Œä¸”ï¼Œç”±äºä¸»é¢˜è®¾ç½®ä¸ Material ç»‘å®šï¼Œå¦‚æœä¸å®Œå…¨éµå¾ª Material çš„è®¾è®¡å†³ç­–ï¼Œä½ ç”šè‡³æ— æ³•ä¸ºä½ çš„åº”ç”¨è®¾ç½®ä¸»é¢˜ã€‚</p>

<p>ä½ å¯ä»¥ä»å¤´å¼€å§‹æ„å»ºæ‰€æœ‰å†…å®¹ï¼Œä½†è°æœ‰æ—¶é—´è¿™æ ·åšå‘¢ï¼Ÿè€ƒè™‘åˆ°ä¸åŒçš„çŠ¶æ€ã€å¯è®¿é—®æ€§å’Œè¾¹ç¼˜æƒ…å†µï¼Œåƒåº•éƒ¨è¡¨å•è¿™æ ·çš„å•ä¸ªç»„ä»¶å¯èƒ½éœ€è¦ 3-4 å‘¨æ‰èƒ½å®Œæˆã€‚è¿™ä¸ªé—®é¢˜åœ¨ Compose Multiplatform ä¸­å˜å¾—æ›´åŠ ä¸¥é‡â€”â€”Material åœ¨ iOS ä¸Šçœ‹èµ·æ¥ç¬¨æ‹™ï¼Œåœ¨æ¡Œé¢ä¸Šæ˜¾å¾—ä¸æˆæ¯”ä¾‹ã€‚</p>

<p>æˆ‘éœ€è¦ä¸€ä¸ªçµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥åœ¨ä»»ä½•å¹³å°ä¸Šä½¿ç”¨ï¼Œè€Œä¸å— Material çš„é™åˆ¶ã€‚äºæ˜¯æˆ‘æ’¸èµ·è¢–å­ï¼Œè‡ªå·±åŠ¨æ‰‹æ„å»ºäº†ä¸€ä¸ªï¼š</p>

<p><strong><a href="https://composables.com/docs/com.composables/core">Compose Unstyled</a> æ˜¯åŸºäº Compose Foundation çš„ APIï¼Œå¯è½»æ¾æ„å»ºä»»ä½•è®¾è®¡ç³»ç»Ÿ</strong> ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82%E5%AE%83%E6%8F%90%E4%BE%9B%E6%97%A0%E6%A0%B7%E5%BC%8F%E3%80%81%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89%E7%81%B5%E6%B4%BB%E7%9A%84%E4%B8%BB%E9%A2%98">https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82%E5%AE%83%E6%8F%90%E4%BE%9B%E6%97%A0%E6%A0%B7%E5%BC%8F%E3%80%81%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89%E7%81%B5%E6%B4%BB%E7%9A%84%E4%B8%BB%E9%A2%98</a> APIâ€”â€”æ‰€æœ‰å…³äºç”¨æˆ·ä½“éªŒå’Œå¯è®¿é—®æ€§çš„ç¹çå·¥ä½œéƒ½å·²ä¸ºä½ å¤„ç†ã€‚</p>

<p>Unstyled ä¸­çš„ç»„ä»¶å®Œå…¨æ— éœ€æ¸²æŸ“ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåœ¨å±å¹•ä¸Šæ˜¾ç¤ºä»»ä½•å†…å®¹ã€‚ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºâ€œç»„ä»¶æ¨¡å¼â€ï¼Œå®ƒä»¬å°†â€œåº•éƒ¨è¡¨å•â€æˆ–â€œè¿›åº¦æ¡â€çš„æ¦‚å¿µå¼•å…¥ä½ çš„åº”ç”¨ï¼Œè€Œæ— éœ€ä½ æ‹…å¿ƒç”¨æˆ·ä½“éªŒã€é”®ç›˜å¯¼èˆªæˆ–å¯è®¿é—®æ€§å®ç°ã€‚åªéœ€æ·»åŠ æ ·å¼å³å¯ã€‚</p>

<h2>ç®€æ´çš„ APIï¼Œæä¾›ä½ æ‰€éœ€çš„æ ·å¼</h2>

<p>Compose Unstyled ä¸æä¾›ä»»ä½•ç‰¹æ®Šçš„æ ·å¼ APIã€‚æ‰€æœ‰æ“ä½œéƒ½é€šè¿‡ <code>Modifier</code> å®Œæˆã€‚å¦‚æœä½ çŸ¥é“å¦‚ä½•è®¾ç½® <code>Box()</code> çš„æ ·å¼ï¼Œé‚£ä¹ˆä½ å°±çŸ¥é“å¦‚ä½•è®¾ç½® Compose Unstyled ä¸­æ¯ä¸ªç»„ä»¶çš„æ ·å¼ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Compose Unstyled æ„å»ºæ¨¡æ€åº•éƒ¨è¡¨å•çš„ç®€å•ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…å«è‡ªå®šä¹‰å®šä½ç‚¹ï¼ˆè¡¨å•åœ¨å±å¹•ä¸Šâ€œåœç•™â€çš„ä½ç½®ï¼‰ä»¥åŠä½ é€‰æ‹©çš„æ ·å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">Peek</span> <span class="p">=</span> <span class="n">SheetDetent</span><span class="p">(</span><span class="s">&quot;peek&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">containerHeight</span><span class="p">,</span> <span class="n">sheetHeight</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">containerHeight</span> <span class="p">*</span> <span class="m">0.6f</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">BoxWithConstraints</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Brush</span><span class="p">.</span><span class="n">linearGradient</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF800080</span><span class="p">),</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFDA70D6</span><span class="p">)))))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">modalSheetState</span> <span class="p">=</span> <span class="n">rememberModalBottomSheetState</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialDetent</span> <span class="p">=</span> <span class="n">Hidden</span><span class="p">,</span>
</span><span class='line'>        <span class="n">detents</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">Peek</span><span class="p">,</span> <span class="n">FullyExpanded</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span>
</span><span class='line'>        <span class="n">modalSheetState</span><span class="p">.</span><span class="n">targetDetent</span> <span class="p">=</span> <span class="n">Peek</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">modalSheetState</span><span class="p">.</span><span class="n">targetDetent</span> <span class="p">=</span> <span class="n">Peek</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="n">WindowInsets</span><span class="p">.</span><span class="n">navigationBars</span><span class="p">.</span><span class="n">only</span><span class="p">(</span><span class="n">WindowInsetsSides</span><span class="p">.</span><span class="n">Horizontal</span><span class="p">).</span><span class="n">asPaddingValues</span><span class="p">()),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">6.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">14.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">),</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Show Sheet&quot;</span><span class="p">,</span> <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">(</span><span class="m">500</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isCompact</span> <span class="p">=</span> <span class="n">maxWidth</span> <span class="p">&lt;</span> <span class="m">600.</span><span class="n">dp</span>
</span><span class='line'>    <span class="n">ModalBottomSheet</span><span class="p">(</span><span class="n">state</span> <span class="p">=</span> <span class="n">modalSheetState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Scrim</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scrimColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">enter</span> <span class="p">=</span> <span class="n">fadeIn</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">exit</span> <span class="p">=</span> <span class="n">fadeOut</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">12.</span><span class="n">dp</span><span class="p">).</span><span class="n">let</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">isCompact</span><span class="p">)</span> <span class="n">it</span> <span class="k">else</span> <span class="n">it</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">56.</span><span class="n">dp</span><span class="p">)</span> <span class="p">}.</span><span class="n">displayCutoutPadding</span><span class="p">().</span><span class="n">statusBarsPadding</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">WindowInsets</span><span class="p">.</span><span class="n">navigationBars</span><span class="p">.</span><span class="n">only</span><span class="p">(</span><span class="n">WindowInsetsSides</span><span class="p">.</span><span class="n">Horizontal</span><span class="p">).</span><span class="n">asPaddingValues</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Sheet</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">topStart</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">,</span> <span class="n">topEnd</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">widthIn</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="m">640.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">topStart</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">,</span> <span class="n">topEnd</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>                <span class="n">contentColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">600.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">TopCenter</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">DragIndication</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">22.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.4f</span><span class="p">),</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">100</span><span class="p">)).</span><span class="n">width</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">).</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œæˆ‘çŸ¥é“ä½ å¯èƒ½ä¼šæƒ³ã€‚â€œAlexï¼è¿™ API çœŸå¥‡æ€ªã€‚ä¸ºä»€ä¹ˆæˆ‘éœ€è¦ä¸€ä¸ª <code>ModalBottomSheet</code> å’Œä¸€ä¸ª <code>Sheet</code>ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ Slots å‘¢ï¼Ÿâ€</p>

<p>è¿™ä¸ªè®¾è®¡é€‰æ‹©æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„ï¼š</p>

<h2>è®¾è®¡ç†å¿µ</h2>

<p>Compose Unstyled ä¸ä¼šæ›¿ä½ åšå‡ºä»»ä½•è®¾è®¡å†³ç­–ï¼Œè€Œæ˜¯è®©ä½ å®Œå…¨æŒæ§å¸ƒå±€ã€‚äº‹å®ä¸Šï¼Œå¦‚æœä½ è¢«è¿«ä½¿ç”¨æ— æ³•æ ¹æ®éœ€æ±‚æ›´æ”¹çš„æ ·å¼ï¼Œåˆ™ä¼šè¢«è§†ä¸ºé”™è¯¯ï¼ˆè¯·æäº¤ GitHub é—®é¢˜ï¼Œä»¥ä¾¿æˆ‘è¿›è¡Œè°ƒæŸ¥ï¼‰ã€‚</p>

<p>ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›å°†åº•éƒ¨è¡¨å•æ”¾ç½®åœ¨å±å¹•çš„å·¦ä¾§æˆ–å³ä¾§ã€‚å½“ä½ æƒ³è¦æ±‚å¼€å‘è€…æä¾›ä¸€ä¸ªåœ¨å¸ƒå±€ä¸Šå…·æœ‰ä¸¥æ ¼ä½ç½®çš„ç»„ä»¶æ—¶ï¼ŒåŸºäºæ’æ§½çš„ API éå¸¸å®ç”¨ã€‚</p>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°† <code>ModalBottomSheet</code> ç»„ä»¶è§†ä¸ºè¡¨å•å¯ä»¥ç§»åŠ¨çš„åŒºåŸŸã€‚<code>Sheet</code> æ˜¯ç”¨æˆ·å¯ä»¥ä¸ä¹‹äº¤äº’çš„å®é™…è¡¨å•ã€‚é€šè¿‡æä¾›è¿™æ ·çš„ç»„ä»¶ï¼Œå®ƒä¸ºå¼€å‘è€…æä¾›äº†æ¸…æ™°çš„ APIï¼Œå¹¶æ¸…æ¥šåœ°è¯´æ˜äº†ç»„ä»¶çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ<code>Scrim()</code> ç»„ä»¶å…·æœ‰ <em>enter</em> å’Œ <em>exit</em> è¿‡æ¸¡å‚æ•°ã€‚ Compose Unstyled ä¼šåœ¨æ°å½“çš„æ—¶æœºä¸ºçº±å¹•æ·»åŠ å’Œéšè—åŠ¨ç”»ï¼Œä»¥å®ç°æœ€ä½³ç”¨æˆ·ä½“éªŒã€‚ä½ åªéœ€æŒ‡å®šâ€œå¦‚ä½•â€å®ç°å³å¯ã€‚</p>

<p>ç”±äº Compose Unstyled åœ¨å¤–è§‚æ–¹é¢éå¸¸å¼€æ”¾ï¼Œå› æ­¤ä¸åŸå§‹çš„ Compose Foundation ç»„ä»¶ç›¸æ¯”ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å¹³å°é™åˆ¶ã€‚Foundation ä¸­çš„â€œå¯¹è¯æ¡†â€å…·æœ‰å›ºå®šçš„æœ€å¤§å°ºå¯¸ï¼Œè¿™ä½¿å¾—å®ƒä»¬åœ¨è¯¸å¦‚å…¨å±å¯¹è¯æ¡†ç­‰æƒ…å†µä¸‹éš¾ä»¥å·¥ä½œã€‚</p>

<p>Compose Unstyled ä¸­çš„æ‰€æœ‰ç»„ä»¶åœ¨æ‰€æœ‰å¹³å°ä¸Šçš„å·¥ä½œæ–¹å¼å®Œå…¨ç›¸åŒã€‚è¿™æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œå› ä¸ºæ­¤ç±»å†³ç­–åº”è¯¥å±äºè®¾è®¡ç³»ç»Ÿå±‚çš„ä¸€éƒ¨åˆ†ã€‚å°½ç®¡è¿™ä¼šç»™å¼€å‘è€…å¸¦æ¥æ›´å¤šè´Ÿæ‹…ï¼Œä½†ç”±äºæ²¡æœ‰â€œé™·é˜±â€ï¼Œå®ƒå¤§å¤§ç¼©çŸ­äº†å¼€å‘æ—¶é—´ã€‚ç»„ä»¶çš„æ ·å¼ä¸ä½ æè¿°çš„å®Œå…¨ä¸€è‡´ã€‚</p>

<p>è¿™ä¸ä¼šä½¿ Compose Unstyled ä¸åº•å±‚å¹³å°è„±èŠ‚ã€‚åœ¨ä½¿ç”¨å¯¹è¯æ¡†å’Œæ¨¡æ€åº•éƒ¨èœå•ç­‰æ¨¡æ€çª—å£æ—¶ï¼Œè®¾ç½®ç³»ç»Ÿçª—å£çš„æ ·å¼æ˜¯ Android æ ·å¼è®¾ç½®çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCompose Unstyled æä¾›äº†ä¸€ä¸ª <code>LocalModalWindow</code> ç»„åˆæœ¬åœ°æ¥å£ï¼Œå…è®¸ä½ è®¿é—®æ¸²æŸ“æ¨¡æ€çª—å£çš„ <code>Window</code>ã€‚è¯·æ³¨æ„ï¼Œæ­¤ç±» API ä»…é€‚ç”¨äº Android ç›®æ ‡å¹³å°ï¼Œä¸å±äºé€šç”¨ç›®æ ‡å¹³å° APIã€‚</p>

<p>æœ€åï¼Œæ¯ä¸ªç»„ä»¶çš„ä»£ç éƒ½åŒ…å«åœ¨å…¶è‡ªå·±çš„æ–‡ä»¶ä¸­ï¼Œå³ä½¿ä½ ä¸æ˜¯ Compose ä¸“å®¶ï¼Œä¹Ÿèƒ½è½»æ¾ç†è§£ã€‚ä½ æ— éœ€æ‹…å¿ƒä»»ä½•é™åˆ¶ã€‚å¦‚æœä½ ç°åœ¨éœ€è¦æ›´æ”¹æŸäº›å†…å®¹ï¼Œå¹¶ä¸”è¿«ä¸åŠå¾…åœ°æƒ³è¦æäº¤é”™è¯¯å¹¶åœ¨åº“çº§åˆ«ä¿®å¤å®ƒï¼Œä½ åªéœ€å°†ç»„ä»¶çš„å•ä¸ªæ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ°ä½ çš„ä»£ç åº“ä¸­å³å¯ã€‚è¿™ä¸ºä½ èŠ‚çœäº†é€šå¸¸éœ€è¦ä½ è‡ªå·±å®Œæˆçš„ 4 å‘¨å·¥ä½œæ—¶é—´ã€‚</p>

<h2>æ»‘å—</h2>

<p>ä»¥ä¸‹æ˜¯å¦‚ä½•æ„å»ºä¸€ä¸ªå…·æœ‰ä½ æ‰€é€‰æ ·å¼çš„æ»‘å—ã€‚</p>

<p>å®ƒä¸ Compose çš„â€œInteractionStateâ€é›†æˆï¼Œä»¥ä¾¿ä½ å¯ä»¥æŒ‰ç…§è‡ªå·±æƒ³è¦çš„æ–¹å¼å®Œå–„ç»„ä»¶ã€‚é”®ç›˜äº¤äº’åŠŸèƒ½å¼€ç®±å³ç”¨ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æŒ‰ä¸‹é”®ç›˜ä¸Šçš„â€œå‘ä¸Šâ€æˆ–â€œå‘ä¸‹â€é”®æ¥å¢åŠ æˆ–å‡å°‘å€¼ï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-1.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Brush</span><span class="p">.</span><span class="n">linearGradient</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFED213A</span><span class="p">),</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF93291E</span><span class="p">)))),</span>   <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isFocused</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsFocusedAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isPressed</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsPressedAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">rememberSliderState</span><span class="p">(</span><span class="n">initialValue</span> <span class="p">=</span> <span class="m">0.7f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Row</span><span class="p">(</span><span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">,</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">).</span><span class="n">widthIn</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="m">480.</span><span class="n">dp</span><span class="p">).</span><span class="n">fillMaxWidth</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span> <span class="p">-=</span> <span class="m">0.1f</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">VolumeDown</span><span class="p">,</span> <span class="s">&quot;Decrease&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Slider</span><span class="p">(</span>
</span><span class='line'>            <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span><span class="p">,</span>
</span><span class='line'>            <span class="n">state</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">track</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// the &#39;not yet completed&#39; part of the track</span>
</span><span class='line'>                    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxHeight</span><span class="p">().</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF93291E</span><span class="p">)))</span>
</span><span class='line'>                    <span class="c1">// the &#39;completed&#39; part of the track</span>
</span><span class='line'>                    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxHeight</span><span class="p">().</span><span class="n">fillMaxWidth</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">thumb</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">thumbSize</span> <span class="k">by</span> <span class="n">animateDpAsState</span><span class="p">(</span><span class="n">targetValue</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">isPressed</span><span class="p">)</span> <span class="m">22.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">18.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">thumbInteractionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">isHovered</span> <span class="k">by</span> <span class="n">thumbInteractionSource</span><span class="p">.</span><span class="n">collectIsHoveredAsState</span><span class="p">()</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">glowColor</span> <span class="k">by</span> <span class="n">animateColorAsState</span><span class="p">(</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">isFocused</span> <span class="p">||</span> <span class="n">isHovered</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.33f</span><span class="p">)</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Transparent</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="c1">// keep the size fixed to ensure that the resizing animation is always centered</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">36.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">CircleShape</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">glowColor</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Thumb</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">thumbSize</span><span class="p">).</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">).</span><span class="n">hoverable</span><span class="p">(</span><span class="n">thumbInteractionSource</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span> <span class="p">+=</span> <span class="m">0.1f</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">VolumeUp</span><span class="p">,</span> <span class="s">&quot;Increase&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä¸‹æ‹‰èœå•</h2>

<p>ä¸‹æ‹‰èœå•çš„æ­£ç¡®å®ç°éå¸¸å¤æ‚ï¼Œå°¤å…¶æ˜¯åœ¨é”®ç›˜å¯¼èˆªå’Œç„¦ç‚¹ç®¡ç†æ–¹é¢ã€‚</p>

<p>è¦å……åˆ†ä½“éªŒæ­¤ç»„ä»¶ï¼Œè¯·åœ¨æ¡Œé¢ä¸Šè¯•ç”¨ï¼šç‚¹å‡»â€œOptionsâ€æŒ‰é’®ä»¥èšç„¦æ¼”ç¤ºï¼Œç„¶åä½¿ç”¨é”®ç›˜çš„ä¸Šä¸‹ç®­å¤´é”®è¿›è¡Œå¯¼èˆªï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-2.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DropdownOption</span><span class="p">(</span><span class="k">val</span> <span class="py">text</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">icon</span><span class="p">:</span> <span class="n">ImageVector</span><span class="p">,</span> <span class="k">val</span> <span class="py">enabled</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="k">val</span> <span class="py">dangerous</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">options</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Select All&quot;</span><span class="p">,</span> <span class="n">Maximize</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Copy&quot;</span><span class="p">,</span> <span class="n">Copy</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Cut&quot;</span><span class="p">,</span> <span class="n">Scissors</span><span class="p">,</span> <span class="n">enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Paste&quot;</span><span class="p">,</span> <span class="n">Clipboard</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">Trash2</span><span class="p">,</span> <span class="n">dangerous</span> <span class="p">=</span> <span class="k">true</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">DropdownMenu</span><span class="p">(</span><span class="n">onExpandRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">true</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Button</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">6.</span><span class="n">dp</span><span class="p">),</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">true</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">14.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Options&quot;</span><span class="p">,</span> <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">(</span><span class="m">500</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span><span class="n">ChevronDown</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">DropdownMenuPanel</span><span class="p">(</span>
</span><span class='line'>        <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">240.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">enter</span> <span class="p">=</span> <span class="n">scaleIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">120</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">LinearOutSlowInEasing</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialScale</span> <span class="p">=</span> <span class="m">0.8f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">transformOrigin</span> <span class="p">=</span> <span class="n">TransformOrigin</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">+</span> <span class="n">fadeIn</span><span class="p">(</span><span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">30</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">exit</span> <span class="p">=</span> <span class="n">scaleOut</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">delayMillis</span> <span class="p">=</span> <span class="m">75</span><span class="p">),</span> <span class="n">targetScale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">)</span> <span class="p">+</span> <span class="n">fadeOut</span><span class="p">(</span><span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">75</span><span class="p">))</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">options</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">option</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">==</span> <span class="m">1</span> <span class="p">||</span> <span class="n">index</span> <span class="p">==</span> <span class="n">options</span><span class="p">.</span><span class="n">lastIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Separator</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFBDBDBD</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span> <span class="n">enabled</span> <span class="p">=</span> <span class="n">option</span><span class="p">.</span><span class="n">enabled</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentColor</span> <span class="p">=</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">dangerous</span><span class="p">)</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFC62828</span><span class="p">)</span> <span class="k">else</span> <span class="n">LocalContentColor</span><span class="p">.</span><span class="n">current</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="m">1f</span> <span class="k">else</span> <span class="m">0.5f</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Icon</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">icon</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="n">option</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">horizontal</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥åŠæ›´å¤šæœªæ ·å¼åŒ–çš„ç»„ä»¶ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
<li><a href="https://composables.com/docs/com.composables/core/textfield">TextField</a>ï¼Œå…¨é¢æ”¯æŒå±å¹•é˜…è¯»å™¨çš„æ— éšœç¢åŠŸèƒ½</li>
<li><a href="https://composables.com/docs/com.composables/core/button">Button</a></li>
<li><a href="https://composables.com/docs/com.composables/core/dialog">Dialog</a></li>
<li><a href="https://composables.com/docs/com.composables/core/radiogroup">Radio Group</a></li>
<li><a href="https://composables.com/docs/com.composables/core/tabgroup">TabGroup</a>ï¼Œç”¨äºæ„å»ºæ ‡ç­¾å¼å¯¼èˆªï¼Œä¾‹å¦‚åº•éƒ¨åº”ç”¨æ æˆ–é¡¶éƒ¨æ ‡ç­¾æ¡Œé¢</li>
<li><a href="https://composables.com/docs/com.composables/core/checkbox">å¤é€‰æ¡†</a></li>
<li><a href="https://composables.com/docs/com.composables/core/tristatecheckbox">ä¸‰æ€å¤é€‰æ¡†</a></li>
<li><a href="https://composables.com/docs/com.composables/core/toggleswitch">åˆ‡æ¢å¼€å…³</a></li>
<li><a href="https://composables.com/docs/com.composables/core/scrollarea">æ»šåŠ¨æ¡</a>ï¼ˆæ²¡é”™ï¼Œå°±æ˜¯æ»šåŠ¨æ¡ã€‚ï¼‰</li>
</ul>


<p>æ¯ä¸ªç»„ä»¶åœ¨æ„å»ºæ—¶éƒ½å……åˆ†è€ƒè™‘äº†å¯è®¿é—®æ€§ï¼ŒåŒ…æ‹¬åˆç†çš„è¯­ä¹‰å’Œå®Œæ•´çš„é”®ç›˜å¯¼èˆªæ”¯æŒã€‚</p>

<p>ä½ å¯ä»¥<a href="https://composables.com/docs/com.composables/core">åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°å®Œæ•´çš„ç»„ä»¶åˆ—è¡¨ -></a>ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82">https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82</a></p>

<h2>ä½¿ç”¨ä½ çš„è®¾è®¡ä»¤ç‰Œè‡ªå®šä¹‰ Compose ä¸»é¢˜</h2>

<p>Compose Unstyled åŒ…å«ä¸€ä¸ªçµæ´»çš„ä¸»é¢˜ç³»ç»Ÿï¼Œå¯ä¸ä»»ä½•è®¾è®¡ç³»ç»Ÿä»¤ç‰Œå…¼å®¹ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ä½ é€‰æ‹©çš„è®¾è®¡ä»¤ç‰Œåˆ›å»ºå®Œå…¨è‡ªå®šä¹‰çš„ä¸»é¢˜ï¼š</p>

<p>ä»¥ä¸‹æ˜¯åˆ›å»º Compose Theme å‡½æ•°çš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// define your theme properties</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">colors</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;colors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">typography</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;typography&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">shapes</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;shapes&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">elevation</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Dp</span><span class="p">&gt;(</span><span class="s">&quot;elevation&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">// define your theme tokens.</span>
</span><span class='line'><span class="c1">// those are the potential values of your theme properties</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">background</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;background&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">card</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;surface&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onCard</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onCard&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">outline</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;outline&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">accent</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;accent&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">primary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;primary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onPrimary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onPrimary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onSecondary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onSecondary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">secondary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;secondary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">subtle</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Dp</span><span class="p">&gt;(</span><span class="s">&quot;subtle&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">titleMedium</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;titleMedium&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">bodyMedium</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;bodyMedium&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">cardShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;cardShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">albumCoverShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;albumCoverShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">buttonShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;buttonShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">// create your Compose Theme and assign values to each token</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">LightTheme</span> <span class="p">=</span> <span class="n">buildTheme</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;LightTheme&quot;</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">colors</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">accent</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span>
</span><span class='line'>        <span class="n">card</span> <span class="n">to</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onCard</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF1E293B</span><span class="p">),</span>
</span><span class='line'>        <span class="n">outline</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFE2E8F0</span><span class="p">),</span>
</span><span class='line'>        <span class="n">primary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF2563EB</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onPrimary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">secondary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFE2E8F0</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onSecondary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF64748B</span><span class="p">),</span>
</span><span class='line'>        <span class="n">background</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF8F9FA</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">typography</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">titleMedium</span> <span class="n">to</span> <span class="n">TextStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">fontSize</span> <span class="p">=</span> <span class="m">18.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">SemiBold</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontFamily</span> <span class="p">=</span> <span class="n">loadInterFont</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">bodyMedium</span> <span class="n">to</span> <span class="n">TextStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">fontSize</span> <span class="p">=</span> <span class="m">14.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontFamily</span> <span class="p">=</span> <span class="n">loadInterFont</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">shapes</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">cardShape</span> <span class="n">to</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">albumCoverShape</span> <span class="n">to</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">buttonShape</span> <span class="n">to</span> <span class="n">CircleShape</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">elevation</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">subtle</span> <span class="n">to</span> <span class="m">8.</span><span class="n">dp</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨æ–°çš„ä¸»é¢˜å‡½æ•°åŒ…è£…ä½ çš„åº”ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MusicPlayerApp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LightTheme</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MusicPlayerCard</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œå®ƒä¼šä½¿ç”¨ <code>Theme</code> å¯¹è±¡æˆäºˆå…¶å­ç»„ä»¶å¯¹ä¸»é¢˜çš„è®¿é—®æƒé™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MusicPlayerCard</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">sliderState</span> <span class="p">=</span> <span class="n">rememberSliderState</span><span class="p">(</span><span class="n">initialValue</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">outline</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">elevation</span><span class="p">][</span><span class="n">subtle</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">card</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ProvideContentColor</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onCard</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Column</span><span class="p">(</span><span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span><span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">,</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">Res</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">just_hoist_it_cover</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">albumCoverShape</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">primary</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">80.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Album Cover&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">contentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Just hoist it!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">typography</span><span class="p">][</span><span class="n">titleMedium</span><span class="p">])</span>
</span><span class='line'>                        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;The Deprecated&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">style</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">typography</span><span class="p">][</span><span class="n">bodyMedium</span><span class="p">],</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onSecondary</span><span class="p">]</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">Slider</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">state</span> <span class="p">=</span> <span class="n">sliderState</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">track</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                            <span class="c1">// the empty part of the track</span>
</span><span class='line'>                            <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">secondary</span><span class="p">]))</span>
</span><span class='line'>                            <span class="c1">// the filled part of the track</span>
</span><span class='line'>                            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(</span><span class="n">sliderState</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">accent</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="n">thumb</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Thumb</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">accent</span><span class="p">],</span>
</span><span class='line'>                            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">]</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">SpaceEvenly</span><span class="p">,</span> <span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">SkipBack</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Previous&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">primary</span><span class="p">],</span> <span class="n">contentColor</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onPrimary</span><span class="p">],</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">Pause</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Pause&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">SkipForward</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Next&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>è½®å»“ä¿®é¥°ç¬¦</h2>

<p>æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼ŒCompose Unstyled å¼•å…¥äº†ä¸€äº› Compose Foundation ä¸­ç¼ºå°‘çš„æ ·å¼ <code>Modifier</code>ï¼Œä½†è¿™äº›ä¿®é¥°ç¬¦å¯¹äºæ„å»ºè§†è§‰ä¸°å¯Œçš„ç•Œé¢å¿…ä¸å¯å°‘ï¼š</p>

<h3>è½®å»“</h3>

<p>ä¸ Compose Foundation çš„ <code>border()</code> ä¿®é¥°ç¬¦ä¸åŒï¼Œæ­¤ä¿®é¥°ç¬¦ä¸ä¼šå½±å“å¸ƒå±€ã€‚å®ƒè¿˜ä¼šåœ¨ç»„ä»¶å‘¨å›´è€Œä¸æ˜¯å†…éƒ¨è¿›è¡Œç»˜åˆ¶ã€‚å½“ä½ éœ€è¦ä¸€ä¸ªä¸é˜´å½±å®Œç¾èåˆçš„åŠé€æ˜è½®å»“æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸æ–¹ä¾¿ï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-3.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span><span class="p">,</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ç„¦ç‚¹ç¯</h3>

<p>ç„¦ç‚¹ç¯åœ¨å¤„ç†é”®ç›˜å¯¼èˆªå’Œç„¦ç‚¹æ—¶éå¸¸é‡è¦ã€‚å®ƒä»¬åªæœ‰åœ¨è·å¾—ç„¦ç‚¹æ—¶æ‰ä¼šæ¸²æŸ“è½®å»“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">focusRing</span><span class="p">(</span>
</span><span class='line'>        <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span><span class="p">,</span>
</span><span class='line'>        <span class="n">width</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span>
</span><span class='line'>        <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>    <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç„¶åå‘¢ï¼Ÿ</h2>

<p>å³å°†æ¨å‡ºçš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>

<ul>
<li>ä¾§è¾¹æ </li>
<li>å·¥å…·æç¤º</li>
<li>ä¸Šä¸‹æ–‡èœå•</li>
</ul>


<p>ä»¥åŠæ›´å¤šã€‚</p>

<p>å¦‚æœä½ æ„¿æ„ä¸ºè¯¥é¡¹ç›®æä¾›èµ„é‡‘æ”¯æŒï¼Œæˆ‘ä»¬è¿˜æä¾›<a href="https://composables.com/ui-kit">æ­£åœ¨åˆ¶ä½œä¸­çš„ UI Kit</a>ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/ui-kit%EF%BC%89%E3%80%82%E8%AF%A5">https://composables.com/ui-kit%EF%BC%89%E3%80%82%E8%AF%A5</a> UI Kit æ˜¯ä¸€å¥—å®Œæ•´çš„è®¾è®¡ç³»ç»Ÿï¼Œé€‚ç”¨äºè§¦æ§å’ŒæŒ‡é’ˆåº”ç”¨ã€‚</p>

<p>ä¸ºäº†ä½¿è¿™äº› API å®Œç¾æ— ç¼ºï¼Œæˆ‘ä»¬æŠ•å…¥äº†å¤§é‡çš„å·¥ä½œå’Œä¸“ä¸šçŸ¥è¯†ã€‚é€šè¿‡èµ„é‡‘æ”¯æŒè¯¥é¡¹ç›®ï¼Œä½ å°†åœ¨æœªæ¥å‡ å¹´è·å¾—æ›´å¤šèµ„æºï¼Œè€Œæˆ‘åˆ™å¯ä»¥ç»§ç»­ä»äº‹å¼€æºå·¥ä½œï¼ŒåŒæ—¶æ”¯ä»˜æˆ¿ç§Ÿã€‚</p>

<p>æƒ³è¦éšæ—¶äº†è§£æœ€æ–°åŠ¨æ€ï¼Ÿè¯·åŠ¡å¿…<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/">åœ¨ Github ä¸Šå…³æ³¨ Unstyled</a>ï¼ˆé“¾æ¥:<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/%EF%BC%89%E3%80%82">https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/%EF%BC%89%E3%80%82</a></p>

<p>æƒ³è¦è¯„è®ºè¿™ç¯‡æ–‡ç« å—ï¼Ÿ<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106">åœ¨ GitHub ä¸Šè®¨è®º â†’</a>ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106%EF%BC%89">https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106%EF%BC%89</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[è¿è¡Œæ—¶ç€è‰²å™¨å®æˆ˜ï¼šå®ç°å…ƒçƒï¼ˆMetaballsï¼‰åŠ¨æ•ˆ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders/"/>
    <updated>2025-09-06T23:19:16+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒMetaballs with Runtimeshadersã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/metaballs-with-runtimeshaders-bb7e5f6b27c2">https://medium.com/@off.mind.by/metaballs-with-runtimeshaders-bb7e5f6b27c2</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025810ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*fQOua40zD_PlbsejLeHBeg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä»Šå¤©æˆ‘æƒ³å‘å¤§å®¶ä»‹ç»ä¸€ç§æœ€ç®€å•å´åˆå‡ºäººæ„æ–™åœ°ä»¤äººå°è±¡æ·±åˆ»çš„æ•ˆæœï¼šå…ƒçƒã€‚</p>

<p>å…ƒçƒæ˜¯ä¸€ç§çœ‹èµ·æ¥åƒæœ‰æœºä½“çš„å½¢çŠ¶ï¼Œå…¶ç‰¹ç‚¹æ˜¯å®ƒä»¬èƒ½å¤Ÿåœ¨è¿‘è·ç¦»å†…èåˆåœ¨ä¸€èµ·ï¼Œå½¢æˆå•ä¸ªè¿ç»­çš„ç‰©ä½“ã€‚</p>

<p>ä½¿ç”¨ GLSL ç€è‰²å™¨åˆ›å»ºè¿™ç§æ•ˆæœéå¸¸ç®€å•ï¼Œåªéœ€å‡ è¡Œä»£ç å³å¯ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°å…³äºå¦‚ä½•å°†å…¶ç§»æ¤åˆ° AGSL å¹¶åœ¨ Compose ä¸­ä½¿ç”¨çš„æ•™ç¨‹ã€‚ç„¶è€Œï¼Œä¸»è¦çš„é—®é¢˜æ˜¯è¿™ç§æ•ˆæœéœ€è¦ä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰ç‰©ä½“ã€‚æˆ‘æ‰¾åˆ°çš„æ‰€æœ‰æ•™ç¨‹éƒ½åªæ˜¯åœ¨å•ä¸ªç€è‰²å™¨ä¸­æ¨¡æ‹Ÿä¸¤ä¸ªç»„ä»¶ã€‚è¿™ç§æ–¹æ³•åœ¨è§†è§‰ä¸Šå¾ˆæœ‰æ•ˆï¼Œä½†åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ—¶ä¼šå¸¦æ¥å¾ˆå¤šé™åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘å¼€å§‹ä»¥ä¸€ç§æ¯ä¸ªå…ƒç´ åªæ‰­æ›²è‡ªèº«çš„æ–¹å¼æ¥æ„å»ºè¿™ç§æ•ˆæœâ€”â€”å°½å¯èƒ½åœ°è®©ä¸€åˆ‡çœ‹èµ·æ¥å…¬å¹³ã€å¹²å‡€ã€‚</p>

<p>å¥½äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»æ˜ç™½äº†ä¸ºä»€ä¹ˆè¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªmetaballæ•™ç¨‹ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„æ•™ç¨‹â€”â€”é‚£å°±å¼€å§‹å§ï¼å’Œå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘æŠŠæ‰€æœ‰å†…å®¹åˆ†è§£æˆå‡ ä¸ªéƒ¨åˆ†ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œæˆ‘ä¼šå¿«é€Ÿè§£é‡Šä¸€ä¸‹è¿™ç§æ•ˆæœåœ¨ç»å…¸å®ç°ä¸­çš„å·¥ä½œåŸç†ï¼Œç„¶åæˆ‘ä»¬ä¼šè¿›è¡Œå“ªäº›ä¸åŒçš„è°ƒæ•´ã€‚</li>
<li>ç„¶åï¼Œæˆ‘ä¼šä»‹ç»ä¸€ä¸‹Composeçš„ç®€å•è®¾ç½®ï¼Œè®©å®ƒè¿è¡Œèµ·æ¥ã€‚</li>
<li>æœ€åï¼Œæˆ‘ä»¬ä¼šæ›´è¯¦ç»†åœ°ä»‹ç»ç€è‰²å™¨æœ¬èº«ã€‚</li>
</ul>


<p>æœ€ç»ˆï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1192/1*2oZU3pJdUVUq1eR56tVTNw.gif" alt="è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªé€‰é¡¹ï¼›è¿™ç§æ•ˆæœæ˜¯é«˜åº¦å¯å®šåˆ¶çš„ã€‚" /></p>

<blockquote><p>å¼€å§‹ä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹â€”â€”æˆ‘ä¸ä¼šä¸ºæˆ‘åˆ¶ä½œçš„æ¯ä¸ªæ•ˆæœéƒ½åˆ¶ä½œæ•™ç¨‹ï¼Œä½†ä½ å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E6%89%80%E6%9C%89%E6%95%99%E7%A8%8B%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E6%89%80%E6%9C%89%E6%95%99%E7%A8%8B%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸Šæ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœå…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>è¦åˆ›å»ºå…ƒçƒæ•ˆæœï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹åŸºç¡€çŸ¥è¯†ã€‚å¦‚ä½•åœ¨ç€è‰²å™¨ä¸­ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„åœ†åœˆï¼Ÿæœ€ç®€å•çš„æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªä¸­å¿ƒå’Œä¸€ä¸ªåŠå¾„ï¼Œç„¶åä½¿ç”¨ step å‡½æ•°ã€‚å¦‚æœåƒç´ æ¯”åŠå¾„æ›´é è¿‘ä¸­å¿ƒï¼Œåˆ™è¿”å› 1ï¼›å¦‚æœåƒç´ æ¯”åŠå¾„æ›´è¿œç¦»ä¸­å¿ƒï¼Œåˆ™è¿”å› 0ã€‚å®é™…ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span> <span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">center</span><span class="p">),</span> <span class="n">radius</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">b1</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>è¿™æ®µä»£ç æ˜¯ç”¨ GLSL ç¼–å†™çš„ï¼Œè€Œä¸æ˜¯ AGSLï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ° shadertoy.com ä¸­ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‰€æœ‰ä»£ç éƒ½å°†é‡‡ç”¨ç›¸åŒçš„æ–¹æ³•ï¼Œè®©ä½ æ— éœ€è¿è¡Œ Android Studio å³å¯æ›´è½»æ¾åœ°æµ‹è¯•å’ŒæŸ¥çœ‹ç»“æœã€‚</p></blockquote>

<p><em>ç»“æœæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„åœ†åœˆã€‚å¦‚æœä½ å¯¹ç€è‰²å™¨ç¨æœ‰äº†è§£ï¼Œè¿™éƒ¨åˆ†åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ã€‚</em></p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*PTHu_h9ayCxqi-EgVN2nVQ.png" alt="æœ€ç®€å•çš„åœ†åœˆ" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ç¬¬äºŒä¸ªåœ†åœˆï¼Œå¹¶å°†å®ƒä»¬æ°´å¹³æ”¾ç½®ï¼Œä½¿å®ƒä»¬ç•¥å¾®åˆ†å¼€ï¼Œè€Œä¸æ˜¯åŒæ—¶ä½äºä¸­å¿ƒã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ä¸å†ä½¿ç”¨æ­¥é•¿å‡½æ•°æ¥å®šä¹‰è¾¹ç¼˜ï¼Œè€Œæ˜¯ä½¿ç”¨åè·ç¦»ã€‚æˆ‘ä»¬ä»ç„¶ä¼šå¾—åˆ°ä¸¤ä¸ªåœ†åœˆï¼Œä½†è¾¹ç¼˜ä¸å†æ˜¯é”åˆ©çš„ï¼Œè€Œæ˜¯å¹³æ»‘çš„æ¸å˜ï¼Œä½¿åœ†åœˆçœ‹èµ·æ¥æ›´åƒå‘å…‰çš„ç‚¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">center</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">dist</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">circles</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">circles</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rXfBtvZOlpnK98XEy7HyUA.png" alt="" /></p>

<p>å¦‚ä½ æ‰€è§ï¼Œåœ¨æœ€ç»ˆå›¾åƒä¸­ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªåœ†çš„å€¼ç›¸åŠ ã€‚å³ä½¿ç°åœ¨ï¼Œå¦‚æœä½ å°†å®ƒä»¬ç§»è¿‘ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ°å®ƒä»¬å¼€å§‹åˆå¹¶ã€‚åŸºæœ¬ä¸Šï¼Œæ•ˆæœå·²ç»å­˜åœ¨â€”â€”å‰©ä¸‹çš„å°±æ˜¯å¯¹æœ€ç»ˆå€¼åº”ç”¨ä¸€äº›å‡½æ•°ï¼Œæˆ–è€…å†æ¬¡ä½¿ç”¨ step å‡½æ•°æˆªæ–­ä½äºç‰¹å®šé˜ˆå€¼çš„æ‰€æœ‰å†…å®¹ï¼Œä¿ç•™å…¶å†…éƒ¨å†…å®¹ã€‚å°±è¿™æ ·â€”â€”å…ƒçƒæ•ˆæœå®Œæˆäº†ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">center</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">dist</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)   </span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// make circles moving slightly along horizontal direction</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">horiz</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">iTime</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="o">+</span><span class="n">horiz</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.3</span><span class="o">-</span><span class="n">horiz</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">circles</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">circles</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rIVQla9lc5qbYGaCMVmI4g.gif" alt="æœ€ç®€å•çš„å…ƒçƒæ•ˆæœ" /></p>

<p>å½“ç„¶ï¼Œé™¤äº†é˜¶è·ƒå‡½æ•°ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ SmoothStepï¼Œæ·»åŠ è·ç¦»çš„å¹³æ–¹åæ¯”ï¼Œæˆ–è€…å°è¯•ä¸åŒçš„å…¬å¼ï¼Œè°ƒæ•´ç³»æ•°ç­‰ç­‰ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¯èƒ½çš„ï¼Œå¹¶ä¸”éƒ½ä¼šæ”¹å˜æœ€ç»ˆçš„å¤–è§‚ï¼Œä½†æ ¸å¿ƒæ€æƒ³ä¿æŒä¸å˜ï¼šæˆ‘ä»¬ç”¨å¹³æ»‘è¡°å‡å…¬å¼å®šä¹‰åœ†ï¼Œå°†ç»“æœç›¸åŠ ï¼Œå¹¶åœ¨æŸä¸ªé˜ˆå€¼å¤„è¿›è¡Œæˆªæ–­ã€‚è¿™æ ·ï¼Œå½“å½¢çŠ¶æ¥è¿‘æ—¶ï¼Œå®ƒä»¬çš„åœºä¹‹å’Œä¼šè¶…è¿‡é˜ˆå€¼ï¼Œä»è€Œåˆå¹¶æˆä¸€ä¸ªå½¢çŠ¶â€”â€”è€Œå½“å®ƒä»¬ç›¸è·è¾ƒè¿œæ—¶ï¼Œåˆ™ä¸ä¼šåˆå¹¶ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•åˆ›å»ºå…ƒçƒæ•ˆæœï¼Œçœ‹èµ·æ¥æˆ‘ä»¬åªéœ€æ‰“å¼€ Android Studio å°±å¯ä»¥å¼€å§‹æ„å»ºäº†ï¼ç„¶è€Œï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ul>
<li>ç›®å‰ï¼Œæ‰€æœ‰æŒ‰é’®éƒ½åƒåœ†å½¢ä¸€æ ·å·¥ä½œâ€”â€”è¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ã€‚ä½†å¦‚æœæˆ‘ä»¬å¸Œæœ›åˆå¹¶æŒ‰é’®å…·æœ‰å…¶ä»–å½¢çŠ¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¾‹å¦‚ SDF æ–¹æ³•ã€‚å³ä¾¿å¦‚æ­¤ï¼Œå½¢çŠ¶ä»ç„¶åœ¨ç€è‰²å™¨å†…éƒ¨å®šä¹‰ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°åœ¨ Compose è§†å›¾ä¸­åº”ç”¨ RoundedCornerShape å¹¶æœŸæœ›å®ƒèƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚</li>
<li>ä¸¤ä¸ªæŒ‰é’®å¿…é¡»åœ¨åŒä¸€ä¸ªç€è‰²å™¨ä¸­å®šä¹‰ã€‚å¦‚æœæœ‰ä¸‰ä¸ªæŒ‰é’®ï¼Œåˆ™ä¸‰ä¸ªæŒ‰é’®éƒ½å¿…é¡»ä½äºåŒä¸€ä¸ªç€è‰²å™¨ä¸­ã€‚æœ€é‡è¦çš„æ˜¯â€”â€”æˆ‘ä»¬å¦‚ä½•å¤„ç†è¿™äº›æŒ‰é’®çš„ç‚¹å‡»ï¼Ÿ</li>
</ul>


<p>å¦‚æœä½ æŸ¥æ‰¾æœ‰å…³æ­¤æ•ˆæœçš„æ–‡ç« ï¼Œä½ ä¼šå‘ç°è¿™ä¸¤ä¸ªé—®é¢˜é€šå¸¸è¢«å¿½ç•¥ã€‚ç„¶è€Œï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå®ƒä»¬è‡³å…³é‡è¦â€”â€”è¿™æ­£æ˜¯æˆ‘å†³å®šæ’°å†™æœ¬æ•™ç¨‹çš„åŸå› ã€‚æˆ‘å»ºè®®é‡‡ç”¨ä¸€ç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ç€è‰²å™¨å†…éƒ¨å®šä¹‰å½¢çŠ¶ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†å˜å½¢åæ ‡ç³»æœ¬èº«ï¼Œä»è€Œè§£å†³ä¸åŒå½¢çŠ¶çš„é—®é¢˜ã€‚</p>

<p>å…¶æ¬¡ï¼Œæ•ˆæœä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¼šè·å¾—è‡ªå·±çš„ç€è‰²å™¨å®ä¾‹ï¼Œä½†æˆ‘ä»¬ä¹Ÿä¼šå°†ç›¸é‚»å…ƒç´ çš„åæ ‡ä¼ é€’ç»™å®ƒã€‚è¿™è§£å†³äº†ç‚¹å‡»å¤„ç†é—®é¢˜ï¼Œå› ä¸ºç°åœ¨æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç»„åˆå…ƒç´ ï¼Œæ‹¥æœ‰è‡ªå·±çš„å±æ€§å’Œ lambda è¡¨è¾¾å¼ã€‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*7yVd3iok98-pQNLWIhP1mQ.png" alt="ç»¿è‰²è¡¨ç¤ºå¯ç»„åˆå…ƒç´ ã€‚ç²‰è‰²è¡¨ç¤ºç€è‰²å™¨" /></p>

<p>å› æ­¤ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸»è¦çš„å­ä»»åŠ¡ã€‚ä¸€æ—¦è§£å†³äº†è¿™ä¸¤ä¸ªå­ä»»åŠ¡ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°æœ€ç»ˆçš„æ•ˆæœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å­¦ä¹ å¦‚ä½•å˜å½¢ç”»å¸ƒä»¥è·å¾—ä¸å…ƒçƒç›¸åŒçš„è§†è§‰æ•ˆæœã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ”¶é›†å®¹å™¨ä¸­æ¯ä¸ªå­å…ƒç´ çš„ä½ç½®æ•°æ®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å…¶ä»–ç€è‰²å™¨ã€‚è®©æˆ‘ä»¬å…ˆä»ç¬¬ä¸€éƒ¨åˆ†å¼€å§‹ã€‚</p>

<p>è®©æˆ‘ä»¬ä»ä½¿ç”¨ç€è‰²å™¨æ‰€éœ€çš„æœ€ç®€å•çš„è®¾ç½®å¼€å§‹ã€‚ä¸‹é¢æ˜¯å¯ç»„åˆéƒ¨åˆ†â€”â€”ä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼Œå®ƒåº”è¯¥å¯ä»¥ç«‹å³è¿è¡Œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MetaballShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">metaballShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF171717</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ShadedButton</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">:</span> <span class="n">RuntimeShader</span><span class="p">,)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">boxSize</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">boxSize</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF6F6F6</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>            <span class="n">imageVector</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">MoreVert</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Expand Menu&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tint</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥ä¸‹æ˜¯ç€è‰²å™¨ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Language</span><span class="p">(</span><span class="s">&quot;AGSL&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">metaballShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">vec2</span> <span class="n">o</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">o</span> <span class="p">/</span> <span class="n">r</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">&gt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="p">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">uv</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">p</span> <span class="p">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="p">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>        <span class="n">vec4</span> <span class="k">final</span> <span class="p">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="m">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="k">final</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘å·²ç»åŒ…å«äº†ä¸¤ä¸ªå¿…è¦çš„æ–¹æ³•ï¼šä¸€ä¸ªç”¨äºè§„èŒƒåŒ–ï¼Œä¸€ä¸ªç”¨äºä»è¾“å…¥çº¹ç†ä¸­è·å–é¢œè‰²ã€‚æˆ‘åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ä»‹ç»è¿‡è¿™äº›æ–¹æ³•ï¼Œå› æ­¤ä½ å¯ä»¥ç®€å•åœ°å°†å®ƒä»¬è§†ä¸ºå¿…éœ€çš„æ ·æ¿ä»£ç â€”â€”å®ƒä»¬ä¸ä¼šå½±å“æ•ˆæœçš„æ ¸å¿ƒé€»è¾‘â€”â€”æˆ–è€…æŸ¥çœ‹æˆ‘ä¹‹å‰çš„æ•™ç¨‹ï¼Œæˆ‘åœ¨é‚£é‡Œè¯¦ç»†è§£é‡Šäº†å®ƒä»¬ã€‚æœ¬è¯¾ç¨‹å·²ç»ç›¸å½“ä¸°å¯Œï¼Œç”šè‡³å¯èƒ½ä¿¡æ¯é‡è¿‡å¤§ï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p></blockquote>

<p>å¤ªå¥½äº†ï¼å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªå°šæœªæ·»åŠ ä»»ä½•å†…å®¹çš„ç€è‰²å™¨â€”â€”å®ƒåªæ˜¯ç»˜åˆ¶æ‰€æœ‰å†…å®¹ï¼Œå°±åƒç€è‰²å™¨æ ¹æœ¬ä¸å­˜åœ¨ä¸€æ ·ã€‚ç»“æœåº”è¯¥åªæ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‰é’®ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*V_yEnqGelKeDKYaPwUklTg.png" alt="æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯ä¸€ä¸ªæŒ‰é’® :)" /></p>

<p>åœ¨æœ€ç»ˆçš„ä»£ç ä¸­ï¼Œå˜å½¢å°†åŸºäºå…¶ä»–å…ƒç´ ï¼Œä½†ç”±äºæˆ‘ä»¬ç›®å‰è¿˜æ²¡æœ‰è¿™äº›å…ƒç´ ï¼Œæˆ‘åªéœ€æ·»åŠ ä¸€ä¸ªè™šæ‹Ÿç‚¹å¹¶å°†å…¶ç»˜åˆ¶åœ¨ç”»å¸ƒä¸Šå³å¯ã€‚è¿™åªæ˜¯æµ‹è¯•ä»£ç ï¼Œæˆ‘ä»¬ç¨åä¼šå°†å…¶ç§»é™¤ã€‚æˆ‘è¿˜ä¼šå°†æ—¶é—´ä¼ é€’ç»™ç€è‰²å™¨ï¼Œå¹¶ä½¿è¯¥ç‚¹æ°´å¹³ç§»åŠ¨ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä½œä¸ºç”»å¸ƒå˜å½¢çš„å‚è€ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">//...</span>
</span><span class='line'> <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>  <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>       <span class="c1">//...</span>
</span><span class='line'>        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'><span class="c1">//...</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ç€è‰²å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ·»åŠ æ—¶é—´ç»Ÿä¸€å‡½æ•°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶æ·»åŠ è™šæ‹Ÿåœ†ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">float</span> <span class="n">getCircle</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŒæ—¶å°†è™šæ‹Ÿåœ†æ·»åŠ åˆ°æœ€ç»ˆè¾“å‡ºä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">circleHorizontalPosition</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">time</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">;</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">helperCicrle</span> <span class="o">=</span> <span class="n">getCircle</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="n">circleHorizontalPosition</span><span class="p">,</span> <span class="mf">0.</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">final</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">helperCicrle</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span> <span class="n">helperCicrle</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">final</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ ·ï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°ä¸€ä¸ªçº¢è‰²çš„å‚è€ƒç‚¹ï¼Œæˆ‘ä»¬å°†ä»¥æ­¤ä¸ºåŸºç¡€æ¥æ‰­æ›²æŒ‰é’®ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rikNEHT918EmDeWLzQsWbA.gif" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•è®¡ç®—æ§åˆ¶ç‚¹å¯¹æŒ‰é’®çš„å½±å“ï¼Œä½¿ç”¨ä¸è®¡ç®—å…ƒçƒå®Œå…¨ç›¸åŒçš„æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">controlPoint</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dist</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">circleHorizontalPosition</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">time</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">;</span>
</span><span class='line'>        <span class="k">vec2</span> <span class="n">controlPointPos</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">circleHorizontalPosition</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">helperCicrle</span> <span class="o">=</span> <span class="n">getCircle</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">controlPointPos</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">getInfluence</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">controlPointPos</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">uv</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">influence</span><span class="p">;</span> <span class="c1">// why here is 1 - influence was explained in Deform the Canvas tutorial</span>
</span><span class='line'>        <span class="k">vec4</span> <span class="n">final</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">final</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">final</span><span class="p">,</span><span class="n">helperCicrle</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span><span class="n">helperCicrle</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">final</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*ivjxpAXa4_O6hDtt.gif" alt="å¤Ÿæç¬‘çš„ï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„" /></p>

<p>ç»“æœå¾ˆæç¬‘ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬çš„é¢„æœŸã€‚å†…éƒ¨çš„ç‘•ç–µï¼ˆâ€œæ´â€æ•ˆæœï¼‰å¯ä»¥é€šè¿‡å°†å½±å“å€¼é™åˆ¶åœ¨ 0 åˆ° 1 ä¹‹é—´è½»æ¾ä¿®å¤ã€‚ç„¶è€Œï¼Œè¿™ä»ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœâ€”â€”æˆ‘ä»¬å¾—åˆ°çš„æ˜¯æ§åˆ¶ç‚¹å‘¨å›´çš„åŒºåŸŸè†¨èƒ€äº†ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ•ˆæœå‡ ä¹æ˜¯ç›¸åçš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆå¾ˆç®€å•ï¼Œä¹Ÿæœ‰ç‚¹æ„æ€â€”â€”è™½ç„¶æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´æ‰æ˜ç™½ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯å°†åæ ‡ä¸­å¿ƒåˆ°æ§åˆ¶ç‚¹çš„è·ç¦»ä¸ä¸¤ä¸ªè·ç¦»ä¹‹å’Œè¿›è¡Œæ¯”è¾ƒï¼šä»ä¸­å¿ƒåˆ°å½“å‰ç‚¹ (uv) çš„è·ç¦»ï¼Œä»¥åŠä»å½“å‰ç‚¹åˆ°æ§åˆ¶ç‚¹çš„è·ç¦»ã€‚ä¸‹å›¾æ˜¯æŒ‰é’®å†…éƒ¨ä¸€ä¸ªéšæœºç‚¹çš„ç¤ºæ„å›¾ã€‚è¿™ä¸ªè·ç¦»æ€»æ˜¯å¤§äºç›´æ¥åˆ°ä¸­å¿ƒçš„è·ç¦»ï¼Œè€Œè¿™ä¸ªæŠ€å·§å°±æ˜¯è®©æˆ‘ä»¬å®ç°å…ƒçƒæ•ˆæœçš„å…³é”®ï¼</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*n7kIFbwMCFNmhinMLfBP6g.png" alt="å¦‚æœæˆ‘ä»¬å°†ç»¿è‰²åˆ°çº¢è‰²çš„è·ç¦»åŠ ä¸Šåˆ°ä¸­å¿ƒçš„è·ç¦»ï¼Œé‚£ä¹ˆç»¿è‰²åˆ°çº¢è‰²çš„è·ç¦»æ€»æ˜¯å¤§äºä¸­å¿ƒåˆ°çº¢è‰²çš„è·ç¦»ã€‚" /></p>

<p>æ‰€ä»¥ï¼Œä¸ºäº†å°†æˆ‘ä»¬ç°åœ¨çš„æ•ˆæœå˜æˆå‡ ä¹å®Œæ•´çš„æ•ˆæœï¼ˆé™¤äº†å¼ºåº¦è®¾ç½®å’Œå…¶ä»–ä¸€äº›å°çš„è°ƒæ•´ï¼‰ï¼Œæˆ‘ä»¬å®é™…ä¸Šåªéœ€è¦å°†ä¸­å¿ƒæ·»åŠ åˆ°è·ç¦»è®¡ç®—ä¸­â€”â€”å°±è¿™æ ·ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">controlPoint</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// float dist = length(controlPoint-uv); - was like that</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span> <span class="c1">//added length(uv);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dist</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*ArDCdZxeCKBBmsfQ.gif" alt="æˆ‘ä»¬å·²ç»å¾—åˆ°äº†æƒ³è¦çš„ç»“æœ" /></p>

<blockquote><p><em>ç°åœ¨å¯ä»¥æ·»åŠ â€œmassâ€æˆ–é™¤ä»¥è·ç¦»çš„å¹³æ–¹æ¥åŠ å¿«æ·¡å‡ºé€Ÿåº¦ã€‚ä½†è¿™äº›éƒ½æ˜¯å®Œå–„çš„ç»†èŠ‚ï¼Œå¹¶éæ ¸å¿ƒæ•ˆæœé€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä½ è‡ªå·±å°è¯•ä¸€ä¸‹ getInfluence æ–¹æ³•ã€‚</em></p></blockquote>

<p>æœ€åä¸€æ­¥æ˜¯ä¼ é€’å¦ä¸€ä¸ªç»„ä»¶çš„åæ ‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç€è‰²å™¨å†…çš„æ§åˆ¶ç‚¹ã€‚å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†è¿™é‡Œæœ‰ä¸€äº›éœ€è¦è®¨è®ºçš„åœ°æ–¹ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæœ€éš¾çš„éƒ¨åˆ†æ˜¯è·å–ä¸ç€è‰²å™¨æœ¬èº«ä½äºåŒä¸€â€œç³»ç»Ÿâ€ä¸­çš„åæ ‡ã€‚è™½ç„¶æ§åˆ¶ç‚¹ä½äºç€è‰²å™¨å†…éƒ¨ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ uv åˆ›å»ºäº†å®ƒï¼Œè€Œ uv å·²ç»æ ¹æ®è§†å›¾çš„å¤§å°è¿›è¡Œäº†å½’ä¸€åŒ–ã€‚ä½†æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬è¦è·å–ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ä½ç½®ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•å°†æ‰€æœ‰è¿™äº›ç»“åˆèµ·æ¥å‘¢ï¼Ÿ</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ·»åŠ ç¬¬äºŒä¸ªæŒ‰é’®ï¼Œå¹¶å°†æ‰€æœ‰å¿…è¦çš„å‚æ•°ä¼ é€’ç»™ç€è‰²å™¨ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†æ·±å…¥ç€è‰²å™¨é€»è¾‘çš„æ ¸å¿ƒâ€”â€”åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æ˜¯æœ€æœ‰è¶£çš„éƒ¨åˆ†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TestShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">metaballShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">parentBoxSize</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">firstButtonPosition</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">secondButtonPosition</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF171717</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInParent</span><span class="p">()</span> <span class="p">+</span>
</span><span class='line'>                            <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">x</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">y</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">*</span> <span class="m">0.5f</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="n">icon</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Favorite</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shader</span> <span class="p">=</span> <span class="n">shader</span><span class="p">,</span>
</span><span class='line'>            <span class="n">parentBoxSize</span> <span class="p">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">otherViewPosition</span> <span class="p">=</span> <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">myPosition</span> <span class="p">=</span> <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">end</span> <span class="p">=</span> <span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInParent</span><span class="p">()</span> <span class="p">+</span>
</span><span class='line'>                            <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">x</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">y</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">*</span> <span class="m">0.5f</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="n">icon</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Star</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shader</span> <span class="p">=</span> <span class="n">shader</span><span class="p">,</span>
</span><span class='line'>            <span class="n">parentBoxSize</span> <span class="p">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">otherViewPosition</span> <span class="p">=</span> <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">myPosition</span> <span class="p">=</span> <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ShadedButton</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">icon</span><span class="p">:</span> <span class="n">ImageVector</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">:</span> <span class="n">RuntimeShader</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">parentBoxSize</span><span class="p">:</span> <span class="n">IntSize</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">myPosition</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">otherViewPosition</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">boxSize</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">boxSize</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;parentBoxSize&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;otherViewPosition&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">otherViewPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">otherViewPosition</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;positionInParent&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">myPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">myPosition</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF6F6F6</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>            <span class="n">imageVector</span> <span class="p">=</span> <span class="n">icon</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Expand Menu&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tint</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ çš„åªæ˜¯ä¼ é€’çˆ¶å®¹å™¨çš„å¤§å°å’Œç›¸é‚»è§†å›¾çš„ä¸­å¿ƒåæ ‡ã€‚è¯·è®°ä½ï¼Œç”±äº Compose å›è°ƒè¿”å›çš„ä½ç½®æ˜¯å·¦ä¸Šè§’ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¼ é€’ä¹‹å‰å¯¹å…¶è¿›è¡Œä¸€äº›è°ƒæ•´ã€‚å¦å¤–ï¼Œè¯·è®°ä½ï¼Œç¬¬ä¸€ä¸ªç»„ä»¶åº”è¯¥åœ¨ otherViewPosition å‚æ•°ä¸­æ¥æ”¶ç¬¬äºŒä¸ªç»„ä»¶ï¼Œç¬¬äºŒä¸ªç»„ä»¶ä¹Ÿåº”è¯¥æ¥æ”¶ç¬¬ä¸€ä¸ªç»„ä»¶ã€‚æœ€é‡è¦çš„æ˜¯ä¸è¦æ··æ·†å®ƒä»¬ :)</p>

<p>è®©æˆ‘ä»¬ç»§ç»­è®¨è®ºç€è‰²å™¨ã€‚æˆ‘ä»¬å°†ä»æ·»åŠ å¿…è¦çš„ uniform å¼€å§‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">otherViewPosition</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">parentBoxSize</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positionInParent</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨åˆ°äº†æœ‰è¶£çš„éƒ¨åˆ†ï¼šä¹‹å‰çš„æ§åˆ¶ç‚¹ç°åœ¨éœ€è¦æ ¹æ®ä¸¤ä¸ªå‚æ•°æ¥è®¡ç®—â€”â€”çˆ¶çº§çš„å¤§å°ä»¥åŠç¬¬äºŒä¸ªè§†å›¾ç›¸å¯¹äºçˆ¶çº§çš„åæ ‡ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è·å–å®¹å™¨å¤§å°ä¸æŒ‰é’®å¤§å°çš„æ¯”ç‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">float</span> <span class="n">parentRatio</span> <span class="o">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ getInfluence æ–¹æ³•ï¼Œå°±èƒ½å°†æ‰€æœ‰å†…å®¹æ•´åˆåˆ°ä¸€ä¸ªåæ ‡ç³»ä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">otherViewPosition</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="mf">2.</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">influence</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†å®é™…ä¸Šï¼Œè¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›ä¸å¤ªæ˜æ˜¾çš„è®¡ç®—ã€‚è€Œä¸”è¿™äº›è®¡ç®—å¹¶éä¸€çœ¼å°±èƒ½è½»æ˜“æŒæ¡ã€‚æ‰€ä»¥æˆ‘å°½é‡æŠŠå®ƒè§£é‡Šå¾—æ¸…æ™°æ˜“æ‡‚ã€‚æ‰€ä»¥ï¼Œä»æ•´ä½“ä¸Šçœ‹ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯è¿™æ ·çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*ttaLU6zCxuP0vuHWmtkgGA.png" alt="å·¦è¾¹æ˜¯æˆ‘ä»¬çš„â€œæ´»åŠ¨â€è§†å›¾ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å§‹ç»ˆå¤„äºè§†å›¾ç€è‰²å™¨çš„â€œå†…éƒ¨â€ã€‚" /></p>

<p>å¥½çš„ï¼Œæˆ‘ä»¬æœ‰çˆ¶å®¹å™¨ã€å®ƒçš„å¤§å°ã€æˆ‘ä»¬è§†å›¾ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ä½ç½®ï¼Œä»¥åŠç›¸é‚»è§†å›¾ï¼ˆæˆ‘ä»¬ä¹‹å‰ç¤ºä¾‹ä¸­çš„æ§åˆ¶ç‚¹ï¼‰çš„ä½ç½®ã€‚æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯å°†è¿™ä¸ªæ§åˆ¶ç‚¹æ”¾åˆ°æˆ‘ä»¬çš„UVåæ ‡ç³»ä¸­ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*S6fLIECuZWm-UYymAuwPbg.png" alt="ä»ä¸Šåˆ°ä¸‹çš„æ•´ä¸ªè¿‡ç¨‹" /></p>

<p>æˆ‘å°è¯•è‡ªä¸Šè€Œä¸‹åœ°è§£é‡Šäº†æ•´ä¸ªè¿‡ç¨‹ã€‚ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä»£ç ï¼Œå¹¶é€æ­¥è®²è§£ä¸€ä¸‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="n">float2</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>  <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">otherViewPosition</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>  <span class="k">float</span> <span class="n">parentRatio</span> <span class="o">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>  <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">parentRatio</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‡è®¾çˆ¶å®¹å™¨çš„å®½åº¦ä¸º 500ã€‚æˆ‘ä»¬åœ¨å…¶ä¸­çš„ä½ç½®ä¸º 100ï¼Œç›¸é‚»è§†å›¾çš„ä½ç½®ä¸º 400ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è·å–ä¸¤ä¸ªè§†å›¾ç›¸å¯¹äºçˆ¶å®¹å™¨çš„æ ‡å‡†åŒ–åæ ‡ï¼ˆåç§» -0.5ï¼‰ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ä½ç½®ä¸º -0.3ï¼Œç›¸é‚»è§†å›¾çš„ä½ç½®ä¸º 0.2ã€‚å› æ­¤ï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»ä¸º 0.5â€”â€”å³çˆ¶å®¹å™¨å®½åº¦çš„ä¸€åŠã€‚ä½†è¯·è®°ä½ï¼Œæˆ‘ä»¬ä½äºé™„åŠ åˆ°è‡ªèº«è§†å›¾çš„ç€è‰²å™¨å†…éƒ¨ï¼Œå› æ­¤å¿…é¡»å°†è¿™ä¸ªå€¼ä¹˜ä»¥çˆ¶å®¹å™¨å¤§å°ä¸æˆ‘ä»¬è§†å›¾å¤§å°çš„æ¯”å€¼ã€‚è¿™æ˜¯å…³é”®çš„ä¸€æ­¥ï¼šæˆ‘ä»¬ç°åœ¨å¾—åˆ°çš„ä¸æ˜¯ 0.5ï¼Œè€Œæ˜¯å¦ä¸€ä¸ªå€¼ï¼Œä½†å®ƒä½äºæˆ‘ä»¬è§†å›¾çš„åæ ‡ç³»ä¸­ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—è·ç¦»ï¼Œå¹¶æ‰§è¡Œä¹‹å‰å¯¹è™šæ‹Ÿæ§åˆ¶ç‚¹æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œï¼</p>

<blockquote><p>_è¿™é‡Œæˆ‘å°†æ‰€æœ‰å†…å®¹ç®€åŒ–ä¸ºæ°´å¹³åæ ‡ï¼Œä½†åŒæ ·çš„é€»è¾‘ä¹Ÿé€‚ç”¨äºå‚ç›´åæ ‡ã€‚æˆ‘åªæ˜¯ä¸æƒ³è®©æœ¬æ¥å°±å¾ˆå¤æ‚çš„è§£é‡Šæ›´åŠ éš¾ä»¥ç†è§£ã€‚</p></blockquote>

<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*OWQ-vSnQ3yAiPloRXBRXQw.png" alt="é™æ€çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¾ˆæ˜æ˜¾ä¸¤ä¸ªè§†å›¾æ˜¯ç›¸äº’å½±å“çš„ã€‚" /></p>

<p>æœ€åä¸€æ­¥æ˜¯ç”¨æ•°ç»„æ›¿æ¢è¿™ä¸¤ä¸ªè§†å›¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ç¬¬ä¸‰ä¸ªã€ç¬¬å››ä¸ªç”šè‡³ç¬¬äº”ä¸ªæŒ‰é’®ã€‚</p>

<p>åœ¨ç€è‰²å™¨ä¸­ï¼Œä¸èƒ½ä½¿ç”¨åŠ¨æ€æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªä¸Šé™â€”â€”æˆ‘é€‰æ‹©äº† 10 ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå•ç‹¬çš„è®¡æ•°å™¨æ¥è®°å½•å®é™…æœ‰å¤šå°‘ä¸ªå…ƒç´ ã€‚ç”±äºæ•°ç»„ä¸èƒ½ç•™ç©ºï¼Œåœ¨ Compose ä¸­ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨ç”¨é›¶ä½ç½®å¡«å……æœªä½¿ç”¨çš„æ§½ä½ï¼Œä½†è®¡æ•°å™¨ä¼šç¡®ä¿è¿™ä¸ä¼šå½±å“æœ€ç»ˆç»“æœã€‚</p>

<p>å› æ­¤ï¼Œåœ¨ç€è‰²å™¨ä¸­ï¼Œuniform å˜é‡çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">uniform</span> <span class="k">int</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positions</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">parentResolution</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positionInParent</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœå¤šä¸ªç›¸é‚»å…ƒç´ åŒæ—¶å½±å“è§†å›¾ï¼ŒgetInfluence æ–¹æ³•å°†å¾ªç¯éå†æ‰€æœ‰å…ƒç´ å¹¶ç´¯ç§¯å½±å“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">rawScale</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="mf">2.</span><span class="p">);</span>
</span><span class='line'>        <span class="n">influence</span> <span class="o">+=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rawScale</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">clamp</span><span class="p">(</span><span class="n">influence</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ Compose ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªåˆ—è¡¨å¹¶ä»”ç»†ä¼ é€’æ‰€æœ‰å€¼ã€‚ä½ ä¹Ÿå¯ä»¥æ·»åŠ åŠ¨ç”»å’Œå…¶ä»–æ•ˆæœï¼Œä½†è¿™ä¼šä½¿ Compose ä»£ç è¿‡è½½ï¼Œåœ¨æœ¬è¯¾ä¸­æ›´éš¾ç†è§£ã€‚æœ¬æ•™ç¨‹å·²ç»ç›¸å½“ä¸°å¯Œï¼Œæ‰€ä»¥æˆ‘åªæ¼”ç¤ºå¦‚ä½•å°†å€¼ä¼ é€’åˆ°æ•°ç»„ä¸­â€”â€”å…¶ä½™çš„å®éªŒç•™ç»™ä½ è‡ªå·± :) è®°ä½ï¼Œä½ å¯ä»¥éšæ—¶æŸ¥çœ‹æˆ‘çš„ä»£ç åº“ä»¥è·å–å®Œæ•´ç‰ˆæœ¬ã€‚</p>

<p>ä¸‹é¢æ˜¯æˆ‘ç¼–å†™çš„ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼Œç”¨äºæ–¹ä¾¿åœ°å‘ç€è‰²å™¨æ·»åŠ åˆ—è¡¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">RuntimeShader</span><span class="p">.</span><span class="n">setVec2ArrayUniform</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Pair</span><span class="p">&lt;</span><span class="n">Float</span><span class="p">,</span> <span class="n">Float</span><span class="p">&gt;&gt;,</span>
</span><span class='line'>
</span><span class='line'><span class="n">maxSize</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">require</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">size</span> <span class="p">&lt;=</span> <span class="n">maxSize</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;Too many elements for uniform &#39;$name&#39;. Maximum allowed is $maxSize, but got ${values.size}&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">padded</span> <span class="p">=</span> <span class="n">values</span> <span class="p">+</span> <span class="n">List</span><span class="p">(</span><span class="n">maxSize</span> <span class="p">-</span> <span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="m">0f</span> <span class="n">to</span> <span class="m">0f</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">floatArray</span> <span class="p">=</span> <span class="n">padded</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">listOf</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">}.</span><span class="n">toFloatArray</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">floatArray</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç”¨æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'>  <span class="n">shader</span><span class="p">.</span><span class="n">setVec2ArrayUniform</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ä½ å¯ä»¥æ·»åŠ ä¸åŒçš„å…ƒç´ ï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­å¹³æ»‘åœ°åˆå¹¶æˆ–åˆ†ç¦»ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*s01C-TPOXIfOwZDg.gif" alt="ä»¥ä¸‹æ˜¯ä¸‰ä¸ªä¸åŒå½¢çŠ¶çš„è§†å›¾" /></p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚è¿™ä¸ªé¡¹ç›®åªæ˜¯æˆ‘çš„ä¸€ä¸ªçˆ±å¥½ï¼Œè¯´å®è¯ï¼Œæˆ‘çš„åŠ¨åŠ›å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ”¶åˆ°çš„åé¦ˆâ€”â€”æ‰€ä»¥æˆ‘éå¸¸é«˜å…´åœ¨é¢‘é“é‡Œè§åˆ°ä½ ã€‚å¦‚æœä½ æ„¿æ„ï¼Œè¯·åœ¨ä½ çš„ç¤¾äº¤åª’ä½“ä¸Šåˆ†äº«è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç©è½¬Shaderä¹‹å­¦ä¼šå¦‚ä½•å˜å½¢ç”»å¸ƒ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas/"/>
    <updated>2025-09-05T22:24:46+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒDeform the canvasã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/deform-the-canvas-57dc59bec42a">https://medium.com/@off.mind.by/deform-the-canvas-57dc59bec42a</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025å¹´8æœˆ2æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*DTU5ja0MLebUmXQMg9qi9w.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä½¿ç”¨ç€è‰²å™¨æ—¶ï¼Œæˆ‘æ€»æ˜¯ç€è¿·äºå¦‚ä½•è½»æ¾åˆ›å»ºçœ‹èµ·æ¥ç²¾è‡´è€Œæ˜‚è´µçš„æ•ˆæœã€‚ä»Šå¤©çš„æ–‡ç« å°±æ˜¯å¦ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚æœ€è¿‘ï¼Œæˆ‘çš„ Telegram é¢‘é“çš„ä¸€ä½è®¢é˜…è€…é—®æˆ‘ï¼Œå¦‚ä½•åœ¨ç”¨æ‰‹æŒ‡æ‹–åŠ¨è§†å›¾æ—¶åˆ›å»ºæ‹‰ä¼¸æ•ˆæœã€‚è‡ªç„¶è€Œç„¶åœ°ï¼Œæˆ‘ç«‹åˆ»æƒ³åˆ°äº†ç”¨ç€è‰²å™¨æ¥å®ç°ã€‚ç°åœ¨ç»“æœå·²ç»å‡ºæ¥äº†ï¼Œæˆ‘å¾ˆé«˜å…´åˆ†äº«æˆ‘çš„æ„å»ºè¿‡ç¨‹ã€‚å’Œå¾€å¸¸ä¸€æ ·ï¼Œè¿™ç¯‡æ–‡ç« åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†å±•ç¤ºäº† Compose çš„ç®€å•è®¾ç½®ï¼Œç¬¬äºŒéƒ¨åˆ†é€æ­¥è®²è§£ç€è‰²å™¨ï¼Œæœ€åï¼Œæˆ‘ä»¬å°†åœ¨ Compose ä¸­æ·»åŠ ä¸€äº›å°ç»†èŠ‚ï¼Œè¿™äº›ç»†èŠ‚å®é™…ä¸Šæ„æˆäº† 90% çš„è§†è§‰æ•ˆæœâ€”â€”å°½ç®¡è¿™å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹ä¸å…¬å¹³ã€‚</p>

<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1196/1*M42RvZvThTrI7UMjelqb5w.gif" alt="æœ€ç»ˆç»“æœ" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰æ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> (é“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders">https://github.com/AleksiejVolkov/runtimeshaders</a>)ä¸Šæ‰¾åˆ°ã€‚ä½ è¿˜å¯ä»¥åœ¨æˆ‘çš„ <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸­æ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœçš„å…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>è®©æˆ‘ä»¬ä»æœ€åŸºæœ¬çš„ Compose è®¾ç½®å¼€å§‹ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä¸ä¼šåŒ…å«ä»»ä½•èƒŒæ™¯å›¾ç‰‡æˆ–é¢å¤–çš„æ ·å¼ã€‚æˆ‘ä»¬ä¼šå°½å¯èƒ½åœ°ä¿æŒç®€æ´ã€‚æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªåº”ç”¨ç€è‰²å™¨çš„å®¹å™¨ã€ä¸€äº›ç€è‰²å™¨æœ¬èº«çš„å‚æ•°ï¼Œä»¥åŠä¸€ä¸ªæ”¾ç½®åœ¨ç€è‰²å™¨ç›’å†…çš„èœå•æˆ–åˆ—è¡¨çš„åŸºæœ¬æ¨¡æ‹Ÿã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¼€å§‹æ‰€éœ€çš„åŸºæœ¬è®¾ç½®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">targetPercentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">percentage</span> <span class="p">=</span> <span class="n">animateFloatAsState</span><span class="p">(</span>
</span><span class='line'>    <span class="n">targetValue</span> <span class="p">=</span> <span class="n">targetPercentage</span><span class="p">,</span>
</span><span class='line'>    <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span>
</span><span class='line'>          <span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span>
</span><span class='line'>          <span class="n">easing</span> <span class="p">=</span> <span class="n">ElasticOutEasing</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">pressed</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">fingerPosition</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">fingerStartPosition</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span><span class="n">Box</span><span class="p">(</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                    <span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">awaitPointerEventScope</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">event</span> <span class="p">=</span> <span class="n">awaitPointerEvent</span><span class="p">()</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">change</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">changes</span><span class="p">.</span><span class="n">firstOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="k">continue</span>
</span><span class='line'>                        <span class="n">pressed</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">pressed</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">.</span><span class="n">previousPressed</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                               <span class="n">fingerStartPosition</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">position</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                            <span class="n">targetPercentage</span> <span class="p">=</span> <span class="m">1f</span>
</span><span class='line'>                            <span class="n">fingerPosition</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">position</span> <span class="p">-</span> <span class="n">fingerStartPosition</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">targetPercentage</span> <span class="p">=</span> <span class="m">0f</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">event</span><span class="p">.</span><span class="n">changes</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">consume</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;touch&quot;</span><span class="p">,</span> <span class="n">fingerPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">fingerPosition</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">targetPercentage</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">targetPercentage</span> <span class="p">==</span> <span class="m">0f</span><span class="p">)</span> <span class="m">1f</span> <span class="k">else</span> <span class="m">0f</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">//... è¿™é‡Œæ˜¯ä¸‹æ‹‰åˆ—è¡¨æœ¬èº«æˆ–ä»»ä½•å…¶ä»–å¯ä»¥é€šè¿‡æ‹–åŠ¨æ‹‰ä¼¸çš„å¯ç»„åˆé¡¹</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>shader -</strong> è¿™æ˜¯ç€è‰²å™¨æœ¬èº«ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ç¼–å†™å®ƒã€‚</p>

<p><strong>targetPercentage</strong>ã€<strong>percentage</strong> å’Œ <strong>pressed -</strong> è¿™äº›æ§åˆ¶ä¼ é€’ç»™ç€è‰²å™¨çš„æ•ˆæœå¼ºåº¦ã€‚æˆ‘ä»¬éœ€è¦å®ƒä»¬æ¥ä¸ºç”¨æˆ·æŠ¬èµ·æ‰‹æŒ‡åçš„â€œåå¼¹â€æ•ˆæœæ·»åŠ åŠ¨ç”»æ•ˆæœã€‚æ€è·¯å¾ˆç®€å•ï¼šå½“æœ‰æ´»åŠ¨è§¦æ‘¸æ—¶ï¼Œå¼ºåº¦ä¸º 1ï¼ˆæœ€å¤§å€¼ï¼‰ï¼Œå½“ç”¨æˆ·æŠ¬èµ·æ‰‹æŒ‡æ—¶ï¼Œæˆ‘ä»¬å°†å…¶åŠ¨ç”»åŒ–ä¸º 0ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è‡ªå®šä¹‰çš„ <strong><em>ElasticOutEasing</em></strong> æ¥ä»£æ›¿å¸¸è§„çš„çº¿æ€§åŠ¨ç”»ï¼Œæˆ‘å°†åœ¨æœ€åä¸€èŠ‚ä¸­å¯¹å…¶è¿›è¡Œæè¿°ã€‚</p>

<p><strong>fingerPosition</strong> å’Œ <strong>fingerStartPosition -</strong> æˆ‘ä»¬åªå°†å¢é‡å‘é‡ä¼ é€’ç»™ç€è‰²å™¨ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å…³å¿ƒæ–¹å‘å’Œå¼ºåº¦ï¼ˆå‘é‡é•¿åº¦ï¼‰ã€‚æ‹‰ä¼¸å§‹ç»ˆä»ä¸­å¿ƒå¼€å§‹ï¼ˆæˆ‘å‘ç°è¿™æ¯”ä»ç²¾ç¡®çš„è§¦æ‘¸ç‚¹å¼€å§‹æ›´ç¾è§‚ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å­˜å‚¨ä¸¤ä¸ªå€¼ï¼Œå¹¶å°†å®ƒä»¬çš„å·®å€¼ä¼ é€’ç»™ç€è‰²å™¨ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨ <strong>onSizeChanged</strong> ä¸­ï¼Œæˆ‘ä»¬å°†è§†å›¾å¤§å°ä¼ é€’ç»™ç€è‰²å™¨ã€‚åœ¨ pointerInput ä¸­ï¼Œæˆ‘ä»¬è·Ÿè¸ªæ‹–åŠ¨å¹¶è®¡ç®—å¢é‡å‘é‡ã€‚æœ€åï¼Œåœ¨ <strong>graphicsLayer</strong> ä¸­ï¼Œæˆ‘ä»¬å°†å¢é‡å’Œæ•ˆæœå¼ºåº¦ä¼ é€’ç»™ç€è‰²å™¨ã€‚</p>

<p>æ¥ä¸‹æ¥æ˜¯åŒ…å«å°†è¦æ‹‰ä¼¸çš„è§†å›¾ç¤ºä¾‹çš„ä»£ç å—ã€‚å®ƒå®é™…ä¸Šåªæ˜¯ä¸€æ®µåŸºæœ¬çš„å ä½ç¬¦ä»£ç ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºä¸å€¼å¾—è¯¦ç»†åˆ†æã€‚æˆ‘å°†å…¶åŒ…å«åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿â€”â€”è¿™æ ·ä½ å°±å¯ä»¥å¤åˆ¶å®ƒï¼Œè€Œä¸å¿…æ‹…å¿ƒè‡ªå·±ç¼–å†™å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">actions</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;Cut&quot;</span><span class="p">,</span> <span class="s">&quot;Copy&quot;</span><span class="p">,</span> <span class="s">&quot;Paste&quot;</span><span class="p">,</span> <span class="s">&quot;Edit&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">Column</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">x8843484C</span><span class="p">),</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">border</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Gray</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">actions</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">action</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.8f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">action</span> <span class="p">!=</span> <span class="s">&quot;Edit&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">HorizontalDivider</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compose çš„è®¾ç½®å°±åˆ°è¿™é‡Œï¼è®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ç€è‰²å™¨å§ï¼</p>

<p>æˆ‘ä»¬ä»æœ€ç®€å•çš„ç€è‰²å™¨å¼€å§‹ã€‚ä¸‹é¢æ˜¯è¾“å‡ºè¾“å…¥çš„æç®€ä»£ç ï¼Œæ— éœ€è¿›è¡Œä»»ä½•é‡å¤§æ›´æ”¹ã€‚æˆ‘å”¯ä¸€æ·»åŠ çš„æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œæ–¹ä¾¿ä»¥åä¿®æ”¹ã€‚å®ƒå«åš <strong>GetImageTexture</strong>ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œä½ å¯ä»¥ä½¿ç”¨ <strong>image.eval(fragCoord)</strong> è¿”å›æ‰€æœ‰æœªæ›´æ”¹çš„å›¾åƒï¼Œä½†æ˜¯ä¸€æ—¦åœ¨é‡æ–°æ˜ å°„å›¾åƒä¹‹å‰å¼€å§‹ä¿®æ”¹åæ ‡ï¼Œå°±éœ€è¦å¤„ç†å®½é«˜æ¯”å’Œå›¾åƒå¹³ç§»â€”â€”è¿™åŸºæœ¬ä¸Šå°±æ˜¯ä½¿ç”¨ä»¥ç”»å¸ƒä¸­å¿ƒä¸ºä¸­å¿ƒçš„åæ ‡ç³»ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å¤„ç†è¿™äº›é—®é¢˜ã€‚ä½ åªéœ€å‘å®ƒä¼ é€’æ ‡å‡†åŒ–çš„ UV åæ ‡ã€è‡ªå®šä¹‰ä¸­å¿ƒç‚¹å’Œåˆ†è¾¨ç‡ï¼Œå®ƒå°±ä¼šè¿”å›æ­£ç¡®çš„ç»“æœã€‚å¦‚æœä½ ç°åœ¨ä½¿ç”¨è¿™äº›è®¾ç½®è¿è¡Œç€è‰²å™¨ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸ä¸ä½¿ç”¨ç€è‰²å™¨æ—¶å®Œå…¨ç›¸åŒçš„å›¾åƒã€‚è¿™æ˜¯ä¸€ä¸ªå¥½å…†å¤´ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float2</span> <span class="n">touch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span> <span class="p">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span> <span class="p">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">float</span> <span class="n">ratio</span> <span class="p">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">img</span> <span class="p">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="m">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ åœ¨è¿™é‡Œçœ‹åˆ°çš„åº”è¯¥éå¸¸ç†Ÿæ‚‰â€”â€”å‡ ä¹æ‰€æœ‰æˆ‘çš„ç€è‰²å™¨éƒ½æ˜¯è¿™æ ·å¯åŠ¨çš„ï¼Œè¯´å®è¯ï¼Œå¤§å¤šæ•°å…¶ä»–ç€è‰²å™¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘å†é‡å¤ä¸€éï¼šæˆ‘ä»¬è·å– fragCoordï¼Œå®ƒæ˜¯æ¯ä¸ªåƒç´ ç›¸å¯¹äºè§†å›¾ç”»å¸ƒçš„ä½ç½®ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ ‡å‡†åŒ–çš„ UV åæ ‡ç³»ï¼Œæ ¹æ®å®½é«˜æ¯”è¿›è¡Œè°ƒæ•´ï¼Œå¹¶åç§» 0.5â€”â€”è¿™å°†åŸç‚¹ç½®äºè§†å›¾çš„æ­£ä¸­å¤®ã€‚å¹¶éæ¯ä¸ªäººéƒ½è¿™æ ·åšï¼Œä½†æˆ‘è§‰å¾—è¿™æ ·æ›´æ–¹ä¾¿ã€‚å®ƒå¯ä»¥â€œå…è´¹â€åœ°å®ç°å¾ˆå¤šæ•ˆæœï¼Œæ¯”å¦‚é•œåƒè¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬åªå›´ç»•ä¸­å¿ƒè®¡ç®—ä¸€æ¬¡æ‰€æœ‰å†…å®¹ï¼Œè€Œä¸æ˜¯åˆ†åˆ«å¤„ç†æ¯æ¡è¾¹ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬ç”»å¸ƒçš„ç¤ºæ„å›¾ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*1aPwjWpXJgxlQ8-mCJ2JBA.png" alt="æ–¹å½¢ç”»å¸ƒçš„ç®€å• UV å›¾ç¤º" /></p>

<p>å¥½äº†ï¼Œç°åœ¨è¯¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬æƒ³è¦å®ç°çš„æ•ˆæœäº†ã€‚æˆ‘ä»¬éœ€è¦ä»ä¸­å¿ƒï¼ˆåœ¨å½“å‰å®ç°ä¸­ï¼‰æ²¿ç€ç‰¹å®šå‘é‡æ‹‰ä¼¸ç”»å¸ƒï¼ŒåŒæ—¶ä¿æŒå…¶ä½™éƒ¨åˆ†ä¸å˜ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•æ‹‰ä¼¸ç”»å¸ƒå‘¢ï¼Ÿå…¶å®ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä¹˜ä»¥ä¸€ä¸ªæ•°å­—ï¼è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹â€”â€”æ·»åŠ ä¸€ä¸ªæ¯”ä¾‹å˜é‡å¹¶å°è¯•ä¸€ä¸‹ã€‚æœ€åï¼Œæˆ‘ä»¬å°† UV ä¹˜ä»¥è¿™ä¸ªæ¯”ä¾‹å‘é‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'><span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="k">vec4</span> <span class="n">img</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*_C7fYI8VQn5WKMOFUSnbdA.png" alt="å·¦è¾¹æ˜¯åŸå§‹å›¾åƒï¼Œå³è¾¹æ˜¯æˆ‘ä»¬åº”ç”¨äº†ç¼©æ”¾æ•ˆæœçš„å›¾åƒã€‚" /></p>

<p>å°è¯•ä½¿ç”¨ä¸åŒçš„<strong>scale</strong>å€¼æ¥æ›´å¥½åœ°æ„Ÿå—æ•ˆæœã€‚æ­£å¦‚ä½ æ‰€æ³¨æ„åˆ°çš„â€”â€”ä½¿ç”¨1ä¸ä¼šæ”¹å˜ä»»ä½•å€¼ï¼Œå› ä¸ºä¹˜ä»¥1åå€¼ä¿æŒä¸å˜ã€‚å°äº1çš„å€¼ä¼šæ‹‰ä¼¸å›¾åƒï¼Œè€Œå¤§äº1çš„å€¼ä¼šå‹ç¼©å›¾åƒã€‚è®°ä½è¿™ä¸€ç‚¹â€”â€”æˆ‘ä»¬ç¨åä¼šè®¡ç®—ç¼©æ”¾å¼ºåº¦å¹¶å°†å…¶ä»1ä¸­å‡å»ï¼Œè¿™æ ·å½“ç¼©æ”¾ä¸ºé›¶æ—¶ï¼Œæ•ˆæœä¹Ÿä¸ºé›¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¹˜ä»¥äº†ä¸€ä¸ªå•ä½å‘é‡ã€‚</p>

<p>å¤ªå¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å°†è§¦æ‘¸ä½ç½®æ·»åŠ åˆ°è®¡ç®—ä¸­ã€‚ç®€å•å›é¡¾ä¸€ä¸‹â€”â€”æˆ‘ä»¬ä»è§¦æ‘¸ä¸­æ¥æ”¶äº†ä¸€ä¸ªä½ç§»å‘é‡ã€‚å› æ­¤ï¼Œå½“æ‰‹æŒ‡è§¦æ‘¸å±å¹•æ—¶ï¼Œå‘é‡ä¸º (0, 0)ã€‚å¦‚æœæˆ‘ä»¬å°†æ‰‹æŒ‡å‘å³ç§»åŠ¨ 20 åƒç´ ï¼Œåˆ™å¾—åˆ° (20, 0)ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¹è¿™ä¸ªå‘é‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œå¹¶å°†å…¶ä¹˜ä»¥å®½é«˜æ¯”ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">nMouse</span> <span class="o">=</span> <span class="n">touch</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæˆ‘ä»¬å°†æ‰‹æŒ‡å‘å·¦ç§»åŠ¨ 20 åƒç´ ï¼Œåˆ™ä¼šå¾—åˆ°ä¸€ä¸ª (-20, 0) çš„å‘é‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªå‘é‡ä½œä¸ºæ¯”ä¾‹ï¼Œè€Œæ˜¯å–å…¶é•¿åº¦ã€‚å®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>è®°ä½ï¼Œæ²¡æœ‰æ•ˆæœæ„å‘³ç€ä¹˜ä»¥ 1ï¼Œè€Œä¸æ˜¯ä¹˜ä»¥ 0ï¼Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨æ¯”ä¾‹å‘é‡æ—¶ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ä¹‹å‰å…ˆå°†å…¶ä» 1 ä¸­å‡å»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">scale</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œæˆ‘ä»¬ç°åœ¨åº”è¯¥èƒ½å¤Ÿæ§åˆ¶æ²¿ä¸¤ä¸ªè½´çš„æ‹‰ä¼¸ã€‚å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/1*ix2Fe4IcYGkQ_iHmSHJ3jA.gif" alt="" /></p>

<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½â€”â€”ç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šåº”ç”¨æ‹‰ä¼¸ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é‡çš„ç‚¹ç§¯ã€‚åŸç†å¾ˆç®€å•ï¼šå¦‚æœå‘é‡æŒ‡å‘åŒä¸€æ–¹å‘ï¼Œåˆ™æ­¤è¿ç®—è¿”å›æ­£å€¼ï¼›å¦‚æœå‘é‡æŒ‡å‘ç›¸åæ–¹å‘ï¼Œåˆ™è¿”å›è´Ÿå€¼ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä½ åœ¨ä¸“ç”¨èµ„æºä¸Šé˜…è¯»æ›´å¤šå…³äºæ­¤è¿ç®—ï¼ˆä»¥åŠå…¶ä»–å‘é‡è¿ç®—ï¼‰çš„å†…å®¹ï¼Œå› ä¸ºçº¿æ€§ä»£æ•°æ˜¯ç€è‰²å™¨ä¸­ä¸€åˆ‡çš„åŸºç¡€ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå®ƒåœ¨å®è·µä¸­çš„å·¥ä½œåŸç†ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">nMouse</span><span class="p">),</span> <span class="n">uv</span><span class="p">);</span>
</span><span class='line'><span class="n">scale</span> <span class="o">*=</span> <span class="n">influence</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*aKRAalWcQzf2Jugs18aEoQ.png" alt="åº”ç”¨ç‚¹ç§¯å" /></p>

<p>å¦‚ä½ æ‰€è§ï¼Œæ•ˆæœå·²ç»è¿‘ä¹å®Œç¾ï¼ä½†æˆ‘ä¸å¤ªå–œæ¬¢å¦ä¸€ä¾§åœ¨å¦ä¸€ä¸ªæ–¹å‘ä¸Šå˜å½¢ï¼ˆå³è¢«å‹ç¼©ï¼‰ã€‚è¿™æ˜¯ç‚¹ç§¯çš„å‰¯ä½œç”¨â€”â€”å½“å®ƒè¿”å›è´Ÿå€¼æ—¶ï¼Œç¼©æ”¾æ¯”ä¾‹ä¹Ÿä¼šå˜ä¸ºè´Ÿå€¼ï¼Œç”»å¸ƒçš„è¿™ä¸€éƒ¨åˆ†ä¼šè¢«æŒ¤å‹ã€‚æˆ‘å¸Œæœ›ä¿æŒè§†å›¾çš„è¿™ä¸€éƒ¨åˆ†ä¸å˜ï¼Œæ‰€ä»¥æˆ‘æ·»åŠ äº†ä¸€ä¸ªä»é›¶åˆ°å®šä¹‰æœ€å¤§å€¼çš„çº¿æ€§æ’å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">influence</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åä¸€æ­¥æ˜¯ä¹˜ä»¥â€œæ•ˆæœå¼ºåº¦â€ï¼Œæˆ‘ä»¬é€šè¿‡ç™¾åˆ†æ¯”å‚æ•°ä¼ é€’è¯¥å¼ºåº¦ï¼ˆä¹Ÿè®¸è¿™ä¸æ˜¯æœ€å¥½çš„å‘½åï¼Œä½†æˆ‘ä¹ æƒ¯è¿™æ ·ç§°å‘¼å®ƒï¼‰ã€‚è¿™ä¸ä¼šæ”¹å˜æ‹–åŠ¨è¿‡ç¨‹ä¸­çš„è¡Œä¸ºï¼Œä½†å®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨æ‹–åŠ¨ç»“æŸåå¹³æ»‘åœ°å°†è§†å›¾æ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">scale</span> <span class="o">*=</span> <span class="n">percentage</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å°±æ˜¯è¿™æ ·ï¼ç€è‰²å™¨å·²å‡†å¤‡å°±ç»ªã€‚ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç â€”â€”å°½ç®¡æœ€ç»ˆçš„è§†è§‰æ•ˆæœçœ‹èµ·æ¥ä¸°å¯Œè€Œå¤æ‚ï¼Œä½†å®ƒç®€æ´æ˜äº†ã€‚åœ¨æœ€ç»ˆç‰ˆæœ¬ä¸­ï¼Œæˆ‘è¿˜é™åˆ¶äº† x è½´å’Œ y è½´ä¸Šçš„æœ€å¤§ç¼©æ”¾å€¼ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦éšæ„è°ƒæ•´è¿™äº›å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">float2</span> <span class="n">touch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">nMouse</span> <span class="o">=</span> <span class="n">touch</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">nMouse</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mf">0.4</span><span class="p">));</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">nMouse</span><span class="p">),</span> <span class="n">uv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">influence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">scale</span> <span class="o">*=</span> <span class="n">influence</span><span class="p">;</span>
</span><span class='line'>    <span class="n">scale</span> <span class="o">*=</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">scale</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">img</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æ¥çœ‹çœ‹æˆ‘ä» Compose ä¸­ç•™ä¸‹çš„éƒ¨åˆ†â€”â€”ElasticOutEasingã€‚åœ¨ Compose ä¸­åˆ›å»ºåŠ¨ç”»æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å†…ç½®çš„ç¼“åŠ¨å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„ç¼“åŠ¨å‡½æ•°ã€‚æˆ‘ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„å¼¹æ€§ç¼“åŠ¨å‡½æ•°ç¤ºä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">ElasticOutEasing</span> <span class="p">=</span> <span class="n">Easing</span> <span class="p">{</span> <span class="n">t</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">p</span> <span class="p">=</span> <span class="m">0.3f</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="p">==</span> <span class="m">0f</span> <span class="p">||</span> <span class="n">t</span> <span class="p">==</span> <span class="m">1f</span><span class="p">)</span> <span class="n">t</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">s</span> <span class="p">=</span> <span class="n">p</span> <span class="p">/</span> <span class="m">4</span>
</span><span class='line'>        <span class="m">2f</span><span class="p">.</span><span class="n">pow</span><span class="p">(-</span><span class="m">10f</span> <span class="p">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">*</span> <span class="n">sin</span><span class="p">((</span><span class="n">t</span> <span class="p">-</span> <span class="n">s</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="m">2f</span> <span class="p">*</span> <span class="n">PI</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span> <span class="p">/</span> <span class="n">p</span><span class="p">)</span> <span class="p">+</span> <span class="m">1f</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤ç¼“åŠ¨å‡½æ•°åœ¨åŠ¨ç”»ç»“æŸæ—¶åˆ›å»ºç±»ä¼¼å¼¹è·³çš„æ•ˆæœã€‚å®ƒä¸€å¼€å§‹å¾ˆå¿«ï¼Œç„¶åç•¥å¾®è¶…è¿‡ç›®æ ‡å¹¶ç¨³å®šä¸‹æ¥ï¼Œæ¨¡ä»¿å¼¹ç°§çš„è¡Œä¸ºã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æŒ‡æ•°è¡°å‡ (2^-10t) ä¸æ­£å¼¦æ³¢ç›¸ç»“åˆï¼Œä»¥æ¨¡æ‹Ÿå¼¹æ€§è¿åŠ¨ã€‚å®ƒåœ¨èµ·å§‹ (0) å’Œç»“æŸ (1) å¤„è¿”å›ç²¾ç¡®å€¼ï¼Œä½†åœ¨ä¸¤è€…ä¹‹é—´æ·»åŠ äº†ä¸€ä¸ªæŠ–åŠ¨ã€‚</p>

<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¸¸è§„çš„çº¿æ€§ç¼“åŠ¨ï¼Œä½†ç»“æœçœ‹èµ·æ¥ä¼šæ›´åŠ å¹³æ·¡ã€‚è¿™æ­£æ˜¯æˆ‘åœ¨å¼€å¤´æåˆ°çš„â€”â€”è¿™ä¸ªå°ç»†èŠ‚ä¸ºæ•´ä½“æ•ˆæœçš„æµç•…åº¦å’Œä»¤äººæ»¡æ„çš„ä½“éªŒè´¡çŒ®äº† 90%ï¼</p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„ <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> æˆ–åœ¨ <a href="https://x.com/KrowaNaMostku">Twitter (X)</a> ä¸Šå…³æ³¨æˆ‘ã€‚è¿™ä¸ªé¡¹ç›®åªæ˜¯æˆ‘çš„ä¸€ä¸ªçˆ±å¥½ï¼Œè¯´å®è¯ï¼Œæˆ‘çš„åŠ¨åŠ›å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ”¶åˆ°çš„åé¦ˆâ€”â€”æ‰€ä»¥æˆ‘éå¸¸é«˜å…´åœ¨é¢‘é“é‡Œè§åˆ°ä½ ã€‚å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œè¯·å°†è¿™ç¯‡æ–‡ç« åˆ†äº«åˆ°ä½ çš„ç¤¾äº¤åª’ä½“ä¸Šï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ·±å…¥æµ…å‡ºç€è‰²å™¨ï¼šæåæ ‡ç³»ä¸ç‚«é…·ç¯å½¢è¿›åº¦æ¡]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader/"/>
    <updated>2025-08-18T22:20:10+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCircle bars with AGSLã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/circle-bars-with-agsl-37d0612c34a2">https://medium.com/@off.mind.by/circle-bars-with-agsl-37d0612c34a2</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025å¹´1æœˆ6æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*eA4A8yhl-BSTW4EoFMDRJw.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä»Šå¤©ï¼Œæˆ‘å°†å‘å¤§å®¶è®²è§£å¦‚ä½•ä½¿ç”¨æåæ ‡ç³»ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦ä½†åˆç›¸å½“ç®€å•çš„ä¸»é¢˜ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†ä¸€ä¸ªç›´æˆªäº†å½“çš„æ•ˆæœï¼Œä»¥é¿å…è¿‡å¤šåœ°æ·±å…¥è®²è§£å…¶ä»–ç»†èŠ‚ã€‚ä¸å¾€å¸¸ä¸€æ ·ï¼Œæœ¬æ•™ç¨‹åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘å°†æ¦‚è¿°è®¾ç½®ç€è‰²å™¨æ‰€éœ€çš„æœ€ç®€ Compose ä»£ç ã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†è¯¦ç»†è§£é‡Šç€è‰²å™¨æœ¬èº«ä»¥åŠä½¿ç”¨æåæ ‡çš„åŸç†ã€‚æœ€åï¼Œæˆ‘ä»¬å°†è¿›è¡Œä¸€äº›æ”¶å°¾å·¥ä½œï¼Œä½¿æ•ˆæœæ›´åŠ æƒŠè‰³ã€‚</p>

<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ç°å¦‚ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*RA4vKEMtnGVL78RVxe9Avg.gif" alt="" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ¯ä¸ªæ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸­æ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœçš„å…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>å’Œå¾€å¸¸ä¸€æ ·ï¼Œè®©æˆ‘ä»¬ä»å¸ƒå±€å¼€å§‹ã€‚æˆ‘å°†åŸºç¡€ Compose ç»„ä»¶å‘½åä¸ºâ€œTimerShaderScreenâ€ã€‚åœ¨ç»„ä»¶å†…éƒ¨ï¼Œæˆ‘ä»¬å°†ä»ä¸€ä¸ªâ€œColumnâ€å®¹å™¨å¼€å§‹ï¼Œè¯¥å®¹å™¨é¡¶éƒ¨åŒ…å«ä¸€ä¸ªè¾“å…¥å­—æ®µï¼Œåé¢è·Ÿç€ä¸€ä¸ªâ€œBoxâ€ã€‚è¿™ä¸ªâ€œBoxâ€åœ¨åŒä¸€å±‚çº§ä¸ŠåŒ…å«ä¸€ä¸ªå°†åº”ç”¨ç€è‰²å™¨çš„â€œBoxâ€å’Œä¸€ä¸ªæ˜¾ç¤ºå½“å‰è®¡æ—¶å™¨å€¼çš„â€œTextâ€å…ƒç´ ï¼ˆè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼‰ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªâ€œBoxâ€ï¼Œä½†è¿™ä¼šä½¿ç€è‰²å™¨ç¨å¾®å¤æ‚ä¸€äº›ã€‚ä¸ºäº†ç®€åŒ–æœ¬æ•™ç¨‹ï¼Œæˆ‘é€‰æ‹©äº†ç¨å¾®å¤æ‚çš„æ„å›¾ï¼Œä»¥ä½¿ç€è‰²å™¨ä¿æŒç®€æ´ã€‚åœ¨è¿™ä¸ªâ€œBoxâ€ä¹‹åï¼Œæœ‰ä¸€ä¸ªç”¨äºå¯åŠ¨è®¡æ—¶å™¨çš„æŒ‰é’®ã€‚æˆ‘æä¾›äº†ä¸€ä¸ªå¸ƒå±€å›¾ï¼Œä»¥ä¾¿æ›´æ¸…æ™°åœ°å±•ç¤ºï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå¸ƒå±€æœ¬èº«å·²ç»éå¸¸ç®€å•äº†ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*oIa0bosA1IbHuMZVKw9tFw.png" alt="" /></p>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·»åŠ å¿…è¦çš„å˜é‡å¹¶å®šä¹‰æ•´ä¸ªå¸ƒå±€ã€‚ç”±äºæˆ‘ä»¬å°šæœªå‡†å¤‡å¥½ç€è‰²å™¨ï¼Œå› æ­¤ä½ å¯ä»¥æš‚æ—¶è·³è¿‡â€œRuntimeShaderâ€å˜é‡ï¼Œåªéœ€è¿è¡Œé¡¹ç›®å¹¶ç¡®ä¿ä¸€åˆ‡æ­£å¸¸å³å¯ã€‚æˆ‘æƒ³å¼ºè°ƒä¸€ä¸ªé‡è¦çš„ç»†èŠ‚ï¼šå¦‚æœä½ å°†ç€è‰²å™¨åº”ç”¨äºä¸€ä¸ªä¸åŒ…å«ä»»ä½•å†…å®¹çš„â€œBoxâ€ï¼Œåˆ™éœ€è¦ä¸ºå…¶è®¾ç½®èƒŒæ™¯é¢œè‰²ã€‚è¿™ç¡®ä¿å®ƒå‚ä¸åˆæˆï¼Œä»è€Œä½¿æˆ‘ä»¬çš„æ•ˆæœå¯è§ã€‚ä½†æ˜¯ï¼ŒåŠ¡å¿…åœ¨åº”ç”¨â€œgraphicsLayerâ€ä¹‹åè®¾ç½®èƒŒæ™¯é¢œè‰²ã€‚å¦åˆ™ï¼Œåªä¼šæ¸²æŸ“é¢œè‰²ï¼Œç€è‰²å™¨å°†ä¸å¯è§ã€‚ç›®å‰ï¼Œå¸ƒå±€åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TimerShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">startValue</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">20</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">percentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0.0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">isRunning</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">seconds</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">startValue</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// circularTimeShaderæ˜¯ä¸€ä¸ªåŒ…å«ç€è‰²å™¨ä»£ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„éƒ¨åˆ†ä¸­ç¼–å†™</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">circularTimerShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">),</span>
</span><span class='line'>        <span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">horizontalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterHorizontally</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">OutlinedTextField</span><span class="p">(</span>
</span><span class='line'>            <span class="n">value</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">startValue</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="n">startValue</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onValueChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">startValue</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">toIntOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start value&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">it</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">),</span> <span class="c1">// &lt;-- æˆ‘ä»¬å¿…é¡»æ·»åŠ ä¸€äº›é¢œè‰²ï¼Œå¦åˆ™ç©ºæ¡†å°±ä¼šä»æ„å›¾ä¸­ç§»é™¤ï¼Œå°±çœ‹ä¸å‡ºæ•ˆæœäº†</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">textAlign</span> <span class="p">=</span> <span class="n">TextAlign</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>                <span class="n">text</span> <span class="p">=</span> <span class="n">seconds</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">fontSize</span> <span class="p">=</span> <span class="m">50.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>                <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Thin</span><span class="p">,</span>
</span><span class='line'>                <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">OutlinedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="p">!</span><span class="n">isRunning</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="s">&quot;Stop&quot;</span> <span class="k">else</span> <span class="s">&quot;Start&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯å®ƒåœ¨æ‰‹æœºä¸Šçš„å®é™…æ˜¾ç¤ºæ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:924/1*HPGAGRtgTmxrihj91xiRXw.png" alt="" /></p>

<p>å‰©ä¸‹çš„å°±æ˜¯æ·»åŠ è®¡æ—¶å™¨æœ¬èº«çš„é€»è¾‘ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿›å…¥æ­£æ–‡äº†ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>LaunchedEffect</code> æ¥åœ¨è®¡æ—¶å™¨è¿è¡Œæ—¶æ›´æ–°å…¶å€¼ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤ä»£ç å—ä¸­è®¡ç®—ç€è‰²å™¨çš„ <code>percentage</code>ã€‚ç”±äºæˆ‘ä»¬çš„ç€è‰²å™¨ä¼šä»è®¡æ—¶å™¨çš„èµ·å§‹å€¼å‘ä¸‹è¿‡æ¸¡åˆ°é›¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹ <code>percentage</code> å˜é‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶ç›¸åº”åœ°ä» 0 å˜ä¸º 1ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span> <span class="c1">// æ—¶é—´åˆ°æ—¶åœæ­¢å€’è®¡æ—¶</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">elapsedTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span> <span class="c1">// å·²ç”¨æ—¶é—´ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰</span>
</span><span class='line'>        <span class="n">percentage</span> <span class="p">=</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">)</span> <span class="p">/</span> <span class="n">startValue</span> <span class="c1">// å°†ç»è¿‡çš„æ—¶é—´å½’ä¸€åŒ–ä¸º[0,1]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// å°†ç™¾åˆ†æ¯”é™åˆ¶åœ¨ [0, 1] ä¹‹é—´ä»¥é¿å…è¿‡å†²</span>
</span><span class='line'>        <span class="n">percentage</span> <span class="p">=</span> <span class="n">percentage</span><span class="p">.</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// è®¡ç®—å‰©ä½™ç§’æ•°</span>
</span><span class='line'>        <span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="p">((</span><span class="n">startValue</span> <span class="p">-</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">))).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="c1">// å»¶è¿Ÿä»¥æ§åˆ¶æ›´æ–°é¢‘ç‡</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compose éƒ¨åˆ†å°±åˆ°æ­¤ä¸ºæ­¢ï¼›è®©æˆ‘ä»¬ç»§ç»­ç¼–å†™ç€è‰²å™¨å§ï¼</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰æ¥è‡ª UI çš„å˜é‡ï¼Œä»¥åŠç€è‰²å™¨çš„æœ€ä½è®¾ç½®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿”å›åƒç´ ä¸å½’ä¸€åŒ–åæ ‡ä¸­å¿ƒçš„è·ç¦»ï¼Œä½œä¸ºé¢œè‰²ï¼š<code>length(uv)</code>ã€‚å¦‚æœè¿™éƒ¨åˆ†å†…å®¹ä¸å¤ªæ¸…æ¥šï¼Œå¼ºçƒˆå»ºè®®ä½ æŸ¥çœ‹æˆ‘çš„<a href="https://juejin.cn/post/7535292253813981247">æ•™ç¨‹</a>ï¼Œäº†è§£å¦‚ä½•åœ¨ Android ä¸­ä½¿ç”¨ç€è‰²å™¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">circularTimerShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>        <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>å› æ­¤ï¼Œç›®å‰æˆ‘ä»¬å¾—åˆ°çš„å¤§è‡´å¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*e2GHAO-1N7K0KBjN4wAYww.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•åœ¨æ ‡å‡†ç¬›å¡å°”å¹³é¢ä¸Šç»˜åˆ¶ä¸€ä¸ªâ€œæ …æ â€ï¼Œå³ä¸€ç³»åˆ—å‚ç›´çš„æ¡å½¢ã€‚å¦‚ä½•å®ç°è¿™ä¸ªæ•ˆæœï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬å°† y è½´ä¸Šçš„æ‰€æœ‰å€¼é™åˆ¶åœ¨é›¶ä»¥ä¸‹ã€‚ç€è‰²å™¨ç°åœ¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜å°†æ²¿ x è½´è£å‰ªæ‰ä¸€åŠçš„åŒºåŸŸã€‚è®°ä½ï¼Œæˆ‘ä»¬çš„ <code>uv</code> åæ ‡åç§»äº† 0.5ï¼Œä½¿é›¶ç‚¹ä½äºä¸­å¿ƒã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ²¿ x è½´åœ¨é›¶ç‚¹å¤„è£å‰ªï¼Œåªç•™ä¸‹å³ä¸Šè±¡é™ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'><span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°† x è½´ä¸Šçš„åæ ‡ä¹˜ä»¥ 10ï¼Œå¹¶åªå–å°æ•°éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ x è½´å€¼ï¼š<code>[0...1, 0...1, 0...1, ...]</code>ã€‚å†å°†å®ƒä»¬å¹³ç§» 0.5ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†â€œæ …æ â€ã€‚ä¸‹é¢ï¼Œæˆ‘æ¼”ç¤ºäº†æ„å»ºå‚ç›´æ¡çš„ä¸‰ä¸ªæ­¥éª¤ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*l7X_24sRzAI7iYZLqeWKFQ.png" alt="" /></p>

<p>ç°åœ¨åˆ°äº†æœ€æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†ï¼šå¦‚ä½•ä»ç¬›å¡å°”åæ ‡ç³»è¿‡æ¸¡åˆ°æåæ ‡ç³»ï¼Ÿæ¢å¥è¯è¯´ï¼Œå¦‚ä½•åˆ›å»ºç›¸åŒçš„â€œæ …æ â€ï¼Œä½†ä½¿å…¶çœ‹èµ·æ¥åƒåœ†å½¢ï¼Ÿè®©æˆ‘ä»¬æ¥å¼„æ¸…æ¥šã€‚</p>

<p>æˆ‘ä»¬ä¹ æƒ¯ç”¨ä¸¤ä¸ªå€¼æ¥æè¿°å‡½æ•°ï¼š<code>x</code> å’Œ <code>y</code>ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç¡®å®šåƒç´ åœ¨å¹³é¢ä¸Šçš„ç²¾ç¡®ä½ç½®å¹¶ä¸ºå…¶åˆ†é…é¢œè‰²ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåæ ‡ç³»æ˜¯ <code>uv</code>ã€‚ä¸ºäº†å‚ç›´è£å‰ªï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>y</code>ï¼›ä¸ºäº†æ°´å¹³è£å‰ªâ€œæ …æ â€çš„å„ä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>x</code>ã€‚</p>

<p>æåæ ‡ç³»ä¸æ­¤éå¸¸ç›¸ä¼¼ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨çš„ä¸æ˜¯æ°´å¹³è½´å’Œå‚ç›´è½´ï¼Œè€Œæ˜¯åŠå¾„ï¼ˆä¸åŸç‚¹çš„è·ç¦»ï¼‰å’Œè§’åº¦ã€‚</p>

<p>æ¢å¥è¯è¯´ï¼Œç”±äºè¿™ä¸¤ä¸ªåæ ‡ç³»éƒ½åŒ…å«ä¸¤ä¸ªåˆ†é‡ï¼Œç†è§£å®ƒä»¬çš„å«ä¹‰ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›¸å¯¹è½»æ¾åœ°å°†ç¬›å¡å°”åæ ‡ç³»ä¸­ä½¿ç”¨çš„å…¬å¼å’ŒæŠ€æœ¯åº”ç”¨äºæåæ ‡ç³»ã€‚ç„¶è€Œï¼Œæœ€ç»ˆçš„å›¾åƒçœ‹èµ·æ¥ä¼šâ€œå¼¯æ›²â€æˆä¸€ä¸ªåœ†å½¢ã€‚è®©æˆ‘ä»¬å°è¯•å°†â€œæ …æ â€è½¬æ¢ä¸ºæåæ ‡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">atan</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬æ¢ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">// åŠå¾„</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="c1">// è§’åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*UR389J0im6ziWvc_d9ERzA.png" alt="æåæ ‡ç³»ä¸­çš„â€œæ …æ â€" /></p>

<p>ä½†æ˜¯ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œå…‰çº¿çš„å®½åº¦éšç€è¿œç¦»ä¸­å¿ƒè€Œå¢åŠ ã€‚æˆ‘ä»¬å¯ä»¥æ·»åŠ è¡¥å¿æ¥æ¶ˆé™¤è¿™ç§å½±å“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å®½åº¦å·²è°ƒæ•´çš„è¿›åº¦æ¡</span>
</span><span class='line'><span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// Bar width</span>
</span><span class='line'><span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'><span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦é™åˆ¶å†…åŠå¾„ï¼Œè¿˜éœ€è¦é™åˆ¶å¤–åŠå¾„ï¼Œä»¥åˆ›å»ºä¸€ä¸ªç¯ï¼Œè€Œä¸æ˜¯æ— é™å»¶ä¼¸çš„å…‰çº¿ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨è¿›åº¦æ¡ä¸Š</span>
</span><span class='line'><span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'><span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ€»çš„æ¥è¯´ï¼Œæ­¤æ—¶å®ƒçœ‹èµ·æ¥åº”è¯¥åƒè¿™æ ·ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// è¿›åº¦æ¡å®½åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬åŒ–ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// åŠå¾„</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è§’åº¦</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">innerMask</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å®½åº¦å·²è°ƒæ•´çš„è¿›åº¦æ¡</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨è¿›åº¦æ¡ä¸Š</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ç»“åˆè¿›åº¦æ¡å’Œå†…å±‚è’™ç‰ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1288/1*B_VJQme_vnEdXq0pEmfLZg.png" alt="" /></p>

<p>æœ€åä¸€æ­¥æ˜¯æ ¹æ® <code>percentage</code> çš„å€¼å¢åŠ åˆ—çš„å¤§å°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè§’åº¦ <code>theta</code> çš„å½“å‰èŒƒå›´æ˜¯ä» <code>-Pi</code> åˆ° <code>Pi</code>ï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œå½’ä¸€åŒ–ï¼Œå³å°†å…¶è½¬æ¢ä¸ºä» <code>0</code> åˆ° <code>1</code> çš„èŒƒå›´ã€‚è¿™æ ·å¯ä»¥æ›´å®¹æ˜“åœ°å°†å…¶ä¸ <code>percentage</code> çš„å€¼å¯¹é½ï¼Œå› ä¸º <code>percentage</code> çš„å€¼ä¹Ÿæ˜¯ä» <code>0</code> åˆ° <code>1</code> å˜åŒ–çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// è¿˜å°†å…¶ç§»åŠ¨ï¼Œä½¿é›¶ä½äºé¡¶éƒ¨è€Œä¸æ˜¯å·¦ä¾§</span>
</span><span class='line'><span class="k">float</span> <span class="n">normalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸ºâ€œwaveâ€åº”ç”¨å¦ä¸€ä¸ªè’™ç‰ˆï¼Œå®ƒå°†å–å†³äº <code>percentage</code> å˜é‡çš„å½“å‰å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜éœ€è¦å°†è¿™ä¸ªæ³¢æµªçš„å€¼æ·»åŠ åˆ° <code>barRadius</code> ä¸­ï¼Œå¹¶åœ¨æœ€åå°†æ•´ä½“é®ç½©ä¹˜ä»¥ <code>waveMask</code>ã€‚æ­¤å¤–ï¼Œæˆ‘å°†æœ€ç»ˆ Alpha å€¼çš„å¸¸é‡å€¼æ›¿æ¢ä¸ºç»„åˆé®ç½©çš„å€¼ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ç°åœ¨å¾—åˆ°äº†ä¸€ä¸ªå‡ ä¹å®Œæ•´çš„æ•ˆæœã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å…¶ä½™ä»£ç  ...</span>
</span><span class='line'>
</span><span class='line'><span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">;</span> <span class="c1">// ä½¿ç”¨æ³¢å½¢è’™ç‰ˆè®¾ç½®æ¡å½¢åŠå¾„</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'><span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span> <span class="o">*</span> <span class="n">waveMask</span><span class="p">;</span>
</span><span class='line'><span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">combinedMask</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*ZduMs_yVlmd5r7CxADMpRQ.gif" alt="" /></p>

<p>æˆ‘æƒ³åœ¨æœ¬èŠ‚ä¸­æ·»åŠ çš„æœ€åä¸€ç‚¹æ˜¯ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹è’™ç‰ˆã€‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæ¯ä¸ªåˆ—çš„å·¦å³è¾¹ç¼˜åŠå¾„ä¸åŒï¼Œä½†æˆ‘å¸Œæœ›å®ƒä»¬çš„é«˜åº¦ä¸€è‡´ã€‚è¿™æ ·å¯ä»¥ä½¿æ•ˆæœçœ‹èµ·æ¥æ›´ç®€æ´ä¸€äº›ã€‚ä»¥ä¸‹æ˜¯å®ç°æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// åœ¨æ¯ä¸ªæ¡å½¢çš„ä¸­å¿ƒé‡‡æ ·æ³¢å½¢è’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">barIndex</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">);</span> <span class="c1">// ç¡®å®šæ¡çš„ç´¢å¼•</span>
</span><span class='line'><span class="k">float</span> <span class="n">centerTheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">barIndex</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">;</span> <span class="c1">// æ¡çš„ä¸­å¿ƒè§’</span>
</span><span class='line'><span class="k">float</span> <span class="n">centerNormalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">centerTheta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ€»çš„æ¥è¯´ï¼Œæ ¸å¿ƒæ•ˆæœç°åœ¨å·²ç»å®Œæˆã€‚ç„¶è€Œï¼Œåœ¨ç€è‰²å™¨ä¸­ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œ99% å¤æ‚è€Œæœ‰è¶£çš„å·¥ä½œæ„æˆäº†æ•ˆæœçš„åŸºç¡€ï¼Œä½†å•ç‹¬æ¥çœ‹ï¼Œæ•ˆæœå¯èƒ½çœ‹èµ·æ¥ç®€å•å¹³æ·¡ã€‚æ­£æ˜¯è¿™æœ€åçš„ 1% çš„æ¶¦è‰²ï¼Œæ‰èƒ½å½»åº•æ”¹å˜ä¸€åˆ‡ï¼</p>

<p>è®©æˆ‘ä»¬ä¸ºç€è‰²å™¨æ·»åŠ ä¸€ä¸ªæ¸å˜ã€‚æˆ‘ä½¿ç”¨äº†æœ€ç®€å•çš„ä¸€ä¸ªï¼Œå®ƒåœ¨ <a href="http://shadertoy.com/">ShaderToy</a> ï¼ˆé“¾æ¥ï¼š<a href="http://shadertoy.com/%EF%BC%89%E4%B8%AD%E5%90%AF%E5%8A%A8%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%BB%98%E8%AE%A4%E5%88%9B%E5%BB%BA%EF%BC%88%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E5%B9%B6%E7%82%B9%E5%87%BB%E5%8F%B3%E4%B8%8A%E8%A7%92%E7%9A%84%E2%80%9C%E6%96%B0%E5%BB%BA%E2%80%9D%E6%8C%89%E9%92%AE%E6%9F%A5%E7%9C%8B%EF%BC%89%E3%80%82%E6%88%91%E6%8A%8A%E5%AE%83%E7%A7%BB%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%AD%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E5%91%BD%E5%90%8D%E4%B8%BA">http://shadertoy.com/%EF%BC%89%E4%B8%AD%E5%90%AF%E5%8A%A8%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%BB%98%E8%AE%A4%E5%88%9B%E5%BB%BA%EF%BC%88%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E5%B9%B6%E7%82%B9%E5%87%BB%E5%8F%B3%E4%B8%8A%E8%A7%92%E7%9A%84%E2%80%9C%E6%96%B0%E5%BB%BA%E2%80%9D%E6%8C%89%E9%92%AE%E6%9F%A5%E7%9C%8B%EF%BC%89%E3%80%82%E6%88%91%E6%8A%8A%E5%AE%83%E7%A7%BB%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%AD%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E5%91%BD%E5%90%8D%E4%B8%BA</a> <code>gradient</code>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec3</span> <span class="n">gradient</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">uv</span><span class="p">.</span><span class="n">xyx</span> <span class="o">+</span> <span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œæˆ‘ä¸å†å°†æœ€ç»ˆé¢œè‰²ä¹˜ä»¥ <code>vec3(1.)</code>ï¼ˆå³ç™½è‰²ï¼‰ï¼Œè€Œæ˜¯å°†å…¶ä¹˜ä»¥æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ¸å˜ã€‚æ­¤å¤–ï¼Œæˆ‘è¿˜å¯¹å…¶ä½™åŒºåŸŸåº”ç”¨äº†ç›¸åŒçš„æ¸å˜ï¼Œä½† Alpha å€¼éå¸¸ä½ï¼Œè¿™ä¸ºæ•´ä¸ªå±å¹•å¢æ·»äº†å¾®å¦™çš„è¾‰å…‰ã€‚</p>

<blockquote><p>è¯·æ³¨æ„ï¼Œè¦çœ‹åˆ°è¿™ä¸ªæ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¿…é¡»ä» Compose ä»£ç ä¸­ä¼ é€’ <code>time</code>ã€‚</p></blockquote>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*DXGRdfXQ67eQG7UMnMy8lw.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è½¬åˆ°é¡¹ç›®çš„å¯ç»„åˆéƒ¨åˆ†ï¼Œå¹¶åœ¨æ–‡æœ¬å˜åŒ–æ—¶æ·»åŠ åŠ¨ç”»å’Œæ¨¡ç³Šæ•ˆæœã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ï¼Œå› ä¸ºè¿™è¶…å‡ºäº†æœ¬è¯¾çš„èŒƒå›´ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ¬æ•™ç¨‹å®Œå…¨ä¸åŒ…å«ä»£ç ï¼Œæ„Ÿè§‰ä¸å¤ªå¯¹åŠ²ã€‚æ‰€ä»¥ï¼Œä»¥ä¸‹æ˜¯å¯ç»„åˆéƒ¨åˆ†ï¼ˆåŒ…å«æ—¶é—´æ›´æ–°å’Œæ–‡æœ¬åŠ¨ç”»ï¼‰çš„æœ€ç»ˆç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TimerShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">startValue</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">20</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">percentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0.0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">isRunning</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">circularTimerShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">seconds</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">startValue</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span> <span class="c1">// æ—¶é—´åˆ°æ—¶åœæ­¢å€’è®¡æ—¶</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">elapsedTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span> <span class="c1">// å·²ç”¨æ—¶é—´ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰</span>
</span><span class='line'>            <span class="n">percentage</span> <span class="p">=</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">)</span> <span class="p">/</span> <span class="n">startValue</span> <span class="c1">// å°†ç»è¿‡çš„æ—¶é—´å½’ä¸€åŒ–ä¸º[0,1]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// å°†ç™¾åˆ†æ¯”é™åˆ¶åœ¨ [0, 1] ä¹‹é—´ä»¥é¿å…è¿‡å†²</span>
</span><span class='line'>            <span class="n">percentage</span> <span class="p">=</span> <span class="n">percentage</span><span class="p">.</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// è®¡ç®—å‰©ä½™ç§’æ•°</span>
</span><span class='line'>            <span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="p">((</span><span class="n">startValue</span> <span class="p">-</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">))).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="c1">// å»¶è¿Ÿä»¥æ§åˆ¶æ›´æ–°é¢‘ç‡</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">),</span>
</span><span class='line'>        <span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">horizontalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterHorizontally</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">OutlinedTextField</span><span class="p">(</span>
</span><span class='line'>            <span class="n">value</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">startValue</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="n">startValue</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onValueChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">startValue</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">toIntOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start value&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">it</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="k">var</span> <span class="py">previousSeconds</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">coerceAtLeast</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">AnimatedContent</span><span class="p">(</span>
</span><span class='line'>                <span class="n">targetState</span> <span class="p">=</span> <span class="n">seconds</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">coerceAtLeast</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
</span><span class='line'>                <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="p">(</span><span class="n">slideInVertically</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">))</span> <span class="p">{</span> <span class="n">height</span> <span class="p">-&gt;</span> <span class="p">-</span><span class="n">height</span> <span class="p">}</span> <span class="p">+</span> <span class="n">fadeIn</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span>
</span><span class='line'>                            <span class="m">500</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">))</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">togetherWith</span><span class="p">(</span><span class="n">slideOutVertically</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">))</span> <span class="p">{</span> <span class="n">height</span> <span class="p">-&gt;</span> <span class="n">height</span> <span class="p">}</span> <span class="p">+</span> <span class="n">fadeOut</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">))</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;CountdownAnimation&quot;</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span> <span class="n">targetSeconds</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="c1">// æ£€æµ‹æ˜¯å¦æ­£åœ¨è½¬æ¢</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">isTransitioning</span> <span class="p">=</span> <span class="n">targetSeconds</span> <span class="p">!=</span> <span class="n">previousSeconds</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// è¿‡æ¸¡æœŸé—´æ¨¡ç³ŠåŠ¨ç”»</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">blurRadius</span> <span class="k">by</span> <span class="n">animateFloatAsState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">targetValue</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">isTransitioning</span><span class="p">)</span> <span class="m">30f</span> <span class="k">else</span> <span class="m">0f</span><span class="p">,</span> <span class="c1">// è¿‡æ¸¡æ—¶æ¨¡ç³Š</span>
</span><span class='line'>                    <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">500</span><span class="p">)</span> <span class="c1">// åŒ¹é…è¿‡æ¸¡æŒç»­æ—¶é—´</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// è½¬æ¢å®Œæˆåæ›´æ–° previousSeconds</span>
</span><span class='line'>                <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">targetSeconds</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">previousSeconds</span> <span class="p">=</span> <span class="n">targetSeconds</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="c1">// åº”ç”¨åŠ¨ç”»æ¨¡ç³Šæ•ˆæœ</span>
</span><span class='line'>                            <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createBlurEffect</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">blurRadius</span><span class="p">,</span> <span class="n">blurRadius</span><span class="p">,</span> <span class="n">android</span><span class="p">.</span><span class="n">graphics</span><span class="p">.</span><span class="n">Shader</span><span class="p">.</span><span class="n">TileMode</span><span class="p">.</span><span class="n">CLAMP</span>
</span><span class='line'>                            <span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                    <span class="n">textAlign</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">TextAlign</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">text</span> <span class="p">=</span> <span class="n">targetSeconds</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">fontSize</span> <span class="p">=</span> <span class="m">50.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">font</span><span class="p">.</span><span class="n">FontWeight</span><span class="p">.</span><span class="n">Thin</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">OutlinedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="p">!</span><span class="n">isRunning</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="s">&quot;Stop&quot;</span> <span class="k">else</span> <span class="s">&quot;Start&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥åŠæœ€ç»ˆçš„ç€è‰²å™¨ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span><span class="k">vec2</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">atan</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="k">vec3</span> <span class="n">gradient</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">uv</span><span class="p">.</span><span class="n">xyx</span> <span class="o">+</span> <span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// æ¡å½¢å®½åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬æ¢ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">// åŠå¾„</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>    <span class="c1">// è§’åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">innerMask</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†é¡¶éƒ¨è®¾ä¸ºé›¶ï¼Œä½¿è§’åº¦æ ‡å‡†åŒ–</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">normalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å›ºå®šç™¾åˆ†æ¯”è¡¥å¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fixPercentage</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">+</span> <span class="n">percentage</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// åœ¨æ¯ä¸ªæ¡å½¢çš„ä¸­å¿ƒé‡‡æ ·æ³¢å½¢è’™æ¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barIndex</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">);</span> <span class="c1">// ç¡®å®šæ¡çš„ç´¢å¼•</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">centerTheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">barIndex</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">;</span> <span class="c1">// æ¡çš„ä¸­å¿ƒè§’</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">centerNormalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">centerTheta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™æ¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å®½åº¦å·²è°ƒæ•´çš„æ¡å½¢å›¾æ¡ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨å§å°ä¸Š</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">;</span> <span class="c1">// ä½¿ç”¨æ³¢å½¢è’™ç‰ˆè®¾ç½®æ¡å½¢åŠå¾„</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ç»“åˆæ¡å½¢å’Œå†…å±‚è’™ç‰ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span> <span class="o">*</span> <span class="n">waveMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">combinedMask</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”è®²è§£æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚ä½ çš„æ”¯æŒæ„ä¹‰é‡å¤§ï¼Œå¹¶æ¿€åŠ±ç€æˆ‘ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç”¨Composeä¸­çš„Shaderå®ç°ä¸€ä¸ªé›ªèŠ±é£˜é£˜å¼¹çª—æ•ˆæœ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader/"/>
    <updated>2025-08-17T22:02:24+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒSnow Dialog Shader Tutorialã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20">https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´12æœˆ27æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*oNN6ZtalbQEvYCpTx8gLWg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘å¤§å®¶å±•ç¤ºå¦‚ä½•åˆ›å»ºé›ªèŠ±è¦†ç›–çš„å¯¹è¯æ¡†æ•ˆæœã€‚æ€»çš„æ¥è¯´ï¼Œè¯¥æ•ˆæœå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>

<ol>
<li><strong>è®¾ç½® Compose ä»£ç </strong>ï¼šè¿™ç¡®ä¿äº†åŸºç¡€æ•ˆæœçš„å®ç°ã€‚</li>
<li><strong>åˆ›å»ºå¯¹è¯æ¡†åº•éƒ¨ç§¯é›ªçš„ç€è‰²å™¨</strong>ï¼šè¿™æ˜¯æˆ‘åœ¨ä»Šå¤©æ•™ç¨‹ä¸­é‡ç‚¹è®²è§£çš„æ ¸å¿ƒæ•ˆæœã€‚</li>
<li><strong>æ·»åŠ é£˜è½çš„é›ªèŠ±</strong>ï¼šä¸ºæ­¤ï¼Œæˆ‘åœ¨ ShaderToy ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªç°æˆçš„ç€è‰²å™¨ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œä½¿å…¶ä¸ä¼šå¯¹æ‰‹æœºæ€§èƒ½é€ æˆå¤ªå¤§è´Ÿæ‹…ã€‚ç¬¬ä¸‰éƒ¨åˆ†å°†åŒ…å«åŸå§‹ç€è‰²å™¨çš„é“¾æ¥ä»¥åŠä¸€äº›ä¼˜åŒ–è¯´æ˜ã€‚</li>
</ol>


<p>æœ¬æ•™ç¨‹ä¸»è¦è®²è§£å¦‚ä½•ä¸ºå¯¹è¯æ¡†åˆ›å»ºä¸æ–­å¢é•¿çš„é›ªç›–æ•ˆæœã€‚</p>

<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:804/1*SRa57BglcDzpLzAAw1UAPw.gif" alt="æœ€ç»ˆæ•ˆæœ" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰æ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ï¼ˆé“¾æ¥ï¼š<a href="https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81">https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81</a></p></blockquote>

<p>è®©æˆ‘ä»¬ä» Compose ä¸­ä¸ºæ•ˆæœè®¾ç½®ä¸€ä¸ªæœ€å°é¡µé¢å¼€å§‹ã€‚å®ƒåŒ…å«ä¸€å¼ èƒŒæ™¯å›¾ç‰‡å’Œä¸€ä¸ªä½äºä¸­å¿ƒçš„æŒ‰é’®ï¼Œç”¨äºè§¦å‘å¯¹è¯æ¡†ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹è¯æ¡†ä¸åº”æ¥è‡ª Material åº“ï¼Œè€Œåº”ä½¿ç”¨ Compose ä¸­æœ€åŸºæœ¬çš„â€œAlertDialogâ€ã€‚</p>

<p>ä»¥ä¸‹æ˜¯æœ€ä½é…ç½®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">SnowDialogScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showDialog</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>            <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">christmas_night</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Sample Image&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>        <span class="k">if</span> <span class="p">(!</span><span class="n">showDialog</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">showDialog</span> <span class="p">=</span> <span class="k">true</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Ho-ho-ho!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SnowedDialog</span> <span class="p">{</span> <span class="n">showDialog</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Merry Christmas!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">titleLarge</span><span class="p">)</span>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Happy New Year!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">26.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">End</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Close&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">bodyMedium</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">primary</span><span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆï¼Œä½ åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*fnlF56ZxRxMwa7vHkCOudA.png" alt="é¢œè‰²å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œæ­¤å¤–è§‚å·²é’ˆå¯¹æš—é»‘æ¨¡å¼è¿›è¡Œäº†è°ƒæ•´" /></p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™ç€è‰²å™¨äº†ï¼æˆ‘å°†ç®€è¦ä»‹ç»å¦‚ä½•è®¾ç½®ç€è‰²å™¨å¹¶å°†å…¶é™„åŠ åˆ°å¯¹è¯æ¡†ä¸­ã€‚æœ‰å…³è¿è¡Œæ—¶ç€è‰²å™¨çš„æ›´è¯¦ç»†ä»‹ç»å’Œåˆå­¦è€…æŒ‡å—ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„å¦ä¸€ä¸ª<a href="https://juejin.cn/post/7535292253813981247">æ•™ç¨‹</a>ã€‚</p>

<p>å¼€å§‹ä½¿ç”¨ç€è‰²å™¨æ‰€éœ€çš„æœ€ä½è¦æ±‚å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨å¯¹è¯æ¡†ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª <code>runtimeShader</code>ï¼Œå¹¶ä½¿ç”¨ <code>graphicsLayer</code> å°†å…¶åˆ†é…ç»™ <code>Column</code>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ä»å­—ç¬¦ä¸²ç¼–è¯‘æˆ‘ä»¬çš„ç€è‰²å™¨</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="c1">// pass resolution</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// apply shader </span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// å…¶ä½™ä»£ç ä¿æŒä¸å˜</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Language</span><span class="p">(</span><span class="s">&quot;agsl&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)&gt;</span><span class="m">0.5</span> <span class="p">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)&gt;</span><span class="m">0.5</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="m">0.0</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="n">float</span> <span class="n">ratio</span> <span class="p">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>         <span class="n">vec4</span> <span class="n">imageColor</span> <span class="p">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">vec3</span><span class="p">(</span><span class="m">1.0</span><span class="p">),</span> <span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç›®å‰ï¼Œå®ƒå°†æ˜¾ç¤ºä¸ºä¸€ä¸ªç©ºç™½çŸ©å½¢ï¼Œå°±åƒæˆ‘ä»¬çš„å¯¹è¯æ¡†ä¸€æ ·ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*C5O1IMHS7MvK0lFnIqHFYA.png" alt="" /></p>

<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘å…ˆå°½å¯èƒ½ç®€å•åœ°è§£é‡Šä¸€ä¸‹å®ç°æ­¤æ•ˆæœèƒŒåçš„é€»è¾‘ã€‚æˆ‘å°†ç®—æ³•åˆ†ä¸ºå››ä¸ªæ¦‚å¿µæ­¥éª¤ï¼š</p>

<ol>
<li><strong>æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°</strong>æ¥å®šä¹‰é›ªè¾¹ç¼˜çš„è½®å»“ã€‚</li>
<li><strong>åœ¨ y è½´ä¸Š</strong>ç»˜åˆ¶æ­¤å‡½æ•°ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹**ï¼Œå¹¶å°†å…¶å‚ç›´ç§»å‘åº•éƒ¨è¾¹ç¼˜ã€‚</li>
<li><strong>å®šä¹‰ä¸€ä¸ªé®ç½©åŒºåŸŸ</strong>ï¼Œè¿™æ„å‘³ç€åœ¨æ­¤åŒºåŸŸä¹‹å¤–ï¼Œå‡½æ•°å°†è¢«å®Œå…¨å¿½ç•¥ï¼Œæˆ‘ä»¬åªéœ€ç»˜åˆ¶ç€è‰²å™¨ä»ç³»ç»Ÿæ¥æ”¶çš„å†…å®¹å³å¯ã€‚</li>
<li><strong>ä¿®æ”¹ä¾§é¢å’Œé¡¶éƒ¨çš„é®ç½©</strong>ï¼Œä½¿é›ªçš„å½¢çŠ¶æ›´è‡ªç„¶ï¼Œè€Œåº•éƒ¨è¾¹ç¼˜çš„è½®å»“åˆ™ç”±æˆ‘ä»¬çš„å‡½æ•°å¤„ç†ã€‚</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Vbq5YEL42g1tQsLjWKAokQ.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç€è‰²å™¨ä¸­æŒ‰é¡ºåºå®ç°è¿™äº›æ­¥éª¤ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©äº†ä¸€ä¸ªåŸºæœ¬çš„æ­£å¼¦æ³¢ä½œä¸ºé›ªè¾¹ç¼˜çš„å‡½æ•°ã€‚æˆ‘æ·»åŠ äº†ä¸€äº›ç³»æ•°æ¥å‹ç¼©å®ƒå¹¶é™ä½å…¶æŒ¯å¹…ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ç™½è‰²å¡«å……æ­¤çº¿ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒæ—¶å¿½ç•¥å…¶ä¸‹æ–¹çš„æ‰€æœ‰å†…å®¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">snow</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">)</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>é€šè¿‡å‘ <code>uv.y</code> æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç›´ç§»åŠ¨æ•´ä¸ªå‡½æ•°ã€‚</p></blockquote>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥æ–¹æ³•ç§»è¿‘å¯¹è¯æ¡†çš„åº•éƒ¨è¾¹ç¼˜å¹¶æ·»åŠ ä¸€ä¸ªé®ç½©ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„çŸ©å½¢åŒºåŸŸä½œä¸ºé®ç½©ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†åˆ«æŒ‡å®šæ¯ä¸ªè¾¹ç¼˜æ¥å®šä¹‰å®ƒã€‚è¿™ç§æ–¹æ³•å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹å†—é•¿ï¼Œä½†å®ƒä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span><span class='line'>         <span class="n">snowEdge</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">leftBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">rightBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">topBound</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="n">snowMask</span> <span class="o">*=</span> <span class="n">snowEdge</span><span class="p">;</span>
</span><span class='line'>         <span class="k">vec4</span> <span class="n">imageColor</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">snowColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">imageColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">snowColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="o">+</span><span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è°ƒæ•´åï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æœã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*GM2d-tsCUOAHnloMiDYAAA.png" alt="" /></p>

<p>ç°åœ¨å¯èƒ½ä¸æ˜¯æåŠè¿™ä¸€ç‚¹çš„æœ€ä½³æ—¶æœºï¼Œä¹Ÿè®¸åº”è¯¥æ—©ç‚¹æåŠï¼Œä½†åœ¨è¿™é‡Œå¼ºè°ƒè¿™ä¸€ç‚¹è‡³å…³é‡è¦ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬å¯¹åæ ‡è¿›è¡Œäº†å½’ä¸€åŒ–ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†å¹³ç§»ï¼Œä½¿é›¶ç‚¹æ°å¥½ä½äºç”»å¸ƒï¼ˆå³å¯¹è¯æ¡†ï¼‰çš„ä¸­å¿ƒã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š<code>_float2 uv = fragCoord/resolution â€” 0.5;_</code></p>

<p>ç†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºç°åœ¨æˆ‘æƒ³å‡å°ä¸­å¿ƒæ­£å¼¦æ³¢çš„æŒ¯å¹…ï¼Œå¹¶éšç€æˆ‘ä»¬å‘å·¦å³ä¸¤ä¾§è¿œç¦»ä¸­å¿ƒè€Œå¢å¤§æŒ¯å¹…ã€‚ç†è§£åæ ‡ç³»çš„è®¾ç½®æ–¹å¼åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å‡½æ•°ä¹˜ä»¥æ²¿ x è½´è·ç¦»ä¸­å¿ƒçš„è·ç¦»æ¥å®ç°è¿™ä¸€ç‚¹ã€‚è¿™æ ·ï¼Œå‡½æ•°å°†åœ¨ä¸­å¿ƒå¤„æ°å¥½è¿”å›é›¶ç‚¹ï¼Œå¹¶éšç€å‘å¤–ç§»åŠ¨è€Œå¢å¤§ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ç°ä»¥ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*oW8OP3R2VFo0SkJmDhgVSw.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯å¸¸é‡æ¥å®šä¹‰é®ç½©çš„é¡¶éƒ¨è¾¹ç•Œã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªæ­£å¼¦æ³¢ï¼Œä½†é—´éš”ç­‰äºå¯¹è¯æ¡†çš„å®½åº¦ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="mf">0.8</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">.2</span><span class="o">+</span><span class="mf">0.3</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å°†ä¸ºå·¦å³è¾¹ç•Œæ·»åŠ ç±»ä¼¼çš„ä»£ç ï¼šæˆ‘å¸Œæœ›å®ƒä»¬ä¹Ÿä½¿ç”¨æ­£å¼¦æ³¢ï¼Œä½†è¿™æ¬¡æ˜¯å‚ç›´è¿è¡Œçš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">+</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.4</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåº•éƒ¨è¾¹ç¼˜æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼šè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å˜é‡ï¼Œæˆ‘ä»¬ä¼šå°†å®ƒä» Compose ä¼ é€’ç»™ç€è‰²å™¨ã€‚åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€æ·»åŠ ç›¸åº”çš„ <code>uniform</code> å˜é‡ï¼Œå¹¶å°†åº•éƒ¨è¾¹ç¼˜å‡½æ•°ä¹˜ä»¥å®ƒå³å¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>        <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">adjustedTime</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">adjustedTime</span><span class="p">;</span>
</span><span class='line'>         <span class="n">snowEdge</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="mf">0.8</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">.2</span><span class="o">+</span><span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">+</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.4</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">leftBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">rightBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">topBound</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">snowMask</span> <span class="o">*=</span> <span class="n">snowEdge</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">vec4</span> <span class="n">imageColor</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">snowColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">imageColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">snowColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="o">+</span><span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åˆ«å¿˜äº†ä»composableä¸­æä¾›æ—¶é—´ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// è¿™é‡Œæä¾›æ—¶é—´ï¼š</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="c1">// å…¶ä½™ä»£ç ä¿æŒä¸å˜</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*5YYiM3lZYp42O8Fa9iS-4A.gif" alt="" /></p>

<p>å…³äºè¿™ä¸ªæ•ˆæœï¼Œæˆ‘æƒ³åˆ†äº«çš„å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼è¿™æ˜¯æ ¸å¿ƒæ€æƒ³ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œä½ å¯ä»¥å°è¯•ä¸åŒçš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ç”¨ä¸€ä¸ªåŸºäº Perlin å™ªå£°çš„æ›´æ··ä¹±çš„ç‰ˆæœ¬æ›¿æ¢äº†åŸºæœ¬çš„æ­£å¼¦æ³¢ã€‚</p>

<p>ä½†è¿™äº›åªæ˜¯ç»†èŠ‚ï¼Œåœ¨å®ç°ä¸Šå¯ä»¥æœ‰æ— é™çš„å˜åŒ–ã€‚åˆ›å»ºç€è‰²å™¨çš„å…³é”®åœ¨äºæŒæ¡å…¶èƒŒåçš„æ ¸å¿ƒæ€æƒ³ã€‚</p>

<p>ä½ å¯ä»¥åœ¨æˆ‘çš„ä»£ç åº“ä¸­æ‰¾åˆ°æˆ‘çš„å®ç°ï¼Œå…¶ä¸­è¿˜åŒ…å«å„ç§ç”¨äºä¸åŒå¢å¼ºåŠŸèƒ½çš„è¾…åŠ©æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ç³»åˆ—è¿‡æ¸¡æ•ˆæœï¼ˆçº¿æ€§ã€ä¸‰æ¬¡ã€æŒ‡æ•°ç­‰ï¼‰ã€‚</p>

<p>æ·»åŠ é›ªèŠ±æ˜¯æœ€åä¸€æ­¥ï¼Œä½†åˆ›å»ºé›ªã€é›¨ã€æ˜Ÿæ˜Ÿç­‰æ•ˆæœçš„æ–¹æ³•å€¼å¾—å¦å¼€ä¸€ä¸ªæ•™ç¨‹ã€‚ä¸‹æ¬¡æˆ‘ä¸€å®šä¼šè®²è§£ã€‚ä»Šå¤©ï¼Œæˆ‘åªæƒ³æä¸€ä¸‹ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç‰¹å®šçš„æ•ˆæœï¼Œæˆ‘ä½¿ç”¨äº† <strong>Andrew Baldwin</strong> äº 2013 å¹´åœ¨ ShaderToy ä¸Šåˆ›å»ºçš„ç€è‰²å™¨ã€‚é“¾æ¥å¦‚ä¸‹ï¼š<a href="https://www.shadertoy.com/view/ldsGDn">https://www.shadertoy.com/view/ldsGDn</a></p>

<p>ç”±äºåŸå§‹ç€è‰²å™¨å¯¹äºæ‰‹æœºæ¥è¯´è¿‡äºåºå¤§ï¼Œæˆ‘åšäº†ä¸€äº›ç®€åŒ–ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜éœ€è¦ä¸€äº›é€‚é… AGSL çš„åŠŸèƒ½ã€‚è¿™æ˜¯æˆ‘çš„ç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">int</span> <span class="n">uLayers</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">uDepth</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">uSpeed</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">const</span> <span class="k">int</span> <span class="n">MAX_LAYERS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</span><span class='line'>   <span class="k">const</span> <span class="k">float</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">vec2</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="k">vec2</span> <span class="n">o</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">o</span> <span class="o">/</span> <span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">uv</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>       <span class="k">vec4</span> <span class="n">image</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>       <span class="k">const</span> <span class="k">mat3</span> <span class="n">p</span> <span class="o">=</span> <span class="k">mat3</span><span class="p">(</span><span class="mf">13.323122</span><span class="p">,</span> <span class="mf">23.5112</span><span class="p">,</span> <span class="mf">21.71123</span><span class="p">,</span> <span class="mf">21.1212</span><span class="p">,</span> <span class="mf">28.7312</span><span class="p">,</span> <span class="mf">11.9312</span><span class="p">,</span> <span class="mf">21.8112</span><span class="p">,</span> <span class="mf">14.7212</span><span class="p">,</span> <span class="mf">61.3934</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>       <span class="k">vec3</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>       <span class="k">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// åˆå§‹åŒ– alpha</span>
</span><span class='line'>       <span class="k">float</span> <span class="n">dof</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>       <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LAYERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">uLayers</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// å¦‚æœ i è¶…å‡º uLayersï¼Œåˆ™è·³å‡ºå¾ªç¯</span>
</span><span class='line'>
</span><span class='line'>           <span class="k">float</span> <span class="n">fi</span> <span class="o">=</span> <span class="k">float</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec2</span> <span class="n">q</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">uDepth</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡è°ƒåˆ¶å’Œæ—¶é—´è°ƒæ•´é›ªèŠ±ä½ç½®</span>
</span><span class='line'>           <span class="n">q</span> <span class="o">-=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">WIDTH</span> <span class="o">*</span> <span class="n">mod</span><span class="p">(</span><span class="n">fi</span> <span class="o">*</span> <span class="mf">7.238917</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">WIDTH</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">uSpeed</span> <span class="o">*</span> <span class="n">time</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">uDepth</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">));</span>                      <span class="k">vec3</span> <span class="n">n</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="mf">31.189</span> <span class="o">+</span> <span class="n">fi</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">m</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.00001</span> <span class="o">+</span> <span class="n">fract</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">31415.9</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">fract</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fract</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// ä½¿ç”¨åœ†å½¢maskçš„åœ†å½¢é›ªèŠ±å½¢çŠ¶</span>
</span><span class='line'>           <span class="n">float2</span> <span class="n">center</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">distanceToCenter</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">center</span><span class="p">);</span> <span class="c1">// åœ†å‘¨è·ç¦»</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">flakeRadius</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">;</span> <span class="c1">// æ¯ä¸ªè–„ç‰‡çš„åŠå¾„ç•¥æœ‰ä¸åŒ</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡æ‰©å±•çš„å¹³æ»‘æ­¥è¿›å®ç°æ›´å¹³æ»‘çš„è¾¹ç¼˜</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">flakeRadius</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">flakeRadius</span><span class="p">,</span> <span class="n">distanceToCenter</span><span class="p">)</span> <span class="o">*</span>
</span><span class='line'>                               <span class="n">smoothstep</span><span class="p">(</span><span class="n">flakeRadius</span><span class="p">,</span> <span class="n">flakeRadius</span> <span class="o">-</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">distanceToCenter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// Ensure flakes are white or transparent (prevent black color)</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">flakeColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span> <span class="c1">// é›ªèŠ±è¦æ˜¯ç™½è‰²</span>
</span><span class='line'>           <span class="n">acc</span> <span class="o">+=</span> <span class="n">flakeColor</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡å¹³æ»‘è¿‡æ¸¡ç§¯ç´¯ alpha</span>
</span><span class='line'>           <span class="n">alpha</span> <span class="o">+=</span> <span class="n">intensity</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// å½’ä¸€åŒ– alpha ä»¥ç¡®ä¿å…¶ä¸è¶…è¿‡ 1.0</span>
</span><span class='line'>       <span class="n">alpha</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>       <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ratio</span> <span class="o">||</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="n">finalColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>           <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>       <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">+</span><span class="n">image</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å½“ç„¶ï¼Œä¸ºäº†è®©ä¸€äº›é›ªèŠ±å‡ºç°åœ¨å±å¹•å‰æ–¹ï¼Œè€Œå¦ä¸€äº›é›ªèŠ±é£˜åˆ°å±å¹•åæ–¹ï¼Œæˆ‘å¿…é¡»åœ¨è¿™ä¸ªç€è‰²å™¨ä¸­ä½¿ç”¨ä¸¤å±‚ã€‚è¿™æ˜¯å¯¹è¯æ¡†å¯ç»„åˆå‡½æ•°çš„æœ€ç»ˆæ•ˆæœï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">flakesShaderForeground</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">flakesShaderBackground</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setIntUniform</span><span class="p">(</span><span class="s">&quot;uLayers&quot;</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uDepth&quot;</span><span class="p">,</span> <span class="m">0.15f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uSpeed&quot;</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setIntUniform</span><span class="p">(</span><span class="s">&quot;uLayers&quot;</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uDepth&quot;</span><span class="p">,</span> <span class="m">1.5f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uSpeed&quot;</span><span class="p">,</span> <span class="m">0.8f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">flakesShaderForeground</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">flakesShaderBackground</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.1f</span><span class="p">))</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Merry Christmas!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">titleLarge</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Happy New Year!&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">26.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">End</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Close&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">bodyMedium</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">primary</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆç»“æœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*UG3e4b_9AqY1J1kKCNFqAw.png" alt="" /></p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚ä½ çš„æ”¯æŒæ„ä¹‰é‡å¤§ï¼Œå¹¶æ¿€åŠ±ç€æˆ‘ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åˆæ¢Composeä¸­çš„ç€è‰²å™¨RuntimeShader]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader/"/>
    <updated>2025-08-15T22:21:24+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒFirst look at RuntimeShaders in Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644">https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´4æœˆ12æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader/"><img src="https://miro.medium.com/v2/resize:fit:1302/1*QXaDvaYryDIZ1GItjM1uqQ.png" title="auto auto" ></a></p>

<!-- more -->


<p>è‡ªä»æˆ‘ä»¬æœ‰æœºä¼šåœ¨ Compose ä¸­ä½¿ç”¨ RuntimeShaders è‡ªå®šä¹‰Shaderï¼ˆç€è‰²å™¨ï¼‰ä»¥æ¥ï¼Œå·²ç»è¿‡å»äº†ä¸€å¹´å¤šçš„æ—¶é—´ã€‚è¯´å®è¯ï¼Œæˆ‘åŸæœ¬ä»¥ä¸ºä¼šæœ‰å¤§é‡å…³äºè¿™ä¸ªä¸»é¢˜çš„æ–‡ç« ã€‚æˆ‘ä»¥ä¸ºç°åœ¨ Android ä¸Šåº”è¯¥å·²ç»å……æ–¥ç€æ— æ•°ä»¤äººæƒŠå¹çš„ç¤ºä¾‹ã€æ„æƒ³ä¸åˆ°çš„æ•ˆæœï¼Œä»¥åŠå¬åˆ°â€œç€è‰²å™¨â€è¿™ä¸ªè¯æ—¶è„‘æµ·ä¸­æµ®ç°çš„å…¶ä»–ä»¤äººç€è¿·çš„ä¸œè¥¿ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚åœ¨ RuntimeShaders å¯ç”¨ä¹‹åï¼Œå‡ ä¹ç«‹åˆ»å°±å‡ºç°äº†å‡ ç¯‡æ–‡ç« ï¼Œä¹‹åå°±å†ä¹Ÿæ²¡æœ‰äº†ã€‚ä¸€ç‰‡å¯‚é™ã€‚</p>

<p>æˆ‘æƒ³ç­”æ¡ˆå¾ˆç®€å•ï¼šAndroid å¼€å‘è€…å¹¶ä¸ç†Ÿæ‚‰ç€è‰²å™¨ï¼Œè€Œç€è‰²å™¨ç¨‹åºå‘˜é€šå¸¸ä¸ä¼šç›´æ¥ä¸º Android ç¼–å†™ä»£ç ï¼›ä»–ä»¬é€šå¸¸ä¼šä½¿ç”¨æŸç§æ¸¸æˆå¼•æ“ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘çš„å‡è®¾æ­£ç¡®ï¼Œæˆ‘å¸Œæœ›ç”¨è¿™ç¯‡æ–‡ç« æ¥å¼¥åˆè¿™ä¸¤ä¸ªä¸–ç•Œä¹‹é—´çš„å·®è·ã€‚æˆ‘çœŸå¿ƒå¸Œæœ›ç€è‰²å™¨ç¼–å†™èƒ½å¤Ÿæ¸—é€åˆ° Android å¼€å‘é¢†åŸŸã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡çš„å‰©ä½™éƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›å¿…è¦çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥ä¾¿ä½ å¯ä»¥åä¸‹æ¥ç¼–å†™ç€è‰²å™¨å¹¶äº«å—å…¶æˆæœã€‚</p>

<p>å› æ­¤ï¼Œæˆ‘å‡è®¾ä½ å·²ç»å¯¹ Compose æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æœ¬æ–‡ä¸ä¼šè¿‡å¤šè®¨è®ºç€è‰²å™¨ã€‚æˆ‘çš„ä¸»è¦é‡ç‚¹æ˜¯è¿æ¥è¿™ä¸¤ä¸ªä¸–ç•Œã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥è®¨è®ºå…·ä½“çš„æŠ€æœ¯ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªé¡¹ç›®ï¼šä¸€ä¸ªå¸¦æœ‰èƒŒæ™¯å›¾åƒï¼Œé¡¶éƒ¨æœ‰ä¸€ä¸ªæ¡†ï¼Œæˆ‘ä»¬æš‚æ—¶å°†å…¶è®¾ç½®ä¸ºé»‘è‰²ã€‚ä»¥ä¸‹æ˜¯ä»£ç çš„ç®€åŒ–ç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">VerySimpleShaderTheme</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">contentScale</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span><span class="p">,</span>
</span><span class='line'>            <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">background_pattern</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>          <span class="p">){</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè¦å°†ç€è‰²å™¨æ·»åŠ åˆ°æ¡†ä¸­ï¼Œä½ éœ€è¦è·å–ç€è‰²å™¨æ–‡æœ¬æœ¬èº«ï¼Œè¯¥æ–‡æœ¬ä»¥å¸¸è§„å­—ç¬¦ä¸²å½¢å¼ä¼ é€’ã€‚ä½¿ç”¨æ­¤æ–‡æœ¬åˆ›å»ºä¸€ä¸ª <code>RuntimeShader</code> å¯¹è±¡ã€‚ç„¶åï¼Œå°†å…¶ä¼ é€’ç»™ <code>graphicsLayer</code> æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="m">0.</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="p">.</span><span class="m">5</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span>
</span><span class='line'>                                    <span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'>                       <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç€è‰²å™¨ç¤ºä¾‹ï¼Œå®ƒè¾“å‡ºé»‘è‰²ï¼Œé€æ˜åº¦ä¸º 50%ã€‚å®ƒçœ‹èµ·æ¥åƒä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼ˆèƒŒæ™¯åªæ˜¯æ¥è‡ªèµ„æºåº“çš„å›¾ç‰‡ï¼‰ã€‚å®ƒå¯èƒ½è¿˜ä¸å¤Ÿä»¤äººå°è±¡æ·±åˆ»ï¼Œä½†æˆ‘æƒ³åœ¨è¿™é‡Œå¼ºè°ƒä¸¤ä¸ªé‡è¦çš„ç»†èŠ‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¦‚ä½•å°†ç€è‰²å™¨åº”ç”¨åˆ°ç›’å­ä¸Šã€‚åœ¨æˆ‘ä»¬çš„ç€è‰²å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç€è‰²å™¨å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åˆ›å»º renderEffect æ—¶ä¼ é€’å®ƒã€‚ç¬¬äºŒä¸ªé‡è¦çš„ç»†èŠ‚æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºç›’å­æ·»åŠ ä¸€ä¸ªèƒŒæ™¯ï¼Œå¹¶ä¸”èƒŒæ™¯ä¸èƒ½å®Œå…¨é€æ˜ï¼›åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬çš„ç€è‰²å™¨æ‰èƒ½åº”ç”¨åˆ°ç›’å­ä¸Šï¼Œå¦åˆ™å®ƒå°†ä¸å¯è§ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*DWbBFHchSRHzeVv_9FuxvQ.png" alt="" /></p>

<p>åœ¨ä½¿ç”¨ç€è‰²å™¨æ—¶ï¼Œé€šå¸¸éœ€è¦å¯¹åæ ‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶ä» 0 å˜ä¸º 1ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä» -0.5 åˆ° 0.5ï¼Œè¿™æ ·åæ ‡ä¸­å¿ƒå°±ä½äºç”»å¸ƒçš„æ­£ä¸­å¤®ã€‚è¿™æœ‰åŠ©äºä½¿ç”¨å„ç§æ•°å­¦å…¬å¼ã€‚ç„¶è€Œï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¸ä»…éœ€è¦çŸ¥é“å½“å‰åƒç´ åæ ‡ï¼Œè¿˜éœ€è¦çŸ¥é“ç”»å¸ƒçš„æ€»å°ºå¯¸ã€‚ä¸ºäº†æ¼”ç¤ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸‹ä¸€ä¸ªé‡ç‚¹ï¼šå°†å‚æ•°ä»ä»£ç ä¼ é€’ç»™ç€è‰²å™¨ã€‚æˆ‘ä»¬å°†ä¼ é€’ç›’å­çš„å°ºå¯¸å¹¶ä¿®æ”¹ç€è‰²å™¨ï¼Œä½¿å…¶ç»˜åˆ¶ä¸€ä¸ªåœ†åœˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">xy</span> <span class="p">-</span> <span class="p">.</span><span class="m">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">),</span><span class="m">0.5</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                            <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                                <span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span>
</span><span class='line'>                                    <span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'>                       <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*nBzr_W24ekFtGgf3xdz8QA.png" alt="" /></p>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•åˆ›å»ºè‡ªå·±çš„ç€è‰²å™¨å¹¶ä¸ºå…¶ä¼ é€’å‚æ•°ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ä½ å¯ä»¥ä¼ é€’ä»»ä½•ä½ éœ€è¦çš„å‚æ•°ï¼Œæ— è®ºæ˜¯æ—¶é—´ã€é¢œè‰²è¿˜æ˜¯ç€è‰²å™¨æ‰€éœ€çš„å…¶ä»–å‚æ•°ã€‚ä¸ºäº†å·©å›ºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸€ä¸ªæˆ‘ä¸º Android åˆ¶ä½œçš„ç¬¬ä¸€ä¸ªç€è‰²å™¨çš„ç¤ºä¾‹â€”â€”ä¸€ä¸ªç”¨äºåŠ è½½çš„å‘å…‰åœ†åœˆã€‚æˆ‘ä»¬å°†ä¼ é€’å½“å‰æ—¶é—´æ¥ä¸ºå…¶æ·»åŠ åŠ¨ç”»æ•ˆæœï¼›ä¸‹é¢æ˜¯ä¸€ä¸ªæ­¤ç±»æ•ˆæœçš„ç®€å•ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float</span> <span class="n">radius</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">xy</span> <span class="p">-</span> <span class="p">.</span><span class="m">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float</span> <span class="n">radiusWithTime</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">+</span><span class="n">sin</span><span class="p">(</span><span class="n">time</span><span class="p">))*</span><span class="m">0.1</span> <span class="p">+</span> <span class="n">radius</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float</span> <span class="n">glowingCircle</span> <span class="p">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">radiusWithTime</span><span class="p">,</span> <span class="n">radiusWithTime</span><span class="p">-</span><span class="n">radiusWithTime</span><span class="p">*</span><span class="m">0.3</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">glowingCircle</span><span class="p">-</span><span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">),</span><span class="n">radius</span><span class="p">*</span><span class="m">0.7</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;radius&quot;</span><span class="p">,</span> <span class="m">0.6f</span><span class="p">)</span>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>        <span class="n">time</span><span class="p">+=</span><span class="m">0.01f</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Lr85zuDhk8o0-TUgw993_A.png" alt="å®ƒå®é™…ä¸Šæœ‰ä¸€ä¸ªå…‰æ™•åŠ¨ç”»" /></p>

<p>æˆ‘å·²ç»æ¼”ç¤ºäº†æœ€åŸºç¡€çš„éƒ¨åˆ†ã€‚æˆ‘çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œå¹¶å±•ç¤ºå®ƒæ˜¯å¤šä¹ˆçš„ç®€å•ã€‚å…³äºç€è‰²å™¨ï¼Œæˆ‘è¿˜æœ‰å¾ˆå¤šæƒ³è®¨è®ºçš„ï¼Œä½†æˆ‘ä»¬ç•™åˆ°ä¸‹æ¬¡å†è¯´ã€‚</p>

<p>æ„Ÿè°¢ä½ çš„å…³æ³¨ï¼Œç¥ä½ ä½¿ç”¨ Androidã€Compose å’ŒShaderï¼ˆç€è‰²å™¨ï¼‰é¡ºåˆ©è¿›å…¥éå‡¡çš„ UI ä¸–ç•Œã€‚æœŸå¾…ä¸ä½ ç›¸è§ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¼šè¯´ä¸ï¼è®©ä½ å½»åº•å­¦ä¼šKotlin Flowçš„å–æ¶ˆæœºåˆ¶]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/08/flow-cancellation/"/>
    <updated>2025-08-08T20:25:21+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/08/flow-cancellation</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCancellable Flows in Kotlin Coroutines: The Complete Guide to Flow Cancellation Techniquesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/cancellable-flows-in-kotlin-coroutines-the-complete-guide-to-flow-cancellation-techniques-8988a85fc158">https://proandroiddev.com/cancellable-flows-in-kotlin-coroutines-the-complete-guide-to-flow-cancellation-techniques-8988a85fc158</a>ï¼Œç”±Sahil Thakarå‘å¸ƒäº2025å¹´7æœˆ21æ—¥ã€‚</p></blockquote>

<p><strong>è¯‘è€…æŒ‰ï¼š</strong> æœ¬æ–‡å¹¶ä¸æ˜¯Flowçš„åŸºç¡€æ•™ç¨‹ï¼Œè€Œæ˜¯ä¸“é—¨è®²è§£å¦‚ä½•å–æ¶ˆflowçš„ï¼Œé€‚åˆå¯¹Flowæœ‰ä¸€å®šåŸºç¡€çš„åŒå­¦ã€‚å¦‚æœå¯¹Flowè¿˜ä¸å¤Ÿç†Ÿæ‚‰ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯»ä¸€ä¸‹ä¹‹å‰çš„æ–‡ç« ï¼š</p>

<ul>
<li><a href="https://juejin.cn/post/7336751931375648820">åŒ…æ•™åŒ…ä¼šçš„Kotlin Flowæ•™ç¨‹</a></li>
<li><a href="https://juejin.cn/post/7337517508151590947">ä¸“å®¶ä¹‹è·¯ä¸Šçš„Flowé«˜çº§ç§˜ç±</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¼šç”¨æœ€ä¼˜é›…çš„å§¿å¼åœ¨Composeä¸­æ˜¾ç¤ºå¯Œæ–‡æœ¬]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose/"/>
    <updated>2025-07-30T22:50:40+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒStyledString: A Better Pattern for Rich Text in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1">https://proandroiddev.com/styledstring-a-better-pattern-for-rich-text-in-jetpack-compose-5930bde981b1</a>ï¼Œç”±Eury PÃ©rez BeltrÃ©å‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/07/30/styledstring-in-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NS_T-i72tS5eOs5F0f_Tnw.png" title="auto auto" ></a></p>

<!-- more -->


<p>åœ¨ Jetpack Compose ä¸­è®¾ç½®æ–‡æœ¬æ ·å¼çœ‹ä¼¼ç®€å•â€¦â€¦ä½†å…¶å®ä¸ç„¶ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ¢è®¨ AnnotatedString çš„å±€é™æ€§ï¼Œä»¥åŠ StyledString å¦‚ä½•è®©å¯Œæ–‡æœ¬æ›´æ˜“äºç®¡ç†ã€‚è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚ğŸ‘‡</p>

<h2>ğŸ“š ç›®å½•</h2>

<ol>
<li>å¼•è¨€ï¼šä¸€ä¸ªç²—ä½“å­—ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</li>
<li>AnnotatedStringï¼šæ ·å¼è¿‡å¤šï¼Œç®€æ´æ€§ä¸è¶³</li>
<li>StyledString ç®€ä»‹ï¼šä¸€ä¸ª API å³å¯è®¾ç½®æ‰€æœ‰æ ·å¼</li>
<li>StyledString åº•å±‚åŸç†ï¼šAPI èƒŒåçš„å¼•æ“</li>
<li>ç»“è¯­</li>
</ol>


<h2>å¼•è¨€ï¼šä¸€ä¸ªåŠ ç²—çš„å•è¯ã€ä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠä¸€å¤§å †éº»çƒ¦</h2>

<p>ä¸€å¼€å§‹ï¼Œä½ æ‹¥æœ‰äº† AnnotatedString å’Œä¸€ä¸ª SpanStyle ï¼Œä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆé¡ºç•…ã€‚ä½ æƒ³åŠ ç²—ä¸€ä¸ªå•è¯ï¼Ÿå¾ˆç®€å•âœ…ã€‚ç»™æŸä¸ªä¸œè¥¿åŠ ä¸‹åˆ’çº¿ï¼Ÿæ²¡é—®é¢˜ã€‚è¿™ç”šè‡³æ„Ÿè§‰æœ‰ç‚¹æœ‰è¶£ï¼Œå°¤å…¶æ˜¯åœ¨ä½ åƒ<a href="https://developer.android.com/develop/ui/compose/text/style-text#multiple-styles">å®˜æ–¹æ–‡æ¡£</a>ä¸­é‚£æ ·æ‰‹åŠ¨æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²çš„æ—¶å€™ã€‚</p>

<p>ä½†é—®é¢˜æ˜¯ï¼šğŸ§ </p>

<p>å½“ä½ å®Œå…¨æ§åˆ¶å­—ç¬¦ä¸²æ—¶ï¼Œè¿™ç§æ–¹æ³•éå¸¸æœ‰æ•ˆã€‚ä½†å½“ä½ å¤„ç†å®é™…å†…å®¹ï¼šåŠ¨æ€å‰¯æœ¬ã€æœ¬åœ°åŒ–æ–‡æœ¬ã€ä»å…¶ä»–åœ°æ–¹ä¼ å…¥çš„æ®µè½ï¼Œè€Œä½ åªéœ€è¦è®¾ç½®å…¶ä¸­ä¸€éƒ¨åˆ†çš„æ ·å¼æ—¶ï¼Ÿ</p>

<p>äº‹æƒ…å¾ˆå¿«å°±å˜å¾—å¾ˆç³Ÿç³•ã€‚</p>

<p>çªç„¶é—´ï¼Œä½ éœ€è¦è·Ÿè¸ªå­å­—ç¬¦ä¸²ã€è®¡ç®—ç´¢å¼•ã€åº”ç”¨æ ·å¼ï¼Œå¹¶è¿æ¥ç‚¹å‡»ç›‘å¬å™¨ã€‚åªéœ€å¯¹æ–‡æœ¬è¿›è¡Œä¸€æ¬¡æ›´æ”¹ï¼Œä½ çš„é€»è¾‘å°±ä¼šåƒçº¸ç‰Œå±‹ä¸€æ ·å´©æºƒã€‚ğŸƒ</p>

<p>ä½ åŸæœ¬æƒ³è¦çš„åªæ˜¯åŠ ç²—ä¸€ä¸ªå•è¯å¹¶è®©é“¾æ¥å¯ç‚¹å‡»ã€‚ç°åœ¨ä½ æ·±é™·äºæ ·æ¿ä»£ç ä¸­ï¼Œç¥ˆç¥·ä¸€åˆ‡éƒ½ä¸ä¼šæ”¹å˜ã€‚</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†è§£é‡Šä¸ºä»€ä¹ˆ AnnotatedString åœ¨å®é™… UI ä¸­æ— æ³•å¾ˆå¥½åœ°æ‰©å±•ï¼Œå¹¶ä»‹ç»ä¸€ä¸ªæˆ‘ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜è€Œæ„å»ºçš„å¾®å‹æŠ½è±¡ã€‚å®ƒå«åš StyledStringï¼Œå®ƒçš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼šğŸ’¡ å®ƒç¡®å®åšåˆ°äº†ï¼š</p>

<p><strong>è®©Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚</strong></p>

<h2>AnnotatedStringï¼šæ ·å¼å¤ªå¤šï¼Œç®€æ´æ€§ä¸è¶³</h2>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç§°èµä¸€ä¸‹ AnnotatedStringã€‚å®ƒæ˜¯ä¸€æ¬¾å¼ºå¤§çš„å·¥å…·ğŸ’ª.</p>

<p>ä½ å¯ä»¥ä½¿ç”¨ä¸€ä¸ª Text å¯ç»„åˆé¡¹æ¥åˆ›å»ºå¸¦æ ·å¼ã€å¯ç‚¹å‡»ã€å¯äº¤äº’çš„æ–‡æœ¬ã€‚æƒ³è¦è®©ä¸€ä¸ªå•è¯åŠ ç²—ï¼Œå¦ä¸€ä¸ªå•è¯åƒé“¾æ¥ä¸€æ ·æ˜¾ç¤ºï¼Ÿå®Œå…¨å¯ä»¥ã€‚è¯¥ API çµæ´»ã€åº•å±‚ï¼Œå¹¶ä¸”ç”± Compose æœ¬èº«çš„å¯Œæ–‡æœ¬å¼•æ“æ”¯æŒã€‚</p>

<p>é—®é¢˜æ˜¯ï¼Œå®ƒåªæœ‰<strong>åœ¨æ‰‹åŠ¨</strong>æ„å»ºæ•´ä¸ªå­—ç¬¦ä¸²æ—¶æ‰èƒ½å‘æŒ¥æœ€ä½³æ•ˆæœã€‚</p>

<p>æ–‡æ¡£ä¸­çš„å¤§å¤šæ•°ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">buildAnnotatedString</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">append</span><span class="p">(</span><span class="s">&quot;Hello &quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">withStyle</span><span class="p">(</span><span class="n">style</span> <span class="p">=</span> <span class="n">SpanStyle</span><span class="p">(</span><span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Bold</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">append</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>çœ‹èµ·æ¥ä¸é”™ï¼Œå¯¹å§ï¼Ÿä½†æ£˜æ‰‹çš„åœ°æ–¹å°±åœ¨è¿™é‡Œã€‚ğŸ‘€</p>

<p>å¦‚æœä½ æœ‰ä¸€æ•´æ®µåŠ¨æ€æ–‡æœ¬ï¼Œæ¯”å¦‚ä¸€æ®µæœ¬åœ°åŒ–çš„å­—ç¬¦ä¸²æˆ–ä¸€ä¸ªä»å…¶ä»–åœ°æ–¹æ‹‰å–çš„å¥å­ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ</p>

<p>ç°åœ¨ä½ éœ€è¦å¤„ç†ï¼š</p>

<ul>
<li>æŸ¥æ‰¾è¦æ·»åŠ æ ·å¼çš„å­å­—ç¬¦ä¸²</li>
<li>è®¡ç®—èµ·å§‹å’Œç»“æŸç´¢å¼•</li>
<li>æ‰‹åŠ¨æ·»åŠ æ ·å¼æˆ–æ³¨é‡Š</li>
<li>å¸Œæœ›æ–‡æœ¬æ°¸è¿œä¸å˜ï¼Œå¦åˆ™ä¸€åˆ‡éƒ½ä¼šå´©æºƒã€‚</li>
</ul>


<p>å¦‚æœä½ éœ€è¦å¤šç§æ ·å¼ï¼Œæ¯”å¦‚ç²—ä½“å•è¯ã€å¯ç‚¹å‡»çš„ç”µå­é‚®ä»¶å’Œå¸¦ä¸‹åˆ’çº¿çš„ URLï¼ŒåŠ¨æ€åœ°ï¼Œäº‹æƒ…å¾ˆå¿«å°±ä¼šå˜å¾—æ··ä¹±ã€‚ğŸ”¥
è¿™æ—¶ï¼ŒbuildAnnotatedString å°±ä¼šå˜æˆä¸€å †è„†å¼±çš„ç´¢å¼•æ•°å­¦è¿ç®—ã€é‡å¤çš„é€»è¾‘å’Œæ ·æ¿ä»£ç ï¼Œéš¾ä»¥é˜…è¯»ï¼Œæ›´éš¾ä»¥ç»´æŠ¤ã€‚</p>

<p>å½“ç„¶ï¼ŒAnnotatedString åŠŸèƒ½å¼ºå¤§ã€‚ä½†å½“ä½ çš„æ–‡æœ¬æ˜¯åŠ¨æ€çš„ï¼Œè€Œä½ åªæƒ³ä¸ºå…¶ä¸­çš„éƒ¨åˆ†å†…å®¹æ·»åŠ æ ·å¼æ—¶ï¼Ÿå®ƒå¾ˆå¿«å°±ä¼šå˜å¾—ç´¢ç„¶æ— å‘³ã€‚</p>

<h2>StyledString éš†é‡å‡ºåœºï¼šä¸€ä¸ª API å³å¯å®ç°æ‰€æœ‰æ ·å¼</h2>

<p>åœ¨ä¸ AnnotatedString çº ç»“äº†æ— æ•°æ¬¡ä¹‹åï¼Œæˆ‘å†³å®šæ„å»ºä¸€ä¸ªæ›´å¥½çš„ä¸œè¥¿ã€‚å®ƒå¹¶éä¸€ä¸ªåºå¤§çš„åº“ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ ·å¼æ¡†æ¶ã€‚è€Œæ˜¯ä¸€ä¸ªç®€å•ã€å…¼å®¹ Compose çš„æŠ½è±¡ï¼Œç”¨äºè§£å†³ä¸€ä¸ªéå¸¸å…·ä½“çš„é—®é¢˜ã€‚</p>

<p><strong>StyledString æ¥å•¦ï¼ğŸ‘‹</strong></p>

<p>å®ƒçš„ç›®æ ‡å¾ˆç®€å•ï¼šè®©ä½ å®šä¹‰å­—ç¬¦ä¸²çš„å“ªäº›éƒ¨åˆ†åº”è¯¥è¢«è®¾ç½®æ ·å¼æˆ–å¯ç‚¹å‡»ï¼Œè€Œæ— éœ€æ‹…å¿ƒ indexOf ã€ addStyle æˆ– AnnotatedString.Builder ã€‚ä½ åªéœ€ç¼–å†™æ–‡æœ¬ï¼Œå‘Šè¯‰å®ƒéœ€è¦è®¾ç½®å“ªäº›å•è¯çš„æ ·å¼ï¼Œä»¥åŠç‚¹å‡»åè¯¥æ‰§è¡Œçš„æ“ä½œã€‚</p>

<p>å®ƒçš„å®é™…æ•ˆæœå¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// This list can be built in the ViewModel</span>
</span><span class='line'><span class="k">val</span> <span class="py">styledStrings</span> <span class="p">=</span> <span class="n">persistentListOf</span><span class="p">(</span>
</span><span class='line'>    <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableEmail</span><span class="p">(</span>
</span><span class='line'>        <span class="n">highlightedText</span> <span class="p">=</span> <span class="s">&quot;support@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;support@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">style</span> <span class="p">=</span> <span class="n">SpanStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span>
</span><span class='line'>            <span class="n">textDecoration</span> <span class="p">=</span> <span class="n">TextDecoration</span><span class="p">.</span><span class="n">Underline</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>    <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableUrl</span><span class="p">(</span>
</span><span class='line'>        <span class="n">highlightedText</span> <span class="p">=</span> <span class="s">&quot;website&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">url</span> <span class="p">=</span> <span class="s">&quot;https://euryperez.dev&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">style</span> <span class="p">=</span> <span class="n">SpanStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span>
</span><span class='line'>            <span class="n">textDecoration</span> <span class="p">=</span> <span class="n">TextDecoration</span><span class="p">.</span><span class="n">Underline</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// In your Compose Screen</span>
</span><span class='line'><span class="n">StyledText</span><span class="p">(</span>
</span><span class='line'>    <span class="n">fullText</span> <span class="p">=</span> <span class="s">&quot;Contact us at support@example.com or visit our website&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">styledStrings</span> <span class="p">=</span> <span class="n">styledStrings</span><span class="p">,</span>
</span><span class='line'>    <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">label</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">styled</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">styled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ClickableEmail</span> <span class="p">-&gt;</span> <span class="n">openEmailClient</span><span class="p">(</span><span class="n">styled</span><span class="p">.</span><span class="n">email</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ClickableUrl</span> <span class="p">-&gt;</span> <span class="n">openUrl</span><span class="p">(</span><span class="n">styled</span><span class="p">.</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>å°±æ˜¯è¿™æ ·ã€‚æ— éœ€æ‰‹åŠ¨æ„å»ºæ–‡æœ¬ï¼Œæ— éœ€ç´¢å¼•è®¡ç®—ï¼Œæ— éœ€æ ·æ¿ä»£ç ã€‚åªéœ€ç®€æ´ã€æ˜“è¯»ã€å£°æ˜å¼çš„æ ·å¼ï¼Œå³å¯ä¸çœŸå®æ–‡æœ¬å…¼å®¹ã€‚</p>

<p>ç”±äº StyledString æ”¯æŒ Simple ã€ ClickableEmail å’Œ ClickableUrl ç­‰ç±»å‹ï¼Œå› æ­¤å®ƒæ˜“äºåœ¨ä½ çš„åº”ç”¨ä¸­æ‰©å±•å’Œå¤ç”¨ã€‚ä½ å¯ä»¥è·å¾—å¯ç‚¹å‡»çš„ã€å¸¦æ ·å¼çš„æ–‡æœ¬ï¼Œè€Œæ— éœ€ç‰ºç‰²å…¶åˆç†æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ğŸ™</p>

<h2>StyledString çš„åº•å±‚ï¼šAPI èƒŒåçš„å¼•æ“</h2>

<p>è®©æˆ‘ä»¬æ­å¼€å®ƒçš„é¢çº±ï¼Œé€æ­¥äº†è§£ StyledString çš„å·¥ä½œåŸç†ã€‚ğŸª„</p>

<p>å½“ä½ åœ¨ UI ä¸­ä½¿ç”¨ StyledText æ—¶ï¼ŒğŸ§ å®ƒå¯èƒ½æ„Ÿè§‰åƒé­”æ³•ä¸€æ ·ç¥å¥‡ï¼Œä½†åœ¨å¹•åï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€æ´ã€æ˜“äºç»„åˆçš„æ¶æ„ï¼Œæ—¨åœ¨å‡å°‘æ ·å¼è®¾è®¡çš„ç—›è‹¦ï¼Œè€Œä¸ä¼šå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§ã€‚</p>

<p>æœ¬èŠ‚æ¶µç›–äº† StyledString ç³»ç»Ÿçš„æ¯ä¸ªéƒ¨åˆ†ï¼Œä»æ ·å¼çš„æè¿°æ–¹å¼ï¼Œåˆ°æ ·å¼çš„æŸ¥æ‰¾ã€åº”ç”¨å’Œåœ¨å±å¹•ä¸Šæ¸²æŸ“ã€‚</p>

<h3>ğŸ§± 1. æ•°æ®æ¨¡å‹ï¼šStyledString å’Œ ClickableStyleString</h3>

<p>æ•´ä¸ªå®ç”¨ç¨‹åºçš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªåä¸º StyledString çš„å¯†å°æ¥å£ã€‚æˆ‘ä»¬é€šè¿‡å®ƒæ¥å¯¹éœ€è¦ä»¥æŸç§æ–¹å¼è®¾ç½®æ ·å¼çš„æ–‡æœ¬ç‰‡æ®µè¿›è¡Œå»ºæ¨¡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">StyledString</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">highlightedText</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">style</span><span class="p">:</span> <span class="n">SpanStyle</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Add `Simple` type</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Add `ClickableEmail` type</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Add `ClickableUrl` type</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ª StyledString éƒ½éœ€è¦ä¸¤æ¡ä¿¡æ¯ï¼š</p>

<ul>
<li>highlightedTextï¼šéœ€è¦è®¾ç½®æ ·å¼çš„æ–‡æœ¬çš„ç¡®åˆ‡éƒ¨åˆ†</li>
<li>styleï¼šå®šä¹‰å…¶å¤–è§‚çš„ SpanStyleï¼ˆé¢œè‰²ã€ä¸‹åˆ’çº¿ã€å­—ä½“ç²—ç»†ç­‰ï¼‰ã€‚</li>
</ul>


<p>ç„¶åï¼Œæˆ‘ä»¬å®šä¹‰ä¸€äº›å®ç°æ­¤æ¥å£çš„ç‰¹å®šç±»å‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Simple</span><span class="p">(</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">highlightedText</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">style</span><span class="p">:</span> <span class="n">SpanStyle</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">StyledString</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ˜¯çº¯è§†è§‰æ•ˆæœçš„ï¼Œå®ƒä¼šæ”¹å˜æ–‡æœ¬çš„å¤–è§‚ï¼Œä½†ä¸å“åº”ç‚¹å‡»ã€‚</p>

<p>ç„¶åæˆ‘ä»¬ä»‹ç»äº¤äº’ç±»å‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">ClickableEmail</span><span class="p">(</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">highlightedText</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">email</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">style</span><span class="p">:</span> <span class="n">SpanStyle</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">StyledString</span><span class="p">,</span> <span class="n">ClickableStyleString</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">ClickableUrl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">highlightedText</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">url</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">style</span><span class="p">:</span> <span class="n">SpanStyle</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">StyledString</span><span class="p">,</span> <span class="n">ClickableStyleString</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®ƒä»¬æ‰§è¡Œç›¸åŒçš„æ ·å¼è®¾ç½®å·¥ä½œï¼Œä½†è¿˜æºå¸¦é¢å¤–çš„æ•°æ®ï¼ˆä¾‹å¦‚ç‚¹å‡»æ—¶åº”æ‰“å¼€çš„ URL æˆ–ç”µå­é‚®ä»¶ï¼‰ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä»¬å®ç°äº†ç¬¬äºŒä¸ªæ¥å£ï¼šClickableStyleStringã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">ClickableStyleString</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå°æ¥å£æ„ä¹‰é‡å¤§ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤ŸåŒºåˆ†çº¯è§†è§‰æ ·å¼å’Œåº”è¯¥å“åº”ç‚¹å‡»çš„æ ·å¼ã€‚è¿™ä½¿å¾—æˆ‘ä»¬çš„ç‚¹å‡»å¤„ç†é€»è¾‘ç®€æ´ä¸”ç±»å‹å®‰å…¨ã€‚ğŸ’¡</p>

<p>ä½ å¯ä»¥è½»æ¾æ·»åŠ æ›´å¤šå˜ä½“ï¼Œä¾‹å¦‚ @mentionsã€#hashtags æˆ–ç”µè¯å·ç ï¼Œåªéœ€åˆ›å»ºå¦ä¸€ä¸ªæ•°æ®ç±»å¹¶é€‰æ‹©æ€§åœ°å®ç°ClickableStyleString å³å¯ã€‚</p>

<h3>ğŸ¯ 2. æ ·å¼å’Œé“¾æ¥ï¼šapplyStyle</h3>

<p>ä¸€æ—¦æˆ‘ä»¬çŸ¥é“äº†å“ªäº›æ–‡æœ¬éœ€è¦æ ·å¼ï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸€ç§å°†è¿™äº›æ ·å¼åº”ç”¨äºå®é™…çš„ AnnotatedString çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯ applyStyle() çš„ä½œç”¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„æ‰©å±•å‡½æ•°ï¼Œå®ƒæ ¹æ® StyledString çš„ç±»å‹åº”ç”¨æ ·å¼ï¼ˆå’Œç‚¹å‡»ç›‘å¬å™¨ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">AnnotatedString</span><span class="p">.</span><span class="n">Builder</span><span class="p">.</span><span class="n">applyStyle</span><span class="p">(</span>
</span><span class='line'>    <span class="n">styledString</span><span class="p">:</span> <span class="n">StyledString</span><span class="p">,</span>
</span><span class='line'>    <span class="n">startIndex</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>    <span class="n">endIndex</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span><span class="p">:</span> <span class="p">(</span><span class="n">ClickableStyleString</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">when</span> <span class="p">(</span><span class="n">styledString</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableUrl</span> <span class="p">-&gt;</span> <span class="n">TODO</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableEmail</span> <span class="p">-&gt;</span> <span class="n">TODO</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">Simple</span> <span class="p">-&gt;</span> <span class="n">TODO</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯æ¬¡åŒ¹é…æ¯ä¸ª StyledString æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨ä¸€æ¬¡æ­¤å‡½æ•°ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®ƒåšäº†ä»€ä¹ˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableUrl</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">linkAnnotation</span> <span class="p">=</span> <span class="n">LinkAnnotation</span><span class="p">.</span><span class="n">Url</span><span class="p">(</span>
</span><span class='line'>        <span class="n">url</span> <span class="p">=</span> <span class="n">styledString</span><span class="p">.</span><span class="n">url</span><span class="p">,</span>
</span><span class='line'>        <span class="n">styles</span> <span class="p">=</span> <span class="n">TextLinkStyles</span><span class="p">(</span><span class="n">style</span> <span class="p">=</span> <span class="n">styledString</span><span class="p">.</span><span class="n">style</span><span class="p">),</span>
</span><span class='line'>        <span class="n">linkInteractionListener</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onClick</span><span class="p">(</span><span class="n">styledString</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">addLink</span><span class="p">(</span><span class="n">linkAnnotation</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæ˜¯ URLï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ª LinkAnnotation.Url å¯¹è±¡ï¼Œé™„åŠ æ ·å¼ï¼Œå¹¶ä¸ºå…¶æ·»åŠ ä¸€ä¸ªç‚¹å‡»ç›‘å¬å™¨ã€‚addLink è´Ÿè´£å°†å…¶é™„åŠ åˆ°æ­£ç¡®çš„æ–‡æœ¬èŒƒå›´ã€‚</p>

<p>æˆ‘ä»¬æ‰§è¡Œçš„æ“ä½œç±»ä¼¼ï¼Œä½†é’ˆå¯¹ç”µå­é‚®ä»¶ä½¿ç”¨çš„æ˜¯ LinkAnnotation.Clickable ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableEmail</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">linkAnnotation</span> <span class="p">=</span> <span class="n">LinkAnnotation</span><span class="p">.</span><span class="n">Clickable</span><span class="p">(</span>
</span><span class='line'>        <span class="n">tag</span> <span class="p">=</span> <span class="n">styledString</span><span class="p">.</span><span class="n">highlightedText</span><span class="p">,</span>
</span><span class='line'>        <span class="n">styles</span> <span class="p">=</span> <span class="n">TextLinkStyles</span><span class="p">(</span><span class="n">style</span> <span class="p">=</span> <span class="n">styledString</span><span class="p">.</span><span class="n">style</span><span class="p">),</span>
</span><span class='line'>        <span class="n">linkInteractionListener</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onClick</span><span class="p">(</span><span class="n">styledString</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">addLink</span><span class="p">(</span><span class="n">linkAnnotation</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæ ·å¼åªæ˜¯è§†è§‰ä¸Šçš„ï¼ˆä¸å¯ç‚¹å‡»ï¼‰ï¼Œæˆ‘ä»¬ä¼šåº”ç”¨å¸¸è§„è·¨åº¦ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">Simple</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">addStyle</span><span class="p">(</span>
</span><span class='line'>        <span class="n">style</span> <span class="p">=</span> <span class="n">styledString</span><span class="p">.</span><span class="n">style</span><span class="p">,</span>
</span><span class='line'>        <span class="n">start</span> <span class="p">=</span> <span class="n">startIndex</span><span class="p">,</span>
</span><span class='line'>        <span class="n">end</span> <span class="p">=</span> <span class="n">endIndex</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§åˆ†ç¦»å°†æ‰€æœ‰æ ·å¼åº”ç”¨é€»è¾‘é›†ä¸­åœ¨ä¸€å¤„ã€‚å¦‚æœä½ æƒ³è¦æ”¯æŒæ–°çš„é“¾æ¥ç±»å‹æˆ–è¡Œä¸ºï¼Œåªéœ€æ›´æ–°æ­¤å‡½æ•°å³å¯ã€‚</p>

<h3>ğŸ” 3. åŒ¹é…æ–‡æœ¬ï¼šfindAllOccurrences</h3>

<p>åœ¨åº”ç”¨æ ·å¼ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ–‡æœ¬ä¸­æ‰€æœ‰å‡ºç°æŒ‡å®šhighlightedText çš„ä½ç½®ã€‚è¿™å°±æ˜¯æ­¤å‡½æ•°çš„ç”¨é€”ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Find all occurrences of a substring in a string, optionally ignoring case.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @param substring The substring to search for.</span>
</span><span class='line'><span class="cm"> * @param ignoreCase Whether to perform a case-insensitive search.</span>
</span><span class='line'><span class="cm"> * @return A list of indices where the substring was found.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">String</span><span class="p">.</span><span class="n">findAllOccurrences</span><span class="p">(</span>
</span><span class='line'>    <span class="n">substring</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ignoreCase</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">):</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°†è·å–å…¨æ–‡ï¼Œå¹¶è¿”å›ç»™å®šå­å­—ç¬¦ä¸²çš„æ¯ä¸ªåŒ¹é…é¡¹çš„èµ·å§‹ç´¢å¼•åˆ—è¡¨ã€‚</p>

<p>å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">substring</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="k">return</span> <span class="n">emptyList</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¯¹äºç©ºå­å­—ç¬¦ä¸²ï¼Œå¿«é€Ÿæå‰é€€å‡ºã€‚é¿å…å¥‡æ€ªçš„è¾¹ç¼˜æƒ…å†µã€‚ç„¶åï¼Œæˆ‘ä»¬å‡†å¤‡è¿›è¡Œä¸åŒºåˆ†å¤§å°å†™çš„æœç´¢ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">indices</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
</span><span class='line'><span class="k">val</span> <span class="py">searchString</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">ignoreCase</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="n">lowercase</span><span class="p">()</span> <span class="k">else</span> <span class="k">this</span>
</span><span class='line'><span class="k">val</span> <span class="py">searchSubstring</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">ignoreCase</span><span class="p">)</span> <span class="n">substring</span><span class="p">.</span><span class="n">lowercase</span><span class="p">()</span> <span class="k">else</span> <span class="n">substring</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬éå†å­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æ‰€æœ‰åŒ¹é…é¡¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">var</span> <span class="py">startIndex</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'><span class="k">val</span> <span class="py">maxStartIndex</span> <span class="p">=</span> <span class="n">length</span> <span class="p">-</span> <span class="n">substring</span><span class="p">.</span><span class="n">length</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">startIndex</span> <span class="p">&lt;=</span> <span class="n">maxStartIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">index</span> <span class="p">=</span> <span class="n">searchString</span><span class="p">.</span><span class="n">indexOf</span><span class="p">(</span><span class="n">searchSubstring</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">==</span> <span class="p">-</span><span class="m">1</span><span class="p">)</span> <span class="k">break</span>
</span><span class='line'>    <span class="n">indices</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>    <span class="n">startIndex</span> <span class="p">=</span> <span class="n">index</span> <span class="p">+</span> <span class="m">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬æœ€ç»ˆè¿”å›ç»“æœï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">return</span> <span class="n">indices</span><span class="p">.</span><span class="n">toList</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä½¿å¾—æˆ‘ä»¬çš„æ ·å¼é€»è¾‘ä¿æŒçµæ´»æ€§å’Œå¼¹æ€§ï¼Œæ— è®ºæˆ‘ä»¬è®¾è®¡çš„å•è¯å‡ºç°ä¸€æ¬¡è¿˜æ˜¯åå‡ æ¬¡ã€‚</p>

<h3>ğŸ§  4. æ„å»º AnnotatedStringï¼šrememberStyledAnnotationString</h3>

<p>ä»¥ä¸‹å‡½æ•°å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ã€‚å®ƒæ¥æ”¶å®Œæ•´æ–‡æœ¬å’Œä½ çš„StyledString åˆ—è¡¨ï¼Œå¹¶è¿”å›ä¸€ä¸ªåº”ç”¨äº†æ‰€æœ‰æ ·å¼çš„ AnnotatedStringã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">rememberStyledAnnotationString</span><span class="p">(</span>
</span><span class='line'>    <span class="n">fullText</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="n">styledStrings</span><span class="p">:</span> <span class="n">ImmutableList</span><span class="p">&lt;</span><span class="n">StyledString</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">ignoreCase</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span><span class="p">:</span> <span class="p">(</span><span class="n">ClickableStyleString</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">):</span> <span class="n">AnnotatedString</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬ç¡®ä¿ä½¿ç”¨ rememberUpdatedState() æ¥ä¿æŒç‚¹å‡»ç›‘å¬å™¨çš„æœ€æ–°çŠ¶æ€ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">currentOnClick</span> <span class="k">by</span> <span class="n">rememberUpdatedState</span><span class="p">(</span><span class="n">onClick</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨è®°ä½æ¥ç¼“å­˜å·¥ä½œï¼Œé™¤éè¾“å…¥å‘ç”Ÿå˜åŒ–ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">return</span> <span class="n">remember</span><span class="p">(</span><span class="n">fullText</span><span class="p">,</span> <span class="n">styledStrings</span><span class="p">,</span> <span class="n">ignoreCase</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// TODO: build annotated string</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬é¦–å…ˆé™„åŠ å®Œæ•´çš„æœªæ ·å¼åŒ–çš„æ–‡æœ¬ã€‚ç„¶åï¼Œå¯¹äºæ¯ä¸ª StyledString ï¼Œæˆ‘ä»¬æ‰¾åˆ°æ‰€æœ‰åŒ¹é…çš„ä½ç½®å¹¶åº”ç”¨æ ·å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">buildAnnotatedString</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">append</span><span class="p">(</span><span class="n">fullText</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">styledStrings</span><span class="p">.</span><span class="n">fastForEach</span> <span class="p">{</span> <span class="n">styledStringInfo</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">indices</span> <span class="p">=</span>
</span><span class='line'>            <span class="n">fullText</span><span class="p">.</span><span class="n">findAllOccurrences</span><span class="p">(</span><span class="n">styledStringInfo</span><span class="p">.</span><span class="n">highlightedText</span><span class="p">,</span> <span class="n">ignoreCase</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">indices</span><span class="p">.</span><span class="n">fastForEach</span> <span class="p">{</span> <span class="n">startIndex</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">endIndex</span> <span class="p">=</span> <span class="n">startIndex</span> <span class="p">+</span> <span class="n">styledStringInfo</span><span class="p">.</span><span class="n">highlightedText</span><span class="p">.</span><span class="n">length</span>
</span><span class='line'>            <span class="n">applyStyle</span><span class="p">(</span><span class="n">styledStringInfo</span><span class="p">,</span> <span class="n">startIndex</span><span class="p">,</span> <span class="n">endIndex</span><span class="p">,</span> <span class="n">currentOnClick</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªå¾ªç¯ä½¿å¾—æ ·å¼è®¾ç½®èƒ½å¤ŸåŠ¨æ€ä¸”å¤šç›®æ ‡åŒ–ã€‚ä½ å¯ä»¥å°†ä»»ä½•æœ¬åœ°åŒ–æˆ–è¿è¡Œæ—¶ç”Ÿæˆçš„å­—ç¬¦ä¸²ä½œä¸º fullText ä¼ é€’ï¼Œå®ƒä»ç„¶èƒ½å¤Ÿæ­£ç¡®åº”ç”¨æ ·å¼ã€‚</p>

<h3>ğŸ§© 5. å¯ç»„åˆé¡¹ï¼šStyledText</h3>

<p>æœ€åï¼ŒStyledText å¯ç»„åˆé¡¹å°†æ‰€æœ‰å†…å®¹è¿æ¥åœ¨ä¸€èµ·ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">StyledText</span><span class="p">(</span>
</span><span class='line'>    <span class="n">fullText</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="n">styledStrings</span><span class="p">:</span> <span class="n">ImmutableList</span><span class="p">&lt;</span><span class="n">StyledString</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">style</span><span class="p">:</span> <span class="n">TextStyle</span><span class="p">,</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span><span class="p">:</span> <span class="p">(</span><span class="n">ClickableStyleString</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{},</span>
</span><span class='line'>    <span class="n">ignoreCase</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// TODO: Implementation</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ ä¼ å…¥å…¨æ–‡ã€æ ·å¼ä»¥åŠå¯é€‰çš„ç‚¹å‡»å¤„ç†ç¨‹åºã€‚å®ƒçš„å†…éƒ¨åŠŸèƒ½å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">annotatedString</span> <span class="p">=</span> <span class="n">rememberStyledAnnotationString</span><span class="p">(</span>
</span><span class='line'>    <span class="n">fullText</span> <span class="p">=</span> <span class="n">fullText</span><span class="p">,</span>
</span><span class='line'>    <span class="n">styledStrings</span> <span class="p">=</span> <span class="n">styledStrings</span><span class="p">,</span>
</span><span class='line'>    <span class="n">ignoreCase</span> <span class="p">=</span> <span class="n">ignoreCase</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onClick</span> <span class="p">=</span> <span class="n">onClick</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™è°ƒç”¨äº†æˆ‘ä»¬åˆšåˆšè®²è¿‡çš„é€»è¾‘ã€‚å®ƒè¿”å›ä¸€ä¸ªå¸¦æ ·å¼çš„ AnnotatedString ã€‚ç„¶åæˆ‘ä»¬æ¸²æŸ“å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">Text</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">text</span> <span class="p">=</span> <span class="n">annotatedString</span><span class="p">,</span>
</span><span class='line'>    <span class="n">style</span> <span class="p">=</span> <span class="n">style</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®ƒåªæ˜¯ä¸€ä¸ªæ™®é€šçš„ Compose Text ã€‚ä½†æ‰€æœ‰æ ·å¼é€»è¾‘éƒ½å·²é¢„å…ˆçƒ˜ç„™ã€‚ç°åœ¨ï¼Œä½ çš„ UI ä»£ç ä¿æŒç®€æ´ä¸”å£°æ˜å¼ã€‚ğŸŒš</p>

<h3>âš¡ï¸ 6. StyledText å®è·µ</h3>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ StyledText çš„å®è·µï¼Œä¸ºæ­¤ï¼Œæˆ‘æ•´ç†äº†ä¸€ä¸ªé¢„è§ˆï¼Œä½ å¯ä»¥è‡ªå·±æµ‹è¯•ä¸€ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@PreviewLightDark</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">StyledTextPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">MyTheme</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colors</span><span class="p">.</span><span class="n">background</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// This list can be built in the ViewModel</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">styledStrings</span> <span class="p">=</span> <span class="n">persistentListOf</span><span class="p">(</span>
</span><span class='line'>                <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableEmail</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">highlightedText</span> <span class="p">=</span> <span class="s">&quot;support@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;support@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">style</span> <span class="p">=</span> <span class="n">SpanStyle</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Gray</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">textDecoration</span> <span class="p">=</span> <span class="n">TextDecoration</span><span class="p">.</span><span class="n">Underline</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">),</span>
</span><span class='line'>                <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableUrl</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">highlightedText</span> <span class="p">=</span> <span class="s">&quot;website&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">url</span> <span class="p">=</span> <span class="s">&quot;https://euryperez.dev&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">style</span> <span class="p">=</span> <span class="n">SpanStyle</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Gray</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">textDecoration</span> <span class="p">=</span> <span class="n">TextDecoration</span><span class="p">.</span><span class="n">Underline</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// In your Compose Screen</span>
</span><span class='line'>            <span class="n">StyledText</span><span class="p">(</span>
</span><span class='line'>                <span class="n">fullText</span> <span class="p">=</span> <span class="s">&quot;Contact us at support@example.com or visit our website&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">styledStrings</span> <span class="p">=</span> <span class="n">styledStrings</span><span class="p">,</span>
</span><span class='line'>                <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">body2</span><span class="p">,</span>
</span><span class='line'>                <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colors</span><span class="p">.</span><span class="n">onBackground</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">styled</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="k">when</span> <span class="p">(</span><span class="n">styled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableEmail</span> <span class="p">-&gt;</span> <span class="n">TODO</span><span class="p">()</span>
</span><span class='line'>                        <span class="k">is</span> <span class="n">StyledString</span><span class="p">.</span><span class="n">ClickableUrl</span> <span class="p">-&gt;</span> <span class="n">TODO</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ å°†åœ¨é¢„è§ˆä¸­çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š
<img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Tc22BNoUfij54fBGQ7YCg.png" alt="StyledTextPreview" /></p>

<h3>âœ… æ€»ç»“ï¼šä¸€ä¸ªè¾“å‡ºç®€æ´çš„ç®€å•å¼•æ“</h3>

<p>æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªå®Œå…¨å¯å¤ç”¨çš„ Compose å®ç”¨ç¨‹åºï¼Œå®ƒï¼š</p>

<ul>
<li>ä½¿ç”¨ StyledString ä»¥å£°æ˜å¼æ–¹å¼æè¿°æ ·å¼</li>
<li>å®‰å…¨åœ°åŒºåˆ†å¯è§†æ ·å¼å’Œå¯ç‚¹å‡»æ ·å¼</li>
<li>ä½¿ç”¨ applyStyle åº”ç”¨ span å’Œ link</li>
<li>ä½¿ç”¨ findAllOccurrences æŸ¥æ‰¾å¤šä¸ªåŒ¹é…é¡¹</li>
<li>ä»¥ Compose ç¨³å®šçš„æ–¹å¼ç»„è£…æ‰€æœ‰å†…å®¹</li>
<li>å°è£…åœ¨ä¸€ä¸ªç®€æ´çš„ API ä¸­ï¼šStyledText</li>
</ul>


<p>æ— éœ€ indexOf ï¼Œæ— éœ€å¤æ‚çš„èŒƒå›´é€»è¾‘ï¼Œä¹Ÿæ— éœ€å¤åˆ¶ç²˜è´´ buildAnnotatedStringæ ·æ¿ä»£ç ã€‚</p>

<p><a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a">ç‚¹å‡»æ­¤å¤„</a>ï¼ˆé“¾æ¥ï¼š<a href="https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82">https://gist.github.com/euri16/614a460fe6a690ce57cd23cc41164b5a%EF%BC%89%E8%8E%B7%E5%8F%96%E5%AE%8C%E6%95%B4%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82</a></p>

<h2>ç»“è¯­ğŸ¯</h2>

<p>Jetpack Compose èµ‹äºˆæˆ‘ä»¬å¼ºå¤§çš„åŠŸèƒ½ï¼Œä½†å¹¶éæ€»æ˜¯æœ€ç¬¦åˆäººä½“å·¥ç¨‹å­¦çš„å¼€ç®±å³ç”¨å·¥å…·ã€‚AnnotatedString å¯¹äºä¸€æ¬¡æ€§éœ€æ±‚æ¥è¯´éå¸¸æ£’ï¼Œä½†ä¸€æ—¦ä½ çš„ UI éœ€è¦å¤šç§æ ·å¼ã€å¤ç”¨æ¨¡å¼æˆ–åŠ¨æ€ç‚¹å‡»å¤„ç†ï¼Œå®ƒå°±ä¼šå¾ˆå¿«å˜å¾—å†—é•¿ã€‚</p>

<p>è¿™å°±æ˜¯ StyledString çš„ç”¨æ­¦ä¹‹åœ°ã€‚</p>

<p>å®ƒå¹¶éå–ä»£ AnnotatedStringï¼Œè€Œæ˜¯å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼Œä¸ºä½ æä¾›ä¸€ç§æ›´å®‰å…¨ã€æ›´æ¸…æ™°çš„æ–¹å¼æ¥æè¿°æ„å›¾ï¼š</p>

<ul>
<li>â†’ â€œå°†æ­¤å•è¯åŠ ç²—â€</li>
<li>â†’ â€œå°†æ­¤çŸ­è¯­è®¾ä¸ºé“¾æ¥â€</li>
<li>â†’ â€œä¸ºè¯¥å­—ç¬¦ä¸²çš„æ¯ä¸ªå®ä¾‹è®¾ç½®æ ·å¼â€</li>
</ul>


<p>ä½ æ— éœ€å†è€ƒè™‘æ–‡æœ¬åç§»é‡å’Œè·¨åº¦èŒƒå›´ï¼Œè€Œæ˜¯å¼€å§‹æ€è€ƒå«ä¹‰ã€‚ç»“æœï¼šä»£ç æ›´ç®€æ´ã€æ ·æ¿æ›´å°‘ï¼Œå¼€å‘è€…ä½“éªŒæ›´ä½³ğŸ’†</p>

<h3>ğŸ§© æ˜“äºé‡‡ç”¨</h3>

<p>ä½ æ— éœ€é‡æ„æ•´ä¸ªåº”ç”¨å³å¯ä½¿ç”¨ StyledString ã€‚</p>

<p>åªéœ€å°†ä¸€ä¸¤ä¸ª Text() å…ƒç´ æ›¿æ¢ä¸º StyledText() å³å¯ã€‚å°†å†…è”çš„ buildAnnotatedString { &hellip; } å—æ›¿æ¢ä¸º StyledString.Simple æˆ– ClickableUrl çš„ç®€å•åˆ—è¡¨å³å¯ã€‚</p>

<p>å°±è¿™æ ·ï¼Œä½ å°±æˆåŠŸäº†ã€‚âœ¨</p>

<h3>ğŸ› ï¸ æ˜“äºæ‰©å±•</h3>

<p>è¿˜æœ‰å…¶ä»–ç”¨ä¾‹å—ï¼Ÿ</p>

<ul>
<li>ä¸º #hashtags è®¾ç½®æ ·å¼ï¼Ÿ</li>
<li>å¤„ç† @mentionsï¼Ÿ</li>
<li>è‡ªåŠ¨æ£€æµ‹ç”µè¯å·ç ï¼Ÿ</li>
<li>æ·»åŠ å›¾æ ‡æˆ–èƒŒæ™¯é«˜äº®ï¼Ÿ</li>
</ul>


<p>åªéœ€åˆ›å»ºä¸€ä¸ªå®ç° StyledString çš„æ–°æ•°æ®ç±»ï¼Œå¹¶åœ¨ applyStyle() ä¸­å¤„ç†å®ƒå³å¯ã€‚ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ã€‚</p>

<p>è¿™ç§åˆ†ç¦»ä½¿ä½ çš„æ–‡æœ¬é€»è¾‘æ¨¡å—åŒ–ã€å¯æµ‹è¯•ï¼Œå¹¶èƒ½å¤Ÿé€‚åº”æœªæ¥çš„è®¾è®¡æˆ–ä¸šåŠ¡éœ€æ±‚ã€‚</p>

<p>å¦‚æœä½ æœ‰ä»€ä¹ˆæœ‰è¶£çš„æƒ³æ³•ï¼Œåˆ«å¿˜äº†åœ¨è¯„è®ºåŒºåˆ†äº«ã€‚ğŸ˜‰</p>

<h3>ğŸ«± è½®åˆ°ä½ äº†</h3>

<p>ç°åœ¨ä½ å·²ç»äº†è§£äº†å®ƒçš„å·¥ä½œåŸç†ï¼ˆä»¥åŠå®ƒå®é™…éœ€è¦çš„ä»£ç é‡æœ‰å¤šå°ï¼‰ï¼Œé‚£å°±åœ¨ä¸‹ä¸€ä¸ª Compose å±å¹•ä¸­å°è¯•ä¸€ä¸‹å§ã€‚ä¸å†éœ€è¦ç¹ççš„ AnnotatedString.Builder ä»£ç ã€‚ä¸å†éœ€è¦é‡å¤çš„ span é€»è¾‘ã€‚åªéœ€æè¿°ä½ æƒ³è¦çš„å†…å®¹ï¼Œå‰©ä¸‹çš„äº¤ç»™ StyledText å¤„ç†ã€‚</p>

<p><strong>è®© Compose ä¸­çš„æ–‡æœ¬æ ·å¼å†æ¬¡å˜å¾—ç®€å•ã€‚ğŸ˜</strong></p>

<h3>ğŸ¤ æ„Ÿè°¢é˜…è¯»</h3>

<p>å¦‚æœä½ æœ€ç»ˆåœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† StyledStringï¼Œè¯·å‘Šè¯‰æˆ‘ï¼çœ‹åˆ°è¿™äº›å¾®å‹æ¨¡å¼åœ¨ç°å®ä¸–ç•Œä¸­è½åœ°æ€»æ˜¯å¾ˆé…·ã€‚ğŸ‘€</p>

<p>æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰ç”¨ï¼Œè¯·è€ƒè™‘åˆ†äº«ç»™å…¶ä»–å¼€å‘è€…ï¼Œç‚¹èµæˆ–ç•™è¨€ã€‚è¿™å¾ˆæœ‰å¸®åŠ©ã€‚âœŒï¸</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ­å¯†Jetpack Composeä¸­çš„PausableComposition]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition/"/>
    <updated>2025-07-24T19:55:51+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒExploring PausableComposition internals in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose">https://blog.shreyaspatil.dev/exploring-pausablecomposition-internals-in-jetpack-compose</a>ï¼Œç”±Shreyas Patilå‘å¸ƒäº2025å¹´7æœˆ14æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/07/24/exploring-pausablecomposition/"><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751791091096/4e5b36e3-485c-4079-88be-987082e7d67e.png?w=1600&h=840&fit=crop&crop=entropy&auto=compress,format&format=webp" title="auto auto" ></a></p>

<!-- more -->


<p>å—¨ï¼ŒComposers ä»¬ğŸ‘‹ï¼Œåœ¨æœ€è¿‘çš„ Compose 1.9.X ç‰ˆæœ¬ä¸­ï¼ŒCompose-runtime å¼•å…¥äº†ä¸€ä¸ªåä¸º PausableComposition çš„æ–°å†…éƒ¨ APIï¼Œæ®ç§°å®ƒå¯ä»¥è§£å†³æ€§èƒ½é—®é¢˜ã€‚å®ƒå¬èµ·æ¥åƒé­”æ³•ï¼Œä½†åœ¨åº•å±‚ï¼Œè¿™ä¸€åˆ‡éƒ½å½’åŠŸäºä¸€äº›éå¸¸å·§å¦™çš„å·¥ç¨‹è®¾è®¡ã€‚åœ¨æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶ä»¥æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹æ—¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº†ä¸€ä¸ªå¼ºå¤§çš„å†…éƒ¨å·¥å…·ï¼Œå®ƒä½¿è¿™ä¸€åˆ‡æˆä¸ºå¯èƒ½ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« å°†æ·±å…¥åˆ†æè¿™ä¸€æœºåˆ¶ï¼šPausableCompositionã€‚è¿™æ˜¯ Compose çš„å†…éƒ¨ APIï¼Œå¼€å‘è€…æ— éœ€äº†è§£å®ƒã€‚ä½†äº†è§£å®ƒçš„åº•å±‚å·¥ä½œåŸç†æ€»æ˜¯æœ‰ç›Šçš„ã€‚å¯¹äºæƒ³è¦æ·±å…¥äº†è§£ Compose å¦‚ä½•å®ç°å…¶æƒŠäººæ€§èƒ½çš„ Jetpack Compose å¼€å‘è€…æ¥è¯´ï¼Œè¿™ç¯‡æ¢ç´¢æ–‡ç« å°†ä¸ºä½ æä¾›æ›´æ¸…æ™°çš„è§†è§’ã€‚æˆ‘ä»¬å°†æ·±å…¥è¿è¡Œæ—¶æºä»£ç ï¼Œäº†è§£å®ƒçš„å·¥ä½œåŸç†ã€å®ƒå¯¹æ€§èƒ½å¦‚æ­¤é‡è¦çš„åŸå› ï¼Œä»¥åŠå¦‚ä½•åè°ƒæ‰€æœ‰ç»„ä»¶ä»¥ä½¿æˆ‘ä»¬çš„ UI æ„Ÿè§‰å¦‚æ­¤æµç•…ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼</p>

<h2>ç¼˜èµ·</h2>

<p>ä¸ºäº†å®ç°æµç•…çš„ 60 å¸§/ç§’ (fps)ï¼Œæˆ‘ä»¬çš„åº”ç”¨éœ€è¦åœ¨ 16.7 æ¯«ç§’å†…ç»˜åˆ¶æ¯ä¸€å¸§ã€‚å½“ç”¨æˆ·æ»šåŠ¨æµè§ˆ LazyColumn æ—¶ï¼Œå¿…é¡»åœ¨è¿™ä¸ªå¾®å°çš„çª—å£å†…åˆ›å»ºã€æµ‹é‡å’Œç»˜åˆ¶æ–°çš„é¡¹ç›®ã€‚</p>

<p>å¦‚æœä¸€ä¸ªé¡¹ç›®å¾ˆå¤æ‚ï¼ŒåŒ…å«åµŒå¥—å¸ƒå±€ã€å›¾ç‰‡å’Œå¤§é‡é€»è¾‘ï¼Œé‚£ä¹ˆç»„åˆå®ƒæ‰€éœ€çš„å·¥ä½œå¾ˆå®¹æ˜“è¶…è¿‡ 16 æ¯«ç§’ã€‚å½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¸»çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œå¸§ä¼šä¸¢å¤±ï¼Œç”¨æˆ·ä¼šåœ¨æ»šåŠ¨è¿‡ç¨‹ä¸­çœ‹åˆ°â€œå¡é¡¿â€æˆ–å¡é¡¿ã€‚ğŸ˜©</p>

<p>è¿™æ­£æ˜¯ PausableComposition çš„åˆè¡·ã€‚</p>

<h2>â€œåšä»€ä¹ˆâ€ï¼šæ›´æ™ºèƒ½çš„ Compose æ–¹å¼</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ˜¯ä¸€ä½å¨å¸ˆï¼Œæ­£åœ¨ä¸ºä¸€åœºæ´»åŠ¨å‡†å¤‡ä¸€é¡¿å¤§é¤ã€‚ğŸ‘¨â€ğŸ³ ä¸å…¶åœ¨ç¬¬ä¸€ä½å®¢äººåˆ°æ¥æ—¶æ…Œä¹±åœ°ä»å¤´å¼€å§‹çƒ¹é¥ªæ‰€æœ‰é£Ÿæï¼Œä¸å¦‚æå‰å‡ ä¸ªå°æ—¶åšå¥½å‡†å¤‡å·¥ä½œã€‚åˆ‡èœã€è°ƒé…±ã€çƒ¤ç”œç‚¹ã€‚ç­‰åˆ°ä¸Šæ¡Œæ—¶ï¼Œæœ€åçš„çƒ¹é¥ªå’Œç»„è£…é€Ÿåº¦ä¼šå¿«å¾—ä»¤äººéš¾ä»¥ç½®ä¿¡ã€‚</p>

<p>PausableComposition å°†è¿™ç§â€œå‡†å¤‡å·¥ä½œâ€çš„ç†å¿µå¸¦åˆ°äº† Compose ä¸­ã€‚å®ƒå…è®¸è¿è¡Œæ—¶ï¼š</p>

<ol>
<li>å¢é‡å¼ Composeï¼šå°†å¤§å‹ UI å…ƒç´ çš„åˆæˆåˆ†è§£æˆæ›´å°ã€æ›´æ˜“äºç®¡ç†çš„éƒ¨åˆ†ã€‚</li>
<li>å¼‚æ­¥å‡†å¤‡ï¼šåœ¨ UI çœŸæ­£éœ€è¦æ˜¾ç¤ºåœ¨å±å¹•ä¸Šä¹‹å‰è¿›è¡Œåˆæˆå·¥ä½œï¼Œé€šå¸¸åˆ©ç”¨å¸§é—´çš„ç©ºé—²æ—¶é—´ã€‚</li>
</ol>


<p>è¿™ç§å¯ç»„åˆé¡¹çš„é¢„çƒ­æ„å‘³ç€ï¼Œå½“æŸä¸ªé¡¹ç›®æœ€ç»ˆæ»šåŠ¨åˆ°è§†å›¾ä¸­æ—¶ï¼Œå¤§éƒ¨åˆ†ç¹é‡çš„å·¥ä½œå·²ç»å®Œæˆï¼Œä½¿å…¶å‡ ä¹å¯ä»¥ç«‹å³æ˜¾ç¤ºã€‚</p>

<p>ä¸ºäº†ç›´è§‚åœ°ç†è§£è¿™ä¸€æ¦‚å¿µï¼Œè¯·è§‚çœ‹ä»¥ä¸‹åŠ¨ç”»ï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751997214840/f9f7308a-7b83-4a3d-9d38-e3ce6aa8d9a9.gif?auto=format,compress&amp;gif-q=60&amp;format=webm" alt="æ»šåŠ¨å¸§æ—¶é—´çº¿" /></p>

<p>æ»šåŠ¨å‘ç”Ÿæ—¶ï¼Œå‡è®¾é¡¹ç›® Aã€Bã€Cã€D å’Œ E å·²åœ¨å±å¹•ä¸Šå¯è§ï¼Œä¸‹ä¸€ä¸ªé¡¹ç›®æ˜¯ Fã€‚å¦‚æœé¡¹ç›® F çš„å¸ƒå±€æˆ–ç»“æ„å¤æ‚ï¼Œéœ€è¦æ›´å¤šæ—¶é—´è¿›è¡Œå¸ƒå±€è®¡ç®—æˆ–å…¶ä»–é¢„å¤„ç†æ‰èƒ½åœ¨ UI ä¸Šæ¸²æŸ“ï¼Œåˆ™æ­¤é¢„å¤„ç†å°†åœ¨å¸§æ—¶é—´è½´å†…åˆ†å—è¿›è¡Œï¼ˆä¾‹å¦‚ 16 æ¯«ç§’ï¼‰ã€‚å› æ­¤ï¼Œå¦‚æœå®ƒéœ€è¦ 2 å¸§ï¼Œåˆ™ F æ‰€éœ€çš„é¢„å¤„ç†ä¼šåœ¨ 2 å¸§çš„ç©ºé—²æ—¶é—´å†…å®Œæˆï¼Œä¸ä¼šé€ æˆä»»ä½•å¸§å¡é¡¿ã€‚æœ€åï¼Œå½“éœ€è¦æ˜¾ç¤ºæ—¶ï¼Œå®ƒä¼šè¢«ç»˜åˆ¶åˆ° UI ä¸Šã€‚é¡¹ç›® G å’Œ H ä¹Ÿé‡‡ç”¨ç›¸åŒçš„æµç¨‹ã€‚</p>

<h2>å·¥ä½œåŸç†ï¼šæ ¸å¿ƒç»„ä»¶</h2>

<p>é€šè¿‡æŸ¥çœ‹è¿è¡Œæ—¶æºä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸€äº›å…³é”®æ¥å£å’Œç±»æ¥å¤„ç†çš„ã€‚è™½ç„¶ä½ ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™äº› APIï¼Œä½†ç†è§£å®ƒä»¬å¯ä»¥æ­ç¤º LazyColumn çš„æ€§èƒ½æå‡ã€‚ğŸ•µï¸â€â™‚ï¸</p>

<h3>ç”Ÿå‘½å‘¨æœŸï¼šPausableComposition åŠå…¶æ§åˆ¶å™¨</h3>

<p>æ—…ç¨‹ä» PausableComposition æ¥å£å¼€å§‹ï¼Œè¯¥æ¥å£æ‰©å±•äº† ReusableComposition å¹¶æ·»åŠ äº†æš‚åœåŠŸèƒ½ã€‚</p>

<blockquote><p>å…³äº ReusableComposition çš„ç®€è¦è¯´æ˜ï¼š</p>

<p>åœ¨è®¨è®ºæš‚åœä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯ ReusableCompositionï¼Ÿå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç»„åˆï¼Œä¸“ä¸ºéœ€è¦é«˜æ•ˆå›æ”¶ UI å†…å®¹çš„é«˜æ€§èƒ½åœºæ™¯è€Œè®¾è®¡ã€‚æƒ³è±¡ä¸€ä¸‹ LazyColumn ä¸­çš„é¡¹ç›®ã€‚ReusableComposition ä¸ä¼šé”€æ¯æ»šåŠ¨åˆ°å±å¹•å¤–çš„é¡¹ç›®çš„æ•´ä¸ªç»„åˆï¼Œè€Œæ˜¯å…è®¸è¿è¡Œæ—¶åœç”¨å®ƒã€‚è¿™ä¼šä¿ç•™åº•å±‚ UI èŠ‚ç‚¹ï¼Œä½†ä¼šæ¸…é™¤å·²è®°ä½çš„çŠ¶æ€ã€‚ç„¶åï¼Œè¿™ä¸ªåœç”¨çš„ç»„åˆå¯ä»¥å¿«é€Ÿåœ°ç”¨æ–°å†…å®¹â€œé‡æ–°å¡«å……â€ï¼Œä»è€ŒèŠ‚çœäº†ä»å¤´åˆ›å»ºèŠ‚ç‚¹çš„æˆæœ¬ã€‚PausableComposition ç›´æ¥æ„å»ºäºè¿™ä¸ªå¼ºå¤§çš„å›æ”¶åŸºç¡€ä¹‹ä¸Šã€‚</p></blockquote>

<p>PausableComposition çš„å¤–è§‚å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=66</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PausableComposition</span> <span class="p">:</span> <span class="n">ReusableComposition</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setPausableContent</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">PausedComposition</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setPausableContentWithReuse</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">):</span> <span class="n">PausedComposition</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ï¼ˆæ³¨æ„ï¼šè¯¥æ¥å£æ˜¯å¯†å°çš„ï¼Œå› ä¸ºå®ƒä»…åœ¨ Compose è¿è¡Œæ—¶å†…éƒ¨å…·æœ‰ä¸€ç»„å°é—­ä¸”æœ‰é™çš„å®ç°ã€‚è¿™ä¸ºç¼–è¯‘å™¨æä¾›äº†æ›´å¤šä¿¡æ¯æ¥è¿›è¡Œä¼˜åŒ–ã€‚ï¼‰</p>

<p>è°ƒç”¨ setPausableContent ä¸ä¼šç«‹å³ç»„åˆç•Œé¢ã€‚ç›¸åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª PausedComposition å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å……å½“é€æ­¥è¿‡ç¨‹çš„æ§åˆ¶å™¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=112</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PausedComposition</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isComplete</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">resume</span><span class="p">(</span><span class="n">shouldPause</span><span class="p">:</span> <span class="n">ShouldPauseCallback</span><span class="p">):</span> <span class="n">Boolean</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">apply</span><span class="p">()</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">cancel</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªç”Ÿå‘½å‘¨æœŸæœ€å¥½ä»¥çŠ¶æ€æœºçš„å½¢å¼æ¥è¡¨ç¤ºï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751864148018/27512893-f186-47e7-9bdc-26036460aed7.png?auto=compress,format&amp;format=webp" alt="PausableCompositionç”Ÿå‘½å‘¨æœŸæµç¨‹å›¾" /></p>

<ul>
<li>resume(shouldPause: ShouldPauseCallback)ï¼šè¿™æ˜¯å¼•æ“ã€‚é¢„å–ç³»ç»Ÿï¼ˆæ­¤å¤„æŒ‡ LazyColumn ä¸Šä¸‹æ–‡ï¼‰ä¼šåå¤è°ƒç”¨ resume() æ¥æ‰§è¡Œå¤§é‡çš„ç»„åˆå·¥ä½œã€‚ç¥å¥‡ä¹‹å¤„åœ¨äº shouldPause å›è°ƒã€‚Compose è¿è¡Œæ—¶ä¼šåœ¨ç»„åˆè¿‡ç¨‹ä¸­é¢‘ç¹è°ƒç”¨æ­¤ lambdaã€‚å¦‚æœå®ƒè¿”å› trueï¼ˆä¾‹å¦‚ï¼Œç”±äºå¸§æˆªæ­¢æ—¶é—´å·²è¿‘ï¼‰ï¼Œåˆ™ç»„åˆè¿‡ç¨‹å°†åœæ­¢ï¼Œå¹¶å°†ä¸»çº¿ç¨‹äº¤è¿˜ç»™æ›´é‡è¦çš„å·¥ä½œï¼Œä¾‹å¦‚ç»˜åˆ¶å½“å‰å¸§ã€‚</li>
<li>apply()ï¼šä¸€æ—¦ resume() è¿”å› trueï¼Œå³è¡¨ç¤ºæ“ä½œå®Œæˆï¼Œå°±ä¼šè°ƒç”¨ apply()ã€‚è¿™ä¼šè·å–æ‰€æœ‰è®¡ç®—å‡ºçš„ç•Œé¢æ›´æ”¹ï¼Œå¹¶å°†å…¶æäº¤åˆ°å®é™…çš„ç•Œé¢æ ‘ä¸­ã€‚</li>
<li>cancel()ï¼šå¦‚æœç”¨æˆ·æ»šåŠ¨ç¦»å¼€ï¼Œå¹¶ä¸”ä¸å†éœ€è¦é¢„å…ˆç»„åˆçš„é¡¹ç›®ï¼Œåˆ™ä¼šè°ƒç”¨ cancellation() æ¥ä¸¢å¼ƒå·¥ä½œå¹¶é‡Šæ”¾èµ„æºã€‚</li>
</ul>


<h3>å†…éƒ¨ç»“æ„æ¦‚è§ˆï¼šPausedCompositionImpl</h3>

<p>ä¸Šè¿°çŠ¶æ€æœºç”±å†…éƒ¨çš„ PausedCompositionImpl ç±»ç®¡ç†ã€‚è¯¥ç±»ä¿å­˜çŠ¶æ€å¹¶è¿æ¥æ‰€æœ‰éƒ¨åˆ†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/PausableComposition.kt;l=202</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">PausedCompositionImpl</span><span class="p">(...)</span> <span class="p">:</span> <span class="n">PausedComposition</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">state</span> <span class="p">=</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">InitialPending</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">pausableApplier</span> <span class="p">=</span> <span class="n">RecordingApplier</span><span class="p">(</span><span class="n">applier</span><span class="p">.</span><span class="n">current</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">resume</span><span class="p">(</span><span class="n">shouldPause</span><span class="p">:</span> <span class="n">ShouldPauseCallback</span><span class="p">):</span> <span class="n">Boolean</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">InitialPending</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// This is the first time resume() is called.</span>
</span><span class='line'>                <span class="c1">// It starts the initial composition of the content.</span>
</span><span class='line'>                <span class="n">invalidScopes</span> <span class="p">=</span>
</span><span class='line'>                    <span class="n">context</span><span class="p">.</span><span class="n">composeInitialPaused</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">shouldPause</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'>                <span class="n">state</span> <span class="p">=</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">RecomposePending</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">invalidScopes</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="n">markComplete</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">RecomposePending</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// This is for subsequent calls to resume().</span>
</span><span class='line'>                <span class="n">state</span> <span class="p">=</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">Recomposing</span>
</span><span class='line'>                <span class="c1">// It tells the Composer to continue where it left off,</span>
</span><span class='line'>                <span class="c1">// processing any pending invalidations.</span>
</span><span class='line'>                <span class="n">invalidScopes</span> <span class="p">=</span>
</span><span class='line'>                    <span class="n">context</span><span class="p">.</span><span class="n">recomposePaused</span><span class="p">(</span><span class="n">composition</span><span class="p">,</span> <span class="n">shouldPause</span><span class="p">,</span> <span class="n">invalidScopes</span><span class="p">)</span>
</span><span class='line'>                <span class="n">state</span> <span class="p">=</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">RecomposePending</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">invalidScopes</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="n">markComplete</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// ... other states like Recomposing, Applied, Cancelled are handled here ...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">isComplete</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">apply</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ... other state checks ...</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="p">==</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">ApplyPending</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">applyChanges</span><span class="p">()</span> <span class="c1">// The call site</span>
</span><span class='line'>            <span class="n">state</span> <span class="p">=</span> <span class="n">PausedCompositionState</span><span class="p">.</span><span class="n">Applied</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">applyChanges</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>        <span class="n">pausableApplier</span><span class="p">.</span><span class="n">playTo</span><span class="p">(</span><span class="n">applier</span><span class="p">,</span> <span class="n">rememberManager</span><span class="p">)</span>
</span><span class='line'>        <span class="n">rememberManager</span><span class="p">.</span><span class="n">dispatchRememberObservers</span><span class="p">()</span>
</span><span class='line'>        <span class="n">rememberManager</span><span class="p">.</span><span class="n">dispatchSideEffects</span><span class="p">()</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è°ƒç”¨ resume() æ—¶ï¼Œå®ƒä¼šæ£€æŸ¥å…¶å†…éƒ¨çŠ¶æ€å¹¶é‡‡å–ç›¸åº”çš„æªæ–½ï¼š</p>

<ul>
<li>InitialPendingï¼šé¦–æ¬¡è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.composeInitialPaused å¯åŠ¨åˆæˆè¿‡ç¨‹ã€‚è¿™ä¼šå‘ŠçŸ¥æ ¸å¿ƒ ComposerImpl å¼€å§‹æ‰§è¡Œ @Composable å†…å®¹ï¼Œå¹¶æ‰§è¡Œ shouldPause å›è°ƒã€‚</li>
<li>RecomposePendingï¼šåç»­è°ƒç”¨æ—¶ï¼Œå®ƒä¼šé€šè¿‡è°ƒç”¨ context.recomposePaused ç»§ç»­å·¥ä½œã€‚æ­¤æ–¹æ³•ç”¨äºå¤„ç†åˆæˆä¸­ä»»ä½•å› çŠ¶æ€å˜åŒ–è€Œå¤±æ•ˆçš„éƒ¨åˆ†ï¼Œæˆ–ç»§ç»­ä¹‹å‰æš‚åœçš„å·¥ä½œã€‚</li>
<li>Applierï¼šåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼ŒComposerImpl å°†æ‰€æœ‰ UI æ›´æ”¹æ“ä½œè½¬å‘ç»™ pausableApplierï¼ˆå³ RecordingApplierï¼‰ï¼Œè¯¥æ“ä½œä¼šè¿›è¡Œç¼“å†²ï¼Œè€Œä¸æ˜¯ç«‹å³åº”ç”¨ã€‚</li>
<li>æ­¤è¿‡ç¨‹æŒç»­è¿›è¡Œï¼Œç›´åˆ°å·¥ä½œå®Œæˆæˆ– shouldPause å›è°ƒè¿”å› trueã€‚</li>
</ul>


<h3>RecordingApplierï¼šæ¨è¿Ÿæœ€åçš„æ¶¦è‰²</h3>

<p>ä¸€ä¸ªå…³é”®çš„æ€§èƒ½æŠ€å·§æ˜¯ RecordingApplierã€‚è°ƒç”¨ resume() æ—¶ï¼ŒComposer ä¸ä¼šç›´æ¥æ›´æ”¹å®æ—¶ UI æ ‘ã€‚å¦‚æœåˆ†å°æ­¥æ‰§è¡Œï¼Œå¯èƒ½ä¼šå¾ˆæ…¢ï¼Œå¹¶å¯¼è‡´ UI æ›´æ–°ä¸å®Œæ•´ï¼Œæ˜¾å¾—æ€ªå¼‚ã€‚</p>

<p>PausableComposition ä½¿ç”¨çš„æ˜¯ RecordingApplierã€‚è¿™ä¸ªç‰¹æ®Šçš„ Applier ä¼šå°†å…¶åº”è¯¥æ‰§è¡Œçš„æ‰€æœ‰ UI æ“ä½œï¼ˆä¾‹å¦‚â€œåˆ›å»º Text èŠ‚ç‚¹â€ã€â€œè®¾ç½®å…¶æ–‡æœ¬å±æ€§â€æˆ–â€œæ·»åŠ å­å›¾åƒâ€ï¼‰è®°å½•åˆ°ä¸€ä¸ªå†…éƒ¨åˆ—è¡¨ä¸­ã€‚</p>

<p>åªæœ‰è°ƒç”¨ PausedComposition.apply() æ—¶ï¼ŒRecordingApplier æ‰ä¼šå°†å…¶è®°å½•çš„æ“ä½œåˆ—è¡¨â€œå›æ”¾â€åˆ°å®é™…çš„ Applier ä¸Šï¼Œä»è€Œé«˜æ•ˆåœ°å•æ­¥æ›´æ–° UI æ ‘ã€‚PausedComposition çš„å…¬å…± apply() æ–¹æ³•æ˜¯ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºå®ˆå«ã€‚çœŸæ­£çš„å·¥ä½œå‘ç”Ÿåœ¨å†…éƒ¨çš„ applyChanges() æ–¹æ³•ä¸­ï¼ˆå¦‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼‰ã€‚</p>

<p>å½“è°ƒç”¨ applyChanges æ—¶ï¼Œå®ƒä¼šæŒ‰é¡ºåºæ‰§è¡Œä¸‰é¡¹å…³é”®æ“ä½œï¼š</p>

<ul>
<li>å®ƒä¼šå‘Šè¯‰ RecordingApplier å°†å…¶æ‰€æœ‰ç¼“å†²çš„å‘½ä»¤æ’­æ”¾åˆ°å®é™…çš„ applier ä¸Šã€‚è¿™æ‰æ˜¯ UI çœŸæ­£å‡ºç°åœ¨å±å¹•ä¸Šçš„å…³é”®ã€‚</li>
<li>å®ƒä¼šä¸ºæ‰€æœ‰å·²åˆ›å»ºçš„ RememberObserversï¼ˆä¾‹å¦‚ DisposableEffectï¼‰è°ƒåº¦æ‰€æœ‰ onRemembered ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚</li>
<li>æœ€åï¼Œå®ƒä¼šè¿è¡Œåœ¨åˆæˆè¿‡ç¨‹ä¸­æ’é˜Ÿçš„æ‰€æœ‰ SideEffectã€‚</li>
</ul>


<p>è¿™ç§æœ‰åºçš„æ‰¹å¤„ç†è¿‡ç¨‹ç¡®ä¿ UI é«˜æ•ˆæ›´æ–°ï¼Œå¹¶ä¸”æ‰€æœ‰ç”Ÿå‘½å‘¨æœŸäº‹ä»¶éƒ½åœ¨æ­£ç¡®çš„æ—¶é—´å‘ç”Ÿã€‚</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751794209046/49f5c1c7-b424-4c7d-a017-8ba65bb7b2d3.png?auto=compress,format&amp;format=webp" alt="PausableCompositionæ—¶åºå›¾" /></p>

<h2>ä½¿ç”¨äº† PausableComposition çš„ LazyList</h2>

<p>LazyList å·²ç»å¼€å§‹ä½¿ç”¨ PausableComposition APIäº†ã€‚åœ¨ LazyList ä¸­ï¼ŒPausableComposition å¹¶éç‹¬ç«‹å·¥ä½œï¼Œè€Œæ˜¯ååŒå·¥ä½œçš„ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚</p>

<ul>
<li>æŒ‡æŒ¥å™¨ (Recomposer)ï¼šä¸» Recomposer è´Ÿè´£æ§åˆ¶èŠ‚å¥ï¼Œé©±åŠ¨å¯è§ UI çš„é€å¸§æ›´æ–°ã€‚</li>
<li>è§„åˆ’å™¨ (LazyLayoutPrefetchState)ï¼šå½“ç”¨æˆ·æ»šåŠ¨æ—¶ï¼Œæ­¤ç»„ä»¶ä¼šé¢„æµ‹å“ªäº›é¡¹ç›®å³å°†æ˜¾ç¤ºã€‚</li>
<li>èˆå°ç®¡ç†å™¨ (SubcomposeLayout)ï¼šè¿™ä¸ªå¼ºå¤§çš„ SubcomposeLayout æ˜¯ LazyList çš„åŸºç¡€ã€‚å®ƒçš„ SubcomposeLayoutState å¯ä»¥åœ¨éœ€è¦æ—¶ä¸ºå„ä¸ªé¡¹ç›®åˆ›å»ºå’Œç®¡ç†åˆæˆã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒæä¾›äº† createPausedPrecomposition() APIã€‚</li>
<li>èˆå°è°ƒåº¦å™¨ (PrefetchScheduler)ï¼šæ­¤è°ƒåº¦å™¨ä¼šåœ¨å¸§ä¹‹é—´å¯»æ‰¾ç©ºé—²æ—¶é—´æ¥æ‰§è¡Œè§„åˆ’å™¨è¯·æ±‚çš„é¢„åˆæˆå·¥ä½œã€‚</li>
</ul>


<p>äº†è§£æ­¤åŠŸèƒ½çš„å¼€å‘è¿‡ç¨‹ä¹Ÿå¾ˆæœ‰è¶£ã€‚åœ¨ LazyLayoutPrefetchState æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥æ‰¾åˆ°æ§åˆ¶å®ƒçš„åŠŸèƒ½æ ‡å¿—ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// A simplified look inside LazyLayoutPrefetchState.kt: https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=647</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ComposeFoundationFlags</span><span class="p">.</span><span class="n">isPausableCompositionInPrefetchEnabled</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This is the future, modern path.</span>
</span><span class='line'>    <span class="n">performPausableComposition</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">contentType</span><span class="p">,</span> <span class="n">average</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// This is the older, non-pausable fallback.</span>
</span><span class='line'>    <span class="n">performFullComposition</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">contentType</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>isPausableCompositionInPrefetchEnabled è¿™ä¸ªæ ‡å¿—å……å½“äº†ç»ˆæ­¢å¼€å…³çš„ä½œç”¨ã€‚è™½ç„¶å®ƒåœ¨æºä»£ç ä¸­çš„é»˜è®¤å€¼ä¸º falseã€‚å¦‚æœä½ æƒ³åœ¨æƒ°æ€§å¸ƒå±€ï¼ˆLazyColumnã€LazyRow ç­‰ï¼‰ä¸­å¯ç”¨å¯æš‚åœç»„åˆè¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°æŒ‰å¦‚ä¸‹æ–¹å¼å¯ç”¨å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyApplication</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ComposeFoundationFlags</span><span class="p">.</span><span class="n">isPausableCompositionInPrefetchEnabled</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è§„åˆ’å™¨ï¼šLazyLayoutPrefetchState è¯¦è§£</h3>

<p>LazyLayoutPrefetchState æ˜¯é¢„å–æ“ä½œçš„æ ¸å¿ƒã€‚å®ƒçš„ä½œç”¨æ˜¯è·å–æ¥è‡ª LazyLayout çš„é¢„æµ‹ï¼ˆä¾‹å¦‚ï¼Œâ€œç¬¬ 25 é¡¹å³å°†ä¸Šçº¿â€ï¼‰ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºå®é™…çš„é¢„ç»„åˆä»»åŠ¡ã€‚</p>

<p>å®ƒé€šè¿‡ PrefetchHandleProvider å®ç°æ­¤æ“ä½œï¼Œè¯¥æä¾›è€…ä¼šåˆ›å»ºä¸€ä¸ª PrefetchRequestã€‚æ­¤è¯·æ±‚æ˜¯ PrefetchScheduler å¯ä»¥æ‰§è¡Œçš„å·¥ä½œå•å…ƒã€‚åœ¨è¿™ä¸ªè¯·æ±‚ä¸­ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æš‚åœé€»è¾‘çš„æ ¸å¿ƒã€‚</p>

<p>å½“ PrefetchScheduler æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œå®ƒä¼šè¿›å…¥ä¸€ä¸ªå¾ªç¯ï¼Œåœ¨ PausableComposition ä¸Šè°ƒç”¨ resume()ã€‚ä¼ é€’ç»™ resume çš„ lambda è¡¨è¾¾å¼å†³å®šæ˜¯å¦æš‚åœã€‚</p>

<p>å› æ­¤ï¼Œå¦‚æœå¯ç”¨äº†ä¸Šè¿°åŠŸèƒ½æ ‡è®°ï¼Œå®ƒå°†é€šè¿‡ Pausable Composition API æ‰§è¡Œè¯·æ±‚ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/foundation/foundation/src/commonMain/kotlin/androidx/compose/foundation/lazy/layout/LazyLayoutPrefetchState.kt;l=754</span>
</span><span class='line'><span class="c1">// Simplified from HandleAndRequestImpl inside LazyLayoutPrefetchState</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PrefetchRequestScope</span><span class="p">.</span><span class="n">performPausableComposition</span><span class="p">(...)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">composition</span> <span class="p">=</span> <span class="c1">// get the composition for the item of the LazyLayout </span>
</span><span class='line'>    <span class="n">pauseRequested</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="p">(!</span><span class="n">composition</span><span class="p">.</span><span class="n">isComplete</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">pauseRequested</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">composition</span><span class="p">.</span><span class="n">resume</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">pauseRequested</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// 1. Update how much time is left in this frame&#39;s idle window.</span>
</span><span class='line'>                <span class="n">updateElapsedAndAvailableTime</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// 2. Save how long this work chunk took, to improve future estimates.</span>
</span><span class='line'>                <span class="n">averages</span><span class="p">.</span><span class="n">saveResumeTimeNanos</span><span class="p">(</span><span class="n">elapsedTimeNanos</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// 3. The Core Decision: Is there enough time left to do another</span>
</span><span class='line'>                <span class="c1">//    chunk of work without risking a frame drop?</span>
</span><span class='line'>                <span class="n">pauseRequested</span> <span class="p">=</span> <span class="p">!</span><span class="n">shouldExecute</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">availableTimeNanos</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">averages</span><span class="p">.</span><span class="n">resumeTimeNanos</span> <span class="p">+</span> <span class="n">averages</span><span class="p">.</span><span class="n">pauseTimeNanos</span><span class="p">,</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// 4. Return the decision to the composition engine.</span>
</span><span class='line'>            <span class="n">pauseRequested</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">updateElapsedAndAvailableTime</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pauseRequested</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// If we decided to pause, record how long the final pause check took.</span>
</span><span class='line'>        <span class="n">averages</span><span class="p">.</span><span class="n">savePauseTimeNanos</span><span class="p">(</span><span class="n">elapsedTimeNanos</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// If we finished without pausing, record the time for the final resume chunk.</span>
</span><span class='line'>        <span class="n">averages</span><span class="p">.</span><span class="n">saveResumeTimeNanos</span><span class="p">(</span><span class="n">elapsedTimeNanos</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è®©æˆ‘ä»¬åˆ†è§£ä¸€ä¸‹è¿™ä¸ªé€»è¾‘ï¼š</p>

<ol>
<li>updateElapsedAndAvailableTime()ï¼šåœ¨æ¢å¤ lambda å‡½æ•°å†…éƒ¨ï¼Œç³»ç»Ÿä¼šä¸æ–­æ£€æŸ¥è·ç¦»ä¸‹ä¸€å¸§éœ€è¦ç»˜åˆ¶è¿˜å‰©å¤šå°‘æ—¶é—´ã€‚</li>
<li>averages.saveResumeTimeNanos(&hellip;)ï¼šå®ƒä¼šè®°å½•æ¯ä¸ªå°å—åˆæˆå·¥ä½œæ‰€éœ€çš„æ—¶é—´ã€‚è¿™æœ‰åŠ©äºå®ƒæ„å»ºä¸€ä¸ªå¹³å‡å€¼ (averages) æ¥é¢„æµ‹æœªæ¥å·¥ä½œçš„æˆæœ¬ã€‚</li>
<li>!shouldExecute(&hellip;)ï¼šè¿™æ˜¯æ ¸å¿ƒå†³ç­–ã€‚å®ƒä¼šå°† availableTimeNanos ä¸é¢„ç®—è¿›è¡Œæ¯”è¾ƒã€‚è¿™ä¸ªé¢„ç®—æ˜¯ä¸€ä¸ªæ™ºèƒ½ä¼°ç®—ï¼šå®Œæˆå¦ä¸€å—å·¥ä½œæ‰€éœ€çš„å¹³å‡æ—¶é—´åŠ ä¸Šæš‚åœæ‰€éœ€çš„å¹³å‡æ—¶é—´ã€‚å¦‚æœæ—¶é—´ä¸è¶³ï¼ŒpauseRequested ä¼šå˜ä¸º trueã€‚</li>
<li>æœ€ç»ˆè®¡æ—¶ï¼šåœ¨æœ¬æ¬¡å¾ªç¯é€€å‡ºåï¼ˆå› ä¸ºå·¥ä½œå®Œæˆæˆ–è¯·æ±‚æš‚åœï¼‰ï¼Œä¼šè°ƒç”¨æœ€åä¸€æ¬¡ updateElapsedAndAvailableTime()ã€‚è¿™ä¼šæ•è·æœ€åä¸€ä¸ªæ“ä½œçš„æ—¶é—´ã€‚</li>
<li>ä¿å­˜å¹³å‡å€¼ï¼šç„¶åç³»ç»Ÿä¼šä¿å­˜è¿™ä¸ªæœ€ç»ˆè®¡æ—¶ã€‚å¦‚æœè¯·æ±‚äº†æš‚åœï¼Œåˆ™å®ƒä¼šå½±å“ pauseTimeNanosã€‚å¦‚æœå¾ªç¯è‡ªç„¶å®Œæˆï¼Œåˆ™å®ƒä¼šå½±å“ resumeTimeNanosã€‚è¿™ç¡®ä¿äº†ç”¨äºæœªæ¥é¢„æµ‹çš„å†å²æ•°æ®å§‹ç»ˆå‡†ç¡®ã€‚</li>
</ol>


<p>è¿™ç§è‡ªæˆ‘è°ƒèŠ‚çš„åé¦ˆå¾ªç¯å…è®¸é¢„å–å™¨åœ¨ç³»ç»Ÿç©ºé—²æ—¶ä¿æŒç§¯æä¸»åŠ¨ï¼Œä½†åœ¨éœ€è¦æ¸²æŸ“ UI æ—¶åˆèƒ½ä¿æŒç¤¼è²Œï¼Œå°Šé‡ä¸»çº¿ç¨‹ã€‚</p>

<h3>æœ€åä¸€æ­¥ï¼šåº”ç”¨é¢„ç»„åˆ UI</h3>

<p>é‚£ä¹ˆï¼Œå½“å±å¹•ä¸ŠçœŸæ­£éœ€è¦é¢„ç»„åˆçš„é¡¹ç›®æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿè¿™æ—¶ SubcomposeLayout å°±å æ®äº†ä¸­å¿ƒä½ç½®ã€‚åœ¨æ­£å¸¸çš„æµ‹é‡è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šä¸ºç°åœ¨å¯è§çš„é¡¹ç›®è°ƒç”¨å…¶ subcompose å‡½æ•°ã€‚åœ¨å†…éƒ¨ï¼Œè¿™ä¼šè§¦å‘æœ€åä¸€æ­¥ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// https://cs.android.com/androidx/platform/frameworks/support/+/8d08d42d60f7cc7ec0034d0b7ff6fd953516d96a:compose/ui/ui/src/commonMain/kotlin/androidx/compose/ui/layout/SubcomposeLayout.kt;l=1186</span>
</span><span class='line'><span class="c1">// Simplified from LayoutNodeSubcompositionsState inside SubcomposeLayout.kt</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">NodeState</span><span class="p">.</span><span class="n">applyPausedPrecomposition</span><span class="p">(</span><span class="n">shouldComplete</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">pausedComposition</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">pausedComposition</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pausedComposition</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 1. If the work must be completed now...</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">shouldComplete</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ...force the composition to finish by looping `resume`</span>
</span><span class='line'>            <span class="c1">// and always passing `false` to the `shouldPause` callback.</span>
</span><span class='line'>            <span class="k">while</span> <span class="p">(!</span><span class="n">pausedComposition</span><span class="p">.</span><span class="n">isComplete</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">pausedComposition</span><span class="p">.</span><span class="n">resume</span> <span class="p">{</span> <span class="k">false</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// 2. Apply the changes to the real UI tree.</span>
</span><span class='line'>        <span class="n">pausedComposition</span><span class="p">.</span><span class="n">apply</span><span class="p">()</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">pausedComposition</span> <span class="p">=</span> <span class="k">null</span> <span class="c1">// Clear the handle.</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å½“æŸä¸ªé¡¹ç›®å¯è§æ—¶ï¼Œå…¶ç»„åˆä¸å†æ˜¯ä½ä¼˜å…ˆçº§çš„åå°ä»»åŠ¡ï¼Œè€Œæ˜¯é«˜ä¼˜å…ˆçº§çš„åŒæ­¥ä»»åŠ¡ã€‚shouldComplete = true å‚æ•°ç¡®ä¿æ‰€æœ‰å‰©ä½™çš„ç»„åˆå·¥ä½œç«‹å³å®Œæˆï¼Œæ— éœ€æš‚åœã€‚ç„¶åï¼Œapply() è¢«è°ƒç”¨ï¼Œå®Œæ•´çš„ UI ä¼šç«‹å³æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚</p>

<p>å®ƒä»¬å¦‚ä½•ååŒå·¥ä½œï¼š</p>

<p><img src="https://cdn.hashnode.com/res/hashnode/image/upload/v1751799217100/82837ef0-e97e-49c7-bee6-cd68ab1804ba.png?auto=compress,format&amp;format=webp" alt="LazyListæ»šåŠ¨æ—¶åºå›¾" /></p>

<h2>ç»“è®º</h2>

<p>æ·±å…¥ç ”ç©¶ Compose è¿è¡Œæ—¶åï¼ŒPausableComposition çš„è®¾è®¡å ªç§°æ€§èƒ½å·¥ç¨‹çš„æ°ä½œã€‚</p>

<ul>
<li>å®ƒå¹¶éé­”æ³•ï¼Œè€Œæ˜¯å»¶è¿Ÿï¼šå…¶æ ¸å¿ƒç†å¿µæ˜¯åœ¨ç´§æ€¥ä»»åŠ¡ä¹‹å‰å®Œæˆã€‚é€šè¿‡åœ¨ç©ºé—²æ—¶é—´åˆæˆé¡¹ç›®ï¼Œå¿«é€Ÿæ»šåŠ¨æ—¶ä¸»çº¿ç¨‹æ‰€éœ€çš„å·¥ä½œé‡ä¼šå¤§å¤§å‡å°‘ã€‚</li>
<li>åä½œå¼å’Œéé˜»å¡å¼ï¼šshouldPause å›è°ƒæ˜¯å¤„ç†å¤šä»»åŠ¡çš„ç»ä½³æ–¹å¼ã€‚å®ƒå¯ä»¥è®©é•¿æ—¶é—´è¿è¡Œçš„åˆæˆä»»åŠ¡ä¼˜é›…åœ°è®©ä½äºæ›´ç´§æ€¥çš„å½“å‰å¸§æ¸²æŸ“ä»»åŠ¡ï¼Œä»è€Œç›´æ¥é˜²æ­¢å¡é¡¿ã€‚</li>
<li>é€šè¿‡æ‰¹å¤„ç†æé«˜æ•ˆç‡ï¼šRecordingApplier é€šè¿‡å°† UI æ ‘ä¸­çš„è®¸å¤šå°çš„ç‹¬ç«‹æ›´æ”¹åˆ†ç»„ä¸ºå•ä¸ªé«˜æ•ˆçš„æ›´æ–°ï¼Œé¿å…äº†è¿™äº›æ›´æ”¹å¸¦æ¥çš„å¼€é”€ã€‚</li>
</ul>


<p>è™½ç„¶ PausableComposition æ˜¯ä¸€ä¸ªä½ å¯èƒ½æ°¸è¿œä¸ä¼šç›´æ¥ä½¿ç”¨çš„å†…éƒ¨åŠŸèƒ½ï¼Œä½†äº†è§£å®ƒçš„å­˜åœ¨å’Œè¿ä½œæ–¹å¼ï¼Œå¯ä»¥è®©ä½ çœŸæ­£ä½“ä¼šåˆ° Jetpack Compose å¦‚æ­¤é«˜æ€§èƒ½çš„æ˜æ™ºå†³ç­–ã€‚ä¸‹æ¬¡ä½ è½»æ¾æµç•…åœ°æ»šåŠ¨æµè§ˆå¤æ‚çš„ LazyColumn æ—¶ï¼Œä½ å°±ä¼šä½“ä¼šåˆ°è¿™å·§å¦™ä¸”ç²¾å¿ƒç¼–æ’çš„â€œèˆè¹ˆâ€æ˜¯å¦‚ä½•åœ¨è¡¨é¢ä¹‹ä¸‹è¿›è¡Œçš„ã€‚âœ… è¿™ç§æ¶æ„ä¸ä»…è§£å†³äº†å½“å‰çš„æ€§èƒ½æŒ‘æˆ˜ï¼Œè¿˜ä¸º Compose æœªæ¥æ›´å…ˆè¿›çš„æ¸²æŸ“ç­–ç•¥é“ºå¹³äº†é“è·¯ã€‚</p>

<p>å¸Œæœ›ä½ å·²ç»äº†è§£äº†è¿™ä¸ªæ–° API åœ¨ Jetpack Compose ä¸­çš„å·¥ä½œåŸç†ã€‚</p>

<p>å¤ªæ£’äº†ï¼å¸Œæœ›ä½ ä»ä¸­è·å¾—äº†ä¸€äº›å®è´µçš„è§è§£ã€‚å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« ï¼Œè¯·åˆ†äº« ğŸ˜‰ï¼Œå› ä¸ºâ€¦â€¦</p>

<p>â€œåˆ†äº«å³å…³çˆ±â€</p>

<p>è°¢è°¢ï¼ğŸ˜„</p>

<p>è®©æˆ‘ä»¬ä¸€èµ·å›é¡¾ X ï¼ˆé“¾æ¥ï¼š<a href="https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF">https://twitter.com/imShreyasPatil%EF%BC%89%E7%9A%84%E6%9C%80%E6%96%B0%E5%8A%A8%E6%80%81%EF%BC%8C%E6%88%96%E8%80%85%E8%AE%BF%E9%97%AE%E6%88%91%E7%9A%84%E7%BD%91%E7%AB%99%EF%BC%88%E9%93%BE%E6%8E%A5%EF%BC%9Ahttps://shreyaspatil.dev/%EF%BC%89%E4%BA%86%E8%A7%A3%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8E%E6%88%91%E7%9A%84%E4%BF%A1%E6%81%AF</a> ğŸ˜ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[SnapshotFlowè¿˜æ˜¯collectAsStateï¼Ÿå¯¹äºJetpack Composeæ¥è¯´å“ªä¸ªæ›´é¦™ï¼Ÿ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"/>
    <updated>2025-07-16T22:31:22+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒSnapshotFlow or collectAsState? How to pick the right tool for Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123">https://proandroiddev.com/snapshotflow-or-collectasstate-how-to-pick-the-right-tool-for-jetpack-compose-d6f1cc9d2123</a>ï¼Œç”±Dmitry Glazunovå‘å¸ƒäº2025å¹´7æœˆ7æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/16/snapshotflow-or-collectasstate/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*P0darOG2IeBIDWdY" title="auto auto" ></a></p>

<!-- more -->


<p>æ„å»º UI å¯èƒ½æ„Ÿè§‰å¾ˆç®€å•ï¼Œç›´åˆ°éœ€è¦è®¢é˜…çŠ¶æ€å˜åŒ–å¹¶æœ‰æ•ˆå¤„ç†å‰¯ä½œç”¨æ—¶ä¹‹å‰ã€‚è®¸å¤šå¼€å‘è€…è¿‡åº¦ä½¿ç”¨ collectAsStateï¼Œå¯¼è‡´å»¶è¿Ÿå’Œæ„å¤–çš„é‡ç»„ï¼ˆreCompositionï¼‰ã€‚è¿˜æœ‰ä¸€äº›äººå¬è¯´è¿‡ snapshotFlowï¼Œä½†å´ä¸å¤ªæ˜ç™½æ—¢ç„¶ StateFlow å’Œ collectAsState å·²ç»å­˜åœ¨ï¼Œä¸ºä»€ä¹ˆè¿˜éœ€è¦å®ƒï¼Ÿ</p>

<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†é€šè¿‡æ¢ç´¢å®é™…é¡¹ç›®ä¸­ç®€çŸ­ä¸”å®ç”¨çš„ç¤ºä¾‹ï¼Œåˆ†äº«æˆ‘å¯¹ä½•æ—¶ä½¿ç”¨ snapshotFlow ä»¥åŠä½•æ—¶æ›´é€‚åˆä½¿ç”¨ collectAsState çš„çœ‹æ³•ï¼Œå¸®åŠ©ä½ é¿å…é¡¹ç›®ä¸­éšè—çš„ bug å’Œæ€§èƒ½é—®é¢˜ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥è¯¦ç»†åˆ†æä¸€ä¸‹ã€‚</p>

<h2>collectAsState çš„ä½œç”¨</h2>

<p>collectAsState åœ¨ Compose ä¸­è®¢é˜… Flowï¼Œå¹¶è‡ªåŠ¨å°†å…¶å…¬å¼€ä¸ºStateï¼Œä»¥ä¾¿åœ¨ UI ä¸­è½»æ¾æ˜¾ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">uiState</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiStateFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸æ˜“äºä½¿ç”¨ã€‚</li>
<li>é‡ç»„æ—¶è‡ªåŠ¨å–æ¶ˆå¹¶é‡æ–°å¼€å§‹æ”¶é›†ã€‚</li>
<li>éå¸¸é€‚åˆ ViewModel â†’ UI æ•°æ®ç»‘å®šã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>æ¯æ¬¡å‘å‡ºæ–°æ•°æ®æ—¶éƒ½ä¼šè§¦å‘é‡ç»„ï¼Œå“ªæ€•åªæ˜¯å‘ç”Ÿäº†å¾®å°çš„å˜åŒ–ã€‚</li>
<li>å¯ç»„åˆé¡¹è¿›å…¥é‡ç»„çŠ¶æ€åç«‹å³å¼€å§‹æ”¶é›†ã€‚</li>
<li>ä¸é€‚ç”¨äºè§‚å¯Ÿ Compose ç‰¹æœ‰çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ»šåŠ¨æˆ–æ‰‹åŠ¿ã€‚</li>
</ul>


<h2>å¿«ç…§æµ (snapshotFlow) çš„ä½œç”¨</h2>

<p>å¿«ç…§æµ (snapshotFlow) å°† Compose çŠ¶æ€ï¼ˆä¾‹å¦‚ LazyListState ã€ derivedStateOf ï¼‰è½¬æ¢ä¸ºå†·æµ (cold Flow)ï¼Œè®©ä½ æ— éœ€è¿›è¡Œä¸å¿…è¦çš„é‡ç»„å³å¯å¯¹çŠ¶æ€å˜åŒ–åšå‡ºååº”ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">listState</span> <span class="p">=</span> <span class="n">rememberLazyListState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">listState</span><span class="p">.</span><span class="n">firstVisibleItemIndex</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">index</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">analytics</span><span class="p">.</span><span class="n">logScrollPosition</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¦ç‚¹ï¼š</p>

<ul>
<li>éå¸¸é€‚åˆ Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ã€‚</li>
<li>ä¸ä¼šè§¦å‘é‡ç»„ã€‚</li>
<li>å¯åœ¨ LaunchedEffect æˆ–åç¨‹ä¸­ä½¿ç”¨ã€‚</li>
</ul>


<p>ä½†æ˜¯ï¼š</p>

<ul>
<li>ä¸ä¼šå…¬å¼€çŠ¶æ€ä»¥è¿›è¡Œç›´æ¥ UI æ¸²æŸ“ã€‚</li>
<li>ä¸ä¼šæ›¿ä»£ CollectAsState æ¥å®ç° ViewModel â†’ UI æ›´æ–°ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ collectAsState</h2>

<ul>
<li>ä» ViewModel è®¢é˜… UI çš„ Flow æˆ– StateFlowã€‚</li>
<li>åœ¨ UI ä¸­æ˜¾ç¤ºæ•°æ®ï¼ˆæ–‡æœ¬ã€åŠ è½½çŠ¶æ€ã€è·å–çš„æ•°æ®ï¼‰ã€‚</li>
<li>ç”¨æˆ·éœ€è¦çœ‹åˆ°çš„ä½é¢‘æ›´æ–°ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>é«˜é¢‘æ›´æ–°ï¼ˆæ»šåŠ¨åç§»ã€ä¼ æ„Ÿå™¨æ•°æ®ï¼‰ã€‚</li>
<li>è§¦å‘ä¸éœ€è¦ UI æ›´æ–°çš„å‰¯ä½œç”¨ã€‚</li>
</ul>


<h2>ä½•æ—¶ä½¿ç”¨ snaphotFlow</h2>

<ul>
<li>å“åº” Compose çŠ¶æ€ï¼ˆæ»šåŠ¨ã€æ‰‹åŠ¿ã€åŠ¨ç”»ï¼‰ã€‚</li>
<li>è§¦å‘å‰¯ä½œç”¨ä½†ä¸ä¼šå¯¼è‡´é‡ç»„ã€‚</li>
<li>ä» Compose çŠ¶æ€æ„å»º Flow ç®¡é“ï¼ˆåˆ†æã€å»¶è¿ŸåŠ è½½è§¦å‘å™¨ï¼‰ã€‚</li>
</ul>


<p>é¿å…ä½¿ç”¨ï¼š</p>

<ul>
<li>ç›´æ¥ UI æ•°æ®æ¸²æŸ“ã€‚</li>
<li>ç”¨ viewModel â†’ UI æµæ›¿æ¢ collectAsStateã€‚</li>
</ul>


<h2>snapshotFlow çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šä½¿ç”¨ snaphotFlow.collectAsState è¿›è¡ŒåŠ¨ç”»è¿›åº¦</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">progress</span> <span class="k">by</span> <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">animationState</span><span class="p">.</span><span class="n">progress</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Progress: ${(progress * 100).toInt()}%&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½¿ç”¨ snaphotFlow å’Œ collectAsState æ¥é©±åŠ¨åŠ¨ç”»è¿›åº¦çš„ UI æ›´æ–°ä¼šå¯¼è‡´æ¯ä¸€å¸§éƒ½é‡æ–°åˆæˆï¼Œä»è€Œå¯¼è‡´å¡é¡¿ï¼Œè¿èƒŒäº† snaphotFlow çš„åˆè¡·ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ snaphotFlow åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­è¿›è¡Œåˆ†æ</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">snapshotFlow</span> <span class="p">{</span> <span class="n">animationState</span><span class="p">.</span><span class="n">progress</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span> <span class="p">{</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="p">(</span><span class="n">old</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span> <span class="p">==</span> <span class="p">(</span><span class="n">new</span> <span class="p">*</span> <span class="m">100</span><span class="p">).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">progress</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">analytics</span><span class="p">.</span><span class="n">logAnimationProgress</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šè·Ÿè¸ªåŠ¨ç”»è¿›åº¦ï¼Œä»¥ä¾¿è¿›è¡Œåˆ†ææˆ–è®°å½•ï¼Œè€Œä¸ä¼šè§¦å‘ UI é‡æ„ã€‚</p>

<h2>collectAsState çš„å®ç”¨ç¤ºä¾‹</h2>

<p>é”™è¯¯ä½“ä½ï¼šå°† collectAsState ç”¨äºé«˜é¢‘æ»šåŠ¨æ•°æ®</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">scrollOffset</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">scrollOffsetFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Offset: $scrollOffset&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¼šåœ¨æ»šåŠ¨çš„æ¯ä¸ªåƒç´ ä¸Šè§¦å‘é‡æ–°åˆæˆï¼Œå¯¼è‡´ CPU è¿‡è½½ã€‚</p>

<p>æ­£ç¡®å§¿å¼ï¼šä½¿ç”¨ collectAsState è·å–æœ‰æ„ä¹‰çš„ UI æ•°æ®</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">userName</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">userNameFlow</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'><span class="n">Text</span><span class="p">(</span><span class="s">&quot;Hello, $userName!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é€‚ç”¨äºæ˜¾ç¤ºç”¨æˆ·éœ€è¦æŸ¥çœ‹ä¸”ä¸ç»å¸¸æ›´æ”¹çš„æ•°æ®ã€‚</p>

<h2>ç»“è®º</h2>

<p>collectAsState å’Œ snapshotFlow ç›¸è¾…ç›¸æˆï¼š</p>

<ul>
<li>ä½¿ç”¨ collectAsState åœ¨ UI ä¸­æ˜¾ç¤º ViewModel æ•°æ®ã€‚</li>
<li>ä½¿ç”¨ snapshotFlow å“åº” Compose çŠ¶æ€å˜åŒ–çš„å‰¯ä½œç”¨ï¼Œè€Œæ— éœ€è§¦å‘é‡ç»„ã€‚</li>
</ul>


<p>æ­£ç¡®ä½¿ç”¨å®ƒä»¬å°†å¸®åŠ©ä½ é¿å…ä¸å¿…è¦çš„é‡ç»„ï¼Œæå‡åº”ç”¨çš„å“åº”é€Ÿåº¦ï¼Œå¹¶ä¿æŒ Compose ä»£ç ç®€æ´ã€å¯æ‰©å±•ä¸”å¯é¢„æµ‹ã€‚</p>

<p>å¦‚æœä½ è§‰å¾—æœ¬æ–‡åˆ†ææœ‰ç”¨ï¼Œè¯·éšæ—¶å…³æ³¨æˆ‘ä»¥è·å–æ›´å¤šè§è§£ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä¸ºä»€ä¹ˆä½ çš„Appæ€»æ˜¯å¿˜è®°æ‰€æœ‰äº‹æƒ…]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting/"/>
    <updated>2025-07-11T23:20:20+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒWhy Your App Keeps Forgetting Everythingã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/mobile-app-development-publication/why-your-app-keeps-forgetting-everything-aa9ad8dd8f6b">https://medium.com/mobile-app-development-publication/why-your-app-keeps-forgetting-everything-aa9ad8dd8f6b</a>ï¼Œç”±Android Dev Nexuså‘å¸ƒäº2025å¹´6æœˆ13æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/11/app-keep-forgetting/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OqqSvUytY9D0D4EIX_Cn0A.png" title="auto auto" ></a></p>

<!-- more -->


<p>ä¸çŸ¥ä½ æœ‰æ²¡æœ‰å‘ç°äº†ä¸€ä¸ªè®©è®¸å¤š Android å¼€å‘è€…å›°æƒ‘çš„å…³é”®é—®é¢˜ï¼šViewModel å’Œ savedInstanceState è§£å†³çš„æ˜¯ä¸åŒçš„é—®é¢˜ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸã€‚</p>

<p>è®©æˆ‘æ¥è§£é‡Šä¸€ä¸‹ä½ çš„æµ‹è¯•ä¸­ç©¶ç«Ÿå‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥åŠä¸ºä»€ä¹ˆè¿™ä¸¤ç§æœºåˆ¶éƒ½å­˜åœ¨ã€‚</p>

<h2>Android ä¸­çš„ä¸¤ç§â€œæ­»äº¡â€ç±»å‹</h2>

<p>Android åº”ç”¨å¯ä»¥é€šè¿‡ä¸¤ç§æˆªç„¶ä¸åŒçš„æ–¹å¼â€œæ­»äº¡â€ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1-DtrKgBiEVyWj0RgbaNoQ.png" alt="" /></p>

<h3>1. é…ç½®å˜æ›´ï¼ˆå±å¹•æ—‹è½¬ç­‰ï¼‰</h3>

<ul>
<li>Activity/Fragmentï¼šæ­»äº¡å¹¶é‡å»º</li>
<li>ViewModelï¼šå¹¸å­˜ï¼ğŸ‰</li>
<li>savedInstanceStateï¼šä¹Ÿå¹¸å­˜ï¼Œä½†æ­¤æ—¶ä½ å¹¶ä¸éœ€è¦å®ƒ</li>
</ul>


<h3>2. è¿›ç¨‹æ­»äº¡ï¼ˆåº”ç”¨æœ€å°åŒ–ã€å†…å­˜ä¸è¶³ç­‰ï¼‰</h3>

<ul>
<li>Activity/Fragmentï¼šæ­»äº¡</li>
<li>ViewModelï¼šä¹Ÿæ­»äº¡ï¼ğŸ’€</li>
<li>savedInstanceStateï¼šå¹¸å­˜å¹¶æˆä¸ºä½ çš„ç”Ÿå‘½çº¿</li>
</ul>


<h2>æµ‹è¯•ç»“æœä¸æ’’è°</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¿›ç¨‹æ­»äº¡æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ:</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// æœ€å°åŒ–åº”ç”¨ç¨‹åºä¹‹å‰:</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span> <span class="p">=</span> <span class="s">&quot;Important data&quot;</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">42</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// é‡æ–°æ‰“å¼€åº”ç”¨ç¨‹åºå:</span>
</span><span class='line'><span class="c1">// - æ–°çš„ ViewModel å®ä¾‹å·²åˆ›å»ºï¼ˆæ—§æ•°æ®å·²æ¶ˆå¤±ï¼‰</span>
</span><span class='line'><span class="c1">// - ä½†æ˜¯ onCreate() æ¥æ”¶äº†å·²ä¿å­˜æ•°æ®çš„ savedInstanceState åŒ…</span>
</span><span class='line'><span class="c1">// - ä½ éœ€è¦æ‰‹åŠ¨ä» savedInstanceState æ¢å¤ ViewModel</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ çŒœæµ‹çš„å®Œå…¨æ­£ç¡®ï¼šViewModel éœ€è¦é¢å¤–çš„æ­¥éª¤æ¥å­˜å‚¨/æ¢å¤æ•°æ®ï¼Œå³ä½¿è¿›ç¨‹ç»ˆæ­¢ã€‚</p>

<h2>å®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼šä¸¤è€…ç»“åˆ</h2>

<p>ä»¥ä¸‹æ˜¯ç°ä»£ Android å¼€å‘å¤„ç†è¿™ä¸ªåŒå±‚ç³»ç»Ÿçš„æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">MyViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span> <span class="p">=</span> <span class="n">ViewModelProvider</span><span class="p">(</span><span class="k">this</span><span class="p">)[</span><span class="n">MyViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// æ£€æŸ¥æˆ‘ä»¬æ˜¯å¦æ­£åœ¨ä»è¿›ç¨‹æ­»äº¡ä¸­æ¢å¤</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">savedInstanceState</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// ä» savedInstanceState æ¢å¤ ViewModel</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">userData</span> <span class="p">=</span> <span class="n">savedInstanceState</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">savedInstanceState</span><span class="p">.</span><span class="n">getInt</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
</span><span class='line'>            <span class="n">viewModel</span><span class="p">.</span><span class="n">restoreFromSavedState</span><span class="p">(</span><span class="n">userData</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// ä¿å­˜å…³é”®çš„ ViewModel æ•°æ®ä»¥é¿å…è¿›ç¨‹æ­»äº¡</span>
</span><span class='line'>        <span class="n">outState</span><span class="p">.</span><span class="n">putString</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">userData</span><span class="p">)</span>
</span><span class='line'>        <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">counter</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">isEmpty</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">userData</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">()</span> <span class="p">&amp;&amp;</span> <span class="n">counter</span> <span class="p">==</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">restoreFromSavedState</span><span class="p">(</span><span class="n">userData</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">counter</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userData</span> <span class="p">=</span> <span class="n">userData</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">counter</span> <span class="p">=</span> <span class="n">counter</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å½“æ¯ä¸ªæœºåˆ¶ç”Ÿæ•ˆæ—¶</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dmQnYfNrJik_bbpuNT7bzQ.png" alt="" /></p>

<p>è®©æˆ‘æ¥å‘ä½ å±•ç¤ºä¸€ä¸‹ä¸åŒåœºæ™¯ä¸‹çš„å…·ä½“æƒ…å†µï¼š</p>

<h3>åœºæ™¯ 1ï¼šå±å¹•æ—‹è½¬</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before rotation:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>- savedInstanceState: Gets saved but not really needed
</span><span class='line'>
</span><span class='line'>After rotation:
</span><span class='line'>- ViewModel: Same instance, data intact âœ…
</span><span class='line'>- savedInstanceState: Available but redundant
</span><span class='line'>- Result: ViewModel data is immediately available
</span></code></pre></td></tr></table></div></figure>


<h3>åœºæ™¯2ï¼šåº”ç”¨ç¨‹åºæœ€å°åŒ–â†’é‡æ–°æ‰“å¼€ï¼ˆè¿›ç¨‹æ­»äº¡ï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before minimizing:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>- onSaveInstanceState<span class="o">()</span>: Saves critical data to Bundle
</span><span class='line'>After reopening:
</span><span class='line'>- ViewModel: NEW instance, no data âŒ
</span><span class='line'>- savedInstanceState: Contains saved data âœ…
</span><span class='line'>- Result: Must restore ViewModel from savedInstanceState
</span></code></pre></td></tr></table></div></figure>


<h3>åœºæ™¯ 3ï¼šåº”ç”¨ç¨‹åºæœ€å°åŒ– â†’ é‡æ–°æ‰“å¼€ï¼ˆè¿›ç¨‹å­˜æ´»ï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Bash'><span class='line'>Before minimizing:
</span><span class='line'>- ViewModel: Alive with data âœ…
</span><span class='line'>After reopening:
</span><span class='line'>- ViewModel: Same instance, data intact âœ…
</span><span class='line'>- savedInstanceState: null <span class="o">(</span>no recreation happened<span class="o">)</span>
</span><span class='line'>- Result: ViewModel data is immediately available
</span></code></pre></td></tr></table></div></figure>


<h2>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆå­˜åœ¨è¿™ä¸ªåŒå±‚ç³»ç»Ÿï¼Ÿ</h2>

<p>ViewModel å¤„ç†å¸¸è§æƒ…å†µï¼š</p>

<ul>
<li>å¤æ‚çš„ UI çŠ¶æ€ï¼Œä½ ä¸å¸Œæœ›åœ¨é¢‘ç¹æ—‹è½¬å±å¹•æ—¶ä¸¢å¤±ã€‚</li>
<li>ä»»ä½•éœ€è¦è€—è´¹å¤§é‡èµ„æºé‡æ–°åˆ›å»ºçš„å†…å®¹ã€‚</li>
</ul>


<p>savedInstanceState å¤„ç†ç‰¹æ®Šæƒ…å†µï¼š</p>

<ul>
<li>è¿›ç¨‹æ­»äº¡éš¾ä»¥é¢„æµ‹ã€‚ä½†å½“å®ƒå‘ç”Ÿæ—¶ï¼Œç”¨æˆ·å¸Œæœ›å…¶çŠ¶æ€èƒ½å¤ŸæŒä¹…ä¿å­˜ã€‚</li>
<li>å°è€Œå…³é”®çš„æ•°æ®ç‰‡æ®µï¼ˆä¾‹å¦‚ç”¨æˆ·è¾“å…¥ã€æ»šåŠ¨ä½ç½®ï¼‰ã€‚</li>
<li>ç®€å•çš„ UI çŠ¶æ€ï¼Œå¯¹ç”¨æˆ·ä½“éªŒè‡³å…³é‡è¦ã€‚</li>
</ul>


<h2>Bundle å¤§å°çš„ç°å®æ£€éªŒ</h2>

<p>ä»¥ä¸‹æ˜¯ä¸€äº›å¯ä»¥å¸®ä½ å…å»è°ƒè¯•éº»çƒ¦çš„äº‹æƒ…ï¼šBundle å¹¶éæ— é™å¤§çš„å­˜å‚¨ç©ºé—´ã€‚ä½ å¤§çº¦æœ‰ 1MB çš„ç©ºé—´å¯ç”¨ï¼Œè¶…è¿‡è¿™ä¸ªé™åˆ¶ä¼šå¯¼è‡´
å´©æºƒï¼Œè®©ä½ è´¨ç–‘è‡ªå·±çš„äººç”Ÿé€‰æ‹©ã€‚</p>

<p>ä¿æŒ onSavedInstanceState æ•°æ®ç²¾ç®€ã€‚ä¿å­˜ç”¨æˆ·å†™åˆ°ä¸€åŠçš„ç”µå­é‚®ä»¶è‰ç¨¿ï¼Œè€Œä¸æ˜¯æ•´ä¸ªè”ç³»äººåˆ—è¡¨ã€‚</p>

<h2>ç°ä»£æ–¹æ³•ï¼šSavedStateHandle</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ThuE7YpnrtfFQe2fwDlbDg.png" alt="" /></p>

<p>Google æ„è¯†åˆ°è¿™ç§æ‰‹åŠ¨æ“ä½œéå¸¸ç¹çï¼Œå› æ­¤ä»–ä»¬åˆ›å»ºäº† SavedStateHandle ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">savedStateHandle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è¿™å°†è‡ªåŠ¨ä¿ç•™é…ç½®æ›´æ”¹å’Œè¿›ç¨‹ç»ˆæ­¢ï¼</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">userData</span><span class="p">:</span> <span class="n">String</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;(</span><span class="s">&quot;user_data&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span>
</span><span class='line'>        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s">&quot;user_data&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">counter</span><span class="p">:</span> <span class="n">Int</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;(</span><span class="s">&quot;counter&quot;</span><span class="p">)</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>        <span class="k">set</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">.</span><span class="k">set</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// æ— éœ€æ‰‹åŠ¨æ¢å¤ï¼</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¯¹äºä»¥ä¸‹æƒ…å†µï¼Œä¸ºä»€ä¹ˆä»ç„¶éœ€è¦æ‰‹åŠ¨ onSaveInstanceStateï¼Ÿ</h2>

<h3>1. ä¸å±äº ViewModel çš„ UI ç‰¹å®šçŠ¶æ€</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// è¿™äº›ä¸å±äºä½ çš„ä¸šåŠ¡é€»è¾‘å±‚</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;scroll_position&quot;</span><span class="p">,</span> <span class="n">recyclerView</span><span class="p">.</span><span class="n">computeVerticalScrollOffset</span><span class="p">())</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putBoolean</span><span class="p">(</span><span class="s">&quot;is_toolbar_expanded&quot;</span><span class="p">,</span> <span class="n">collapsingToolbar</span><span class="p">.</span><span class="n">isExpanded</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putParcelable</span><span class="p">(</span><span class="s">&quot;dialog_state&quot;</span><span class="p">,</span> <span class="n">currentDialog</span><span class="o">?.</span><span class="n">onSaveInstanceState</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. Fragment å‚æ•°å’Œ Activity Extras</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¿™äº›éœ€è¦åœ¨è¿›ç¨‹ç»ˆæ­¢åç»§ç»­å­˜åœ¨ï¼Œä½†ä¸æ˜¯ ViewModel çŠ¶æ€</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DetailFragment</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">newInstance</span><span class="p">(</span><span class="n">itemId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">DetailFragment</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">arguments</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>  <span class="c1">// è¿™åœ¨å†…éƒ¨ä½¿ç”¨ savedInstanceState</span>
</span><span class='line'>                <span class="n">putString</span><span class="p">(</span><span class="s">&quot;item_id&quot;</span><span class="p">,</span> <span class="n">itemId</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. è§†å›¾çŠ¶æ€è¿‡äºç‰¹å®šäº UI</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è¯¸å¦‚ EditText å…‰æ ‡ä½ç½®ã€ç„¦ç‚¹çŠ¶æ€ç­‰ã€‚</span>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;edit_text_selection_start&quot;</span><span class="p">,</span> <span class="n">editText</span><span class="p">.</span><span class="n">selectionStart</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putInt</span><span class="p">(</span><span class="s">&quot;edit_text_selection_end&quot;</span><span class="p">,</span> <span class="n">editText</span><span class="p">.</span><span class="n">selectionEnd</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æŠŠæ‰‹å¼„è„ï¼ˆåŠ¨æ‰‹è¯•ä¸€è¯•ï¼‰</h2>

<p>ä½ å¯ä»¥å¼ºåˆ¶ç»ˆæ­¢è¿›ç¨‹è¿›è¡Œæµ‹è¯•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Kill your app process </span>
</span><span class='line'>adb shell am <span class="nb">kill </span>com.yourpackage.name
</span><span class='line'><span class="c"># Or use &quot;Don&#39;t keep activities&quot; in Developer Options</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°†å¸®åŠ©ä½ éªŒè¯çŠ¶æ€æ¢å¤æ˜¯å¦æ­£ç¡®è¿›è¡Œã€‚</p>

<h2>å…³é”®æ´å¯Ÿ</h2>

<p>ViewModel éå¸¸é€‚åˆé…ç½®æ›´æ”¹ï¼Œä½†éœ€è¦å¸®åŠ©åº”å¯¹è¿›ç¨‹æ­»äº¡ã€‚</p>

<p>ç°ä»£æ–¹æ³•æ˜¯åœ¨ ViewModel ä¸­ä½¿ç”¨ SavedStateHandleï¼Œå®ƒå¯ä»¥è‡ªåŠ¨å¤„ç†è¿™ä¸¤ç§æƒ…å†µã€‚å¦‚æœä½ å°šæœªä½¿ç”¨å®ƒï¼Œåˆ™éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ savedInstanceState â†’ ViewModel çš„æ¢å¤è¿‡ç¨‹ã€‚</p>

<p>è¿™ä¸ªåŒå±‚ç³»ç»Ÿçœ‹ä¼¼å¤æ‚ï¼Œä½†å®é™…ä¸Šéå¸¸ä¼˜é›…ï¼šå¸¸è§æƒ…å†µï¼ˆé…ç½®æ›´æ”¹ï¼‰çš„å¿«é€Ÿæ¢å¤ï¼Œä»¥åŠç½•è§æƒ…å†µï¼ˆè¿›ç¨‹æ­»äº¡ï¼‰çš„å¯é æ¢å¤ã€‚</p>

<p>ç¥ä½ ç¼–ç æ„‰å¿«ï¼Œæ„¿ä½ çš„çŠ¶æ€å§‹ç»ˆæŒä¹…ï¼ğŸš€</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç”¨ä¼˜é›…çš„å§¿å¼åº”å¯¹Kotlin Flowçš„å›å‹]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress/"/>
    <updated>2025-07-03T22:09:26+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒHow to Manage Backpressure in Kotlin Flow: collect â€¢ buffer â€¢ conflate â€¢ collectLatestã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/how-to-manage-backpressure-in-kotlin-flow-collect-buffer-conflate-collectlatest-b8102284d968">https://proandroiddev.com/how-to-manage-backpressure-in-kotlin-flow-collect-buffer-conflate-collectlatest-b8102284d968</a>ï¼Œç”±Shbazhenovå‘å¸ƒäº2025å¹´6æœˆ13æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/03/handling-flow-backpress/"><img src="https://blog.mindorks.com/images/kotlin-flow-banner-image.png" title="auto auto" ></a></p>

<!-- more -->


<p>ä½ æ˜¯å¦æ›¾é‡åˆ°è¿‡å¿«é€Ÿæ•°æ®æºå‘é€çš„æ•°æ®é‡è¶…å‡ºåº”ç”¨å¤„ç†èƒ½åŠ›çš„æƒ…å†µï¼Œå¯¼è‡´åº”ç”¨é€Ÿåº¦å˜æ…¢ç”šè‡³å´©æºƒï¼ŸKotlin Flow å†…ç½®äº†ä¸€äº›æ–¹æ³•ï¼Œå¯è®©ä½ çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¿æŒåŒæ­¥ã€‚æœ¬æ–‡å°†ä»‹ç»ï¼š</p>

<ol>
<li>å›å‹çš„å«ä¹‰</li>
<li>Flow é»˜è®¤çš„â€œäº’ç›¸ç­‰å¾…â€æ¨¡å¼å¦‚ä½•å·¥ä½œ</li>
<li>ä½•æ—¶ä½¿ç”¨ buffer() æ·»åŠ å°å‹é˜Ÿåˆ—</li>
<li>conflate() å¦‚ä½•è·³è¿‡æ—§æ•°æ®é¡¹</li>
<li>ä¸ºä»€ä¹ˆ collectLatest { } ä¼šåœæ­¢æ—§æ•°æ®å¤„ç†</li>
<li>å¦‚ä½•æ ¹æ®ä½ çš„æƒ…å†µé€‰æ‹©åˆé€‚çš„é€‰é¡¹</li>
</ol>


<h2>å›å‹çš„å«ä¹‰</h2>

<p>å›å‹çš„ä½œç”¨æ˜¯ç¡®ä¿å¿«é€Ÿçš„æ•°æ®å‘é€æ–¹ä¸ä¼šå‹å®è¾ƒæ…¢çš„æ¥æ”¶æ–¹ã€‚å¦‚æœæ²¡æœ‰å›å‹ï¼Œä½ å¯èƒ½ä¼šåœ¨å†…å­˜ä¸­å­˜å‚¨è¿‡å¤šçš„æ•°æ®ï¼Œæˆ–è€…æµªè´¹æ—¶é—´å¤„ç†è¿‡æ—¶çš„ä¿¡æ¯ã€‚</p>

<p>å›å‹å¯ä»¥å¸®åŠ©ä½ ï¼š</p>

<ul>
<li>æ§åˆ¶å†…å­˜ä½¿ç”¨é‡</li>
<li>é¿å…ä¸å¿…è¦çš„å·¥ä½œ</li>
<li>ä½¿åº”ç”¨æ€§èƒ½æ›´å¯é¢„æµ‹</li>
</ul>


<h2>1. é»˜è®¤â€œäº’ç›¸ç­‰å¾…â€æ¨¡å¼</h2>

<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä½ æ‰§è¡Œä»¥ä¸‹æ“ä½œæ—¶ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">repeat</span><span class="p">(</span><span class="m">3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">emit</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Sent $it&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>            <span class="c1">// å¿«é€Ÿçš„å‘é€è€…</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>  <span class="n">println</span><span class="p">(</span><span class="s">&quot;Handling $value&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>             <span class="c1">// æ…¢é€Ÿçš„å¤„ç†è€…</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‘é€æ–¹ ( emit ) å°†æš‚åœï¼Œç›´åˆ°å¤„ç†æ–¹ ( collect ) å¤„ç†å®Œæœ€åä¸€ä¸ªå€¼ã€‚æ²¡æœ‰é˜Ÿåˆ—ï¼Œæ¯ä¸ªå€¼éƒ½æ˜¯ä¸€æ¬¡å‘é€å’Œå¤„ç†ä¸€ä¸ªã€‚</p>

<h2>2. ä½¿ç”¨ buffer() æ·»åŠ ä¸€ä¸ªå°é˜Ÿåˆ—</h2>

<p>å¦‚æœä½ å¸Œæœ›å‘é€æ–¹æå‰ä¸€ç‚¹ï¼Œè¯·ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">buffer</span><span class="p">(</span><span class="n">capacity</span> <span class="p">=</span> <span class="m">2</span><span class="p">)</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="c1">// slow work here</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>ç°åœ¨ï¼Œå‘é€è€…æœ€å¤šå¯ä»¥å°† 2 ä¸ªé¡¹ç›®æ”¾å…¥ä¸€ä¸ªå°é˜Ÿåˆ—ä¸­ã€‚</li>
<li>ä¸€æ—¦é˜Ÿåˆ—æ»¡äº†ï¼Œå®ƒå°±ä¼šå†æ¬¡æš‚åœã€‚</li>
</ul>


<p>è¿™ç»™äº†ä½ ä¸€ä¸ªæœ‰é™çš„é˜Ÿåˆ—ï¼šä½ ä»ç„¶å¯ä»¥å¤„ç†æ¯ä¸ªé¡¹ç›®ï¼Œä½†å¯ä»¥å¹³æ»‘é€Ÿåº¦å³°å€¼ã€‚</p>

<h2>3. ä½¿ç”¨ conflate() è·³è¿‡æ—§é¡¹ç›®</h2>

<p>å½“ä½ åªå…³å¿ƒæœ€æ–°æ•°æ®ï¼ˆä¾‹å¦‚æ›´æ–°è¿›åº¦æ¡ï¼‰æ—¶ï¼Œä½ å¯ä»¥è¿™æ ·å†™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">conflate</span><span class="p">()</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Update to $value&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>å¦‚æœå¤„ç†ç¨‹åºç¹å¿™ï¼Œåˆ™ä»…ä¿ç•™æœ€æ–°æœªå¤„ç†çš„é¡¹ç›®ã€‚</li>
<li>è¾ƒæ—§çš„é¡¹ç›®å°†è¢«ä¸¢å¼ƒï¼Œå› æ­¤ä½ æ— éœ€å¤„ç†è¿‡æ—¶çš„æ›´æ–°ã€‚</li>
</ul>


<p>æ³¨æ„ï¼šconflate() ä¸ä¼šåœæ­¢å½“å‰å·¥ä½œï¼›å®ƒåªæ˜¯åœ¨ä¸‹æ¬¡è¯»å–æ—¶è·³è¿‡æ—§å€¼ã€‚</p>

<h2>4. ä½¿ç”¨ collectLatest { } åœæ­¢æ—§å·¥ä½œ</h2>

<p>è¦è¿›ä¸€æ­¥æ“ä½œå¹¶åœ¨æ–°æ•°æ®è¿›å…¥æ—¶å–æ¶ˆä»»ä½•æ­£åœ¨è¿›è¡Œçš„å·¥ä½œï¼Œè¯·ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">flow</span> <span class="p">{</span> <span class="err">â€¦</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">.</span><span class="n">collectLatest</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Start $value&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">300</span><span class="p">)</span>    <span class="c1">// å¯èƒ½ä¼šè¢«åˆ‡æ–­</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Done $value&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>æ¯æ¬¡å‘å‡ºï¼ˆemitï¼‰æ–°çš„æ•°æ®æ—¶ï¼Œå¤„ç†å‰ä¸€ä¸ªå€¼çš„å—éƒ½ä¼šç«‹å³è¢«ä¸¢å¼ƒã€‚</li>
<li>åªæœ‰å½“å‘é€æ–¹çš„å‘é€é€Ÿåº¦æŒç»­è¶…å‡ºä½ çš„å¤„ç†èƒ½åŠ›æ—¶ï¼Œä½ æ‰éœ€è¦å®Œæˆæœ€åä¸€ä¸ªå€¼çš„å·¥ä½œã€‚</li>
</ul>


<p>è¿™éå¸¸é€‚åˆè¾¹è¾“å…¥è¾¹æœç´¢çš„æƒ…å†µï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¸Œæœ›åœ¨ç”¨æˆ·å†æ¬¡è¾“å…¥æ—¶ç«‹å³ä¸¢å¼ƒæ—§è¯·æ±‚ã€‚</p>

<h2>5. é€‰æ‹©åˆé€‚çš„å·¥å…·</h2>

<h3>æ™®é€š collect</h3>

<ul>
<li>åŠŸèƒ½ï¼šå‘é€æ–¹å’Œå¤„ç†æ–¹äº’ç›¸ç­‰å¾…ï¼Œä¸€ä¸ªæ¥ä¸€ä¸ª</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ å¿…é¡»æŒ‰é¡ºåºå¤„ç†æ¯ä¸ªé¡¹ç›®

<h3>.buffer(n)</h3></li>
<li>åŠŸèƒ½ï¼šå¤§å°ä¸º n çš„å°é˜Ÿåˆ—ï¼›ä¸ä¸¢å¼ƒä»»ä½•é¡¹ç›®</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ éœ€è¦å°‘é‡ç¼“å†²ï¼Œä½†ä»è¦å¤„ç†æ‰€æœ‰é¡¹ç›®

<h3>.conflate()</h3></li>
<li>åŠŸèƒ½ï¼šå¦‚æœå¤„ç†æ–¹ç¹å¿™ï¼Œåˆ™ä»…ä¿ç•™æœ€æ–°é¡¹ç›®</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šä½ éœ€è¦æœ€æ–°æ•°æ®ï¼Œä½†ä»è¦å®Œæˆå½“å‰å·¥ä½œ

<h3>collectLatest { }</h3></li>
<li>åŠŸèƒ½ï¼šæ–°æ•°æ®åˆ°è¾¾åç«‹å³å–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„å·¥ä½œ</li>
<li>ä½•æ—¶é€‰æ‹©å®ƒï¼šåªè€ƒè™‘æœ€æ–°çš„ç»“æœï¼›ç«‹å³æ”¾ä¸‹å…¶ä»–ä¸€åˆ‡

<h2>6. æ€»ç»“</h2></li>
<li>å›å‹æœºåˆ¶å¯é˜²æ­¢å¿«é€Ÿæ•°æ®æµè¿‡è½½æ…¢é€Ÿå¤„ç†å™¨ã€‚</li>
<li>é»˜è®¤æ¨¡å¼æ²¡æœ‰é˜Ÿåˆ—ï¼šå®‰å…¨ä½†é€Ÿåº¦å¯èƒ½è¾ƒæ…¢ã€‚</li>
<li>buffer() å‡½æ•°æ·»åŠ äº†ä¸€ä¸ªå°é˜Ÿåˆ—ï¼šæ›´çµæ´»ï¼Œä¸ä¼šä¸¢åŒ…ã€‚</li>
<li>conflate() å‡½æ•°è·³è¿‡æ—§å€¼ï¼šå§‹ç»ˆä¿æŒæœ€æ–°ï¼Œä½†è®©å½“å‰å·¥ä½œå®Œæˆã€‚</li>
<li>collectLatest { } å‡½æ•°åœæ­¢æ—§å·¥ä½œï¼šä»…å®Œæˆæœ€æ–°é¡¹ã€‚</li>
</ul>


<p>ä¸‹æ¬¡ä½ çš„ Flow æ„Ÿè§‰å¤ªå¿«æˆ–å¤ªæ…¢æ—¶ï¼Œè¯·é—®è‡ªå·±ï¼š</p>

<ol>
<li>æˆ‘éœ€è¦å¤„ç†æ¯ä¸ªå€¼å—ï¼Ÿ</li>
<li>å°å‹é˜Ÿåˆ—æœ‰å¸®åŠ©å—ï¼Ÿ</li>
<li>åªæœ‰æœ€æ–°æ•°æ®æ‰é‡è¦å—ï¼Ÿ</li>
<li>å½“æ–°æ•°æ®åˆ°è¾¾æ—¶ï¼Œæˆ‘åº”è¯¥å–æ¶ˆæ—§å·¥ä½œå—ï¼Ÿ</li>
</ol>


<p>é€‰æ‹©æœ€åˆé€‚çš„ç®€å•é€‰é¡¹ï¼ŒKotlin Flow ä¼šå¤„ç†ä½™ä¸‹çš„äº‹æƒ…ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Kotlin ViewModelä¸­æ­£ç¡®å¤„ç†ç›¸åŒçš„UIç»„ä»¶äº¤äº’]]></title>
    <link href="https://alexhilton.github.io/blog/2025/07/01/handling-ui-action/"/>
    <updated>2025-07-01T22:34:20+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/07/01/handling-ui-action</id>
    <content type="html"><![CDATA[<p>æœ¬æ–‡è¯‘è‡ªã€ŒHandling UI Actions the Right Way in Kotlin ViewModelsã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/handling-ui-actions-the-right-way-in-kotlin-viewmodels-119a06bb43ef">https://proandroiddev.com/handling-ui-actions-the-right-way-in-kotlin-viewmodels-119a06bb43ef</a>ï¼Œç”±Vaibhav Jaiswalå‘å¸ƒäº2025å¹´4æœˆ16æ—¥ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/07/01/handling-ui-action/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MLROq8NAKOSnutBMj3WivQ.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç¼˜èµ·</h2>

<p>ä½œä¸ºAndroidå¼€å‘è€…ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°éœ€è¦åœ¨å¤šä¸ªViewModelä¸­å®ç°ç›¸åŒæˆ–è€…éå¸¸ç±»ä¼¼UIåŠŸèƒ½çš„æƒ…å†µã€‚</p>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰å¤šä¸ªé¡µé¢ï¼Œå®ƒä»¬å…·æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä¾‹å¦‚æ˜¾ç¤ºå¸–å­ã€æ’°å†™è¯„è®ºæˆ–å¤„ç†ç”¨æˆ·äº¤äº’ã€‚</p>

<p>åœ¨æ¯ä¸ªViewModelä¸­åˆ†åˆ«å¤„ç†è¿™äº›UIäº¤äº’å¾ˆå¿«å°±ä¼šå˜å¾—æ··ä¹±ï¼Œå¯¼è‡´å¤§é‡çš„ä»£ç é‡å¤ã€‚éšç€åº”ç”¨è§„æ¨¡çš„æ‰©å¤§å’Œé¡µé¢æ•°é‡çš„å¢åŠ ï¼Œè¿™ä¸ªé—®é¢˜ä¼šå˜å¾—æ›´åŠ æ£˜æ‰‹ï¼Œå¯¼è‡´ä»£ç åº“éš¾ä»¥ç»´æŠ¤ï¼Œå¹¶å¸¦æ¥å¯æ‰©å±•æ€§é—®é¢˜ã€‚</p>

<p>å¯¹äºè¿™ç§ä»£ç é‡å¤é—®é¢˜ï¼Œæˆ‘ä»¬Androidå¼€å‘è€…å¸¸ç”¨çš„å‡ ç§å¸¸è§è§£å†³æ–¹æ¡ˆåŒ…æ‹¬ï¼š</p>

<ul>
<li>é¢å¤–çš„è¾…åŠ©ç±»æ–¹æ³•</li>
<li>â€œç»§æ‰¿â€æˆ–â€œä½¿ç”¨å§”æ‰˜çš„ç»„åˆâ€æ–¹æ³•</li>
</ul>


<p>åœ¨ä»¥ä¸‹ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†æ¢è®¨è¿™äº›è§£å†³æ–¹æ¡ˆï¼Œäº†è§£æ¯ç§æ–¹æ³•å¦‚ä½•è§£å†³ä»£ç é‡å¤é—®é¢˜ï¼Œå¹¶é‡ç‚¹ä»‹ç»æ¯ç§æ–¹æ³•çš„å±€é™æ€§ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒåŸºäºè¿™äº›æƒ³æ³•ï¼Œå¹¶è§£å†³äº†å®ƒä»¬çš„å±€é™æ€§ï¼Œä»è€Œå®ç°äº†æ›´é«˜æ•ˆçš„UIäº¤äº’ç®¡ç†ã€‚</p>

<blockquote><p>è¿™ä¸ªè§£å†³æ–¹æ¡ˆæˆ‘å·²ç»åœ¨<a href="https://medial.app/"> Medial çš„åº”ç”¨</a>ï¼ˆé“¾æ¥ <a href="https://medial.app/%EF%BC%89%E4%BB%A3%E7%A0%81%E5%BA%93%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E4%BA%86%E2%80%94%E2%80%94%E5%B0%86">https://medial.app/%EF%BC%89%E4%BB%A3%E7%A0%81%E5%BA%93%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%BF%87%E4%BA%86%E2%80%94%E2%80%94%E5%B0%86</a> UIäº¤äº’å¤„ç†ä»£ç å˜æˆäº†è¿‘ä¹å³æ’å³ç”¨çš„ä½“éªŒã€‚</p></blockquote>

<p>æˆ‘çš„è§£å†³æ–¹æ¡ˆæ ¹æœ¬ä¸å»ºè®®ä½¿ç”¨ BaseViewModelï¼Œä¹Ÿä¸åŸºäº BaseViewModelã€‚BaseViewModel åªæ˜¯ä¸€ä¸ªä¾‹å­ï¼Œç”¨æ¥è¯´æ˜æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»ä»»ä½•å…¶ä»–ç±»/æ¥å£ç»§æ‰¿çš„åŠŸèƒ½ï¼Œè¿™äº›ç±»/æ¥å£å¯ä»¥æ˜¯ BaseViewModelã€ViewModelã€Decompose çš„ ComponentContext æˆ–å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚</p>

<h2>âš¡ï¸ TL;DR: å¤„ç†ViewModelä¸­çš„å…±äº«UIäº¤äº’</h2>

<p>å½“åœ¨å¤šä¸ªé¡µé¢ä¸Šæ˜¾ç¤ºç›¸åŒçš„UIç»„ä»¶æ—¶ï¼Œåœ¨æ¯ä¸ªViewModelä¸­å¤„ç†å®ƒä»¬çš„äº¤äº’ä¼šå¯¼è‡´é‡å¤å’Œé€»è¾‘æ··ä¹±ã€‚æˆ‘ä»¬æ¢ç´¢äº†ä¸‰ç§æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>è¾…åŠ©ç±»æ–¹æ³•</li>
<li>â– ç®€å•ï¼Œä½†æ— æ³•è¦†å†™ä»»ä½•è¡Œä¸º</li>
<li>â– å¹¶éViewModelçš„ç›´æ¥åŠŸèƒ½</li>
<li>é€šè¿‡ Kotlin å§”æ‰˜è¿›è¡Œç»„åˆ</li>
<li>âœ… æ›´å¥½çš„è®¾è®¡ï¼Œæ”¯æŒè¦†å†™è¡Œä¸ºã€‚</li>
<li>â– æ— æ³•è®¿é—®viewModelScopeæˆ–å…¶ä»–ViewModelåŠŸèƒ½ã€‚</li>
<li>â– æ— æ³•ä»ä»»ä½•å…¶ä»–ç»§æ‰¿ç±»è®¿é—®ä»»ä½•å†…å®¹ã€‚</li>
<li>ğŸ’¡ æˆ‘çš„è§£å†³æ–¹æ¡ˆ â€” ä½¿ç”¨å¸¦æœ‰é»˜è®¤å‡½æ•°çš„æ¥å£</li>
<li>âœ… ç®€æ´ã€å¯å¤ç”¨ï¼Œæ”¯æŒè¦†å†™ï¼ˆOverrideï¼‰è¡Œä¸ºã€‚</li>
<li>âœ… å®Œå…¨è®¿é—®ViewModelåŠŸèƒ½æˆ–ä»»ä½•å…¶ä»–ç»§æ‰¿ç±»çš„åŠŸèƒ½ã€‚</li>
<li>âœ… åªéœ€ä»æ¥å£å®ç°å³å¯è½»æ¾æ’å…¥ä»»ä½• ViewModel</li>
</ol>


<p>æœ¬åšå®¢ä¸­çš„æ‰€æœ‰è§£å†³æ–¹æ¡ˆå‡åœ¨<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample">æ­¤ç¤ºä¾‹é¡¹ç›®</a>ï¼ˆé“¾æ¥ <a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E5%AE%9E%E7%8E%B0%EF%BC%9A">https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E5%AE%9E%E7%8E%B0%EF%BC%9A</a></p>

<h2>ğŸ—ï¸ è®¾ç½®</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåç½®UI å…ƒç´ ï¼Œå®ƒæœ‰ä¸€äº›UI äº¤äº’ï¼Œå¹¶åƒ MVI å»ºè®®çš„é‚£æ ·ï¼Œåœ¨ä¸€ä¸ªå¯†å°çš„ç•Œé¢ä¸­å‘ˆç°ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PostAction</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ShareClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ª BaseViewModel ç±»ï¼Œç”¨äºä¿å­˜æ¯ä¸ªViewModelæ‰€éœ€çš„é€šç”¨åŠŸèƒ½</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">showShackBar</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showBottomSheet</span> <span class="k">by</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">navigate</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">// å®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">showSnackbar</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">showSnackBar</span> <span class="p">=</span> <span class="n">message</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>é¢å¤–çš„è¾…åŠ©ç±»æ–¹æ³•</h3>

<p>åœ¨è¿™ç§æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„è¾…åŠ©ç±»æ¥å°è£…UIäº¤äº’çš„å¤„ç†ã€‚æˆ‘ä»¬å°†è¿™ä¸ªç±»ä½œä¸ºViewModelçš„ä¸€ä¸ªå±æ€§ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªè¾…åŠ©ç±» PostActionHandler æ¥å¤„ç†äº¤äº’ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostActionHandler</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">()</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackBar</span><span class="p">(</span><span class="s">&quot;Liked&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="p">{</span> <span class="cm">/* å®ç° */</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œåœ¨ PostScreenViewModel ä¸­æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª PostActionHandler å®ä¾‹</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostScreenViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">actionHandler</span> <span class="p">=</span> <span class="n">PostActionHandler</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostScreenViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">actionHandler</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span><span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è™½ç„¶è¿™ç§æ–¹æ³•ç¡®å®è§£å†³äº†è·¨å¤šä¸ªViewModelé‡å¤ä»£ç çš„é—®é¢˜ï¼Œä½†å®ƒä¹Ÿå­˜åœ¨ä¸€äº›ä¸»è¦ç¼ºç‚¹ï¼Œè¿™äº›ç¼ºç‚¹åŒ…æ‹¬ï¼š</p>

<ul>
<li>ğŸš« è‡ªå®šä¹‰åŠŸèƒ½æœ‰é™ï¼šç”±äº PostActionHandler æ˜¯ä¸€ä¸ªå°è£…ç±»ï¼Œæˆ‘ä»¬æ— æ³•è¦†å†™ä»»ä½•è¡Œä¸ºã€‚</li>
<li>ğŸš« é€šè¿‡å±æ€§è®¿é—®ï¼šæˆ‘ä»¬ä¸æ˜¯å°†åŠŸèƒ½æ·»åŠ åˆ°ViewModelæœ¬èº«ï¼Œè€Œæ˜¯å°†å…¶ä½œä¸ºViewModelçš„ä¸€ä¸ªå±æ€§æ·»åŠ ã€‚</li>
</ul>


<p><strong>æ— æ³•è¦†å†™ï¼ˆOverrideï¼‰è¡Œä¸ºæ˜¯è¿™ç§æ–¹æ³•ä¸å»ºè®®ç”¨äºUIäº¤äº’å¤„ç†çš„ä¸»è¦åŸå› ã€‚</strong></p>

<h2>ğŸ§¬ ä½¿ç”¨ Kotlin å§”æ‰˜è¿›è¡Œç»„åˆï¼ˆä¼˜é›…ä½†å—é™çš„è§£å†³æ–¹æ¡ˆï¼‰</h2>

<p>è¿™æ˜¯äº’è”ç½‘ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜çš„æ ‡å‡†æ–¹æ³•ï¼Œä¹Ÿæ˜¯æœ€å—æ¨èçš„æ–¹æ³•ã€‚è¯¥è§£å†³æ–¹æ¡ˆåŸºäºç»§æ‰¿ï¼Œä½†ä¸æ˜¯ç»§æ‰¿è‡ªæŸä¸ªç±»ï¼Œè¿™æ ·å°±æ— æ³•å†æ‰©å±•ä»»ä½•ç±»ã€‚æˆ‘ä»¬åˆ©ç”¨ Kotlin å§”æ‰˜å°†å®ç°å§”æ‰˜ç»™å¦ä¸€ä¸ªç±»ï¼Œè¿™æ ·å°±æ— éœ€æ‰©å±•æŸä¸ªç±»ï¼Œä¹Ÿæ— éœ€å†ç»ˆæ­¢ç»§æ‰¿ã€‚</p>

<p>ä»¥ä¸‹æ˜¯æˆ‘ä»¬å®ç°è¯¥è§£å†³æ–¹æ¡ˆçš„æ–¹æ³•</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">PostActionHandlerImpl</span> <span class="p">:</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="n">handleShareClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å°±æ˜¯æˆ‘ä»¬çš„ä½¿ç”¨æ–¹æ³•</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span> <span class="k">by</span> <span class="n">PostActionHandlerImpl</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span><span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•è§£å†³äº†é¢å¤–è¾…åŠ©ç±»æ–¹æ³•ä¸­å­˜åœ¨çš„æ‰€æœ‰é—®é¢˜ã€‚</p>

<ul>
<li>âœ… è¦†å†™è¡Œä¸ºï¼šé€šè¿‡ä½¿ç”¨æ¥å£å’Œå§”æ‰˜ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°è¦†å†™ä»»ä½•è¡Œä¸ºã€‚</li>
<li>âœ… æ›´ç®€æ´çš„è®¾è®¡ï¼šåŠŸèƒ½ç›´æ¥æˆä¸ºViewModelçš„ä¸€éƒ¨åˆ†ï¼Œå…è®¸æˆ‘ä»¬åƒè°ƒç”¨åŸç”ŸViewModelæ–¹æ³•ä¸€æ ·è°ƒç”¨è¿™äº›å‡½æ•°ã€‚</li>
</ul>


<p>ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªä¸»è¦ç¼ºç‚¹ï¼Œä½¿å…¶åœ¨å¤„ç†UIäº¤äº’å’ŒUIé€»è¾‘æ–¹é¢ä¸å¤Ÿå®Œå–„ã€‚</p>

<h3>è®¿é—®ä»å…¶ä»–ç±»ç»§æ‰¿çš„åŠŸèƒ½</h3>

<p>æ­¤æ¨¡å¼çš„ä¸€ä¸ªä¸»è¦æŒ‘æˆ˜æ˜¯æˆ‘ä»¬æ— æ³•è®¿é—®ä»å…¶ä»–ç±»ç»§æ‰¿çš„åŠŸèƒ½ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä¼ é€’å¼•ç”¨ã€‚</p>

<p>è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªé™åˆ¶å¸¦æ¥äº†å“ªäº›æŒ‘æˆ˜ï¼š</p>

<ul>
<li>æ— æ³•è®¿é—®ViewModelåŠŸèƒ½ï¼šæˆ‘ä»¬æ— æ³•ä»å®ç°ç±»è®¿é—®ä»»ä½•ViewModelåŠŸèƒ½ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ— æ³•åœ¨å®ç°ç±»ä¸­ä¼ é€’å½“å‰ç±»çš„å¼•ç”¨ã€‚</li>
<li>æ— æ³•ä½¿ç”¨ viewModelScopeï¼šæ­¤é™åˆ¶å¸¦æ¥çš„ä¸€ä¸ªä¸»è¦è­¦å‘Šæ˜¯ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨ viewModelScopeï¼Œå› æ­¤æ— æ³•ç›´æ¥å¯åŠ¨åç¨‹ã€‚æˆ‘ä»¬å¿…é¡»åœ¨ viewModel ä¸­åˆ›å»ºåŒ…è£…å‡½æ•°ï¼Œè¿™ä¼šç ´åå¯é‡ç”¨æ€§ï¼Œå› ä¸ºç°åœ¨å¯ç»„åˆå‡½æ•°ä¼šè°ƒç”¨æˆ‘ä»¬çš„ViewModelå‡½æ•°ã€‚</li>
</ul>


<p>å½“æˆ‘ä»¬å°è¯•å°†å…¶ä½œä¸ºæ„é€ å‡½æ•°å‚æ•°ä¼ é€’æ—¶ï¼ŒAndroid Studio ä¼šæŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xcJAyapM8023-hqu06vwUw.png" alt="Kotlin Compiler showing error when passing â€œthisâ€" /></p>

<h2>ğŸ§© æˆ‘çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æ¥å£é»˜è®¤å‡½æ•°è¿›è¡Œç»„åˆ</h2>

<p>åœ¨æˆ‘è‡ªå·±å®ç°ä½¿ç”¨å§”æ‰˜çš„ Composition æ–¹æ¡ˆæ—¶ï¼Œæˆ‘é‡åˆ°äº†ä¸€ä¸ªéš¾é¢˜ï¼šå¦‚ä½•ä¼ é€’å½“å‰ViewModelçš„å¼•ç”¨æ¥è®¿é—®viewModelScope å’Œæˆ‘çš„ BaseViewModel åŠŸèƒ½ã€‚åæ¥æˆ‘æƒ³èµ·äº† Kotlin æ¥å£ä¸­çš„é»˜è®¤å‡½æ•°ï¼Œäºæ˜¯å°è¯•äº†è¿™ä¸ªæ–¹æ¡ˆï¼Œå®Œç¾åœ°è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚</p>

<p>é€šè¿‡è¿™ä¸ªæ–¹æ¡ˆï¼Œæˆ‘å¯ä»¥ï¼š</p>

<ul>
<li>ğŸ’¡ æ”¯æŒåŠŸèƒ½é‡å†™</li>
<li>ğŸ”— å®Œå…¨è®¿é—®æˆ‘çš„BaseViewModelå’ŒViewModel çš„åŠŸèƒ½ï¼Œä¾‹å¦‚viewModelScope ç­‰ï¼Œæˆ–ä»»ä½•å…¶ä»–ç±»çš„åŠŸèƒ½ã€‚</li>
<li>âŒ æ— éœ€å•ç‹¬çš„å®ç°ç±»</li>
</ul>


<blockquote><p>åœ¨æˆ‘ä»¬<a href="https://medial.app/"> Medial çš„åº”ç”¨</a>ï¼ˆé“¾æ¥ <a href="https://medial.app/%EF%BC%89%E7%94%9F%E4%BA%A7%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8C%E6%88%91%E9%9B%86%E6%88%90%E4%BA%86%E8%BF%99%E4%B8%AA%E6%96%B9%E6%A1%88%EF%BC%8C%E4%BB%A5%E7%AE%80%E5%8C%96ViewModel%E5%A4%84%E7%90%86UI%E4%BA%A4%E4%BA%92%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82%E7%BB%93%E6%9E%9C%E5%A6%82%E4%BD%95%EF%BC%9F%E6%AF%8F%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%E5%8F%AA%E9%9C%80%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%8C%E5%AE%83%E5%B0%B1%E5%B9%B2%E5%87%80%E5%88%A9%E8%90%BD%E5%9C%B0%E8%8E%B7%E5%BE%97%E4%BA%86%E5%8A%9F%E8%83%BD%E3%80%82">https://medial.app/%EF%BC%89%E7%94%9F%E4%BA%A7%E4%BB%A3%E7%A0%81%E4%B8%AD%EF%BC%8C%E6%88%91%E9%9B%86%E6%88%90%E4%BA%86%E8%BF%99%E4%B8%AA%E6%96%B9%E6%A1%88%EF%BC%8C%E4%BB%A5%E7%AE%80%E5%8C%96ViewModel%E5%A4%84%E7%90%86UI%E4%BA%A4%E4%BA%92%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%82%E7%BB%93%E6%9E%9C%E5%A6%82%E4%BD%95%EF%BC%9F%E6%AF%8F%E4%B8%AA%E6%96%B0%E9%A1%B5%E9%9D%A2%E5%8F%AA%E9%9C%80%E5%AE%9E%E7%8E%B0%E8%BF%99%E4%B8%AA%E6%8E%A5%E5%8F%A3%EF%BC%8C%E7%84%B6%E5%90%8E%EF%BC%8C%E5%AE%83%E5%B0%B1%E5%B9%B2%E5%87%80%E5%88%A9%E8%90%BD%E5%9C%B0%E8%8E%B7%E5%BE%97%E4%BA%86%E5%8A%9F%E8%83%BD%E3%80%82</a></p></blockquote>

<p>è®©æˆ‘ä»¬æ¥æ¢ç´¢ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆæ˜¯å¦‚ä½•è§£å†³æˆ‘ä»¬çš„é—®é¢˜çš„ã€‚</p>

<h3>è®¾è®¡ ActionHandler æ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">ShareClicked</span> <span class="p">-&gt;</span> <span class="n">handleShareClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">showToast</span><span class="p">(</span><span class="s">&quot;Liked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// å®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è®©æˆ‘ä»¬çš„ViewModelå®ç°è¿™ä¸ªæ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">PostViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ä¼ å…¥å½“å‰çš„baseViewModel</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">valViewModel</span><span class="p">=</span> <span class="k">this</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">handleShareClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// æ·»åŠ  overrideå®ç°</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è¿™æ˜¯å®ƒåœ¨ Composable ä¸­çš„ä½¿ç”¨æ–¹å¼</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">PostViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">PostItem</span><span class="p">(</span><span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostItem</span><span class="p">(</span>
</span><span class='line'>    <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ‰€ä»¥ï¼Œæ­£å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ viewModel å˜é‡ï¼Œå°±å¤§åŠŸå‘Šæˆäº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ViewModelå’Œ BaseViewModel æä¾›çš„æ‰€æœ‰åŠŸèƒ½äº†ã€‚</p>

<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•è§£å†³ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆçš„ä¸»è¦ç¼ºç‚¹çš„ï¼š</p>

<ul>
<li>é€šè¿‡å°† viewModel å¼•ç”¨ä¿ç•™ä¸ºæ¥å£å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°åœ¨ViewModelä¸­å®šä¹‰å®ƒã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›´æ¥è®¿é—® BaseViewModel æˆ–ä»»ä½•å…¶ä»–ViewModelæä¾›çš„æ‰€æœ‰åŠŸèƒ½ã€‚</li>
<li>æˆ‘ä»¬ç®€åŒ–äº† viewModelScope çš„ä½¿ç”¨ã€‚ç°åœ¨ï¼Œå¯åŠ¨åç¨‹ã€æ”¶é›†æµç¨‹ä»¥åŠæ‰§è¡Œå…¶ä»–ä»»åŠ¡éƒ½å˜å¾—éå¸¸ç®€å•ï¼Œæ— éœ€ä»»ä½•å¤æ‚çš„å˜é€šæ–¹æ³•æˆ– hackã€‚è¿™å°±æ˜¯æ­¤è§£å†³æ–¹æ¡ˆå¸¦æ¥çš„ä¼˜é›…å’Œç®€æ´ä¹‹å¤„ã€‚</li>
</ul>


<p>è¿™ç§æ–¹æ³•åªæœ‰ä¸€ä¸ªå°ç¼ºç‚¹ï¼Œé‚£å°±æ˜¯</p>

<ul>
<li>æˆ‘ä»¬å¿…é¡»åœ¨ViewModelä¸­å®šä¹‰æ‰€æœ‰æ¥å£å±æ€§ï¼Œè¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¸»è¦ä¼šå¼•ç”¨ Repository æˆ– Domain Layer ç±»ï¼Œä»¥åŠä¸€äº›å¯å˜çŠ¶æ€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚</li>
</ul>


<p>è¿™ä¸ªé—®é¢˜æ¯”æˆ‘ä»¬åœ¨è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸­å…‹æœçš„ç¼ºç‚¹è¦å°å¾—å¤šï¼Œè¿™ä½¿å¾—å®ƒæˆä¸ºå¤„ç†ä»»ä½•å…±äº«UIäº¤äº’æˆ–ä»»ä½•å…±äº«UIä¸šåŠ¡é€»è¾‘çš„æœ€ä½³è§£å†³æ–¹æ¡ˆã€‚</p>

<blockquote><p>å—¯ï¼Œè¿™ä¸€éƒ¨åˆ†æ¯”å‰é¢å‡ éƒ¨åˆ†ç®€å•å¾—å¤šã€‚è¿™é‡Œæ²¡æœ‰å¤æ‚çš„é—®é¢˜éœ€è¦æ·±å…¥ç ”ç©¶â€”â€”åªæ˜¯ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒç¡®å®åšåˆ°äº†å®ƒåº”è¯¥åšçš„äº‹æƒ…ï¼Œå¹¶è§£å†³äº†æˆ‘ä»¬æ‰€æœ‰çš„é—®é¢˜ã€‚</p></blockquote>

<h2>ğŸ¥·ğŸ» è®©æˆ‘ä»¬åœ¨å®é™…ç”¨ä¾‹ä¸­çœ‹çœ‹è¿™ä¸ªè§£å†³æ–¹æ¡ˆçš„å®é™…åº”ç”¨ã€‚</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»é¡µé¢ï¼Œå®ƒä»¥åˆ—è¡¨å½¢å¼æ˜¾ç¤ºå„ç§UIå…ƒç´ ï¼Œä¾‹å¦‚åŒ…å«å¸–å­å’Œæ–°é—»ç­‰é¡¹ç›®çš„åŠ¨æ€ã€‚æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«ä¸€ç»„ç”¨æˆ·äº¤äº’ï¼Œä¾‹å¦‚ç‚¹èµå¸–å­ã€åˆ†äº«æ–°é—»æ–‡ç« æˆ–å¯¼èˆªåˆ°è¯¦æƒ…è§†å›¾ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆå¯ä»¥å¸®åŠ©æˆ‘ä»¬é«˜æ•ˆåœ°å¤„ç†è·¨ä¸åŒViewModelçš„è¿™äº›äº¤äº’ï¼Œç¡®ä¿ä»¥å¯æ‰©å±•çš„æ–¹å¼å¤„ç†é€šç”¨åŠŸèƒ½ã€‚</p>

<h3>ä¸ºæ¯ä¸ªUIç»„ä»¶è®¾è®¡UIäº¤äº’</h3>

<p>ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨ Kotlin çš„ Sealed æ¥å£ï¼Œåƒåœ¨å…¸å‹çš„ MVI æ¶æ„ä¸­ä¸€æ ·è®¾è®¡UIäº¤äº’ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">PostAction</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ShareClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">)</span> <span class="p">:</span> <span class="n">PostAction</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">NewsAction</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Clicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">LikeClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">BookmarkClicked</span><span class="p">(</span><span class="k">val</span> <span class="py">news</span><span class="p">:</span> <span class="n">News</span><span class="p">)</span> <span class="p">:</span> <span class="n">NewsAction</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>åˆ›å»ºæˆ‘ä»¬çš„åŠ¨ä½œå¤„ç†ç¨‹åºæ¥å£</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">PostActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">postRepo</span><span class="p">:</span> <span class="n">PostRepository</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">PostAction</span><span class="p">)</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handlePostClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>          <span class="k">is</span> <span class="n">PostAction</span><span class="p">.</span><span class="n">LikeClicked</span> <span class="p">-&gt;</span> <span class="n">handleLikeClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handlePostClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">(......)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleLikeClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">postRepo</span><span class="p">.</span><span class="n">like</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackbar</span><span class="p">(</span><span class="s">&quot;Post Liked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">interface</span> <span class="n">NewsActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">BaseViewModel</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">newsRepo</span><span class="p">:</span> <span class="n">NewsRepository</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">NewsAction</span><span class="p">)</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">NewsAction</span><span class="p">.</span><span class="n">Clicked</span> <span class="p">-&gt;</span> <span class="n">handleNewsClick</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">NewsAction</span><span class="p">.</span><span class="n">Bookmark</span> <span class="p">-&gt;</span> <span class="n">handleNewsBookmark</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleNewsClick</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">navigate</span><span class="p">(.....)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">handleNewsBookmark</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">newsRepo</span><span class="p">.</span><span class="n">bookmark</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>      <span class="n">viewModel</span><span class="p">.</span><span class="n">showSnackBar</span><span class="p">(</span><span class="s">&quot;News Bookmarked&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªæ•°æ®æ¨¡å‹åˆ›å»ºäº†ä¸€ä¸ª Action Handler æ¥å£ã€‚</p>

<p>æˆ‘ä»¬åœ¨è¿™é‡Œæ‰€åšçš„å°±æ˜¯éµå¾ªä¸Šä¸€èŠ‚æ‰€ç¤ºçš„æ¥å£è®¾è®¡ã€‚</p>

<ul>
<li>æˆ‘ä»¬æœ‰ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯ViewModelå’ŒRepository ç±»ã€‚</li>
<li>æˆ‘ä»¬åˆ†åˆ«åˆ›å»ºäº†å¤„ç†æ¯ä¸ª Action çš„å‡½æ•°ã€‚å½“ç„¶ï¼Œè¿™æ˜¯å¯é€‰çš„ã€‚æˆ‘ä¿ç•™è¿™ç§æ–¹å¼æ˜¯ä¸ºäº†æ–¹ä¾¿è¦†å†™ä»»ä½•ç‰¹å®šçš„è¡Œä¸ºï¼Œå¹¶ä¸”æˆ‘ä»¬ä¸ºæ¯ä¸ª Action ç±»å‹åˆ†åˆ«è°ƒç”¨ç›¸åº”çš„ Action å¤„ç†å‡½æ•°ã€‚</li>
</ul>


<h3>åˆ›å»º ViewModel</h3>

<p>è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªå®ç°è¿™ä¸¤ä¸ªæ¥å£çš„ ViewModelï¼Œä»¥ç»§æ‰¿å®ƒä»¬çš„åŠŸèƒ½ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">HomeViewModel</span> <span class="p">:</span> <span class="n">BaseViewModel</span><span class="p">(),</span> <span class="n">PostActionHandler</span><span class="p">,</span> <span class="n">NewsActionHandler</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="k">this</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">postRepo</span> <span class="p">=</span> <span class="n">PostRepository</span><span class="p">()</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">newsRepo</span> <span class="p">=</span> <span class="n">NewsRepository</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**</span>
</span><span class='line'><span class="cm">      ViewModelå…¶ä½™ä»£ç </span>
</span><span class='line'><span class="cm">    **/</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œæˆ‘ä»¬åœ¨ViewModelä¸­å®šä¹‰å¿…è¦çš„å±æ€§ï¼ˆ viewModel ã€ postRepo å’Œ newsRepo ï¼‰ï¼Œè¿™äº›å±æ€§ä¼šè¢«ä¸¤ä¸ªæ¥å£ä½¿ç”¨ã€‚</p>

<p>è¿™ç§è®¾è®¡æ¶ˆé™¤äº†å†—ä½™ï¼Œå¹¶ä¿æŒäº†ä»£ç çš„ç®€æ´æ€§ï¼Œå› ä¸ºæˆ‘ä»¬åªéœ€è®¾ç½®ä¸€æ¬¡å±æ€§ï¼Œåªè¦å±æ€§åç§°ç›¸åŒï¼Œä¸¤ä¸ªæ¥å£å°±å¯ä»¥æ— ç¼åœ°ä¸å…¶äº¤äº’ã€‚
è¿™ç§æ–¹æ³•ä¿æŒäº†ViewModelçš„ä¸­å¿ƒåœ°ä½ï¼ŒåŒæ—¶åˆå¯ä»¥è½»æ¾å¤„ç†ä¸åŒç»„ä»¶çš„UIäº¤äº’å’Œä¸šåŠ¡é€»è¾‘ã€‚</p>

<h2>ğŸªè¿æ¥ä¸€åˆ‡ï¼šå°†æ“ä½œè¿æ¥åˆ° UI</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">HomeViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LazyColumn</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">items</span><span class="p">(</span><span class="n">viewModel</span><span class="p">.</span><span class="n">items</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">when</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">News</span> <span class="p">-&gt;</span> <span class="n">NewsCard</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">Post</span> <span class="p">-&gt;</span> <span class="n">PostCard</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">onAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">handleAction</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">NewsCard</span><span class="p">(</span>
</span><span class='line'>  <span class="n">news</span><span class="p">:</span> <span class="n">News</span><span class="p">,</span>
</span><span class='line'>  <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">NewsAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">PostCard</span><span class="p">(</span>
</span><span class='line'>  <span class="n">post</span><span class="p">:</span> <span class="n">Post</span><span class="p">,</span>
</span><span class='line'>  <span class="n">onAction</span><span class="p">:</span> <span class="p">(</span><span class="n">PostAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨æˆ‘ä»¬çš„UIç»„ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥å°†è¿™äº›å‡½æ•°ç”¨ä½œViewModelæœ¬èº«çš„å‡½æ•°ï¼Œè¿™æ ·å°±å®Œæˆäº†åœ¨ Screen ä¸­æ·»åŠ äº¤äº’å¤„ç†çš„åŠŸèƒ½ã€‚</p>

<ul>
<li>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰å¦ä¸€ä¸ªåªæ˜¾ç¤ºæ–°é—»çš„é¡µé¢ï¼ˆScreenï¼‰ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯åœ¨ViewModelä¸­å®ç° NewsActionHandler æ¥å£â€”â€”å°±è¿™æ ·ï¼Œä¸€åˆ‡å°±ç»ªã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥æ— ç¼åœ°ä» BaseViewModel æˆ–ViewModelè°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œä»è€Œèƒ½å¤Ÿåœ¨ä¸€ä¸ªå•ä¸€çš„ã€é›†ä¸­çš„ä½ç½®å®ç°å®Œæ•´çš„ç«¯åˆ°ç«¯åŠŸèƒ½ã€‚å¦‚æœæˆ‘ä»¬åœ¨å¤šä¸ªä½ç½®æ˜¾ç¤ºç›¸åŒçš„æ•°æ®æ¨¡å‹ï¼Œè¿™å°†éå¸¸æœ‰åˆ©ã€‚</li>
</ul>


<h2>ğŸ“¦ æ•´åˆæ‰€æœ‰åŠŸèƒ½</h2>

<p>åœ¨è¿™ç¯‡åšæ–‡ä¸­ï¼Œæˆ‘ä»¬æ¢è®¨äº†åœ¨æ‰©å±•Android UIï¼ˆåŸºæœ¬ä¸Šæ˜¯ä»»ä½• UIï¼‰æ—¶æœ€å®¹æ˜“è¢«å¿½è§†çš„é—®é¢˜ä¹‹ä¸€ï¼Œå³è·¨ViewModelçš„é‡å¤UIäº¤äº’é€»è¾‘ã€‚æˆ‘ä»¬æ¢ç´¢äº†ä¸‰ç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<ol>
<li>è¾…åŠ©ç±» - ä¸€ç§å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼Œä½†å­˜åœ¨ä¸¥æ ¼çš„é™åˆ¶ã€‚</li>
<li>ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆâ€”â€”ä¸€ç§æ›´ç°ä»£çš„ç»§æ‰¿é©±åŠ¨è§£å†³æ–¹æ¡ˆï¼Œ
ä½†å®ƒéš¾ä»¥ä»å¤–éƒ¨è®¿é—®åŠŸèƒ½ã€‚</li>
<li>ä½¿ç”¨é»˜è®¤å‡½æ•°çš„æ¥å£ï¼ˆæˆ‘çš„è§£å†³æ–¹æ¡ˆï¼‰â€”â€”ä¸€ç§å®ç”¨ã€ä¼˜é›…ä¸”çµæ´»çš„æ–¹æ³•ï¼Œå…‹æœäº†å‰ä¸¤ç§æ–¹æ³•çš„æ‰€æœ‰é™åˆ¶ã€‚</li>
</ol>


<p>é€šè¿‡åˆ©ç”¨ Kotlin çš„æ¥å£é»˜è®¤æ–¹æ³•å¹¶å°†ViewModelä½œä¸ºæ¥å£å†…éƒ¨çš„å±æ€§ï¼Œæˆ‘ä»¬è§£é”äº†å®Œæ•´çš„å¯æ‰©å±•æ€§ï¼Œå¹¶èƒ½å¤Ÿä»å…¶ä»–ç»§æ‰¿çš„ç±»/æ¥å£è®¿é—®æ‰©å±•åŠŸèƒ½ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä»¥è¡¨æ ¼çš„å½¢å¼æ¯”è¾ƒä¸€ä¸‹æ¯ä¸ªè§£å†³æ–¹æ¡ˆï¼š</p>

<table>
<thead>
<tr>
<th> å¥½å¤„                           </th>
<th> é€šè¿‡è¾…åŠ©ç±»                                       </th>
<th> ä½¿ç”¨å§”æ‰˜è¿›è¡Œç»„åˆ                             </th>
<th> å¸¦æœ‰é»˜è®¤å‡½æ•°çš„æ¥å£ (âœ… æœ€å¥½)         </th>
</tr>
</thead>
<tbody>
<tr>
<td> ğŸ” å¯é‡ç”¨æ€§                                 </td>
<td>  âœ… Yes        </td>
<td>  âœ… Yes         </td>
<td>  âœ… Yes </td>
</tr>
<tr>
<td> ğŸ§  è¦†å†™è¡Œä¸º                        </td>
<td> âŒ ä¸å¯èƒ½          </td>
<td> âœ… å¯ä»¥ï¼Œç”±äºç»§æ‰¿        </td>
<td> âœ…  å¯ä»¥ï¼Œç”±äºç»§æ‰¿           </td>
</tr>
<tr>
<td> ğŸ”— è®¿é—®ä»å…¶ä»–æ¥æºç»§æ‰¿çš„åŠŸèƒ½                 </td>
<td> âŒ ä¸å¯ä»¥ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå°è£…ç±»      </td>
<td> âŒ  ä¸å¯ä»¥ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•ä¼ é€’å½“å‰å¼•ç”¨       </td>
<td> âœ…  å¯ä»¥ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å°†ç»§æ‰¿ç±»ä¿ç•™ä¸ºæ¥å£å±æ€§    </td>
</tr>
<tr>
<td> ğŸ—ï¸ è·¨é¡µé¢å¯æ‰©å±•æ€§                  </td>
<td> âš ï¸ å·®â€”â€”å½“é€»è¾‘è¿˜æ¶‰åŠè§†å›¾æ¨¡å‹ç‰¹å®šåŠŸèƒ½æ—¶ä¼šå˜å¾—å›°éš¾               </td>
<td> âœ… æ›´å¥½â€”â€”å¯é‡å¤ä½¿ç”¨çš„é€»è¾‘                    </td>
<td> âœ… æœ€ä½³â€”â€”è·¨é¡µé¢å³æ’å³ç”¨            </td>
</tr>
<tr>
<td> âœ… æœ€ä½³ç”¨ä¾‹                               </td>
<td> å¯¹äºéUIäº¤äº’å°è£…åŠŸèƒ½                   </td>
<td> ä¸šåŠ¡é€»è¾‘é‡ç”¨ï¼ŒéUIä¸Šä¸‹æ–‡            </td>
<td> å¤šä¸ªViewModelä¸­éœ€è¦çš„UIäº¤äº’ </td>
</tr>
</tbody>
</table>


<p>ä½ å¯ä»¥åœ¨<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample">ä¸“ç”¨çš„ GitHub ä»£ç åº“</a>ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E6%8E%A2%E7%B4%A2%E6%9C%AC%E5%8D%9A%E5%AE%A2%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82%E6%AC%A2%E8%BF%8E%E9%9A%8F%E6%84%8Fclone%E3%80%81fork%E6%88%96%E8%AF%95%E7%94%A8%E3%80%82">https://github.com/Vaibhav2002/Ui-Intreraction-Handler-Sample%EF%BC%89%E4%B8%AD%E6%8E%A2%E7%B4%A2%E6%9C%AC%E5%8D%9A%E5%AE%A2%E4%B8%AD%E6%8F%90%E5%88%B0%E7%9A%84%E6%89%80%E6%9C%89%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88%E3%80%82%E6%AC%A2%E8%BF%8E%E9%9A%8F%E6%84%8Fclone%E3%80%81fork%E6%88%96%E8%AF%95%E7%94%A8%E3%80%82</a></p>

<h2>âœŒï¸ å‘Šåˆ«</h2>

<p>æ€»è€Œè¨€ä¹‹ï¼Œå¸Œæœ›è¿™ç¯‡åšå®¢èƒ½å¸®åŠ©ä½ è§£é”ä¸€äº›å¼ºå¤§çš„æŠ€å·§ï¼Œæå‡ä½ çš„Kotlin å’ŒUIå¤„ç†çŸ¥è¯†ã€‚æœ‰äº†Kotlin çš„ç•Œé¢é»˜è®¤å‡½æ•°ï¼Œä½ çš„æ„å»ºå°†æ›´åŠ ç®€æ´ã€å¿«é€Ÿï¼Œå¹¶å…¼é¡¾é•¿æœŸå¯æ‰©å±•æ€§ã€‚</p>

<p>å¦‚æœä½ å–œæ¬¢è¿™ç¯‡æ–‡ç« å¹¶æƒ³éšæ—¶äº†è§£æœ€æ–°åŠ¨æ€ï¼š</p>

<ul>
<li>æŸ¥çœ‹æˆ‘çš„ LinkedInã€GitHub å’Œ X ä¸ªäººèµ„æ–™ï¼Œäº†è§£æˆ‘æ­£åœ¨åšçš„äº‹æƒ…ã€‚</li>
<li>æƒ³è¦æ›´å¤š Kotlin çš„é­”æ³•ï¼Ÿé˜…è¯»æˆ‘ä¹‹å‰çš„åšå®¢ï¼Œäº†è§£å¦ä¸€ç§å¯ä»¥è®©ä½ çš„ä»£ç åº“æ›´ç²¾ç®€ã€æ›´æ™ºèƒ½çš„æŠ€æœ¯ã€‚</li>
</ul>


<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼Œå¸Œæœ›ä½ å–œæ¬¢ï¼ğŸš€</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MVIæ¶æ„ï¼šComposeä¸­çš„å“åº”å¼çŠ¶æ€ç®¡ç†]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose/"/>
    <updated>2025-06-25T22:32:21+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒReactive State Management in Compose â€” MVI Architectureã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/reactive-state-management-in-compose-mvi-architecture-71546c9f1b52">https://proandroiddev.com/reactive-state-management-in-compose-mvi-architecture-71546c9f1b52</a>ï¼Œç”±Davies Adedayo AbdulGafarå‘å¸ƒäº2025å¹´4æœˆ22æ—¥ã€‚</p></blockquote>

<p>è¯‘æ³¨ï¼šåŸæ–‡ä½œè€…è™½ç„¶æ˜¯åŸºäºJetpack Composeæ¥å†™çš„ï¼Œä½†é‡ç‚¹è®¨è®ºçš„æ˜¯åº”ç”¨çš„MVIæ¶æ„æ–¹å¼ï¼Œæ¶‰åŠçš„éƒ½æ˜¯çº¯Kotlinè¯­è¨€å±‚é¢çš„ï¼Œä»¥åŠComposeå±‚é¢çš„ï¼Œå¹¶ä¸æ¶‰åŠå¹³å°ç‰¹æ€§ï¼Œå› æ­¤å®Œå…¨é€‚ç”¨äºè·¨å¹³å°çš„Compose Multiplatformã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/06/25/reactive-state-in-compose/"><img src="https://alexhilton.github.io/Users/alexhilton/Downloads/banner_reactive.png" title="auto auto" ></a></p>

<!-- more -->


<h2>MVIæ˜¯ä»€ä¹ˆé¬¼</h2>

<h3>MVIæ¶æ„çš„åŸºæœ¬æ¦‚å¿µ</h3>

<p>MVIï¼ˆæ¨¡å‹-è§†å›¾-æ„å›¾ï¼‰æ¶æ„ä¸º Android åº”ç”¨ç¨‹åºä¸­å¯æ‰©å±•ã€ç¨³å¥ä¸”å¯æµ‹è¯•çš„ UI çŠ¶æ€ç®¡ç†æä¾›äº†ä¸€ç§ç»“æ„è‰¯å¥½çš„æ–¹æ³•ã€‚å®ƒå¼ºè°ƒä»£ç ç®€æ´å’Œå…³æ³¨ç‚¹åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰ï¼Œå°†åº”ç”¨ç¨‹åºåˆ’åˆ†ä¸ºä¸‰ä¸ªä¸»è¦ç»„ä»¶â€”â€”æ¨¡å‹(Model)ã€è§†å›¾(View)å’Œæ„å›¾(Intent)â€”â€”å®ƒä»¬å…±åŒæ„æˆä¸€ä¸ªå¾ªç¯ï¼šæ„å›¾ -> è§†å›¾æ¨¡å‹ -> æ¨¡å‹ -> è§†å›¾ï¼Œä»è€Œå®šä¹‰å•å‘æ•°æ®æµï¼ˆ<strong>è¯‘æ³¨ï¼š</strong>è¿™é‡Œçš„æ„å›¾Intentæ˜¯æ¶æ„ä¸­çš„ä¸€ä¸ªé€»è¾‘æ¦‚å¿µï¼Œä¸Androidç³»ç»Ÿä¸­çš„Intentæ²¡æœ‰å…³ç³»ï¼‰ã€‚æ­¤æ¶æ„æ¨¡å¼æä¾›çš„ä¸åŒè§’è‰²æœ‰åŠ©äºæ›´è½»æ¾åœ°ç†è§£å’Œç»´æŠ¤ UI çŠ¶æ€ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼ŒMVI ä¸ä»…ä»…æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œè€Œæ˜¯ä¸€ä¸ªæ—¨åœ¨æµç•…å“åº”å˜åŒ–çš„å“åº”å¼ç³»ç»Ÿã€‚è¿™ç§å“åº”æ€§æ˜¯å…¶å®šä¹‰ç‰¹å¾ä¹‹ä¸€ï¼Œä¹Ÿæ˜¯å…¶æœ€å¤§çš„ä¼˜åŠ¿ã€‚</p>

<ul>
<li>å•å‘æ•°æ®æµï¼šæŒ‡æ•°æ®ä»¥å•å‘æµåŠ¨â€”â€”ä»æ¨¡å‹æµå‘è§†å›¾ï¼Œå¹¶ä»¥æ„å›¾çš„å½¢å¼è¿”å›ã€‚è¿™ç¡®ä¿äº†æ¶æ„çš„æ¸…æ™°åº¦ã€å¯é¢„æµ‹æ€§å’Œæ˜“ç»´æŠ¤æ€§ã€‚</li>
<li>å…³æ³¨ç‚¹åˆ†ç¦»ï¼šæŒ‡æ¨¡å‹ã€è§†å›¾å’Œæ„å›¾ç»„ä»¶å…·æœ‰ä¸åŒçš„è§’è‰²ã€‚æ¨¡å‹ç®¡ç†çŠ¶æ€ï¼Œè§†å›¾å¤„ç† UI æ¸²æŸ“ï¼Œæ„å›¾æ•è·å¹¶ä¼ è¾¾ç”¨æˆ·æ“ä½œã€‚</li>
<li>ä¸å¯å˜æ€§ï¼ˆImmutabilityï¼‰ï¼šç¡®ä¿æ¨¡å‹çš„çŠ¶æ€ä¸€æ—¦è®¾ç½®ä¾¿ä¿æŒä¸å˜ã€‚è¿™ä¿è¯äº†å¯é¢„æµ‹æ€§ï¼Œæ¶ˆé™¤äº†æ„å¤–çš„å‰¯ä½œç”¨ï¼Œå¹¶ä¿ƒè¿›äº†ç¨³å®šå¯é çš„åº”ç”¨çŠ¶æ€ã€‚</li>
<li>å“åº”å¼ï¼šå½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒUI ä¼šè‡ªåŠ¨æ›´æ–°ã€‚</li>
</ul>


<p>è¯¥æ¶æ„åˆ†è§£ä¸ºä¸‰ä¸ªå’Œè°çš„ç»„ä»¶ï¼Œå®ƒä»¬ä»¥å“åº”å¼æµç¨‹ååŒå·¥ä½œï¼š</p>

<ul>
<li>æ¨¡å‹ (Model) æ˜¯å•ä¸€äº‹å®æ¥æºï¼Œå®ƒæ˜¯åº”ç”¨ç¨‹åºåœ¨ä»»ä½•ç‰¹å®šæ—¶åˆ»çš„çŠ¶æ€å¿«ç…§ã€‚å½“æ­¤çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®ƒä¼šè§¦å‘æ•´ä¸ªç³»ç»Ÿçš„çº§è”å“åº”å¼æ›´æ–°ã€‚UI ä¼šåœ¨çŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°ï¼Œè¿™å‡¸æ˜¾äº†è¿™ä¸€æ ¸å¿ƒçš„å“åº”å¼åŸåˆ™ã€‚</li>
<li>è§†å›¾ (View) æ ¹æ®å½“å‰æ¨¡å‹çŠ¶æ€ä»¥å“åº”å¼æ–¹å¼æ¸²æŸ“ç”¨æˆ·æ‰€è§å†…å®¹ã€‚å®ƒè®¢é˜…çŠ¶æ€å˜åŒ–å¹¶è‡ªåŠ¨è¿›è¡Œè½¬æ¢ä»¥åæ˜ è¿™äº›å˜åŒ–ï¼Œè€Œæ— éœ€ä»»ä½•å‘½ä»¤å¼æ›´æ–°è°ƒç”¨ã€‚è¿™ç§å“åº”å¼æ¸²æŸ“æ­£æ˜¯ MVI å¦‚æ­¤å¼ºå¤§çš„åŸå› â€”â€”è§†å›¾å§‹ç»ˆä¸çŠ¶æ€åŒæ­¥ã€‚</li>
<li>æ„å›¾ (Intent) å®Œå–„äº†å“åº”å¼ç”µè·¯ï¼Œæ•è·ç”¨æˆ·äº¤äº’å¹¶å°†å…¶åé¦ˆå›ç³»ç»Ÿä»¥åˆ›å»ºæ–°çŠ¶æ€ã€‚è¿™å½¢æˆäº†ä¸€ä¸ªæŒç»­çš„åé¦ˆå¾ªç¯ï¼šç”¨æˆ·æ“ä½œè§¦å‘æ„å›¾ï¼Œæ„å›¾äº§ç”Ÿæ–°çŠ¶æ€ï¼Œæ–°çŠ¶æ€è§¦å‘ UI æ›´æ–°ã€‚</li>
</ul>


<p>å½“æˆ‘ä»¬è¯´ MVI å…·æœ‰å“åº”å¼ç‰¹æ€§æ—¶ï¼Œæˆ‘ä»¬æŒ‡çš„æ˜¯æ•´ä¸ªç³»ç»Ÿéƒ½æ˜¯å›´ç»•è‡ªåŠ¨å“åº”å˜åŒ–è€Œæ„å»ºçš„ã€‚æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒUI æ— éœ€æ‰‹åŠ¨æ›´æ–°ï¼Œè€Œæ˜¯ä¼šè‡ªåŠ¨åæ˜ å½“å‰çŠ¶æ€ã€‚è¿™ç§å“åº”å¼ç‰¹æ€§èƒ½å¤Ÿåˆ›å»ºä¸€ä¸ªåŠ¨æ€ã€å“åº”è¿…é€Ÿçš„åº”ç”¨ç¨‹åºï¼Œè®©ç”¨æˆ·æ„Ÿè§‰ç”ŸåŠ¨æ´»æ³¼ã€‚</p>

<h3>MVIæ¶æ„çš„å…¸å‹å®ç°æ–¹å¼</h3>

<p>åœ¨åŸç”Ÿ Android å¼€å‘ä¸­ï¼ŒMVI çš„å¤§éƒ¨åˆ†å®ç°éƒ½æ”¾åœ¨ ViewModel ç±»ä¸­ã€‚ä»¥ä¸‹æ˜¯å®ç° MVI æ¨¡å¼çš„ä¸€ç§ç®€å•æ–¹æ³•ï¼š</p>

<ol>
<li>æˆ‘ä»¬æ‰“ç®—å»ºæ¨¡çš„ UI çŠ¶æ€å°†å®ç°ä¸ºä¸€ä¸ªä¸å¯å˜çš„ Kotlin æ•°æ®ç±»ï¼ˆdata classï¼‰ï¼Œå…¶å­—æ®µä¿å­˜ç€æˆ‘ä»¬æƒ³è¦åœ¨è§†å›¾ä¸­æ˜¾ç¤ºçš„çŠ¶æ€ã€‚</li>
<li>StateFlow æ˜¯å°†æ•´ä¸ªæ¶æ„ç»‘å®šåœ¨ä¸€èµ·çš„å“åº”å¼ç²˜åˆå‰‚ã€‚è¿™ä¸ªè§‚å¯Ÿè€…å¯¹è±¡åŒ…è£…äº†æ¨¡å‹ï¼Œå¹¶å°†å˜åŒ–é€šçŸ¥ç»™è§†å›¾ï¼Œä»¥ä¾¿å®ƒåæ˜ æ–°çš„çŠ¶æ€ã€‚è¿™ä¸ªå“åº”å¼ç®¡é“ç¡®ä¿ä»»ä½•çŠ¶æ€å˜åŒ–éƒ½ä¼šè‡ªåŠ¨ä¼ æ’­åˆ° UIã€‚</li>
<li>ç›®å‰ï¼Œæˆ‘ä»¬çš„æ„å›¾å¯ä»¥å®ç°ä¸º ViewModel ä¸­çš„å…¬å…±å‡½æ•°ã€‚è¿™äº›å‡½æ•°åº”è¯¥æ²¡æœ‰è¿”å›å€¼ï¼Œä»¥ç¡®ä¿è§†å›¾åªæ¥æ”¶æ¥è‡ªè§‚å¯Ÿè€…çš„çŠ¶æ€æ›´æ–°ã€‚ç±»ä¼¼äºå¯¹è±¡ä½œä¸ºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ç­‰å…¬æ°‘ï¼Œå¯ä»¥é€šè¿‡å¼•ç”¨ä¼ é€’ï¼ŒåŒæ ·ï¼Œå‡½æ•°ä¹Ÿä¾èµ–äºæ–¹æ³•å¼•ç”¨ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸€ç‚¹å°†æ„å›¾ä¼ é€’ç»™ä½¿ç”¨å®ƒçš„ UI èŠ‚ç‚¹ã€‚æˆ‘ä»¬æ— éœ€ç¼–å†™å¤æ‚çš„ç±»æ¥å»ºæ¨¡æ„å›¾ï¼Œå› ä¸ºé‚£æ ·éœ€è¦é¢å¤–å®ç°æ„å›¾å¤„ç†ç¨‹åºã€‚</li>
</ol>


<p>ä»¥ä¸‹æ˜¯åœ¨ ViewModel ä¸­å®ç° MVI æ¨¡å¼çš„æ¨¡æ¿ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">class</span> <span class="nc">ScreenViewModel</span><span class="p">()</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span><span class="p">:</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(...))</span> <span class="c1">// private observer object</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span> <span class="c1">// observer object exposed as an immutable instance</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">doUpdateOnState</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span> <span class="c1">// public function serves as an intent</span>
</span><span class='line'>  <span class="k">fun</span> <span class="nf">doAnotherUpdate</span><span class="p">(...)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">MyModel</span><span class="p">(...)</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ–°çŠ¶æ€åœ¨ ViewModel ä¸­ç”Ÿæˆï¼Œç„¶åç”±è§‚å¯Ÿ uiState çš„è§†å›¾ä½¿ç”¨ã€‚è¯·æ³¨æ„ï¼ŒIntent æ˜¯å¦‚ä½•ä½œä¸ºè§¦å‘çŠ¶æ€æ›´æ”¹çš„å›è°ƒä¼ é€’åˆ°å¯ç»„åˆé¡¹é¡µé¢çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'> <span class="k">fun</span> <span class="nf">MyScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">ScreenViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">MyModel</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifeCycle</span><span class="p">()</span> <span class="c1">// consumes the state produced in the viewModel</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">MyScreenContent</span><span class="p">(</span>
</span><span class='line'>     <span class="n">uiState</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">,</span>
</span><span class='line'>     <span class="n">doUpdate</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">doUpdateOnState</span><span class="p">,</span> <span class="c1">// intent to do update</span>
</span><span class='line'>     <span class="n">doAnotherUpdate</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">doAnotherUpdate</span> <span class="c1">// intent to do another update</span>
</span><span class='line'>   <span class="p">)</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§ååº”æ¨¡å¼é€šè¿‡ Kotlin çš„ StateFlow å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span><span class="p">:</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">MyModel</span><span class="p">(...))</span>
</span><span class='line'><span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">MyModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ UI æ–¹é¢ï¼Œè¿™ç§ååº”æ€§é€šè¿‡æ”¶é›†æ“ä½œæ¥è¡¨è¾¾ï¼Œè¯¥æ“ä½œæ¶ˆè€—ä» viewModel ç”Ÿæˆçš„æ–°çŠ¶æ€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">uiState</span> <span class="p">=</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifeCycle</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™è¡Œä»£ç å»ºç«‹äº†ä¸€ä¸ªå“åº”å¼è¿æ¥ï¼Œæ¯å½“çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶éƒ½ä¼šè‡ªåŠ¨åˆ·æ–° UIã€‚æ— éœ€æ‰‹åŠ¨åˆ·æ–°è°ƒç”¨æˆ–å¤æ‚çš„æ›´æ–°é€»è¾‘â€”â€”ç³»ç»Ÿæœ¬èº«å°±æ˜¯å“åº”å¼çš„ã€‚</p>

<h2>æ¡ˆä¾‹ç ”ç©¶</h2>

<p>è®©æˆ‘ä»¬é‡‡ç”¨æ›´å®ç”¨çš„æ–¹æ³•ï¼Œå®ç° MVI æ¨¡å¼æ¥ç®¡ç†é¡µé¢ çŠ¶æ€ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªé¡µé¢ï¼Œç”¨æˆ·å¯ä»¥ä»ç»™å®šçš„é€‰é¡¹ä¸­é€‰æ‹©æ‰€æ˜¾ç¤ºé—®é¢˜çš„ç­”æ¡ˆã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:838/format:webp/0*uwa_-6EYNOhyNuNJ" alt="Case study" /></p>

<p>å›¾ç‰‡æ¥æº â€” <a href="https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey">Compose ç¤ºä¾‹ Jetsurvey</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey%EF%BC%89%E3%80%82%E7%82%B9">https://github.com/android/compose-samples/tree/v2024.01.00/Jetsurvey%EF%BC%89%E3%80%82%E7%82%B9</a><a href="https://github.com/SahDavies/mvi-architecture-sample/">å‡»æ­¤</a>ï¼ˆè¯‘æ³¨ï¼šé“¾æ¥æ˜¯<a href="https://github.com/SahDavies/mvi-architecture-sample/%EF%BC%89%E5%A4%84%E6%9F%A5%E7%9C%8B%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E3%80%82">https://github.com/SahDavies/mvi-architecture-sample/%EF%BC%89%E5%A4%84%E6%9F%A5%E7%9C%8B%E5%AE%8C%E6%95%B4%E5%AE%9E%E7%8E%B0%E3%80%82</a></p>

<p>é¡µé¢åŒ…å«ä»¥ä¸‹çŠ¶æ€ï¼š</p>

<ol>
<li>é—®é¢˜</li>
<li>é€‰é¡¹åˆ—è¡¨</li>
<li>é—®é¢˜è®¡æ•°</li>
<li>é€‰æ‹©æŒ‡ç¤ºå™¨</li>
<li>å¯ç”¨/ç¦ç”¨æŒ‰é’®</li>
</ol>


<p>æ­¤å¤–ï¼Œé¡µé¢è¿˜æä¾›ä»¥ä¸‹ç”¨æˆ·æ“ä½œçš„è¾“å…¥ï¼š</p>

<ol>
<li>è·å–ä¸‹ä¸€ä¸ªé—®é¢˜</li>
<li>è·å–ä¸Šä¸€ä¸ªé—®é¢˜</li>
<li>é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</li>
<li>å…³é—­/ç»“æŸæ“ä½œã€‚è¿™äº›æ“ä½œç”¨äºå°†ç”¨æˆ·çš„æ„å›¾ä¼ è¾¾ç»™åº”ç”¨ç¨‹åºã€‚</li>
</ol>


<p>ä¿å­˜é¡µé¢çŠ¶æ€çš„æ¨¡å‹å¯ä»¥è¿™æ ·å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UiState</span><span class="p">(</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">questionCount</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">totalQuestion</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">question</span><span class="p">:</span> <span class="n">Question</span><span class="p">,</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">userSelection</span><span class="p">:</span> <span class="n">Option</span><span class="p">?</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">hasNext</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">questionCount</span> <span class="p">&lt;</span> <span class="n">totalQuestion</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">hasPrevious</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">questionCount</span> <span class="p">&gt;</span> <span class="m">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚å‰æ‰€è¿°ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨å…¬å…±å‡½æ•°æ¥æè¿°æ„å›¾ï¼Œè¿™äº›å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚æˆ‘ä»¬åœ¨ä¸‹é¢åˆ—ä¸¾äº†å°†åœ¨ ViewModel ä¸­å®ç°çš„å‡½æ•°ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">next</span><span class="p">()</span> <span class="c1">// åŠ è½½ä¸‹ä¸€ä¸ªé—®é¢˜</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">previous</span><span class="p">()</span> <span class="c1">// åŠ è½½ä¸Šä¸€ä¸ªé—®é¢˜</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onOptionSelected</span><span class="p">(</span><span class="n">selection</span><span class="p">:</span> <span class="n">Option</span><span class="p">)</span> <span class="c1">// æ¿€æ´»é€‰ä¸­é€‰é¡¹çš„æ ‡è¯†</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨è§†å›¾ä¸­è°ƒç”¨çš„æ¯ä¸ªå‡½æ•°éƒ½ä¼šè§¦å‘ä¸€ä¸ªæ–°çš„çŠ¶æ€ä»¥ä¾›è§†å›¾ä½¿ç”¨ï¼Œè¿™æ ·æˆ‘ä»¬çš„é¡µé¢å°±æ˜¯å¯é¢„æµ‹å’Œå¯æµ‹è¯•çš„ï¼Œå› ä¸ºæ¯ä¸ªç”¨æˆ·äº¤äº’éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„ä¸å¯å˜çŠ¶æ€ï¼Œå¯ä»¥åœ¨æµ‹è¯•æœŸé—´è¿›è¡Œæ¯”è¾ƒã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">QuestionScreen</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onDone</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">BackHandler</span> <span class="p">{</span> <span class="cm">/* Do nothing */</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">QuestionViewModel</span><span class="p">(</span><span class="n">getQuestions</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">uiState</span><span class="p">.</span><span class="n">collectAsStateWithLifecycle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">QuestionScreenContent</span><span class="p">(</span>
</span><span class='line'>        <span class="n">uiState</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onClickNext</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">next</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onClickPrevious</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">previous</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onOptionSelected</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">onOptionSelected</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onDone</span> <span class="p">=</span> <span class="n">onDone</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„ï¼šå¹¶éæ‰€æœ‰å¸¦æœ‰çŠ¶æ€çš„é¡µé¢ç»„ä»¶éƒ½èƒ½ç”¨ MVI ç®¡ç†ã€‚æœ‰äº›ç»„ä»¶ç”±å•ç‹¬çš„çŠ¶æ€æŒæœ‰ç±»ç®¡ç†ï¼Œæœ‰äº›åˆ™ç”±å¯ç»„åˆç»„ä»¶æœ¬èº«çš„å†…éƒ¨çŠ¶æ€ç®¡ç†â€”â€”ä¾‹å¦‚ä¸Šå›¾ä¸­çš„è¿›åº¦æŒ‡ç¤ºå™¨ã€‚ä¸çœŸæ­£å¤„ç†ä¸šåŠ¡é€»è¾‘çš„çŠ¶æ€ä¸åº”è¯¥ä½¿ç”¨ MVI ç®¡ç†ã€‚</p>

<h2>è¶…è¶ŠåŸºæœ¬å“åº”å¼</h2>

<p>ä¸Šè¿°æ¡ˆä¾‹ç ”ç©¶åŸºäºæˆ‘ä»¬çš„é¡µé¢éœ€æ±‚ï¼Œä½¿ç”¨äº†ä¸€ä¸ªæ¨¡å‹çš„ç®€å•å®ç°ã€‚ç¼–å†™ MVI æ¨¡å¼çš„æ¨¡å‹å®ç°æœ‰å¾ˆå¤šæ–¹æ³•â€”â€”æ ¹æ®é¡µé¢éœ€æ±‚è¿›è¡Œå®ç°â€”â€”ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å«åŠ è½½å’Œé”™è¯¯çŠ¶æ€çš„é¡µé¢ã€‚é€šå¸¸ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨å¯†å°çš„ç±»å±‚æ¬¡ç»“æ„æ¥å®ç°â€”â€”å°½ç®¡å¦‚æ­¤ï¼Œä½ ä¹Ÿå¯ä»¥é€‰æ‹©ä»¥ä¸åŒçš„æ–¹å¼å®ç°ä½ è‡ªå·±çš„æ¨¡å‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// è€ƒè™‘åŠ è½½å’Œé”™è¯¯çŠ¶æ€çš„æ¨¡å‹</span>
</span><span class='line'><span class="k">internal</span> <span class="n">sealed</span> <span class="k">class</span> <span class="nc">UiState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Content</span><span class="p">(</span><span class="k">val</span> <span class="py">myModel</span><span class="p">:</span> <span class="n">UiModel</span><span class="p">)</span> <span class="p">:</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">error</span><span class="p">:</span> <span class="n">ErrorUiModel</span><span class="p">):</span> <span class="n">UiState</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è§†å›¾ä½¿ç”¨è¿™ç§æ–°ç±»å‹çš„æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'> <span class="n">@Composable</span>
</span><span class='line'> <span class="k">fun</span> <span class="nf">MyScreenContent</span><span class="p">(</span><span class="n">uiState</span><span class="p">:</span> <span class="n">UiState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">when</span><span class="p">(</span><span class="n">uiState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">LoadingScreen</span><span class="p">()</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">ErrorScreen</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">error</span><span class="p">)</span>
</span><span class='line'>      <span class="k">is</span> <span class="n">Content</span> <span class="p">-&gt;</span> <span class="n">ContentScreen</span><span class="p">(</span><span class="n">uiState</span><span class="p">.</span><span class="n">myModel</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">LoadingScreen</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ErrorScreen</span><span class="p">(</span><span class="n">error</span><span class="p">:</span> <span class="n">ErrorUiModel</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ContentScreen</span><span class="p">(</span><span class="n">content</span><span class="p">:</span> <span class="n">UiModel</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* implementation block */</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ç§æ¨¡å‹æ˜¯äº’æ–¥çš„â€”â€”å®ƒä¿è¯ä¸‰ä¸ªçŠ¶æ€ä¸ä¼šåŒæ—¶å‘ç”Ÿï¼Œè€Œæ˜¯ä¸€æ¬¡å‘ç”Ÿä¸€ä¸ªï¼Œè¿™æœ‰åŠ©äºé˜²æ­¢ UI çŠ¶æ€æ¸²æŸ“ä¸­å¸¸è§çš„é”™è¯¯ã€‚</p>

<h3>é‡å†™ Intent å®ç°</h3>

<p>Intent å®ç°ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ  Reducer/Handler æ¥ä¿®æ”¹ï¼ŒReducer/Handler æ˜¯ ViewModel ä¸­çš„ä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œå®ƒä¼šè°ƒç”¨ç§æœ‰å®ç°ï¼ˆè¾…åŠ©å‡½æ•°ï¼‰æ¥æ‰§è¡Œæ“ä½œï¼Œå¹¶ä½¿ç”¨ when è¡¨è¾¾å¼åˆ†æ”¯åˆ°ç›¸åº”çš„æ“ä½œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">Class</span> <span class="n">HomeScreenViewModel</span><span class="p">()</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Some class properties</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// our reducer/handler</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">onHomeAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">HomeAction</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">CategorySelected</span> <span class="p">-&gt;</span> <span class="n">onCategorySelected</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">TopicFollowed</span> <span class="p">-&gt;</span> <span class="n">onTopicFollowed</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">topic</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span> <span class="p">-&gt;</span> <span class="n">onHomeCategorySelected</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">category</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">ToggleTopicFollowed</span> <span class="p">-&gt;</span> <span class="n">onToggleTopicFollowed</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">topic</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onCategorySelected</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n">CategoryInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onTopicFollowed</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onToggleTopicFollowed</span><span class="p">(</span><span class="n">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onHomeCategorySelected</span><span class="p">(</span><span class="n">category</span><span class="p">:</span> <span class="n">HomeCategory</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºäº†ä½¿æ­¤è®¾ç½®æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¯†å°çš„æ¥å£å±‚æ¬¡ç»“æ„ï¼Œå¯¹åº”äºæ¯ä¸ªæ“ä½œï¼Œå…¶å­ç±»å±æ€§ç”¨äºä¿å­˜å‚æ•°ï¼Œç„¶åè¿™äº›å‚æ•°å°†é€šè¿‡è§†å›¾ä¸­çš„ reducer/handler ä¼ é€’ç»™è¿™äº›æ“ä½œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">HomeAction</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">CategorySelected</span><span class="p">(</span><span class="k">val</span> <span class="py">category</span><span class="p">:</span> <span class="n">CategoryInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">HomeCategorySelected</span><span class="p">(</span><span class="k">val</span> <span class="py">category</span><span class="p">:</span> <span class="n">HomeCategory</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">TopicFollowed</span><span class="p">(</span><span class="k">val</span> <span class="py">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleTopicFollowed</span><span class="p">(</span><span class="k">val</span> <span class="py">topic</span><span class="p">:</span> <span class="n">TopicInfo</span><span class="p">)</span> <span class="p">:</span> <span class="n">HomeAction</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸æˆ‘ä»¬ç¬¬ä¸€æ¬¡å®ç° Intent æ—¶éœ€è¦åœ¨è§†å›¾ä¸­ä½¿ç”¨æ–¹æ³•å¼•ç”¨ä¼ é€’æ‰€æœ‰æ“ä½œä¸åŒï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä¼ é€’ Reducer/Handlerã€‚ç„¶åï¼Œå†³å®šéœ€è¦è°ƒç”¨å“ªä¸ªæ“ä½œçš„è´£ä»»å°±è½åœ¨äº†è°ƒç”¨è€…èº«ä¸Šã€‚</p>

<p>è¿™æ˜¯è§†å›¾ä¸­çš„æ ·å­</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">HomeScreenViewModel</span><span class="p">,</span> <span class="n">onNavigate</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">HomeContent</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">contentPadding</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onHomeAction</span> <span class="p">=</span> <span class="n">viewModel</span><span class="o">::</span><span class="n">onHomeAction</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onNavigate</span> <span class="p">=</span> <span class="n">onNavigate</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>HomeContent å¯ç»„åˆå‡½æ•°ç°åœ¨è´Ÿè´£å†³å®šè°ƒç”¨å“ªä¸ªæ“ä½œï¼Œæ–¹æ³•æ˜¯å®ä¾‹åŒ–ä»¥ä¸‹ä»»æ„å¯¹è±¡ï¼Œç„¶åä½¿ç”¨å®ä¾‹åŒ–çš„å¯¹è±¡è°ƒç”¨ onHomeAction</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">CategorySelected</span><span class="p">(</span><span class="n">category</span> <span class="p">=</span> <span class="n">CategoryInfo</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span><span class="p">(</span><span class="n">category</span> <span class="p">=</span> <span class="n">HomeCategory</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">TopicFollowed</span><span class="p">(</span><span class="n">topic</span> <span class="p">=</span> <span class="n">TopicInfo</span><span class="p">())</span>
</span><span class='line'><span class="n">HomeAction</span><span class="p">.</span><span class="n">ToggleTopicFollowed</span><span class="p">(</span><span class="n">topic</span> <span class="p">=</span> <span class="n">TopicInfo</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯·å‚é˜…ä¸‹é¢çš„å®é™…æ“ä½œï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">HomeContent</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onHomeAction</span><span class="p">:</span> <span class="p">(</span><span class="n">HomeAction</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span> <span class="c1">// HomeActionæ˜¯ä¸€ä¸ªå¯†å°ç±»å‹å±‚æ¬¡</span>
</span><span class='line'>    <span class="n">onNavigate</span><span class="p">:</span> <span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">homeCategory</span> <span class="p">=</span> <span class="n">HomeAction</span><span class="p">.</span><span class="n">HomeCategorySelected</span><span class="p">(</span><span class="n">CategoryInfo</span><span class="p">())</span>
</span><span class='line'>  <span class="n">onHomeAction</span><span class="p">(</span><span class="n">homeCategory</span><span class="p">)</span> <span class="c1">// triggers a state change</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å³ä½¿å¢åŠ äº†å¤æ‚åº¦ï¼Œæ ¸å¿ƒçš„å“åº”å¼åŸåˆ™ä¾ç„¶ä¿æŒä¸å˜ã€‚Reducer åªæ˜¯æä¾›äº†ä¸€ç§æ›´æœ‰æ¡ç†çš„æ–¹å¼æ¥å¤„ç†æ„å›¾å¹¶ç”Ÿæˆæ–°çš„çŠ¶æ€ï¼Œè€Œä»çŠ¶æ€åˆ° UI çš„å“åº”å¼æµç¨‹ä¿æŒä¸å˜ã€‚</p>

<p>è¿™ç§å®ç°æ–¹å¼ä½¿å¾—è¿­ä»£æ„å»ºå˜å¾—ç®€å•â€”â€”æ— è®ºæˆ‘ä»¬éœ€è¦å¯¹æ„å›¾è¿›è¡Œä»€ä¹ˆæ›´æ”¹ï¼ˆæ— è®ºæ˜¯æ·»åŠ æ–°çš„æ„å›¾è¿˜æ˜¯åˆ é™¤ç°æœ‰çš„æ„å›¾ï¼‰ï¼Œéƒ½ä¸éœ€è¦åƒæˆ‘ä»¬æœ€åˆçš„å®ç°é‚£æ ·åœ¨å¾ˆå¤šåœ°æ–¹è¿›è¡Œé‡å†™ï¼›æˆ‘ä»¬åªéœ€åœ¨å¤„ç†ç¨‹åºä¸­æ³¨å†Œæ–°çš„æ“ä½œï¼Œç„¶ååœ¨è°ƒç”¨å¤„ç†ç¨‹åºæ—¶æ ¹æ®å…·ä½“æƒ…å†µå®ä¾‹åŒ–ä¸åŒçš„å¯¹è±¡å³å¯ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹è¿™ç¯‡æ–‡ç« ï¼ŒMVI æœ€ä¼˜é›…çš„æ–¹é¢åœ¨äºå®ƒå¦‚ä½•åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„å“åº”å¼é“¾è·¯ï¼š</p>

<ol>
<li>æ¨¡å‹å‘å‡ºçŠ¶æ€</li>
<li>è§†å›¾ä½¿ç”¨çŠ¶æ€å¹¶æ¸²æŸ“ UI</li>
<li>ç”¨æˆ·ä¸è§†å›¾çš„äº¤äº’ç”Ÿæˆæ„å›¾</li>
<li>æ„å›¾è¢«å¤„ç†ä»¥åˆ›å»ºæ–°çš„æ¨¡å‹</li>
<li>è¿™ä¸ªå¾ªç¯ä»¥å“åº”å¼çš„æ–¹å¼æŒç»­è¿›è¡Œ</li>
</ol>


<p>è¿™ç§ä¸é—´æ–­çš„å“åº”å¼å¾ªç¯ç¡®ä¿ä½ çš„åº”ç”¨ç¨‹åºå§‹ç»ˆä¸ç”¨æˆ·æ“ä½œå’Œåç«¯æ•°æ®ä¿æŒåŒæ­¥ã€‚è¿™ä¸ä»…ä»…æ˜¯å“åº”å˜åŒ–â€”â€”è€Œæ˜¯åˆ›å»ºä¸€ä¸ªç³»ç»Ÿï¼Œè®©å˜åŒ–è‡ªç„¶åœ°é€šè¿‡é¢„å®šä¹‰çš„å“åº”å¼è·¯å¾„è¿›è¡Œã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰ä»¥è®©Androidä»£ç æ›´ç®€æ´]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases/"/>
    <updated>2025-06-16T22:20:33+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒMaking Android Code Cleaner with Use Cases: A Practical Approach Using Kotlin Coroutinesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/making-android-code-cleaner-with-use-cases-a-practical-approach-using-kotlin-coroutines-2700e724c4fd">https://proandroiddev.com/making-android-code-cleaner-with-use-cases-a-practical-approach-using-kotlin-coroutines-2700e724c4fd</a>ï¼Œç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´4æœˆ11æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/06/16/making-android-code-cleaner-with-use-cases/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eVj9Vuqq31RUWd2y" title="auto auto" ></a></p>

<!-- more -->


<h2>ä»‹ç»</h2>

<p>ä¹‹å‰ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€ä¸ª Android åº”ç”¨ï¼Œé‡ç‚¹å…³æ³¨äº†æ•´æ´æ¶æ„ (Clean Architecture)ã€è¾“å…¥/è¾“å‡º MVVM æ‹†åˆ†å’Œ Repository æ¨¡å¼ã€‚è¿™ç§æ–¹æ³•éµå¾ªäº† Google Android å›¢é˜Ÿæ¨èçš„æœ€ä½³å®è·µï¼Œä½¿ä»£ç åº“å…·æœ‰å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¯æµ‹è¯•æ€§ã€‚</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨å¦ä¸€ä¸ªé‡è¦æ¦‚å¿µâ€”â€”ç”¨ä¾‹ (Use Case)ï¼Œå¹¶å‘ä½ ä»‹ç»å®ƒçš„ç”¨æ³•åŠå…¶èƒŒåçš„èƒŒæ™¯ã€‚é‡‡ç”¨è¿™ç§æ¨¡å¼å°†ä½¿ä½ çš„ä»£ç æ›´å…·å¯è¯»æ€§å’Œå¯æµ‹è¯•æ€§â€”â€”è¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„ä¼˜åŠ¿ã€‚</p>

<h3>ä½¿ç”¨Interactorså¸¦æ¥çš„é—®é¢˜</h3>

<p>è¿‡å»ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ Interactors ä½œä¸ºå±‚ä¸å±‚ä¹‹é—´çš„ä¸­é—´ä»¶ç»„ä»¶â€”â€”ä¾‹å¦‚ï¼ŒPresenter å¯ä»¥ä½¿ç”¨ Interactors ä¸é¢†åŸŸå±‚ï¼ˆDomain layerï¼‰è¿›è¡Œé€šä¿¡ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†ä¸€äº›é€»è¾‘ä» Presenter ä¸­ç§»å‡ºï¼Œå¹¶æ”¾å…¥å•ç‹¬çš„å¯å¤ç”¨ç»„ä»¶ä¸­ã€‚åœ¨å½“æ—¶ï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„é€»è¾‘æ‹†åˆ†è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿä¿æŒä»£ç ç®€æ´ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Interactor</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserInteractor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">username</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;Guest&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getUsername</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">username</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">username</span> <span class="p">=</span> <span class="n">name</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Presenter</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserPresenter</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">view</span><span class="p">:</span> <span class="n">UserView</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">interactor</span><span class="p">:</span> <span class="n">UserInteractor</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadUsername</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">interactor</span><span class="p">.</span><span class="n">getUsername</span><span class="p">()</span>
</span><span class='line'>        <span class="n">view</span><span class="p">.</span><span class="n">showUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">interactor</span><span class="p">.</span><span class="n">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">view</span><span class="p">.</span><span class="n">showSavedMessage</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>éšç€ Presenter çš„å¢é•¿ï¼Œé€»è¾‘çš„å¤æ‚æ€§ä¹Ÿä¼šéšä¹‹å¢åŠ â€”â€”è¿™é€šå¸¸ä¼šå¯¼è‡´ Interactor ä¸­æ–¹æ³•æ•°é‡çš„å¢åŠ ã€‚Presenter è¶Šå¤§ï¼ŒInteractor ä¹Ÿå°±è¶Šåºå¤§ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€å¨å¡æ»¡çŠ¶æ€ã€æ–¹æ³•å’Œå˜é‡çš„å±å †ï¼Œå®ƒä»¬éƒ½å †æŒ¤åœ¨ä¸€ä¸ªåœ°æ–¹ã€‚</p>

<p>æ˜¾ç„¶ï¼Œè¿™æ ·çš„ä»£ç åº“ç»´æŠ¤èµ·æ¥å¾ˆå›°éš¾ï¼Œæµ‹è¯•èµ·æ¥ä¹Ÿå¾ˆå›°éš¾ï¼Œç”šè‡³æ›´éš¾ç”¨åˆé€‚çš„å•å…ƒæµ‹è¯•æ¥è¦†ç›–ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™ç§æ¶æ„ä¼šé™·å…¥åæ¨¡å¼çš„å¢ƒåœ°ï¼Œè¿å <strong>SOLIDï¼ˆå°¤å…¶æ˜¯å•ä¸€èŒè´£åŸåˆ™ï¼‰</strong> å’Œ <strong>KISS</strong> ç­‰æ ¸å¿ƒåŸåˆ™ã€‚</p>

<p>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘è¦å¼ºè°ƒä½¿ç”¨ Interactor æ–¹æ³•æ—¶å®¹æ˜“é‡åˆ°çš„ä»¥ä¸‹å‘ï¼š</p>

<ul>
<li>ä¸€å¤„å¡å¤ªå¤šä¸œè¥¿</li>
</ul>


<p>å½“ä¸€ä¸ªç±»å¤„ç†æ‰€æœ‰æ“ä½œâ€”â€”è¯»å–ã€å†™å…¥ã€åˆ é™¤â€”â€”å®ƒæœ€ç»ˆä¼šåšå¤ªå¤šäº‹æƒ…ã€‚è¿™ä¼šå¯¼è‡´æµ‹è¯•æ›´åŠ å›°éš¾ï¼Œå¹¶ä¸”å¾ˆéš¾åœ¨ä¸ç ´åå…¶ä»–åŠŸèƒ½çš„æƒ…å†µä¸‹è¿›è¡Œæ›´æ”¹ã€‚</p>

<ul>
<li>åŠŸèƒ½ä¸æ˜ç¡®</li>
</ul>


<p>åƒ LoginUser() è¿™æ ·çš„ç”¨ä¾‹ä¼šæ¸…æ¥šåœ°å‘Šè¯‰ä½ å‘ç”Ÿäº†ä»€ä¹ˆã€‚ä½†æ˜¯ï¼Œå¦‚æœäº¤äº’å™¨ï¼ˆinteractorï¼‰å¾ˆå¤§ï¼Œå°±å¾ˆéš¾åŒºåˆ†å®ƒçš„ä½œç”¨â€”â€”å®ƒæ˜¯å…³äºç”¨æˆ·çš„ã€è®¾ç½®çš„è¿˜æ˜¯å…¶ä»–ä»€ä¹ˆçš„ï¼Ÿ</p>

<ul>
<li>æ— æ³•å¤ç”¨</li>
</ul>


<p>åªå®Œæˆä¸€é¡¹å·¥ä½œçš„ç”¨ä¾‹å¾ˆå®¹æ˜“æ’å…¥åˆ°ä»»ä½•éœ€è¦çš„åœ°æ–¹ã€‚äº¤äº’å™¨ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå¢é•¿ï¼Œå˜å¾—è¿‡äºæ··ä¹±ï¼Œæ— æ³•å¤ç”¨ã€‚</p>

<ul>
<li>æ‰©å±•æ€§å·®</li>
</ul>


<p>æƒ³è±¡ä¸€ä¸‹ï¼Œæœ‰ 10 ä¸ªåŠŸèƒ½ï¼Œæ¯ä¸ªåŠŸèƒ½éƒ½æœ‰è‡ªå·±çš„äº¤äº’å™¨ï¼Œå¹¶ä¸”åŒ…å« 5 ä¸ªä»¥ä¸Šçš„æ–¹æ³•ã€‚è¿™éœ€è¦è®°ä½å¾ˆå¤šä¸œè¥¿ï¼Œä¹Ÿéœ€è¦ç®¡ç†å¾ˆå¤šä»£ç ã€‚</p>

<ul>
<li>é€»è¾‘æ··ä¹±</li>
</ul>


<p>å½“æ‰€æœ‰å†…å®¹éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­æ—¶ï¼Œå¾ˆå®¹æ˜“æ„å¤–åœ°å°†ä¸è¯¥æ”¾åœ¨ä¸€èµ·çš„å†…å®¹æ”¾åœ¨ä¸€èµ·â€”â€”ä¾‹å¦‚ï¼Œç™»å½•é€»è¾‘ä¸ä¸ªäººèµ„æ–™æ›´æ–°é€»è¾‘å°±ä¼šæ··æ‚åœ¨ä¸€èµ·ã€‚</p>

<h2>ç”¨ä¾‹ï¼ˆUse Caseï¼‰ï¼šä» UML åˆ° Android</h2>

<p>æˆ‘ä»¬åˆšæ‰è®¨è®ºçš„æ‰€æœ‰é—®é¢˜éƒ½å¯ä»¥é€šè¿‡ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰æ–¹æ³•å®Œå…¨è§£å†³æˆ–è‡³å°‘éƒ¨åˆ†è§£å†³ã€‚ä½†åœ¨æ·±å…¥æ¢è®¨åœ¨Androidä¸Šçš„å®ç°ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆå¿«é€Ÿäº†è§£ä¸€ä¸‹ç”¨ä¾‹åœ¨ UML æœ¯è¯­ä¸­çš„å«ä¹‰ã€‚åœ¨ UML ä¸­ï¼Œç”¨ä¾‹æ˜¯å…³äºä¸€ä¸ªæ˜ç¡®çš„æ„å›¾â€”â€”å®ƒä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„ä¸šåŠ¡é€»è¾‘æˆ–åŠŸèƒ½ã€‚</p>

<p>æŸ¥çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼Œäº†è§£å®ƒé€šå¸¸æ˜¯å¦‚ä½•å¯è§†åŒ–çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CK9zG_B9spS8JQ8-" alt="Use Case" /></p>

<p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬å³å°†å®ç°çš„ç”¨ä¾‹éµå¾ªä¸ UML ç›¸åŒçš„ç†å¿µï¼šä¸€ä¸ªæ„å›¾ï¼Œä¸€ä¸ªç”¨ä¾‹ï¼ˆOne Intent, one Use Caseï¼‰ã€‚è¿™ä¸ªç®€å•çš„è§„åˆ™å¸®åŠ©æˆ‘ä»¬è§£å†³äº†ä¹‹å‰çš„æ‰€æœ‰é—®é¢˜â€”â€”æµ‹è¯•å˜å¾—æ›´ç®€å•ï¼Œä»£ç æ›´å…·å¯æ‰©å±•æ€§ï¼Œæ•´ä½“ä¹Ÿæ›´æ˜“äºç»´æŠ¤ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ç”¨ä¾‹æ–¹æ³•æ”¹è¿›ä¸Šé¢çš„ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Use-Case 1</span>
</span><span class='line'><span class="k">class</span> <span class="nc">GetUserNameUseCase</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">():</span> <span class="n">String</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">repository</span><span class="p">.</span><span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Use-Case 2</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SaveUsernameUseCase</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">repository</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å› æ­¤ï¼Œæˆ‘ä»¬åˆšåˆšå°† Interactor æ‹†åˆ†æˆäº†ä¸¤ä¸ªç”¨ä¾‹ã€‚æˆ‘å»ºè®®ä½¿ç”¨ Invoke æ“ä½œå‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å°†å®ƒä»¬çš„ç”¨ä¾‹åç§°è§†ä¸ºå‡½æ•°ã€‚æ­¤å¤–ï¼Œè¿™ç§æ–¹å¼æµ‹è¯•èµ·æ¥ä¹Ÿæ›´åŠ å®¹æ˜“ã€‚</p>

<p>ä»¥ä¸‹ ViewModel æ¼”ç¤ºäº†ç”¨ä¾‹çš„ç”¨æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ViewModel</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUsername</span><span class="p">:</span> <span class="n">GetUserNameUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">saveUsername</span><span class="p">:</span> <span class="n">SaveUsernameUseCase</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userName</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadUsername</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userName</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">getUsername</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateUsername</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">saveUsername</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç®€å•çš„æµ‹è¯•å¯ä»¥å†™å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Before</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">useCase</span> <span class="p">=</span> <span class="n">GetUserNameUseCase</span><span class="p">(</span><span class="n">repository</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="k">return</span> <span class="n">username</span> <span class="n">from</span> <span class="n">repository</span><span class="err">`</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>     <span class="n">`when`</span><span class="p">(</span><span class="n">repository</span><span class="p">.</span><span class="n">getUserName</span><span class="p">()).</span><span class="n">thenReturn</span><span class="p">(</span><span class="s">&quot;JohnDoe&quot;</span><span class="p">)</span>
</span><span class='line'>     <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">useCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>     <span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;JohnDoe&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</span><span class='line'>     <span class="n">verify</span><span class="p">(</span><span class="n">repository</span><span class="p">).</span><span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">save</span> <span class="n">username</span> <span class="n">to</span> <span class="n">repository</span><span class="err">`</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">testName</span> <span class="p">=</span> <span class="s">&quot;JaneDoe&quot;</span>
</span><span class='line'>    <span class="n">useCase</span><span class="p">(</span><span class="n">testName</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">verify</span><span class="p">(</span><span class="n">repository</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">testName</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¦‚ä½•å°†å…¶çº³å…¥çœŸæ­£çš„ Repos åº”ç”¨ç¨‹åº</h2>

<p>æˆ‘çš„å»ºè®®æ˜¯å§‹ç»ˆä»æŠ½è±¡å¼€å§‹ã€‚é‰´äºç”¨ä¾‹çš„æ€§è´¨ï¼ˆé€šå¸¸åªæœ‰ä¸€ä¸ªå…¬å…±æ–¹æ³•ï¼‰ï¼Œæˆ‘å»ºè®®ä½¿ç”¨è¿ç®—ç¬¦å‡½æ•°ï¼ˆä¾‹å¦‚ï¼Œinvoke åœ¨è¿™é‡Œå°±å¾ˆæœ‰æ•ˆï¼‰ã€‚å¯ä»¥å®ç°ä»¥ä¸‹æŠ½è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ¨¡æ¿æ¥å£ä½œä¸ºæ‰€æœ‰ç”¨ä¾‹çš„æŠ½è±¡</span>
</span><span class='line'><span class="n">interface</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span> <span class="n">O</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®ƒçš„åç§°å¸¦æœ‰å‰ç¼€Suspendï¼ˆè¯‘æ³¨ï¼šè¿™é‡Œåº”è¯¥æ˜¯å‰ç¼€ï¼ŒåŸæ–‡æœ‰é”™è¯¯ï¼‰ï¼Œè¡¨ç¤ºå®ƒå¤„ç†æš‚åœçš„ç»“æœã€‚è¿™ç§é€šç”¨æ–¹æ³•å…è®¸æˆ‘ä»¬ä¸ºå‚æ•°å’Œè¿”å›ç±»å‹å®šä¹‰ç‰¹å®šçš„ç±»å‹ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹ç‰¹å®šçš„ç”¨ä¾‹æ¥å£å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç‰¹å®šçš„ç”¨ä¾‹æ¥å£</span>
</span><span class='line'><span class="n">interface</span> <span class="n">GetReposUseCase</span><span class="p">:</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ ¹æ®å…¶åç§°ï¼Œå®ƒå¯ä»¥ç”¨äºè·å– Reposï¼Œå¹¶æŠ›å‡ºå…¶ Result åŒ…è£…å™¨ã€‚å®¢æˆ·ç«¯å¯ä»¥ä»¥å‡½æ•°å¼çš„æ–¹å¼ä½¿ç”¨å®ƒï¼ˆä¾‹å¦‚ï¼Œval repos = getRepos(&hellip;)ï¼‰ã€‚å®ƒçš„å®ç°å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// GetReposUseCase çš„ç®€å•å®ç°</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">GetReposUseCaseImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">ReposRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">GetReposUseCase</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span>
</span><span class='line'>      <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>          <span class="n">repository</span><span class="p">.</span><span class="n">getRepos</span><span class="p">(</span><span class="n">param</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="n">mapper</span><span class="o">::</span><span class="n">map</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è®©ä»»åŠ¡æ›´å…·æŒ‘æˆ˜æ€§ï¼Œå¹¶åœ¨ç”¨ä¾‹ç»“æ„ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„æŠ½è±¡å±‚ã€‚æˆ‘æƒ³è¦å®ç°ä»…ä¸å­˜å‚¨åº“äº¤äº’çš„ç”¨ä¾‹ã€‚è¿™äº›ç”¨ä¾‹å°†åŒ…å«å­˜å‚¨åº“çš„å®ä¾‹ä½œä¸ºæ³›å‹ä¸­çš„é™„åŠ å‚æ•°ç±»å‹ã€‚è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»¥ä¸‹ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ¨¡æ¿æ¥å£ä½œä¸ºæ‰€æœ‰ç”¨ä¾‹çš„æŠ½è±¡</span>
</span><span class='line'><span class="n">interface</span> <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">T</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">T</span><span class="p">):</span> <span class="n">O</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä¿®æ”¹äº†executeæ–¹æ³•ï¼Œä½¿å…¶èƒ½å¤Ÿä»å¦ä¸€ä¸ªæŠ½è±¡å­ç±»ä¸­è°ƒç”¨ã€‚ä»¥ä¸‹æ˜¯æ›´æ–°åçš„ä»£ç ç‰‡æ®µï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// æ‰©å±• SuspendUseCase æ¥å£</span>
</span><span class='line'><span class="n">interface</span> <span class="n">RepositoryUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">I</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&gt;</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">SuspendUseCase</span><span class="p">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">O</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">repository</span><span class="p">:</span> <span class="n">R</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ªå®ç°ç±»å‹Rçš„å­˜å‚¨åº“çš„å­ç±»éƒ½å°†éµå®ˆè¯¥æ¥å£ï¼ˆContractï¼‰ã€‚æœ€åˆé€‚çš„æ–¹æ³•æ˜¯ä½¿ç”¨æŠ½è±¡ç±»ã€‚è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªæŠ½è±¡ç±»æ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç¡®ä¿éµå®ˆæ¥å£çš„æŠ½è±¡ç±»</span>
</span><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">BaseRepositoryUseCase</span><span class="p">&lt;</span><span class="k">in</span> <span class="n">I</span><span class="p">,</span> <span class="k">out</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span> <span class="p">:</span> <span class="n">Repository</span><span class="p">&gt;(</span><span class="k">override</span> <span class="k">var</span> <span class="py">repository</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">RepositoryUseCase</span><span class="p">&lt;</span><span class="n">I</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">I</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">):</span> <span class="n">O</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// è¿™æ˜¯å¯¹ SuspendUseCase æ¥å£çš„è°ƒç”¨</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">execute</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯æ‰©å±• BaseRepositoryUseCase ï¼Œéµå¾ªå…¶æ³›å‹æ¥å£ï¼Œæä¾›ä¸€ä¸ªè¾“å…¥ç±»ã€ä¸€ä¸ªè¾“å‡ºç±»ä»¥åŠä¸€ä¸ªè¢«è¦†å†™çš„Repoå®ä¾‹ã€‚ä»¥ä¸‹å®ç°å·²ç»è¶³å¤Ÿï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// ç”¨ä¾‹çš„å®ç°</span>
</span><span class='line'><span class="k">class</span> <span class="nc">GetReposUseCase</span><span class="p">(</span><span class="n">repository</span><span class="p">:</span> <span class="n">RepoRepository</span><span class="p">):</span>
</span><span class='line'>    <span class="n">BaseRepositoryUseCase</span><span class="p">&lt;</span><span class="n">Boolean</span><span class="p">,</span><span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;,</span> <span class="n">RepoRepository</span><span class="p">&gt;(</span><span class="n">repository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">(</span><span class="n">param</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">DomainRepoEntity</span><span class="p">&gt;&gt;</span> <span class="p">=</span>
</span><span class='line'>        <span class="c1">// ä½¿ç”¨å­˜å‚¨åº“è·å–å¹¶è¿”å›ç»“æœï¼Œå¦‚ repository.getData()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»“è®º</h2>

<p>å› æ­¤ï¼Œæˆ‘ä»¬æ¢ç´¢äº†ä»é›¶å¼€å§‹ä½¿ç”¨ç”¨ä¾‹ï¼ˆUse Caseï¼‰ã€æ•æ‰å®¢æˆ·æ„å›¾ï¼ˆClient Intentï¼‰çš„æœ€ä½³æ–¹æ³•ã€‚æˆ‘æ¼”ç¤ºäº†å¦‚ä½•ä»¥åŠŸèƒ½æ€§çš„æ–¹å¼å®ç°å’Œä½¿ç”¨å®ƒä»¬ï¼Œä½¿å…¶æ˜“äºæµ‹è¯•å’Œé›†æˆã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Androidåº”ç”¨ä¸­å®æˆ˜Repositoryæ¨¡å¼]]></title>
    <link href="https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository/"/>
    <updated>2025-06-13T22:57:11+08:00</updated>
    <id>https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒIncorporating the Repository Pattern into a Real-World Androidã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@siarhei.krupenich/incorporating-the-repository-pattern-into-a-real-world-android-app-739f2fee1460">https://medium.com/@siarhei.krupenich/incorporating-the-repository-pattern-into-a-real-world-android-app-739f2fee1460</a>ï¼Œç”±Siarhei Krupenichå‘å¸ƒäº2025å¹´4æœˆ4æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/06/13/incoporating-the-repository/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qkmRcr1xl7uFYPUfNyk2rw.png" title="auto auto" ></a></p>

<!-- more -->


<h2>å¼•è¨€</h2>

<p>ä¹‹å‰ï¼Œæˆ‘ä»¬æ¢è®¨äº†æ•´æ´æ¶æ„ (Clean Architecture) ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œè¿™äº›é—®é¢˜å¯èƒ½ä¼šæŸå®³ SOLID åŸåˆ™ã€å¢åŠ ç´§å¯†è€¦åˆæˆ–ä½¿å¯æµ‹è¯•æ€§å¤æ‚åŒ–ã€‚æˆ‘ä»‹ç»äº†ä¸€ç§è§£å†³è¿™äº›é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œå¸®åŠ©æˆ‘ä»¬ç»´æŠ¤æ›´å¯æ‰©å±•çš„ä»£ç åº“å¹¶æ›´é«˜æ•ˆåœ°æ·»åŠ æ–°åŠŸèƒ½ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¿˜æ¼”ç¤ºäº†å¦‚ä½•å°† ViewModel æ‹†åˆ†ä¸ºä¸¤ä¸ªä¸»è¦éƒ¨åˆ†â€”â€”è¾“å…¥æµå’Œè¾“å‡ºæµâ€”â€”ä»¥å‡å°‘ç´§å¯†è€¦åˆå¹¶æé«˜ ViewModel çš„çµæ´»æ€§ã€‚</p>

<p>æœ¬æ–‡å»¶ç»­äº†è¿™ä¸€æ€è·¯ï¼Œé€šè¿‡æ„å»ºä¸€ä¸ªç¤ºä¾‹åº”ç”¨æ¥å±•ç¤º Android å¼€å‘çš„æœ€ä½³å®è·µï¼Œè¯¥åº”ç”¨é€šè¿‡ API è¯·æ±‚è·å–å¹¶æ˜¾ç¤º Git ä»“åº“åˆ—è¡¨ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯å°†ç¦»çº¿æ¨¡å¼èå…¥åˆ°é¡¹ç›®ä¸­ã€‚å®ç°è¿™ä¸€ç›®æ ‡æœ€åˆé€‚çš„æ–¹æ³•æ˜¯å®ç° Repository æ¨¡å¼ã€‚Repository æ¨¡å¼å……å½“ Facadeï¼ˆå¦‚ GoF è®¾è®¡æ¨¡å¼ä¸­æ‰€è¿°ï¼‰ï¼Œåœ¨ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨ä¹‹é—´è¿›è¡Œåè°ƒï¼Œç¡®ä¿é«˜æ•ˆçš„æ•°æ®è®¿é—®ã€‚</p>

<p>ä¸ºäº†å……åˆ†ç†è§£æœ¬æ–‡ä¸­çš„æ¦‚å¿µï¼Œå»ºè®®ä½ ç†Ÿæ‚‰åç¨‹æˆ– RxJavaï¼Œå°½ç®¡è¿™äº›ä¸»é¢˜è¶…å‡ºäº†æœ¬æ–‡çš„è®¨è®ºèŒƒå›´ã€‚</p>

<h2>å­˜å‚¨åº“æ–¹æ³•ï¼šç¦»çº¿æ¨¡å¼çš„æœ€ä½³è§£å†³æ–¹æ¡ˆ</h2>

<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨åº”ç”¨ä¸­å®ç°ç¦»çº¿æ¨¡å¼ï¼Œç¡®ä¿å³ä½¿åœ¨æ²¡æœ‰äº’è”ç½‘è¿æ¥çš„æƒ…å†µä¸‹ä¹Ÿèƒ½è®¿é—®æ•°æ®ã€‚åº”ç”¨é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå®ƒä¼šä»ç½‘ç»œè·å–æ•°æ®ï¼Œå°†å…¶å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œç„¶åä½¿ç”¨ç¼“å­˜çš„æ•°æ®æ¥æœ€å¤§é™åº¦åœ°å‡å°‘ç½‘ç»œä½¿ç”¨é‡å¹¶é™ä½æµé‡ã€‚</p>

<p>å¦ä¸€ä¸ªå…³é”®æ–¹é¢æ˜¯æä¾›åœ¨éœ€è¦æ—¶æ‰‹åŠ¨åˆ·æ–°ç½‘ç»œæ•°æ®çš„åŠŸèƒ½ã€‚æœ€åï¼Œä¸ºäº†å¸®åŠ©ç”¨æˆ·åœ¨è¿æ¥é—®é¢˜åè¯†åˆ«åº”ç”¨ä½•æ—¶æ¢å¤äº’è”ç½‘è¿æ¥ï¼Œæˆ‘ä»¬ä¼šåœ¨ç¼“å­˜æ•°æ®æ—è¾¹æ˜¾ç¤ºä¸€æ¡é”™è¯¯æ¶ˆæ¯ï¼Œç›´åˆ°è¿æ¥æ¢å¤ã€‚</p>

<p>ç°åœ¨ä»»åŠ¡å·²ç»æ˜ç¡®ï¼Œè®©æˆ‘ä»¬æ·±å…¥æ¢è®¨å³ç”¨å‹è§£å†³æ–¹æ¡ˆèƒŒåçš„ç†è®ºã€‚å…¶æ ¸å¿ƒæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦è§£å†³ç»å…¸çš„æ•°æ®åŒæ­¥é—®é¢˜â€”â€”ä»ç½‘ç»œè·å–æ•°æ®ï¼Œå°†å…¶å­˜å‚¨åœ¨æœ¬åœ°ï¼Œå¹¶ç¡®ä¿è®¿é—®æœ€æ–°ä¿¡æ¯ã€‚</p>

<p>è¿™æ„å‘³ç€æˆ‘ä»¬çš„åº”ç”¨è‡³å°‘éœ€è¦ä¸¤ä¸ªæ•°æ®æºï¼šä¸€ä¸ªç”¨äºç½‘ç»œ API é€šä¿¡ï¼Œå¦ä¸€ä¸ªç”¨äºæœ¬åœ°å­˜å‚¨è®¿é—®ã€‚æ ¹æ®åº”ç”¨çš„éœ€æ±‚ï¼Œå¯èƒ½ä¼šç”¨åˆ°å…¶ä»–æ•°æ®æºï¼Œä¾‹å¦‚ Firebaseï¼ˆå†…ç½®åŒæ­¥åŠŸèƒ½ï¼‰ã€BLE æ•°æ®ç­‰ç­‰ã€‚</p>

<p>ä¸ºäº†åè°ƒè¿™äº›æ•°æ®æºï¼ˆåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨ï¼‰ï¼Œæœ€ç›´è§‚çš„è®¾è®¡æ¨¡å¼æ˜¯å››äººå¸® (GoF) çš„ Facade æ¨¡å¼ã€‚</p>

<p>Facade æ¨¡å¼æ˜¯ä¸€ç§é€šè¿‡æä¾›ç»Ÿä¸€æ¥å£æ¥ç®€åŒ–ä¸å¤æ‚ç³»ç»Ÿäº¤äº’çš„è®¾è®¡æ¨¡å¼ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†ç½‘ç»œ API å’Œæœ¬åœ°å­˜å‚¨å°è£…åœ¨ä¸€ä¸ªæŠ½è±¡å±‚ä¹‹åã€‚</p>

<p>æˆ‘ä»¬æ–°åˆ›å»ºçš„ Facade å°†åŒæ—¶ä¿å­˜ API ç½‘ç»œæ¥å£å’Œæœ¬åœ°å­˜å‚¨æ¥å£çš„å®ä¾‹ã€‚å¦ä¸€æ–¹é¢ï¼Œå®ƒå°†å…¬å¼€å•ä¸€çš„è®¿é—®æ–¹æ³•ï¼Œå¤„ç†è¯¸å¦‚å¼ºåˆ¶ä»ç½‘ç»œæ›´æ–°æ•°æ®ã€æœ¬åœ°å­˜å‚¨æ•°æ®ä»¥åŠç®¡ç†é”™è¯¯ç­‰ä»»åŠ¡ï¼ŒåŒæ—¶éšè—å†…éƒ¨å¤æ‚æ€§ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢çš„å›¾è¡¨ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1070/format:webp/0*FF1TQeYdw1F60rOZ" alt="å›¾ 1ï¼šå¤–è§‚æ¨¡å¼" /></p>

<p>è¯¥å›¾å‘ˆç°äº†ä¸€ç§ç®€å•çš„é€»è¾‘ï¼šå®¢æˆ·ç«¯ä»…ä¸Facade å®ä¾‹äº¤äº’ä»¥è®¿é—®æ•°æ®ï¼Œè€Œæ‰€æœ‰åº•å±‚å¤æ‚æ€§éƒ½éšè—åœ¨å…¶èƒŒåã€‚è¿™ç§æ–¹æ³•å®Œå…¨ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£è¡¨è¯¥å›¾çš„ä»¥ä¸‹ä¼ªä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// API Network</span>
</span><span class='line'><span class="n">interface</span> <span class="n">Network</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Local Storage</span>
</span><span class='line'><span class="n">interface</span> <span class="n">Storage</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">save</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Facade</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DataFacade</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">network</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="n">storage</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">storage</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Client</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>        <span class="n">testScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">facade</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªç®€å•çš„ä¾‹å­æ¼”ç¤ºäº†è¿™ç§æ–¹æ³•ï¼šå®¢æˆ·ç«¯æŒæœ‰ä¸€ä¸ª DataFacade å®ä¾‹ï¼Œå¹¶è°ƒç”¨å…¶obtainData() æ–¹æ³•ã€‚å½“ç„¶ï¼Œåœ¨å®é™…åœºæ™¯ä¸­ï¼ŒobtainData() æ–¹æ³•ä¼šåŒ…å«æ›´å¤æ‚çš„é€»è¾‘â€”â€”å¤„ç†é”™è¯¯ã€æ˜ å°„æ•°æ®ã€å°†ç»“æœåŒ…è£…åˆ° Result ç±»ä¸­ï¼Œä»¥åŠå†³å®šæ˜¯è·å–æ–°æ•°æ®è¿˜æ˜¯ä½¿ç”¨ç¼“å­˜ç‰ˆæœ¬ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ›´è¿›ä¸€æ­¥ï¼Œå°†è¿™ä¸ª Facade è½¬æ¢ä¸º Repository ç±»ã€‚
Repository æ¨¡å¼æ—¨åœ¨é€šè¿‡æ¸…æ™°çš„æ¥å£ç®¡ç†æ•°æ®è®¿é—®ï¼ŒåŒæ—¶éšè—åº•å±‚çš„å¤æ‚æ€§ã€‚ä»å®¢æˆ·ç«¯çš„è§’åº¦æ¥çœ‹ï¼Œ
æ²¡æœ‰ä»»ä½•å˜åŒ–â€”â€”ç”¨æ³•ä¿æŒä¸å˜â€”â€”ä½†åœ¨å†…éƒ¨ï¼Œé€»è¾‘ç»“æ„è‰¯å¥½ä¸”å°è£…å®Œæ•´ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¸‹å›¾æ¥æŸ¥çœ‹ Repository æ¨¡å¼çš„ç»“æ„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1070/format:webp/0*_A5f_Tv_9UhUuFqz" alt="å›¾ 2ï¼šå­˜å‚¨åº“æ¨¡å¼" /></p>

<p>ä¸Šå›¾è¡¨æ˜ï¼ŒRepository æ¨¡å¼æœ‰æ•ˆåœ°æ•æ‰äº† Facade æ¨¡å¼ï¼›ç„¶è€Œï¼Œâ€œRepositoryâ€ä¸€è¯æ›´èƒ½ä½“ç°è®¿é—®æ•°æ®çš„é€»è¾‘ï¼Œ
å› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨â€œRepositoryâ€ç‰ˆæœ¬ã€‚</p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å®ç°è¯¥æ¨¡å¼çš„å¢å¼ºç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// Repository Interface</span>
</span><span class='line'><span class="n">interface</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Repository</span>
</span><span class='line'><span class="k">class</span> <span class="nc">DataRepositoryImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">network</span><span class="p">:</span> <span class="n">Network</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">storage</span><span class="p">:</span> <span class="n">Storage</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">DataRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">obtainData</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">network</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="n">storage</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">storage</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Client</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Client</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">testScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">repository</span><span class="p">.</span><span class="n">obtainData</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å­˜å‚¨åº“æ¨¡å¼ï¼šä¼˜åŠ¿ä¸åŠ£åŠ¿</h2>

<h3>å­˜å‚¨åº“çš„ä¼˜åŠ¿</h3>

<ol>
<li>ä¿æŒäº•ç„¶æœ‰åºâ€”â€”ä½ çš„ä¸šåŠ¡é€»è¾‘æ— éœ€å¤„ç†æ•°æ®åº“æŸ¥è¯¢ã€‚</li>
<li>æ˜“äºæµ‹è¯•â€”â€”ä½ å¯ä»¥å°†çœŸå®æ•°æ®åº“ä¸æ¨¡æ‹Ÿæ•°æ®åº“äº¤æ¢ä»¥è¿›è¡Œæµ‹è¯•ã€‚</li>
<li>é¢å‘æœªæ¥â€”â€”å¦‚æœä½ ä» SQLite åˆ‡æ¢åˆ° Firebaseï¼Œåªéœ€æ›´æ–°å­˜å‚¨åº“å³å¯ã€‚</li>
<li>å¯é‡ç”¨â€”â€”åº”ç”¨ç¨‹åºçš„ä¸åŒéƒ¨åˆ†å¯ä»¥ä½¿ç”¨ç›¸åŒçš„å­˜å‚¨åº“ï¼Œè€Œæ— éœ€ç¼–å†™é‡å¤çš„ä»£ç ã€‚</li>
<li>ä»£ç æ›´ç®€æ´â€”â€”å®ƒéšè—äº†å¤æ‚çš„æŸ¥è¯¢ï¼Œå› æ­¤å…¶ä½™ä»£ç ä¿æŒç®€æ´ã€‚</li>
</ol>


<h3>ä¸ºä»€ä¹ˆå®ƒå¯èƒ½å¾ˆç¹ç</h3>

<ol>
<li>å¢åŠ é¢å¤–ä»£ç â€”â€”å¦‚æœä½ çš„åº”ç”¨ç¨‹åºå¾ˆå°ï¼Œä½¿ç”¨å­˜å‚¨åº“å¯èƒ½ä¼šæœ‰äº›è¿‡åº¦ã€‚</li>
<li>å¯èƒ½ä¼šé™ä½é€Ÿåº¦â€”â€”æ›´å¤šçš„å±‚çº§æ„å‘³ç€æ›´å¤šçš„å¯¹è±¡å’Œæ–¹æ³•è°ƒç”¨ã€‚</li>
<li>ç¼“å­˜ä¸æ˜¯è‡ªåŠ¨çš„â€”â€”å¦‚æœä½ æƒ³é¿å…ä¸å¿…è¦çš„æ•°æ®åº“è°ƒç”¨ï¼Œåˆ™éœ€è¦ä»˜å‡ºé¢å¤–çš„åŠªåŠ›ã€‚</li>
<li>å¯èƒ½è¿‡äºä¾èµ–æ•°æ®æ¨¡å‹â€”â€”å¦‚æœè®¾è®¡ä¸å½“ï¼Œæ›´æ”¹æ•°æ®åº“ç»“æ„å¯èƒ½ä¼šå¾ˆéº»çƒ¦ã€‚</li>
<li>å¹¶éæ€»æ˜¯å¿…è¦â€”â€”æœ‰æ—¶ï¼Œä»…ä½¿ç”¨ DAO å°±è¶³å¤Ÿäº†ã€‚</li>
</ol>


<p>Repository æ¨¡å¼éå¸¸é€‚åˆä¿æŒç®€æ´æ€§å’Œå¯æ‰©å±•æ€§ï¼Œä½†å®ƒå¹¶éæ€»æ˜¯æœ€ç®€å•çš„é€‰æ‹©ã€‚å¦‚æœä½ çš„åº”ç”¨è§„æ¨¡è¾ƒå°ï¼Œè·³è¿‡å®ƒå¯èƒ½ä¼šæ›´è½»æ¾ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬çš„é‡ç‚¹æ˜¯ä¸ºå¿«é€Ÿå¢é•¿ä¸”å¯æ‰©å±•çš„åº”ç”¨æä¾›è§£å†³æ–¹æ¡ˆï¼Œå› æ­¤æˆ‘ä»¬é€‰æ‹©äº†å®ƒã€‚</p>

<p>ç°åœ¨ï¼Œæ˜¯æ—¶å€™ç¼–å†™ä»£ç å¹¶å¢å¼º Repo åº”ç”¨äº†ã€‚</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬æ”¹è¿› Repository ç»“æ„å¹¶ä½¿å…¶é€‚åº”åº”ç”¨ã€‚ç”±äºæ²¡æœ‰å¤ªå¤šç»†èŠ‚éœ€è¦æ•´åˆï¼Œå› æ­¤æœ€ç»ˆçš„å›¾è¡¨ä¸ä¹‹å‰çš„ç‰ˆæœ¬éå¸¸ç›¸ä¼¼ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1144/format:webp/0*aH3Jd9RK9EI0AA9I" alt="å›¾3ï¼šè·å–Reposçš„Repositoryå®ç°" /></p>

<h2>å¼€æ’¸</h2>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å®ç° Repository å¹¶å°†å…¶é›†æˆåˆ°åº”ç”¨ç¨‹åºä¸­ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="c1">// The Repository pattern implementation</span>
</span><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">ReposRepositoryImpl</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">reposNetworkApi</span><span class="p">:</span> <span class="n">ReposNetworkApi</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">reposDao</span><span class="p">:</span> <span class="n">ReposDao</span><span class="p">,</span>
</span><span class='line'>    <span class="c1">// mappers may be placed here</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ReposRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getRepos</span><span class="p">(</span><span class="n">i</span>
</span><span class='line'>        <span class="n">sRefreshing</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">runCatching</span> <span class="p">{</span>
</span><span class='line'>             <span class="k">val</span> <span class="py">dbRepos</span> <span class="p">=</span> <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>             <span class="k">if</span> <span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                 <span class="n">reposNetworkApi</span><span class="p">.</span><span class="n">getRepos</span><span class="p">().</span><span class="n">fold</span><span class="p">({</span> <span class="n">result</span> <span class="p">-&gt;</span>
</span><span class='line'>                     <span class="n">reposDao</span><span class="p">.</span><span class="n">insertReposWithRelations</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span class='line'>                     <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span>
</span><span class='line'>                         <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                     <span class="p">)</span>
</span><span class='line'>                  <span class="p">},</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                     <span class="n">error</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span><span class="n">dbRepos</span><span class="p">)</span>
</span><span class='line'>                  <span class="p">})</span>
</span><span class='line'>              <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">dbRepos</span><span class="p">)</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}.</span><span class="n">getOrElse</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>              <span class="n">error</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>                  <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearRepos</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposDao</span><span class="p">.</span><span class="n">clearRepos</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†å¦‚ä½•å°† Repository æ¨¡å¼é›†æˆåˆ°åº”ç”¨ä¸­ã€‚å®ƒåŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼šä¸€ä¸ªç”¨äºæ¸…é™¤æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ•°æ®ã€‚getRepos(isRefreshing: Boolean) æ–¹æ³•åŒ…å«ä¸€ä¸ªæ ‡å¿—ï¼Œç”¨äºå¼ºåˆ¶ä»ç½‘ç»œåˆ·æ–°æ•°æ®ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿå¯èƒ½ä»ç¼“å­˜ä¸­è¿”å›æ•°æ®ï¼ˆä¾‹å¦‚ï¼ŒRoom DB ç”¨ä½œç¼“å­˜ï¼‰ã€‚å¦‚æœå‘ç”Ÿé”™è¯¯ï¼Œå³ä½¿æ•°æ®å·²ç¼“å­˜ï¼Œè¯¥æ–¹æ³•ä¹Ÿä¼šè¿”å›ä¸€ä¸ªåŒ…å«å¤±è´¥ä¿¡æ¯çš„å“åº”ã€‚</p>

<p>ç”±äºæˆ‘ä»¬ä¸»è¦å…³æ³¨çš„æ˜¯åç¨‹ï¼Œå› æ­¤è®©æˆ‘ä»¬ä½¿ç”¨ RxJava é‡å†™ getRepos(isRefreshing: Boolean) æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getRepos</span><span class="p">(</span>
</span><span class='line'>    <span class="n">isRefreshing</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'><span class="p">):</span> <span class="n">Single</span><span class="p">&lt;</span><span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">isRefreshing</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposNetworkApi</span><span class="p">.</span><span class="n">getRepos</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">insertReposWithRelations</span><span class="p">(</span><span class="n">networkReposToDbReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onErrorResumeNext</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">error</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">reposDao</span><span class="p">.</span><span class="n">getReposWithRelations</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onErrorReturn</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">error</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span><span class="n">emptyList</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¼‚å¸¸å¤„ç†çš„æ‰©å±•å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Throwable</span><span class="p">.</span><span class="n">exceptionToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">RepoWithRelations</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;(</span>
</span><span class='line'>            <span class="n">data</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»“æœé”™è¯¯å¤„ç†æ‰©å±•å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">fun</span> <span class="nf">Throwable</span><span class="p">.</span><span class="n">errorToResultWithFallback</span><span class="p">(</span>
</span><span class='line'>        <span class="n">localData</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">RepoWithRelations</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Repo</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">repoError</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">IOException</span> <span class="p">-&gt;</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">NetworkLost</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HttpException</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="p">()</span> <span class="p">==</span> <span class="m">401</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">RepoError</span><span class="p">.</span><span class="n">Unauthorized</span>
</span><span class='line'>                <span class="k">else</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">RepoError</span><span class="p">.</span><span class="n">Unknown</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">dbReposToReposMapper</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="n">localData</span><span class="p">),</span>
</span><span class='line'>            <span class="n">repoError</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŒ…è£…çš„æ•…éšœæ•°æ®ç±»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">ResultWithFallback</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Failure</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">?,</span> <span class="k">val</span> <span class="py">error</span><span class="p">:</span> <span class="n">RepoError</span><span class="p">)</span> <span class="p">:</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶ä¸”è½¬æ¢æ˜ å°„æ‰©å±•å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.</span><span class="n">map</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">):</span> <span class="n">ResultWithFallback</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="n">transform</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span> <span class="p">-&gt;</span> <span class="n">ResultWithFallback</span><span class="p">.</span><span class="n">Failure</span><span class="p">(</span>
</span><span class='line'>            <span class="n">data</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">transform</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">error</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»“è®º</h2>

<p>æˆ‘ä»¬å·²æˆåŠŸå°†å­˜å‚¨åº“æ¨¡å¼(Repository pattern)é›†æˆåˆ°åº”ç”¨ä¸­ï¼Œäº‹å®è¯æ˜ï¼Œè¿™æ˜¯ä¸€ç§ç»´æŠ¤ç¦»çº¿æ¨¡å¼çš„ç»ä½³æ–¹æ³•ã€‚æ­¤æ¨¡å¼ä¸ä»…ç®€åŒ–äº†æ•°æ®ç®¡ç†ï¼Œè¿˜ç¡®ä¿äº†å¯æ‰©å±•æ€§ã€‚å®ƒæ˜¯å®ç°æ•°æ®æ£€ç´¢å’Œå­˜å‚¨åŠŸèƒ½çš„æœ€æœ‰æ•ˆæ–¹æ³•ä¹‹ä¸€ï¼Œéšç€é¡¹ç›®è§„æ¨¡çš„å¢é•¿ï¼Œä½ å¯ä»¥æ›´è½»æ¾åœ°ç®¡ç†æœ¬åœ°å’Œè¿œç¨‹æ•°æ®æºã€‚</p>

<p>ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹é“¾æ¥æ¢ç´¢ä¸æœ¬æ–‡ä¸»é¢˜ç›¸å…³çš„ GitHub ä»£ç åº“ï¼š<a href="https://github.com/sergeykrupenich/TestRepo/tree/repository">https://github.com/sergeykrupenich/TestRepo/tree/repository</a></p>
]]></content>
  </entry>
  
</feed>
