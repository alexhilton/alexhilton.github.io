<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[稀有猿诉]]></title>
  <link href="http://toughcoder.net/atom.xml" rel="self"/>
  <link href="http://toughcoder.net/"/>
  <updated>2022-06-15T22:13:52+08:00</updated>
  <id>http://toughcoder.net/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Java集合操作集锦]]></title>
    <link href="http://toughcoder.net/blog/2022/06/14/java-collection-opertions-made-easy/"/>
    <updated>2022-06-14T23:36:34+08:00</updated>
    <id>http://toughcoder.net/blog/2022/06/14/java-collection-opertions-made-easy</id>
    <content type="html"><![CDATA[<p>集合是最为常见的容器，在日常工作之中经常用到，一些集合的常规操作以及不同的集合之间的转换，虽然看似是基础中的基础，但实践中会发现并不是那么显而易见的，特别是涉及boxing的时候，这篇就是想总结 出一些最优的方式来进行集合操作和转换。</p>

<p><strong>注意</strong>：这里集合的意思是容器，是一个更为宽泛的概念，包括数组，列表，Map，Set等。</p>

<p><a href="http://toughcoder.net/blog/2022/06/14/java-collection-opertions-made-easy/"><img src="https://tse4-mm.cn.bing.net/th/id/OIP-C.rLPIzmZk6G7fV6TCQsotWAHaHa?pid=ImgDet&rs=1" title="auto auto" ></a></p>

<!-- more -->


<h2>核心理念</h2>

<p>不造轮子，也就是说尽可能的复用JDK里面的函数库，无论是数组结构，还是针对数组结构的操作。</p>

<p>另外，就是尽可能的用函数化，也即是Stream API来完成，因为这更直观，当然 这里不能为了用而用，还是要保持代码的简洁和易懂。</p>

<h2>一维集合</h2>

<p>包括，数组，列表，Set，以及Queue和Stack。</p>

<h2>二维集合</h2>

<p>二维数组（矩阵），嵌套列表，Map，图。</p>

<h2>多维集合</h2>

<p>多维数组</p>

<h2>参考资料</h2>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera 2 API学习之小结]]></title>
    <link href="http://toughcoder.net/blog/2022/05/08/summary-of-camera-2-api-project/"/>
    <updated>2022-05-08T15:59:15+08:00</updated>
    <id>http://toughcoder.net/blog/2022/05/08/summary-of-camera-2-api-project</id>
    <content type="html"><![CDATA[<p>通过前面的<a href="http://toughcoder.net/blog/2022/04/24/camera-2-handling-3a-parameters/">一系列文章</a>，到现在已经算是学完了Camera 2 API的使用了，也做出一个具体基础功能的相机应用，目前可称得上是一个1.0版本了，后续会在此基础上进行迭代。本篇先进行一个小结。</p>

<p><a href="http://toughcoder.net/blog/2022/05/08/summary-of-camera-2-api-project/"><img src="https://tse1-mm.cn.bing.net/th/id/R-C.21389bf92d6ddcd68a53cbcf118eb665?rik=D%2f7xkH%2b7FC115w&riu=http%3a%2f%2ffindnerd.s3.amazonaws.com%2fimagedata%2f8364%2f8364.jpg&ehk=K55%2fBz%2favKGvIksdqHHaPCN3z%2bIIaDp9xclEICTNIOc%3d&risl=&pid=ImgRaw&r=0" title="auto auto" ></a></p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<script>mermaid.initialize({startOnLoad:true});</script>




<!-- more -->


<h2>整体架构</h2>

<p><a href="http://toughcoder.net/blog/2022/05/06/camera-2-record-video/">上一篇文章</a>加入了录像模式，让整体复杂度又提升了一个层次，需要做一次业务逻辑抽离。前面一直使用CameraContext作为整体外部调用的接口，一部分业务逻辑，如启动预览，打开相机，关闭相机，和拍照都放在了CameraContext之中。现在因为多了录像模式，且涉及模式切换，如果仍都把逻辑放入到CameraContext之中，会非常的混乱，于是需要引入新的组件：</p>

<div class="mermaid">
classDiagram
CameraScene <|-- BaseScene
BaseScene <|-- PhotoScene
BaseScene <|-- VideoScene
PhotoOutputConfig -&#45;|&gt; OutputConfig
VideoOutputConfig -&#45;|&gt; OutputConfig
PhotoScene *-- PhotoOutputConfig
VideoScene *-- VideoOutputConfig
BaseScene <-- CameraContext
BaseScene *-- CameraAgent
CameraContext <-- CameraAgent
class CameraScene {
    &lt;&lt;interface&gt;&gt;
    attachCameraContext(CameraContext cameraContext)
    attachSaveAgent(PhotoSaveAgent saveAgent)
    activate()
    onResume()
    onPause()
    deactivate()
    clickShutter(Consumer~PhotoCaptureStatus~ consumer)
    updatePreviewSurface(Surface surface)
    setFlashMode(FlashMode flashMode)
    changeOutputConfig(OutputConfig config)
    switchCamera(Config.CameraFacing facing)
    addPreviewSizeListener(Consumer~CameraSize~ consumer)
    addStatusListener(Consumer~SceneStatus~ consumer)
    getSupportedFlashModes() List~FlashMode~
    FlashMode getFlashMode()
    getSupportedOutputConfigs() List~OutputConfig~
    getOutputConfig() OutputConfig
}
class BaseScene {
    Context context
    CameraContext.CameraThreadHandler cameraHandler
    List~Consumer~CameraSize~~ previewSizeListeners
    List~Consumer~SceneStatus~~ moduleStatusListeners
    List~FlashMode~ supportedFlashModes

    CameraContext cameraContext
    CameraAgent cameraAgent
    Surface previewSurface
    PhotoSaveAgent saveAgent
    FlashMode flashMode
    
    notifyStatus(SceneStatus status)
    notifyPreviewSize(CameraSize size)
    generateOutputTargets() List~Surface~
    checkCameraContext()
    onCameraAvailable()
}
class VideoScene {
    Surface recorderSurface
    MediaRecorder mediaRecorder
    File emptyFile
    List~VideoOutputConfig~ supportedOutputConfigs
    VideoOutputConfig currentOutputConfig
}
class PhotoScene {
    Optional~OrientationEventListener~ orientationEventListener
    int deviceOrientation
    List~PhotoOutputConfig~ supportedOutputConfigs
    PhotoOutputConfig currentOutputConfig
}
class OutputConfig {
    int id
    String displayName
    Config.PictureRatio ratio
}
class PhotoOutputConfig {
    int width
    int height
    int format
}
class VideoOutputConfig {
    int width
    int height
    int fps
}
class CameraContext {
   Context context
    CameraManagerWrapper cameraManager
    Map~Config.CameraFacing, CameraAgent~ cameraCache
    HandlerThread cameraManageThread
    CameraThreadHandler cameraThreadHandler
    CameraAgent currentCamera
    
    attachThread()
    detachThread()
    openCamera()
    closeCamera()
    createScene()
    getCurrentCamera() CameraAgent
}
class CameraAgent {
    CameraCharacteristics characteristics
    Optional~CameraDevice~ cameraDevice
    Optional~CameraCaptureSession~ captureSession
    PreviewCaptureCallback previewCallback
    CaptureRequest.Builder requestBuilder
    CameraParameters parameters
    
    calculateSupportedRatios() List~PhotoOutputConfig~
    getFlashModes() List~FlashMode~
    calculateVideoRecordMode() List~VideoOutputConfig~
    connect()
    disconnect()
    startPreview(List~Surface~)
    stopPreview()
    capturePhoto()
    setFlashMode(FlashMode mode)
}
</div>


<h3>CameraScene和BaseScene</h3>

<p>一个Scene可以定义为一个典型的用户使用场景，比如拍照场景和录像场景，场景是业务逻辑的主要实现者，它的前面是UI层，后面则是平台API封装层。</p>

<h3>VideoScene和PhotoScene</h3>

<p>目前为止两个使用场景，PhotoScenne负责拍照，从UI处接收命令，完成拍照；VideoScene则负责录像。</p>

<p><a href="https://postimg.cc/c6pwmfHj"><img src="https://i.postimg.cc/4NdPX5TJ/camera2.png" alt="camera2.png" /></a></p>

<h3>与CameraContext的关系</h3>

<p>现在CameraContext则是一个纯的线程管理和camera open/close管理，除此之外的其他逻辑全部都挪到了Scene中去。Scene与Context的关系是组合关系，Scene的所有操作都应该只发生在CameraContext的线程中。</p>

<h2>线程模型</h2>

<p>三个长驻线程，一个是主线程负责UI交互，一个是CameraContext线程，负责所有的业务逻辑，还有一个是存储，一旦结果出来了后余下的所有事情都在存储线程中。</p>

<div class="mermaid">
sequenceDiagram
    MainThread-&gt;>CameraManageThread: startPreview
    CameraManageThread-&#45;&gt;>MainThread: onPreviewSize
    MainThread->>CameraManageThread: capturePhoto
    CameraManageThread-&#45;&gt;>MainThread: captureStatus
    CameraManageThread-) ImageSaveThread: onCaptureComplete
    ImageSaveThread-&#45;&gt;>MainThread: onThumbnailArrive
</div>


<h2>组件通信</h2>

<p>通过接口进行隔离，均不产生强依赖关系。因为数据 都不复杂，所以用Consumer就可以了，具体的状态根据不同的场景定义一些enum即可。</p>

<h3>camera状态反馈</h3>

<p>用于隔离Scene和CameraAgent，反馈camera的连接状态，方便做一些与camera强相关的业务处理，比如一些事情（预览和拍照）只能是在camera处于连接状态才能做的事。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">cameraContext</span><span class="o">.</span><span class="na">openCamera</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">currentFacing</span><span class="o">,</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">onCameraAvailable</span><span class="o">();</span>
</span><span class='line'>        <span class="n">notifyStatus</span><span class="o">(</span><span class="n">SceneStatus</span><span class="o">.</span><span class="na">ACTIVE</span><span class="o">);</span>
</span><span class='line'>    <span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Scene状态反馈</h3>

<p>隔离UI和CameraScene，UI的状态，如一些按扭的可点态和显示与隐藏，以及一些显示内容需要知道CameraScene的状态，当CameraScene处于ACTIVE状态时UI才会完全处于可用态。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">SceneStatus</span><span class="o">&gt;</span> <span class="n">moduleStatusListener</span> <span class="o">=</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="n">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span>
</span><span class='line'>        <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">statusView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="n">status</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SceneStatus</span><span class="o">.</span><span class="na">ACTIVE</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">onSceneActive</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">onSceneInactive</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>预览尺寸变化 反馈</h3>

<p>比较纯，就是用于控制Surface的显示，它需要反馈当前预览的尺寸和比例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">CameraSize</span><span class="o">&gt;</span> <span class="n">previewSizeListener</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-&gt;</span> <span class="n">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span>
</span><span class='line'>        <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">viewFinder</span><span class="o">.</span><span class="na">setAspectRatio</span><span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="n">size</span><span class="o">.</span><span class="na">width</span><span class="o">)</span>
</span><span class='line'><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>拍照状态反馈</h3>

<p>这个仅在拍照时才需要。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">PhotoCaptureStatus</span><span class="o">&gt;</span> <span class="n">captureStatusListener</span> <span class="o">=</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;capture status &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
</span><span class='line'>    <span class="n">statusView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Capture Status: &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">STARTED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">overlayView</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="k">new</span> <span class="nf">ColorDrawable</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">argb</span><span class="o">(</span><span class="mi">150</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">255</span><span class="o">)));</span>
</span><span class='line'>        <span class="n">mainHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">overlayView</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="kc">null</span><span class="o">),</span> <span class="n">Config</span><span class="o">.</span><span class="na">CAPTURE_ANIM_DURATION</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">COMPLETED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setClickable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cameraSwitchView</span><span class="o">.</span><span class="na">setClickable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">FAILED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">setClickable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setClickable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cameraSwitchView</span><span class="o">.</span><span class="na">setClickable</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>后续计划</h2>

<p>架构仍需要优化，后面会加入新的功能，未完待续。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera2之录像]]></title>
    <link href="http://toughcoder.net/blog/2022/05/06/camera-2-record-video/"/>
    <updated>2022-05-06T22:38:03+08:00</updated>
    <id>http://toughcoder.net/blog/2022/05/06/camera-2-record-video</id>
    <content type="html"><![CDATA[<p><a href="http://toughcoder.net/blog/2022/04/24/camera-2-handling-3a-parameters/">前面的文章</a>都是集中在拍照模式，对于相机来说拍照与录像是两个最为基础的功能，这篇文章来看一下使用Camera2如何实现一个简单的录像功能。</p>

<p><a href="http://toughcoder.net/blog/2022/05/06/camera-2-record-video/"><img src="https://tse1-mm.cn.bing.net/th/id/R-C.d5e9195041cc351bd041464e996c1333?rik=kBPfq9at8eScog&riu=http%3a%2f%2fpublic.hudl.com%2fassets%2f562f9fbbd4c96106101813f7%2fbball_record.jpg&ehk=eigfVMaCv6ym1Sx4NimQfPnoJ%2frkdPMPlQrVoR9uFm8%3d&risl=&pid=ImgRaw&r=0" title="auto auto" ></a></p>

<!-- more -->


<h2>录像原理和流程</h2>

<p>录像相较于拍照来说，业务逻辑要稍简单一些，因为大部分功能的实现要靠<a href="https://developer.android.com/reference/android/media/MediaRecorder">MediaRecorder</a>。Camera2的API界线划分比较清楚，camera只负责输出图像帧，至于如何编码成为视频则是多媒体部分（也即MediaRecorder）的事情。</p>

<p>所以，实现录像功能，需要提供一个MediaRecorder，把其Surface作为camera的目标输出，同时作为MediaRecorder的输入，这就建立了它们的连接。</p>

<h3>录像的主要流程</h3>

<p>有以下几个关键的步骤需要做：</p>

<h4>1. 选择要使用的分辨率</h4>

<p>从CameraAgent中读取支持的分辨率。简单起见，可以用全高清来当默认值width=1920，height=1080，fps=30。</p>

<h4>2. 准备目标Surface</h4>

<p>可以用<a href="https://developer.android.com/reference/android/media/MediaCodec">MediaCodec</a>来创建一个Surface，用<a href="https://developer.android.com/reference/android/media/MediaCodec#createPersistentInputSurface(">createPersistentInputSurface</a>)方法，这个会传给CameraAgent用作配置session。</p>

<h4>3. 准备MediaRecorder</h4>

<p>创建实例，用步骤1作为video配置，步骤2 的Surface当作input surface，然后还要prepare，否则一些资源不会生效如Surface的buffer。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">setupMediaRecorder</span><span class="o">(</span><span class="n">VideoOutputConfig</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">recorderSurface</span> <span class="o">=</span> <span class="n">MediaCodec</span><span class="o">.</span><span class="na">createPersistentInputSurface</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mediaRecorder</span> <span class="o">=</span> <span class="n">createRecorder</span><span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">mode</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="n">mode</span><span class="o">.</span><span class="na">fps</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mediaRecorder</span><span class="o">.</span><span class="na">prepare</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;failed to prepare MediaRecorder: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="n">MediaRecorder</span> <span class="nf">createRecorder</span><span class="o">(</span><span class="kt">int</span> <span class="n">width</span><span class="o">,</span> <span class="kt">int</span> <span class="n">height</span><span class="o">,</span> <span class="kt">int</span> <span class="n">fps</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">MediaRecorder</span> <span class="n">recorder</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="n">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">S</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">recorder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MediaRecorder</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">recorder</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MediaRecorder</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setAudioSource</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">AudioSource</span><span class="o">.</span><span class="na">MIC</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setVideoSource</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">VideoSource</span><span class="o">.</span><span class="na">SURFACE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setOutputFormat</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">OutputFormat</span><span class="o">.</span><span class="na">MPEG_4</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setOutputFile</span><span class="o">(</span><span class="n">emptyVideoFile</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setVideoEncodingBitRate</span><span class="o">(</span><span class="mi">1_0_000_000</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setVideoSize</span><span class="o">(</span><span class="n">width</span><span class="o">,</span> <span class="n">height</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setVideoFrameRate</span><span class="o">(</span><span class="n">fps</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setVideoEncoder</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">VideoEncoder</span><span class="o">.</span><span class="na">H264</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setAudioEncoder</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">AudioEncoder</span><span class="o">.</span><span class="na">AAC</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setInputSurface</span><span class="o">(</span><span class="n">recorderSurface</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setOnErrorListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="n">recorder</span><span class="o">.</span><span class="na">setOnErrorListener</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">recorder</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>到此，Surface和MediaRecorder就处于ready状态了</p>

<h4>4. 使用常规view finder的Surface和第2步的Surface来启动预览</h4>

<p>就是启动常规的预览即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">cameraAgent</span><span class="o">.</span><span class="na">startPreview</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">previewSurface</span><span class="o">,</span> <span class="n">recorderSurface</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<h4>5. 现在就处于Ready状态了，可以随时录像</h4>

<h4>6. 调用MediaRecorder#start/stop/pause/resume来录像</h4>

<h2>录像的分辨率选择</h2>

<p>尺寸比例可以固定在16：9，因为这是较为通用的比例尺寸：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">VideoOutputConfig</span><span class="o">&gt;</span> <span class="nf">calculateVideoRecordMode</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StreamConfigurationMap</span> <span class="n">configurationMap</span> <span class="o">=</span> <span class="n">characteristics</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CameraCharacteristics</span><span class="o">.</span><span class="na">SCALER_STREAM_CONFIGURATION_MAP</span><span class="o">);</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">Size</span><span class="o">&gt;</span> <span class="n">supportedSizes</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">configurationMap</span><span class="o">.</span><span class="na">getOutputSizes</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">supportedSizes</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">size</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>                <span class="kd">final</span> <span class="kt">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">size</span><span class="o">.</span><span class="na">getWidth</span><span class="o">()</span> <span class="o">/</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">size</span><span class="o">.</span><span class="na">getHeight</span><span class="o">();</span>
</span><span class='line'>                <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">ratio</span> <span class="o">-</span> <span class="n">Config</span><span class="o">.</span><span class="na">PictureRatio</span><span class="o">.</span><span class="na">WIDE</span><span class="o">.</span><span class="na">ratio</span><span class="o">)</span> <span class="o">&lt;=</span> <span class="n">CameraSize</span><span class="o">.</span><span class="na">EPS</span><span class="o">;</span>
</span><span class='line'>            <span class="o">})</span>
</span><span class='line'>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">size</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>                <span class="kt">float</span> <span class="n">rfps</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">configurationMap</span><span class="o">.</span><span class="na">getOutputMinFrameDuration</span><span class="o">(</span><span class="n">MediaRecorder</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span> <span class="o">/</span> <span class="mi">1_000_000_000</span><span class="o">.</span><span class="mi">0</span><span class="n">f</span><span class="o">;</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">rfps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="n">f</span> <span class="o">?</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="mf">1.0f</span> <span class="o">/</span> <span class="n">rfps</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>                <span class="k">return</span> <span class="k">new</span> <span class="nf">VideoOutputConfig</span><span class="o">(</span><span class="n">size</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">size</span><span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span> <span class="n">fps</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}).</span><span class="na">filter</span><span class="o">(</span><span class="n">vrm</span> <span class="o">-&gt;</span> <span class="n">vrm</span><span class="o">.</span><span class="na">fps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>录像之闪光灯</h2>

<p>闪光灯主要是用于拍照，但录像也是支持闪光灯的，当然还是要看硬件的配置，如果characteristics.get(<a href="https://developer.android.com/reference/android/hardware/camera2/CameraCharacteristics#FLASH_INFO_AVAILABLE">CameraCharacteristics.FLASH_INFO_AVAILABLE</a>)为true，那就可以在录像中使用闪光灯，不过一般情况下，只有OFF和TORCH两种模式，因为录像是一个持续的输出帧的过程，其余的模式没有意义。</p>

<h2>开始录像之后的流程</h2>

<p>录像准备妥当后，准备目标文件，监听用户事件，按下快门后开始录像，再次点击后结束录像，然后释放MediaRecorder，最后把文件写入媒体数据库。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera2拍照之3A处理]]></title>
    <link href="http://toughcoder.net/blog/2022/04/24/camera-2-handling-3a-parameters/"/>
    <updated>2022-04-24T21:17:03+08:00</updated>
    <id>http://toughcoder.net/blog/2022/04/24/camera-2-handling-3a-parameters</id>
    <content type="html"><![CDATA[<p><a href="http://toughcoder.net/blog/2022/04/13/camera-2-take-snapshot/">前面一篇文章</a>介如了如何进行拍照，但那是最为基本的操作，还不够，作为相机还需要处理3A相关的参数和状态，以得到更好的拍照效果，这篇文章就来详细的学习一下如何处理最基础的3A。</p>

<p><a href="http://toughcoder.net/blog/2022/04/24/camera-2-handling-3a-parameters/"><img src="https://3q9z5d3wyxnn1bhwik46zlyr-wpengine.netdna-ssl.com/wp-content/uploads/2013/01/mattcameradiagram2.png" title="auto auto" ></a></p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<script>mermaid.initialize({startOnLoad:true});</script>




<!-- more -->


<h2><a href="https://source.android.com/devices/camera/camera3_3Amodes">基础知识</a></h2>

<p>3A，也即是AF &ndash; <a href="https://en.wikipedia.org/wiki/Autofocus">Auto Focus</a>（自动对焦）, <a href="https://www.sony.com/electronics/support/articles/00014979">AE</a> &ndash; Auto Exposure（自动爆光）和 AWB &ndash; Auto White Balance（自动白平衡），是拍照里面最为基础的三参数，对拍照的效果有直接影响。</p>

<p>大多数情况下，是不需要做特别的处理的，只要是一款合格的相机（无论是单反，卡片机，还是智能手机）都有自动模式，也就是说相机硬件系统会运行在一组自动的参数之下，也是默认的，基本的和常用的模式，用户不需要特别调整。只有在手动模式，或者称为高级模式的时候，才需要用户去设置特别的参数，以达到更为惊艳的拍照效果，或者应对更为复杂的拍摄条件，当然手动模式需要用户具备专业的知识，否则得到的拍摄效果会比auto模式还要差。</p>

<h2>常规的参数设置</h2>

<p> 旧的API中只需要从Camera对象中拿到Parameters对象，它像一个Map，更改其中的值就可以了。Camera 2略有变化 ，但总体思想是一样的，仍是类似于Map，键-值式的设置具体的参数，我们来看一下。</p>

<h3>关键的对象</h3>

<p>基类是<a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata?hl=en">CameraMetadata</a>，它里面以键-值形式定义了参数，类似于一个Map，但它的键并不是单纯的String，值也并不是简单的数据类型如整数或者字串，而是全部都搞成了对象，以一种比较复杂的泛型的方式搞出来的，但就具体使用上面与Map一样，就get/set就好了，虽然都是对象，但都能autobox。</p>

<div class="mermaid">
classDiagram
    CameraMetadata <|-- CaptureRequest
    CameraMetadata <|-- CaptureResult
    CaptureRequest *-- Builder
    
    class CameraMetadata {
    }
    
    class CaptureRequest {
    }
    
    class Builder {
    }
    
    class CaptureResult {
    }
</div>


<p>更为具体的，把下发参数都用<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest?hl=en">CaptureRequest</a>来封装，也就是说上层对底层下发的参数请求，放于此对象中；而从底层读参数的状态，或者说读取某些参数的值则放在了<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureResult?hl=en">CaptureResult</a>里面。</p>

<p>CaptureRequest通常是在下发请求时要去从其Builder中生成的；而CaptureResult则是在CaptureCallback中由底层传上来的。</p>

<h3>参数设置的流程</h3>

<p>根据不同的参数需要可以在预览时，或者拍照时下发参数，方法基本上是一样的，都是通过请求下去的：CameraCaptureSession#setRepeatingRequest，CameraCaptureSession#capture。</p>

<p>在下发请求前需要通过<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest.Builder?hl=en">CaptureRequest#Builder</a>创建请求，而参数就是在此时以键-值方式设置下去的。CaptureRequest是一个Immutable的对象，只能过构建者模式Builder来改变和生成。</p>

<div class="mermaid">
sequenceDiagram
    CameraAgent -&gt;> CameraDevice: createCaptureRequest
    CameraDevice -&#45;&gt;> CameraAgent: CaptureRequest.Builder
    CameraAgent -&gt;> CameraCaptureSession: setRepeatingRequest
    CameraAgent -&gt;> CameraCaptureSession: capture
    CameraCaptureSession -&#45;&gt;> CameraAgent: CaptureCallback.onCaptureStarted
    CameraCaptureSession -&#45;&gt;> CameraAgent: CaptureCallback.onCaptureProgressed
    CameraCaptureSession -&#45;&gt;> CameraAgent: CaptureCallback.onCaptureCompleted
</div>


<h3>常见的预览参数设置</h3>

<p>把3A都设置为Auto即可，能满足需求：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyCommonParameters</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_MODE_AUTO</span><span class="o">);</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AF_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AF_MODE_CONTINUOUS_PICTURE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AWB_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AWB_MODE_AUTO</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">applyForPreview</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">previewBuilder</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">applyCommonParameters</span><span class="o">(</span><span class="n">previewBuilder</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">previewBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE_ON</span><span class="o">);</span>
</span><span class='line'>    <span class="n">previewBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_PRECAPTURE_TRIGGER</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_PRECAPTURE_TRIGGER_IDLE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">previewBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_LOCK</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">previewBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_CAPTURE_INTENT</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_CAPTURE_INTENT_PREVIEW</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">applyFlashMode</span><span class="o">(</span><span class="n">previewBuilder</span><span class="o">,</span> <span class="n">ApplyType</span><span class="o">.</span><span class="na">PREVIEW</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>常见的拍照参数设置</h3>

<p>相较于preview无明显变化，只不过需要添加一些成片相关的设置，如图片质量，旋转等：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">applyForStillCapture</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">applyCommonParameters</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">JPEG_QUALITY</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)</span> <span class="mi">92</span><span class="o">);</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">JPEG_ORIENTATION</span><span class="o">,</span> <span class="n">jpegRotation</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_CAPTURE_INTENT</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_CAPTURE_INTENT_STILL_CAPTURE</span><span class="o">);</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_PRECAPTURE_TRIGGER</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_PRECAPTURE_TRIGGER_IDLE</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">applyFlashMode</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">,</span> <span class="n">ApplyType</span><span class="o">.</span><span class="na">CAPTURE</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果就是普通的拍照需求，以上这次常规的参数设置就足够了。</p>

<h2>闪光灯</h2>

<p>闪光灯是拍照过程中非常重要的参数，也会显著的影响拍照效果，但与旧的Camera不同，Camera 2中打闪的过程比较复杂，并不是把四种闪光灯模式设置下去就能完事儿的，还涉及AE状态的处理，需要仔细学习和研究。</p>

<p>闪光灯模式，现代的闪光灯共有四种模式：关闭，自动，打开和常亮：</p>

<ul>
<li>关闭 &ndash; 也就是关闭闪光灯，无论什么条件下都不打闪</li>
<li>自动 &ndash; 拍照时，依据AE自动爆光时的光线情况，决定是否需要打闪</li>
<li>打开 &ndash; 拍照时，打闪</li>
<li>常亮 &ndash; 像手电筒一样一直打开闪光灯，预览和拍照时都可生效。注意不能常亮时间太长，否则会引起手机温度过高，耗电过快，甚至可能此起主板烧断。</li>
</ul>


<p>通过在CaptureRequest中设置，键为<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest?hl=en#FLASH_MODE">CaptureRequest.FLASH_MODE</a>，但与旧的不一样，它的值只有三个：</p>

<ul>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata?hl=en#FLASH_MODE_OFF">FLASH_MODE_OFF</a></li>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata?hl=en#FLASH_MODE_SINGLE">FLASH_MODE_SINGLE</a></li>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata?hl=en#FLASH_MODE_TORCH">FLASH_MODE_TORCH</a></li>
</ul>


<p>与预期的四种模式并不匹配，并且如果你下发上面的模式会发现，OFF和TORCH还是符合预期的，分别对应着关闭和常亮。但是即使是SINGLE也并不是打开，它打闪的时间很短，拍照还没有完成就一闪而过，并且具体的打闪的时机，似乎与AE过程并不匹配。前面提到了闪光灯是与自动爆光（AE）过程关联特别大的，只有当AE收敛后打闪才是最合适的时机，并且打闪过程要持续到拍照结束。这里涉及AE状态的处理，并且真实下发的FLASH_MODE并不是SINGLE。</p>

<p><strong>注意</strong>：闪光灯的自动和打开状态仅对拍照过程生效，预览过程是不生效的，所以设置什么值都一样。下面的讨论也是针对拍照过程中的。</p>

<h3>闪光灯打开模式实现方法</h3>

<p>仔细查阅文档可以发现，自动和打开，其实与AE有关，并且AE有两种模式疑似与闪光灯有关系：</p>

<ol>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_MODE_ON_AUTO_FLASH">ON_AUTO_FLASH</a></li>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_MODE_ON_ALWAYS_FLASH">ON_ALWAYS_FLASH</a></li>
<li><a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_MODE_ON_AUTO_FLASH_REDEYE">ON_AUTO_FLASH_REDEYE</a></li>
</ol>


<p>但直接把AE设置为以上的方式，也不能实现自动打闪和打闪，这两种情况与AE强相关，受AE状态控制，需要处理AE的状态，依据状态的不同然后换思路去实现。</p>

<p>一种实现方式是，真实下发的闪光灯状态是TORCH，但要受AE状态来控制，先触发<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest?hl=en#CONTROL_AE_PRECAPTURE_TRIGGER">AE_PRECAPTURE_TRIGGER</a>，然后监听AE状态变化，当其从<a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_STATE_SEARCHING">SEARCHING</a>变为<a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_STATE_CONVERGED">收敛</a>时，或者变为<a href="https://developer.android.com/reference/android/hardware/camera2/CameraMetadata#CONTROL_AE_STATE_FLASH_REQUIRED">FLASH_REQUIRED</a>时，就直接下发TORCH，直到拍照结束onCaptureCompleted，恢复为正常的状态。</p>

<div class="mermaid">
flowchart TD
    capturePhoto -&#45;> flashMode
    flashMode{FlashMode is ON or AUTO}
    flashMode == No ==> doCapture
    flashMode == Yes ==> preCapture
    preCapture[capture with request<br/>AE_PRECAPTURE_TRIGGER to START]
    preCapture -&#45;> aeSearching
    aeSearching[AE state is searching]
    aeSearching -&#45;> aeConverged
    aeConverged[AE state is converged or flashRequired]
    aeConverged -&#45;> flashTorch
    flashTorch[set flashMode to TORCH]
    flashTorch -&#45;> doCapture
    doCapture -&#45;> onCaptureCompleted
    onCaptureCompleted -&#45;> flashSingle
    flashSingle[set flashMode to SINGLE]
</div>


<p>需要注意的是，预拍照请求是通过单次请求capture下发的，其CaptureCallback可以与预览使用同一个。另外就是AE收敛过程的处理是在onCaptureProgressed中处理的，而其最终的状态是在onCaptureCompleted中的。</p>

<h3>闪灯光自动模式实现方式</h3>

<p>自动模式，与打开时类似，也是当需要打闪的时候直接下发TORCH，只不过，需要在预拍照时，看到AE的状态为FLASH_REQUIRED时，再去下发TORCH，否则就是OFF。</p>

<div class="mermaid">
sequenceDiagram
    CameraAgent -&gt;> CameraCaptureSession: capture AE_PRECAPTURE START
    CameraCaptureSession -&#45;&gt;> CameraAgent: onCaptureProgressed AE PRECAPTURE
    CameraCaptureSession -&#45;&gt;> CameraAgent: onCaptureProgressed AE SEARCHING
    CameraCaptureSession -&#45;&gt;> CameraAgent: onCaptureProgressed AE CONVERGED
    CameraCaptureSession -&#45;&gt;> CameraAgent: onCaptureProgressed AE FLASH_REQUIRED
    CameraAgent -&gt;> CameraCaptureSession: capture FLASH TORCH
    CameraCaptureSession -&#45;&gt;> CameraAgent: onCaptureCompleted
    CameraAgent -&gt;> CameraCaptureSession: setRepeatRequest FLASH SINGLE or OFF
</div>


<p><br/>
总结以上，那么下发flash mode需要做一些修改：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">applyFlashMode</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span><span class="o">,</span> <span class="n">ApplyType</span> <span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;applyFlashMode mode &quot;</span> <span class="o">+</span> <span class="n">flashMode</span> <span class="o">+</span> <span class="s">&quot;, applyType &quot;</span> <span class="o">+</span> <span class="n">type</span><span class="o">);</span>
</span><span class='line'>    <span class="n">FlashMode</span> <span class="n">applyFlashMode</span> <span class="o">=</span> <span class="n">flashMode</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">switch</span> <span class="o">(</span><span class="n">type</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">PRECAPTURE:</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">CAPTURE:</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">((</span><span class="n">flashMode</span> <span class="o">==</span> <span class="n">FlashMode</span><span class="o">.</span><span class="na">AUTO</span> <span class="o">||</span> <span class="n">flashMode</span> <span class="o">==</span> <span class="n">FlashMode</span><span class="o">.</span><span class="na">ON</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">flashRequired</span><span class="o">)</span>  <span class="o">{</span>
</span><span class='line'>                <span class="n">applyFlashMode</span> <span class="o">=</span> <span class="n">FlashMode</span><span class="o">.</span><span class="na">TORCH</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>        <span class="k">default</span><span class="o">:</span>
</span><span class='line'>            <span class="k">break</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;applyFlashMode apply flash mode &quot;</span> <span class="o">+</span> <span class="n">applyFlashMode</span><span class="o">);</span>
</span><span class='line'>    <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">FLASH_MODE</span><span class="o">,</span> <span class="n">applyFlashMode</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">applyFlashMode</span> <span class="o">==</span> <span class="n">FlashMode</span><span class="o">.</span><span class="na">AUTO</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE_ON_AUTO_FLASH</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">applyFlashMode</span> <span class="o">==</span> <span class="n">FlashMode</span><span class="o">.</span><span class="na">ON</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE_ON_ALWAYS_FLASH</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE</span><span class="o">,</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AE_MODE_ON</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于打闪需要，现在capturePhoto方法已变成了三个方法，或者分为三个主要的步骤，一是预拍照，二是拍照，三是拍照后的流程：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">capturePhoto</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">PhotoCaptureStatus</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">,</span> <span class="n">PhotoSaveAgent</span> <span class="n">imageSaveAgent</span><span class="o">,</span> <span class="kt">int</span> <span class="n">orientation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;takeSnapshot&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(!</span><span class="n">cameraDevice</span><span class="o">.</span><span class="na">isPresent</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">captureSession</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;takeSnapshot, cannot snap&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">consumer</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">parameters</span><span class="o">.</span><span class="na">setFlashRequired</span><span class="o">(</span><span class="n">previewCallback</span><span class="o">.</span><span class="na">flashRequired</span><span class="o">());</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">needPreCapture</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="na">needPreCapture</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Runnable</span> <span class="n">actionPostCapture</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">needPreCapture</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">actionPostCapture</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;postCapture reset flash status for post capture.&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">parameters</span><span class="o">.</span><span class="na">applyForPreview</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">);</span>
</span><span class='line'>            <span class="n">previewCallback</span><span class="o">.</span><span class="na">setAEState</span><span class="o">(</span><span class="n">CameraParameters</span><span class="o">.</span><span class="na">Preview3AState</span><span class="o">.</span><span class="na">PICTURE_TAKEN</span><span class="o">);</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">captureSession</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">setRepeatingRequest</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">previewCallback</span><span class="o">,</span> <span class="n">cameraHandler</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">jpegOrientation</span> <span class="o">=</span> <span class="n">CameraUtils</span><span class="o">.</span><span class="na">calculateRelativeRotation</span><span class="o">(</span><span class="n">characteristics</span><span class="o">,</span> <span class="n">orientation</span><span class="o">);</span>
</span><span class='line'>    <span class="n">parameters</span><span class="o">.</span><span class="na">setJpegRotation</span><span class="o">(</span><span class="n">jpegOrientation</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="n">PhotoStillCapture</span> <span class="n">stillCapture</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PhotoStillCapture</span><span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">imageSaveAgent</span><span class="o">,</span> <span class="n">actionPostCapture</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">action</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;capture doCapture&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">captureSession</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">capture</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">stillCapture</span><span class="o">.</span><span class="na">generateRequest</span><span class="o">(</span><span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">(),</span> <span class="n">imageSaveAgent</span><span class="o">.</span><span class="na">getOutputTarget</span><span class="o">(),</span> <span class="n">parameters</span><span class="o">),</span>
</span><span class='line'>                    <span class="n">stillCapture</span><span class="o">.</span><span class="na">getCaptureCallback</span><span class="o">(),</span>
</span><span class='line'>                    <span class="n">cameraHandler</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">needPreCapture</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">pendingCaptureAction</span> <span class="o">=</span> <span class="n">action</span><span class="o">;</span>
</span><span class='line'>        <span class="n">preCapture</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">action</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>        <span class="n">pendingCaptureAction</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">preCapture</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;preCapture&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">createCaptureRequest</span><span class="o">(</span><span class="n">CameraDevice</span><span class="o">.</span><span class="na">TEMPLATE_PREVIEW</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">Surface</span> <span class="n">surface</span> <span class="o">:</span> <span class="n">previewSurfaces</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">builder</span><span class="o">.</span><span class="na">addTarget</span><span class="o">(</span><span class="n">surface</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">parameters</span><span class="o">.</span><span class="na">applyForPreCapture</span><span class="o">(</span><span class="n">builder</span><span class="o">);</span>
</span><span class='line'>        <span class="n">previewCallback</span><span class="o">.</span><span class="na">setAEState</span><span class="o">(</span><span class="n">CameraParameters</span><span class="o">.</span><span class="na">Preview3AState</span><span class="o">.</span><span class="na">WAITING_PRECAPTURE</span><span class="o">);</span>
</span><span class='line'>        <span class="n">captureSession</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">capture</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">previewCallback</span><span class="o">,</span> <span class="n">cameraHandler</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>CameraParameters对象</h2>

<p>为了方便3A以及拍照参数的管理，创建一个新的对象CameraParameters专门用于预览和拍照相关的参数和配置管理。此对象仅与CameraAgent交互，并且由CameraAgent持有。</p>

<div class="mermaid">
classDiagram
    PhotoStillCapture *&#45;- CameraParameters
    CameraAgent *&#45;- CameraParameters
    
    class CameraParameters {
    }
    
    class PhotoStillCapture {
    }
    
    class CameraAgent {
    }
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android ADB Made Easy]]></title>
    <link href="http://toughcoder.net/blog/2022/04/14/android-adb-made-easy/"/>
    <updated>2022-04-14T22:35:57+08:00</updated>
    <id>http://toughcoder.net/blog/2022/04/14/android-adb-made-easy</id>
    <content type="html"><![CDATA[<h2>Android ADB 命令大全</h2>

<p>ADB意即Android Debug Bridge是安卓开发（不止是应用开发）最为常用的工具，这里将总结一下该命令的使用。</p>

<p><a href="http://toughcoder.net/blog/2022/04/14/android-adb-made-easy/"><img src="https://tse1-mm.cn.bing.net/th/id/R-C.104b94c261017f8ecfad7fc7fcb9015e?rik=vQKR84tQzptEUA&riu=http%3a%2f%2fdriverslab.ru%2fimages%2fpost%2fandroid_adb.png&ehk=D9ws5sG7Gj7E%2bpfEQsJTjHS6MIem4%2f0P9z69aI6R7GA%3d&risl=&pid=ImgRaw&r=0&sres=1&sresct=1" title="auto auto" ></a></p>

<!-- more -->


<h2>比较有用的常规命令</h2>

<table>
<thead>
<tr>
<th> Commands </th>
<th> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Usage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th> Descriptions </th>
</tr>
</thead>
<tbody>
<tr>
<td> adb wait-for-devices </td>
<td> </td>
<td> 等待设备，只有设备成功连接后才停止等待 </td>
</tr>
<tr>
<td> adb devices </td>
<td> </td>
<td> 列出当前所有已连接的设备 </td>
</tr>
<tr>
<td> adb logcat -c </td>
<td> </td>
<td> 清除logcat的buffer </td>
</tr>
</tbody>
</table>


<h2>参考资料</h2>

<ul>
<li><a href="https://adbshell.com/commands">ADB Shell</a></li>
<li><a href="https://www.cnblogs.com/sjjg/p/6028580.html">adb shell 大全</a></li>
<li><a href="https://developer.android.com/studio/command-line/adb">官方教程 Android Debug Bridge</a></li>
<li><a href="https://gist.github.com/Pulimet/5013acf2cd5b28e55036c82c91bd56d8">Adb useful commands list</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera 2学习之拍照基础]]></title>
    <link href="http://toughcoder.net/blog/2022/04/13/camera-2-take-snapshot/"/>
    <updated>2022-04-13T21:31:01+08:00</updated>
    <id>http://toughcoder.net/blog/2022/04/13/camera-2-take-snapshot</id>
    <content type="html"><![CDATA[<p>前面<a href="http://toughcoder.net/blog/2022/03/04/camera-2-preview-and-improvement/">一篇文章</a>讲解了如何建立预览，下一步就是进行拍照了，这是相机类的核心业务，TL;DR。</p>

<p><a href="http://toughcoder.net/blog/2022/04/13/camera-2-take-snapshot/"><img src="https://tse4-mm.cn.bing.net/th/id/OIP-C.teE5837-ZJPLgV6e410swAHaFN?pid=ImgDet&rs=1" title="auto auto" ></a></p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<script>mermaid.initialize({startOnLoad:true});</script>




<!-- more -->


<h2>拍照的基本流程</h2>

<p>先简单的总结 一下，有个印象，后面会逐一详细的讲解：</p>

<ol>
<li>需要一个目标输出，以接收camera的输出。Camera2的API界线划分的比较清楚，Camera只负责拍照成像，并且输出的结果不再像以前那样直接返回一个jpeg byte array，是一个中间结果，需要一个目标输出进行收集并处理。</li>
<li>需要一个CameraCaptureSession.CaptureCallback，以监听拍照流程状态</li>
<li>需要存储模块做最终的结果保存</li>
</ol>


<p>整体架构图：</p>

<div class="mermaid">
classDiagram
    OnImageAvailableListener  <|-- PhotoSaveAgent
    PhotoWriteTask --|> Runnable
    PhotoResultObserver <|-- PhotoSaveAgent
    PhotoSaveAgent ..|> PhotoWriteTask
    CaptureCallback  <|-- PhotoStillCapture
    PhotoSaveAgent *-- PhotoResult
    PhotoWriteTask *-- PhotoResult
    PhotoResultObserver --* PhotoStillCapture   
    class PhotoSaveAgent {
        imageReader
        photoQueue
        executor
        +config(int width, int height, int format)
        +Surface getOutputTarget()
        onImageAvailable()
        onCaptureStart()
        onCaptureComplete()
    }
    
    class OnImageAvailableListener {
        &lt;&lt;interface&gt;&gt;
        onImageAvailable(Image image)
    }
    
    class Runnable {
        &lt;&lt;interface&gt;&gt;
        run()
    }
    
    class PhotoWriteTask {
        &lt;&lt;interface&gt;&gt;
        run()
    }
    
    class PhotoResultObserver {
        &lt;&lt;interface&gt;&gt;
        onCaptureStart(CaptureRequest request, long timestamp, long frame, String filename)
        onCaptureComplete(CaptureRequest request, CaptureResult result)
    }
    
    class PhotoResult {
        CaptureRequest captureRequest
        long timestamp
        long frameNumber
        String filename
        CaptureResult captureResult
        Image image
    }
    
    class CaptureCallback {
        &lt;&lt;interface&gt;&gt;
        onCaptureStarted()
        onCaptureProgressed()
        onCaptureCompleted()
        onCaptureFailed()
    }
    
    class PhotoStillCapture {
        Date dateTaken
        String filename
        Consumer consumer
        PhotoResultObserver resultObserver
        +generateRequest()
        +generateCaptureCallback()
    }
</div>


<h2>存储模块</h2>

<p>存储模块的主要职责是提供目标输出给CameraAgent，收集拍照结果，并做后续的保存工作。它与CameraAgent是独立开来的，并没有直接的关系。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>save
</span><span class='line'>  |-- PhotoSaveAgent
</span><span class='line'>  |-- PhotoWriteTask</span></code></pre></td></tr></table></div></figure>


<h3>关键的组件</h3>

<h4>ImageReader拍照结果收集器</h4>

<h4>PhotoSaveAgent用以封装和对外交互</h4>

<h4>PhotoWriteTask专门负责把jpeg结果进行文件保存和媒体库的记录创建</h4>

<h4>结果队列</h4>

<p>因为结果会来源于ImageReader#OnImageAvailable和onCaptureComplete，需要合并两个异步回调的以合成最终结果，并且两个回调均是异步的，先后顺序 也不一样，因此需要一个队列。</p>

<p>因为查询比较多，所以，这里用一个哈希表来当作队列，键为CaptureRequest，而值为PhotoResult。</p>

<h3>线程模型</h3>

<p>会有一个HandlerThread，以保证存储模块相关的操作全部都发生在自己的HandlerThread里面，这里存储模块的主要的工作线程。当与外部交互 时，特别是有外部的回调过来时，都要及时的转入自己的工作线程进行后续处理，以保证线程的安全性。</p>

<p>ImageReader的回调OnImageAvailable也要放在自己的工作线程中。</p>

<p>还需要一个线程池专门用于jpeg结果的保存。因为文件的I/O是CPU密集型的耗时操作，如果放在主工作线程中，会造成阻塞，并且可能会多个拍照结果要处理，所以需要一个专门的线程池。</p>

<h3>对外交互</h3>

<h4>接收camera size</h4>

<p>因为创建ImageReader时需要指定一个尺寸，而这个尺寸必须 来自于camera，也就是说必须 是camera针对 某一配置所能支持的尺寸，并要符合一定的约束。这个尺寸最终会作用到目标输出Surface上面，从而影响拍照结果。</p>

<h4>提供一个返回Surface的接口给外部</h4>

<p>Camera 2的所有输出都是以Surface形式的中间结果（实质上都是一些buffer），所以需要提供一个Surface给CameraAgent。这个Surface可以从创建好了的ImageReader中直接获取。</p>

<h4>实现一个拍照结果观察者</h4>

<p>除了上述三个以外，不暴露任何公开的方法。</p>

<h3>主要工作流程</h3>

<p>此模块需要在Activity中进行初始化，和生命周期的管理，比如在onCreate时进行初始化，在onDestroy中进行销毁。</p>

<p>初始化时，要先准备工作线程HandlerThread，并启动。之后要把初始化工作都尽可能的放在工作线程中，以不阻塞外部调用线程。</p>

<p>之后是创建ImageReader，这个需要外部输入尺寸，一旦ImageReader创建完成，就会处于ready状态。</p>

<p>PhotoSaveAgent是对外交互的对象，在CameraContext中会使用此对象，主要是：</p>

<ol>
<li>当CameraAgent对象创建好了后，计算出来了picture size后，通知camera size给PhotoSaveAgent，PhotoSaveAgent知道此size后便可以创建ImageReader</li>
<li>拍照时，获取目标输出Surface，来源是第1步创建好后的ImageReader</li>
<li>拍照时接收拍照状态</li>
</ol>


<div class="mermaid">
stateDiagram-v2
    [*] &#45;&#45;> Setup
    Setup &#45;&#45;> Config
    Config &#45;&#45;> ReadyForImage
    ReadyForImage &#45;&#45;> CollectPhotoResult
    CollectPhotoResult &#45;&#45;> SavePhoto
    SavePhoto &#45;&#45;> ReadyForImage
    SavePhoto &#45;&#45;> TearDown
    TearDown &#45;&#45;> [*]
</div>


<h4>拍照结果收集</h4>

<p>一旦PhotoSaveAgent处于ready状态后，就可以随时收集拍照结果，拍照的结果全部是以回调的形式被动通知的，二个是来自于拍照模块，一个是ImageReader：</p>

<ol>
<li>拍照开始</li>
<li>拍照结束</li>
<li>ImageReader通知onImageAvailable</li>
</ol>


<p>需要注意，前面的三个回调拍照开始肯定 最先来，但后面的拍照结束和onImageAvailable谁先谁后真不一定，理论上来说是拍照结束来的早一些，但也不绝对，因此在逻辑处理上不能强依赖这两者的午后顺序。</p>

<p>主要的流程是：</p>

<ol>
<li>拍照开始时，在结果队列中添加记录，以CaptureRequest为key，并创建PhotoResult对象；</li>
<li>拍照结束回调中，以CaptureRequest为key，查询结果，向PhotoResult对象添加CaptureResult，并检查PhotoResult的状态，如果PhotoResult的CaptureResult和Image对象都齐全了，就说明拍照结果已集齐，这时就可以移除队列并进行保存了；</li>
<li>在onImageAvailable中，流程稍复杂些，因为这个回调只有一个Image对象，需要与队列中的PhotoResult对象进行匹配，就是通过拍照时的timestamp进行匹配，这是唯一的标识了，遍历队列，如果找到了就更新PhotoResult，并检查是否集齐，如已集齐则移除队列并进行结果保存。</li>
</ol>


<p>另外需要注意的是，拍照开始和拍照结束两个回调的调用线程不确定，所以需要进行转换，先转到PhotoSaveAgent的工作线程中再去处理，这样可以保证PhotoSaveAgent的所有操作都在自己的线程中，不需要再做额外的线程安全性保护。</p>

<h4>拍照结果保存</h4>

<p>在拍照结果回调中，以及onImageAvailable回调中检查PhotoResult是否集齐，集齐后，就可以进行结果保存。</p>

<p>主要流程如下：</p>

<ol>
<li>创建PhotoWriteTask，它实现了Runnable接口，以方便在线程池中使用</li>
<li>向线程池提交任务</li>
<li>在创建任务的时候，要把需要的信息都保存下来。特别需要注意的是，需要从Image中把jpeg byte array拷贝出来。因为ImageReader内部会用Image池子去不断的接收从外部输入（拍照时就是camera sensor）的结果，所以onImageAvailable中传过来的Image需要尽快的释放（即Image#close），以保证ImageReader能正常工作。PhotoWriteTask虽然是单独的线程池，但文件的I/O过程不可控，可能长也可能短，假如简单的持有Image对象，可能会导致Image对象无法及时被释放，从而导致ImageReader不能正常工作。因此需要在创建任务的时候就赶紧把jpeg bytes从Image中拷贝出来。</li>
<li>具体的写入过程比较清晰，向MediaProvider中写入文件即可。</li>
</ol>


<h2>拍照模块</h2>

<p>这是最为核心的一部分。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>snapshot
</span><span class='line'>    |-- PhotoCaptureStatus
</span><span class='line'>    |-- PhotoResult
</span><span class='line'>    |-- PhotoResultObserver
</span><span class='line'>    |-- PhotoStillCapture</span></code></pre></td></tr></table></div></figure>


<h3>关键组件</h3>

<ol>
<li>PhotoResultObserver，拍照结果观察者接口，用于向外部通知拍照结果，两个方法，一个是拍照开始，一个是拍照结束。注意拍照失败也是调用拍照结束，只不过没有CaptureResult。</li>
<li>PhotoResult，这是合成后的拍照结果对象，里面包含着拍照结果的一切信息，如文件名，参数，CaptureRequest，CaptureResult和Image。是一个POJO，仅做状态和数据的保存，无逻辑。</li>
<li>PhotoStillCapture，可理解为拍照对象，用以封装拍照参数，生成CaptureRequest和处理CaptureCallback。</li>
</ol>


<h3>线程模型</h3>

<p>这属于核心业务，所以它是在CameraContext的工作线程中的。</p>

<h3>对外交互</h3>

<p>通过PhotoResultObserver来通知外部拍照的结果状态。</p>

<h3>工作流程</h3>

<p>CameraContext中拉回拍照接口，并转入到自己的工作线程中。CameraAgent增加拍照接口，这是主要的功能入口。</p>

<div class="mermaid">
sequenceDiagram
    CameraActivity ->> CameraAgent: takePhoto
    CameraAgent ->> PhotoSaveAgent: getOutputTarget
    CameraAgent -&#45;>> CameraActivity: started
    CameraAgent -&#45;>> CameraActivity: ongoing
    CameraAgent -&#45;>> PhotoSaveAgent: onCaptureStart
    CameraAgent -&#45;>> CameraActivity: completed
    CameraAgent -&#45;>> PhotoSaveAgent: onCaptureComplete
    PhotoSaveAgent ->> PhotoWriteTask: savePhoto
    PhotoWriteTask -&#45;>> CameraActivity: thumbnailArrived
</div>


<p>CameraAgent会在其capturePhoto方法，创建一个PhotoStillCapture对象，然后调用CameraCaptureSession#capture方法进行拍照。拍照请求由PhotoStillCapture生成，CaptureCallback亦由PhotoStillCapture对象处理。</p>

<p>创建PhotoStillCapture对象是会锁定一些参数，如当前的旋转，文件名字（通常以时间戳为文件名字）， 以及PhotoResultObserver。</p>

<p>生成拍照请求CaptureRequest时，会传入一些拍照需要的参数，如旋转，如图片质量等等。</p>

<p>在CatpureCallback中，做一些简单处理，然后回调PhotoResultObserver。</p>

<p>到此，拍照模块的事情 就做完，它就要是拍照的前期工作，与外部做连接，下发请求就基本上完整了。拍照结果的收集则是存储模块的事情 了。</p>

<h2>状态反馈</h2>

<p>从整个拍照交互来说，也是需要状态反馈的，最为基础的交互逻辑是，为了保证拍照的成功率，当下发拍照请求后，到拍照结束前，也就是CaptureCallback#onCaptureCompleted或者CaptureCallback#onCaptureFailed这两个回调回来之前，是不可以下发新的拍照请求的。</p>

<div class="mermaid">
classDiagram
    CameraActivity &#45;&#45;|> Consumer
    Consumer &#45;&#45;&ast; PhotoStillCapture
    CaptureCallback <|&#45;&#45; PhotoStillCapture
    
    class Consumer {
        &lt;&lt;interface&gt;&gt;
        +accept(PhotoCaptureStatus status)
    }
    
    class CameraActivity {
    }
    
    class PhotoStillCapture {
        consumer
    }
    
    class CaptureCallback {
        &lt;&lt;interface&gt;&gt;
        onCaptureStarted()
        onCaptureProgressed()
        onCaptureCompleted()
        onCaptureFailed()
    }
</div>


<p>那么交互 层面也需要知道拍照状态，以方便进行UI管控，比如说当下发了拍照请求后，就把快门shutter设置为disabled，在拍照结束后再恢复为enabled的；此外还有拍照动画，也需要知道状态。</p>

<p>但UI交互层只知道状态就可以了，并不需要特别的数据，所以 这一路的状态通过简单的Consumer即可实现，仅在拍照模块中定义一些简单的状态就可以了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">enum</span> <span class="n">PhotoCaptureStatus</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">STARTED</span><span class="o">,</span>
</span><span class='line'>    <span class="n">ONGOING</span><span class="o">,</span>
</span><span class='line'>    <span class="n">FAILED</span><span class="o">,</span>
</span><span class='line'>    <span class="n">COMPLETED</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为拍照是由UI层触发的，所以在调用CameraContext时，就提供一个接收状态的Consumer就可以了，这样就把UI层和逻辑层分离开了，逻辑层接收Consumer作为参数，在关键的节点就回报状态；UI层负责处理感兴趣的状态就可以了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">takePhoto</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cameraFactory</span><span class="o">.</span><span class="na">takePhoto</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="n">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">captureStatusListener</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">status</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然别忘记了，在Consumer中要做线程切换，UI的处理只以在主线程中。</p>

<h2>缩略图处理</h2>

<p>缩短略图是一个非常重要的拍照结果展示，用以告诉用户拍照成功了，并且是预览结果成片的入口，因此需要做二个事情：</p>

<ol>
<li>监听拍照结果，注意这里并不是说要监听拍照状态，而是要监听拍照结果，因为只有得到最终结果jpeg array后，才可以从这里创建缩略图，并展示 出来。</li>
<li>点击缩略图时要能够进行结果成片的展示，所以，还需要知道拍照结果的文件路径，或者说Uri</li>
</ol>


<p>以上两个信息，都在PhotoSaveAgent里面，因此需要建立UI层与存储模块之间的连接，但其实存储层只是一个数据来源，它并不负责缩略图的业务，而且缩略图的来源可能的不止存储模块，还能来源于直接的数据库查询。</p>

<div class="mermaid">
classDiagram
    ThumbnailObserver <|-- CameraActivity
    CameraActivity --* Thumbnail
    ThumbnailObserver --* PhotoSaveAgent
    
    class CameraActivity {
        thumbnailArrived(Thumbnail thumbnaill)
    }
    
    class PhotoSaveAgent {
        +addThumbnailObserver()
    }
    
    class Thumbnail {
        bitmap
        uri
    }
    
    class ThumbnailObserver {
        &lt;&lt;interface&gt;&gt;
        thumbnailArrived(Thumbnail thumbnail)
    }
</div>


<p>为此，新建一个缩略图模块，里面有一个Thumbnail对象，是一个POJO用以代表缩略图的相关信息，如Bitmap和Uri；还有一个ThumbnailObserver的接口，用以让数据源告诉观察者，一个新的缩略图对象生成了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thumbnail</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Uri</span> <span class="n">uri</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">mime</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">Thumbnail</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">,</span> <span class="n">String</span> <span class="n">mime</span><span class="o">,</span> <span class="n">Bitmap</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">mime</span> <span class="o">=</span> <span class="n">mime</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">bitmap</span> <span class="o">=</span> <span class="n">bitmap</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Bitmap</span> <span class="nf">getBitmap</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">bitmap</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Intent</span> <span class="nf">generateAction</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_VIEW</span><span class="o">);</span>
</span><span class='line'>        <span class="n">intent</span><span class="o">.</span><span class="na">setDataAndType</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">mime</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">intent</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ThumbnailObserver</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">thumbnailArrived</span><span class="o">(</span><span class="n">Thumbnail</span> <span class="n">thumbnail</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此，UI层与PhotoSaveAgent就分离开来了，它们之间的联系只有ThumbnailObserver接口，UI层就实现接口，负责收到缩略图后的展示工作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">private</span> <span class="kd">final</span> <span class="n">ThumbnailObserver</span> <span class="n">thumbnailObserver</span> <span class="o">=</span> <span class="n">thumbnail</span> <span class="o">-&gt;</span> <span class="n">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">updateThumbnail</span><span class="o">(</span><span class="n">thumbnail</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">updateThumbnail</span><span class="o">(</span><span class="n">Thumbnail</span> <span class="n">thumbnail</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">setTag</span><span class="o">(</span><span class="n">thumbnail</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="o">((</span><span class="n">ImageView</span><span class="o">)</span> <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">getNextView</span><span class="o">()).</span><span class="na">setImageBitmap</span><span class="o">(</span><span class="n">thumbnail</span><span class="o">.</span><span class="na">getBitmap</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">showNext</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// when init PhotoSaveAgent, register the thumbnail observer</span>
</span><span class='line'>    <span class="n">imageSaveAgent</span><span class="o">.</span><span class="na">addThumbnailObserver</span><span class="o">(</span><span class="n">thumbnailObserver</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">viewLastPhoto</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">getTag</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;No thumbnail, you should take photo first.&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">Thumbnail</span> <span class="n">thumbnail</span> <span class="o">=</span> <span class="o">(</span><span class="n">Thumbnail</span><span class="o">)</span> <span class="n">thumbnailSwitcher</span><span class="o">.</span><span class="na">getTag</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Intent</span> <span class="n">action</span> <span class="o">=</span> <span class="n">thumbnail</span><span class="o">.</span><span class="na">generateAction</span><span class="o">();</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">startActivity</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ActivityNotFoundException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Unfortunately, we cannot view the photo.&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>而对于PhotoSaveAgent则需要在PhotoWriteTask里面，最后一步，也即文件保存完毕后，生成缩略图，因为是需要Uri的，所以必须是要在最后才能生成缩略图，并通过ThumbnailObserver回调：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="c1">// in PhotoWriteTask</span>
</span><span class='line'>   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">///// other codes</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Thumbnail</span> <span class="n">t</span> <span class="o">=</span> <span class="n">generateThumbnail</span><span class="o">(</span><span class="n">fileUri</span><span class="o">);</span>
</span><span class='line'>        <span class="k">for</span> <span class="o">(</span><span class="n">ThumbnailObserver</span> <span class="n">to</span> <span class="o">:</span> <span class="n">thumbnailObservers</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">to</span><span class="o">.</span><span class="na">thumbnailArrived</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Thumbnail</span> <span class="nf">generateThumbnail</span><span class="o">(</span><span class="n">Uri</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">Thumbnail</span><span class="o">(</span><span class="n">uri</span><span class="o">,</span> <span class="n">mime</span><span class="o">,</span> <span class="n">extractThumbnailBitmap</span><span class="o">(</span><span class="n">jpeg</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Bitmap</span> <span class="nf">extractThumbnailBitmap</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">jpegArray</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="mi">480</span><span class="o">;</span>
</span><span class='line'>        <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">Options</span> <span class="n">options</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">Options</span><span class="o">();</span>
</span><span class='line'>        <span class="n">options</span><span class="o">.</span><span class="na">inJustDecodeBounds</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeByteArray</span><span class="o">(</span><span class="n">jpegArray</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">jpegArray</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>        <span class="n">options</span><span class="o">.</span><span class="na">inSampleSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">options</span><span class="o">.</span><span class="na">outWidth</span><span class="o">,</span> <span class="n">options</span><span class="o">.</span><span class="na">outHeight</span><span class="o">)</span> <span class="o">/</span> <span class="n">target</span><span class="o">;</span>
</span><span class='line'>        <span class="n">options</span><span class="o">.</span><span class="na">inJustDecodeBounds</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>        <span class="n">Bitmap</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="n">BitmapFactory</span><span class="o">.</span><span class="na">decodeByteArray</span><span class="o">(</span><span class="n">jpegArray</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">jpegArray</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">options</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Matrix</span> <span class="n">matrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Matrix</span><span class="o">();</span>
</span><span class='line'>        <span class="n">matrix</span><span class="o">.</span><span class="na">postRotate</span><span class="o">(</span><span class="n">jpegOrientation</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Bitmap</span> <span class="n">rotated</span> <span class="o">=</span> <span class="n">Bitmap</span><span class="o">.</span><span class="na">createBitmap</span><span class="o">(</span><span class="n">bitmap</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getWidth</span><span class="o">(),</span> <span class="n">bitmap</span><span class="o">.</span><span class="na">getHeight</span><span class="o">(),</span> <span class="n">matrix</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">rotated</span> <span class="o">!=</span> <span class="n">bitmap</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">bitmap</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">rotated</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>拍照动画</h2>

<p>拍照动画的目的就在于给用户一个直观 的感觉，特别是拍照开始了，至于拍照结束倒是不用特别的，这人一般在缩略图那里体现。</p>

<p>主要做两个动画，一个是快门shutter的动画，这个是在快门点击时就可以去做了，主要是一个缩放的动画，把缩放的动画正着放一遍（缩小0.75倍），再reverse（放大到正常大小）即可：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='Java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">takePhoto</span><span class="o">(</span><span class="n">View</span> <span class="n">view</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ScaleAnimation</span> <span class="n">anim</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ScaleAnimation</span><span class="o">(</span><span class="mi">1</span><span class="n">f</span><span class="o">,</span> <span class="mf">0.75f</span><span class="o">,</span> <span class="mi">1</span><span class="n">f</span><span class="o">,</span> <span class="mf">0.75f</span><span class="o">,</span>
</span><span class='line'>                <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span> <span class="mf">0.5f</span><span class="o">,</span> <span class="n">Animation</span><span class="o">.</span><span class="na">RELATIVE_TO_SELF</span><span class="o">,</span> <span class="mf">0.5f</span><span class="o">);</span>
</span><span class='line'>        <span class="n">anim</span><span class="o">.</span><span class="na">setDuration</span><span class="o">(</span><span class="n">Config</span><span class="o">.</span><span class="na">CAPTURE_ANIM_DURATION</span> <span class="o">/</span> <span class="mi">2</span><span class="o">);</span>
</span><span class='line'>        <span class="n">anim</span><span class="o">.</span><span class="na">setInterpolator</span><span class="o">(</span><span class="k">new</span> <span class="nf">AccelerateDecelerateInterpolator</span><span class="o">());</span>
</span><span class='line'>        <span class="n">anim</span><span class="o">.</span><span class="na">setFillAfter</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="n">anim</span><span class="o">.</span><span class="na">setRepeatMode</span><span class="o">(</span><span class="n">Animation</span><span class="o">.</span><span class="na">REVERSE</span><span class="o">);</span>
</span><span class='line'>        <span class="n">anim</span><span class="o">.</span><span class="na">setRepeatCount</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">startAnimation</span><span class="o">(</span><span class="n">anim</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cameraFactory</span><span class="o">.</span><span class="na">takePhoto</span><span class="o">(</span><span class="n">status</span> <span class="o">-&gt;</span> <span class="n">mainHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">captureStatusListener</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">status</span><span class="o">)));</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外一个就是在拍照开始时的动画，这个动画的时机是在硬件真的开始拍照时做，也即是要在CaptureCallback#onCaptureStarted时去做，需要特别注意的是，这个时间是由硬件决定的，所以只有在onCaptureStarted回调时去做才是最恰当的。</p>

<p>至于动画的形式，一般是通过预览区域的闪动实现，比如可以用一个与预览Surface一样大小的View，改变它的颜色，给用户一种预览闪动的效果即可。这里的overlayView是一个盖在预览上面的透明的View，在做动画时给它设置为半透明的白色：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">private</span> <span class="kd">final</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">PhotoCaptureStatus</span><span class="o">&gt;</span> <span class="n">captureStatusListener</span> <span class="o">=</span> <span class="n">status</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;capture status &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
</span><span class='line'>    <span class="n">statusView</span><span class="o">.</span><span class="na">setText</span><span class="o">(</span><span class="s">&quot;Capture Status: &quot;</span> <span class="o">+</span> <span class="n">status</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">STARTED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">overlayView</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="k">new</span> <span class="nf">ColorDrawable</span><span class="o">(</span><span class="n">Color</span><span class="o">.</span><span class="na">argb</span><span class="o">(</span><span class="mi">150</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">255</span><span class="o">,</span> <span class="mi">255</span><span class="o">)));</span>
</span><span class='line'>        <span class="n">mainHandler</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">overlayView</span><span class="o">.</span><span class="na">setBackground</span><span class="o">(</span><span class="kc">null</span><span class="o">),</span> <span class="n">Config</span><span class="o">.</span><span class="na">CAPTURE_ANIM_DURATION</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">COMPLETED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">PhotoCaptureStatus</span><span class="o">.</span><span class="na">FAILED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">shutterView</span><span class="o">.</span><span class="na">setEnabled</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mac画图工具]]></title>
    <link href="http://toughcoder.net/blog/2022/04/01/diagrams-drawing-made-easy/"/>
    <updated>2022-04-01T23:30:44+08:00</updated>
    <id>http://toughcoder.net/blog/2022/04/01/diagrams-drawing-made-easy</id>
    <content type="html"><![CDATA[<p>在平时开发中，经常需要画各种图形，比如流程图，架构图和UML图等等。找到一个好用且高效的工具能事半功倍，现在就来总结一下在Mac上面有哪些好用的画图工具。</p>

<p><a href="http://toughcoder.net/blog/2022/04/01/diagrams-drawing-made-easy/"><img src="https://www.pcwdld.com/wp-content/uploads/Cade-Network-diagramming-tool.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>厘清需求</h2>

<p>还是要先厘清需求明确问题。需求也比较明确，最好是免费，用户友好，支持导出各种图片格式，能支持常见的各种图形，如流程图，架构图和UML图等。</p>

<h2>桌面软件</h2>

<p>桌面软件大部分都是付费的，但也有一些是免费的，以下的值得尝试，这些都是专业公司开发的，在功能，易用性和稳定性上面要好一些。</p>

<table>
<thead>
<tr>
<th> &nbsp;&nbsp;&nbsp;&nbsp;Name&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th style="text-align:center;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;付费情况&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th style="text-align:center;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;下载安装&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th style="text-align:center;"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;支持平台&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th> &nbsp;&nbsp;&nbsp;&nbsp;说明&nbsp;&nbsp;&nbsp;&nbsp; </th>
</tr>
</thead>
<tbody>
<tr>
<td> <a href="https://www.nchsoftware.com/chart/index.html?ref=cj&amp;cjevent=27d37b109b8711eb808b01840a180511">ClickCharts</a> </td>
<td style="text-align:center;"> 基础版本免费 </td>
<td style="text-align:center;"> <a href="https://www.nchsoftware.com/chart/clickchartspmaci.zip">网站下载</a> </td>
<td style="text-align:center;"> Windows<br/>Mac<br/>Android </td>
<td> 界面接近Visio<br/>功能比较齐全 </td>
</tr>
<tr>
<td> <a href="http://pencil.evolus.vn/">Pencil</a> </td>
<td style="text-align:center;"> 开源且免费 </td>
<td style="text-align:center;"> <a href="http://pencil.evolus.vn/dl/V3.1.0.ga/Pencil-3.1.0.ga.dmg">网站下载</a> </td>
<td style="text-align:center;"> Windows<br/>Mac<br/>Linux </td>
<td> 是一款开源软件，免费使用<br/>不好的地方是文档较少 </td>
</tr>
</tbody>
</table>


<h2>在线工具</h2>

<p>除了桌面软件以外，还有很多在线的图形工具，非常的好用。随着Browser性能越来越强，现在Web端的体验也是相当的好，可以优先选择Web端。</p>

<h3><a href="https://app.diagrams.net/">Draw.io</a></h3>

<p>这个相当有名气，用的也比较广泛，一般来讲能够满足日常需求。</p>

<h3>基于JavaScript的图形库</h3>

<p>还有很多用JavaScript实现的图表库也相当的棒，有在线的编辑工具，并且很多都支持语法脚本，支持云存储，也支持把结果以图片形式下载到本地，非常的实用。</p>

<table>
<thead>
<tr>
<th> Name </th>
<th style="text-align:center;">  &nbsp;&nbsp;&nbsp;&nbsp;在线编辑工具&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th> &nbsp;&nbsp;&nbsp;&nbsp;说明&nbsp;&nbsp;&nbsp;&nbsp; </th>
</tr>
</thead>
<tbody>
<tr>
<td> <a href="https://mermaid-js.github.io/mermaid/#/">mermaid</a> </td>
<td style="text-align:center;"> <a href="https://mermaid.live/edit#pako:eNpVkM-KwkAMxl8l5OSCfYEeBG3Vi6Cgt46H0InOIPOHdMoibd99p5aF3ZyS7_t9IWTANmjGEp9C0cCtVh5ybZvKiO2So-4ORbEZj5zABc_vEXarY4DOhBitf34t_G6GoBpOM8aQjPWvabGqT_7seYS6OVFMId7_OrfvMMK-sReT1_93jHBOHZoHlQ8qWhKoSD4IrtGxOLI6nz7MisJk2LHCMrea5KVQ-SlzfdSUeK9tCoJlkp7XSH0K17dvf-eFqS3lL7hFnH4ABg5bBA">mermaid live</a> </td>
<td> </td>
</tr>
<tr>
<td> <a href="https://bramp.github.io/js-sequence-diagrams/">js-sequence-diagrams</a></td>
<td style="text-align:center;"> </td>
<td></td>
</tr>
<tr>
<td> <a href="http://flowchart.js.org/">flowchatjs</a> </td>
<td style="text-align:center;"> </td>
<td></td>
</tr>
</tbody>
</table>


<p><br/>
更多的在线工具可以参考<a href="http://toughcoder.net/blog/2022/03/28/blog-image-bed-made-easy/">前一篇文章</a>。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://www.makeuseof.com/tag/free-flowchart-makers-mac/">The 7 Best Free Mac Flowchart Makers for Quick and Easy Diagrams</a></li>
<li><a href="https://www.softwaretestinghelp.com/flowchart-software/">10 Best Free Flowchart Software For Windows And Mac</a></li>
<li><a href="https://machow2.com/flowcharts-for-mac-the-best-software/">10 Best Flowchart Software of 2022 For Pros</a></li>
<li><a href="https://zapier.com/blog/flowchart-diagramming-software/">The best flowchart software and diagram tools in 2022</a></li>
<li><a href="https://www.techrepublic.com/article/five-free-web-based-tools-that-make-diagramming-a-snap/">Five free web-based tools that make diagramming a snap</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[博客图形图像解决办法]]></title>
    <link href="http://toughcoder.net/blog/2022/03/28/blog-image-bed-made-easy/"/>
    <updated>2022-03-28T20:46:51+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/28/blog-image-bed-made-easy</id>
    <content type="html"><![CDATA[<p>一个好的博客必须要图文并茂，但图片是一个大问题，用GitHub pages搭建的博客最为蛋疼的就是图床问题，被图床问题困扰了很久，需要花点时间好好的解决一下子了。</p>

<p><a href="http://toughcoder.net/blog/2022/03/28/blog-image-bed-made-easy/"><img src="https://cdn.writermag.com/2016/12/blogs-versus-articles.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>图片始终是痛点</h2>

<p>曾经用过七牛，免额满了后就没有再用了。</p>

<p>后来用微博，但后来微博不允许外链了，不但不能再用了，之前存在微博的图片也都无法访问了。</p>

<p>免费的图床也一直都有，但都不长久，这东西很难盈利，运营不过多久就会关了，还要再找新的。一个字就是蛋疼。</p>

<h2>厘清需求</h2>

<p>要想解决问题，需要先把问题澄清，问题源于图片需求。</p>

<ul>
<li>非原创性图片，用于splash，或者说明和阐述一些细节的</li>
<li>原创图片，手动画的一些图片</li>
<li>截屏，手机截屏，或者电脑屏幕截图，用于展示过程说明或者运行结果</li>
<li>原创图形，如流程图，结构图，架构图，设计图或者UML图</li>
</ul>


<p>在博客中使用的图形与图像，就是以上四种。</p>

<h2>如何解决问题</h2>

<p>针对 不同的需求用不同的解法。</p>

<h3>非原创性图片用链接</h3>

<p>对于非原创性图片，尽可能的在网络上搜索，使用网络图片，这是最为省事的。</p>

<p>搜索的时候要注意：</p>

<ol>
<li>尽是用<a href="https://cn.bing.com/">Bing</a>来搜索</li>
<li>图片不能被墙，要都能访问的</li>
<li>注意版权，别侵权</li>
</ol>


<h3>原创性图片和截屏找图床</h3>

<p>没办法，这个只能找图床来解决了。后面再单独拿出来说。</p>

<h3>原创图形用画图库</h3>

<p>对于一些原创性的图形，要寻找画图库来解决，就是那种内嵌在网页里面的，用脚本或者源码去画图的图形库。后面单独说。</p>

<h2>痛点治疗方案</h2>

<p>通过上面来分析，如何找到图床和画图库，就成解决痛点的关键。</p>

<h3>图床用<a href="https://postimages.org/">postimages</a></h3>

<p>看似绕来绕去，仍还是需要寻找图床。但其实还是不一样，通过上面分析，发现仅有少量的原创图片和截屏需要图床，所以整体量并不大。用GitHub就可以了，空间是够的不是问题，问题就在于稳定性，毕竟访问GitHub经常抽风（不是GitHub server本身抽风，而是网络抽风），另外就是CDN加速。即使GitHub能正常访问，但是还是太慢了，对于常规的push/pull还好，但图片肯定会明显感觉到很慢，必须寻找CDN加速方法。</p>

<ul>
<li>新建一个repo，专门用于博客图床</li>
<li>寻找CDN加速方法</li>
</ul>


<p>网络上还真有大把的人用GitHub用作图床，方法有两种：</p>

<ol>
<li>直接在GitHub issues中上传图片，<a href="https://dev.to/adityatyagi/host-images-for-free-on-github-3d1c">这篇文章有详细讨论</a></li>
<li>创建一个repo，<a href="https://fizzy.cc/use-github-repo-to-host-images/">可以看这篇文章</a>，讲的很详细</li>
</ol>


<p>方法1非常的简单和方便，对于图片需求量不大的话，非常合适，而且它不占用repo的空间配额。目前先用方法1。如果 后面图片量确实大的话，再考虑切到方案2.</p>

<p><strong>注意</strong>：GitHub貌似做了屏蔽，不让上传图片，可能是因为上传的图片太多了，hold不住了，所以做了限制。</p>

<h3>专用图床</h3>

<p>目前发现<a href="https://postimages.org/">postimages</a>比较好用，先用这个吧。</p>

<ul>
<li><a href="https://www.bettertechtips.com/blogging/image-hosting-blog/">7 Free Image Hosting Sites to Save Your Blog Storage</a></li>
<li><a href="https://blogpros.com/blog/2016/03/host-blog-images-free">10 Reliable Websites to Host Your Blog Images for Free</a></li>
</ul>


<h3>寻找JavaScript图形库</h3>

<p>这个现成方案很多，就需要找一个合适的。</p>

<p>我们的需求是：</p>

<ol>
<li>最好是内嵌在网页中的</li>
<li>免费，毕竟需求量不是很大，偶尔才需要画图，没必要花钱</li>
<li>支持常见的图形和图表，如流程图，结构图，架构图和UML图</li>
<li>使用方式当然越简单越好</li>
</ol>


<p>可行的的方案：</p>

<ul>
<li><a href="https://modeling-languages.com/javascript-drawing-libraries-diagrams/">20+ JavaScript libraries to draw your own diagrams</a></li>
<li><a href="https://www.chartjs.org/">Chart.js</a> 这个是图表，也就是统计数据的图表（柱图饼图散列图等）。</li>
<li><a href="https://hackernoon.com/my-top-13-javascript-diagram-libraries-g2a53z6u">My Top 13 JavaScript Diagram Libraries</a></li>
<li><a href="https://ourcodeworld.com/articles/read/159/top-5-best-free-diagrams-javascript-libraries">Top 5 : Best free diagrams javascript libraries</a></li>
</ul>


<p>目前来看<a href="http://mermaid-js.github.io/mermaid/#/">mermaid</a>和<a href="http://flowchart.js.org/">FlowChart.js</a>比较符合需求，它们都可以内嵌到网页里面，且功能较强大。而mermaid的语法更简洁一些，我们可以先从mermaid开始尝试。目前最重要的事情是，如何把图形内嵌到博客中，把链路先跑通。</p>

<h3><a href="https://mermaid-js.github.io/mermaid/#/">mermaid</a></h3>

<p>语法简单，与Markdown类似，同时库比较简单，方便集成。比较符合我们的需求。就先从它开始。</p>

<p>集成方法，非常简单，先引入库，然后定义一个class=&ldquo;mermaid&#8221;的<div> tag即可。因为Markdown是支持内嵌HTML tag的，所以可以直接在Markdown中写。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script&gt;</span><span class="nx">mermaid</span><span class="p">.</span><span class="nx">initialize</span><span class="p">({</span><span class="nx">startOnLoad</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;mermaid&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>graph TD;
</span><span class='line'>    A--&gt;B;
</span><span class='line'>    A--&gt;C;
</span><span class='line'>    B--&gt;D;
</span><span class='line'>    C--&gt;D;
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>效果就是这样：</p>

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>


<script>mermaid.initialize({startOnLoad:true});</script>




<div class="mermaid">
graph TD;    A&#45;&#45;>B;    A&#45;&#45;>C;    B&#45;&#45;>D;    C&#45;&#45;>D;
</div>


<p><br/></p>

<h3>用entity解决转义问题</h3>

<p>因为Markdown以及一些静态博客框架如Jekyll或者Octopress会对一些字符进行转义，因此有些时候会造成最终结果是mermaid运行出错：Syntax error in graph</p>

<p>原因就在于一些字符被Mardown以及博客框架用作特殊用途了。因此需要转义，在mardown源码中用HTML Entity来代替被转换的字符即可。因为mermaid是JavaScript库，它是在DOM都渲染好了之后才对div tag进行处理，而HTML enity能保证在DOM中是正确的字符，又恰是在mermaid处理之前，因此可以得到符合预期的结果，而且是用Markdown编辑器预览，以及最终博客里面都能得到符合预期的结果。</p>

<p>常见的需要做转义的字符：</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> &nbsp;&nbsp;&nbsp;&nbsp;预期字符&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th style="text-align:center;"> &nbsp;&nbsp;&nbsp;&nbsp;HTML Entity&nbsp;&nbsp;&nbsp;&nbsp; </th>
<th> &nbsp;&nbsp;&nbsp;&nbsp;说明&nbsp;&nbsp;&nbsp;&nbsp; </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> &#45; </td>
<td style="text-align:center;"> &amp;#45; </td>
<td> 单个&#45;不需要，当其与&gt;组合时需要  </td>
</tr>
<tr>
<td style="text-align:center;"> &lt;&lt; </td>
<td style="text-align:center;"> &amp;lt;&amp;lt; </td>
<td> 单个不需要，两个在一起就需要  </td>
</tr>
<tr>
<td style="text-align:center;"> &gt;&gt; </td>
<td style="text-align:center;"> &amp;gt;&amp;gt; </td>
<td> 单个不需要，两个在一起就需要 </td>
</tr>
</tbody>
</table>


<p><br/><br/>
这里是常见的HTML Entity参考：</p>

<ul>
<li><a href="https://www.w3schools.com/html/html_entities.asp">HTML entities</a></li>
<li><a href="https://dev.w3.org/html5/html-author/charref">HTML entities table</a></li>
<li><a href="https://www.freeformatter.com/html-entities.html">HTML Entity List</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LeetCode Hot 100 归档]]></title>
    <link href="http://toughcoder.net/blog/2022/03/17/leetcode-hot-100-archives/"/>
    <updated>2022-03-17T23:40:15+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/17/leetcode-hot-100-archives</id>
    <content type="html"><![CDATA[<p><a href="https://leetcode-cn.com/problem-list/2cktkvj/">LeetCode热门100</a> 刷题归档.</p>

<p><a href="http://toughcoder.net/blog/2022/03/17/leetcode-hot-100-archives/"><img src="https://img.tukuppt.com/png_preview/00/03/28/I7XmLxWIHx.jpg!/fw/780" title="auto auto" ></a></p>

<!-- more -->


<table>
<thead>
<tr>
<th> Problems </th>
<th style="text-align:center;">  &nbsp;&nbsp;&nbsp;&nbsp;Solutions&nbsp;&nbsp;&nbsp;&nbsp;  </th>
<th style="text-align:center;">  &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Code Archives&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  </th>
<th style="text-align:center;"> 主要算法 </th>
</tr>
</thead>
<tbody>
<tr>
<td> <a href="https://leetcode.cn/problems/two-sum/">1. 两数之和</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/two-sum/solution/liang-shu-zhi-he-by-alexhilton-y3eb/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P001TwoSum.java">代码归档</a> </td>
<td style="text-align:center;"> 双指针，对撞指针，哈希 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/add-two-numbers/">2. 两数相加</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/add-two-numbers/solution/add-two-by-alexhilton-vaw0/">题解</a> </td>
<td style="text-align:center;"><a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P002AddTwoNumbers.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/longest-substring-without-repeating-characters/">3. 无重复字符的最长子串</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/longest-substring-without-repeating-characters/solution/wu-zhong-fu-by-alexhilton-ecxc/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P003LongestSubstring.java">代码归档</a> </td>
<td style="text-align:center;"> 同向双指针，哈希 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/median-of-two-sorted-arrays/">4. 寻找两个正序数组的中位数</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/median-of-two-sorted-arrays/solution/4-by-alexhilton-xnk5/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P004FindMedian.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/longest-palindromic-substring/">5. 最长回文子串</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/longest-palindromic-substring/solution/5-zui-chang-hui-wen-zi-chuan-by-alexhilt-6kvt/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P005LongestPalindrome.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/regular-expression-matching">10. 正则表达式匹配</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/container-with-most-water">11. 盛最多水的容器</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/3sum/">15. 三数之和</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/3sum/solution/15-san-shu-zhi-he-by-alexhilton-0ucz/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/array/ArrayQuestions.java">代码归档</a> </td>
<td style="text-align:center;"> 排序，双指针 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/letter-combinations-of-a-phone-number">17. 电话号码的字母组合</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list/">19. 删除链表的倒数第 N 个结点</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/remove-nth-node-from-end-of-list/solution/19-shan-chu-lian-biao-de-dao-shu-di-n-ge-xa3i/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/linkedlist/DoublePointers.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/valid-parentheses/">20. 有效的括号</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/valid-parentheses/solution/by-alexhilton-8tcu/">题解</a> </td>
<td style="text-align:center;"> <a href="">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/merge-two-sorted-lists/">21. 合并两个有序链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/merge-two-sorted-lists/solution/21-he-bing-liang-ge-you-xu-lian-biao-by-2pafg/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P021MergeList.java">代码归档</a> </td>
<td style="text-align:center;"> 归并排序思想 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/generate-parentheses">22. 括号生成</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/generate-parentheses/solution/by-alexhilton-9yxt/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/merge-k-sorted-lists">23. 合并K个升序链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/top-k-frequent-elements/solution/by-alexhilton-xhxc/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/next-permutation">31. 下一个排列</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/longest-valid-parentheses">32. 最长有效括号</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/search-in-rotated-sorted-array">33. 搜索旋转排序数组</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array">34. 在排序数组中查找元素的第一个和最后一个位置</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/combination-sum">39. 组合总和</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/combination-sum/solution/by-alexhilton-1dzy/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/trapping-rain-water">42. 接雨水</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/permutations">46. 全排列</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/permutations-ii/solution/by-alexhilton-m337/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/rotate-image">48. 旋转图像</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/rotate-image/solution/by-alexhilton-5das/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/group-anagrams/">49. 字母异位词分组</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/group-anagrams/solution/49-zi-mu-yi-wei-ci-fen-zu-by-alexhilton-ni22/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P049GroupAnagrams.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/maximum-subarray">53. 最大子数组和</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/maximum-subarray/solution/by-alexhilton-21zr/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/jump-game">55. 跳跃游戏</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/merge-intervals">56. 合并区间</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/merge-intervals/solution/by-alexhilton-a3ie/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/unique-paths">62. 不同路径</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/minimum-path-sum">64. 最小路径和</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/climbing-stairs/">70. 爬楼梯</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/climbing-stairs/solution/by-alexhilton-7zms/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P070ClimbStairs.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/edit-distance">72. 编辑距离</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/sort-colors">75. 颜色分类</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/sort-colors/solution/by-alexhilton-lx1m/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/minimum-window-substring">76. 最小覆盖子串</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/subsets">78. 子集</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/word-search">79. 单词搜索</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/largest-rectangle-in-histogram">84. 柱状图中最大的矩形</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/maximal-rectangle">85. 最大矩形</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/binary-tree-inorder-traversal">94. 二叉树的中序遍历</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/unique-binary-search-trees">96. 不同的二叉搜索树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/validate-binary-search-tree">98. 验证二叉搜索树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/symmetric-tree">101. 对称二叉树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/binary-tree-level-order-traversal">102. 二叉树的层序遍历</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/maximum-depth-of-binary-tree">104. 二叉树的最大深度</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/construct-binary-tree-from-preorder-and-inorder-traversal">105. 从前序与中序遍历序列构造二叉树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/flatten-binary-tree-to-linked-list">114. 二叉树展开为链表</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock">121. 买卖股票的最佳时机</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock/solution/by-alexhilton-pv84/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/binary-tree-maximum-path-sum">124. 二叉树中的最大路径和</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/longest-consecutive-sequence">128. 最长连续序列</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/single-number/">136. 只出现一次的数字</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/single-number/solution/136-zhi-chu-xian-yi-ci-de-shu-zi-by-alex-1ta2/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/numbers/Binaries.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/word-break">139. 单词拆分</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/linked-list-cycle/">141. 环形链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/linked-list-cycle/solution/141-huan-xing-lian-biao-by-alexhilton-pzk1/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/linkedlist/DoublePointers.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/linked-list-cycle-ii/">142. 环形链表 II</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/linked-list-cycle-ii/solution/by-alexhilton-u2dm/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/linkedlist/DoublePointers.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/lru-cache">146. LRU 缓存</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/sort-list/">148. 排序链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/sort-list/solution/by-alexhilton-tqk5/">题解</a> </td>
<td style="text-align:center;"> <a href="">代码归档</a> </td>
<td style="text-align:center;"> 归并排序 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/maximum-product-subarray">152. 乘积最大子数组</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/min-stack">155. 最小栈</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/intersection-of-two-linked-lists/">160. 相交链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/intersection-of-two-linked-lists/solution/by-alexhilton-jhos/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/linkedlist/DoublePointers.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/majority-element/">169. 多数元素</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/majority-element/solution/by-alexhilton-upn7/">题解</a> </td>
<td style="text-align:center;"> <a href="">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/house-robber">198. 打家劫舍</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/house-robber/solution/by-alexhilton-kmj8/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/number-of-islands">200. 岛屿数量</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/reverse-linked-list/">206. 反转链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/reverse-linked-list/solution/206-fan-zhuan-lian-biao-by-alexhilton-6ttd/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P206ReverseList.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/course-schedule">207. 课程表</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/implement-trie-prefix-tree">208. 实现 Trie (前缀树)</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/kth-largest-element-in-an-array">215. 数组中的第K个最大元素</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/maximal-square">221. 最大正方形</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/invert-binary-tree">226. 翻转二叉树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/palindrome-linked-list/">234. 回文链表</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/palindrome-linked-list/solution/by-alexhilton-pcab/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/linkedlist/ReverseList.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/lowest-common-ancestor-of-a-binary-tree">236. 二叉树的最近公共祖先</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/product-of-array-except-self">238. 除自身以外数组的乘积</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/product-of-array-except-self/solution/by-alexhilton-42tu/">题解</a> </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/sliding-window-maximum">239. 滑动窗口最大值</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/search-a-2d-matrix-ii">240. 搜索二维矩阵 II</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/meeting-rooms-ii">253. 会议室 II</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/perfect-squares">279. 完全平方数</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/move-zeroes/">283. 移动零</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/move-zeroes/solution/by-alexhilton-y9fs/">题解</a> </td>
<td style="text-align:center;"> <a href="">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/find-the-duplicate-number">287. 寻找重复数</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/serialize-and-deserialize-binary-tree">297. 二叉树的序列化与反序列化</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/longest-increasing-subsequence">300. 最长递增子序列</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/remove-invalid-parentheses">301. 删除无效的括号</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/best-time-to-buy-and-sell-stock-with-cooldown">309. 最佳买卖股票时机含冷冻期</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/burst-balloons">312. 戳气球</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/coin-change">322. 零钱兑换</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/house-robber-iii">337. 打家劫舍 III</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/counting-bits/">338. 比特位计数</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/counting-bits/solution/338-bi-te-wei-ji-shu-by-alexhilton-ft3h/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/numbers/Binaries.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/top-k-frequent-elements">347. 前 K 个高频元素</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/decode-string">394. 字符串解码</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/evaluate-division/">399. 除法求值</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/queue-reconstruction-by-height">406. 根据身高重建队列</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/partition-equal-subset-sum">416. 分割等和子集</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/path-sum-iii">437. 路径总和 III</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/find-all-anagrams-in-a-string/">438. 找到字符串中所有字母异位词</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/find-all-anagrams-in-a-string/solution/438-zhao-dao-zi-fu-chuan-zhong-suo-you-z-e1jq/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/leetcode/src/main/java/hot100/P438FindAnagrams.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/find-all-numbers-disappeared-in-an-array">448. 找到所有数组中消失的数字</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/hamming-distance/">461. 汉明距离</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/hamming-distance/solution/by-alexhilton-0opr/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/numbers/Binaries.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/target-sum">494. 目标和</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/convert-bst-to-greater-tree">538. 把二叉搜索树转换为累加树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/diameter-of-binary-tree">543. 二叉树的直径</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/subarray-sum-equals-k/">560. 和为 K 的子数组</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/subarray-sum-equals-k/solution/by-alexhilton-eh11/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/array/ArrayQuestions.java">代码归档</a> </td>
<td style="text-align:center;"> 数组，前缀和，哈希 </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/shortest-unsorted-continuous-subarray">581. 最短无序连续子数组</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/merge-two-binary-trees">617. 合并二叉树</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/task-scheduler">621. 任务调度器</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/palindromic-substrings/">647. 回文子串</a> </td>
<td style="text-align:center;"> <a href="https://leetcode.cn/problems/palindromic-substrings/solution/647-hui-wen-zi-chuan-by-alexhilton-t79d/">题解</a> </td>
<td style="text-align:center;"> <a href="https://github.com/alexhilton/EffectiveAlgorithm/blob/main/effectiveoffer/src/main/java/strings/Palindrome.java">代码归档</a> </td>
<td></td>
</tr>
<tr>
<td> <a href="https://leetcode.cn/problems/daily-temperatures">739. 每日温度</a> </td>
<td style="text-align:center;"> 题解 </td>
<td style="text-align:center;"> 代码归档 </td>
<td style="text-align:center;"> </td>
</tr>
</tbody>
</table>


<!--
| []() | [题解]() | [代码归档]() |
-->


<p><br />
<br />
<br />
<strong>注意</strong>：题目版权归 <a href="https://leetcode-cn.com/">LeetCode</a> 所有。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LeetCode刷题计划]]></title>
    <link href="http://toughcoder.net/blog/2022/03/17/leetcode-learning-plans/"/>
    <updated>2022-03-17T23:33:39+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/17/leetcode-learning-plans</id>
    <content type="html"><![CDATA[<p>多说无益，还是要撸。从<a href="https://leetcode-cn.com/problem-list/2cktkvj/">Hot100</a>开始，这是比较基础的一套题目，非常适合入手。</p>

<p><a href="http://toughcoder.net/blog/2022/03/17/leetcode-learning-plans/"><img src="https://pic1.zhimg.com/v2-5efc27df05c686f2496e631f3cd44958_r.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>在本地编码</h2>

<p>浏览器编辑和调试代码毕竟还是不太方便，所以还需要在本地调试和编码，然后再到网站上面去提交。</p>

<p>创建一个新的module，为leetcode，然后同时创建测试代码。<a href="https://github.com/alexhilton/EffectiveAlgorithm/tree/main/leetcode">完整代码在这里</a>。</p>

<h2>要先学习，再去解题</h2>

<p>刷题是在练习，如果一道题，有思路，或者已经知道如何解决，那么可以去解题，力争一遍AC，并要优化代码细节。</p>

<p>但如果完全没有思路，或者除了蛮力法和常规方法外，想不到更好的方案，但其实有更好的方法，那这题做起来其实就没有多大意思了，因为在不借外力的情况下，想不出更好的方案。</p>

<p>所以，还是需要先去学习相关的知识，然后再去练习。比如先去看书，或者看LeetBook，学习到相关的知识以后，再去找类似的题目去解题。</p>

<p>对于书中（常规书籍或者LeetBook）的示例，重点是要看懂和理解，当然也要敲一遍运行一下，以完全理解思路和编码细节。但不应该花过多的时间，比如寻找更多解法等，这是没有必要的。因为一定可以找到与书中一样的题，或者至少有类似的题，解题时可以尝试不同的解法，比如蛮力法，改良法和书中建议的方法。这样效率更高，因为题中有更全的测试用例，也能更好的比较运行结果。最后 写题解进行总结。</p>

<p>但一定一定不能为了刷而刷，比如不经思考直接去看评论或者题解，这样是没有意义的。</p>

<h2>每一道题要尝试多种解法</h2>

<p>一定要自己思考，并尝试多种解法。从直观蛮力法开始，做好效率分析，争取每次提交都有提升。</p>

<p>实在没思路时，先看题目本身的提示，再看题解或者网上其他人的解法。然后写自己的解法，不要照抄。</p>

<p>发散思维是相当重要的，这无论是在面试中还是在实际工作中都是极其重要的，因为任何问题都不止一个解法。面试时更喜欢问，有没有其他解法，有没有更好的解法，所以尝试多种解法是相当有益的。</p>

<h2>力争做到Beat 100%</h2>

<p>重点是时间上，要力争做到beat 100%，至少要beat 90%。</p>

<p>空间不做特别要求，尽量不用额外空间，做到至少beat 50%吧。当然也没有必要为了优化而优化，比如针对LeetCode的测试特点进行优化，这是没有必要的。</p>

<h2>做完后要写题解</h2>

<p>把题目的分析，和各种解法写一写。</p>

<h2>引申知识点的学习总结成文</h2>

<p>对于题目中引申出来的知识点要进行学习并另外总结成文，放在博客之中。</p>

<h2>博客之中归档</h2>

<p>博客之中用一篇文章来记录所做的题目，对应的题解和完整代码。</p>

<ul>
<li><a href="http://toughcoder.net/blog/2022/03/17/leetcode-hot-100-archives/">LeetCode Hot 100 归档</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Interview Algorithm and LeetCode]]></title>
    <link href="http://toughcoder.net/blog/2022/03/16/algorithms-made-easy/"/>
    <updated>2022-03-16T21:44:25+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/16/algorithms-made-easy</id>
    <content type="html"><![CDATA[<p>这个是面试的必备技能，而且特别是外企和一线大厂都很喜欢问算法题目，所以这也是一个必须跨跃的门槛。</p>

<p>这东西与当年ACM/ICPC以及中学的信息技术竞赛是同一套东西，核心就是算法和数据结构，目的就是训练逻辑思维能力，建模的能力和问题分析与解决的能力，当然 对于提升解决问题的能力还是很有帮助的。</p>

<p>很惭愧，当年没有学好（ACM/ICPC 2008年亚洲区域赛合肥赛区只拿到优胜奖 Honorable Mention），现在是时候好好补习一下了。</p>

<p><a href="http://toughcoder.net/blog/2022/03/16/algorithms-made-easy/"><img src="https://tse3-mm.cn.bing.net/th/id/OIP-C.57PbuYOIlWq6wvAuK8tp9gHaEK?pid=ImgDet&rs=1" title="auto auto" ></a></p>

<!-- more -->


<h2>优质书籍</h2>

<p>核心的书籍就是算法和数据结构，市面上书籍甚多，比较优质的有如下</p>

<h3>基石</h3>

<p>数据结构与算法是基础中的基础。</p>

<ul>
<li><a href="">数据结构与算法图解</a></li>
<li><a href="">算法图解</a></li>
<li><a href="">编程的修炼</a></li>
<li><a href="">编程玑珠</a></li>
<li><a href="">数学之美</a> 这个更偏数学一些，不过数学更是基石中的基石</li>
</ul>


<h3>以面试题为主线的书</h3>

<p>另外，还有一套书是以面试题为主线，辅助以介绍基础知识的书，非常之实用。</p>

<ul>
<li><a href="">剑指Offer 专项突破版</a></li>
<li><a href="">剑指Offer</a></li>
<li><a href="">编程之美：微软技术面试心得</a></li>
</ul>


<h2>LeetCode</h2>

<p>现在最火的就是刷题，就是在LeetCode（力扣）上面刷题，网上各种攻略以及题解都非常之多。</p>

<ul>
<li><a href="https://books.halfrost.com/leetcode/">LeetCode Cookbook</a></li>
<li><a href="https://www.zhihu.com/question/280279208">大家都是如何刷 LeetCode 的？</a></li>
<li><a href="https://blog.csdn.net/fuxuemingzhu/article/details/105183554">刷完 900 多道算法题的首次总结：LeetCode 应该怎么刷？</a></li>
<li><a href="https://www.zhihu.com/question/36738189">LeetCode按照怎样的顺序来刷题比较好？</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/349940945">Leetcode面试高频题分类刷题总结</a></li>
<li><a href="https://www.cnblogs.com/grandyang/p/4606334.html">LeetCode All in One 题目讲解汇总</a></li>
</ul>


<p>另外，在<a href="https://github.com">GitHub</a>上面，也有大量的优质的LeetCode资源：</p>

<ul>
<li><a href="https://github.com/azl397985856/leetcode">LeetCode Solutions: A Record of My Problem Solving Journey</a></li>
<li><a href="https://github.com/haoel/leetcode">LeetCode Problems&#8217; Solutions</a>.   耗子叔出品的</li>
<li><a href="https://github.com/soulmachine/leetcode">LeetCode题解，151道题完整版</a></li>
<li><a href="https://github.com/doocs/leetcode">LeetCode solutions in any programming language</a></li>
<li><a href="https://github.com/MisterBooo/LeetCodeAnimation">Demonstrate all the questions on LeetCode in the form of animation</a>.  以动画的形式帮助你理解题解，非常棒的项目</li>
<li><a href="https://github.com/youngyangyang04/leetcode-master">《代码随想录》LeetCode 刷题攻略：200道经典题目刷题顺序，共60w字的详细图解，视频难点剖析，50余张思维导图，支持C++，Java，Python，Go，JavaScript等多语言版本，从此算法学习不再迷茫</a></li>
<li><a href="https://github.com/yuanguangxin/LeetCode">LeetCode刷题记录与面试整理</a></li>
<li><a href="https://github.com/qiyuangong/leetcode">Python &amp; JAVA Solutions for Leetcode</a></li>
<li><a href="https://github.com/fishercoder1534/Leetcode">Solutions to LeetCode problems; updated daily. Subscribe to my YouTube channel for more.</a></li>
</ul>


<p>力扣与ACM OJ最大的区别就是在于它对编程语言支持丰富，并且并不限制你使用标准库，比如C++可以用STL，比如Java可以用Collections，除非题目中有特别的限制，这个需要注意，就是在解题的时候思维不能受到局限，比如查询相关的题目，首先能想到的就是Map，但一般在ACM OJ时，通常不会往Map上想，因为是不允许使用现成的库的（起码当年我训练的时候是这样的），但LeetCode上面并没有这样的限制（其实这很符合实际项目），所以思维要打开，另外就是可以多多尝试，有没有限制试过后就知道了。</p>

<h2>更多的练习题</h2>

<p>力扣是以面试为核心，它上面的题集都集中在面试，特别是大厂和外企的常见面试题目。</p>

<p>之外，就是各种OJ了，这是各种信息竞赛算法竞赛和ACM的训练基地，题目也更广泛，难度也相当的高。</p>

<ul>
<li><a href="https://tco21.topcoder.com/">TopCoder</a></li>
<li><a href="https://codeforces.com/">CodeForces</a></li>
<li><a href="https://atcoder.jp/">AtCoder</a></li>
<li><a href="http://poj.org/">北大ACM OJ</a></li>
<li><a href="https://acm.hdu.edu.cn/">杭电ACM OJ</a></li>
</ul>


<h2>参考资料</h2>

<ul>
<li><a href="https://www.cnblogs.com/gzshan/p/10910831.html">【剑指Offer】剑指offer题目汇总 </a></li>
<li><a href="https://zhuanlan.zhihu.com/p/56200260">面试必刷-《剑指offer》刷题小结</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Java中整数基础知识]]></title>
    <link href="http://toughcoder.net/blog/2022/03/08/java-integer-basics/"/>
    <updated>2022-03-08T20:32:18+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/08/java-integer-basics</id>
    <content type="html"><![CDATA[<p>最近做了一道题，非常有意思，题本身很简单，但涉及到整数的最大值以及最小值，当写测试用例的时候，却犯了一个错误，发现最小整数并不是0xFFFFFFFF，我们来仔细看一下。</p>

<p><a href="http://toughcoder.net/blog/2022/03/08/java-integer-basics/"><img src="https://cdn.softwaretestinghelp.com/wp-content/qa/uploads/2020/06/Java-integer.png" title="auto auto" ></a></p>

<!-- more -->


<h2>整数基础</h2>

<p>Java中，整数都是有符号的，最高位是符号位，0表示正数，1表示负数。有四种，byte，short，int和long。</p>

<ul>
<li>byte 8位，-2<sup>7</sup> ~ 2<sup>7</sup> - 1，-128 ~ 127, 0x80 ~ 0x7F</li>
<li>short 16位，-2<sup>15</sup> ~ 2<sup>15</sup> - 1，-32768 ~ 32767, 0x8000 ~ 0x7FFF</li>
<li>int 32位，-2<sup>31</sup> ~ 2<sup>31</sup> -1，-2147483648 ~ 2147483647, 0x8000000 ~ 0x7FFFFFFF</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Max byte %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Min byte %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">Byte</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="o">(</span><span class="kt">byte</span><span class="o">)(</span><span class="n">Byte</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">)));</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Max short %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Min short %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">Short</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="o">(</span><span class="kt">short</span><span class="o">)</span> <span class="o">(</span><span class="n">Short</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">)));</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Max Int %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Min Int %d, 0x%X, half 0x%X&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">/</span><span class="mi">2</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Outputs</span>
</span><span class='line'><span class="c1">//Max byte 127, 0x7F, half 0x3F</span>
</span><span class='line'><span class="c1">//Min byte -128, 0x80, half 0xC0</span>
</span><span class='line'><span class="c1">//Max short 32767, 0x7FFF, half 0x3FFF</span>
</span><span class='line'><span class="c1">//Min short -32768, 0x8000, half 0xC000</span>
</span><span class='line'><span class="c1">//Max Int 2147483647, 0x7FFFFFFF, half 0x3FFFFFFF</span>
</span><span class='line'><span class="c1">//Min Int -2147483648, 0x80000000, half 0xC0000000</span>
</span></code></pre></td></tr></table></div></figure>


<h3>细节和原理</h3>

<p>值得注意的是，16进制的数值与直觉预期并不一样，特别是负数。正数是一致的，比如int，一共是32位，最高位是符号，所以真正数值部分是31位，那么最大的int就是0x7FFFFFF。</p>

<p>但负数，也即是最小的int，却与直觉完全不一样。按照直觉，负数最高位是1，那最小的int应该是0xFFFFFFFF啊，为何确是0x80000000呢？原因就是整数的编码方式并不是直接的二进制形式的，是以<a href="https://baike.baidu.com/item/%E8%A1%A5%E7%A0%81/6854613">补码的形式</a>，也就是说在内部实现中，用二进制表示一个整数的时候，是以二进制补码形式（转成二进制后还要求其补码，才是真实的二进制和16进制形式）。</p>

<p>简单来说，补码是一种二进制编码形式，正数的补码就是它的本身，而负数的补码是其取反后加1，可以<a href="https://en.wikipedia.org/wiki/Two%27s_complement">参考百科上的定义</a>。</p>

<p>负数的转换：原码取反加1，即是补码，补码再转补码即得到原码（也可以补码减1再取反即是原码），符号位在转换过程中一直不变。</p>

<p><strong>注意：</strong>补码的严谨说法是2的补码（Twi&rsquo;s Complement），并不称作二进制补码。补码是为了能用加法的方式来计算减法。因此原码转补码时，取反加1，补码求原码时再求补码，避免用减法（虽然减1后再取反也能求得原码，但需要用到减法）。</p>

<h3>非10进制字面常量是补码形式</h3>

<p>在日常代码中，为了方便，通常都用16进制来写一些整数常量，这里就特别要注意了。16进制的字面常量，不会再进行补码转换，会当成补码直接使用。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Literal %d, 0x%X&quot;</span><span class="o">,</span> <span class="mh">0xffffffff</span><span class="o">,</span> <span class="mh">0xffffffff</span><span class="o">));</span>
</span><span class='line'><span class="c1">//Literal -1, 0xFFFFFFFF</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以，你写的0xFFFFFFFF是补码形式，它的原码是减1再取反，（32个1）减1，最低位变成0，前面31个1，再取反，就只剩下最后一位是1和最高位的符号位，因此是-1，注意符号位是不变的，在转换过程中。</p>

<p>而最小的整数是-2<sup>31</sup>，原码 形式应该是0x80000000，先取反变成了0xFFFFFFFF，再加1，符号位最高位不变的情况下，其余全变成了0，所以是0x80000000。</p>

<h2>最小整数</h2>

<p>开篇时说了，当时错误的认为0xFFFFFFFF是最小的整数，这里犯的第一个严重错误是，误把二进制的补码当成了原码，代码中的16进制（二进制）都是补码形式的，它的原码是0x80000001即-1。这个错误是比较明显的。</p>

<p>但另外的问题就是，假如都是二进制原码的情况下，为啥最小的整数是0x80000000而不是0xFFFFFFFFF。这是理解上的误区，整数的定义是，最高位是符号位，所以常规认知是全是1的情况是最大的数，加上符号不就变成最小的了么？这是以10进制思维，也就是二进制转换成为10进制后的想法。计算机只认识二进制，在最高位是1（负数）的情况下，哪个数最小？当然0x80000000最小啊，它除了符号位全是0，肯定 小于0xFFFFFFFF，因此从二进制的角度来理解，0x80000000是最小的整数。</p>

<p>而0xFFFFFFFF（原码）则是第2小的负整数，最高位是符号位，其余31位全是1，它的补码是0x80000001：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Literal %d 0x%X&quot;</span><span class="o">,</span> <span class="mh">0x80000001</span><span class="o">,</span> <span class="mh">0x80000001</span><span class="o">));</span>
</span><span class='line'><span class="c1">//Literal -2147483647 0x80000001</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>计算机中是以二进制补码来存储整数的，所以要从计算机的角度来理解比较，就是要用二进制的补码来比较两个数的大小。</strong></p>

<p>再次强调，<strong>我们写的源码当中的二进制（无论是字面常量，还是打印输出）都是补码形式，计算机看到的也是补码，比较也是补码，只有当转换成为10进制时，才会还原为原码并进行10进制转换</strong>。</p>

<p>由此得出，（注意，程序员眼睛看到的16进制全是补码形式）：</p>

<ul>
<li>0x80000000是最小的负数，原码为0x80000000，-2<sup>31</sup></li>
<li>0x80000001，第2小的负数（最小的0x80000000再加上1），原码为0xFFFFFFFF，-(2<sup>31</sup>-1)</li>
<li>0xFFFFFFFF，是-1，原码为0x80000001。它是最大的负数（-1是最大的负数）。0xFFFFFFFF（全是1）肯定 最大啊，最高位是1，是负数，所以是最大的负数。</li>
</ul>


<h2>一些有意思的值</h2>

<h3>Integer.MAX_VALUE + 1 = Integer.MIN_VALUE</h3>

<p>按理说应该溢出了，但如果以16进制去计算，就是这样的结果：0x7FFFFFFF + 1 = 0x80000000</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Max in %d (0x%X) + 1 = %d (0x%X)&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">+</span><span class="mi">1</span><span class="o">),</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">+</span><span class="mi">1</span><span class="o">)));</span>
</span><span class='line'><span class="c1">// Max in 2147483647 (0x7FFFFFFF) + 1 = -2147483648 (0x80000000)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Integer.MIN_VALUE - 1 = Integer.MAX_VALUE</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;Min in %d (0x%X) - 1 = %d (0x%X)&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">,</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">-</span><span class="mi">1</span><span class="o">),</span> <span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">MIN_VALUE</span><span class="o">-</span><span class="mi">1</span><span class="o">)));</span>
</span><span class='line'><span class="c1">//Min in -2147483648 (0x80000000) - 1 = 2147483647 (0x7FFFFFFF)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考资料</h2>

<ul>
<li><a href="https://zhuanlan.zhihu.com/p/103239461">为什么0xffffffff是-1？（计算机对整型的存储）</a></li>
<li><a href="https://www.cnblogs.com/zhangziqiu/archive/2011/03/30/computercode.html">原码, 反码, 补码 详解 </a></li>
<li><a href="https://segmentfault.com/a/1190000021511009">一文读懂原码、反码与补码</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/99082236">二进制的原码、反码、补码</a></li>
<li><a href="https://www.ruanyifeng.com/blog/2009/08/twos_complement.html">关于2的补码</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera 2教程之预览与加强]]></title>
    <link href="http://toughcoder.net/blog/2022/03/04/camera-2-preview-and-improvement/"/>
    <updated>2022-03-04T19:27:56+08:00</updated>
    <id>http://toughcoder.net/blog/2022/03/04/camera-2-preview-and-improvement</id>
    <content type="html"><![CDATA[<p><a href="http://toughcoder.net/blog/2022/02/28/camera2-api-made-easy/">前一篇文章</a>讲解了如何使用这套新的API，但仍有很多可以提升的空间，这篇重点来讲讲，如何提升预览画质和做一些加强。</p>

<p><a href="http://toughcoder.net/blog/2022/03/04/camera-2-preview-and-improvement/"><img src="https://www.edumobile.org/wp-content/uploads/2015/05/Camera-Preview-Example-in-Android-Programming.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>线程模型</h2>

<p>因为相机是属于硬件，操作起来可能会耗时，这套新的API也特别注意，因此加了很多异步化处理，所有的请求结果全是通过回调来进行的，并且需要调用者来指定一个回调所使用的线程。因此，我们需要一个专门用于camera操作的线程，用HandlerThread就可以，并把它控制在Activity的生命周期之中，比如在onCreate时启动此线程，在onDestroy时关闭。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>    <span class="n">attachCameraThread</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
</span><span class='line'>     <span class="n">detachCameraThread</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所有与camera相关的操作，均要在相机专属的HandlerThread中调用，与其他线程（如主线程）的交互均通过回调处理。</p>

<h2>关键对象</h2>

<p>为了进一步的封装和方便管理，需要两个关键对象的封装。</p>

<h3>CameraContext</h3>

<p>一个是CameraContext，负责管理相机的线程，外部所有的方法调用均应该通过它来进行，我们的目的是要把所有的相机相关操作封装在自己的线程里面，因此，暴露给外面的接口，必须统一，并且在开放的方法中加入线程检查，如果还没有启动HandlerThread，就报错，调用者需要先attachThread：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CameraContext</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">LOG_TAG</span> <span class="o">=</span> <span class="n">CameraContext</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CameraManagerWrapper</span> <span class="n">cameraManager</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">HandlerThread</span> <span class="n">cameraManageThread</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">CameraThreadHandler</span> <span class="n">cameraThreadHandler</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">volatile</span> <span class="n">CameraAgent</span> <span class="n">currentCamera</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CameraContext</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">cameraManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CameraManagerWrapper</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">attachThread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;attachThread&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraThreadHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cameraThreadHandler</span><span class="o">.</span><span class="na">removeCallbacksAndMessages</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraManageThread</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">quitSafely</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="n">cameraManageThread</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HandlerThread</span><span class="o">(</span><span class="s">&quot;Camera Management Thread&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="n">cameraThreadHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CameraThreadHandler</span><span class="o">(</span><span class="n">cameraManageThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">detachThread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;detachThread&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraManageThread</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>             <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">quitSafely</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkThread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraManageThread</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">cameraManageThread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CameraSetupException</span><span class="o">(</span><span class="s">&quot;attachThread must be called before any other method invocations.&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">openCamera</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">checkThread</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Runnable</span> <span class="n">actionOpen</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// ...</span>
</span><span class='line'>        <span class="o">};</span>
</span><span class='line'>        <span class="n">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">cameraThreadHandler</span><span class="o">,</span> <span class="n">actionOpen</span><span class="o">);</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">CameraThreadHandler</span><span class="o">.</span><span class="na">MSG_OPEN_CAMERA</span><span class="o">;</span>
</span><span class='line'>        <span class="n">msg</span><span class="o">.</span><span class="na">sendToTarget</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closeCamera</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">checkThread</span><span class="o">();</span>
</span><span class='line'>        <span class="n">Runnable</span> <span class="n">actionClose</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="n">Message</span> <span class="n">msgClose</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="na">obtain</span><span class="o">(</span><span class="n">cameraThreadHandler</span><span class="o">,</span> <span class="n">actionClose</span><span class="o">);</span>
</span><span class='line'>        <span class="n">msgClose</span><span class="o">.</span><span class="na">what</span> <span class="o">=</span> <span class="n">CameraThreadHandler</span><span class="o">.</span><span class="na">MSG_CLOSE_CAMERA</span><span class="o">;</span>
</span><span class='line'>        <span class="n">msgClose</span><span class="o">.</span><span class="na">sendToTarget</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CameraAgent</h3>

<p>还需要对CameraDevice进行封装，把CameraCaptureSession，以及RequestBuilder，封装在内，并且在三大回调Device State Callback，Session State Callback以及Session Capture Callback也都封装在内，因此这些东西的生命周期全都是在CameraDevice内部的。</p>

<p>设计要点：</p>

<ul>
<li>CameraAgent不开放接口给外部，它只能开放给CameraContext使用</li>
<li>对象是对camera device的完整封装，对象本身一直可用，与CameraDevice是否打开无直接关系</li>
<li>随时可以查询静态配置属性，创建对象时就要传入id和CameraCharacteristics</li>
<li>有连接状态，也即打开对应的CameraDevice，动态配置属性查询，以及像启动预览，必须要是连接状态</li>
<li>拍照应该在预览状态内</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">CameraAgent</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="n">LOG_TAG</span> <span class="o">=</span> <span class="n">CameraAgent</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CameraCharacteristics</span> <span class="n">characteristics</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CameraContext</span><span class="o">.</span><span class="na">CameraThreadHandler</span> <span class="n">cameraHandler</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Executor</span> <span class="n">executor</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">CameraDevice</span><span class="o">&gt;</span> <span class="n">cameraDevice</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">CameraCaptureSession</span><span class="o">&gt;</span> <span class="n">captureSession</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">CameraDevice</span><span class="o">.</span><span class="na">StateCallback</span> <span class="n">stateCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraDevice</span><span class="o">.</span><span class="na">StateCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpened</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Device Status: onOpened&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">camera</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisconnected</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Device Status: onDisconnected&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">,</span> <span class="kt">int</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">StateCallback</span> <span class="n">regularSessionCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">StateCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigured</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Session State: onConfigured&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigureFailed</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClosed</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Session State: onClosed&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="kd">super</span><span class="o">.</span><span class="na">onClosed</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
</span><span class='line'>            <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">CaptureCallback</span> <span class="n">captureCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">CaptureCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCaptureStarted</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">CaptureRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="kt">long</span> <span class="n">frameNumber</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">super</span><span class="o">.</span><span class="na">onCaptureStarted</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">frameNumber</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">CaptureRequest</span><span class="o">.</span><span class="na">Builder</span> <span class="n">requestBuilder</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CameraAgent</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">,</span> <span class="n">CameraCharacteristics</span> <span class="n">cameraCharacteristics</span><span class="o">,</span> <span class="n">CameraContext</span><span class="o">.</span><span class="na">CameraThreadHandler</span> <span class="n">handler</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">characteristics</span> <span class="o">=</span> <span class="n">cameraCharacteristics</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">cameraHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">;</span>
</span><span class='line'>        <span class="n">executor</span> <span class="o">=</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">handler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="n">previewSize</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="n">errorCode</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">String</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">boolean</span> <span class="nf">connected</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">cameraDevice</span><span class="o">.</span><span class="na">isPresent</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CameraDevice</span><span class="o">.</span><span class="na">StateCallback</span> <span class="nf">getDeviceStateCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">stateCallback</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">connect</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraManagerWrapper</span> <span class="n">wrapper</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;connect&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">wrapper</span><span class="o">.</span><span class="na">openCamera</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">cameraHandler</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">disconnect</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;disconnect&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">captureSession</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">captureSession</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraDevice</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">startPreview</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">stopPreview</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>启动预览</h2>

<p>新的这套API并没有直接设置预览大小或者图片大小的地方，camera的输出都是Surface，底层是通过Surface的大小来做具体的尺寸。本质上都是数据在流动，其实都是buffer，Surface也是buffer，设定了Surface的大小，也就确定了输出buffer的大小，camera硬件也就知道了大小。</p>

<h3>用SurfaceView就可以</h3>

<p>预览是camera的输出，是另外一些组件的输入，API设计已做好了衔接，Surface就是中间的桥梁，Surface作为SurfaceView（可理解为屏幕）的输入，它可以作为camera的输出，由此便把camera的预览显示了出来。在布局文件中用SurfaceView来充当Activity的布局，由此便能得到Surface，再把它塞给camera即可。</p>

<p>需要重点说一下尺寸的约束，想让预览的Surface反应camera预览的尺寸，因此SurfaceView要是wrap_content的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;androidx.constraintlayout.widget.ConstraintLayout</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">xmlns:app=</span><span class="s">&quot;http://schemas.android.com/apk/res-auto&quot;</span>
</span><span class='line'>    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span>
</span><span class='line'>    <span class="na">android:layout_width=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="na">android:layout_height=</span><span class="s">&quot;match_parent&quot;</span>
</span><span class='line'>    <span class="na">android:background=</span><span class="s">&quot;@color/black&quot;</span>
</span><span class='line'>    <span class="na">tools:context=</span><span class="s">&quot;.CameraActivity&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;net.toughcoder.effectivecamera.AutoFitSurfaceView</span>
</span><span class='line'>        <span class="na">android:id=</span><span class="s">&quot;@+id/view_finder&quot;</span>
</span><span class='line'>        <span class="na">android:layout_width=</span><span class="s">&quot;wrap_content&quot;</span>
</span><span class='line'>        <span class="na">android:layout_height=</span><span class="s">&quot;wrap_content&quot;</span>
</span><span class='line'>        <span class="na">app:layout_constraintTop_toTopOf=</span><span class="s">&quot;parent&quot;</span>
</span><span class='line'>        <span class="na">app:layout_constraintLeft_toLeftOf=</span><span class="s">&quot;parent&quot;</span>
</span><span class='line'>        <span class="na">app:layout_constraintLeft_toRightOf=</span><span class="s">&quot;parent&quot;</span>
</span><span class='line'>        <span class="na">app:layout_constraintBottom_toBottomOf=</span><span class="s">&quot;parent&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>如何选择预览尺寸</h3>

<p>输入的约束条件是一个比例，比如流行的预览比例是4：3，16：9或者全屏，这个比例是长边与短边的比值，这个可以作为用户体验层面的一个约束，或者叫做设置，尺寸的选择应该遵守此约束。</p>

<p>另外一个约束就是屏幕尺寸，预览的大小应该能刚好满足屏幕尺寸即可，超出屏幕其实就浪费了，没有必要。</p>

<p>所以，选择预览尺寸的策略就是保证比例和刚好满足屏幕。</p>

<p>每个camera都有支持的一组预览尺寸，按照 我们的策略从其中选择一个就可以了。预览尺寸从静态配置中就可以读得到，不需要连接状态，因此，可以在创建好CameraAgent对象后就可以进行尺寸选择，屏幕尺寸随时可获利，比例约束是一个设置随时可读取，因此这是可行的。</p>

<p>当选择好了预览尺寸后，要把它设置到SurfaceView中去，以让SurfaceView调整自身的大小。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Strategies:</span>
</span><span class='line'><span class="cm"> *  1) preview size should not be bigger than screen, which is not necessary.</span>
</span><span class='line'><span class="cm"> *  2) ratio should match.</span>
</span><span class='line'><span class="cm"> *  3) pick the largest one.</span>
</span><span class='line'><span class="cm"> *  4) if not found, use screen size.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">CameraSize</span><span class="o">&gt;</span> <span class="nf">calculatePreviewSize</span><span class="o">(</span><span class="n">Point</span> <span class="n">screenSize</span><span class="o">,</span> <span class="kt">float</span> <span class="n">ratio</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">screenSize</span><span class="o">.</span><span class="na">x</span><span class="o">,</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">y</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">Math</span><span class="o">.</span><span class="na">round</span><span class="o">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">),</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">y</span><span class="o">);</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">int</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">x</span> <span class="o">*</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">y</span><span class="o">;</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;screen size &quot;</span> <span class="o">+</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">x</span> <span class="o">+</span> <span class="s">&quot; x &quot;</span> <span class="o">+</span> <span class="n">screenSize</span><span class="o">.</span><span class="na">y</span> <span class="o">+</span>
</span><span class='line'>            <span class="s">&quot;, ratio &quot;</span> <span class="o">+</span> <span class="n">ratio</span> <span class="o">+</span> <span class="s">&quot;, desired width-&gt;&quot;</span> <span class="o">+</span> <span class="n">width</span> <span class="o">+</span> <span class="s">&quot;, height-&gt;&quot;</span> <span class="o">+</span> <span class="n">height</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">StreamConfigurationMap</span> <span class="n">streamMap</span> <span class="o">=</span> <span class="n">characteristics</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CameraCharacteristics</span><span class="o">.</span><span class="na">SCALER_STREAM_CONFIGURATION_MAP</span><span class="o">);</span>
</span><span class='line'>    <span class="n">Size</span><span class="o">[]</span> <span class="n">surfaceSizes</span> <span class="o">=</span> <span class="n">streamMap</span><span class="o">.</span><span class="na">getOutputSizes</span><span class="o">(</span><span class="n">Surface</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">surfaceSizes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">surfaceSizes</span> <span class="o">=</span> <span class="n">streamMap</span><span class="o">.</span><span class="na">getOutputSizes</span><span class="o">(</span><span class="n">ImageFormat</span><span class="o">.</span><span class="na">PRIVATE</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">List</span><span class="o">&lt;</span><span class="n">CameraSize</span><span class="o">&gt;</span> <span class="n">supportedSize</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">surfaceSizes</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CameraSize:</span><span class="o">:</span><span class="k">new</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">size</span> <span class="o">-&gt;</span> <span class="n">size</span><span class="o">.</span><span class="na">height</span> <span class="o">*</span> <span class="n">size</span><span class="o">.</span><span class="na">width</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="nl">CameraSize:</span><span class="o">:</span><span class="n">compare</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;supportedSize &quot;</span> <span class="o">+</span> <span class="n">supportedSize</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">supportedSize</span><span class="o">.</span><span class="na">stream</span><span class="o">().</span><span class="na">filter</span><span class="o">(</span><span class="n">size</span> <span class="o">-&gt;</span> <span class="n">size</span><span class="o">.</span><span class="na">matchRatio</span><span class="o">(</span><span class="n">ratio</span><span class="o">)).</span><span class="na">findFirst</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<h2>确保关闭</h2>

<p>相机是一种硬件资源，当退出的时候要能确保它是关闭状态的，也就是说要确保CameraAgent#disconnect能执行，且要执行完成，执行完成的意思是，你需要收到onDisconnected的回调。</p>

<p>这就要求我们在detachThread，即退出相机线程的时候，要小心处理好尚未来得及执行（如有）的操作，因为所有的操作都会转到相机线程中去，是通过消息队列，所以操作可能还在排队中尚未真正执行。</p>

<p>具体做法是，直接移除掉未得到执行的open和其他操作。如果有pending状态的关闭，则要先让其执行，并且把关闭线程的操作放到CameraDevice State Callcback的onDisconnect中，也就是说待CameraDevice完全关闭完成后，才可以终止相机线程：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">detachThread</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;detachThread&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">cameraThreadHandler</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Drop all pending open actions</span>
</span><span class='line'>        <span class="n">cameraThreadHandler</span><span class="o">.</span><span class="na">removeMessages</span><span class="o">(</span><span class="n">CameraThreadHandler</span><span class="o">.</span><span class="na">MSG_OPEN_CAMERA</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">cameraThreadHandler</span><span class="o">.</span><span class="na">hasMessages</span><span class="o">(</span><span class="n">CameraThreadHandler</span><span class="o">.</span><span class="na">MSG_CLOSE_CAMERA</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Ensure close actions are dispatched.</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">50</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="c1">// Drop all other messages.</span>
</span><span class='line'>        <span class="n">cameraThreadHandler</span><span class="o">.</span><span class="na">removeCallbacksAndMessages</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="c1">// TODO: technically speaking, should do this in handler thread</span>
</span><span class='line'>    <span class="c1">// since all connect/disconnect are done inside handler thread</span>
</span><span class='line'>    <span class="c1">// status might not be synced with caller&#39;s thread.</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">cameraManageThread</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">isAlive</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">currentCamera</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">currentCamera</span><span class="o">.</span><span class="na">connected</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">currentCamera</span><span class="o">.</span><span class="na">addDisconnectedAction</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">quitSafely</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">cameraManageThread</span><span class="o">.</span><span class="na">quitSafely</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Camera2 API Made Easy]]></title>
    <link href="http://toughcoder.net/blog/2022/02/28/camera2-api-made-easy/"/>
    <updated>2022-02-28T23:42:34+08:00</updated>
    <id>http://toughcoder.net/blog/2022/02/28/camera2-api-made-easy</id>
    <content type="html"><![CDATA[<p>从Android 5.0 （API 21）开始谷歌废弃了<a href="https://developer.android.com/reference/android/hardware/Camera">Camera</a>，并提供了一套新的API，称之为<a href="https://developer.android.com/reference/android/hardware/camera2/package-summary">Camera 2</a>，不再是大而全的一个类了，也使用了更多的回调以异步化，流程与参数的控制更加的灵活，但也变得更加的复杂了，今天就来学习一下这套新API的使用方法。</p>

<p><a href="http://toughcoder.net/blog/2022/02/28/camera2-api-made-easy/"><img src="https://www.upphone.com/wp-content/uploads/2020/07/android-camera-settings.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>基本使用大法</h2>

<p>新的这一套API使用起来略复杂，涉及的较多的对象，可以按照如下步骤来使用。</p>

<h3>Step 1: 申请相机使用权限</h3>

<p>自从Android M（6.0）以后，对权限的限制比以前严格多了，必须要在运行时动态的去申请权限，征得用户同意后，方可正常使用。</p>

<p>需要在AndroidManifest中声明相机权限：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.CAMERA&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意</strong>：官方还建议在manifest中声明<a href="https://developer.android.com/guide/topics/manifest/uses-feature-element?hl=en">use camera feature</a>，但用处不大，这主要是给Google Play用的，Google Play可以根据这些方便精准投递你的app，如设备无camera硬件，或者硬件配置不支持，就不会安装，但就国内的市场来说基本用不到。</p>

<p>但这还不够，还需要在运行时动态检查，如果未授权，则要去申请，如仍被用户拒绝，则可直接退出，因为相机应用嘛，没有相机权限啥也做不了。一般来说，这个过程放在onCreate中做就可以了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
</span><span class='line'>    <span class="n">setContentView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_camera</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ContextCompat</span><span class="o">.</span><span class="na">checkSelfPermission</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span> <span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">CAMERA</span><span class="o">)</span> <span class="o">==</span>
</span><span class='line'>            <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">setupCamera</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">requestPermissions</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[]{</span><span class="n">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">CAMERA</span><span class="o">},</span> <span class="n">REQ_CODE_PERM</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRequestPermissionsResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">requestCode</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">String</span><span class="o">[]</span> <span class="n">permissions</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">grantResults</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">super</span><span class="o">.</span><span class="na">onRequestPermissionsResult</span><span class="o">(</span><span class="n">requestCode</span><span class="o">,</span> <span class="n">permissions</span><span class="o">,</span> <span class="n">grantResults</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">requestCode</span> <span class="o">==</span> <span class="n">REQ_CODE_PERM</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">grantResults</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">grantResults</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">PERMISSION_GRANTED</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">setupCamera</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Toast</span><span class="o">.</span><span class="na">makeText</span><span class="o">(</span><span class="n">getApplicationContext</span><span class="o">(),</span>
</span><span class='line'>                    <span class="s">&quot;To use this app you must grant CAMERA permission.&quot;</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">Toast</span><span class="o">.</span><span class="na">LENGTH_LONG</span><span class="o">).</span><span class="na">show</span><span class="o">();</span>
</span><span class='line'>            <span class="n">finish</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>注意</strong>：不建议放在onResume中去做，因为可能会造成死循环，比如权限申请，虽然看起来像一个对话框，但其实是一个Activity，也就是说从权限授权那个弹窗页面回来，是会走onResume的，如果用户同意授予了还好，直接就往下走流程了，假如用户拒绝了权限，检查发现权限还未授予，会继续去申请，这就会死循环了。</p>

<p>权限申请是必须要做，且要处理好，在应用的入口做好处理，保证后面的流程权限是有的，这样可以为业务逻辑减轻复担，里面就可以不用管权限了。基于这样的假设：要么权限已授予，要么就不会走进来（无权限时应该直接退出）。</p>

<h3>Step 2: 获取相机的配置情况</h3>

<p>处理好了权限以后，就要真正开始搞了，无论你的use case是什么，第一步肯定 是获取相机的配置信息情况，也就是说要搞清楚有几个硬件camera可以用，它的能力是什么（输出能满足什么样的需求），它的特点是什么（前置还是后置）。这里最主要用到的是就是<a href="https://developer.android.com/reference/android/hardware/camera2/CameraManager">CameraManager</a>对象，它是一个注册在ServiceManager里面的独立service，所以可以通过Context来获取：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">cameraManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">CameraManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CAMERA_SERVICE</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后就是获取当前有多少可用的摄像头：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">String</span><span class="o">[]</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraIdList</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个列表就是当前可用的camera，用一个String形式的id来标识，查询具体的摄像头的能力和配置都需要传入对应的id，比如说简单的dump一下信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">enumerateCameras</span><span class="o">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">consumer</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>   <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cameraIds</span> <span class="o">=</span> <span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraIdList</span><span class="o">();</span>
</span><span class='line'>   <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">status</span> <span class="o">=</span> <span class="n">cameraIds</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">cameraManager:</span><span class="o">:</span><span class="n">getCameraCharacteristics</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">CameraContext:</span><span class="o">:</span><span class="n">dumpCameraInfo</span><span class="o">)</span>
</span><span class='line'>                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">dumpCameraInfo</span><span class="o">(</span><span class="n">CameraCharacteristics</span> <span class="n">characteristics</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="o">();</span>
</span><span class='line'>    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;{Physical Id: &quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">characteristics</span><span class="o">.</span><span class="na">getPhysicalCameraIds</span><span class="o">());</span>
</span><span class='line'>    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, Facing: &quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">facing</span> <span class="o">=</span> <span class="n">characteristics</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CameraCharacteristics</span><span class="o">.</span><span class="na">LENS_FACING</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">facing</span> <span class="o">==</span> <span class="n">CameraMetadata</span><span class="o">.</span><span class="na">LENS_FACING_FRONT</span> <span class="o">?</span> <span class="s">&quot;FRONT&quot;</span> <span class="o">:</span> <span class="s">&quot;BACK&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;}&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为大多数场景都是默认使用后摄，但要先把找出来：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">cameraIds</span> <span class="o">=</span> <span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraIdList</span><span class="o">();</span>
</span><span class='line'>   <span class="n">cameraIds</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">id</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">CameraCharacteristics</span> <span class="n">cc</span> <span class="o">=</span> <span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraCharacteristics</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">cc</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">CameraCharacteristics</span><span class="o">.</span><span class="na">LENS_FACING</span><span class="o">)</span> <span class="o">==</span> <span class="n">CameraMetadata</span><span class="o">.</span><span class="na">LENS_FACING_BACK</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">currentCamera</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">CameraAgent</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">cc</span><span class="o">,</span> <span class="n">cameraThreadHandler</span><span class="o">);</span>
</span><span class='line'>                            <span class="k">return</span><span class="o">;</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>            <span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为官方的CameraManager封装略差一些，以及它的每一个方法都要检查权限异常，所以做一下进一步的简单封装：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">CameraManagerWrapper</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">CameraManager</span> <span class="n">cameraManager</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">CameraManagerWrapper</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">cameraManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">CameraManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CAMERA_SERVICE</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">getCameraIdList</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraIdList</span><span class="o">());</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="n">CameraCharacteristics</span> <span class="nf">getCameraCharacteristics</span><span class="o">(</span><span class="n">String</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">cameraManager</span><span class="o">.</span><span class="na">getCameraCharacteristics</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Step 3：打开相机</h3>

<p>找到了摄像头，下一步就可以尝试打开并使用了。通过<a href="https://developer.android.com/reference/android/hardware/camera2/CameraManager#openCamera(java.lang.String,%20android.hardware.camera2.CameraDevice.StateCallback,%20android.os.Handler">CameraManager#openCamera</a>)来获取<a href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice">CameraDevice</a>对象，这里的CameraDevice就是一个摄像头的封装，后面所有的操作都要在它上面进行。还需要提供一个<a href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice.StateCallback">CameraDevice.StateCallback</a>，以及一个Handler，它是用于StateCallback运行的线程，也就是说StateCallback的几个方法都是在Handler所在的线程中运行的。</p>

<p>因为打开摄像头是需要去操作硬件的，所以可能会耗时，因此，在这里引入了异步的回调，用以通知打开的结果CameraManager#openCamera是没有任何返回值的，结果 是通过StateCallback来通知给应用程序，且是运行在指定的<a href="https://developer.android.com/reference/android/os/Handler">Handler</a>中的，如果不传Handler，那么StateCallback就会运行在主线程中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">private</span> <span class="n">CameraDevice</span><span class="o">.</span><span class="na">StateCallback</span> <span class="n">stateCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraDevice</span><span class="o">.</span><span class="na">StateCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onOpened</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Device Status: onOpened&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">camera</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onDisconnected</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Device Status: onDisconnected&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="n">errorCode</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraDevice</span> <span class="n">camera</span><span class="o">,</span> <span class="kt">int</span> <span class="n">error</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">cameraDevice</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>        <span class="n">errorCode</span> <span class="o">=</span> <span class="n">error</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">cameraManager</span><span class="o">.</span><span class="na">openCamera</span><span class="o">(</span><span class="n">backId</span><span class="o">,</span> <span class="n">stateCallback</span><span class="o">,</span> <span class="n">handler</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>打开操作仅是一个开端，本身也没有特别复杂的，就是需要在StateCallback中做好处理就可以了。</p>

<h3>Step 4： 创建拍照会话</h3>

<p>下一步就是要创建拍照会话，对于每一个CameraDevice，打开了以后，要想使用必须创建一个<a href="https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession">CameraCaptureSession</a>，所有的use case都需要通过有效的CameraCaptureSeesion对象来实现（如预览和拍照），CameraDevice对象本身提供的功能并不多。与打开类似，也需要提供一个<a href="https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession.StateCallback">CameraCaptureSession.StateCallback</a>以接收创建session的结果，同时也要提供一个StateCallback使用的线程Handler：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">StateCallback</span> <span class="n">regularSessionCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">StateCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigured</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Session State: onConfigured&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigureFailed</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onClosed</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Session State: onClosed&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onClosed</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
</span><span class='line'>        <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createCaptureSession</span><span class="o">(</span><span class="n">Surface</span> <span class="n">surface</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SessionConfiguration</span> <span class="n">sessionConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SessionConfiguration</span><span class="o">(</span>
</span><span class='line'>            <span class="n">SessionConfiguration</span><span class="o">.</span><span class="na">SESSION_REGULAR</span><span class="o">,</span>
</span><span class='line'>            <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="nf">OutputConfiguration</span><span class="o">(</span><span class="n">surface</span><span class="o">)),</span>
</span><span class='line'>            <span class="n">executor</span><span class="o">,</span>
</span><span class='line'>            <span class="n">regularSessionCallback</span><span class="o">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">createCaptureSession</span><span class="o">(</span><span class="n">sessionConfig</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意，同时需要提供一个camera的输出目标，比如预览的Surface。另外就是，创建CaptureSession是有2个API的，以前常用的是<a href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice#createCaptureSession(java.util.List%3Candroid.view.Surface%3E,%20android.hardware.camera2.CameraCaptureSession.StateCallback,%20android.os.Handler">createCaptureSession(List<Surface> outputs, CameraCaptureSession.StateCallback callback, Handler handler)</a>)，但这个方法已被标记为Deprecated的了，推荐使用<a href="https://developer.android.com/reference/android/hardware/camera2/CameraDevice#createCaptureSession(android.hardware.camera2.params.SessionConfiguration">createCaptureSession(SessionConfiguration config)</a>)。这两者基本没区别，所需要传入的参数 都差不多，唯一不同的就是供回调所使用的线程，旧的API是用Handler，新的这个要求是<a href="https://developer.android.com/reference/java/util/concurrent/Executor">Executor</a>，这里有些不太一致，但容易解决，通过Handler可以很容易的创建出来一个Executor：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">executor</span> <span class="o">=</span> <span class="n">command</span> <span class="o">-&gt;</span> <span class="n">handler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Step 5：请求预览</h3>

<p>有了CameraCaptureSession对象以后，就可以启动预览了，这个是相机类应用的最为基础的一个use case。</p>

<p>主要是通过<a href="https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession#setRepeatingRequest(android.hardware.camera2.CaptureRequest,%20android.hardware.camera2.CameraCaptureSession.CaptureCallback,%20android.os.Handler">setRepeatingRequest</a>)这个方法，需要提供一个<a href="https://developer.android.com/reference/android/hardware/camera2/CaptureRequest">CaptureRequest</a>，一个<a href="https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession.CaptureCallback">CaptureCallback</a>以及一个供回调使用的Handler，其实，这一步通常与Step 4融合在一起：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="c1">// 省略的代码</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onConfigured</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span> <span class="s">&quot;Session State: onConfigured&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">captureSession</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">session</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// In session state callback</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">captureSession</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">setRepeatingRequest</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">(),</span> <span class="n">captureCallback</span><span class="o">,</span> <span class="n">cameraHandler</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>   <span class="c1">// 省略的代码</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">CaptureCallback</span> <span class="n">captureCallback</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CameraCaptureSession</span><span class="o">.</span><span class="na">CaptureCallback</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCaptureStarted</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="n">CameraCaptureSession</span> <span class="n">session</span><span class="o">,</span> <span class="nd">@NonNull</span> <span class="n">CaptureRequest</span> <span class="n">request</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timestamp</span><span class="o">,</span> <span class="kt">long</span> <span class="n">frameNumber</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onCaptureStarted</span><span class="o">(</span><span class="n">session</span><span class="o">,</span> <span class="n">request</span><span class="o">,</span> <span class="n">timestamp</span><span class="o">,</span> <span class="n">frameNumber</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doStartPreview</span><span class="o">(</span><span class="n">Surface</span> <span class="n">surface</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">SessionConfiguration</span> <span class="n">sessionConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SessionConfiguration</span><span class="o">(</span>
</span><span class='line'>            <span class="n">SessionConfiguration</span><span class="o">.</span><span class="na">SESSION_REGULAR</span><span class="o">,</span>
</span><span class='line'>            <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="k">new</span> <span class="nf">OutputConfiguration</span><span class="o">(</span><span class="n">surface</span><span class="o">)),</span>
</span><span class='line'>            <span class="n">executor</span><span class="o">,</span>
</span><span class='line'>            <span class="n">regularSessionCallback</span><span class="o">);</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">requestBuilder</span> <span class="o">=</span> <span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">createCaptureRequest</span><span class="o">(</span><span class="n">CameraDevice</span><span class="o">.</span><span class="na">TEMPLATE_PREVIEW</span><span class="o">);</span>
</span><span class='line'>        <span class="n">requestBuilder</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">CaptureRequest</span><span class="o">.</span><span class="na">CONTROL_AF_MODE</span><span class="o">,</span> <span class="n">CaptureResult</span><span class="o">.</span><span class="na">CONTROL_AF_MODE_CONTINUOUS_PICTURE</span><span class="o">);</span>
</span><span class='line'>        <span class="n">requestBuilder</span><span class="o">.</span><span class="na">addTarget</span><span class="o">(</span><span class="n">surface</span><span class="o">);</span>
</span><span class='line'>        <span class="n">sessionConfig</span><span class="o">.</span><span class="na">setSessionParameters</span><span class="o">(</span><span class="n">requestBuilder</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cameraDevice</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">createCaptureSession</span><span class="o">(</span><span class="n">sessionConfig</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CameraAccessException</span> <span class="n">ignored</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>总结</h2>

<p>前面说了这么多，其实关键的就是三个对象和三个回调，三个对象分别是</p>

<ul>
<li>CameraManager &ndash; 用以获取静态的配置信息</li>
<li>CameraDevice &ndash; 用以创建拍照会话</li>
<li>CameraCaptureSession &ndash; 用以启动预览和进行拍照</li>
</ul>


<p>三大回调分别是：</p>

<ul>
<li>CameraDevice.StateCallback &ndash; 用于获取CameraDevice</li>
<li>CameraCaptureSession.StateCallback &ndash; 用于获取拍照会话</li>
<li>CameraCaptureSession.CaptureCallback &ndash; 用于获取预览和拍照的结果</li>
</ul>


<p>再有就是，提供回调的时候要提供一个回调发生的线程，通过Handler或者Executor来指定。因为硬件操作可能会耗时甚至完全卡死，所以回调和线程是用来实现异步的。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://www.freecodecamp.org/news/android-camera2-api-take-photos-and-videos/">Android Camera2 – How to Use the Camera2 API to Take Photos and Videos</a></li>
<li><a href="https://juejin.cn/post/6844904062798790663">Android Camera-Camera2使用</a></li>
<li><a href="https://www.jianshu.com/p/9a2e66916fcb">Android Camera2 教程 · 第一章 · 概览</a></li>
<li><a href="https://developer.aliyun.com/article/678342">android Camera2 API使用详解</a></li>
<li><a href="https://blog.csdn.net/afei__/article/details/85342597">Android Camera2 之 CameraDevice 详解</a></li>
<li><a href="https://www.jianshu.com/p/cad777db008e">Camera2开发(2)之CameraDevice类</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android Camera App开发学习路线]]></title>
    <link href="http://toughcoder.net/blog/2022/02/11/android-camera-app-ramp-up/"/>
    <updated>2022-02-11T20:59:14+08:00</updated>
    <id>http://toughcoder.net/blog/2022/02/11/android-camera-app-ramp-up</id>
    <content type="html"><![CDATA[<p>对于智能手机来说相机是非常重要的一个功能，它是影像的生产者，是新时代社交（图片，视频）内容的基础。后面我们将重点学习 一下安卓平台的Camera app开发。</p>

<p><a href="http://toughcoder.net/blog/2022/02/11/android-camera-app-ramp-up/"><img src="https://www.xda-developers.com/files/2018/09/best-android-camera.png" title="auto auto" ></a></p>

<!-- more -->


<h2><a href="https://developer.android.com/reference/android/hardware/camera2/package-summary">Camera 2 API</a></h2>

<p>学习如何使用新的API，以实例的方式来学习新一套API如何使用，最终成果将会是一个简单的，具有基础功能的Camera App。</p>

<p>有以下文档可供参考：</p>

<ul>
<li><a href="https://developer.android.com/training/camera2">Official training docs</a></li>
<li><a href="https://developer.android.com/training/camera">Camera</a></li>
</ul>


<p>同时谷歌也有一些官方的样例可供参考：</p>

<ul>
<li><a href="https://github.com/googlearchive/android-Camera2Basic">android-Camera2Basic</a></li>
<li><a href="https://github.com/googlearchive/android-Camera2Video">android-Camera2Video</a></li>
<li><a href="https://github.com/googlearchive/android-Camera2Raw">android-Camera2Raw</a></li>
<li><a href="https://github.com/android/camera-samples">Camera Samples Repository</a></li>
</ul>


<p>AOSP源码中的<a href="https://cs.android.com/android/platform/superproject/+/master:packages/apps/Camera2/">Camera2</a>也是值得学习和参考 的。</p>

<h2>Frameworks</h2>

<p>在学习完API如何使用以后，还需要深入学习一下API下面的框架层。正所谓知其然，更要知其所以然，看了Demo以及文档后谁都会有API，要想加深理解，就必须继续深挖。</p>

<p>这部分没有什么捷径，只能去啃<a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/base/core/java/android/hardware/camera2/">AOSP的源码</a>了。</p>

<h2><a href="https://cs.android.com/android/platform/superproject/+/master:frameworks/av/services/camera/libcameraservice/CameraService.cpp?q=cameraservice">CameraService</a></h2>

<p>这是Frameworks层的最后一环，它连接着Java层和HAL层，主要负责camera device的管理，如权限，打开与关闭的管理，在Android M之前并不是独立的进程，是放在media.server一起的，后来独立成为一个单独的系统级别的进程cameraserver，在ServiceManager中的名字是media.camera，可以通过如下命令查看它的状态：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>adb shell dumpsys media.camera</span></code></pre></td></tr></table></div></figure>


<h2><a href="https://developer.android.com/jetpack">Jetpack</a>中的<a href="https://developer.android.com/training/camerax">CameraX</a></h2>

<p>这是谷歌封装的库，用以简化API的调用，加快app开发进度。</p>

<h2>深入了解业务架构与技术栈</h2>

<p><a href="https://source.android.google.cn/devices/camera">AOSP中的文档也值得学习</a></p>

<h2><a href="https://source.codeaurora.org/quic/la/platform/packages/apps/SnapdragonCamera/tree/">SnapdragonCamera</a></h2>

<p>相机是技术栈当中最为复杂的一个，SoC平台是至关重要的，所以Qcom的SnapdragonCamera也是值得深入学习的。</p>

<h2>相机业务知识学习</h2>

<h2>封装</h2>

<p>相机是非常受硬件限制的，不同的SoC平台，不同的OEM厂商，以及不同的Android版本，API以及具体细节差异巨大，这给Camera app开发带来非常大的适配工作，那么可以把Camera app核心的业务封装成一个库，这样可以简化开发。</p>

<h2>架构</h2>

<p>如何架构一个Camera app。</p>

<h2>扩展功能</h2>

<p>除基本的拍照录像功能以外，可以扩展一些功能。</p>

<h2>优秀开源项目</h2>

<h3><a href="https://github.com/react-native-camera/react-native-camera">react-native-camera</a></h3>

<h3><a href="https://github.com/CameraKit/camerakit-android">camerakit-android</a></h3>

<h3><a href="https://github.com/google/cameraview">cameraview</a></h3>

<h3><a href="https://github.com/natario1/CameraView">CameraView</a></h3>

<h3><a href="https://github.com/RedApparat/Fotoapparat">Fotoapparat</a></h3>

<h3><a href="https://github.com/Skykai521/StickerCamera">StickerCamera</a></h3>

<h3><a href="https://github.com/CJT2325/CameraView">CameraView</a></h3>

<h3><a href="https://github.com/CainKernel/CainCamera">CainCamera</a></h3>

<h3><a href="https://github.com/aserbao/AndroidCamera">AndroidCamera</a></h3>

<h3><a href="https://github.com/nekocode/CameraFilter">CameraFilter</a></h3>

<h3><a href="https://github.com/florent37/CameraFragment">CameraFragment</a></h3>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入学习Java虚拟机知识]]></title>
    <link href="http://toughcoder.net/blog/2022/02/08/study-further-the-java-virtual-machine/"/>
    <updated>2022-02-08T20:33:27+08:00</updated>
    <id>http://toughcoder.net/blog/2022/02/08/study-further-the-java-virtual-machine</id>
    <content type="html"><![CDATA[<p>Java编程语言的真核心是其<a href="https://www.geeksforgeeks.org/jvm-works-jvm-architecture/">虚拟机（Java Virtual Machine or JVM）</a>，JVM是真正的让Java宣言『Write Once，Run Anywhere』变成现实，JVM封装并隔离了不同的OS，JVM有它自己的标准和规范，从而凡是符合JVM的『代码』都可以在JVM上运行。Java编程语言并不是直接运行在JVM上面的，Java语言只是套在JVM上面的一层语言规则。</p>

<p><a href="http://toughcoder.net/blog/2022/02/08/study-further-the-java-virtual-machine/"><img src="https://javatutorial.net/wp-content/uploads/2017/10/write-once-run-anywhere-jvm.png" title="auto auto" ></a></p>

<!-- more -->


<p>准确的说JVM接收的是一套叫做<a href="https://www.javatpoint.com/java-bytecode">字节码（Bytecode）</a>的东西，只要是能把一套语法规则『翻译』成为符合JVM规范的字节码，就可以在JVM上面运行，除了正统的Java之外，<a href="https://scala-lang.org/">Scala</a>，<a href="http://www.groovy-lang.org/">Groovy</a>，以及<a href="https://kotlinlang.org/">Kotlin</a>等等都是这样实现的，它们编译之后得到的就是字节码文件，字节码文件可直接运行在JVM之上。</p>

<p>那么字节码才是Java编程语言的真核心，值得深入研究和学习。前面写过<a href="http://toughcoder.net/blog/2022/01/23/android-reverse-engineering-tricks/">一篇介绍安卓高级逆向方法的文章</a>，里面涉及到一些JVM的高级技术，还需要进一步的深入学习一下，以能更好的理解插件化和热修复的核心原理。</p>

<h2><a href="https://docs.oracle.com/javase/7/docs/api/java/lang/ClassLoader.html">ClassLoader</a></h2>

<p>除了标准Java中的以外，在Android当中的<a href="https://developer.android.com/reference/java/lang/ClassLoader">ClassLoader</a>也要深入学习一下，这个是相当多的逆向技术的基础，基本的原理和流程如委托机制看文章或者文档就可以了。</p>

<ul>
<li><a href="https://www.baeldung.com/java-classloaders">Class Loaders in Java</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/51374915">老大难的 Java ClassLoader 再不理解就老了</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/136083521">深入理解Android ClassLoader</a></li>
<li><a href="http://gityuan.com/2017/03/19/android-classloader/">Android类加载器ClassLoader</a></li>
</ul>


<p>需要重点记住的就是两点核心要点，一是ClassLoader是类的作用域，它是类的沙箱，同一个ClassLoader里面只能有一个类，必须唯一，但不同的ClassLoader对象，可以有同样的类。这里类的意思是全量类名，也即其packageName+ClassName，Fully Qualified Name。第二就是惰性加载机制，也就是说，对于同一个ClassLoader对象，一个类只会加载一次，加载过了，就不会再去loadClass了。</p>

<p>根据这两个核心要点，就理解了各种热修复的原理了，惰性加载机制决定了热生效和冷生效，因为ClassLoader只加载一次，所以Class替换的方式，只能下次启动生效（准确的说是下次需要loadClass时生效）。而替换的方法就是把修复的patch的想办法放在常规的前面，这样就会优先加载要替换的类了。</p>

<p><strong>注意</strong>：Android中并不是官方Java的bytecode，而一种叫做dex的东西，它是在编译时把标准Class文件经过转化再打包到一起形成的，最初安卓的VM叫做Dalvik，所以就把它的字节码命名为dex意即Dalvik Executable，这是dex的由来。虽然目标格式不一样，但是dex与class是可以自由转换的，且dex的生成在编译为标准class之后的，所以字节码的一切工具，对于安卓也都可以用。</p>

<p>Android中的ClassLoader，重点是DexPathList，它里面决定了各个dex的顺序，插件和热修复基本上都是在dex的顺序 上做文章，要么是把新的dex放在最前面，要么是找到原dex，然后替换，这就是核心原理，也是这一套逆向方法的可行之处。</p>

<h2><a href="https://www.oracle.com/technical-resources/articles/java/javareflection.html">反射</a></h2>

<p>也即是运行时修改代码的能力，它是直接去修改JVM中的代码，也即是修改bytecode。纯编译型语言如C/C++是不可能有这种能力的。Java有这种能力是因为JVM的存在，编译只是把源码『翻译』成字节码。</p>

<p><a href="https://www.baeldung.com/java-reflection">Guide to Java Reflection</a></p>

<p>原生东西不好用，还是用三方库来反射<a href="https://github.com/jOOQ/jOOR">jOOR</a>。</p>

<h2><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/intro.html">JNI</a></h2>

<p>一些三方的号称可以热修复的工具如exposed和Andfix这些东西，之所以能够实现，是因为JVM本身就开了口子支持JNI，为了能让方法能让JVM找得到，就需要一个method table，而此method table是可以被修改的。
<a href="https://www.baeldung.com/jni">Guide to JNI (Java Native Interface)</a></p>

<p><a href="https://blog.csdn.net/createchance/article/details/53783490">Java Native Interface(JNI)从零开始详细教程</a></p>

<p><a href="https://www.cnblogs.com/DengGao/p/jni.html">java native方法与JNI实现</a></p>

<p><a href="https://www.zhihu.com/question/38509124">JNI本身会降低效率吗？</a></p>

<p>如果JNI接口较多，较复杂，建议用<a href="http://www.swig.org/">SWIG</a>，参见它的<a href="http://www.swig.org/Doc1.3/Java.html#java_overview">说明文档</a>。</p>

<p>Swig有点重了，这个库也相当的好用<a href="https://github.com/spotify/JniHelpers">JniHelpers</a>。</p>

<h2><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/reflection/proxy.html">动态代理</a></h2>

<p>除了官方JDK支持的以接口为基础的动态代理 方式之外，还有其他几种以子类化方式实现动态代理，但它们都是基于ASM的。</p>

<p><a href="https://www.baeldung.com/java-dynamic-proxies">Dynamic Proxies in Java</a></p>

<p><a href="https://www.cnblogs.com/techyc/p/3455950.html">Java的动态代理(dynamic proxy)</a></p>

<p><a href="https://www.cnblogs.com/bryan31/p/15266725.html">动态代理大揭秘，带你彻底弄清楚动态代理！</a></p>

<ul>
<li><a href="https://github.com/cglib/cglib">cglib</a></li>
<li><a href="https://www.javassist.org/">Javassist</a></li>
<li><a href="https://bytebuddy.net/#/">Byte Buddy</a></li>
</ul>


<h2><a href="https://en.wikipedia.org/wiki/Java_code_coverage_tools">代码覆盖率检测</a></h2>

<p><a href="http://cobertura.github.io/cobertura/">Cobertura</a></p>

<p><a href="https://github.com/jacoco/jacoco">JaCoCo</a></p>

<p><a href="https://www.baeldung.com/jacoco">Intro to JaCoCo</a></p>

<h2>Mock</h2>

<p>这是自动化测试以及单元测试必然会用到的利器。</p>

<p><a href="https://site.mockito.org/">Mockito</a></p>

<p><a href="https://easymock.org/">EasyMock</a></p>

<h2><a href="https://asm.ow2.io/">ASM</a></h2>

<p>这是一个神器，专门用来处理字节码的，所有其他的Java底层工具都是基于它来实现的，足可见它的牛逼之处。</p>

<p><a href="https://www.baeldung.com/java-asm">A Guide to Java Bytecode Manipulation with ASM</a></p>

<h2><a href="https://www.tutorialsteacher.com/ioc/dependency-injection">Dependency Injection</a></h2>

<ul>
<li><a href="https://www.vogella.com/tutorials/DependencyInjection/article.html">Using dependency injection in Java</a></li>
<li><a href="https://www.codejava.net/coding/what-is-dependency-injection-with-java-code-example">What is Dependency Injection with Java Code Example</a></li>
<li><a href="https://www.edureka.co/blog/what-is-dependency-injection/">What Is Dependency Injection? – Know How To Implement Dependency Injection</a></li>
</ul>


<h2><a href="https://en.wikipedia.org/wiki/Aspect-oriented_programming">AOP</a></h2>

<ul>
<li><a href="https://mvolkmann.github.io/JavaUserGroup/AOP.pdf">Aspect-Oriented Programming (AOP)in Java</a></li>
<li><a href="https://o7planning.org/10257/java-aspect-oriented-programming-with-aspectj">Java Aspect Oriented Programming with AspectJ (AOP)</a></li>
<li><a href="https://www.javatpoint.com/spring-aop-example">Spring AOP Example</a></li>
<li><a href="https://www.eclipse.org/aspectj/">AspectJ</a></li>
<li><a href="https://github.com/eclipse/org.aspectj">Aspectj source</a></li>
<li><a href="https://www.baeldung.com/aspectj">Intro to AspectJ</a></li>
</ul>


<h2>研究字节码的意义</h2>

<p>所有这些基于字节码的工具和技术存在的意义，是帮助我们如何更好的写出Java代码，而并不是纯粹去做一些逆向工程的事情。比如，效率工具，测试工具，调试工具和动态生成代码的技术等等。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://zhuanlan.zhihu.com/p/94498015">史上最通俗易懂的ASM教程</a></li>
<li><a href="https://www.jianshu.com/p/26e99d39b3fb">Java字节码处理框架ASM设计思想解析</a></li>
<li><a href="https://blog.51cto.com/lsieun/2924583">Java ASM系列一：Core API</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android逆向技术高阶大法]]></title>
    <link href="http://toughcoder.net/blog/2022/01/23/android-reverse-engineering-tricks/"/>
    <updated>2022-01-23T11:39:55+08:00</updated>
    <id>http://toughcoder.net/blog/2022/01/23/android-reverse-engineering-tricks</id>
    <content type="html"><![CDATA[<p>安卓应用是一个客户端，与传统软件类似，需要把软件打包，然后通过某种渠道（应用市场）分发给用户，这是常规的发布方式，它的更新节奏很慢，从你在应用市场上更新后，到用户真正的执行升级，这中间很慢的，而且很多用户根本不会升级新版本，这对于互联网来说是极不友好的。传统的互联网，用户刷新一下网页后，就能看得到更新了，但对于客户端，这行不通，要想实现小时级别的发布和分钟级别的问题修复，正规的发布渠道是做不到的。于是各路大神和专家开始研究客户端的前端化，也就是运用各种技术能让发布，特别是一些问题修复性的小规模发布可以更快的传递到用户手中。</p>

<p><a href="http://toughcoder.net/blog/2022/01/23/android-reverse-engineering-tricks/"><img src="https://images.xiaozhuanlan.com/photo/2017/3709753fdbe5d81e50abb1090511b92a.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>这与正向方法不一样，谷歌或者水果针对 应用市场有明确 的流程的，这是常规发布也即是正向方式。今天我们来聊一聊非正向方法，非常规方式，来实现小模块的发布和热修复。</p>

<h2>核心技术原理</h2>

<p>任何一项技术都离不开编程语言和操作系统上的支持，对于插件化技术来说，最为核心的原理就是Java支持反射，这是一种运行时修改代码的技术，另外就是动态代理，这是插件化可行的根本技术支撑。</p>

<p>说到底，Java仍是一种解释型语言，它的核心是JVM，即也虚拟机，我们所熟悉的Java编程语言，本质上是套在JVM上的一层语法规则，换了一种语言规则也是可行的。就好比Kotlin，Scala和Groovy它们的语法与Java相差很大，但它们编译过后的字节码是完全符合JVM规范的，可以直接运行在JVM之上。</p>

<p>其他的纯解释型语言，如Python和JavaScript，它们在运行时可以动态的加载一段源码，这即是动态化，可以实现真正的插件化，运行时直接加载运行一段代码。Java略变态一些，但它本质上是JVM，而JVM通过反射和动态代理，在一定程度上支持了类似的动态化，就是通过ClassLoader来动态加载一些编译好的Class。</p>

<p>此为插件化的核心原理。</p>

<p>动态代理机制，可以读这几篇文章：</p>

<ul>
<li><a href="https://www.cnblogs.com/bryan31/p/15266725.html">动态代理大揭秘，带你彻底弄清楚动态代理</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1264804593397984">动态代理</a></li>
<li><a href="https://www.cnblogs.com/techyc/p/3455950.html">Java的动态代理(dynamic proxy) </a></li>
<li><a href="https://www.cnblogs.com/gonjan-blog/p/6685611.html">java动态代理实现与原理详细分析</a></li>
<li><a href="https://www.cnblogs.com/codingblock/p/6580364.html">小白也能看懂的插件化DroidPlugin原理（一）&ndash; 动态代理</a></li>
</ul>


<h2>Hook大法</h2>

<p>有了核心原理，才有可行的方案。Hook主要研究三方面内容，一是研究ClassLoader，因为不同的dex分属于不同的层级，它们的ClassLoader不一样，反射的第一步就是要能加载到想要的Class，这个要靠找到合适的ClassLoader；二是动态代理机制，hook的核心原理就是用动态代理机制，创建一个Mock对象用以替换掉原来的，所以接口Interface是关键，原系统设计中必须使用大量接口，并且是以标准方式使用的（没有强制向下转型downcast），这样你创建出来的动态代理去替换才是安全的；三就是学习安卓系统核心组件 的流程，以找到最佳的hook地点。</p>

<p>其实，第3条才是对大部分人最为有益的。</p>

<p>具体如何做hook，可以参考以下文章：</p>

<ul>
<li><a href="https://cloud.tencent.com/developer/article/1562137">Android 插件化原理解析——Service的插件化</a></li>
<li><a href="https://weishu.me/2016/03/07/understand-plugin-framework-ams-pms-hook/">Android 插件化原理解析——Hook机制之AMS&amp;PMS</a></li>
<li><a href="https://mp.weixin.qq.com/s/40NTVRw127JcJh_rL5HtwA">探索Android开源框架 - 10. 插件化原理</a></li>
<li><a href="https://www.cnblogs.com/codingblock/p/6642476.html">小白也能看懂的插件化DroidPlugin原理（二）&ndash; 反射机制和Hook入门</a></li>
</ul>


<p>由于安卓版本升级的原因，上面这几个文章都失效了，例子行不通了。但是这几遍对于原理解释的还是相当清楚的。</p>

<p>以下文章对于新版本也是适用的。</p>

<ul>
<li><a href="https://www.codenong.com/js57705d332677/">基于Android9.0的Hook Activity 的启动（插件化）</a></li>
<li><a href="https://www.jianshu.com/p/eb4121b037e2">Android Hook Activity 的几种姿势</a></li>
<li><a href="https://juejin.cn/post/6844903769650511879">Activity插件化原理第一种方案：Hook Instrumentation</a></li>
<li><a href="https://juejin.cn/post/6844903773823827975">Activity插件化原理第二种方案：Hook IActivityManager</a></li>
<li><a href="https://blog.csdn.net/qq_24675479/article/details/79334567">拦截Activity的启动流程绕过AndroidManifest检测</a></li>
</ul>


<p>需要注意的是，hook这件事情，最基础的技术很简单，就通过反射来替换对象，把系统中的对象替换为仿造的，仿造有三种方式，一是直接创建，这需要类是比较简单的情况，并不需要开放出来，通过反射一切皆可创建；二是继续，这个对于复杂对象也能仿造，如Instrumentation，但是需要类是开放出来的；三是接口，通过动态代理 创建仿造对象（也即代理 ）。核心技术就这些。其他的，全是对于系统代码的理解，找到可行的关键点来进行hook。</p>

<p>另外就是，谷歌对逆向方法限制越来越严了，反射系统的东西，会有限制，有时仅是打印日志，但指不定哪天就不给反射了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Accessing hidden field Landroid/app/ActivityManager;-&gt;IActivityManagerSingleton:Landroid/util/Singleton; (light greylist, reflection)</span></code></pre></td></tr></table></div></figure>


<h2>插件化原理</h2>

<p>学习一门技术最好的方式就是去研读优秀的开源库的源码，对于插件化，现在有很多比较成熟 的开源框架存在了，可以挑几个比较有代表性的来研究 一下。</p>

<h3><a href="http://droidpluginteam.github.io/DroidPlugin/">DroidPlugin</a></h3>

<p>这个基于动态代理创建的插件方法，较为流行，里面有大量的hook技术，网络上也有很多解析此框架的<a href="https://blog.csdn.net/zhejiang9/article/details/89407283">文章</a>，可以帮助理解。</p>

<p>它用了大量的hook，优点就是插件本身可以是正常的apk，无太多的限制，就用常规的app开发方式开发就好，这是它的最大优势，因为对插件无限制，所以框架本身就需要做大量的hook，是学习hook技法的良好例子。</p>

<h3><a href="https://github.com/singwhatiwanna/dynamic-load-apk">DL : Apk动态加载框架</a></h3>

<p>这个是以静态代理为基础创建的插件框架，并没有大量的hook，可以参看它的解析<a href="https://www.jianshu.com/p/30114b7176a3">文章</a>。</p>

<p>任大神的框架适配性较好，基本上是纯软件层的技术（静态代理），没怎么hook。当然缺点也相当明显，就是对于插件的开发要求很苛刻，必须实现框架本身自定义的一坨东西，与安卓标准的app开发差异较大，且越来越大，并且对于打包和开发过程并无工具支持，在实际应用过程中较为麻烦。退一步讲，并未有真正达到插化的目的，它对插件的限制较大。</p>

<p>现在已经基本没人用了，不过这属于开山之作。</p>

<h3><a href="https://github.com/iqiyi/Qigsaw">Qigsaw</a></h3>

<p>这个与其他插件框架的最大差别在于，它最接近于官方的东西（<a href="https://developer.android.com/guide/app-bundle/">App bundle</a>），它的重点在于项目模块化和打包上面，对于常规理解上的『插件』所做的事情特别少，hook特别少，安装和加载插件的过程比较很简单，接近原生，核心在于它的打包过程。<a href="https://www.bookstack.cn/read/Qigsaw/c47ca9c7359b0d0d.md">这里</a>有详细的介绍。</p>

<p>另外，包建强的书<a href="https://item.jd.com/12408095.html">《Android插件化开发指南》</a>也可以读一读的，书的好处在于，它毕竟是一个整体，从基础的技术原理到hook原理都有讲，还是相当不错的。不过书比较旧了 ，要结合<a href="https://www.cnblogs.com/Jax/p/9316422.html">作者的勘误</a>，以及网上的文章一起来消化理解。</p>

<h2>热修复原理</h2>

<p>除了插件化，另外一个大厂热衷的技术便是热修复，这也是大厂头部应用的标配技术。其实插件化，也能实现热修复，比如某个插件，一般是厂里的一个业务，出问题了，紧急打包发布一个修复的版本，然后更新插件。不过，这略显笨重，相当于用牛刀去杀鸡了，总之就是效率不高。</p>

<p>真正的热修复技术讲究效率，且要小巧，针对 点对点式的修复。它的核心原理就是替换，用反射去替换类（修改dex classloader中的dex顺序），以及对方法的替换（侵入虚拟机中的method表，进行替换），还分冷生效（类替换一般是冷生效，也即下次启动时生效）和热生效（方法替换一般是热的，下次调用此方法时就生效了，因为它并不涉及classloader，无需要重新加载类），还有插桩式的，在代码中直接插桩，先检查有没有patch，有patch就先运行patch（这个思路最简单，适配性也好，但实行难度大，需要对现有代码进行插桩）。</p>

<p>这几篇文章有比较详细的讨论。</p>

<ul>
<li><a href="https://www.cnblogs.com/popfisher/p/8543973.html">Android热修复技术原理详解</a></li>
<li><a href="https://www.jianshu.com/p/6ae1e09ebbf5">Android热修复技术，你会怎么选？</a></li>
<li><a href="https://www.jianshu.com/p/8891f95f6e8e">探索Android开源框架 - 11. 热修复原理</a></li>
</ul>


<h3>具体的热修复工具</h3>

<h4>xposed派系</h4>

<p>也即原生的<a href="https://github.com/rovo89/Xposed">Xposed</a>和<a href="https://github.com/rovo89/XposedBridge">Xposed framework</a>
以及大阿里的衍生版本<a href="https://github.com/alibaba/dexposed">dexposed</a>。</p>

<p>针对 方法可以热生效的hook，当年Dalvik时代，这个东西还是相当牛逼的，时过境迁虽然Art上无法用了，但不妨用来学习。</p>

<h4><a href="https://github.com/alibaba/AndFix">Andfix</a></h4>

<p>原产自支付宝的与Xposed类似的方法级的hook工具，支持Dalvik与Art，值得使用和学习。</p>

<h4><a href="https://github.com/panhongwei/AndroidMethodHook">AndroidMethodHook</a></h4>

<p>可以用来学习sophix，sophix是大阿里的东西，把andfix以及dexposed商业化了，不再开源免费用了。这个项目比较接近它们，可以用来学习。</p>

<h4><a href="https://github.com/Tencent/tinker">Tinker</a></h4>

<p>微信出品的Tinker，核心技术还是用dex替换实现的class替换，冷生效。</p>

<p>它的重点在于补丁dex的差量生成，以及发布平台，还做成了收费平台，变成一种服务。所以，你看核心技术是由目标平台（安卓）决定的，原理大家也都懂，各家也都大差不差的，也都有开源现成的方案可以用，但这远远不够，整个链路是值得深挖的，这也是能产生商业价值的地方。</p>

<h4><a href="https://github.com/dodola/HotFix">HotFix</a></h4>

<p><a href="https://zhuanlan.zhihu.com/p/20308548">安卓App热补丁动态修复技术介绍</a></p>

<h4><a href="https://github.com/jasonross/Nuwa">Nuwa</a></h4>

<p><a href="https://www.cnblogs.com/fanfu1/p/5506149.html">安卓热更新之Nuwa实现步骤</a></p>

<h4><a href="https://github.com/Meituan-Dianping/Robust">Robust</a></h4>

<p><a href="https://tech.meituan.com/2017/03/17/android-autopatch.html">Android热更新方案Robust开源，新增自动化补丁工具</a></p>

<p>这个与Nuwa一样，都用了代码插桩，当然插桩过程，是用了字节码工具（如ASM），进行编译时自动化处理，最终字节码（APK）是受影响的，但源码层面是无感知的。</p>

<h2>瓶颈在哪里</h2>

<p>插件化这项技术，它的成本特别高，但收益有限，需要庞大的研发体系来支持，并且只有长期投入，才能产出一些价值。因此，现在来说只有头部大厂才真正玩得转。</p>

<h3>技术本身并不是瓶颈</h3>

<p>这项技术的可行性是由Java决定的，因此一直是可行的。但每年的Android版本，都会对核心组件进行不同程度的强化和升级，这会导致之前的一些方案可能一下子就失效了。另外，手机厂商可能也会做一些修改，不过一般都比较小。</p>

<p>安卓 版本升级，会对插件化有影响，甚至会让现有方案全部失效，但这个还真不是这项技术的瓶颈。因为安卓 升级较慢，正常一年一个版本，但是对核心组件大变化，通常几年才有一次，这个速度对比三方技术的演进还是相当慢的。前面说了这项技术头部大厂最为受益，因此他们会有专门的专家级别的人物在研究，谷歌出了政策，很快就会对策出来，一般用不了多久，插件化技术大拿们就能给出针对 新版本的解决方案。</p>

<p>由于开源和技术分享，很快便会在业界普及。因此，单就技术本身，绝不是瓶颈，并且由于开源的发展，核心业务本身都是开源的，大家都能很快使用最先进的技术。</p>

<h3>网络和平台能力才是瓶颈</h3>

<p>插件化这个事情，想要真正的用好，光有核心业务还是不够的。核心业务现在都有现成的开源库，拿过来就可以用，但这远远不够。</p>

<p>就从一个插件从开发人员手中到用户手中，并成功安装生效，这一过程拆来看需要多少东西吧：</p>

<ol>
<li>插件的开发，需要一些辅助工具。理想的情况下，一个插件模块的开发，应该与常规应用开发是一样的，但毕竟它的构建目标是一个插件，而非标准的app，所以你需要针对核心业务插件框架适用的一些开发工具。这个一般开源框架中都有提供，但不见得有那么好。</li>
<li>构建和打包。如果是一个合格的插件化框架，一定会有怎么构建 打包的配套设施。</li>
<li>测试和调试。这里面的难点在于，如何能尽可能的模拟真实的流程，并且能方便的来实施测试和验证结果</li>
<li>发布上线控制。一些细节就是如何精准推送，如何做灰度发布，以及发现问题后如何快速回滚（你看，这哪一项涉及插件化技术）</li>
<li>下载。客户端的一个最大的问题就是，客户端在客户那里，我们发布的东西都在服务器上，如何能让插件顺利的送达到用户手中。别小看这个，网络问题永远是出错误原因里面最多的一个，而且容易被测试忽略，因为研发人员自己的网络环境一般简单且稳定。（一个最简单的测试就是，当你在电梯里，地铁里，高铁时，厕所里，山上，河里，村里，手机里面的应用还有几个能正常联网的？）</li>
<li>安装和生效。这个也是插件化的核心业务，框架都会支持的。难点在于校验，就是客户端拿到的插件是不是符合预期的，文件有没有损坏，有没被篡改。</li>
<li>降级。这个通常插件化框架不会提供。降级的意思就是如果插件安装更新失败了，你怎么办？能否回滚，如果这个插件彻底废了，有没有H5页面可以用？</li>
</ol>


<p>我们粗略来看，就能分出上面7个步骤，其实还有更细的。上面这些里，插件化开源框架一定能解决的是2和6，1和3会在一定程度上支持。而其他的只有靠自己了，当然 也可能会有一些开源软件可以用，但它们并不纯是为了插件化而做的。这些东西都属于研发效率平台，甚至是涉及软件流程，基本上都属于商业公司的核心业务机密了，基本上是不可能开源的，而且不同的公司文化制度流程都不一样，即使开源给你了，也不一定用得上。但这恰恰又是最能体现一个公司结合技术实力的地方，小公司或者综合能力差的公司，即使有现成的插件化框架方案给你，你也用不好，因为配套设施不行。再次佐证，插件化这东西只有头部大厂才能玩得转，并产生正收益。</p>

<p>这些才是真正的瓶颈。</p>

<h2>这是逆向工程技术</h2>

<p>插件化需要用到大量的反射和动态代理技术去hook安卓系统，从而实现官方并不直接支持的特性，这属于逆向工程，与官方倡导的方向并不一致。</p>

<p>而且，只有在国内圈子里面才比较流行，国外的一些大厂和专家似乎并不愿意花时间和精力搞这些事情。很难简单的用好与坏来评价，只能说文化不同。</p>

<p>逆向工程技术局限性较大，很难长久发展， 一旦官方把某个关键地方堵住（不能说是漏洞，而一些关键的对象和接口），很多插件框架可能就废掉了，当然了道高一尺，魔高一丈，总还是能找到可以hook的地方，仍总感觉怪怪的。</p>

<p>常规的技术，如编程范式（函数式编程，Reactive，RxJava），编程语言，平台框架和轮子（如Picasso，如OkHttp），这些是纯正的技术，不受制于任何平台，不但能长久发展，更能反过来推动官方进步（如OkHttp已被谷歌内置为安卓内部作为HTTP协议的实现）。</p>

<p>综合来说，除非你需要专门研究插件化，并能得到收益之外（对业务，对公司，对个人），对于插件化技术，了解一下就够了，而且这东西并不能真正的提升软件质量（它带来的问题比它解决的要多很多）。不如把时间花在业务上面，花在编程范式，花在编程语言，花在流行的框架和轮子上面，这更能提升软件质量，且是终生受益的。毕竟，假如代码质量够好，发出去的版本都可控，都能达到预期，也就没必要折腾插件化了（即使是对大厂头部应用来说，版本的发布仍主要是靠正常的apk发布，插件迭代一般用在正常版本来不及时使用比如电商的双11期间）。</p>

<p><strong>研发工具（如Instant Run），调试工具（如获取 一些运行时的信息，在线调试），测试工具（如Mock），不侵入源码式编程（动态插桩，AOP和依赖注入）</strong>才是反射和动态代理以及Hook的最终归宿，是值得我们深入研究和学习的方向。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://www.kancloud.cn/alex_wsc/android/504478">动态注入技术（hook技术）</a></li>
<li><a href="https://www.jianshu.com/p/b30ea19c444b">Android插件化原理解析——Hook机制之动态代理</a></li>
<li><a href="https://blog.csdn.net/yulong0809/article/details/56842027">插件化知识详细分解及原理 之代理，hook，反射</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/109157321">盘点Android常用Hook技术</a></li>
<li><a href="https://www.jianshu.com/p/4f6d20076922">理解 Android Hook 技术以及简单实战</a></li>
<li><a href="https://tech.meituan.com/2018/02/02/android-anti-hooking.html">Android Hook技术防范漫谈</a></li>
<li><a href="https://juejin.cn/post/6844903941105270798">Android插件化——高手必备的Hook技术</a></li>
<li><a href="https://blog.csdn.net/gdutxiaoxu/article/details/81459830">Android Hook 机制之简单实战</a></li>
<li><a href="https://juejin.cn/post/6998085562573783076">字节跳动开源 Android PLT hook 方案 bhook</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[拥抱新时代的Java]]></title>
    <link href="http://toughcoder.net/blog/2022/01/17/develop-with-java-8/"/>
    <updated>2022-01-17T22:55:19+08:00</updated>
    <id>http://toughcoder.net/blog/2022/01/17/develop-with-java-8</id>
    <content type="html"><![CDATA[<p>Java作为面向对象编程的王牌语言，曾经风靡一时，在Web领域是绝对的老大。随着时间的推移，一些新的编程范式不断的涌现，如函数式编程，响应式编程，以及对函数的全力支持（Lambda函数）变成了大家经常谈论的话题。移动互联网的出现，以及前端的流行，让新一代的编程语言如<a href="https://scala-lang.org/">Scala</a>，<a href="http://www.groovy-lang.org/">Groovy</a>，<a href="https://developer.apple.com/swift/">Swift</a>以及<a href="https://kotlinlang.org/">Kotlin</a>都大受欢迎。以函数式编程为核心的新一代编程范式慢慢变成了主流。曾经的王者Java，一度被人垢病，因为对函数支持不友好，（其实最主要的原因是如何保持好向后兼容），但也与时俱进，终于在Java 8版本迈出了重大的一步，完全支持了函数式编程。本篇将重点讨论Java 8的新特性，以及如何用Java 8来实践函数式编程。</p>

<p><a href="http://toughcoder.net/blog/2022/01/17/develop-with-java-8/"><img src="https://cdn.educba.com/academy/wp-content/uploads/2020/01/java-8-features.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html">Lambda表达式</a></h2>

<p>也即匿名函数，称之为lambda。具体数学上的定义比较复杂就不多说了。为了便于理解，我们先从匿名内部类说起。</p>

<p><img src="https://www.callicoder.com/static/a42462af7361c61f46c6ef49f0a5bb26/c1b63/java-lambda-expressions-tutorial.png" alt="" /></p>

<p>Java早就支持匿名内部类，这是在当年相比较C++一个重要大的提升，它在一些需要提供行为实现的地方还是非常方便的，典型的例子就是UI中的点击事件的处理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nf">ActionListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="n">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Button is clicked: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的要点就是我们向button传递的是一个行为，也就是说按扭点击了时，要执行什么样的行为。对比其他现代语言，这还是显得有些笨重，没有简单明了的说明意图。用Java 8，这就好办多了，可以这样写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Button is clicked: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>括号里面这一坨就是一个Lambda表达式，它是一个行为（严格来说是一个函数），用以直接向目标对象传递一个行为，对比前面的例子，可以发现，这种场景下使用Lambda更加的简洁高效。</p>

<h3>Lambda表达式的语法</h3>

<p>它的通用语法是：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">(</span><span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">....)</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">statements</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>括号里面是参数列表，当只有一个参数时，括号可省略，但当参数多于1个时，或者显示声明了参数类型时，括号不能省略，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">names</span><span class="o">.</span><span class="na">sort</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">a</span><span class="o">));</span>
</span><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">((</span><span class="n">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Button is clicked: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>花括号中就是语句块了，这跟常规语句块（如if， while等）是一样的，如果有返回值就return，把它理解为常规方法的实体就可以了，像写常规函数实现那样去写就好了。如果只有一个语句，或者一条表达式，可以省略花括号。</p>

<h3>类型推断</h3>

<p>Lambda表达是匿名函数，主要用以向目标对象传递行为，既然匿名，当然是图简洁和清晰，因此就不要弄的太复杂。所以，参数的类型，以及表达式的返回值（如有）的类型，都是编译器通过上下文来推断出来的，因此，不用给参数写类型，如果因为实现的接口不明确，编译器看不懂的话，会有编译报错的。</p>

<p>关于类型推断可以看《Java 8函数式编程》的第2章第5节有详细的讨论。</p>

<h3><a href="https://www.geeksforgeeks.org/closures-in-java-with-examples/">闭包</a></h3>

<p>也就是closure，严格的数学定义就不说了，有点复杂和难于理解，简单来说就是Lambda表达中使用了一个其定义域外的变量的值（称作捕获外部变量），lambda即变成了一个闭包。还是有点绕，这个其实并不陌生，以前的匿名内部就是可以使用外部变量的，只不过编译器要强加final修饰，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kt">int</span> <span class="n">numberOfStudents</span> <span class="o">=</span> <span class="n">countStudents</span><span class="o">();</span>
</span><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nf">ActionListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="n">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Number of students is &quot;</span> <span class="o">+</span> <span class="n">numberOfStudents</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里其实就是一个闭包了，匿名内部类中捕获了外部的变量numberOfStudents，只不过要强加final修饰，这是因为这里要传值。</p>

<p>Java 8里面呢，外部变量不必用final修饰了，但是，它也必须实际上是final的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">numberOfStudents</span> <span class="o">=</span> <span class="n">countStudents</span><span class="o">();</span>
</span><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Number of students is &quot;</span> <span class="o">+</span> <span class="n">numberOfStudents</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为，之前啊，假如捕获了一个外部变量，不是final的，会有编译错误，但如果你用IDE的建议时，它就直接再声明一个final变量，用原变量赋值，然后把新的final变量传给匿名内部类，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">numberOfStudents</span> <span class="o">=</span> <span class="n">countStudents</span><span class="o">();</span>
</span><span class='line'><span class="kd">final</span> <span class="kt">int</span> <span class="n">finalNumberOfStudents</span> <span class="o">=</span> <span class="n">numberOfStudents</span><span class="o">;</span>
</span><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="k">new</span> <span class="nf">ActionListener</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">actionPerformed</span><span class="o">(</span><span class="n">ActionEvent</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Number of students is &quot;</span> <span class="o">+</span> <span class="n">finalNumberOfStudents</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>到此就明白了，Java 8对于闭包的支持，其实较之前没有实质的变化，只不过编译器帮你做了这个final变量的定义而已。</p>

<p>这部分可以参考《Java 8函数式编程》中第2章第3节的内容。</p>

<h2><a href="https://www.oracle.com/webfolder/technetwork/tutorials/obe/java/JavaSE8DefaultMethods/JavaSE8DefaultMethods.html">接口方法默认实现</a></h2>

<p>Java 8中，可以给接口interface，添加一个方法的默认实现，这样在实现此接口时，子类可以选择重新实现，或者不实现，直接调用此方法即可，从语法上来说，是比较简单的，用default关键字来修饰方法即可，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">interface</span> <span class="nc">Formula</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">double</span> <span class="nf">calculate</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">default</span> <span class="kt">double</span> <span class="nf">sqrt</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">ComplexFormula</span> <span class="kd">implements</span> <span class="n">Formula</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">double</span> <span class="nf">calculate</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">real</span><span class="o">)</span> <span class="o">+</span> <span class="kd">super</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">imaginary</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里面，子类ComplexFormula是可以正常编译和运行的。</p>

<p><strong>注意</strong>：接口是支持多重继承的，比如一个类可以实现多个接口，这就有可能存在接口中有相同的默认方法，最好的处理方法就是子类重新实现一下此方法，然后可以用接口的名字+super来具体指定父类中的方法。这一具体的规则比较复杂，可以看《Java 8函数式编程》这本书中的第4章第7节，有比较详细的论述。</p>

<p>另外，需要注意，实际运用中，接口的默认方法并不常用，因为这本身就是比较奇怪的，与最初Java的设计有冲突，接口策重于行为的高级抽象，而抽象类侧重对象的高级抽象（多半涉及状态属性）。这东西的出现主要是为了解决向后兼容，比如说当你一个被广泛使用的接口添加了一个新的方法时，所有实现此接口的类必须全部要改一遍，要实现此接口，这会影响大量的现存代码，而默认方法就是为了解决这个问题的，给新添加的方法标记为default，就不会影响现存代码了。</p>

<p>这个可以仔细读一下《Java 8函数式编程》中的第4章第6节和第7节的内容。</p>

<h2><a href="https://www.geeksforgeeks.org/functional-interfaces-java/">函数接口</a></h2>

<p>支持函数式编程范式的语言一般来说呢，会把函数作为语义上的一级类型，比如像Python或者Kotlin都有专门用于声明函数的关键字。另外，需要澄清一下函数的概念，简单来说函数就是给定一些输入，然后给出输出，输出随输入改变而改变，<strong>不会产生副作用，也就是不会修改全局变量，不会修改环境变量</strong>。且<strong>具有幂等性，即针对 同一组输入，多次调用，结果仍是一样的</strong>，这就是函数。</p>

<p>对于Java，这事儿就有点难办了，因为前面的版本根本就没有把方法独立成为函数，方法必须存在于类中。为了支持函数，函数是函数式编程的基本要素，所以要想支持函数式编程，必须以某种方式来支持函数的定义。Java 8中就提出了函数接口的概念。</p>

<p><strong>函数接口是只有一个抽象方法的接口</strong>，这里有两个关键信息，首先，<strong>语义上的类型必须是一个interface</strong>，其次，<strong>它只能有一个抽象方法</strong>，放在以前的版本，其实意思就是说只有能一个方法，但还要注意的是前面提到的默认方法。那么这里的要求就是<strong>除了默认方法以外，只能有一个方法</strong>。</p>

<p>函数接口必须用<em>@FunctionalInterface</em>注解来标注，编译器会对它做特别的关注，一旦有超过1个抽象接口，就会编译报错。为啥要用注解而不是增加关键字（如function），或者创建一级类型（如function interface），目的仍是向后兼容。注解仅需要在编译阶段做一些额外的事情即可，这即实现了扩展，又保持了兼容性。</p>

<p>前面提到的Lambda表达式必须是一个函数接口的实例，这样说太抽象了，慢慢来解释下。Lambda是一个匿名函数，可以把它理解为一个对象，它所实现的必须是一个函数接口。换句话说，只有声明为函数接口的地方，也就是方法的参数类型或者变量的类型要声明为函数接口，只有这里才可以传入lambda表达式。</p>

<p>接着前面的Formula例子，假如有如下应用场景：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">class</span> <span class="nc">Number</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">payload</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">Number</span> <span class="nf">transform</span><span class="o">(</span><span class="n">Formula</span> <span class="n">formula</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">formula</span><span class="o">.</span><span class="na">calculate</span><span class="o">(</span><span class="n">payload</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在调用transform方法时如果直接传递lambda，是会报错的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">number</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="o">);</span> <span class="c1">// won&#39;t compile</span>
</span></code></pre></td></tr></table></div></figure>


<p>解决方法，就是要给Formula添加函数接口注解：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nd">@FunctionalInterface</span>
</span><span class='line'><span class="kd">interface</span> <span class="nc">Formula</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">double</span> <span class="nf">calculate</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">default</span> <span class="kt">double</span> <span class="nf">sqrt</span><span class="o">(</span><span class="kt">int</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Math</span><span class="o">.</span><span class="na">sqrt</span><span class="o">(</span><span class="n">a</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于函数接口，可以参阅《Java 8函数式编程》中第2章第4节和第4章第4节。</p>

<h3>常用的函数接口</h3>

<p>Java 8 定义了一些非常常用的函数接口，这里做一下简单的介绍。</p>

<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html">Predict<T></a></h4>

<p>断言，给定一个类型为T的输入，给出boolean的输出（true of false）。通常用于过滤操作之中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Predict</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">isEmpty</span> <span class="o">=</span> <span class="nl">String:</span><span class="o">:</span><span class="n">isEmpty</span><span class="o">;</span>
</span><span class='line'><span class="n">students</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">name</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Function.html">Function&lt;T, R></a></h4>

<p>通用的函数操作，给定类型为T的输入，返回类型为R的输出，通常用于map之中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Function</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">length</span> <span class="o">=</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实，Predict可视为一种特殊的Function，它的返回类型是boolean。</p>

<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Consumer.html">Consumer<T></a></h4>

<p>消费类型为T的对象，无输出，作为调用链的终点，通常用于生成终值，如前面例子中传给button的lambda就一个Consumer。</p>

<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Supplier.html">Supplier<T></a></h4>

<p>返回一个类型为T的对象，也即生产者，通常都是用于工厂方法，用来生成新的对象。</p>

<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/UnaryOperator.html">UnaryOperator<T></a></h4>

<p>一元操作符，输入类型是T的对象，返回类型是T的对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">UnaryOperator</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">square</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/BinaryOperator.html">BinaryOperator<T></a></h4>

<p>二元操作符，输入参数是类型同为T的a和b两个参数，输出是一个类型为T的结果：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">BinaryOperator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">join</span> <span class="o">=</span> <span class="o">(</span><span class="n">first</span><span class="o">,</span> <span class="n">second</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">first</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">second</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里例子不是很多，因为单独写这些函数接口的lambda不太好写，且意义不够实用，会在后面结合Stream API，给出更多示例。</p>

<h2><a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html">Optional</a></h2>

<p>这个类用于封装可能为空的对象，以更好的处理null的情况，它加强了类型检查（null本身是没有类型的），以及使用时的空值检查，所以可以一定程度上防止NullPointerException的出现。</p>

<p><img src="https://sboychenko.ru/wp-content/uploads/2016/09/java8-optional.jpg" alt="" /></p>

<p>先来看一下它的简单使用方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">);</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">get</span><span class="o">());</span> <span class="c1">// a</span>
</span><span class='line'><span class="n">Optional</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span> <span class="c1">// 返回一个为空的对象</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">empty</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span> <span class="c1">// false</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">empty</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">&quot;b&quot;</span><span class="o">);</span> <span class="c1">// b</span>
</span><span class='line'><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">empty</span><span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="s">&quot;c&quot;</span><span class="o">));</span> <span class="c1">// c</span>
</span></code></pre></td></tr></table></div></figure>


<p>前面2行好理解了，第3行创建一个为空的Optional对象，它的isPresent会返回false，orElse是说如果为空时可以返回一个默认值『b』，而最后一行也可以为默认值提供一个Supplier以在为空的时候产生一个值。</p>

<p>通过这几个小例子可以看出Optional的用途，它可以比较好的封装对象，并提前定义值不存在时的应对情况，能够一定程序上减少NPE。</p>

<p>不过，这个东西对于复杂项目来说效用不会太大，假如你到处判断isPresent，其实跟检测== null也没有本质区别。实际项目中大量的NPE来自于多线程环境共享成员变量，这种情况下Optional也救不了你。</p>

<p>要想发挥这东西的最大效用，需要从设计角度尽可能的减少变量共享，尽可能的缩小变量作用域，再配合默认值或者默认值的Suppiier，多管齐下，才能有效的防止NPE。</p>

<h2><a href="https://www.javatpoint.com/java-8-method-reference">方法引用</a></h2>

<p>函数式编程，函数要是语义层面的一级类型，变量或者参数的类型可以是函数，前面提到了在Java 8中代表函数类型就是函数接口。</p>

<p>那么，当传递具体函数体的时候，我们一直在使用lambda表达式，但这并不是适合所有场景，比如说我已经有了一个类的方法，完全符合函数接口的方法签名，难道还非要写一个lambda吗？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">event</span> <span class="o">-&gt;</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
</span><span class='line'><span class="n">Predict</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">empty</span> <span class="o">=</span> <span class="n">str</span> <span class="o">-&gt;</span> <span class="n">str</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">();</span>
</span><span class='line'><span class="n">Function</span><span class="o">&lt;</span><span class="n">Artist</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">namer</span> <span class="o">=</span> <span class="n">artist</span> <span class="o">-&gt;</span> <span class="n">artist</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>这显然太啰嗦了，这种情况下，可以直接用<strong>方法引用</strong>，来把已有的方法传递过去，形式是<strong>类名::方法名</strong>，用方法引用重写上面的几个小例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">button</span><span class="o">.</span><span class="na">addActionListener</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span><span class='line'><span class="n">Predict</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">empty</span> <span class="o">=</span> <span class="nl">String:</span><span class="o">:</span><span class="n">isEmpty</span><span class="o">;</span>
</span><span class='line'><span class="n">Function</span><span class="o">&lt;</span><span class="n">Artist</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">namer</span> <span class="o">=</span> <span class="nl">Artist:</span><span class="o">:</span><span class="n">getName</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>简洁了很多吧，不但可以复用已有的方法，简洁明了，而且也省去创建一个lambda对象。一定要注意的就是要用方法的名字，不能加括号，因为加了括号，在语义上就是对函数的调用了，引用的便是该方法的返回值，除非这个方法的返回值是一个函数接口实例（lambda或者一个方法引用）。</p>

<p>除了常规方法可以用作引用以外，还可以对构造方法进行引用，格式是<strong>类名::new</strong>，如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">Artist:</span><span class="o">:</span><span class="k">new</span><span class="o">;</span> <span class="c1">// 相当于  (name, nationality) -&gt; new Artist(name, nationality);</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以参阅《Java 8函数式编程》第5章第1节的内容。</p>

<h2><a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/Stream.html">Stream API</a></h2>

<p>终于到了最为重要的特性了，为了更进一步的支持函数式编程，Java 8新增了Stream API，它是针对集合类型（List，Map和Set等）函数式操作的支持，以更好的把行为与遍历分离。先来看一下小例子：</p>

<p>比如有这样一个列表：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">giants</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;Apple&quot;</span><span class="o">,</span> <span class="s">&quot;Google&quot;</span><span class="o">,</span> <span class="s">&quot;Microsoft&quot;</span><span class="o">,</span> <span class="s">&quot;Facebook&quot;</span><span class="o">,</span> <span class="s">&quot;Tesla&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>想简单遍历一下，以前这么写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">item</span> <span class="o">:</span> <span class="n">giants</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">item</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但，现在只需要这样写就可以了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">giants</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>是不是很清爽，这就是典型的函数式写法，你可能会说就这？客官别急，这只是前戏，后面还有更刺激的。</p>

<p><img src="https://miro.medium.com/max/1400/0*QCmZZpGs_rcF5y2-.png" alt="" /></p>

<p><strong>注意</strong>：这里一定要与I/O stream区分开来，完全是两个东西。Stream API是针对 集合操作的函数式支持。</p>

<p>函数式编程核心元素是函数，它通过对函数的各种组合得到最终的结果，最为典型的就是流式调用，把函数串连起来，或者叫做链式调用，让数据在函数链中流动，最终得到期望的结果。最为经典的函数式『三板斧』就是过滤（filter），转换（map）和折叠（也称化约，英文是reduce），这是所有函数式程序的基本构造单元。可以参阅《函数式编程思维》这本书的第2章，有比较详细的讨论。</p>

<p><img src="https://files.realpython.com/media/TUT19---Functional-Programming_Watermarked.3bb16c6198a2.jpg" alt="" /></p>

<h3>复杂的实例</h3>

<p>为了更好的演示Java 8的Stream API，以及综合运用函数式方法，本文剩余部分，将基于<a href="https://www.nba.com/nets/">Brooklyn</a>的球员技术统计信息操作为基础的实例。球队中有多名球员，每个球员有一些基本信息和一组比赛技术统计，现在教练需要对信息做一些统计。基础的类型是球员包含其基本信息和技术统计，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Player</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">community</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">points</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">rebounds</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">float</span> <span class="n">fieldGoal</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="n">firstName</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">lastName</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;, from &#39;&quot;</span> <span class="o">+</span> <span class="n">community</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;, scores=&quot;</span> <span class="o">+</span> <span class="n">points</span> <span class="o">+</span>
</span><span class='line'>                <span class="s">&quot;, rebounds=&quot;</span> <span class="o">+</span> <span class="n">rebounds</span> <span class="o">+</span>
</span><span class='line'>                <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">&quot;, fieldGoal=%.2f%%&quot;</span><span class="o">,</span> <span class="n">fieldGoal</span> <span class="o">*</span> <span class="mi">100</span><span class="o">.</span><span class="na">f</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="nf">Player</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">,</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">,</span> <span class="n">String</span> <span class="n">community</span><span class="o">,</span> <span class="kt">int</span> <span class="n">scores</span><span class="o">,</span> <span class="kt">int</span> <span class="n">rebounds</span><span class="o">,</span> <span class="kt">float</span> <span class="n">fieldGoal</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">community</span> <span class="o">=</span> <span class="n">community</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">points</span> <span class="o">=</span> <span class="n">scores</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">rebounds</span> <span class="o">=</span> <span class="n">rebounds</span><span class="o">;</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">fieldGoal</span> <span class="o">=</span> <span class="n">fieldGoal</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Builder</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">String</span> <span class="n">firstName</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">String</span> <span class="n">lastName</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="n">String</span> <span class="n">community</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">int</span> <span class="n">scores</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">int</span>  <span class="n">rebounds</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="kt">float</span> <span class="n">fieldGoal</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">firstName</span><span class="o">(</span><span class="n">String</span> <span class="n">firstName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">firstName</span> <span class="o">=</span> <span class="n">firstName</span><span class="o">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">lastName</span><span class="o">(</span><span class="n">String</span> <span class="n">lastName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">this</span><span class="o">.</span><span class="na">lastName</span> <span class="o">=</span> <span class="n">lastName</span><span class="o">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">community</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">communitySupplier</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">community</span> <span class="o">=</span> <span class="n">communitySupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">points</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">pointsSupplier</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">scores</span> <span class="o">=</span> <span class="n">pointsSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">rebounds</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">reboundsSupplier</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">rebounds</span> <span class="o">=</span> <span class="n">reboundsSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Builder</span> <span class="nf">fieldGoal</span><span class="o">(</span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">Float</span><span class="o">&gt;</span> <span class="n">fgSupplier</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">fieldGoal</span> <span class="o">=</span> <span class="n">fgSupplier</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="n">Player</span> <span class="nf">build</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">Player</span><span class="o">(</span><span class="n">firstName</span><span class="o">,</span> <span class="n">lastName</span><span class="o">,</span> <span class="n">community</span><span class="o">,</span> <span class="n">scores</span><span class="o">,</span> <span class="n">rebounds</span><span class="o">,</span> <span class="n">fieldGoal</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>再有就是球队了，就是针对球员们的操作的地方，首先，需要生成数据：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Brooklyn</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">&gt;</span> <span class="n">players</span> <span class="o">=</span> <span class="n">generatePlayers</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">&gt;</span> <span class="nf">generatePlayers</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">names</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;James Harden&quot;</span><span class="o">,</span> <span class="s">&quot;Kevin Durant&quot;</span><span class="o">,</span> <span class="s">&quot;Kyrie Irving&quot;</span><span class="o">,</span> <span class="s">&quot;Nic Clyxton&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="s">&quot;Kessler Edwards&quot;</span><span class="o">,</span> <span class="s">&quot;Bruce Brown&quot;</span><span class="o">,</span> <span class="s">&quot;LaMarcus Aldridge&quot;</span><span class="o">,</span> <span class="s">&quot;Blake Griffin&quot;</span>
</span><span class='line'>        <span class="o">);</span>
</span><span class='line'>        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">communities</span> <span class="o">=</span> <span class="n">List</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&quot;The Bronx&quot;</span><span class="o">,</span> <span class="s">&quot;Brooklyn&quot;</span><span class="o">,</span> <span class="s">&quot;Manhattan&quot;</span><span class="o">,</span> <span class="s">&quot;Queens&quot;</span><span class="o">,</span> <span class="s">&quot;Staten Island&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">names</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">name</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">String</span><span class="o">[]</span> <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">&quot; &quot;</span><span class="o">);</span>
</span><span class='line'>                    <span class="k">return</span> <span class="k">new</span> <span class="n">Player</span><span class="o">.</span><span class="na">Builder</span><span class="o">().</span><span class="na">firstName</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">lastName</span><span class="o">(</span><span class="n">parts</span><span class="o">[</span><span class="mi">1</span><span class="o">])</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">community</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span><span class='line'>                                <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">communities</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span><span class='line'>                                <span class="k">return</span> <span class="n">communities</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span><span class='line'>                            <span class="o">})</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">points</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">61</span><span class="o">))</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">rebounds</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="mi">31</span><span class="o">))</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">fieldGoal</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">random</span><span class="o">.</span><span class="na">nextFloat</span><span class="o">())</span>
</span><span class='line'>                            <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span><span class='line'>                <span class="o">})</span>
</span><span class='line'>                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">Collectors</span><span class="o">.</span><span class="na">toList</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里为了方便使用了一个<a href="https://refactoring.guru/design-patterns/builder">Builder Pattern</a>。另外，创建数据的过程中，其实用到上面提到的大量知识点，如Supplier的使用，以及闭包和方法引用。整体并不难，可以仔细读一读例子中的代码。</p>

<h3>Stream基础操作</h3>

<p>先来看一下Stream的基础操作，包括filter，map和reduce，以及sort和match，不准备说太多的废话，将以实例操作为主线来讲解。</p>

<h4>forEach</h4>

<p>也即遍历，非常方便：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">players</span><span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出会是：</p>

<blockquote><p>&lsquo;James, Harden&rsquo;, from &lsquo;Brooklyn&rsquo;, scores=11, rebounds=24, fieldGoal=10.62% <br/>
&lsquo;Kevin, Durant&rsquo;, from &lsquo;Queens&rsquo;, scores=48, rebounds=4, fieldGoal=47.16% <br/>
&lsquo;Kyrie, Irving&rsquo;, from &lsquo;Staten Island&rsquo;, scores=17, rebounds=21, fieldGoal=86.05% <br/>
&lsquo;Nic, Clyxton&rsquo;, from &lsquo;Queens&rsquo;, scores=43, rebounds=11, fieldGoal=99.66% <br/>
&lsquo;Kessler, Edwards&rsquo;, from &lsquo;The Bronx&rsquo;, scores=55, rebounds=12, fieldGoal=46.78% <br/>
&lsquo;Bruce, Brown&rsquo;, from &lsquo;Queens&rsquo;, scores=10, rebounds=20, fieldGoal=77.51% <br/>
&lsquo;LaMarcus, Aldridge&rsquo;, from &lsquo;Manhattan&rsquo;, scores=35, rebounds=22, fieldGoal=98.18% <br/>
&lsquo;Blake, Griffin&rsquo;, from &lsquo;Brooklyn&rsquo;, scores=3, rebounds=4, fieldGoal=38.06% <br/></p></blockquote>

<p>这个使用起来相当简单，forEach接收一个Consumer，另外需要注意的是forEach不会返回一个Stream对象，所以不能在其后再继续添加链了。它通常作为整个链路的终端，消费最终结果。</p>

<p><strong>注意</strong>：因为数据生成过程中使用了一些随机数，所以运行结果可能会不同。</p>

<h4>filter</h4>

<p>想看看哪些球员，命中率超过五成：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mf">0.5f</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<blockquote><p>&lsquo;James, Harden&rsquo;, from &lsquo;Brooklyn&rsquo;, scores=6, rebounds=22, fieldGoal=95.02% <br/>
&lsquo;Kevin, Durant&rsquo;, from &lsquo;The Bronx&rsquo;, scores=37, rebounds=17, fieldGoal=78.81% <br/>
&lsquo;Bruce, Brown&rsquo;, from &lsquo;Queens&rsquo;, scores=26, rebounds=23, fieldGoal=57.35% <br/>
&lsquo;LaMarcus, Aldridge&rsquo;, from &lsquo;The Bronx&rsquo;, scores=35, rebounds=4, fieldGoal=59.75% <br/></p></blockquote>

<p>filter还是很容易理解的，它接收一个Predict，然后返回Stream中符合条件的元素，也即Predict中是true的。</p>

<h4>map</h4>

<p>转换，把一种数据类型转换为另外一种类型，其实从创建数据的方法generatePlayers中就可以看到了，是把String转换为Player，根据名字生成数据对象。</p>

<h4>sort</h4>

<p>接着前面的例子，把输出按命中率从高到低排个序吧：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()</span> <span class="o">&gt;=</span> <span class="mf">0.5f</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">sorted</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()*</span><span class="mi">100</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()*</span><span class="mi">100</span><span class="o">))</span>
</span><span class='line'>            <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<blockquote><p>&lsquo;Nic, Clyxton&rsquo;, from &lsquo;Queens&rsquo;, scores=34, rebounds=17, fieldGoal=93.82% <br/>
&lsquo;Kyrie, Irving&rsquo;, from &lsquo;Brooklyn&rsquo;, scores=37, rebounds=16, fieldGoal=82.95% <br/>
&lsquo;LaMarcus, Aldridge&rsquo;, from &lsquo;Staten Island&rsquo;, scores=43, rebounds=10, fieldGoal=52.94% <br/></p></blockquote>

<h4>flatMap</h4>

<p>map是把一种数据类型转换为另外一各类型，然后让其在链式中流动，flatMap是更为复杂的操作，它是先做map再做flat，想当于把二维的Stream展平成为一维的Stream，传给flatMap的lambda必须返回一个Stream，来看个例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">public</span> <span class="kd">static</span> <span class="n">Stream</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">queryEmail</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">Stream</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;@brooklyn.nets&quot;</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>        <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">queryEmail</span><span class="o">(</span><span class="n">player</span><span class="o">.</span><span class="na">getLastName</span><span class="o">()))</span>
</span><span class='line'>        <span class="o">.</span><span class="na">forEach</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<blockquote><p><a href="&#109;&#x61;&#x69;&#108;&#x74;&#x6f;&#x3a;&#x48;&#x61;&#x72;&#x64;&#101;&#110;&#64;&#98;&#x72;&#x6f;&#x6f;&#107;&#x6c;&#x79;&#x6e;&#46;&#110;&#x65;&#116;&#x73;">&#x48;&#x61;&#114;&#x64;&#x65;&#x6e;&#64;&#98;&#114;&#x6f;&#x6f;&#x6b;&#108;&#121;&#x6e;&#x2e;&#110;&#x65;&#x74;&#115;</a> <br />
<a href="&#109;&#97;&#105;&#108;&#116;&#x6f;&#58;&#68;&#117;&#114;&#x61;&#x6e;&#x74;&#64;&#98;&#114;&#x6f;&#111;&#107;&#108;&#x79;&#x6e;&#x2e;&#110;&#101;&#116;&#x73;">&#68;&#117;&#114;&#97;&#110;&#x74;&#64;&#98;&#x72;&#111;&#111;&#x6b;&#108;&#121;&#110;&#46;&#x6e;&#101;&#116;&#115;</a> <br />
<a href="&#109;&#x61;&#105;&#108;&#116;&#111;&#x3a;&#73;&#114;&#118;&#x69;&#110;&#103;&#64;&#x62;&#114;&#x6f;&#x6f;&#x6b;&#108;&#x79;&#x6e;&#x2e;&#110;&#101;&#x74;&#115;">&#x49;&#114;&#118;&#x69;&#110;&#x67;&#64;&#98;&#114;&#111;&#x6f;&#107;&#108;&#x79;&#110;&#46;&#x6e;&#101;&#x74;&#115;</a> <br />
<a href="&#x6d;&#x61;&#x69;&#x6c;&#116;&#111;&#58;&#67;&#108;&#x79;&#120;&#116;&#x6f;&#x6e;&#x40;&#x62;&#114;&#x6f;&#x6f;&#107;&#x6c;&#x79;&#x6e;&#x2e;&#110;&#x65;&#116;&#115;">&#x43;&#x6c;&#121;&#120;&#116;&#x6f;&#x6e;&#x40;&#x62;&#x72;&#x6f;&#111;&#107;&#108;&#121;&#110;&#x2e;&#x6e;&#x65;&#x74;&#x73;</a> <br />
<a href="&#x6d;&#97;&#105;&#108;&#x74;&#111;&#58;&#69;&#100;&#119;&#x61;&#x72;&#100;&#x73;&#64;&#x62;&#114;&#x6f;&#x6f;&#x6b;&#108;&#x79;&#x6e;&#46;&#x6e;&#x65;&#x74;&#115;">&#x45;&#x64;&#x77;&#97;&#x72;&#100;&#115;&#64;&#98;&#114;&#111;&#111;&#x6b;&#x6c;&#x79;&#x6e;&#46;&#x6e;&#x65;&#116;&#115;</a> <br />
<a href="&#109;&#x61;&#x69;&#x6c;&#116;&#x6f;&#58;&#66;&#x72;&#111;&#x77;&#110;&#64;&#x62;&#x72;&#111;&#x6f;&#x6b;&#108;&#x79;&#x6e;&#46;&#110;&#101;&#x74;&#115;">&#66;&#x72;&#x6f;&#119;&#x6e;&#x40;&#x62;&#114;&#111;&#x6f;&#107;&#108;&#x79;&#x6e;&#46;&#110;&#x65;&#116;&#x73;</a> <br />
<a href="&#109;&#97;&#105;&#x6c;&#116;&#111;&#58;&#65;&#108;&#100;&#114;&#105;&#100;&#x67;&#x65;&#64;&#98;&#114;&#x6f;&#x6f;&#107;&#108;&#x79;&#110;&#46;&#110;&#x65;&#116;&#x73;">&#x41;&#108;&#x64;&#114;&#105;&#100;&#103;&#101;&#64;&#x62;&#x72;&#111;&#x6f;&#x6b;&#108;&#121;&#x6e;&#46;&#110;&#x65;&#x74;&#x73;</a> <br />
<a href="&#109;&#x61;&#105;&#108;&#x74;&#111;&#x3a;&#71;&#x72;&#x69;&#102;&#102;&#x69;&#110;&#64;&#x62;&#x72;&#111;&#111;&#107;&#108;&#x79;&#x6e;&#46;&#x6e;&#101;&#116;&#115;">&#71;&#x72;&#x69;&#102;&#x66;&#105;&#110;&#64;&#98;&#114;&#111;&#111;&#x6b;&#108;&#121;&#110;&#x2e;&#x6e;&#x65;&#116;&#x73;</a> <br /></p></blockquote>

<p>这里的获取到的Email是另外一个Stream，所以这里必须用flatMap，也即当把player转换为Email后，必须要再flat，变成最初的链中的对象。</p>

<h3>及时求值</h3>

<p>前面讲的操作都是<a href="https://www.geeksforgeeks.org/scala-lazy-evaluation/">惰性求值</a>的，它们都是返回一个Stream，而Stream本身仅是封装操作，其实并没有生成最终值。但有些操作是可以生成最终值的，就是把整个链路的值进行运算，然后生成最终的值，但这个值不再是Stream了，也就是说及时求值操作只能作为链式的终点。</p>

<p><strong>注意</strong>：惰性求值是函数式编程的一个概念，它的主要目的是将行为与结果分离开来，以方便并行化处理。具体可以参阅《函数式编程思维》书中的第4章，有详细的论述。</p>

<h4>count</h4>

<p>计算一下来自『Queens』的球员数量：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kt">long</span> <span class="n">fromQueens</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getCommunity</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Queens&quot;</span><span class="o">))</span>
</span><span class='line'>            <span class="o">.</span><span class="na">count</span><span class="o">();</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fromQueens</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// Output is: 2</span>
</span></code></pre></td></tr></table></div></figure>


<h4>match</h4>

<p>查看Stream的元素中是否有匹配的条件的，有any意即任意元素有了匹配，all所有，none没有（相当于not all）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kt">boolean</span> <span class="n">fromQueens</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">anyMatch</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getCommunity</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Queens&quot;</span><span class="o">));</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fromQueens</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// 是否有人来自于Queens，true</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">fromQueens</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">allMatch</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getCommunity</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Queens&quot;</span><span class="o">));</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fromQueens</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// 所有人都来自Queens，false</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">fromQueens</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">noneMatch</span><span class="o">(</span><span class="n">player</span> <span class="o">-&gt;</span> <span class="n">player</span><span class="o">.</span><span class="na">getCommunity</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;Queens&quot;</span><span class="o">));</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fromQueens</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// 所有人都来自非Queens，false</span>
</span></code></pre></td></tr></table></div></figure>


<h4>reduce</h4>

<p>折叠或者叫作化约，有些语言也称之为fold，它接收两个参数，第一个是初始值，然后是一个二元操作符BinaryOperator，二元操作的第一个参数是截止目前的结果，第二个参数是当前的元素，然后针对每个元素进行滚动执行这个二元操作符。这么说有点难于理解，我们来个，计算球员们的总得分吧：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kt">int</span> <span class="n">totalPoints</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Player:</span><span class="o">:</span><span class="n">getPoints</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">totalPoints</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// output is 247</span>
</span></code></pre></td></tr></table></div></figure>


<p>再来计算平均命中率：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Float</span><span class="o">&gt;</span> <span class="n">averageFieldGoal</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>            <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Player:</span><span class="o">:</span><span class="n">getFieldGoal</span><span class="o">)</span>
</span><span class='line'>            <span class="o">.</span><span class="na">reduce</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">)</span> <span class="o">/</span> <span class="mi">2</span><span class="o">.</span><span class="na">f</span><span class="o">);</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">averageFieldGoal</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span><span class='line'>    <span class="c1">// Output is 0.40</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果没有初始值，或者初始值是0（针对数值时），为空时（针对对象），那么可以省略reduce的第1个参数，这时它会用第1个元素用作初始值。</p>

<h4>max和min</h4>

<p>寻找最少的篮板数的球员：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">&gt;</span> <span class="n">minRebound</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">min</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">getRebounds</span><span class="o">()</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="na">getRebounds</span><span class="o">());</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">minRebound</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<blockquote><p>&lsquo;Kessler, Edwards&rsquo;, from &lsquo;Staten Island&rsquo;, scores=8, rebounds=2, fieldGoal=97.53% <br/></p></blockquote>

<p>寻找命中率最高的球员：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Player</span><span class="o">&gt;</span> <span class="n">bestShooter</span> <span class="o">=</span> <span class="n">players</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
</span><span class='line'>                    <span class="o">.</span><span class="na">max</span><span class="o">((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()*</span><span class="mi">100</span><span class="n">f</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="na">getFieldGoal</span><span class="o">()*</span><span class="mi">100</span><span class="n">f</span><span class="o">));</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bestShooter</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<blockquote><p>&lsquo;Bruce, Brown&rsquo;, from &lsquo;The Bronx&rsquo;, scores=25, rebounds=15, fieldGoal=88.19% <br/></p></blockquote>

<p><strong>注意</strong>：reduce无初始值时，max和min返回的都是Optional，因为可能会取不到具体的值。</p>

<h2>This is just the beginning</h2>

<p>学无止境，Stream API还有很多高级的工具，以及Java 8的新特性也还有很多，还有待后面继续深入学习。</p>

<h2>Android SDK的支持情况</h2>

<p>进入智能手机时代和移动互联网时代，Java曾一度没落，好在安卓的官方开发语言是Java，这也让Java没有被丢弃，虽然现在谷歌力推Kotlin，不过Java仍是安卓 开发的首选语言，且仍在被广泛使用。不过，安卓的Java，并不是Oracle的Java SE，而是基于Apache开源的OpenJDK，这货自Java 1.6版本以后就没怎么更新，而作为downstream的安卓，更是一直停留在1.6的版本上面，这也导致了安卓开发人猿一直未能跟紧Java的发展，当然 这也是Kotlin自推出以来大受安卓开发人猿欢迎的原因。好在谷歌也在推进，它是以打包插件的方式来支持Java 7和Java 8的部分子集。现在AGP（Android Gradle Plugin）4.0以上的版本，是可以使用大部分Java 8的特性的，前面讲述的lambda，Optional，函数接口和Stream等都是可以直接使用的，只要把AGP的版本升级到4.0以上，sourceCompatibility选择VERSION_1_8，就可以了。</p>

<p>可以参阅<a href="https://developer.android.com/studio/write/java8-support">官方文档</a>。而<a href="https://tech.meituan.com/2019/10/17/android-java-8.html">这篇文章</a>相当不错的阐述一些详细的原因，可以仔细读一下。</p>

<h2>优质书籍</h2>

<p>编程范式的学习曲线都是非常陡峭的，函数式编程注重的是行为的抽象，以行为（函数）为第一要素来构建解决方案，这需要思维的转变。并不是说你用了一个lambda就是函数式编程了。因此需要系统化的学习。而系统化的学习，最好的方式就是去啃书（没说看，是要啃书）。</p>

<p>下面列出关于函数式编程，特别是用Java 8进行实践函数式编程的几本非优质的书籍：</p>

<h3><a href="https://www.oreilly.com/library/view/functional-thinking/9781449365509/">Functional Thinking</a></h3>

<p>中译名是《函数式编程思维》，是由Neal Ford出品的佳作，专门讲述如何Thinking in Functional Programming。这本书也不是很厚，非常值得看。因为是重点讲解函数式编程思维 的，所以它用了Java/Scala和Groovy，并且Java的版本还不是Java 8的。</p>

<p>这里也要说一下，编程范式跟语言是否直接支持没有关系，它更是一种思维抽象方法，比如用C也能写出完全符合面向对象的代码；用Java 7以前的版本也能写出函数式程序。</p>

<h3><a href="https://www.amazon.com/Java-Lambdas-Functional-Programming-Masses/dp/1449370772">Java 8 Lambdas: Functional Programming For The Masses</a></h3>

<p>中译名是《Java 8函数式编程》，由Richard Warburton写的。里面有丰富的实例和练习题，也不厚，专注于讲解如何用Java 8来实践函数式编程。</p>

<h3><a href="https://www.manning.com/books/java-8-in-action">Java 8 in Action</a></h3>

<p>中译名《Java 8实战》，由三位作者Raoul-Gabriel Urma, Mario Fusco, and Alan Mycroft合著。内容其实与前面那个差不多，但略有不同，这本书是重点讲解Java 8的新特性的，当然大量篇幅也是讲用Java 8实践函数式编程的（因为Java 8最重要的改进就是对函数式编程的支持），但还有其他的内容。并且这本书较厚，里面各种知识点讲解比较详细。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://stackify.com/streams-guide-java-8/">A Guide to Java Streams in Java 8: In-Depth Tutorial With Examples</a></li>
<li><a href="https://www.exception.site/java8/java8-new-features">Java8 新特性教程</a></li>
<li><a href="https://juejin.cn/post/6844903830254010381">[译] 一文带你玩转 Java8 Stream 流，从此操作集合 So Easy</a></li>
<li><a href="https://segmentfault.com/a/1190000022791696">Java8 Stream完全使用指南</a></li>
<li><a href="https://www.baeldung.com/java-8-streams">The Java 8 Stream API Tutorial</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[玩转安卓运行速度优化]]></title>
    <link href="http://toughcoder.net/blog/2022/01/14/android-cpu-optimization-made-easy/"/>
    <updated>2022-01-14T23:14:55+08:00</updated>
    <id>http://toughcoder.net/blog/2022/01/14/android-cpu-optimization-made-easy</id>
    <content type="html"><![CDATA[<p>早在许多年以前写过<a href="http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/">一篇安卓性能优化文章</a>，时过境迁，很多事情都有了变化，所以再专门针对程序运行速度和渲染的优化，这两方面非常直接的影响应用程序的操作流畅度，也可以称作流畅度优化方法，但更为专业的方式就是CPU优化，因为就是要提高代码的运行速度。</p>

<p><a href="http://toughcoder.net/blog/2022/01/14/android-cpu-optimization-made-easy/"><img src="https://bs-uploads.toptal.io/blackfish-uploads/uploaded_file/file/192945/image-1582543505866-a62a10ab903703bc995fcaab8ccd0bd0.png" title="auto auto" ></a></p>

<!-- more -->


<h2>需要优化的地方</h2>

<p>总的来说，就是应用程序运行要快，大体可以分为三块：</p>

<h3>应用启动要快</h3>

<p>从用户点击了桌面的图标到用户能完整见到页面，这个过程要快。其实也不是快，而是没有能从用户感知得到的卡，或者黑屏或者白屏。</p>

<h3>渲染要快</h3>

<p>也就是说View的渲染要快，无明显的Jank，也即卡顿和丢帧。</p>

<h3>操作要流畅</h3>

<p>主要是针对动画，滑动，转场的时候要流畅，也并不一定就是要真的快，而是说从用户感知的角度来看没有明显的卡顿和丢帧。</p>

<h3>业务逻辑要快</h3>

<p>也就是说要快速的完成你的业务逻辑，这个其实没有办法一概而论，取决 于具体的业务逻辑和实际的使用场景，比如网络不好的时候肯定啥都慢啊。</p>

<p>我们常说的性能优化，一般重点是在启动，渲染和操作流畅度上面下功夫，因为这些东西的优化方法更为通用一些，用户感知也更明显一些。也将是我们后面要讨论的重点内容。而至于像业务逻辑，每个具体的应用程序都不一样，所以没有办法一概而论，而常规的一些小的优化技巧也不会起决定性使用。比如说I/O优化方法，缓存的使用，以及像内存优化等等，确实能帮助你的业务逻辑。但如果业务逻辑就是特别复杂，或者代码写的很差劲，明明一个网络请求就能搞定的事儿，非要弄四五个请求，那你再怎么优化细节，比如把每个请求速度都优化到最好，I/O优化到最好，也是没有多大提升的。</p>

<h2>运行速度分析方法</h2>

<p>前面提到的启动优化，渲染优化和操作流畅度优化，其实都是针对CPU的优化，也即代码执行的优化，只不过重点分析那三个场景而已。</p>

<p>具体的分析方法主要就有两方面，一是用Profiler抓取trace，另外就是可以在代码中加入打点数据。</p>

<p>可以先行用代码代码打点的方式进行粗略的量化，比如说看onCreate执行了多久，看onResume执行了多久，这有两方面好处，一是可以粗略的定位问题，二是方便监控，比如你优化前与优化后的对比，能知道到底是否真的有提升。</p>

<p>精细化分析的方法就是抓trace，然后看具体哪里耗时了，具体使用方法可参后面的罗列的资源都相当详细，就不重复了。</p>

<p>需要注意的就是分析trace时除了用<a href="https://developer.android.com/studio/profile/android-profiler">Profiler</a>以外，还可以用<a href="https://ui.perfetto.dev/#!/">Perfecto</a>，这个功能更为强大。</p>

<h2>优化方法</h2>

<p>具体的优化方法，就没有银弹了，做的事情特别多，代码特别复杂，逻辑特别多特别复杂，优化起来难度自然很大。</p>

<p>核心的原则就是少，少即是多，少做事，特别是主线程，能lazy则lazy，能异步则异步，涉及I/O时，要多用BufferedStream，巧用缓存，buffer尽可能要是8k大小（8192），有重I/O的场景要用nio库。View tree要尽可能精简和扁平，某些特殊条件才会显示的页面就用ViewStub先占着等等。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://juejin.cn/post/6950608825942868004">Android 性能优化总结</a></li>
<li><a href="https://developer.android.com/studio/profile/cpu-profiler">Inspect CPU activity with CPU Profiler</a></li>
<li><a href="https://developer.android.com/topic/performance/tracing">Overview of system tracing</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/27331842">手把手教你使用Systrace（一）</a></li>
<li><a href="https://source.android.google.cn/devices/tech/debug/systrace">Understanding Systrace</a></li>
<li><a href="https://developer.android.com/studio/profile/measuring-performance">Overview of measuring app performance</a></li>
<li><a href="https://developer.android.com/studio/profile/benchmarking-overview">Benchmark your app</a></li>
<li><a href="https://blog.csdn.net/u011578734/article/details/109497064">性能分析工具Systrace的使用详解</a></li>
<li><a href="https://juejin.cn/post/6844903912395243533">Android Systrace 使用方法</a></li>
<li><a href="https://juejin.cn/post/6844903734263152653">Android性能优化之CPU Profiler</a></li>
<li><a href="https://www.jianshu.com/p/38fbf61c48c5">CPU Profiler 使用指南</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[让你不再惧怕内存优化]]></title>
    <link href="http://toughcoder.net/blog/2022/01/13/android-app-memory-optimization-made-easy/"/>
    <updated>2022-01-13T23:37:36+08:00</updated>
    <id>http://toughcoder.net/blog/2022/01/13/android-app-memory-optimization-made-easy</id>
    <content type="html"><![CDATA[<p>之前曾经写过一篇关于<a href="http://toughcoder.net/blog/2015/09/11/android-performance-profiling-made-easy/">如何做性能优化的文章</a>，现在针对内存这一专项再做精细化的讨论。对于安卓应用开发来说，内存究竟会遇到什么样的问题，有什么方法可以用来测试和分析，以及有什么样的策略可以去实践优化，今天就来好好聊聊这个话题。</p>

<p><a href="http://toughcoder.net/blog/2022/01/13/android-app-memory-optimization-made-easy/"><img src="https://blog.singsys.com/wp-content/uploads/2017/09/memoryLeak.jpg" title="auto auto" ></a></p>

<!-- more -->


<h2>缘起</h2>

<p>现代计算机是基于冯*诺依曼架构的，计算机的软件是运行在内存之中的，进程（也即运行中的程序）会耗费一定的内存，才能够正常执行。
在软件开发的中世纪，C和C++盛行的时代，是由软件开发人员（下称猿）自己管理内存，也就是说猿自己申请内存，并处理申请不到内存的情况，并在使用完成后自己负责释放内存，这无疑会加大程序开发难度，产生一些难以调试的问题，如内存越界或者内存踩踏。到了近现代，自动内存管理成为主流，研发人员不再用自己去手动管理内存了，尽管用，可劲儿造，由GC（也即是Garbage Collector内存回收器）来善后。</p>

<p>这极大的解放了研发人员的双手，可以让他们把更多的精力放在接收产品经理的需求上面了，三天一小需求，一周一大需求，产品迭代速度相当快，业务发展迅速，老板相当高兴啊，这干掉BAT指日可待，赶英超美就在明天，IPO触手可及。然而，现实是极其骨感的。</p>

<h2>内存问题会引发什么问题</h2>

<p>对于安卓 应用程序来说，内存优化很重要，因为Java VM本身就是比较耗资源的，当应用复杂到一定程度的时候，就会出现由内存使用不当造成的问题。如，测试同学反馈说应用越用越卡，经常crash，用户也反馈说应用越来越不好用了。老板把老猿叫进办公室一顿骂，然后老板让老猿尽快来解决一下问题。</p>

<p>老猿只得把需求放一边，花时间看一看这些问题，然后说凭我多年经验来看，这怕是内存出了问题。</p>

<p>前面提过，现代编程语言一般都有GC，帮助研发人员管理内存。但由于各种原因，还是会出现内存相关的问题。</p>

<p>特别是对于安卓猿来说，实现应用的编程语言是Java（准确说是JVM，Java和Kotlin 以及像Scala都是基于JVM的编程语言），天生支持GC，导致很多人对内存管理知之甚少。当应用程序复杂到一定程度，当源码庞大到一定的量级时，性能问题，特别是内存性能问题便随之而来。</p>

<p>具体可能是内存出现问题的场景有：</p>

<ol>
<li>OOM导致的crash。OOM，也即OutOfMemoryError，可能发生在任何地方，当Heap中可用内存不足时，便可能会遇到此类crash</li>
<li>应用程序越用越慢，出现黑屏或者白屏。</li>
<li>UI操作出现卡顿，不流畅。造成UI卡，不流畅的原因很多，当排除了其他原因时，就是内存问题了</li>
<li>应用程序莫名闪退</li>
</ol>


<h2>内存问题的具体类型及其原因</h2>

<p>要想做好内存优化，则必须先弄懂内存问题的根本原因，然后再对内存问题进行归类，最后是通过技术手段来解决。</p>

<h3>内存问题的根本原因</h3>

<p>安卓应用程序是由Java构建的，而Java是支持GC的编程语言，所以安卓猿是不需要自己手动的去做内存管理的，只管不停的创建对象即可，Java虚拟机（JVM）会帮助我们管理内存，当有不用的对象时会自动被GC。</p>

<p>但是Java应用程序（当然也包括安卓）还是会遇到内存问题，主要是两类，一类是内存不合理使用，如内存使用过多，频繁创建大量对象，内存碎片等等；二是内存泄露。很多人会把二者混为一谈，网络上绝大多数文章一谈性能优化，一谈内存优化，必然说到内存泄露，但其实并不严谨。内存泄露确实是最常见的内存优化内容，也确实是内存使用不合理的最常见问题，但内存问题并不局限于内存泄露。</p>

<h3>内存使用不合理</h3>

<p>主要分为三个方面：</p>

<ol>
<li>浪费内存，简单来理解就是用一个人住着一千平米的大平层</li>
<li>大量创建小对象，产生碎片，内存碎片会造成JVM中的内存管理效率变低，当后面申请大块内存的时候效率就变差，它需要把小对象（碎片）进行转移压缩，以腾出更大的空间给大的对象使用。简单理解，这个时候JVM的效率就会变差，你的应用程序性能变差，甚至可能引起卡顿。</li>
<li>频繁创建对象，特别是较大的对象，造成内存抖动，也即应用程序使用的内存忽多忽少，会频繁的触发GC，从而影响JVM的运行效率。</li>
</ol>


<h3>内存泄露</h3>

<p>JVM是支持自动GC的，也就是说JVM帮助你管理内存，当有不再使用的对象时，会被JVM自动回收，此称之为GC（Garbage Collection）。但如果对象长期处于『使用』状态，并且超出了它本应该存的周期，无法被及时GC，这就会造成泄露。一般来说，这也没啥影响，但是如果泄露的对象太多，或者泄露的时间够长，就会把系统配额Java Heap空间耗尽，应用程序便会因没有内存创建对象而OOM，就会crash。即使没有crash，因为剩余空间较少，会频繁触发GC，从而导致应用程序卡顿严重。</p>

<p>内存泄露的根本原因是<strong>对象的生命周期错乱</strong>，对象存活了超过了其本该的生命周期，或者简言之，一个本该是较短的生命周期的对象被一个更长生命周期的对象所引用着，就会导致它本该生命周期结束时无法被GC，便产生了泄露。</p>

<p>这是要重点关注对象的生命周期，只有管理好了对象的生命周期，才能彻底的解决内存泄露问题。</p>

<h3>安卓应用中的生命周期</h3>

<h4>短生命周期的对象</h4>

<p>安卓应用程序里面，有一些是短生命周期的，或者说有明显生命周期，且不是由研发人猿自己控制的，如框架层控制的那一坨东西。</p>

<ul>
<li>Activity</li>
<li>Fragment</li>
<li>View</li>
</ul>


<p>特别是Activity，它也是内存泄露的头号对象，90%的内存泄露都是Activity对象。这货完全由系统框架控制，并且有明显的生命周期，而且还有重建实例的情况（涉及状态恢复时），所以它的生命周期其实相当短暂，并且它跟进程和主线程没有任何关系，Activity退出 了（走了onDestroy）进程仍还在，主线程也仍还在。而，又因为它是应用程序的第1级入口，应用程序所有的对象，以及GUI所有的东西，全部都由Activity直接或者间接持有，换句话说，Activity泄露了，你整个应用程序的对象也基本上全泄露了。</p>

<h4>长生命周期对象</h4>

<p>这里所谓的长生命周期，是指它们的生命周期是与进程绑定的，除非进程退出，或者明显的执行一些退出，否则一直随进程而存在：</p>

<ul>
<li>Looper，或者说消息队列，这玩意儿除非主动quit，否则一直存在。主线程的Looper与进程同在，自己创建的Looper要手动退出才算终结。</li>
<li>被static修饰的成员变量，这东西的生命周期是跟进程一样的</li>
<li>单例，单例必须由static来修饰，所以与进程生命周期是一样的，进程在，则单例在</li>
<li>线程池，或者一个长时间运行的thread，除非主动去shutdown</li>
<li>RxJava的Schedulers，这玩意跟looper一样，都是长时间运行的消息队列，且与进程绑定的</li>
<li>系统框架，手机还在开机系统框架就在运行，所以它的生命周期远远长于某一个应用程序</li>
<li>Application和ApplicationContext，这东西与进程生命周期是一样的，相当于单例了</li>
</ul>


<h4>业务逻辑中的生命周期</h4>

<p>业务逻辑就纯属于应用程序的本身逻辑了，无法一概而论，但一般来说，主页面的生命周期肯定是长于某个子页面的。那么子页面在其退出后，理论上它的绝大多数对象应该要被回收。</p>

<h2>如何发现内存问题</h2>

<p>生活中不是缺少美，而是缺少发现。</p>

<p>对于内存优化，第一步就是要通过各种测试手段发现问题。最理想的情况是建立一种监控手段，这样最能保住革命果实，以及非常及时的发现问题。</p>

<p>这里指的是一般性的粗略手段来发现你的应用有内存问题了，可能需要优化了。并且这些测试方法最好能做成定期监控，这样一旦内存性能有回撤时，能尽快发现。</p>

<h3>『队长，我们暴露了』</h3>

<p>很多时候都是问题主动找上门来了。</p>

<h4>前方有雷区</h4>

<p>很不幸，你的应用程序中弹身亡（crash了），还是OOM。这是Java语言中的一个运行时的错误，可能在创建任何对象时发生，但一般来说创建比较大的对象时，这里的大是指对内存需求大，如图片，或者大块数组时，更容易发生。</p>

<p>当你的应用程序出现了OOM的时候，就是一个特别明显的信号，告诉你要重视内存优化了。</p>

<h4>遇到终结者了，是lowmemorykiller</h4>

<p>有时候，没有明显的错误，但是应用却闪退了，特别是在后台，或者跳到其他应用页面时。</p>

<p>这个会比较隐蔽，通常会引发其他表象的问题。最明显的问题就是，当跳转到其他页面，再返回时，发现原来的页面状态不存在了，比如你的应用要访问一个URL，跳转到了网页浏览器，但从浏览器返回时，要么你的应用不在了，要么你的应用的原先状态不在了。这其中的原因就是当你的应用不在前台了，就被系统回收了，其中一个占大头的原因就是占用内存太多，被系统的lmk（lowmemorykiller）干掉了。</p>

<p>因为系统要保证整个设备的正常运转，所以会把占用内存太多的先杀掉，以释放内存。</p>

<p>当你的应用频繁的遇到被lowmemory killer干掉时，也是一个明显的信号，要重视内存优化了。</p>

<h4>读懂系统GC日志</h4>

<p>有些时候不像前面那样严重，但是查看logcat日志时，能发现大量的GC日志，就像这样的</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>259857:01-08 20:00:17.836 10083 26337 26347 I test.test: NativeAlloc concurrent copying GC freed 141174(6852KB) AllocSpace objects, 29(12MB) LOS objects, 49% free, 24MB/48MB, paused 180us total 308.126ms
</span><span class='line'>279178:01-08 20:00:19.618 10083 26337 26347 I test.test: Background young concurrent copying GC freed 469755(20MB) AllocSpace objects, 40(3608KB) LOS objects, 41% free, 28MB/48MB, paused 396us total 124.817ms</span></code></pre></td></tr></table></div></figure>


<p>这是系统在进行GC，通常来说这没有什么问题。但如果在短时间内，比如某个页面，点了某个按扭后大量出现此类日志，也是一个明显的信号，告诉你要重视内存优化了。</p>

<h3>主动出击，以攻为守</h3>

<p>作为一个优秀的猿，不能坐着等问题上来，要能主动的去创造问题。每当完成一个需求后，或者写了一大坨代码以后，就需要主动的去查看一下内存方面是否有需要优化的地方。我们可以通过如下测试方法，来看内存是否有问题，是否需要做优化。重点就是看应用程序在一定时间内，使用的内存是否一直在增长， 有没有抖动，并且在GC后，或者退出 后是否仍不回落。</p>

<h4>meminfo</h4>

<p>具命令是adb shell dumpsys meminfo <package>，这个命令还是比较常见的，网上有很多资料可以用，可以看后面罗列的参考文章中来详细了解它的具体用法以及各个字段的意义，这里就重复了。</p>

<ul>
<li><a href="https://developer.android.com/studio/command-line/dumpsys">dumpsys</a></li>
<li><a href="https://blog.csdn.net/feelabclihu/article/details/105534175">dumpsys meminfo 的原理和应用</a></li>
<li><a href="https://www.cnblogs.com/helloTerry1987/p/13109971.html">adb shell dumpsys meminfo 详解</a></li>
<li><a href="https://www.jianshu.com/p/37539308ff32">dumpsys meminfo 含义</a></li>
</ul>


<p>需要关注一下重点，就是，可以重点看Java Heap一栏的数据变化，这是Java层的占用内存情况。另外就是每次运行meminfo其实会对进程产生影响。所以，这个命令可以用来粗维度的监控，查看一些信息，做一些定性的分析。</p>

<p>它最大的优点是方便，且只要是进程都可以查看，不用有源码。</p>

<h4>Android Studio的Memory Profiler</h4>

<p>在远古时代安卓SDK中会有DDMS，里面是一套调试工具，但现在都集成到Android Studio的Profiler里面了，通常会在下方的工具栏里面，如果 没有就到菜单View->Tools Window->Profiler把它调出来。然后选择要调试的进程，默认它会把CPU，Network，Memory和功耗都显示，这里可以双击Memory那一坨，就会进入专门的内存页面。</p>

<p>它会以时间轴的方式来图形化的展示内存使用情况，非常的直观和方便。通过这个可以直观的看到两个问题，就是嫌疑内存泄露以及内存抖动。</p>

<p>嫌疑内存泄露就是看到曲线一直在增长，且通过显示GC，或者退出后，或者停止某项目操作后，仍不回落的，这就非常有可能有泄露的存在，泄露是超出了它本该的生命周期，比如某一操作结束了，退出 了某一页面，甚至退出应用了，内存仍没有回落，就可能有问题。</p>

<p>另外就是内存抖动，就是能看到内存曲线 有毛刺，短时间内忽上忽下的，这就是内存抖动。</p>

<h4><a href="https://square.github.io/leakcanary/">leakcanary</a></h4>

<p>这货也是非常流行的，专门用于检测内存泄露的工具，它的功能较为强大，除了可以监控以外，还可以给出详细的trace。具体使用可以参考官方的文档，并不难。</p>

<p>但它最大的问题在于，必须参与项目构建。假如你想研究一下竞品的情况，就没有办法了。</p>

<h2>如何调试内存问题</h2>

<p>通过前面提到的手段，我们可以发现内存有一些问题了，需要进行内存方面的优化了，但这还不够，还需要一些精细化的调试方法来具体定位问题，这样才能更好的去进行优化。</p>

<p>那么有哪些具体的调试方法呢？</p>

<h3>Allocation tracer</h3>

<p>这个是前面提到的Android Studio Profier里面的工具。用Profiler可以发现问题，但还需要进一步的深入的分析问题。这就需要Allocation tracer了。</p>

<p>具体做法就是，当你发现某一系列操作后内存一直增长，或者看到有抖动现象时，就可以抓取这段时间的Heap dump，然后详细分析，现在Android Studio都集成好了，只需要点几下，就能抓到，并把结果列出来，可以看到具体创建哪些对象，以及它们的引用关系是怎样的。</p>

<p>可以参考 以下资源来详细了解如何使用此工具：</p>

<ul>
<li><a href="https://developer.android.com/studio/profile/android-profiler">The Android Profiler</a></li>
<li><a href="https://developer.android.com/studio/profile/memory-profiler">Inspect your app&rsquo;s memory usage with Memory Profiler</a></li>
<li><a href="https://juejin.cn/post/6844904080691691533">Android 内存优化篇 - 使用profile 和 MAT 工具进行内存泄漏检测</a></li>
</ul>


<h3><a href="https://www.eclipse.org/mat/">MAT</a></h3>

<p>这是专门用于Java heap内存分析的工具，相当强大。但不能直接使用。</p>

<p>需要先想办法抓取进程的heap dump，然后转换为Java标准的格式（因为安卓的Heap与Java SE的并不一样，安卓 SDK中有转换工具），然后再用MAT打开即可，它的功能要远强大于前面的提到的Allocation tracer。所以，如果要深度的分析和优化，还是要用MAT。</p>

<p>关于MAT的具体使用方法，可以参考以下资源：</p>

<ul>
<li><a href="http://wiki.eclipse.org/MemoryAnalyzer">官方文档</a></li>
<li><a href="https://blog.csdn.net/shulianghan/article/details/106958491">【Android 内存优化】使用 Memory Analyzer ( MAT ) 工具</a></li>
<li><a href="https://androidperformance.com/2015/04/11/AndroidMemory-Usage-Of-MAT/">Android 内存优化(1) - MAT 使用入门</a></li>
</ul>


<h3>leakcanary</h3>

<p>除了能监控以外，它还能分析具体的内存泄露，并给出trace，所以当发现问题后，具体定位问题的时候，也可以使用此工具，还是相当强大的。</p>

<p>它的使用相当简单，直接把它加入到dependencies，然后构建 就好了。</p>

<p>至于它的分析结果也是相当直观的，会以Notification的方式通知你，点开后有一个页面展示出引用关系链，然后判断是否是泄露，即可。</p>

<p>详细可以参阅它的<a href="https://square.github.io/leakcanary/getting_started/">官方文档</a>就可以了。</p>

<h2>如何优化内存</h2>

<p>内存优化，一大半在于测试，监控和调试分析，约占70%，这部分是重头，因为只有找到具体的代码位置，才好去修复问题，并且修复后还要验证问题是否真的修复了。不能光在那里看代码，想当然的认为把几个内部类改为static，或者传递引用了ApplicationContext，就能优化了内存。</p>

<p>对于性能优化，当然也包括内存优化，必须用测试手段进行量化，以此来验证是否真有有改善。</p>

<p>本节内容，假设已通过前面提到的测试方法发现了内存问题，并通过调试手段定位到了具体位置。优化的手段也要针对 具体的问题来进行：</p>

<h3>避免内存泄露</h3>

<p>内存优化的大头是要避免泄露，所以重点来谈谈如何避免内存泄露。</p>

<p>前面提到了，内存泄露的根本原因是生命周期混乱，较长生命周期的对象，甚至是超长生命周期的对象，持有了较短生命周期的对象，这一定会导致泄露。所以，要想真的解决内存泄露问题，必须设计好对象的生命周期，这是根本解决之法。</p>

<h4>要尽可能的，缩小对象的生命周期</h4>

<p>对象的生周期不应该超出它本该存在的范围，并且应该尽可能的减少对象的生命周期，这个可能在设计阶段考虑到。但一般较难执行，代码复杂了，很难控得住。</p>

<h4>对于超过Activity生命周期的对象要及时清理</h4>

<p>前面提到过的超长生命周期的东西，如Looper，如Frameworks，如单例，如RxJava的Schedulers，如线程池，这些东西的生命周期远长于Activity，所以，一定要在对应的地方，及时清除对Activity的引用持有。</p>

<p>后面的参考 资料里面也有大量的实用建议可以参考，这里就不重复了。避免内存泄露应该要被总结成为编程规范，然后在团队内部推行，当然也可以设计一些源码静态检测工具，来强制执行。当然，再好的工具和规范也需要人来遵守，任何事情能够在编码阶段防止发生，成本是最小的，收益 是最大的。</p>

<h4>WeakReference和SoftReference不是救命稻草</h4>

<p>千万不要用WeakReference和SoftReference这东西来修复内存泄露问题，它们根本就不是用来修复内存泄露问题的。</p>

<p>再说一遍，内存泄露是由<strong>生命周期混乱</strong>造成的。</p>

<p>如果强行使用WeakReference来代替原来的强引用，就会造成想使用对象的时候它却被回收了，这时你的正常逻辑就没法走了，而且如何正确的处理这种异常case，也是很难恰当 的处理的。</p>

<p>WeakReference这东西最最合理，最为适合的场景就是缓存里面，也就是说它本身是用于一种可有可无的引用关系，这样一旦被GC了，也不会影响原有逻辑，因为对象本来就可能在（Cache Hit），也可能不在缓存里面（Cache Miss），使用者必须处理在或者不在两种case。因为缓存的清理可能不够及时（必须由编码人员手动设置条件去清理，比如在退出的时候），当JVM需要GC时，因为都是WeakReference，GC就可以快速的回收对象释放内存。</p>

<h4>不要到处给对象引用置为null</h4>

<p>很多有过C++经验的同学，可能会习惯在对象使用完成后，手动把对象置为null。但其实这是完全没有必要的，只会造成不必要的混乱，JVM会自己去追踪每个对象，它到底还有没有被引用持有着。我们要把精力重点放在对象生命周期的把控上面，简单的置为null，不会缩减对象的生命周期，所以它对解决和防止泄露方面没有任何帮助。</p>

<h3>内存使用优化方式</h3>

<p>除了避免内存泄露，其他一些方式也是有很多技术可以用于优化的。</p>

<h4>减少内存浪费</h4>

<p>内存浪费，就是使用了没必要的内存，虽然可能不会引发问题，但是还是会增加风险，比如同样都是后台进程，你的应用占用内存稍大了一些，被杀的风险就高了一些。</p>

<p>减少内存浪费，核心的方法就是按需申请，特别像图片这种内存占用大户，一定要按需要来加载，何为需要就是目标View的大小，具体可以看官方教程<a href="https://developer.android.com/topic/performance/graphics/load-bitmap">Loading Large Bitmaps Efficiently</a>。以及尽可能的<a href="https://developer.android.com/topic/performance/graphics/manage-memory">要复用bitmap</a>。</p>

<p>再如资源图片，设置合理的分辨率，没有必要啥都上高清，且要为低精度设备提供单独的一套资源。</p>

<p>以及像不是要求那么清晰的场景就用RGB_565，而非RGBA_8888等等，这些都是在编码的时候就可以提高内存使用的方法。</p>

<h4>使用缓存</h4>

<p>缓存是计算机史上最伟大的发明，甚至是人类史上最伟大的发明，它无处不在从硬件到软件都会使用缓存，并且它在各种东西的设计之中都是很重要的一部分。</p>

<p>前面提到的内存抖动问题，就需要用缓存来解决，以避免频繁创建对象。特别是涉及图片的场景，比如流行的图片加载开源库里面都有专门的缓存的机制，有些是二级，有些是三级。当需要设计缓存时，可以重点参考图片加载库中的缓存设计。</p>

<p>另外，SDK中也有标准的缓存组件可以用，<a href="https://developer.android.com/reference/android/util/LruCache">LruCache</a>，这是针对内存层面的缓存，可以看<a href="https://www.jianshu.com/p/e09870b60046">这篇文章</a>来详细了解使用方法。</p>

<h4>合理复用对象</h4>

<p>这里的意思是使用像<a href="https://en.wikipedia.org/wiki/Flyweight_pattern">享元这样的设计模式</a>，来合理的复用对象。</p>

<p>需要注意的是享元(Flyweight Pattern)的适用场景，它适用于创建对象的成本较高，比如创建对象需要的一些资源较昂贵，不同的对象仅是有不同的属性，或者说对象本身在使用的时候的表现是不同的。</p>

<p>一个典型的例子就是绘图的形状，比如一个页面有大量的不同的形状需要绘制，有方的，有圆的，有白色的，有彩色的，有实边的有虚线的。常规的思路是一个基类叫Shape，里面有各种属性，还有一个draw方法，子类可以定义不同的属性，各自实现draw方法。然后根据需求创建一大坨具体的对象，遍历调用draw方法。这是面向对象编程（OOP）中的非常标准的多态（Polymophsim）。事实上，你只需要创建一个对象就够了，它会根据不同的属性画出不同的效果。这就是设计模式中的享元模式，具体可以参考<a href="https://refactoring.guru/design-patterns/flyweight">这篇文章</a>来详细了解。</p>

<h2>认识几种不同的内存类型</h2>

<p>通过各种工具查看的内存时，如通过meminfo以及像Memory profiler，但可以发现有不同种类，需要重点关注以几种：</p>

<h3>Java Heap</h3>

<p>也即通常意义上的heap内存（堆内存），名字可能会是Java，Java Heap，或者Java allocate，但都是一样就是指纯Java代码中通过new创建对象时使用的内存。</p>

<h3>Native Heap</h3>

<p>因为Java是支持JNI与C/C++接通，也即native方法，那么通过native方法创建的对象是计算在Native之中的，它与Java层是分开的，当然通过native方法（malloc或者new）创建的对象，要记得去释放，否则是一定会泄露的。</p>

<p>因为Android的大部分是由C/C++实现的，Java层仅是封装，Frameworks层大部分功能都由JNI转到native层去实现的，因此native这部分的内存也是很多的，并且由于Frameworks本身会大量调用JNI native层，所以即使你的应用程序根本没有用到JNI，但是还是会看到Native内存使用。</p>

<h3>Graphics</h3>

<p>主要是涉及OpenGL ES的相关内存占用，如GL Surfaces，如Texture或者如Framebuffer等，它们所占用的内存。</p>

<p>这里需要特别注意的是，即使你的应用没有用到OpenGL相关的东西，但仍可能会有此部分内存占用，这是由于硬件加速本身也是通过OpenGL ES实现的。</p>

<h3>ion内存</h3>

<p>这个是为了效率，直接从kernel层开出shared buffer，以加速内存使用效率，这个是偏底层的，普通app是用不到的。</p>

<p>可以参考一下这个<a href="https://www.cnblogs.com/willhua/p/10029280.html">The Android ION memory allocator</a>。</p>

<h3>共享内存</h3>

<p>可以理解为Linux中的匿名共享内存，可以用来实现IPC通信，但它并不会被Profiler计算在Java或者Native里面。非死不可出品的Fresco当初牛逼的地方就在于把Bitmap放在匿名共享内存里面，从而不占用应用自己的Heap空间。</p>

<p>可以参考这两个文章：</p>

<ul>
<li><a href="https://juejin.cn/post/6844904053961392141">Ashmem(Android共享内存)使用方法和原理</a></li>
<li><a href="https://developpaper.com/android-shared-memory/">Android shared memory</a></li>
</ul>


<h2>学无止境</h2>

<p>深入学习GC相关知识，如JVM的GC如何演进。</p>

<p>也可以学习一下其他编程语言的GC机制。</p>

<h2>不要过早优化，更不能过度优化</h2>

<p>性能优化这个事情是要在架构设计和产品设计阶段就需要考虑的事情，比如是否要加入缓存。</p>

<p>但如果前期想太多，会造成严重的扭曲，会让你陷入无限的复杂问题里面，难以自拔（本是问题1，但是变成了问题A，问题B，直到问题z，最初的问题1却被忽略了），反倒不是好事情。</p>

<p>最为想理的情况就是小步迭代，先提出能满足需求的最小版本，然后逐步迭代。比如说做一个新的feature的时候，先用最简单的架构和设计来实现，然后考虑补充细节，处理异常case，再考虑可能的扩展，然后考虑性能优化。</p>

<h2>剩下的是态度</h2>

<p>不是说一线开发的态度，而是老板们的态度。</p>

<p>性能问题是直接影响体验，所以只有重视体验的老板才会重视性能问题。而且这也不是研发猿的问题，需要测试，产品都要能重视性能问题，才能最终把性能做好。产品同学不能只顾着提需求，也要平衡性能，并且给研发同学一定的时间去注重性能问题，而测试同学更加重要，需要不断精进你的测试方法，帮助研发同学更好的解决问题，并且要有监控手段，比如说A版本做了性能优化专项，那么为了保留革命果实，需要有一种监控手段，以防性能出现重大回撤。</p>

<p>很多事情不能怪研发，就像有一位技术相当不错的同事说过的话，当时大家聊起性能优化的事情，他说：『道理大家都懂，但当左边是产品经理在那里崔需求，右边是设计师在那说按扭还差几个象素，测试同学在那崔你赶紧发版本啊，我还等着测完回家呢！当你处在这种条件下，谁TMD的还管性能啊，先实现了再说吧，甚至代码格式都懒得改了。』</p>

<p>所以，这是整个工程体系的事情，只有整个研发体系都注重性能，性能才会好，体验才会好，而这就需要一个老板的支持了，否则，性能不可能好，产品汪们只顾着提需求，设计师只顾着画面精美，研发同学光实现需求都做不完，哪有精力去搞性能啊！测试同学也不能只用粗浅的测试方法，只说性能不好，具体哪不好，不应该都让研发自己去调试，去发现问题。另外，也需要做好性能监控机制，以保住革命果实。要不然，A版本辛辛苦苦搞了一轮性能优化，也有大幅改善，然后到了B版本，或者几个月后，再来一轮。</p>

<p>这就是很骨感的现实。所以，在现实生活中只有大厂头部应用 才真的重视性能和体验，并且才能把性能和体验做好。</p>

<h2>参考资料</h2>

<ul>
<li><a href="https://developer.android.com/topic/performance/memory-overview">Overview of memory management</a></li>
<li><a href="https://developer.android.com/studio/profile">Profile your app performance</a></li>
<li><a href="https://www.jianshu.com/p/258229426da4">Android内存管理机制</a></li>
<li><a href="https://www.jianshu.com/p/51e28a2c609c">最全的Android内存优化技巧</a></li>
<li><a href="https://jsonchao.github.io/2019/08/18/Android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E4%B9%8B%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96/">Android性能优化之内存优化</a></li>
<li><a href="https://jsonchao.github.io/2019/12/29/%E6%B7%B1%E5%85%A5%E6%8E%A2%E7%B4%A2Android%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96/">深入探索Android内存优化</a></li>
<li><a href="https://juejin.cn/post/6844904096541966350">Android性能优化之内存优化</a></li>
<li><a href="https://juejin.cn/post/6844904099998089230">深入探索 Android 内存优化（炼狱级别-上）</a></li>
<li><a href="https://juejin.cn/post/6872919545728729095">深入探索 Android 内存优化（炼狱级别-下）</a></li>
<li><a href="https://juejin.cn/post/6844904191282905096">内存优化深入版</a></li>
<li><a href="https://pspdfkit.com/blog/2019/android-large-memory-requirements/">Dealing with Large Memory Requirements on Android</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
