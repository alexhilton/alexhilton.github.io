<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[ç¨€æœ‰çŒ¿è¯‰]]></title>
  <link href="https://alexhilton.github.io/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2025-11-25T08:34:05+00:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Jetpack Composeä¸­çš„é˜´å½±è‰ºæœ¯]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose/"/>
    <updated>2025-11-24T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒThe Art of Shadows in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/proandroiddev/the-art-of-shadows-in-jetpack-compose-63a75070882f">https://medium.com/proandroiddev/the-art-of-shadows-in-jetpack-compose-63a75070882f</a>ï¼Œç”±Stefano Nataliå‘å¸ƒäº2025å¹´10æœˆ4æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*UjyqMyVg002OIDJ1Hdee8Q.png" title="auto auto" ></a></p>

<!-- more -->


<p>UI ä¸­çš„é˜´å½±å‘æŒ¥ç€è‡³å…³é‡è¦çš„ä½œç”¨ï¼šå®ƒä»¬åœ¨è§†è§‰ä¸Š<strong>æå‡</strong>å…ƒç´ ï¼ŒæŒ‡ç¤ºç€<strong>äº¤äº’æ€§</strong>ï¼Œå¹¶æä¾›ç”¨æˆ·æ“ä½œçš„å³æ—¶<strong>åé¦ˆ</strong>ã€‚å¤šå¹´æ¥ï¼Œæˆ‘ä»¬ä¸€ç›´ä¾èµ–äº<strong>é«˜åº¦</strong>å±æ€§ï¼Œä½† Jetpack Compose ç°åœ¨æä¾›äº†ä¸€å¥—å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥å¯¹<strong>é˜´å½±æ¸²æŸ“</strong>è¿›è¡Œç²¾ç»†æ§åˆ¶ã€‚</p>

<p>Google æœ€è¿‘æ–°å¢äº†ä¸€ä¸ª<a href="https://developer.android.com/develop/ui/compose/graphics/draw/shadows">æ–‡æ¡£é¡µé¢</a>ï¼Œå…¶ä¸­åŒ…å«ä¸€ç³»åˆ—æœ‰è¶£çš„ç”¨ä¾‹ã€‚æœ¬æ–‡å°†æ¢ç´¢ Compose ä¸­çš„ä¸»è¦é˜´å½±ä¿®æ”¹å™¨ï¼Œå¹¶æ·±å…¥è®²è§£åˆ›å»ºæ¸å˜å’Œç‚«é…·ç‰¹æ•ˆç­‰é«˜çº§æŠ€å·§ï¼Œä»è€Œæå‡åº”ç”¨çš„é£æ ¼ã€‚</p>

<p>æœ¬æ–‡è®¨è®ºçš„æ‰€æœ‰æŠ€å·§çš„å®Œæ•´ä»£ç ç¤ºä¾‹éƒ½å¯ä»¥åœ¨æˆ‘çš„ GitHub ä»“åº“ <a href="https://github.com/stefanoq21/ComposePlayground"><strong>Compose Playground</strong></a> ä¸­æ‰¾åˆ°ã€‚</p>

<h2>é˜´å½±ä¿®æ”¹å™¨ï¼ˆShadow Modifiersï¼‰</h2>

<p>æ·»åŠ é˜´å½±æœ€ç®€å•ä½†è‡ªå®šä¹‰ç¨‹åº¦æœ€ä½çš„æ–¹æ³•æ˜¯ä½¿ç”¨ <strong>Modifier.shadow()</strong>ã€‚ä¸ä»¥å¾€ä¸€æ ·ï¼Œå®ƒçš„è¡Œä¸ºä¾èµ–äº<strong>åŸºäºé«˜åº¦çš„é˜´å½±</strong>ï¼Œæ¨¡æ‹Ÿæ¥è‡ªä¸Šæ–¹çš„å…‰æºï¼Œé˜´å½±æ·±åº¦ç›´æ¥å–å†³äºä½ æä¾›çš„é«˜åº¦å€¼ã€‚å…¶ä¸»è¦é™åˆ¶åœ¨äºé˜´å½±å§‹ç»ˆè¢«è£å‰ªåˆ°å¯åˆæˆå¯¹è±¡çš„å½¢çŠ¶å†…ï¼Œå¹¶ä¸”ä½ æ— æ³•è‡ªå®šä¹‰æ‰©å±•ã€é¢œè‰²è‰²è°ƒæˆ–åç§»ç­‰å±æ€§ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">Box</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">shadow</span><span class="p">(</span>
</span><span class='line'>            <span class="n">elevation</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:704/1*7Nkm6z8Ls4FyvDqCcKToDw.png" alt="" /></p>

<p>è®©æˆ‘ä»¬ä»ä¸€äº›æ–°åŠŸèƒ½å¼€å§‹ï¼Œè¿™äº›åŠŸèƒ½èµ‹äºˆæˆ‘ä»¬æ›´å¼ºå¤§çš„åŠ›é‡ã€‚ä½¿ç”¨ <strong>dropShadow()</strong>ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å†…å®¹åé¢åˆ›å»ºè‡ªå®šä¹‰é˜´å½±ã€‚è¿™ä¸ªä¿®é¥°ç¬¦æ˜¯åˆ›å»ºå¤æ‚é˜´å½±çš„å…³é”®ï¼Œå®ƒå…è®¸å¯¹å†…å®¹åé¢çš„é˜´å½±è¿›è¡Œç²¾ç»†æ§åˆ¶ï¼Œä½¿å…ƒç´ çœ‹èµ·æ¥åƒæ˜¯è¢«æŠ¬å‡äº†ä¸€æ ·ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>            <span class="n">radius</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">spread</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:990/1*kENF6x3L985dO65DSY0Zng.png" alt="" /></p>

<p>å®ƒä½¿ç”¨ <strong>Shadow</strong> å‚æ•°ï¼Œå¯ä»¥ç²¾ç¡®æ§åˆ¶è§†è§‰æ•ˆæœã€‚è¿™ä¸ªå‚æ•°å…è®¸ä½ ä½¿ç”¨å‡ ä¸ªå…³é”®å±æ€§æ¥å¡‘é€ é˜´å½±ã€‚ <strong>åŠå¾„</strong> å†³å®šäº†è¾¹ç¼˜çš„æŸ”å’Œåº¦å’Œæ‰©æ•£ï¼ˆæ¨¡ç³Šï¼‰ç¨‹åº¦ã€‚<strong>æ‰©æ•£</strong> å€¼æ§åˆ¶é˜´å½±å‡ ä½•å½¢çŠ¶ç›¸å¯¹äºå¯ç»„åˆå…ƒç´ å¤§å°çš„æ‰©å±•æˆ–æ”¶ç¼©ã€‚æœ€åï¼Œ<strong>åç§»</strong> æ²¿ <strong>X è½´å’Œ Y è½´</strong>å®šä½é˜´å½±ï¼Œä»è€Œç¡®å®šå…‰æºçš„è§†è§‰æ–¹å‘ã€‚ç»“åˆé˜´å½±çš„<strong>é¢œè‰²</strong>ï¼Œè¿™äº›å±æ€§å¯ä»¥å®ç°å®Œå…¨è‡ªå®šä¹‰ã€‚</p>

<p>ğŸ’¡ <strong>é¡ºåºå¾ˆé‡è¦ï¼š</strong>åœ¨ä¿®æ”¹å™¨é“¾ä¸­ï¼Œ<strong>dropShadow()</strong> ä¿®æ”¹å™¨å¿…é¡»å‡ºç°åœ¨ <strong>background()</strong> ä¿®æ”¹å™¨<strong>ä¹‹å‰</strong>ï¼Œå› ä¸ºé˜´å½±å…ˆç»˜åˆ¶ï¼ŒèƒŒæ™¯ç»˜åˆ¶åœ¨å…¶ä¸Šæ–¹ã€‚</p>

<p><strong>innerShadow()</strong> ä¿®æ”¹å™¨æ˜¯ <strong>dropShadow()</strong> çš„é€†æ“ä½œï¼Œå®ƒåœ¨å¯ç»„åˆå…ƒç´ è¾¹ç•Œçš„<strong>å†…éƒ¨</strong>åˆ›å»ºé˜´å½±ï¼Œä»è€Œå®ç°å…ƒç´ å‡¹é™·æˆ–å‹å…¥è¡¨é¢çš„è§†è§‰æ•ˆæœã€‚ä¸å®ƒçš„å¯¹åº”é¡¹ä¸€æ ·ï¼Œå®ƒä¹Ÿä½¿ç”¨å¯è‡ªå®šä¹‰çš„<strong>Shadow</strong>å¯¹è±¡ï¼Œå…è®¸ä½ ä½¿ç”¨<strong>åŠå¾„</strong>ã€<strong>é¢œè‰²</strong>ã€<strong>åç§»</strong>å’Œ<strong>æ‰©æ•£</strong>æ¥å¾®è°ƒæ•ˆæœã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">innerShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1108/1*a7KFFaTXCk4KC-sm9AYUoQ.png" alt="" /></p>

<p>ğŸ’¡<strong>å†æ¬¡å¼ºè°ƒï¼Œé¡ºåºå¾ˆé‡è¦ï¼š</strong><strong>innerShadow()</strong>ä¿®æ”¹å™¨<strong>å¿…é¡»</strong>æ”¾åœ¨<strong>background()</strong>ä¿®æ”¹å™¨<strong>ä¹‹å</strong>ã€‚å¦‚æœå°†å…¶æ”¾åœ¨èƒŒæ™¯ä¹‹å‰ï¼Œå†…å®¹å°†ç»˜åˆ¶åœ¨é˜´å½±ä¹‹ä¸Šï¼Œå®Œå…¨é®ç›–é˜´å½±ã€‚</p>

<p>è¿™äº›ä¿®æ”¹å™¨çš„çœŸæ­£å¼ºå¤§ä¹‹å¤„åœ¨äºå®ƒä»¬çš„è‡ªå®šä¹‰å’Œç»„åˆã€‚é€šè¿‡å åŠ <strong>innerShadow()</strong>å’Œ<strong>dropShadow()</strong>ï¼Œä½ å¯ä»¥åˆ›å»ºå¤æ‚è€Œé€¼çœŸçš„è§†è§‰æ•ˆæœã€‚æˆ‘ä»¬æ¥çœ‹ä¸€äº›é«˜çº§ç”¨ä¾‹ã€‚</p>

<h2>é«˜çº§æŠ€å·§ï¼šç»„åˆå’Œè‡ªå®šä¹‰é˜´å½±</h2>

<h3>è‡ªå®šä¹‰é˜´å½±</h3>

<p>å½“ä½ åœ¨ <strong>dropShadow()</strong> å‡½æ•°ä¸­å°† <strong>Brush</strong> å¯¹è±¡è€Œéçº¯è‰²ä¼ é€’ç»™ <strong>Shadow</strong> å¯¹è±¡æ—¶ï¼Œè‡ªå®šä¹‰çš„å¼ºå¤§åŠŸèƒ½ä¾¿æ˜¾è€Œæ˜“è§ã€‚æ­¤åŠŸèƒ½å…è®¸ä½ ä½¿ç”¨ <strong>Brush.sweepGradient</strong> åˆ›å»ºæ¸å˜æ•ˆæœã€‚æ­¤å¤–ï¼Œæ— è®ºä½ ä½¿ç”¨æ ‡å‡†å½¢çŠ¶è¿˜æ˜¯å®Œå…¨è‡ªå®šä¹‰çš„å‡ ä½•ä½“ï¼Œé˜´å½±å§‹ç»ˆä¼šè´´åˆå¯ç»„åˆå¯¹è±¡çš„å½¢çŠ¶ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialShapes</span><span class="p">.</span><span class="n">Cookie12Sided</span><span class="p">.</span><span class="n">toShape</span><span class="p">(),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">sweepGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Yellow</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">)</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialShapes</span><span class="p">.</span><span class="n">Cookie12Sided</span><span class="p">.</span><span class="n">toShape</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1122/1*a8xMvXOb3hS6icdGU0p1gg.png" alt="" /></p>

<h3>æ–°ç²—çŠ·ä¸»ä¹‰é˜´å½±</h3>

<p>è¿™ç§é£æ ¼å®Œç¾åœ°å±•ç°äº† <strong>dropShadow()</strong> ä¿®æ”¹å™¨åœ¨å®ç°æè‡´é«˜å¯¹æ¯”åº¦æ•ˆæœæ–¹é¢çš„å¼ºå¤§åŠŸèƒ½ã€‚è¦å®ç°æ–°ç²—çŠ·ä¸»ä¹‰ï¼ˆNeobrutalismï¼‰é‚£ç§ç²—çŠ·ã€æ£±è§’åˆ†æ˜çš„è§†è§‰æ•ˆæœï¼Œä½ å¿…é¡»ä½¿ç”¨ <code>dropShadow()</code> å‡½æ•°ï¼Œå¹¶è®¾ç½®æ¨¡ç³Šåº¦ä¸ºé›¶ï¼Œåç§»é‡è¦æ˜æ˜¾ï¼Œé€šå¸¸è¿˜è¦é…åˆç²—è¾¹æ¡†ã€‚å…·ä½“æ¥è¯´ï¼Œä½ éœ€è¦åŒæ—¶è®¾ç½® <code>radius = 0.dp</code> å’Œ <code>spread = 0.dp</code> æ¥æ¶ˆé™¤æ‰©æ•£ï¼Œç„¶ååº”ç”¨é²œè‰³çš„è‰²å½©ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªæ˜æ˜¾çš„åç§»é‡ï¼Œä»è€Œåˆ›å»ºå‡ºæ ‡å¿—æ€§çš„é”åˆ©è½®å»“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>     <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>     <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">dropShadowColor</span><span class="p">,</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">border</span><span class="p">(</span>
</span><span class='line'>    <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">borderColor</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*bdPpm0XYPfTXMuoNrVQuZw.png" alt="" /></p>

<h3>å…·æœ‰åŠ¨æ•ˆçš„é˜´å½±</h3>

<p>é˜´å½±å¹¶éåªæ˜¯é™æ€çš„ï¼›å®ƒä»¬å¯ä»¥åˆ¶ä½œæˆåŠ¨ç”»ï¼Œä»è€Œæä¾›å³æ—¶çš„ç”¨æˆ·åé¦ˆã€‚æˆ‘ä»¬å°†è¦æ¢ç´¢çš„æœ€åä¸€ä¸ªé«˜çº§æŠ€å·§æ˜¯åˆ›å»ºäº¤äº’å¼é˜´å½±ï¼Œä½¿å…¶åœ¨ç‰¹å®šæ“ä½œï¼ˆä¾‹å¦‚ç‚¹å‡»æˆ–æŒ‰ä¸‹ï¼‰æ—¶å¹³æ»‘è¿‡æ¸¡ã€‚è¿™é¡¹æŠ€æœ¯å¯¹äºæ¨¡æ‹Ÿç‰©ç†äº¤äº’è‡³å…³é‡è¦ï¼Œå®ƒèƒ½ç›´è§‚åœ°ç¡®è®¤å…ƒç´ çš„æŠ¬å‡æˆ–çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isPressed</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsPressedAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Create transition with pressed state</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">transition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span>
</span><span class='line'>            <span class="n">targetState</span> <span class="p">=</span> <span class="n">isPressed</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;button_press_transition&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">=</span> <span class="n">tween</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>            <span class="n">durationMillis</span> <span class="p">=</span> <span class="m">400</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">Ease</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Animate all properties using the transition</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">shadowAlpha</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateFloat</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;shadow_alpha&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">)</span> <span class="m">0f</span> <span class="k">else</span> <span class="m">1f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//to animate the color</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">colorDropShadow</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateColor</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;shadow_color&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">Transparent</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">innerShadowAlpha</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateFloat</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;inner_shadow_alpha&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">pressed</span><span class="p">)</span> <span class="m">0f</span> <span class="k">else</span> <span class="m">1f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">clickable</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">interactionSource</span><span class="p">,</span> <span class="n">indication</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">//...</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">300.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">radius</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">spread</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">)),</span>
</span><span class='line'>                        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">alpha</span> <span class="p">=</span> <span class="n">shadowAlpha</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="c1">// note that the background needs to be defined before defining the inner shadow</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFFFFFFF</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">innerShadow</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">radius</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">spread</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">)),</span>
</span><span class='line'>                        <span class="n">alpha</span> <span class="p">=</span> <span class="n">innerShadowAlpha</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*idzAQ4lII7JweFZdCyfNqg.gif" alt="" /></p>

<p>å¥½çš„ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•ä½¿ç”¨ <strong>updateTransition</strong> API æ¥åˆ›å»ºæµç•…çš„äº¤äº’åé¦ˆã€‚å®ƒé¦–å…ˆä½¿ç”¨ <strong>MutableInteractionSource</strong> è·Ÿè¸ªæŒ‰ä¸‹çŠ¶æ€ã€‚è¯¥çŠ¶æ€ä¼šé©±åŠ¨ä¸€ä¸ª <strong>400 æ¯«ç§’çš„è¿‡æ¸¡åŠ¨ç”»</strong>ï¼ŒåŒæ—¶ä¸ºä¸¤ä¸ªæ–¹å‘ç›¸åçš„é˜´å½±æ·»åŠ åŠ¨ç”»æ•ˆæœã€‚å¤–éƒ¨çš„ <strong>dropShadow</strong> åœ¨æŒ‰ä¸‹æ—¶ä¼šæ·¡å‡ºï¼Œè€Œå†…éƒ¨çš„ <strong>innerShadow</strong> åˆ™ä¼šæ·¡å…¥ã€‚è¿™ç§åŒé˜´å½±åŠ¨ç”»ä½¿ç»„ä»¶ä» <strong>æŠ¬å‡</strong> çŠ¶æ€å¹³æ»‘è¿‡æ¸¡åˆ° <strong>å‡¹é™·</strong> çŠ¶æ€ï¼Œä»è€Œåœ¨ç”¨æˆ·äº¤äº’æ—¶æä¾›æ¸…æ™°ä¸”åŠ¨æ€çš„åé¦ˆã€‚</p>

<h2>ç»“è®º</h2>

<p>Compose å…¨æ–°çš„é˜´å½± API æ ‡å¿—ç€å¯¹ä¼ ç»Ÿ <strong>elevation</strong> å±æ€§å±€é™æ€§çš„é‡å¤§çªç ´ã€‚å®ƒå°†æ ¸å¿ƒæ¦‚å¿µæ‹†åˆ†ä¸º <strong>dropShadow()</strong> å’Œ <strong>innerShadow()</strong>ï¼Œå¹¶èµ‹äºˆæˆ‘ä»¬å¯¹ <strong>Shadow</strong> å¯¹è±¡å±æ€§çš„å®Œå…¨æ§åˆ¶æƒã€‚</p>

<p>æ— è®ºä½ æ˜¯æ‰“é€ ç®€å•çš„æ¸å˜æ•ˆæœã€æ¨¡æ‹Ÿç‰©ç†æ·±åº¦ï¼Œè¿˜æ˜¯å®ç°æ–°ç²—é‡ä¸»ä¹‰çš„é«˜å¯¹æ¯”åº¦è§†è§‰å†²å‡»ï¼Œè¿™ç§å…¨æ–°çš„è‡ªå®šä¹‰ç¨‹åº¦éƒ½æ„å‘³ç€ä½ çš„ <strong>UI ç»ˆäºå¯ä»¥å……åˆ†å±•ç°ä½ è®¾è®¡çš„è‰ºæœ¯æ„¿æ™¯</strong>ã€‚</p>

<p>ä¸å¦¨å°è¯•è¿™äº›ä¿®é¥°ç¬¦ï¼Œä¸ºä½ çš„ Jetpack Compose åº”ç”¨æ³¨å…¥å…¨æ–°çš„åˆ›æ„ç»´åº¦ï¼</p>

<p>å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰è¶£ï¼Œæ¬¢è¿å…³æ³¨æˆ‘ï¼Œè·å–æ›´å¤šå…³äº Android å¼€å‘å’Œ Jetpack Compose çš„ç²¾å½©å†…å®¹ã€‚æˆ‘ä¼šå®šæœŸå‘å¸ƒç›¸å…³ä¸»é¢˜çš„æ–‡ç« ã€‚æ¬¢è¿éšæ—¶åˆ†äº«ä½ çš„è¯„è®ºï¼Œæˆ–é€šè¿‡ <a href="https://bsky.app/profile/stefanoq21.bsky.social"><strong>Bluesky</strong></a> æˆ– <a href="http://www.linkedin.com/in/stefano-natali-q21"><strong>LinkedIn</strong></a> ä¸æˆ‘è”ç³»ï¼Œè¿›è¡Œæ›´æ·±å…¥çš„è®¨è®ºã€‚</p>

<p>ç¥ä½ å¼€å¿ƒï¼Œç¼–ç¨‹å¿«ä¹ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åœ¨Jetpack Composeä¸­åˆ›å»ºCRTå±å¹•æ•ˆæœ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/12/crt-effects/"/>
    <updated>2025-11-12T13:42:48+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/12/crt-effects</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCreating a CRT Screen Effect in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/">https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/</a>ï¼Œç”±sinasamakiå‘å¸ƒäº2025å¹´11æœˆ7æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/12/crt-effects/"><img src="https://www.sinasamaki.com/content/images/size/w2000/2025/11/CRT.png" title="auto auto" ></a></p>

<!-- more -->


<p>CRT æ˜¾ç¤ºå™¨å…·æœ‰ç‹¬ç‰¹è€Œæ€€æ—§çš„å¤–è§‚ï¼šæ¨¡ç³Šçš„è¾¹ç¼˜ã€æ‰«æçº¿å’Œè½»å¾®çš„è‰²å½©æº¢å‡ºã€‚è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ <code>GraphicsLayer</code> å’Œä¸€äº›å·§å¦™çš„å›¾å±‚æŠ€å·§åœ¨ Jetpack Compose ä¸­é‡ç°è¿™ç§æ•ˆæœã€‚</p>

<h2>GraphicsLayer</h2>

<p>ä¸ä¸Šä¸€ç¯‡æ–‡ç« ä¸€æ ·ï¼Œæ­¤æ•ˆæœçš„åŸºç¡€æ˜¯ <code>GraphicsLayer</code>ã€‚å®ƒå…è®¸æˆ‘ä»¬å°†å†…å®¹ç»˜åˆ¶ä¸€æ¬¡åˆ°å±å¹•å¤–ç¼“å†²åŒºã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä»¥æä½çš„æ€§èƒ½å¼€é”€å¤šæ¬¡ä½¿ç”¨ä¸åŒçš„æ•ˆæœé‡æ–°ç»˜åˆ¶å®ƒã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">graphicsLayer</span> <span class="p">=</span> <span class="n">rememberGraphicsLayer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">drawWithContent</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">graphicsLayer</span><span class="p">.</span><span class="n">record</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="n">@drawWithContent</span><span class="p">.</span><span class="n">drawContent</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">content</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸€æ—¦æˆ‘ä»¬å°†å†…å®¹è®°å½•åˆ° <code>graphicsLayer</code> ä¸­ï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>drawLayer(graphicsLayer)</code> æ ¹æ®éœ€è¦å¤šæ¬¡ç»˜åˆ¶å®ƒã€‚</p>

<p>æˆ‘å–œæ¬¢åœ¨é»‘è‰²èƒŒæ™¯ä¸Šç»˜åˆ¶è‰²å½©é²œè‰³ã€é¥±å’Œåº¦é«˜çš„å†…å®¹ï¼Œå¹¶è¿ç”¨è¿™ç§æ•ˆæœã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å°†åº”ç”¨æ­¤æ•ˆæœçš„åŸºç¡€å¯ç»„åˆå¯¹è±¡ã€‚</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-09.39.28.png" alt="" /></p>

<h2>æ·»åŠ æ‰«æçº¿</h2>

<p>ä¸ºäº†æ¨¡æ‹Ÿ CRT æ˜¾ç¤ºå™¨ä¸Šçš„æ°´å¹³æ‰«æçº¿ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é‡å¤æ¸å˜ã€‚è®©æˆ‘ä»¬å°†å…¶æ”¾å…¥ä¸€ä¸ªæ‰©å±•å‡½æ•°ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">blendMode</span><span class="p">:</span> <span class="n">BlendMode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">color</span> <span class="p">=</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">verticalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startY</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endY</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">horizontalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startX</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endX</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬æ‰‹åŠ¨å®šä¹‰é¢œè‰²åœæ­¢ç‚¹ï¼Œä»¥ä¾¿åœ¨é¢œè‰²ä¹‹é—´å½¢æˆæ¸…æ™°çš„è¾¹ç¼˜ï¼Œç„¶åå°† <code>tileMode</code> è®¾ç½®ä¸º <code>Repeated</code>ã€‚è¿™æ ·ï¼Œå†åŠ ä¸Šè¾ƒçŸ­çš„èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œå°±èƒ½å¾—åˆ°è®¸å¤šé‡å¤çš„å¹³è¡Œçº¿ã€‚</p>

<p>æ‰©å±•å‡½æ•°è¿˜ä¼šæ¥æ”¶æˆ‘ä»¬æ‰€éœ€çš„é€æ˜åº¦å’Œ <code>BlendMode</code> å‚æ•°ã€‚</p>

<p>ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ­¤å‡½æ•°åœ¨ <code>graphicsLayer</code> ä¸Šç»˜åˆ¶æ‰«æçº¿ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>        <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å°†æ··åˆæ¨¡å¼è®¾ç½®ä¸º <code>DstOut</code> ä¼šä»ç»˜åˆ¶çš„å†…å®¹ä¸­â€œå‡å»â€æˆ‘ä»¬çš„æ¸å˜ï¼Œä»è€Œäº§ç”Ÿè¿™ç§æ•ˆæœã€‚</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-09.39.55.png" alt="" /></p>

<h2>æ„å»ºæ¨¡ç³Šå›¾å±‚</h2>

<p>ä¸ºäº†å®ç° CRT å±å¹•å¸¸è§çš„å‘å…‰æ•ˆæœï¼Œæˆ‘ä»¬å°†å¤šæ¬¡ç»˜åˆ¶ <code>graphicsLayer</code> å›¾å±‚ï¼Œæ¯æ¬¡ç»˜åˆ¶æ—¶åˆ†åˆ«è®¾ç½®ä¸åŒçš„æ¨¡ç³ŠåŠå¾„ã€é€æ˜åº¦å’Œç¼©æ”¾æ¯”ä¾‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">blurLayers</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.2f</span><span class="p">,</span> <span class="m">1.02f</span> <span class="n">to</span> <span class="m">1.03f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">2f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.9f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">40.</span><span class="n">dp</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ª <code>Triple</code> åˆ—è¡¨æ¥å­˜å‚¨æ¯ä¸ªå›¾å±‚çš„æ•°æ®ã€‚è¯¥åˆ—è¡¨çš„é¡ºåºä¹Ÿå®šä¹‰äº†å®ƒä»¬çš„ç»˜åˆ¶é¡ºåºã€‚æˆ‘å»ºè®®ä½ å°è¯•è°ƒæ•´è¿™äº›å€¼å’Œé¡ºåºï¼Œä»¥è·å¾—æ‰€éœ€çš„æ•ˆæœã€‚ä½†è¿™æ˜¯æˆ‘ç›®å‰ä½¿ç”¨çš„æ–¹æ³•ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">blurLayers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">matchParentSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">BlurredEdgeTreatment</span><span class="p">.</span><span class="n">Unbounded</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">scaleX</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">first</span>
</span><span class='line'>                <span class="n">scaleY</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">second</span>
</span><span class='line'>                <span class="k">this</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ—è¡¨ä¸­çš„å€¼ç»˜åˆ¶æ¯ä¸ªå›¾å±‚ã€‚åœ¨ <code>drawBehind</code> ä¿®æ”¹å™¨ä¸Šæ–¹ï¼Œæˆ‘ä»¬å°†å›¾å±‚å¤§å°è®¾ç½®ä¸ºä¸çˆ¶å›¾å±‚åŒ¹é…ï¼Œå¹¶åº”ç”¨æ¨¡ç³Šã€ç¼©æ”¾å’Œé€æ˜åº¦ã€‚è¯·è®°ä½å°†æ¨¡ç³Šè®¾ç½®ä¸º <code>Unbounded</code>ï¼Œä½¿å…¶è¶…å‡ºåŒ…å«å®ƒçš„å¯ç»„åˆå¯¹è±¡çš„è¾¹ç•Œã€‚</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-08.33.20.png" alt="" /></p>

<h2>å±å¹•æŠ–åŠ¨</h2>

<p>æœ€åï¼Œæˆ‘ä»¬æ¥æ·»åŠ å±å¹•æŠ–åŠ¨æ•ˆæœï¼Œä»¥æ¨¡æ‹Ÿ CRT æ˜¾ç¤ºå™¨ç‰¹æœ‰çš„æŠ–åŠ¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª <code>Offset</code> å¯¹è±¡ï¼Œå¹¶ç”¨ -1 åˆ° 1 ä¹‹é—´çš„éšæœºæµ®ç‚¹å€¼æ¥æ›´æ–°å®ƒã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">var</span> <span class="py">shake</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">shake</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">32</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œåªéœ€åœ¨ä¸€ä¸ª while å¾ªç¯ä¸­å³å¯å®Œæˆã€‚å¯ä»¥è°ƒæ•´å»¶è¿Ÿæ—¶é—´æ¥æ§åˆ¶é—ªçƒçš„é—´éš”é¢‘ç‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">translationX</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">x</span>
</span><span class='line'>        <span class="n">translationY</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åå¯ä»¥ä½¿ç”¨ä¿®é¥°ç¬¦æ¥åº”ç”¨æ­¤åç§»é‡ã€‚</p>

<p><img src="file:///Users/alexhilton/Downloads/crt_opt.gif" alt="" /></p>

<h2>æ•´åˆæ‰€æœ‰åŠŸèƒ½</h2>

<p>è®©æˆ‘ä»¬å°†æ‰€æœ‰è¿™äº›åŠŸèƒ½ç»„åˆæˆä¸€ä¸ªå¯è½»æ¾ä½¿ç”¨çš„ç»„åˆã€‚å®ƒä¼šæ¥æ”¶ <code>content</code> å‚æ•°ä»¥åŠ <code>flickerDelay</code> å‚æ•°ï¼Œåè€…ç”¨äºæ§åˆ¶é—ªçƒé¢‘ç‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CRTBox</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flickerDelay</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">shake</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">flickerDelay</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">shake</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="n">flickerDelay</span><span class="p">.</span><span class="n">toLong</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">graphicsLayer</span> <span class="p">=</span> <span class="n">rememberGraphicsLayer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">translationX</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">x</span>
</span><span class='line'>                <span class="n">translationY</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">drawWithContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">graphicsLayer</span><span class="p">.</span><span class="n">record</span> <span class="p">{</span> <span class="k">this</span><span class="n">@drawWithContent</span><span class="p">.</span><span class="n">drawContent</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">content</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">blurLayers</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">3f</span><span class="p">,</span> <span class="m">1.02f</span> <span class="n">to</span> <span class="m">1.03f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">8f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">9f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">6f</span><span class="p">,</span> <span class="m">1.001f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">40.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">7f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">blurLayers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">matchParentSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">BlurredEdgeTreatment</span><span class="p">.</span><span class="n">Unbounded</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">scaleX</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">first</span>
</span><span class='line'>                        <span class="n">scaleY</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">second</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">layer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">bounds</span><span class="p">:</span> <span class="n">Rect</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">toRect</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">block</span><span class="p">:</span> <span class="n">DrawScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">drawIntoCanvas</span> <span class="p">{</span> <span class="n">canvas</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">canvas</span><span class="p">.</span><span class="n">withSaveLayer</span><span class="p">(</span>
</span><span class='line'>            <span class="n">bounds</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">,</span>
</span><span class='line'>            <span class="n">paint</span> <span class="p">=</span> <span class="n">Paint</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">block</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">blendMode</span><span class="p">:</span> <span class="n">BlendMode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">color</span> <span class="p">=</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">verticalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startY</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endY</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">horizontalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startX</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endX</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œä½ å¯ä»¥åƒä½¿ç”¨å…¶ä»–å¯ç»„åˆç»„ä»¶ä¸€æ ·ä½¿ç”¨å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">CRTBox</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;GAME OVER&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sweeper æ›´æ–°</h2>

<p>å¦‚æœä½ æƒ³æŸ¥çœ‹å®é™…æ•ˆæœï¼Œè¯·æŸ¥çœ‹æœ€æ–°çš„ Sweeper æ›´æ–°ï¼Œè¯¥æ›´æ–°ä½¿ç”¨ CRT æ•ˆæœåˆ›å»ºäº†ä¸€ä¸ªä»¤äººæ¯›éª¨æ‚šç„¶çš„ä¸‡åœ£èŠ‚ä¸»é¢˜ã€‚</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/IMG_9612-Edited-copy.jpeg" alt="" /></p>

<p><a href="https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper&amp;ref=sinasamaki.com">https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper</a></p>

<p><a href="https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495?ref=sinasamaki.com">https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495</a></p>

<p>æ„Ÿè°¢é˜…è¯»ï¼Œç¥ä½ å¥½è¿ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ä½¿ç”¨CameraX 1.5è¿›è¡Œé«˜é€Ÿæ‹æ‘„å’Œæ…¢åŠ¨ä½œè§†é¢‘æ‹æ‘„]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion/"/>
    <updated>2025-11-05T13:59:12+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒHigh-Speed Capture and Slow-Motion Video with CameraX 1.5ã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://android-developers.googleblog.com/2025/10/high-speed-capture-and-slow-motion.html">https://android-developers.googleblog.com/2025/10/high-speed-capture-and-slow-motion.html</a>ï¼Œç”±Leo Huangå‘å¸ƒäº2025å¹´10æœˆ28æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion/"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhSMEQNJHjQybdOLzAewkopnpZ6OUC0jYiXboj3chVWnaFbKtD5bPA4azyqjM7_ffdGv_nBnvYUgoqvhISE7-lff-aGkF8f200ENGHF9" title="auto auto" ></a></p>

<!-- more -->


<p>æ¸…æ™°æ•æ‰å¿«é€Ÿè¿åŠ¨çš„ç”»é¢æ˜¯ç°ä»£ç›¸æœºåº”ç”¨çš„å…³é”®ç‰¹æ€§ã€‚è¿™å¯ä»¥é€šè¿‡é«˜é€Ÿæ‹æ‘„æ¥å®ç°â€”â€”å³ä»¥ 120 æˆ– 240 fps ç­‰é€Ÿç‡é‡‡é›†å¸§ã€‚è¿™ç§é«˜ä¿çœŸæ‹æ‘„å¯ç”¨äºä¸¤ç§æˆªç„¶ä¸åŒçš„ç”¨é€”ï¼šåˆ›å»ºé«˜å¸§ç‡è§†é¢‘ä»¥è¿›è¡Œé€å¸§çš„è¯¦ç»†åˆ†æï¼Œæˆ–ç”Ÿæˆæ…¢åŠ¨ä½œè§†é¢‘ï¼Œä½¿åŠ¨ä½œåœ¨å±å¹•ä¸Šå‘ˆç°å‡ºæˆå‰§æ€§çš„å±•å¼€æ•ˆæœã€‚</p>

<p>ä»¥å‰ï¼Œä½¿ç”¨ Camera2 API å®ç°è¿™äº›åŠŸèƒ½éœ€è¦æ›´å¤šçš„äººå·¥æ“ä½œã€‚ç°åœ¨ï¼ŒCameraX 1.5 ä¸­æ–°å¢çš„<a href="https://developer.android.com/reference/androidx/camera/video/HighSpeedVideoSessionConfig">é«˜é€Ÿ API</a>ç®€åŒ–äº†æ•´ä¸ªæµç¨‹ï¼Œè®©ä½ å¯ä»¥çµæ´»åœ°åˆ›å»ºçœŸæ­£çš„é«˜å¸§ç‡è§†é¢‘æˆ–å³ç”¨å‹æ…¢åŠ¨ä½œçŸ­ç‰‡ã€‚æœ¬æ–‡å°†å‘ä½ å±•ç¤ºå¦‚ä½•æŒæ¡è¿™ä¸¤ç§æ–¹æ³•ã€‚å¦‚æœä½ æ˜¯ CameraX æ–°æ‰‹ï¼Œå¯ä»¥å…ˆé˜…è¯»<a href="https://developer.android.com/media/camera/camerax">CameraX æ¦‚è¿°</a>å¿«é€Ÿä¸Šæ‰‹ã€‚</p>

<h2>æ…¢åŠ¨ä½œåŸç†</h2>

<p>æ…¢åŠ¨ä½œçš„åŸºæœ¬åŸç†æ˜¯ä»¥è¿œé«˜äºæ’­æ”¾å¸§ç‡çš„å¸§ç‡æ¥å½•åˆ¶è§†é¢‘ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä»¥æ¯ç§’ 120 å¸§ (fps) çš„å¸§ç‡å½•åˆ¶ä¸€ä¸ªä¸€ç§’é’Ÿçš„äº‹ä»¶ï¼Œç„¶åä»¥æ ‡å‡†çš„ 30 fps æ’­æ”¾è¯¥å½•åƒï¼Œåˆ™è§†é¢‘éœ€è¦å››ç§’é’Ÿæ‰èƒ½æ’­æ”¾å®Œæ¯•ã€‚è¿™ç§æ—¶é—´çš„â€œæ‹‰ä¼¸â€æ­£æ˜¯æ…¢åŠ¨ä½œæ•ˆæœçš„æ¥æºï¼Œè®©ä½ èƒ½å¤Ÿçœ‹åˆ°è‚‰çœ¼æ— æ³•æ•æ‰åˆ°çš„å¿«é€Ÿç»†èŠ‚ã€‚</p>

<p>ä¸ºç¡®ä¿æœ€ç»ˆè¾“å‡ºè§†é¢‘æµç•…è‡ªç„¶ï¼Œé€šå¸¸åº”ä»¥è‡³å°‘ 30 fps çš„å¸§ç‡è¿›è¡Œæ¸²æŸ“ã€‚è¿™æ„å‘³ç€ï¼Œè¦åˆ¶ä½œ 4 å€æ…¢åŠ¨ä½œè§†é¢‘ï¼ŒåŸå§‹æ‹æ‘„å¸§ç‡å¿…é¡»è‡³å°‘ä¸º 120 fpsï¼ˆ120 fps æ‹æ‘„å¸§ç‡ Ã· 4 = 30 fps æ’­æ”¾å¸§ç‡ï¼‰ã€‚</p>

<p>æ‹æ‘„é«˜å¸§ç‡ç´ æåï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥å®ç°æ‰€éœ€æ•ˆæœï¼š</p>

<ul>
<li><p>æ’­æ”¾å™¨æ§åˆ¶çš„æ…¢åŠ¨ä½œï¼ˆé«˜å¸§ç‡è§†é¢‘ï¼‰ï¼šé«˜é€Ÿå½•åˆ¶çš„è§†é¢‘ï¼ˆä¾‹å¦‚ 120 fpsï¼‰ç›´æ¥ä¿å­˜ä¸ºé«˜å¸§ç‡è§†é¢‘æ–‡ä»¶ã€‚ç„¶åï¼Œè§†é¢‘æ’­æ”¾å™¨è´Ÿè´£é™ä½æ’­æ”¾é€Ÿåº¦ã€‚è¿™æ ·ï¼Œç”¨æˆ·å¯ä»¥çµæ´»åœ°åœ¨æ­£å¸¸æ’­æ”¾å’Œæ…¢åŠ¨ä½œæ’­æ”¾ä¹‹é—´åˆ‡æ¢ã€‚</p></li>
<li><p>å³ç”¨å‹æ…¢åŠ¨ä½œï¼ˆé‡æ–°ç¼–ç çš„è§†é¢‘ï¼‰ï¼šé«˜é€Ÿè§†é¢‘æµç»è¿‡å¤„ç†å’Œé‡æ–°ç¼–ç ï¼Œç”Ÿæˆæ ‡å‡†å¸§ç‡ï¼ˆä¾‹å¦‚ 30 fpsï¼‰çš„æ–‡ä»¶ã€‚æ…¢åŠ¨ä½œæ•ˆæœæ˜¯é€šè¿‡è°ƒæ•´å¸§æ—¶é—´æˆ³â€œåµŒå…¥â€åˆ°è§†é¢‘ä¸­çš„ã€‚ç”Ÿæˆçš„è§†é¢‘æ— éœ€ç‰¹æ®Šå¤„ç†å³å¯åœ¨ä»»ä½•æ ‡å‡†è§†é¢‘æ’­æ”¾å™¨ä¸­ä»¥æ…¢åŠ¨ä½œæ’­æ”¾ã€‚è™½ç„¶è§†é¢‘é»˜è®¤ä»¥æ…¢åŠ¨ä½œæ’­æ”¾ï¼Œä½†è§†é¢‘æ’­æ”¾å™¨ä»ç„¶å¯ä»¥æä¾›æ’­æ”¾é€Ÿåº¦æ§åˆ¶ï¼Œå…è®¸ç”¨æˆ·åŠ å¿«æ’­æ”¾é€Ÿåº¦å¹¶ä»¥åŸå§‹é€Ÿåº¦è§‚çœ‹è§†é¢‘ã€‚</p></li>
</ul>


<p>CameraX API ç®€åŒ–äº†è¿™ä¸€è¿‡ç¨‹ï¼Œä¸ºä½ æä¾›äº†ä¸€ç§ç»Ÿä¸€çš„æ–¹å¼æ¥é€‰æ‹©æ‰€éœ€çš„æ’­æ”¾æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<h2>å…¨æ–°é«˜é€Ÿè§†é¢‘ API</h2>

<p>å…¨æ–°çš„ CameraX è§£å†³æ–¹æ¡ˆåŸºäºä¸¤ä¸ªä¸»è¦ç»„ä»¶ï¼š</p>

<ul>
<li><p><a href="https://developer.android.com/reference/kotlin/androidx/camera/video/Recorder#getHighSpeedVideoCapabilities(androidx.camera.core.CameraInfo)">Recorder#getHighSpeedVideoCapabilities(CameraInfo)</a>: æ­¤æ–¹æ³•ç”¨äºæ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦æ”¯æŒé«˜é€Ÿå½•åˆ¶ï¼Œå¦‚æœæ”¯æŒï¼Œåˆ™å¯æŸ¥çœ‹æ”¯æŒå“ªäº›åˆ†è¾¨ç‡ï¼ˆQuality å¯¹è±¡ï¼‰ã€‚</p></li>
<li><p><a href="https://developer.android.com/reference/androidx/camera/video/HighSpeedVideoSessionConfig">HighSpeedVideoSessionConfig</a>: è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é…ç½®å¯¹è±¡ï¼Œç”¨äºå°†ä½ çš„ VideoCapture å’Œ Preview ä½¿ç”¨åœºæ™¯åˆ†ç»„ï¼Œå¹¶æŒ‡ç¤º CameraX åˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„é«˜é€Ÿæ‘„åƒå¤´ä¼šè¯ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶ VideoCapture æµå°†ä»¥é…ç½®çš„é«˜å¸§ç‡è¿è¡Œï¼Œä½†ä¸ºäº†ç¡®ä¿å±å¹•æµç•…æ˜¾ç¤ºï¼Œé¢„è§ˆæµé€šå¸¸ä¼šè¢«æ‘„åƒå¤´ç³»ç»Ÿé™åˆ¶åœ¨è‡³å°‘ 30 FPS çš„æ ‡å‡†å¸§ç‡ã€‚</p></li>
</ul>


<h2>å…¥é—¨æŒ‡å—</h2>

<p>å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿å·²å°†å¿…è¦çš„ CameraX ä¾èµ–é¡¹æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„ build.gradle.kts æ–‡ä»¶ä¸­ã€‚ä½ éœ€è¦ camera-video ç»„ä»¶ä»¥åŠ CameraX æ ¸å¿ƒåº“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// build.gradle.kts (Module: app)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">camerax_version</span> <span class="p">=</span> <span class="s">&quot;1.5.1&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-core:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-camera2:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-lifecycle:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-video:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-view:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å…³äºå®éªŒæ€§ API çš„è¯´æ˜</h3>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé«˜é€Ÿå½•åˆ¶ API ç›®å‰å¤„äºå®éªŒé˜¶æ®µã€‚è¿™æ„å‘³ç€å®ƒä»¬åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚è¦ä½¿ç”¨å®ƒä»¬ï¼Œä½ å¿…é¡»é€šè¿‡åœ¨ä»£ç ä¸­æ·»åŠ ä»¥ä¸‹æ³¨é‡Šæ¥å¯ç”¨å®ƒä»¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@kotlin</span><span class="p">.</span><span class="n">OptIn</span><span class="p">(</span><span class="n">ExperimentalSessionConfig</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">ExperimentalHighSpeedVideo</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å…·ä½“å®ç°</h2>

<p>ä¸¤ç§ç»“æœçš„å®ç°éƒ½ä»ç›¸åŒçš„è®¾ç½®æ­¥éª¤å¼€å§‹ã€‚åˆ›å»ºé«˜å¸§ç‡è§†é¢‘è¿˜æ˜¯æ…¢åŠ¨ä½œè§†é¢‘çš„é€‰æ‹©å–å†³äºä¸€ä¸ªè®¾ç½®ã€‚</p>

<h3>1.è®¾ç½®é«˜é€Ÿæ‹æ‘„</h3>

<p>é¦–å…ˆï¼Œæ— è®ºä½ çš„ç›®æ ‡æ˜¯ä»€ä¹ˆï¼Œä½ éƒ½éœ€è¦è·å– <a href="https://developer.android.com/reference/androidx/camera/lifecycle/ProcessCameraProvider">ProcessCameraProvider</a>ï¼Œæ£€æŸ¥è®¾å¤‡åŠŸèƒ½ï¼Œå¹¶åˆ›å»ºä½ çš„ä½¿ç”¨åœºæ™¯ã€‚</p>

<p>ä»¥ä¸‹ä»£ç å—å±•ç¤ºäº†åœ¨æŒ‚èµ·å‡½æ•°ä¸­çš„å®Œæ•´è®¾ç½®æµç¨‹ã€‚ä½ å¯ä»¥ä»åç¨‹ä½œç”¨åŸŸè°ƒç”¨æ­¤å‡½æ•°ï¼Œä¾‹å¦‚ <code>lifecycleScope.launch</code>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Add the OptIn annotation at the top of your function or class</span>
</span><span class='line'>
</span><span class='line'><span class="n">@kotlin</span><span class="p">.</span><span class="n">OptIn</span><span class="p">(</span><span class="n">ExperimentalSessionConfig</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">ExperimentalHighSpeedVideo</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setupCamera</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Asynchronously get the CameraProvider</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">cameraProvider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// -- CHECK CAPABILITIES --</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">cameraInfo</span> <span class="p">=</span> <span class="n">cameraProvider</span><span class="p">.</span><span class="n">getCameraInfo</span><span class="p">(</span><span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">videoCapabilities</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">getHighSpeedVideoCapabilities</span><span class="p">(</span><span class="n">cameraInfo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">videoCapabilities</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// This camera device does not support high-speed video.</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// -- CREATE USE CASES --</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// You can create a Recorder with default settings.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// CameraX will automatically select a suitable quality.</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">recorder</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Alternatively, to use a specific resolution, you can configure the</span>
</span><span class='line'>    <span class="c1">// Recorder with a QualitySelector. This is useful if your app has</span>
</span><span class='line'>    <span class="c1">// specific resolution requirements or you want to offer user</span>
</span><span class='line'>    <span class="c1">// preferences. </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// To use a specific quality, you can uncomment the following lines.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get the list of qualities supported for high-speed video. </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// val supportedQualities = videoCapabilities.getSupportedQualities(DynamicRange.SDR)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Build the Recorder using the quality from the supported list.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// val recorderWithQuality = Recorder.Builder()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//     .setQualitySelector(QualitySelector.from(supportedQualities.first()))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//     .build()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create the VideoCapture use case, using either recorder or recorderWithQuality</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">videoCapture</span> <span class="p">=</span> <span class="n">VideoCapture</span><span class="p">.</span><span class="n">withOutput</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Now you are ready to configure the session for your desired output...</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. é€‰æ‹©è¾“å‡º</h3>

<p>ç°åœ¨ï¼Œä½ éœ€è¦å†³å®šè¦åˆ›å»ºå“ªç§ç±»å‹çš„è§†é¢‘ã€‚æ­¤ä»£ç å°†åœ¨ä¸Šé¢æ‰€ç¤ºçš„ <code>setupCamera()suspend</code> å‡½æ•°ä¸­è¿è¡Œã€‚</p>

<h4>é€‰é¡¹ Aï¼šåˆ›å»ºé«˜å¸§ç‡è§†é¢‘</h4>

<p>å¦‚æœä½ å¸Œæœ›æœ€ç»ˆæ–‡ä»¶å…·æœ‰é«˜å¸§ç‡ï¼ˆä¾‹å¦‚ï¼Œ120fps çš„è§†é¢‘ï¼‰ï¼Œè¯·é€‰æ‹©æ­¤é€‰é¡¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Create a builder for the high-speed session</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">sessionConfigBuilder</span> <span class="p">=</span> <span class="n">HighSpeedVideoSessionConfig</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">videoCapture</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">setPreview</span><span class="p">(</span><span class="n">preview</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query and apply a supported frame rate. Common supported frame rates include 120 and 240 fps.</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">supportedFrameRateRanges</span> <span class="p">=</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cameraInfo</span><span class="p">.</span><span class="n">getSupportedFrameRateRanges</span><span class="p">(</span><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setFrameRateRange</span><span class="p">(</span><span class="n">supportedFrameRateRanges</span><span class="p">.</span><span class="n">first</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<h4>é€‰é¡¹ Bï¼šåˆ›å»ºå¯ç›´æ¥æ’­æ”¾çš„æ…¢åŠ¨ä½œè§†é¢‘</h4>

<p>å¦‚æœä½ å¸Œæœ›è§†é¢‘åœ¨ä»»ä½•æ ‡å‡†è§†é¢‘æ’­æ”¾å™¨ä¸­è‡ªåŠ¨ä»¥æ…¢åŠ¨ä½œæ’­æ”¾ï¼Œè¯·é€‰æ‹©æ­¤é€‰é¡¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Create a builder for the high-speed session</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">sessionConfigBuilder</span> <span class="p">=</span> <span class="n">HighSpeedVideoSessionConfig</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">videoCapture</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">setPreview</span><span class="p">(</span><span class="n">preview</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// This is the key: enable automatic slow-motion!</span>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setSlowMotionEnabled</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query and apply a supported frame rate. Common supported frame rates include 120, 240, and 480 fps.</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">supportedFrameRateRanges</span> <span class="p">=</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">cameraInfo</span><span class="p">.</span><span class="n">getSupportedFrameRateRanges</span><span class="p">(</span><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setFrameRateRange</span><span class="p">(</span><span class="n">supportedFrameRateRanges</span><span class="p">.</span><span class="n">first</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸ªæ ‡å¿—ä½æ˜¯åˆ›å»ºå¯ç›´æ¥æ’­æ”¾çš„æ…¢åŠ¨ä½œè§†é¢‘çš„å…³é”®ã€‚å½“ <code>setSlowMotionEnabled</code> è®¾ç½®ä¸º true æ—¶ï¼ŒCameraX ä¼šå¤„ç†é«˜é€Ÿè§†é¢‘æµå¹¶å°†å…¶ä¿å­˜ä¸ºæ ‡å‡†çš„ 30 fps è§†é¢‘æ–‡ä»¶ã€‚æ…¢åŠ¨ä½œæ’­æ”¾é€Ÿåº¦ç”±æ‹æ‘„å¸§é€Ÿç‡ä¸æ ‡å‡†æ’­æ”¾é€Ÿç‡çš„æ¯”å€¼å†³å®šã€‚</p>

<p>ä¾‹å¦‚ï¼š</p>

<ul>
<li><p>ä»¥ 120 fps å½•åˆ¶çš„è§†é¢‘å°†ä»¥ &frac14; å€é€Ÿæ’­æ”¾ (120 Ã· 30 = 4)ã€‚</p></li>
<li><p>ä»¥ 240 fps å½•åˆ¶çš„è§†é¢‘å°†ä»¥ 1/8 å€é€Ÿæ’­æ”¾ (240 Ã· 30 = 8)ã€‚</p></li>
</ul>


<h2>æ•´åˆæ‰€æœ‰æ­¥éª¤ï¼šå½•åˆ¶è§†é¢‘</h2>

<p>é…ç½®å¥½ HighSpeedVideoSessionConfig å¹¶å°†å…¶ç»‘å®šåˆ°ç”Ÿå‘½å‘¨æœŸåï¼Œæœ€åä¸€æ­¥å°±æ˜¯å¼€å§‹å½•åˆ¶ã€‚å‡†å¤‡è¾“å‡ºé€‰é¡¹ã€å¼€å§‹å½•åˆ¶å’Œå¤„ç†è§†é¢‘äº‹ä»¶çš„è¿‡ç¨‹ä¸æ ‡å‡†è§†é¢‘æ•è·ç›¸åŒã€‚</p>

<p>æœ¬æ–‡é‡ç‚¹ä»‹ç»é«˜é€Ÿé…ç½®ï¼Œå› æ­¤ä¸ä¼šè¯¦ç»†ä»‹ç»å½•åˆ¶è¿‡ç¨‹ã€‚å¦‚éœ€äº†è§£ä»å‡†å¤‡ FileOutputOptions æˆ– MediaStoreOutputOptions å¯¹è±¡åˆ°å¤„ç† VideoRecordEvent å›è°ƒçš„å®Œæ•´æŒ‡å—ï¼Œè¯·å‚é˜…<a href="https://developer.android.com/media/camera/camerax/video-capture#videocapture-api-overview">VideoCapture æ–‡æ¡£</a>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Bind the session config to the lifecycle</span>
</span><span class='line'>
</span><span class='line'><span class="n">cameraProvider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span> <span class="k">as</span> <span class="n">LifecycleOwner</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span> <span class="c1">// Bind the config object from Option A or B</span>
</span><span class='line'>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the recording using the VideoCapture use case</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">recording</span> <span class="p">=</span> <span class="n">videoCapture</span><span class="p">.</span><span class="n">output</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">prepareRecording</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">outputOptions</span><span class="p">)</span> <span class="c1">// See docs for creating outputOptions</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span> <span class="n">recordEvent</span> <span class="p">-&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Handle recording events (e.g., Start, Pause, Finalize)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Google Photos å¯¹æ…¢åŠ¨ä½œè§†é¢‘çš„æ”¯æŒ</h2>

<p>åœ¨ CameraX ä¸­å¯ç”¨ setSlowMotionEnabled(true) åï¼Œç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶å°†è¢«è®¾è®¡ä¸ºå¯åœ¨æ ‡å‡†è§†é¢‘æ’­æ”¾å™¨å’Œå›¾åº“åº”ç”¨ä¸­ç«‹å³è¯†åˆ«å¹¶æ’­æ”¾ä¸ºæ…¢åŠ¨ä½œè§†é¢‘ã€‚è°·æ­Œç›¸å†Œå°¤å…¶é’ˆå¯¹æ…¢åŠ¨ä½œè§†é¢‘æä¾›äº†å¢å¼ºåŠŸèƒ½ï¼Œå½“æ‹æ‘„å¸§é€Ÿç‡ä¸º 120ã€240ã€360ã€480 æˆ– 960fps æ—¶ï¼ŒåŠŸèƒ½æ›´åŠ å®Œå–„ï¼š</p>

<ul>
<li>ç¼©ç•¥å›¾ä¸­çš„ç‹¬ç‰¹ UI è¯†åˆ«ï¼šåœ¨è°·æ­Œç›¸å†Œä¸­ï¼Œæ…¢åŠ¨ä½œè§†é¢‘ä¼šé€šè¿‡ç‰¹å®šçš„ UI å…ƒç´ è¿›è¡Œè¯†åˆ«ï¼Œä»è€Œä¸æ™®é€šè§†é¢‘åŒºåˆ†å¼€æ¥ã€‚</li>
</ul>


<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEjPLQRSSF3hvj89T9DvO92-JNi_rjtUXQ-i76ZuyX4GHv4KitBFPVP5oHdqxICQJUf3l7HaOQeI0skgVK9bPM0qz7GToNYiIMszVYj6IsE4-wGa4jqZfYka03TTlFwUTDdYq56unwoIwv1fTnJrNpWIZ-5Iybgk-hFHlvcy08Bkm8xM0adbvYjqVxH12xc" alt="æ™®é€šè§†é¢‘ç¼©ç•¥å›¾" /></p>

<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEiDmd0jikxU58PkjrGG1K181pYs-G-drnrNG_q_mQqVJWkK4NdbuwDSB4jCbQzGAgYeyikORVsPT3pyQp_VCfw_7rNDzafFudhj0x56-bqNZc6mQuRktDCa7ycSx2-qsIJsCCTiQXmxxrtImiBOFwlTz3ufBtbGDsonZvqzSQqWbNugNt-bbDVvyQz7Hw8" alt="æ…¢åŠ¨ä½œè§†é¢‘ç¼©ç•¥å›¾" /></p>

<ul>
<li>æ’­æ”¾æ—¶å¯è°ƒæ•´é€Ÿåº¦ï¼šæ’­æ”¾æ…¢åŠ¨ä½œè§†é¢‘æ—¶ï¼ŒGoogle Photos æä¾›æ§åˆ¶é€‰é¡¹ï¼Œå…è®¸ç”¨æˆ·è°ƒæ•´è§†é¢‘ä¸­å“ªäº›éƒ¨åˆ†ä»¥æ…¢é€Ÿæ’­æ”¾ï¼Œå“ªäº›éƒ¨åˆ†ä»¥æ­£å¸¸é€Ÿåº¦æ’­æ”¾ï¼Œä»è€Œèµ‹äºˆç”¨æˆ·æ›´å¤§çš„åˆ›ä½œè‡ªç”±ã€‚ç¼–è¾‘åçš„è§†é¢‘å¯ä»¥ä½¿ç”¨â€œåˆ†äº«â€æŒ‰é’®å¯¼å‡ºä¸ºæ–°çš„è§†é¢‘æ–‡ä»¶ï¼ŒåŒæ—¶ä¿ç•™ä½ å®šä¹‰çš„æ…¢åŠ¨ä½œç‰‡æ®µã€‚</li>
</ul>


<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEj-dp-bHPORhk_l0I4zkSEdzYUNRYvRwb2boA4KKgd1s4Sr1D61iAV2rWUD6dOdVezRn10qIGtMLae4brWI8RxlP9wFz18gsrZu4qOdAydWnhqgpmmsuLcHAMfo5Rv6XZIxtTCC5dSJeIJERbOKmPZyUXTOdweJ6EjQett5iOVl4yJzaLYR7rrHXz0WnAI" alt="æ­£å¸¸è§†é¢‘æ’­æ”¾" /></p>

<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEi4AaVc78zpZzsG-hgOsuPdAqwCuSD6bb1b6de366Agvy2c3OG5qJ5mSPg94GA8GjR-LXDU4H7zBCoI_Pe3SxrfdDPiTyPmimTRM49IcTkGovC2mccTu0GnwcSyVAL5iW7qnNlWHGCoGHU9EeX3-8bZiSsmLWr6Ljf5KfJjInUuCEODrqF-g8Je3iLvEF4" alt="æ…¢åŠ¨ä½œè§†é¢‘æ’­æ”¾ï¼ˆå¸¦ç¼–è¾‘æ§åˆ¶ï¼‰" /></p>

<h2>å…³äºè®¾å¤‡æ”¯æŒçš„è¯´æ˜</h2>

<p>CameraX çš„é«˜é€Ÿ API ä¾èµ–äºåº•å±‚ Android çš„ <a href="https://developer.android.com/reference/android/media/CamcorderProfile">CamcorderProfile</a> ç³»ç»Ÿæ¥ç¡®å®šè®¾å¤‡æ”¯æŒçš„é«˜é€Ÿåˆ†è¾¨ç‡å’Œå¸§é€Ÿç‡ã€‚CamcorderProfile ç»è¿‡ <a href="https://source.android.com/docs/compatibility/cts">Android å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶ (CTS)</a> çš„éªŒè¯ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥ä¿¡èµ–è®¾å¤‡æ‰€æŠ¥å‘Šçš„è§†é¢‘å½•åˆ¶åŠŸèƒ½ã€‚</p>

<p>è¿™æ„å‘³ç€ï¼Œè®¾å¤‡å†…ç½®ç›¸æœºåº”ç”¨èƒ½å¤Ÿå½•åˆ¶æ…¢åŠ¨ä½œè§†é¢‘å¹¶ä¸èƒ½ä¿è¯ CameraX é«˜é€Ÿ API èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚å‡ºç°è¿™ç§å·®å¼‚çš„åŸå› æ˜¯ï¼Œè®¾å¤‡åˆ¶é€ å•†è´Ÿè´£åœ¨å…¶è®¾å¤‡å›ºä»¶ä¸­å¡«å…… CamcorderProfile æ¡ç›®ï¼Œè€Œæœ‰æ—¶å¿…è¦çš„é«˜é€Ÿé…ç½®æ–‡ä»¶ï¼ˆä¾‹å¦‚ CamcorderProfile.QUALITY_HIGH_SPEED_1080P å’Œ CamcorderProfile.QUALITY_HIGH_SPEED_720Pï¼‰å¯èƒ½å¹¶æœªåŒ…å«åœ¨å†…ã€‚å½“ç¼ºå°‘è¿™äº›é…ç½®æ–‡ä»¶æ—¶ï¼Œ<code>Recorder.getHighSpeedVideoCapabilities()</code> å°†è¿”å› nullã€‚</p>

<p>å› æ­¤ï¼ŒåŠ¡å¿…å§‹ç»ˆä½¿ç”¨ <code>Recorder.getHighSpeedVideoCapabilities()</code> ä»¥ç¼–ç¨‹æ–¹å¼æ£€æŸ¥æ”¯æŒçš„åŠŸèƒ½ï¼Œå› ä¸ºè¿™æ˜¯ç¡®ä¿åœ¨ä¸åŒè®¾å¤‡ä¸Šè·å¾—ä¸€è‡´ä½“éªŒçš„æœ€å¯é æ–¹æ³•ã€‚å¦‚æœå°è¯•åœ¨ <code>Recorder.getHighSpeedVideoCapabilities()</code> è¿”å› null çš„è®¾å¤‡ä¸Šç»‘å®š <code>HighSpeedVideoSessionConfig</code>ï¼Œåˆ™æ“ä½œå°†å¤±è´¥å¹¶æŠ›å‡º <code>IllegalArgumentException</code> å¼‚å¸¸ã€‚ä½ å¯ä»¥åœ¨ Google Pixel è®¾å¤‡ä¸Šç¡®è®¤æ”¯æŒï¼Œå› ä¸ºå®ƒä»¬å§‹ç»ˆåŒ…å«è¿™äº›é«˜é€Ÿé…ç½®æ–‡ä»¶ã€‚æ­¤å¤–ï¼Œå…¶ä»–åˆ¶é€ å•†çš„å„ç§è®¾å¤‡ï¼Œä¾‹å¦‚ Motorola Edge 30ã€OPPO Find N2 Flip å’Œ Sony Xperia 1 Vï¼Œä¹Ÿæ”¯æŒé«˜é€Ÿè§†é¢‘åŠŸèƒ½ã€‚</p>

<h2>ç»“è®º</h2>

<p>CameraX é«˜é€Ÿè§†é¢‘ API åŠŸèƒ½å¼ºå¤§ä¸”çµæ´»ã€‚æ— è®ºä½ æ˜¯éœ€è¦ç”¨äºæŠ€æœ¯åˆ†æçš„çœŸæ­£é«˜å¸§ç‡è§†é¢‘ç´ æï¼Œè¿˜æ˜¯æƒ³ä¸ºä½ çš„åº”ç”¨æ·»åŠ ç”µå½±çº§çš„æ…¢åŠ¨ä½œæ•ˆæœï¼ŒHighSpeedVideoSessionConfig éƒ½èƒ½æä¾›ç»Ÿä¸€ä¸”ç®€ä¾¿çš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡äº†è§£ setSlowMotionEnabled æ ‡å¿—çš„ä½œç”¨ï¼Œä½ å¯ä»¥è½»æ¾æ”¯æŒè¿™ä¸¤ç§ä½¿ç”¨åœºæ™¯ï¼Œå¹¶èµ‹äºˆç”¨æˆ·æ›´å¤§çš„åˆ›ä½œè‡ªç”±ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compose CameraXç°å·²ç¨³å®šï¼šç»™Composerçš„ç«¯åˆ°ç«¯æŒ‡å—]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable/"/>
    <updated>2025-11-02T14:10:34+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCompose-Native CameraX Is Now Stable: End-to-End Guide for Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/goodbye-androidview-camerax-goes-full-compose-4d21ca234c4e">https://proandroiddev.com/goodbye-androidview-camerax-goes-full-compose-4d21ca234c4e</a>ï¼Œç”±Ioannis Anifantakiså‘å¸ƒäº20251026ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*sizZteIZmrzNr4X1BeXcJg.png" title="auto auto" ></a></p>

<!-- more -->


<h2>ç®€ä»‹</h2>

<p>è¿˜è®°å¾—ä½ åœ¨ Jetpack Compose ä¸­çš„ç¬¬ä¸€ä¸ªç›¸æœºé¡µé¢å—ï¼Ÿçº¯ç²¹çš„å£°æ˜å¼ä¹è¶£â€¦â€¦ç›´åˆ°é¢„è§ˆã€‚ç„¶åæ˜¯ç†Ÿæ‚‰çš„ <code>AndroidView(PreviewView)</code> ç»•é“ã€‚å®ƒç¡®å®æœ‰æ•ˆï¼Œä½†æ€»æ„Ÿè§‰ä¸å¯¹ï¼šcomposablesä¸­é—´æœ‰ä¸€ä¸ª View å½¢çŠ¶çš„ç©ºæ´ï¼ˆç±»ä¼¼äº <code>_iFrame_</code>_ â€¦â€¦ï¼‰ï¼Œè€Œä¸”ç‚¹å‡»å¯¹ç„¦çš„æ•°å­¦è®¡ç®—æ€»æ˜¯è®©äººæ„Ÿè§‰ä¸å¤ªå¯é ã€‚</p>

<p>åœ¨ I/O 25 ä¹‹åï¼Œè¿™ç§å¦¥åå·²ç»ç»“æŸã€‚</p>

<ul>
<li><strong>ä¸å†</strong> ä½¿ç”¨ <code>**AndroidView(PreviewView)**</code> è¿›è¡Œç›¸æœºé¢„è§ˆã€‚</li>
<li><strong>æ–°å¢</strong> <code>**CameraXViewfinder**</code> å¯ç»„åˆé¡¹ï¼Œå¯åœ¨ Compose ä¸­ç›´æ¥æ¸²æŸ“ CameraX <code>SurfaceRequest</code>ã€‚</li>
<li><strong>ä¿®æ­£äº†å†…ç½®åæ ‡å˜æ¢</strong>ï¼ˆç‚¹å‡»å¯¹ç„¦ã€å åŠ å±‚ï¼‰ï¼Œå¹¶å»ºç«‹äº†æ›´ç®€æ´ã€æ›´å…·å£°æ˜æ€§çš„å¿ƒæ™ºæ¨¡å‹ã€‚</li>
</ul>


<blockquote><p><strong><em>æ³¨æ„ï¼š</em></strong></p>

<p><em>â€œ</em>åœ¨ I/O 25 å¤§ä¼šä¸Šï¼ŒCompose æ”¯æŒå·²å‘å¸ƒ <strong>alpha/beta</strong> ç‰ˆæœ¬ï¼Œç¨³å®šç‰ˆå·²äº 9 æœˆå‘å¸ƒâ€”â€”ç°åœ¨æ˜¯æ—¶å€™äº†è§£ä¸€ä¸‹äº†ã€‚â€_</p></blockquote>

<h2>é…å¥—é¡¹ç›®</h2>

<p>ä½ å¯ä»¥åœ¨ <a href="https://github.com/ioannisa/CameraX-Composable-Demo/"><strong>GitHub ä¸Šçš„é…å¥—é¡¹ç›®</strong></a> æ‰¾åˆ°æœ¬æ–‡çš„é…å¥—é¡¹ç›®ï¼Œè¯¥é¡¹ç›®æ¼”ç¤ºäº† CameraX ä¸­ Jetpack Compose çš„æ–°åŠŸèƒ½ã€‚</p>

<h3>æƒé™ç”¨æˆ·ä½“éªŒï¼ˆç®€è¦è¯´æ˜ï¼‰</h3>

<p>æœ¬æ–‡å°†é‡ç‚¹ä»‹ç» Compose + CameraX çš„åŠŸèƒ½ã€‚<strong>é…å¥—é¡¹ç›®</strong> å®ç°äº†å®Œæ•´çš„è¿è¡Œæ—¶æµç¨‹ï¼š</p>

<ul>
<li>åœ¨é¢„è§ˆå…¥å£ç‚¹è¯·æ±‚ <code>**CAMERA**</code>ã€‚</li>
<li>ä»…åœ¨ç”¨æˆ·å¼€å§‹å½•åˆ¶æ—¶ï¼ˆæŒ‰éœ€éº¦å…‹é£ï¼‰è¯·æ±‚ <code>**RECORD_AUDIO**</code>ã€‚</li>
<li>ä¸€ä¸ªå°å‹çš„ <code>PermissionGate</code> å¯ç»„åˆå‡½æ•°è´Ÿè´£å¤„ç† Compose æ ‘ä¸­çš„æˆæƒ/æ‹’ç»/é‡æ–°è¯·æ±‚ã€‚</li>
<li>ä¸ºäº†æ»¡è¶³ Lint å¯¹ <code>@RequiresPermission</code> çš„è¦æ±‚ï¼Œè°ƒç”¨ç‚¹è¿˜ä¼šåœ¨è°ƒç”¨ä¸éº¦å…‹é£ç›¸å…³çš„ API ä¹‹å‰æ‰§è¡Œæ˜¾å¼ <code>checkSelfPermission(...)</code>ã€‚</li>
</ul>


<p>è¯·å‚é˜…ä»£ç åº“ï¼Œäº†è§£å…·ä½“çš„ <code>PermissionGate</code> ä»¥åŠæˆ‘ä»¬å¦‚ä½•å°†å…¶è¿æ¥åˆ° Capture é¡µé¢ã€‚</p>

<h2>å®é™…å˜åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ</h2>

<p>CameraX å›¢é˜Ÿæ”¾å¼ƒäº† <code>androidx.camera:camera-compose</code>ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯çœ‹ä¼¼ç®€å•çš„ APIï¼š<code>**CameraXViewfinder**</code>ã€‚ä½†è¿™ä¸ä»…ä»…æ˜¯â€œå°† <code>PreviewView</code> å°è£…åœ¨å¯ç»„åˆé¡¹ä¸­â€ã€‚è¿™æ˜¯å¯¹ Compose çš„å½»åº•é‡å†™ï¼Œä¹Ÿæ˜¯å¯¹ç›¸æœº Surface ä¸ Compose é›†æˆæ–¹å¼çš„æ ¹æœ¬æ€§é‡æ–°æ€è€ƒã€‚</p>

<p>ä»¥ä¸‹æ˜¯æ¶æ„å±‚é¢çš„å˜åŒ–ï¼š</p>

<p><strong>Compose ç›®æ ‡ä¼˜å…ˆ</strong>
å–æ™¯å™¨æ¸²æŸ“ç®¡é“ç°åœ¨å°† Compose è§†ä¸ºä¸»è¦å¹³å°ã€‚Surface ç”Ÿå‘½å‘¨æœŸã€æ—‹è½¬å¤„ç†å’Œç¼©æ”¾éƒ½ä»¥ Compose æƒ¯ç”¨çš„æ–¹å¼è¿›è¡Œã€‚</p>

<p><strong>å¼€ç®±å³ç”¨çš„æ­£ç¡®åæ ‡å˜æ¢</strong>
è¿˜è®°å¾—è®¡ç®—é¢„è§ˆä¸­çš„ç‚¹å‡»å®é™…æ˜ å°„åˆ°ç›¸æœºä¼ æ„Ÿå™¨çš„ä½ç½®ï¼Œå¹¶è€ƒè™‘æ—‹è½¬ã€å®½é«˜æ¯”è£å‰ªå’Œç¼©æ”¾æ¨¡å¼å—ï¼Ÿ<code>MutableCoordinateTransformer</code> å¯ä»¥å¤„ç†è¿™äº›ã€‚ç‚¹å‡»å¯¹ç„¦ç°åœ¨â€¦â€¦å¯ä»¥æ­£å¸¸å·¥ä½œäº†ã€‚</p>

<p><strong>çœŸæ­£çš„å¯ç»„åˆè¯­ä¹‰</strong>
æƒ³è¦å°†é¢„è§ˆ <code>clip()</code> è½¬æ¢ä¸ºè‡ªå®šä¹‰å½¢çŠ¶ï¼Ÿåº”ç”¨ <code>graphicsLayer</code> å˜æ¢ï¼Ÿä½¿ç”¨ <code>AnimatedContent</code> ä¸ºå…¶æ·»åŠ åŠ¨ç”»æ•ˆæœï¼Ÿç°åœ¨ï¼Œä½ å¯ä»¥è½»æ¾å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œï¼Œè€Œæ— éœ€ä¸æ¸²æŸ“å™¨å†²çªã€‚å®ƒä¸å…¶ä»–å¯ç»„åˆç»„ä»¶ä¸€æ ·ã€‚</p>

<p><strong>CameraX 1.5.x æˆç†Ÿåº¦</strong>
æ•´ä¸ªæŠ€æœ¯æ ˆéƒ½å¾—åˆ°äº†å®Œå–„ï¼šé€‚ç”¨äº Kotlin åç¨‹çš„ <code>ProcessCameraProvider.awaitInstance()</code>ã€å…¨é¢ç¨³å®šçš„æ„ä»¶ä»¥åŠæ›´å®Œå–„çš„æ–‡æ¡£ã€‚è¿™å¹¶é Beta æµ‹è¯•â€¦â€¦å®ƒå·²å‡†å¤‡å¥½æŠ•å…¥ç”Ÿäº§ã€‚</p>

<h2>ä¸ºä»€ä¹ˆè¿™çœŸçš„å¾ˆé‡è¦</h2>

<p>å¦‚æœä½ ä¸€ç›´åœ¨æ„å»ºç›¸æœºåŠŸèƒ½ï¼Œ<strong>ä½ å°±ä¼šçŸ¥é“å…¶ä¸­çš„ç—›ç‚¹</strong>ï¼š</p>

<ul>
<li><strong>å¿ƒæ™ºæ¨¡å‹åˆ†è£‚</strong>ï¼šâ€œç”¨ Compose æ€è€ƒ UIï¼Œç”¨ View æ€è€ƒç›¸æœºï¼Œå¹¶åœ¨ä¸¤è€…ä¹‹é—´ä¸æ–­è½¬æ¢ã€‚â€</li>
<li><strong>æ‰‹åŠ¿åè°ƒçš„å™©æ¢¦</strong>ï¼šåœ¨ Compose ä¸­å¤„ç†è§¦æ‘¸äº‹ä»¶ï¼Œåœ¨ View åæ ‡ç³»ä¸­æµ‹å…‰å¯¹ç„¦ï¼Œç¥ˆç¥·ä½ çš„è®¡ç®—å‡†ç¡®æ— è¯¯ã€‚</li>
<li><strong>Z è½´é¡ºåºéš¾é¢˜</strong>ï¼šâ€œPreviewViewâ€ ç»å¸¸ä½¿ç”¨åœ¨å•ç‹¬å›¾å±‚ä¸­æ¸²æŸ“çš„â€œSurfaceViewâ€ã€‚Compose å åŠ å±‚æ— æ³•å¯é åœ°ä½äºé¡¶éƒ¨ï¼Œå› æ­¤åå­—çº¿ã€å‚è€ƒçº¿å’ŒæŒ‰é’®å¯èƒ½ä¼šæ¶ˆå¤±åœ¨é¢„è§ˆå±‚åé¢ã€‚</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸä¹‹èˆ</strong>ï¼šä½¿ç”¨ CameraX ç”¨ä¾‹ç»‘å®šå°† Compose é‡ç»„ä¸ View ç”Ÿå‘½å‘¨æœŸåŒæ­¥</li>
</ul>


<p>æ‰€æœ‰è¿™äº›æ‘©æ“¦ï¼Ÿéƒ½æ¶ˆå¤±äº†ã€‚</p>

<blockquote><p><strong>â€œç°åœ¨ï¼Œä½ å¯ä»¥åƒç¼–å†™å…¶ä»–ç°ä»£ Android åº”ç”¨ä¸€æ ·ç¼–å†™ç›¸æœº UIã€‚ä¸€ä¸ªèŒƒä¾‹ã€‚ä¸€ä¸ªå¿ƒæ™ºæ¨¡å‹ã€‚çº¯ç²¹çš„ Composeã€‚â€</strong></p></blockquote>

<h2>ä»£ç æ¼”ç¤º</h2>

<p>è®©æˆ‘ä»¬ä»æœ€åŸºæœ¬çš„å¼€å§‹â€”â€”ä¸€ä¸ªå¯ä»¥å·¥ä½œçš„ç›¸æœºé¢„è§ˆï¼ˆå›ºå®šçŠ¶æ€æ¨¡å¼ï¼šå°†<strong>å†™å…¥å™¨</strong> <code>MutableStateFlow</code> ä¸<strong>è¯»å–å™¨</strong> <code>collectAsState</code> åˆ†ç¦»ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CameraPreview</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Writer: MutableStateFlow we can update from CameraX callbacks</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Reader: Compose state derived from the flow</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind CameraX use cases once</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// When CameraX needs a surface, publish it to Compose</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">request</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The actual Compose viewfinder</span>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å°±æ˜¯è¿™æ ·ã€‚æ²¡æœ‰ <code>AndroidView</code>ã€‚æ²¡æœ‰ <code>PreviewView</code>ã€‚åªæœ‰ä¸€ä¸ªå¯ç»„åˆç»„ä»¶ï¼Œå®ƒæ¥æ”¶ <code>SurfaceRequest</code> å¹¶è¿›è¡Œæ¸²æŸ“ã€‚</p>

<blockquote><p><strong><em>æ¨¡å¼å¾ˆç®€æ´ï¼šâ€œ</em></strong>CameraX å‘å¸ƒ Surface è¯·æ±‚ï¼ŒCompose å¤„ç†å®ƒä»¬ã€‚å•å‘ã€‚æ²¡æœ‰å›è°ƒåœ¨å„ä¸ªä¸–ç•Œä¹‹é—´æ¥å›åˆ‡æ¢ã€‚â€</p></blockquote>

<h3>å¯é€‰ï¼šä½¿ç”¨é•œå¤´åˆ‡æ¢æŒ‰é’®ï¼ˆFABï¼‰è¿›è¡Œé¢„è§ˆï¼ˆå‰/åï¼‰</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PreviewWithLensSwitch</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// remember current lens</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">useFront</span> <span class="k">by</span> <span class="n">rememberSaveable</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">selector</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">useFront</span><span class="p">)</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_FRONT_CAMERA</span> <span class="k">else</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// bind when camera selector changes (front/back camera)</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">CameraXViewfinder</span><span class="p">(</span><span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">req</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">FloatingActionButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">useFront</span> <span class="p">=</span> <span class="p">!</span><span class="n">useFront</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomEnd</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Rounded</span><span class="p">.</span><span class="n">Cameraswitch</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Switch camera&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>çœŸæ­£çš„è€ƒéªŒï¼šäº¤äº’å¼ç›¸æœºæ§ä»¶</h2>

<p>æ—§æ–¹æ³•çš„å¤±è´¥ä¹‹å¤„å°±åœ¨è¿™é‡Œã€‚è®©æˆ‘ä»¬å®ç°ç‚¹å‡»å¯¹ç„¦å’Œæåˆç¼©æ”¾â€¦â€¦è¿™äº›åŠŸèƒ½è¿‡å»éœ€è¦å¯¹è§†å›¾åæ ‡ç³»è¿›è¡Œä¸€äº› hackï¼ˆåŒæ ·ä½¿ç”¨å›ºå®šçš„å†™å…¥/è¯»å–æ¨¡å¼ï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">InteractiveCameraPreview</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">onFocusTap</span><span class="p">:</span> <span class="p">(</span><span class="n">success</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{})</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">camera</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind camera once</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">camera</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Coordinate transformer: Compose UI â†’ Camera surface</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">coordinateTransformer</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableCoordinateTransformer</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>            <span class="n">coordinateTransformer</span> <span class="p">=</span> <span class="n">coordinateTransformer</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Tap-to-focus</span>
</span><span class='line'>                    <span class="n">detectTapGestures</span> <span class="p">{</span> <span class="n">offset</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">cam</span> <span class="p">=</span> <span class="n">camera</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTapGestures</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c1">// Transform Compose coordinates to camera surface</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">surfacePoint</span> <span class="p">=</span> <span class="n">with</span><span class="p">(</span><span class="n">coordinateTransformer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">offset</span><span class="p">.</span><span class="n">transform</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">meteringFactory</span> <span class="p">=</span> <span class="n">SurfaceOrientedMeteringPointFactory</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">request</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">request</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">focusPoint</span> <span class="p">=</span> <span class="n">meteringFactory</span><span class="p">.</span><span class="n">createPoint</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">surfacePoint</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">surfacePoint</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">action</span> <span class="p">=</span> <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">focusPoint</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">FLAG_AF</span> <span class="n">or</span> <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">FLAG_AE</span>
</span><span class='line'>                        <span class="p">).</span><span class="n">setAutoCancelDuration</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">cam</span><span class="p">.</span><span class="n">cameraControl</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">startFocusAndMetering</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">addListener</span><span class="p">(</span>
</span><span class='line'>                                <span class="p">{</span> <span class="n">onFocusTap</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>                                <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Pinch-to-zoom</span>
</span><span class='line'>                    <span class="n">detectTransformGestures</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">cam</span> <span class="p">=</span> <span class="n">camera</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTransformGestures</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">zoomState</span> <span class="p">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraInfo</span><span class="p">.</span><span class="n">zoomState</span><span class="p">.</span><span class="n">value</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTransformGestures</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">newRatio</span> <span class="p">=</span> <span class="p">(</span><span class="n">zoomState</span><span class="p">.</span><span class="n">zoomRatio</span> <span class="p">*</span> <span class="n">zoom</span><span class="p">).</span><span class="n">coerceIn</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">zoomState</span><span class="p">.</span><span class="n">minZoomRatio</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">zoomState</span><span class="p">.</span><span class="n">maxZoomRatio</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">cam</span><span class="p">.</span><span class="n">cameraControl</span><span class="p">.</span><span class="n">setZoomRatio</span><span class="p">(</span><span class="n">newRatio</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>çœ‹çœ‹è¿™ä¸ªç‚¹å‡»å¯¹ç„¦çš„å®ç°ã€‚æ³¨æ„ä½ <strong>æ²¡æœ‰</strong>åšçš„äº‹æƒ…ï¼š</p>

<ul>
<li>æ— éœ€æ‰‹åŠ¨æ—‹è½¬è¡¥å¿</li>
<li>æ— éœ€è¿›è¡Œåæ ‡æ˜ å°„çš„å®½é«˜æ¯”è®¡ç®—</li>
<li>æ— éœ€è¿›è¡Œè§†å›¾ â†’ è¡¨é¢ â†’ ä¼ æ„Ÿå™¨åæ ‡é“¾è®¡ç®—</li>
<li>æ— éœ€è¿›è¡Œâ€œç¥ˆç¥·å®ƒåœ¨æ¨ªå‘æ¨¡å¼ä¸‹èƒ½æ­£å¸¸å·¥ä½œâ€çš„æ¼«é•¿æµ‹è¯•</li>
</ul>


<p><code>MutableCoordinateTransformer</code> å¯ä»¥å¤„ç†æ‰€æœ‰è¿™äº›ã€‚ä½ ç‚¹å‡» Compose åæ ‡ç³»ï¼Œå®ƒä¼šè½¬æ¢ä¸ºç›¸æœºåæ ‡ç³»ï¼Œå°±å®Œæˆäº†ã€‚</p>

<p>è¿™å°±æ˜¯â€œæŠ€æœ¯ä¸Šå¯è¡Œâ€å’Œâ€œå®é™…æ˜“äºå®ç°â€ä¹‹é—´çš„åŒºåˆ«ã€‚</p>

<h2>æ‹æ‘„ç…§ç‰‡å’Œè§†é¢‘</h2>

<p>æ·»åŠ æ‹æ‘„åŠŸèƒ½éµå¾ªç›¸åŒçš„ç®€æ´æ¨¡å¼â€”â€”ç»‘å®šå…¶ä»–ç”¨ä¾‹ï¼Œå¹¶ä» Compose ç•Œé¢è§¦å‘å®ƒä»¬ã€‚</p>

<p>æˆ‘ä»¬è¿˜å°†ä»…åœ¨å°è¯•å½•åˆ¶æ—¶è¯·æ±‚<strong>éº¦å…‹é£</strong>ï¼Œå¹¶ä½¿ç”¨ç®€å•çš„â€œPermissionGateâ€æ¨¡å¼ï¼ˆä¸æˆ‘ä»¬é¡¹ç›®åœ¨éœ€è¦æ—¶ä»…è¯·æ±‚éŸ³é¢‘çš„æ–¹æ³•ä¸€è‡´ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CameraScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">camera</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">imageCapture</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">ImageCapture</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">videoCapture</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">VideoCapture</span><span class="p">&lt;</span><span class="n">Recorder</span><span class="p">&gt;?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">activeRecording</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Recording</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind all use cases</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">imageCapture</span> <span class="p">=</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">setCaptureMode</span><span class="p">(</span><span class="n">ImageCapture</span><span class="p">.</span><span class="n">CAPTURE_MODE_MINIMIZE_LATENCY</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">recorder</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">setQualitySelector</span><span class="p">(</span><span class="n">QualitySelector</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">Quality</span><span class="p">.</span><span class="n">FHD</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="n">videoCapture</span> <span class="p">=</span> <span class="n">VideoCapture</span><span class="p">.</span><span class="n">withOutput</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">camera</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span><span class="p">,</span>
</span><span class='line'>            <span class="n">imageCapture</span><span class="o">!!</span><span class="p">,</span>
</span><span class='line'>            <span class="n">videoCapture</span><span class="o">!!</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Camera preview</span>
</span><span class='line'>        <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Compose UI controls</span>
</span><span class='line'>        <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomCenter</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">bottom</span> <span class="p">=</span> <span class="m">32.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Capture photo button</span>
</span><span class='line'>            <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>                <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">capturePhoto</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">imageCapture</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">PhotoCamera</span><span class="p">,</span> <span class="s">&quot;Take Photo&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Video record toggle (mic requested only when needed)</span>
</span><span class='line'>            <span class="n">PermissionGate</span><span class="p">(</span>
</span><span class='line'>                <span class="n">permission</span> <span class="p">=</span> <span class="n">Permission</span><span class="p">.</span><span class="n">RECORD_AUDIO</span><span class="p">,</span>
</span><span class='line'>                <span class="c1">// Optional: custom UI if permission is not yet granted</span>
</span><span class='line'>                <span class="n">contentNonGranted</span> <span class="p">=</span> <span class="p">{</span> <span class="n">missing</span><span class="p">,</span> <span class="n">humanReadable</span><span class="p">,</span> <span class="n">requestPermissions</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="c1">// Minimal, inline UX: re-request directly</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">requestPermissions</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Grant $humanReadable&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">activeRecording</span> <span class="p">=</span> <span class="n">toggleRecording</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">videoCapture</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">activeRecording</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">activeRecording</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">RadioButtonUnchecked</span>
</span><span class='line'>                        <span class="k">else</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Stop</span><span class="p">,</span>
</span><span class='line'>                        <span class="s">&quot;Record Video&quot;</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">capturePhoto</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">imageCapture</span><span class="p">:</span> <span class="n">ImageCapture</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">capture</span> <span class="p">=</span> <span class="n">imageCapture</span> <span class="o">?:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="s">&quot;IMG_${System.currentTimeMillis()}.jpg&quot;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">contentValues</span> <span class="p">=</span> <span class="n">ContentValues</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">DISPLAY_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">MIME_TYPE</span><span class="p">,</span> <span class="s">&quot;image/jpeg&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// On Android 10+ you could also set RELATIVE_PATH = &quot;DCIM/CameraX&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">outputOptions</span> <span class="p">=</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">OutputFileOptions</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>        <span class="n">context</span><span class="p">.</span><span class="n">contentResolver</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">EXTERNAL_CONTENT_URI</span><span class="p">,</span>
</span><span class='line'>        <span class="n">contentValues</span>
</span><span class='line'>    <span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">capture</span><span class="p">.</span><span class="n">takePicture</span><span class="p">(</span>
</span><span class='line'>        <span class="n">outputOptions</span><span class="p">,</span>
</span><span class='line'>        <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span><span class='line'>        <span class="k">object</span> <span class="err">: </span><span class="nc">ImageCapture</span><span class="p">.</span><span class="n">OnImageSavedCallback</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onImageSaved</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">OutputFileResults</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Success: output.savedUri</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="n">ImageCaptureException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Handle error</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">toggleRecording</span><span class="p">(</span>
</span><span class='line'>    <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
</span><span class='line'>    <span class="n">videoCapture</span><span class="p">:</span> <span class="n">VideoCapture</span><span class="p">&lt;</span><span class="n">Recorder</span><span class="p">&gt;?,</span>
</span><span class='line'>    <span class="n">currentRecording</span><span class="p">:</span> <span class="n">Recording</span><span class="p">?</span>
</span><span class='line'><span class="p">):</span> <span class="n">Recording</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">capture</span> <span class="p">=</span> <span class="n">videoCapture</span> <span class="o">?:</span> <span class="k">return</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Stop if already recording</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">currentRecording</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">currentRecording</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start new recording</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="s">&quot;VID_${System.currentTimeMillis()}.mp4&quot;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">contentValues</span> <span class="p">=</span> <span class="n">ContentValues</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Video</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">DISPLAY_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// On Android 10+ you could also set RELATIVE_PATH = &quot;DCIM/CameraX&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">outputOptions</span> <span class="p">=</span> <span class="n">MediaStoreOutputOptions</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>        <span class="n">context</span><span class="p">.</span><span class="n">contentResolver</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MediaStore</span><span class="p">.</span><span class="n">Video</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">EXTERNAL_CONTENT_URI</span>
</span><span class='line'>    <span class="p">).</span><span class="n">setContentValues</span><span class="p">(</span><span class="n">contentValues</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">capture</span><span class="p">.</span><span class="n">output</span>
</span><span class='line'>        <span class="p">.</span><span class="n">prepareRecording</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">outputOptions</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">withAudioEnabled</span><span class="p">()</span> <span class="c1">// mic permission is ensured by PermissionGate above</span>
</span><span class='line'>        <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span> <span class="n">event</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// Handle recording events (e.g., finalize, error)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯çº¯ç²¹çš„ Compose UI æ„å»ºã€‚ä½ çš„ç›¸æœºæŒ‰é’®ä¸é¢„è§ˆä½äºåŒä¸€ä¸ªå¯ç»„åˆæ ‘ä¸­ã€‚æ²¡æœ‰æ¡¥æ¥é€»è¾‘ã€‚æ— éœ€ç®¡ç†å•ç‹¬çš„ View å±‚æ¬¡ç»“æ„ã€‚</p>

<h2>è¿ç§»ç­–ç•¥ï¼šPreviewView â†’ CameraXViewfinder</h2>

<p>å¦‚æœä½ ç°æœ‰çš„ç›¸æœºä»£ç ä½¿ç”¨â€œPreviewViewâ€ï¼Œåˆ™è¿ç§»è·¯å¾„å¦‚ä¸‹ï¼š</p>

<p><strong>è¿ç§»å‰ï¼ˆæ—§æ–¹æ³•ï¼‰ï¼š</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">OldCameraPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">previewView</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">PreviewView</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">previewView</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="k">get</span><span class="p">()</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="n">preview</span><span class="p">.</span><span class="n">setSurfaceProvider</span><span class="p">(</span><span class="n">previewView</span><span class="p">.</span><span class="n">surfaceProvider</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AndroidView</span><span class="p">(</span>
</span><span class='line'>        <span class="n">factory</span> <span class="p">=</span> <span class="p">{</span> <span class="n">previewView</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>è¿ç§»åï¼ˆCompose åŸç”Ÿæ–¹æ³•ï¼‰ï¼š</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">NewCameraPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">selector</span> <span class="p">=</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…³é”®çš„æ€ç»´è½¬å˜ï¼šä¸å†å°† View çš„â€œSurfaceProviderâ€èµ‹äºˆ CameraXï¼Œè€Œæ˜¯å°†â€œSurfaceRequestâ€å¯¹è±¡å‘å¸ƒåˆ° Compose çŠ¶æ€ï¼Œå¹¶ä½¿ç”¨â€œCameraXViewfinderâ€è¿›è¡Œæ¸²æŸ“ã€‚</p>

<h2>æ‰€éœ€ä¾èµ–é¡¹</h2>

<p>æ·»åŠ åˆ°ä½ çš„ <code>build.gradle.kts</code> ä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">cameraxVersion</span> <span class="p">=</span> <span class="s">&quot;1.5.1&quot;</span><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-core:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-camera2:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-lifecycle:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-video:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The new Compose-native viewfinder</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-compose:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¸…å•æƒé™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.CAMERA&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.RECORD_AUDIO&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2><strong>å®ç°æ¨¡å¼ï¼ˆæ€§èƒ½ vs. åˆæˆï¼‰</strong></h2>

<p><code>CameraXViewfinder</code> å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼æ¸²æŸ“é¢„è§ˆï¼š</p>

<h3><strong>EXTERNALï¼ˆSurfaceView æ”¯æŒï¼‰</strong></h3>

<p>ç›¸æœºå¸§åœ¨å…¶<strong>è‡ªå·±çš„ Surface</strong> ä¸Šæ¸²æŸ“ï¼Œç”±ç³»ç»Ÿåœ¨ Compose ç»˜åˆ¶é€šé“<strong>ä¹‹å¤–</strong>åˆæˆã€‚å¯ä»¥æƒ³è±¡æˆâ€œUI èƒŒåçš„å®æ—¶è§†é¢‘å±‚â€ã€‚é€šå¸¸å¯ç”¨ç¡¬ä»¶å åŠ  â†’ æœ€ä½³æ€§èƒ½/å»¶è¿Ÿã€‚éå¸¸é€‚åˆåœ¨æ ‡å‡† UI åæ–¹æ˜¾ç¤ºå…¨å±çŸ©å½¢é¢„è§ˆã€‚ç”±äºå®ƒæ˜¯ä¸€ä¸ªå•ç‹¬çš„å±‚ï¼Œå› æ­¤å¯¹<em>ç›¸æœºåƒç´ </em>çš„é€åƒç´ æ•ˆæœï¼ˆå¤æ‚çš„è£å‰ª/æ¨¡ç³Šï¼‰ä¸é€‚ç”¨ã€‚</p>

<ul>
<li>ä¼˜ç‚¹ï¼šå»¶è¿Ÿæ›´ä½ï¼ŒGPU è´Ÿè½½æ›´å°‘ï¼Œéå¸¸é€‚åˆå…¨å±é¢„è§ˆ/å½•åˆ¶ã€‚</li>
<li>ç¼ºç‚¹ï¼šä¸å—é€åƒç´ ç•Œé¢ç‰¹æ•ˆï¼ˆåœ†è§’è’™ç‰ˆ/æ¨¡ç³Šï¼‰çš„å½±å“ï¼Œä¸ä¼šæ˜¾ç¤ºåœ¨ Compose å±å¹•æˆªå›¾ä¸­ã€‚</li>
</ul>


<h3><strong>åµŒå…¥å¼ï¼ˆTextureView æ”¯æŒï¼‰</strong></h3>

<p>ç›¸æœºå¸§ä½œä¸º<strong>GPU çº¹ç†</strong>ç»˜åˆ¶åœ¨ Compose æ¸²æŸ“é€šé“<strong>å†…éƒ¨</strong>â€”â€”ç±»ä¼¼äº<strong>å¯é‡ç»˜é¢æ¿</strong>ï¼Œå…¶è¡Œä¸ºä¸å…¶ä»–å¯ç»„åˆé¡¹ç±»ä¼¼ã€‚ä½ å¯ä»¥è·å¾—æ·±åº¦è£å‰ª/è’™ç‰ˆ/åŠ¨ç”»/æ¨¡ç³Š/Z è½´æ’åºï¼Œä½†ä»£ä»·æ˜¯ GPU å·¥ä½œé‡å¢åŠ ï¼Œå»¶è¿Ÿç•¥é«˜ã€‚</p>

<ul>
<li>ä¼˜ç‚¹ï¼šè¡Œä¸ºç±»ä¼¼äºæ™®é€šç•Œé¢ï¼›è£å‰ªã€Alpha é€šé“ã€æ¨¡ç³Šã€ç‰¹æ®Šå½¢çŠ¶å’Œå¤æ‚ Z è½´æ’åºå‡æ­£å¸¸ã€‚</li>
<li>ç¼ºç‚¹ï¼šGPU å·¥ä½œé‡å¢åŠ  â†’ åœ¨ç¹é‡çš„ç•Œé¢æˆ–ä¸­ç«¯è®¾å¤‡ä¸Šï¼Œå»¶è¿Ÿ/å¡é¡¿é£é™©ç•¥é«˜ã€‚</li>
</ul>


<h3><strong>ç»éªŒæ³•åˆ™</strong></h3>

<ul>
<li>å…¨å±/é«˜æ€§èƒ½ â†’ <strong>å¤–éƒ¨</strong></li>
<li>ç‰¹æ®Šæ„å›¾/ç‰¹æ•ˆ â†’ <strong>åµŒå…¥å¼</strong>ã€‚</li>
</ul>


<p>å¦‚æœä½ æœªæŒ‡å®šæ¨¡å¼ï¼Œåº“å°†é€‰æ‹©ä¸€ä¸ªåˆç†çš„é»˜è®¤æ¨¡å¼ã€‚å¼ºåˆ¶ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">androidx.camera.viewfinder.core.ImplementationMode</span>
</span><span class='line'>
</span><span class='line'><span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>    <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>    <span class="n">implementationMode</span> <span class="p">=</span> <span class="n">ImplementationMode</span><span class="p">.</span><span class="n">EXTERNAL</span> <span class="c1">// or ImplementationMode.EMBEDDED</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å®é™…æ“ä½œä¸­çš„é™·é˜±</h2>

<p><strong>åæ ‡å˜æ¢å¹¶éå¯é€‰</strong>
ä¸è¦å°†åŸå§‹ Compose åç§»é‡ä¼ é€’ç»™æµ‹é‡å·¥å‚ã€‚åŠ¡å¿…ä½¿ç”¨åæ ‡å˜æ¢å™¨ã€‚æ•°å­¦è¿ç®—çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œç›´åˆ°ä½ åœ¨æ¨ªå±ã€å¯æŠ˜å è®¾å¤‡æˆ–éæ ‡å‡†å®½é«˜æ¯”è®¾å¤‡ä¸Šè¿›è¡Œæµ‹è¯•ã€‚</p>

<p><strong>å‰ç½®æ‘„åƒå¤´æ˜¯é•œåƒçš„</strong>
å¦‚æœä½ æ­£åœ¨ç»˜åˆ¶å åŠ å±‚æˆ–å¤„ç†æ‹æ‘„çš„å›¾åƒï¼Œè¯·è®°ä½å‰ç½®æ‘„åƒå¤´é¢„è§ˆé»˜è®¤æ˜¯é•œåƒçš„ï¼Œä½†æ‹æ‘„çš„å›¾åƒä¸æ˜¯ã€‚åœ¨ä½ çš„ç•Œé¢/å¤„ç†é€»è¾‘ä¸­è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚</p>

<p><strong>åœ¨çœŸå®è®¾å¤‡ä¸Šæµ‹è¯•</strong>
ä¸åŒ OEM çš„ç›¸æœºè¡Œä¸ºæœ‰æ‰€ä¸åŒã€‚åœ¨ Pixel ä¸Šå®Œç¾è¿è¡Œçš„åŠŸèƒ½åœ¨ä¸‰æ˜Ÿæˆ–å°ç±³ä¸Šå¯èƒ½å­˜åœ¨é—®é¢˜ã€‚åœ¨ä»£è¡¨æ€§ç¡¬ä»¶ä¸Šæµ‹è¯•ä½ çš„å…³é”®æµç¨‹ã€‚</p>

<p><strong>æƒé™ç”¨æˆ·ä½“éªŒ</strong>
åœ¨å…¥å£ç‚¹è¯·æ±‚ <code>CAMERA</code>ï¼›ä»…åœ¨å¼€å§‹å½•åˆ¶æ—¶è¯·æ±‚ <code>RECORD_AUDIO</code>ï¼ˆè¿™æ˜¯ä¸€ç§è‰¯å¥½åšæ³•ï¼‰ã€‚ä¸Šé¢çš„å†…è” <code>PermissionGate</code> æ¨¡å¼å°†è¯¥é€»è¾‘ä¿ç•™åœ¨ä½ çš„ Compose æ ‘ä¸­ã€‚</p>

<h2>é«˜çº§åŠŸèƒ½ï¼šå¯æŠ˜å å’Œè‡ªé€‚åº” UI</h2>

<p>ç”±äº <code>CameraXViewfinder</code> åªæ˜¯å¦ä¸€ä¸ªå¯ç»„åˆé¡¹ï¼Œå› æ­¤å¯æŠ˜å æ”¯æŒéå¸¸ç®€å•ã€‚ç®€å•çš„åŒçª—æ ¼å¸ƒå±€æˆ–å…¨å±å¸ƒå±€é€šå¸¸å°±è¶³å¤Ÿäº†ï¼›å¦‚æœéœ€è¦ï¼Œå¯ä»¥ä½¿ç”¨ <code>AnimatedContent</code> æ¥åœ¨çŠ¶æ€ä¹‹é—´æ·»åŠ åŠ¨ç”»ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AdaptiveCameraScreen</span><span class="p">(</span><span class="n">surfaceRequest</span><span class="p">:</span> <span class="n">SurfaceRequest</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">expanded</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// pretend this reflects window size/hinge state</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AnimatedContent</span><span class="p">(</span><span class="n">targetState</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;layout&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">isExpanded</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">isExpanded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Row</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">aspectRatio</span><span class="p">(</span><span class="m">9f</span> <span class="p">/</span> <span class="m">16f</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* CameraControls(Modifier.align(Alignment.Center)) */</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="cm">/* CameraControls(Modifier.align(Alignment.BottomCenter)) */</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æµ‹è¯•æ¸…å•ï¼ˆå®ç”¨ï¼‰</h2>

<ul>
<li>éªŒè¯çºµå‘/æ¨ªå‘ä»¥åŠ <code>ContentScale.Crop/Fit</code> æ¨¡å¼ä¸‹çš„ç‚¹å‡»å¯¹ç„¦ç²¾åº¦ã€‚</li>
<li>æµ‹è¯•ç¼©æ”¾é™åˆ¶ï¼›ç¡®ä¿æåˆå’Œç¨‹åºåŒ–ç¼©æ”¾è¿‡æ¸¡æµç•…ã€‚</li>
<li>åˆ‡æ¢æ‘„åƒå¤´ï¼ˆå‰/åï¼‰å¹¶é‡æ–°éªŒè¯å˜æ¢ + é•œåƒè¡Œä¸ºã€‚</li>
<li>å¯¼èˆªç¦»å¼€/åé€€ã€æ—‹è½¬å’Œå¤„ç†é…ç½®æ›´æ”¹ï¼›é¢„è§ˆåº”èƒ½å¤Ÿæ¢å¤ä¸”ä¸é—ªçƒã€‚</li>
<li>åœ¨å¯¹ç„¦/ç¼©æ”¾æ—¶å½•åˆ¶è§†é¢‘ï¼›ç¡®ä¿æ²¡æœ‰è¡¨é¢æ‰è½ã€‚</li>
</ul>


<h2>å…¨å±€å±•æœ›</h2>

<p>æ­¤ç‰ˆæœ¬çš„é‡è¦æ€§ä¸ä»…åœ¨äºå®ƒå¸¦æ¥çš„åŠŸèƒ½ï¼Œè¿˜åœ¨äºå®ƒæ‰€ä¼ é€’çš„ä¿¡æ¯ã€‚</p>

<p>å¤šå¹´æ¥ï¼ŒAndroid ä¸­çš„ç›¸æœºå¼€å‘ä¸€ç›´æ„Ÿè§‰åƒæ˜¯äºŒç­‰å…¬æ°‘ã€‚é™¤äº†ç›¸æœºé¡µé¢ä¹‹å¤–ï¼Œä½ å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨ Compose æ„å»ºç°ä»£ UIï¼Œè€Œç›¸æœºé¡µé¢åˆ™éœ€è¦ä½ å‹‰å¼ºæ‰èƒ½ä¸ View è¿›è¡Œäº’æ“ä½œã€‚è™½ç„¶ Compose ç¡®å®æœ‰æ•ˆï¼Œä½†ç¼–å†™ä»£ç æ—¶æ€»æ„Ÿè§‰åƒæ˜¯è¢«æŸç¼šäº†ä¸€åªæ‰‹ã€‚</p>

<p><code>camera-compose</code> ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæ–°äº§ç‰©ã€‚CameraX å›¢é˜Ÿæ›¾è¯´è¿‡ï¼šâ€œCompose ç°åœ¨æ˜¯ä¸€æµçš„ç›¸æœºå¼€å‘å¹³å°ã€‚â€</p>

<p>è¿™æ„å‘³ç€ï¼š</p>

<ul>
<li>æœªæ¥çš„ç›¸æœºåŠŸèƒ½å°†åœ¨è®¾è®¡æ—¶å……åˆ†è€ƒè™‘ Composeï¼Œè€Œä¸æ˜¯å¯¹å…¶è¿›è¡Œæ”¹é€ ã€‚</li>
<li>ç¤¾åŒºå°†æ„å»ºä»¥ Compose ä¸ºå…ˆçš„ç›¸æœºåº“å’Œç»„ä»¶ã€‚</li>
<li>æœ€ä½³å®è·µå°†å›´ç»•å¯ç»„åˆç›¸æœº UI ä¸æ–­å‘å±•ã€‚</li>
<li>æ–‡æ¡£å’Œç¤ºä¾‹å°†åæ˜ ç°ä»£ Android å¼€å‘ã€‚</li>
</ul>


<p>æˆ‘ä»¬åœ¨æ•´ä¸ª Android ç”Ÿæ€ç³»ç»Ÿä¸­éƒ½çœ‹åˆ°äº†è¿™ç§æ¨¡å¼â€”â€”æœ€åˆä»¥ View ä¸ºä¸­å¿ƒçš„ API æ­£åœ¨é€æ¸è·å¾— Compose åŸç”Ÿçš„å¯¹åº”ç‰ˆæœ¬ã€‚<code>camera-compose</code> å°±æ˜¯è¿„ä»Šä¸ºæ­¢æœ€å…·å½±å“åŠ›çš„ä¾‹å­ä¹‹ä¸€ã€‚</p>

<h2>ä½ ç°åœ¨åº”è¯¥åšä»€ä¹ˆ</h2>

<p><strong>å¦‚æœä½ æ­£åœ¨å¼€å‘ä¸€ä¸ªæ–°çš„ç›¸æœºåŠŸèƒ½ï¼š</strong>
ä»ä¸€å¼€å§‹å°±ä½¿ç”¨ <code>CameraXViewfinder</code>ã€‚ç”šè‡³ä¸éœ€è¦è€ƒè™‘ <code>PreviewView</code>ã€‚å®ƒçš„ä»£ç æ›´ç®€æ´ï¼Œæ€ç»´æ¨¡å‹æ›´ç®€å•ï¼Œä½ ä»¥åä¼šæ„Ÿè°¢è‡ªå·±çš„ã€‚</p>

<p><strong>å¦‚æœä½ å·²ç»æœ‰ç›¸æœºä»£ç ï¼š</strong>
å°† <code>camera-compose</code> æ·»åŠ åˆ°ä½ çš„ä¾èµ–é¡¹ä¸­ï¼Œå¹¶ä¸€æ¬¡è¿ç§»ä¸€ä¸ªé¡µé¢ã€‚ä»æœ€ç®€å•çš„ç›¸æœº UIï¼ˆå¯èƒ½æ˜¯åŸºæœ¬çš„çº¯é¢„è§ˆé¡µé¢ï¼‰å¼€å§‹ï¼Œç†Ÿæ‚‰æ–°çš„ APIã€‚ç„¶åå†å¤„ç†å¤æ‚çš„éƒ¨åˆ†ã€‚</p>

<p><strong>å¦‚æœä½ æ­£åœ¨æ„å»ºä¸€ä¸ªåº“ï¼š</strong>
ç°åœ¨æ˜¯æ—¶å€™å°† Compose åŸç”Ÿç›¸æœºç»„ä»¶æ·»åŠ åˆ°ä½ çš„ SDK ä¸­äº†ã€‚å¼€å‘è€…æ­£åœ¨å¯»æ‰¾å¯ç»„åˆçš„ç›¸æœºè§£å†³æ–¹æ¡ˆï¼Œè€Œç”Ÿæ€ç³»ç»Ÿå·²ç»ä¸ºä»–ä»¬åšå¥½äº†å‡†å¤‡ã€‚</p>

<h2>å»¶ä¼¸é˜…è¯»</h2>

<ul>
<li><a href="https://developer.android.com/jetpack/androidx/releases/camera">CameraX å‘è¡Œè¯´æ˜</a> â€” å®˜æ–¹æ›´æ–°æ—¥å¿—å’Œå·¥ä»¶</li>
<li><a href="https://developer.android.com/jetpack/androidx/releases/camera-viewfinder">Camera Viewfinder æ–‡æ¡£</a> â€” å®ç°æ¨¡å¼ã€ç¼©æ”¾å’Œå¯¹é½</li>
<li><a href="https://github.com/androidx/androidx/tree/androidx-main/camera">CameraX GitHub ç¤ºä¾‹</a> â€” çœŸå®ä»£ç ç¤ºä¾‹</li>
</ul>


<h2>å›½ç‹å·²æ­» / å›½ç‹ä¸‡å²</h2>

<p>â€œAndroidViewâ€ç›¸æœºé¢„è§ˆçš„æ—¶ä»£å·²ç»ç»“æŸã€‚å¦‚æœä½ è¦åœ¨ 2025 å¹´åŠä»¥åæ„å»ºç›¸æœºåŠŸèƒ½ï¼Œé‚£ä¹ˆä½ å°†ä½¿ç”¨ Compose æ¥æ„å»ºå®ƒä»¬ã€‚ç°åœ¨ç»ˆäºæœ‰äº†å¯ä»¥æ­£ç¡®æ”¯æŒè¿™äº›åŠŸèƒ½çš„å·¥å…·ã€‚</p>

<p>ç°åœ¨ï¼Œç”©æ‰é‚£ä¸ªâ€œAndroidViewâ€åŒ…è£…å™¨ï¼Œç¼–å†™ä¸€äº›æ¼‚äº®çš„ç›¸æœº UI å§ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç†è§£retain{}çš„å†…éƒ¨æœºåˆ¶ï¼šJetpack Composeä¸­åŸºäºä½œç”¨åŸŸçš„çŠ¶æ€ä¿å­˜]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals/"/>
    <updated>2025-10-22T14:29:55+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒUnderstanding retain{} internals: A Scope-based State Preservation in Jetpack Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/understanding-retain-internals-a-new-way-to-preserve-state-in-jetpack-compose-54471a32fd05">https://proandroiddev.com/understanding-retain-internals-a-new-way-to-preserve-state-in-jetpack-compose-54471a32fd05</a>ï¼Œç”±Jaewoong Eumå‘å¸ƒäº2025å¹´10æœˆ15æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*yQo3amM25om4TWkUzgxjvQ.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>Jetpack Compose æ˜¯ä¸€ç§ç°ä»£ Android UI å¼€å‘æ–¹å¼ï¼Œæ‹¥æœ‰å£°æ˜å¼æ–¹æ³•å’Œå¼ºå¤§çš„çŠ¶æ€ç®¡ç†åŸè¯­ã€‚è™½ç„¶ <code>remember{}</code> èƒ½å¤Ÿå¾ˆå¥½åœ°åœ¨é‡ç»„è¿‡ç¨‹ä¸­ä¿å­˜çŠ¶æ€ï¼Œä½†å®ƒæœ‰ä¸€ä¸ªæ ¹æœ¬æ€§çš„å±€é™æ€§ï¼šå®ƒæ— æ³•åœ¨é…ç½®æ›´æ”¹æˆ–å¯¼èˆªè½¬æ¢åç»§ç»­ç”Ÿæ•ˆã€‚å¼•å…¥ <code>retain{}</code>ï¼Œè¿™æ˜¯ä¸€ç§åœ¨ç¬æ—¶é”€æ¯åœºæ™¯ä¸‹ä¿å­˜çŠ¶æ€çš„æ–°æ–¹æ³•ï¼ŒåŒæ—¶ä¿æŒå¯ç»„åˆæ€§ã€‚</p>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œä½ å°†æ·±å…¥äº†è§£ <code>retain{}</code>ã€<code>RetainScope</code>ã€<code>RetainObserver</code> å’Œ <code>RetainedEffect</code> çš„å†…éƒ¨æœºåˆ¶ï¼Œæ¢ç´¢å®ƒä»¬çš„åº•å±‚å·¥ä½œåŸç†ï¼Œä»¥åŠä½¿ Retention æ—¢å†…å­˜å®‰å…¨åˆæ€§èƒ½å“è¶Šçš„ä¼˜åŒ–æ–¹æ³•ã€‚</p>

<p>å¦‚æœä½ å°šæœªé˜…è¯»ä»¥ä¸‹ä¹‹å‰çš„æ–‡ç« ï¼Œç†è§£ä»¥ä¸‹éƒ¨åˆ†å°†å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼š</p>

<ul>
<li><a href="https://medium.com/proandroiddev/exploring-retain-api-a-new-way-to-persist-state-in-jetpack-compose-bfb2fe2eae43">é¢„è§ˆ retain{} APIï¼šJetpack Compose ä¸­æŒä¹…åŒ–çŠ¶æ€çš„æ–°æ–¹æ³•</a></li>
<li><a href="https://medium.com/proandroiddev/previewing-retainedeffect-a-new-side-effect-to-bridge-between-composition-and-retention-lifecycles-685b9e543de7">é¢„è§ˆ RetainedEffectï¼šæ¡¥æ¥ Composition å’Œ Retention ç”Ÿå‘½å‘¨æœŸçš„æ–° Side Effect</a></li>
</ul>


<h2>å¯¼å…¥ Compose è¿è¡Œæ—¶ retain åº“</h2>

<p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä¾èµ–é¡¹å¯¼å…¥ Compose è¿è¡Œæ—¶ retain åº“ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.compose.runtime:runtime-retain:1.10.0-alpha05&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯·æ³¨æ„ï¼Œæ­¤åº“ç›®å‰å¤„äºå®éªŒé˜¶æ®µï¼Œæœªæ¥å°†ä¸æ–­å®Œå–„å’Œç¨³å®šå‘å¸ƒã€‚</p>

<h2>ç†è§£æ ¸å¿ƒé—®é¢˜ï¼šä¸ºä»€ä¹ˆ remember{} è¿˜ä¸å¤Ÿ</h2>

<p>ä»æœ¬è´¨ä¸Šè®²ï¼Œ<code>remember{}</code> å¯ä»¥åœ¨å•ä¸ªç»„åˆç”Ÿå‘½å‘¨æœŸå†…è·¨é‡ç»„ä¿ç•™çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå½“ä½ çš„ Activity å› é…ç½®æ›´æ”¹è€Œé‡æ–°åˆ›å»ºæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿæˆ–è€…å½“å¯¼èˆªç›®æ ‡ä»è¿”å›å †æ ˆä¸­ç§»é™¤æ—¶ï¼ŸçŠ¶æ€ä¼šä¸¢å¤±ï¼Œä½ çš„å¯ç»„åˆé¡¹ä¼šé‡æ–°å¼€å§‹ã€‚</p>

<p>ä¼ ç»Ÿçš„ Android è§£å†³æ–¹æ¡ˆæ¶‰åŠ <code>ViewModel</code> å’Œ <code>SavedStateHandle</code>ï¼Œä½†å®ƒä»¬æœ¬èº«ä¹Ÿå…·æœ‰å¤æ‚æ€§ï¼šåºåˆ—åŒ–è¦æ±‚ã€æ‰‹åŠ¨çŠ¶æ€æ¢å¤ä»¥åŠåœ¨å¯ç»„åˆé¡¹å±‚æ¬¡ç»“æ„ä¹‹å¤–ç®¡ç†çŠ¶æ€çš„è®¤çŸ¥å¼€é”€ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥æ‹¥æœ‰ä¸€ä¸ªåƒ <code>remember{}</code> ä¸€æ ·å·¥ä½œï¼Œä½†åˆèƒ½åœ¨è¿™äº›ç¬æ—¶é”€æ¯åç»§ç»­å­˜åœ¨çš„ä¸œè¥¿ï¼Œé‚£ä¼šæ€æ ·ï¼Ÿ</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// With remember: state lost on configuration change</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">()</span> <span class="p">}</span> <span class="c1">// Lost on rotation!</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// With retain: state preserved across configuration changes</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">()</span> <span class="p">}</span> <span class="c1">// Survives rotation!</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>retain{}</code> èƒŒåçš„å…³é”®æ´å¯Ÿæ˜¯ï¼ŒçŠ¶æ€é”€æ¯å¹¶ä¸æ€»æ˜¯æ°¸ä¹…æ€§çš„ã€‚é€šå¸¸ï¼Œå®ƒæ˜¯æš‚æ—¶çš„ï¼›å†…å®¹ä¼šè¢«é‡æ–°åˆ›å»ºï¼Œæ¢å¤ä¹‹å‰çš„çŠ¶æ€ä¼šå¯¹æˆ‘ä»¬æœ‰åˆ©ã€‚è¿™å°±æ˜¯â€œRetainScopeâ€å‘æŒ¥ä½œç”¨çš„åœ°æ–¹ã€‚</p>

<h2>retain{} API åŠå…¶ç”Ÿå‘½å‘¨æœŸ</h2>

<p>å¦‚æœä½ æ£€æŸ¥ retain å‡½æ•°ç­¾åï¼Œä¼šå‘ç°å®ƒä¸ <code>remember</code> API ç±»ä¼¼ï¼Œä½†å­˜åœ¨ä»¥ä¸‹åŒºåˆ«ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">retain</span><span class="p">(</span><span class="n">noinline</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">retain</span><span class="p">(</span><span class="k">vararg</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">noinline</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¸¦æœ‰ <code>reified</code> ç±»å‹å‚æ•°çš„ inline ä¿®é¥°ç¬¦æ— éœ€æ˜¾å¼ç±»å‚æ•°å³å¯å®ç°ç±»å‹å®‰å…¨çš„ä¿ç•™ã€‚ä½†çœŸæ­£çš„é­”åŠ›åœ¨äºå…¶å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">retainImpl</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">RetainKeys</span><span class="p">,</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">retainScope</span> <span class="p">=</span> <span class="n">LocalRetainScope</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">holder</span> <span class="p">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">retainedValue</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">.</span><span class="n">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">RetainScopeMissingValue</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">retainedValue</span> <span class="p">!==</span> <span class="n">RetainScopeMissingValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">RetainedValueHolder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">value</span> <span class="p">=</span> <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span> <span class="p">(</span><span class="n">retainedValue</span> <span class="k">as</span> <span class="n">T</span><span class="p">),</span>
</span><span class='line'>                <span class="n">owner</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">RetainedValueHolder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">value</span> <span class="p">=</span> <span class="n">calculation</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">owner</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">holder</span><span class="p">.</span><span class="n">owner</span> <span class="p">!==</span> <span class="n">retainScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SideEffect</span> <span class="p">{</span> <span class="n">holder</span><span class="p">.</span><span class="n">readoptUnder</span><span class="p">(</span><span class="n">retainScope</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">holder</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤å®ç°æ­ç¤ºäº†ä¿ç•™çš„ä¸¤ä¸ªé˜¶æ®µç‰¹æ€§ï¼š</p>

<p><strong>é˜¶æ®µ 1ï¼šè®°å¿†é˜¶æ®µ</strong>ã€‚<code>retain{}</code> é¦–å…ˆä½¿ç”¨ <code>remember{}</code> åˆ›å»ºä¸€ä¸ª <code>RetainedValueHolder</code>ã€‚è¯¥æŒæœ‰è€…åŒ…è£…å®é™…å€¼å¹¶è·Ÿè¸ªå…¶ç”Ÿå‘½å‘¨æœŸã€‚</p>

<p><strong>é˜¶æ®µ 2ï¼šä¿ç•™é˜¶æ®µ</strong>ã€‚å½“æŒæœ‰è€…ç¦»å¼€ç»„åˆæ—¶ï¼Œ<code>RetainScope</code> ä¸ä¼šç«‹å³å°†å…¶ä¸¢å¼ƒï¼Œè€Œæ˜¯å†³å®šæ˜¯å¦å°†å…¶ä¿ç•™ä»¥å¤‡å°†æ¥æ¢å¤ã€‚</p>

<h2>RetainedValueHolder å’Œ RetainScope</h2>

<p>é¦–å…ˆï¼Œå¦‚æœä½ ä»”ç»†ç ”ç©¶ <code>RetainedValueHolder</code> çš„å†…éƒ¨ä»£ç ï¼Œä½ ä¼šå‘ç°å®ƒæ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†å‘ç”Ÿçš„åœ°æ–¹ã€‚å®ƒå®ç°äº† <code>RememberObserver</code> æ¥å£ï¼Œä»¥ä¾¿ä¸ Compose çš„ç”Ÿå‘½å‘¨æœŸæŒ‚é’©ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">RetainedValueHolder</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">owner</span><span class="p">:</span> <span class="n">RetainScope</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">isNewlyRetained</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RememberObserver</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRemembered</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">isNewlyRetained</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>                <span class="n">value</span><span class="p">.</span><span class="n">onRetained</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onEnteredComposition</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onForgotten</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">owner</span><span class="p">.</span><span class="n">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onExitedComposition</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetired</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAbandoned</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetained</span><span class="p">()</span>
</span><span class='line'>            <span class="n">owner</span><span class="p">.</span><span class="n">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onUnused</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼Œè¯¥æŒæœ‰è€…ä¼šæ‹¦æˆªç»„åˆç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¹¶å°†å…¶è½¬æ¢ä¸ºä¿ç•™äº‹ä»¶ã€‚å½“ <code>onForgotten()</code> è¢«è°ƒç”¨æ—¶ï¼ˆå€¼ç¦»å¼€ç»„åˆï¼‰ï¼Œå®ƒä¼šæ£€æŸ¥ <code>RetainScope</code> æ˜¯å¦ä¿ç•™äº†å·²é€€å‡ºçš„å€¼ã€‚å¦‚æœæ˜¯ï¼Œå®ƒä¼šä¿å­˜è¯¥å€¼ä»¥ä¾›å°†æ¥æ¢å¤ï¼Œè€Œä¸æ˜¯ä¸¢å¼ƒå®ƒã€‚</p>

<p><code>RetainScope</code> æ˜¯ä¿ç•™ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µã€‚å®ƒç®¡ç†ä½•æ—¶ä¿ç•™å€¼ã€å¦‚ä½•å­˜å‚¨å®ƒä»¬ä»¥åŠä½•æ—¶æ¢å¤æˆ–é€€å‡ºå®ƒä»¬ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ç»†èŠ‚ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">RetainScope</span> <span class="p">:</span> <span class="n">RetainStateProvider</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">var</span> <span class="py">keepExitedValuesRequests</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">set</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">final</span> <span class="k">override</span> <span class="k">val</span> <span class="py">isKeepingExitedValues</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">keepExitedValuesRequests</span> <span class="p">&gt;</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Any</span><span class="p">?</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">onStartKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">onStopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½œç”¨åŸŸæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š</p>

<ol>
<li><strong>æ™®é€šæ¨¡å¼</strong> (<code>isKeepingExitedValues = false</code>)ï¼šå€¼ç¦»å¼€ç»„åˆæ—¶ä¼šè¢«ä¸¢å¼ƒï¼Œå°±åƒ <code>remember{}</code> ä¸€æ ·ã€‚</li>
<li><strong>ä¿ç•™æ¨¡å¼</strong> (<code>isKeepingExitedValues = true</code>)ï¼šå€¼é€€å‡ºæ—¶ä¼šè¢«ä¿ç•™ï¼Œä»¥ä¾¿å°†æ¥æ¢å¤ã€‚</li>
</ol>


<p>é‚£ä¹ˆï¼Œä¿ç•™ç”Ÿå‘½å‘¨æœŸæ˜¯å¦‚ä½•è¿ä½œçš„å‘¢ï¼Ÿé€šè¿‡åŸå§‹æºä»£ç ä¸­åµŒå…¥çš„å›¾è¡¨å¯ä»¥æœ€å¥½åœ°ç†è§£ä¿ç•™ç”Ÿå‘½å‘¨æœŸï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span><span class='line'>â”‚                      â”‚
</span><span class='line'>â”‚ retain<span class="o">(</span>keys<span class="o">)</span> <span class="o">{</span> ... <span class="o">}</span> â”‚
</span><span class='line'>â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
</span><span class='line'>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¤  value: T  â”œâ”˜
</span><span class='line'>         â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span><span class='line'>            â”‚   â–²
</span><span class='line'>        Exitâ”‚   â”‚Enter
</span><span class='line'> compositionâ”‚   â”‚composition
</span><span class='line'>   or changeâ”‚   â”‚
</span><span class='line'>        keysâ”‚   â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span><span class='line'>            â”‚   â”œâ”€â”€â”€No retained valueâ”€â”€â”€â”€â”€â”¤   calculation: <span class="o">()</span> -&gt; T   â”‚
</span><span class='line'>            â”‚   â”‚   or different keys     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span><span class='line'>            â”‚   â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span><span class='line'>            â”‚   â””â”€â”€â”€Re-enter compositionâ”€â”€â”¤    Local RetainScope     â”‚
</span><span class='line'>            â”‚       with the same keys    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span><span class='line'>            â”‚                                           â–²   â”‚
</span><span class='line'>            â”‚                      â”Œâ”€Yesâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ value not
</span><span class='line'>            â”‚                      â”‚                        â”‚ restored and
</span><span class='line'>            â”‚   .â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€.     â”‚ scope stops
</span><span class='line'>            â””â”€â–¶<span class="o">(</span>   RetainScope.isKeepingExitedValues   <span class="o">)</span>    â”‚ keeping exited
</span><span class='line'>                <span class="sb">`</span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<span class="err">&#39;</span>     â”‚ values
</span><span class='line'>                                   â”‚                        â–¼
</span><span class='line'>                                   â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span><span class='line'>                                   â””â”€Noâ”€â”€â–¶â”‚     value is retired     â”‚
</span><span class='line'>                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤æµç¨‹æ­ç¤ºäº†å‡ ä¸ªå…³é”®çš„è§è§£ï¼š</p>

<ol>
<li><strong>ä¿ç•™æ˜¯æœ‰æ¡ä»¶çš„</strong>ï¼šåªæœ‰å½“ <code>isKeepingExitedValues</code> ä¸º <code>true</code> æ—¶ï¼Œå€¼æ‰ä¼šè¢«ä¿ç•™ã€‚</li>
<li><strong>é”®å¾ˆé‡è¦</strong>ï¼šå³ä½¿åœ¨ä¿ç•™æœŸé—´ï¼Œæ›´æ”¹çš„é”®ä¹Ÿä¼šå¯¼è‡´ç«‹å³é€€å‡ºã€‚</li>
<li><strong>æ¢å¤æ˜¯è‡ªåŠ¨çš„</strong>ï¼šå½“å†…å®¹ä½¿ç”¨ç›¸åŒçš„é”®é‡æ–°è¾“å…¥æ—¶ï¼Œä¿ç•™çš„å€¼å°†è¢«æ¢å¤ã€‚</li>
<li><strong>é€€å‡ºæ˜¯æœ€ç»ˆçš„</strong>ï¼šä¿ç•™åœæ­¢æ—¶æœªæ¢å¤çš„å€¼å°†è¢«é€€å‡ºã€‚</li>
</ol>


<h2>ControlledRetainScopeï¼šå¯å˜å®ç°</h2>

<p>è™½ç„¶ <code>RetainScope</code> æä¾›äº†æŠ½è±¡ï¼Œä½† <code>ControlledRetainScope</code> æ‰æ˜¯ä¸»è¦çš„å®ç°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ControlledRetainScope</span> <span class="p">:</span> <span class="n">RetainScope</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">keptExitedValues</span> <span class="p">=</span> <span class="n">SafeMultiValueMap</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">?&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Any</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">removeLast</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onStopKeepingExitedValues</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">forEachValue</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetired</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥å®ç°ä½¿ç”¨ <code>SafeMultiValueMap</code> è¿›è¡Œå­˜å‚¨æ˜¯ä¸€ä¸ªé‡è¦çš„è®¾è®¡é€‰æ‹©ã€‚ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºå¤šä¸ª retain è°ƒç”¨å¯ä»¥å…·æœ‰ç›¸åŒçš„é”®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">Example</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Both have the same positional key!</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value1</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="s">&quot;First&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value2</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="s">&quot;Second&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥æ˜ å°„æŒ‰ LIFOï¼ˆåè¿›å…ˆå‡ºï¼‰é¡ºåºå­˜å‚¨æ¯ä¸ªé”®çš„å€¼ã€‚æ¢å¤æ—¶ï¼Œ<code>removeLast()</code> ç¡®ä¿å€¼æŒ‰å…¶å­˜å‚¨çš„ç›¸åé¡ºåºæ¢å¤ï¼Œä»è€Œä¿æŒ retain è°ƒç”¨ä¸å…¶å€¼ä¹‹é—´çš„æ­£ç¡®é…å¯¹ã€‚</p>

<p>æ­¤å¤–ï¼Œ<code>ControlledRetainScope</code> æ”¯æŒåµŒå¥—åœ¨çˆ¶çº§ <code>RetainStateProvider</code> ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">setParentRetainStateProvider</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="n">RetainStateProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">oldParent</span> <span class="p">=</span> <span class="n">parentScope</span>
</span><span class='line'>    <span class="n">parentScope</span> <span class="p">=</span> <span class="n">parent</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">parent</span><span class="p">.</span><span class="n">addRetainStateObserver</span><span class="p">(</span><span class="n">parentObserver</span><span class="p">)</span>
</span><span class='line'>    <span class="n">oldParent</span><span class="p">.</span><span class="n">removeRetainStateObserver</span><span class="p">(</span><span class="n">parentObserver</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">oldParent</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">stopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ”¯æŒæœ‰åºçš„å±‚æ¬¡ç»“æ„ï¼Œå…¶ä¸­å­ä½œç”¨åŸŸä»çˆ¶çº§ç»§æ‰¿ä¿ç•™çŠ¶æ€ã€‚ä½ å¯ä»¥åˆ©ç”¨æ­¤åŠŸèƒ½ä½¿æ‰€æœ‰ <code>RetainScopes</code> åœ¨é…ç½®æ›´æ”¹æœŸé—´ä¿ç•™ï¼Œæ ¹ä½œç”¨åŸŸä¼šæ£€æµ‹åˆ°é…ç½®æ›´æ”¹ï¼Œå¹¶æ²¿å±‚æ¬¡ç»“æ„å‘ä¸‹çº§è”ä¿ç•™ã€‚</p>

<h2>RetainObserverï¼šä¿ç•™å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒ</h2>

<p>éœ€è¦äº†è§£å…¶ä¿ç•™ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡éœ€è¦å®ç° <code>RetainObserver</code>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;CallbackName&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">public</span> <span class="n">interface</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Successfully retained</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onEnteredComposition</span><span class="p">()</span> <span class="c1">// Entered composition</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onExitedComposition</span><span class="p">()</span>  <span class="c1">// Exited composition</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// No longer retained</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onUnused</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Created but never used</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™äº›å›è°ƒå®ç°äº† <code>remember{}</code> æ— æ³•å®ç°çš„èµ„æºç®¡ç†æ¨¡å¼ã€‚è®¾æƒ³ä¸€ä¸ªåª’ä½“æ’­æ”¾å™¨ï¼Œå½“å±å¹•æœªæ˜¾ç¤ºæ—¶åº”è¯¥æš‚åœï¼Œä½†å¦‚æœå¯èƒ½å†æ¬¡æ˜¾ç¤ºï¼Œåˆ™ä¸åº”é‡Šæ”¾èµ„æºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">RetainableMediaPlayer</span> <span class="p">:</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">player</span><span class="p">:</span> <span class="n">MediaPlayer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="n">MediaPlayer</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEnteredComposition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">play</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onExitedComposition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">pause</span><span class="p">()</span> <span class="c1">// Just pause, don&#39;t release</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">release</span><span class="p">()</span> <span class="c1">// Now we can release</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onUnused</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Never entered composition, clean up</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">release</span><span class="p">()</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿˜åº”è®°ä½ï¼Œå›è°ƒéµå¾ªä¸¥æ ¼çš„é¡ºåºä¿è¯ã€‚å½“å¤šä¸ª <code>RetainObserver</code> åŒæ—¶è¿›å…¥ç»„åˆçŠ¶æ€æ—¶ï¼Œå®ƒä»¬çš„ <code>onEnteredComposition</code> å›è°ƒå°†æŒ‰é¡ºåºè§¦å‘ã€‚é€€å‡ºæ—¶ï¼Œ<code>onExitedComposition</code> å°†æŒ‰ç›¸åé¡ºåºè§¦å‘<strong>ï¼Œ</strong>ä»¥ç¡®ä¿æ­£ç¡®æ¸…ç†åµŒå¥—èµ„æºã€‚</p>

<h2>RememberObserver é™åˆ¶</h2>

<p>ä½ å¯ä»¥åœ¨ <code>RetainedValueHolder</code> ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ‰è¶£çš„å®‰å…¨æ£€æŸ¥ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RememberObserver</span> <span class="p">&amp;&amp;</span> <span class="n">value</span> <span class="p">!</span><span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;Retained a value that implements RememberObserver but not RetainObserver. &quot;</span> <span class="p">+</span>
</span><span class='line'>            <span class="s">&quot;To receive the correct callbacks, the retained value &#39;$value&#39; must also &quot;</span> <span class="p">+</span>
</span><span class='line'>            <span class="s">&quot;implement RetainObserver.&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé™åˆ¶ï¼Ÿ<code>RememberObserver</code> å›è°ƒï¼ˆ<code>onRemembered</code>ã€<code>onForgotten</code>ã€<code>onAbandoned</code>ï¼‰ä¸ä¿ç•™è¯­ä¹‰ä¸ä¸€è‡´ã€‚æš‚æ—¶è„±ç¦»ç»„åˆçš„ä¿ç•™å€¼ä¸ä¼šè¢«â€œé—å¿˜â€ï¼Œè€Œæ˜¯å¤„äºä¸ç¡®å®šçŠ¶æ€ï¼Œå¯èƒ½ä¼šå†æ¬¡è¿”å›ã€‚ä½¿ç”¨ <code>RememberObserver</code> ä¼šå¯¼è‡´é”™è¯¯çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒï¼Œå› æ­¤åº“å¼ºåˆ¶ä½¿ç”¨ <code>RetainObserver</code>ã€‚</p>

<h2>RetainedEffectï¼šä¿ç•™åä»å­˜åœ¨çš„å‰¯ä½œç”¨</h2>

<p><code>RetainedEffect</code> å°†ä¿ç•™çš„æ¦‚å¿µæ‰©å±•åˆ°å‰¯ä½œç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainedEffect</span><span class="p">(</span><span class="n">key1</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">effect</span><span class="p">:</span> <span class="n">RetainedEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">RetainedEffectResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">retain</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="p">{</span> <span class="n">RetainedEffectImpl</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">class</span> <span class="nc">RetainedEffectImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">effect</span><span class="p">:</span> <span class="n">RetainedEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">RetainedEffectResult</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">onRetire</span><span class="p">:</span> <span class="n">RetainedEffectResult</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">=</span> <span class="n">InternalRetainedEffectScope</span><span class="p">.</span><span class="n">effect</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onRetire</span><span class="o">?.</span><span class="n">retire</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Other callbacks are no-ops</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®ç°éå¸¸ç®€å•ï¼šå®ƒå°† effect åŒ…è£…åœ¨ä¸€ä¸ª <code>RetainObserver</code> ä¸­ï¼Œè¯¥ <code>RetainObserver</code> åœ¨ä¿ç•™æ—¶æ‰§è¡Œ effectï¼Œå¹¶åœ¨é€€å‡ºæ—¶è¿›è¡Œæ¸…ç†ã€‚ä¸ DisposableEffect ä¸åŒï¼ŒDisposableEffect åœ¨ç¦»å¼€ç»„åˆæ—¶è¿è¡Œå…¶å¤„ç½®ï¼Œè€Œ RetainedEffect ä»…åœ¨çœŸæ­£é€€å‡ºæ—¶å¤„ç½®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">retain</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">)</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// DisposableEffect would dispose on every hide/show</span>
</span><span class='line'>    <span class="c1">// RetainedEffect only disposes when truly done</span>
</span><span class='line'>    <span class="n">RetainedEffect</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="p">.</span><span class="n">initialize</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">player</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="c1">// Only called when player is retired</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œè¯´æ˜åœ¨çŸ­æš‚çš„ UI å˜åŒ–æœŸé—´ä¸åº”é‡æ–°åˆ›å»ºæ˜‚è´µçš„èµ„æºã€‚</p>

<h2>RetainedContentHost å’Œ RetainScopeHolder</h2>

<p><code>compose-runtime-retain</code> åº“æä¾›äº†åŸºäºè¿™äº›åŸè¯­æ„å»ºçš„æ›´é«˜çº§åˆ«çš„æŠ½è±¡ã€‚<code>RetainedContentHost</code> ç®¡ç†æ˜¾ç¤º/éšè—åœºæ™¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainedContentHost</span><span class="p">(</span><span class="n">active</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">retainScope</span> <span class="p">=</span> <span class="n">retainControlledRetainScope</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span><span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">retainScope</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">composer</span> <span class="p">=</span> <span class="n">currentComposer</span>
</span><span class='line'>        <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">retainScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">cancellationHandle</span> <span class="p">=</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">retainScope</span><span class="p">.</span><span class="n">keepExitedValuesRequestsFromSelf</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">composer</span><span class="p">.</span><span class="n">scheduleFrameEndCallback</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">retainScope</span><span class="p">.</span><span class="n">stopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">null</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cancellationHandle</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>                <span class="n">retainScope</span><span class="p">.</span><span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯¥å®ç°æ­ç¤ºäº†ä¸€äº›æ—¶é—´æ§åˆ¶ï¼š</p>

<p><strong>å˜ä¸ºæ´»åŠ¨çŠ¶æ€</strong>ï¼šå®‰æ’åœ¨å¸§ç»“æŸæ—¶åœæ­¢ä¿ç•™ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹éƒ½é¦–å…ˆæ¢å¤å…¶å€¼ã€‚</p>

<p><strong>å˜ä¸ºéæ´»åŠ¨çŠ¶æ€</strong>ï¼šåœ¨å†…å®¹è¢«ç§»é™¤ä¹‹å‰ç«‹å³å¼€å§‹ä¿ç•™ã€‚</p>

<p>è¿™ç¡®ä¿äº†å€¼åœ¨éœ€è¦æ—¶è¢«å‡†ç¡®ä¿ç•™ï¼Œä¸ä¼šå¤ªæ—©ï¼ˆè¿™ä¼šé˜»æ­¢æ¢å¤ï¼‰ï¼Œä¹Ÿä¸ä¼šå¤ªæ™šï¼ˆè¿™ä¼šä¸¢å¤±å€¼ï¼‰ã€‚</p>

<p>å¯¹äºåˆ—è¡¨ç­‰åŠ¨æ€å†…å®¹ï¼Œ<code>RetainScopeHolder</code> è´Ÿè´£ç®¡ç†æ¯ä¸ªé¡¹ç›®çš„ä¿ç•™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">RetainScopeHolder</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">childScopes</span> <span class="p">=</span> <span class="n">MutableScatterMap</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">?,</span> <span class="n">ControlledRetainScope</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">getOrCreateRetainScopeForChild</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">RetainScope</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">childScopes</span><span class="p">.</span><span class="n">getOrPut</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ControlledRetainScope</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">isParentKeepingExitedValues</span><span class="p">)</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainScopeProvider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span>
</span><span class='line'>            <span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">getOrCreateRetainScopeForChild</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">content</span><span class="p">()</span>
</span><span class='line'>            <span class="n">PresenceIndicator</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">PresenceIndicator</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">composer</span> <span class="p">=</span> <span class="n">currentComposer</span>
</span><span class='line'>        <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">endRetainHandle</span> <span class="p">=</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">keepExitedValuesRequestsFor</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">composer</span><span class="p">.</span><span class="n">scheduleFrameEndCallback</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">stopKeepingExitedValues</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">null</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">endRetainHandle</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>                <span class="n">startKeepingExitedValues</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>PresenceIndicator</code> å¯ç»„åˆé¡¹æ˜¯ä¸€ç§å·§å¦™çš„æ¨¡å¼ã€‚å®ƒæŒ‰ç»„åˆé¡ºåºæ”¾ç½®åœ¨å†…å®¹<strong>ä¹‹å</strong>ï¼Œä»¥ç¡®ä¿æ­£ç¡®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ç§»é™¤æ—¶ï¼Œå®ƒä¼šè§¦å‘ä¿ç•™ã€‚æ·»åŠ æ—¶ï¼Œå®ƒä¼šå®‰æ’åœ¨å¸§å®Œæˆååœæ­¢ä¿ç•™ã€‚</p>

<h2>å†…å­˜å’Œæ€§èƒ½è€ƒé‡</h2>

<p>è¯¥å®ç°ä¸­è¿›è¡Œäº†å€¼å¾—ç†è§£çš„æƒè¡¡ï¼š</p>

<p><strong>å†…å­˜ä¼˜å…ˆäº CPU</strong>ï¼šä¿ç•™å€¼åœ¨å†…å­˜ä¸­ä¿ç•™çš„æ—¶é—´æ¯” <code>remember{}</code> æ›´é•¿ã€‚è¿™ç”¨å†…å­˜æ¢å–äº†é‡æ–°åˆ›å»ºæ—¶çš„ CPU å¼€é”€ã€‚å¯¹äºå¼€é”€è¾ƒå¤§çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ä½å›¾ã€åª’ä½“æ’­æ”¾å™¨ï¼‰ï¼Œè¿™é€šå¸¸æ˜¯å€¼å¾—çš„ã€‚</p>

<p><strong>O(n) èŒƒå›´æ“ä½œ</strong>ï¼šæŸ¥æ‰¾è¦æ¢å¤æˆ–é€€å‡ºçš„å€¼éœ€è¦è¿­ä»£å­˜å‚¨çš„å€¼ã€‚å¯¹äºåŒ…å«æ•°åä¸ªä¿ç•™å€¼çš„å…¸å‹ç”¨ä¾‹ï¼Œè¿™å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</p>

<p><strong>æƒ°æ€§åˆ†é…</strong>ï¼šä»…åœ¨éœ€è¦æ—¶åˆ†é…ç¼“å†²åŒºå’Œå­˜å‚¨ç©ºé—´ã€‚æœªä½¿ç”¨çš„ <code>RetainScope</code> å¼€é”€æå°ã€‚</p>

<p><strong>é€šè¿‡å…·ä½“åŒ–å®ç°ç±»å‹å®‰å…¨</strong>ï¼šå†…è”/å…·ä½“åŒ–æ¨¡å¼æ¶ˆé™¤äº†è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥çš„éœ€è¦ï¼ŒåŒæ—¶ä¿æŒäº†ç±»å‹å®‰å…¨ã€‚</p>

<p><strong>é»˜è®¤ä¸ºç»„åˆèŒƒå›´</strong>ï¼šä¸ ViewModelï¼ˆåº”ç”¨èŒƒå›´ï¼‰æˆ– rememberSaveableï¼ˆActivityèŒƒå›´ï¼‰ä¸åŒï¼Œretain æ˜¯ç»„åˆèŒƒå›´çš„ï¼Œå¯ä»¥å¯¹ä¿ç•™è¾¹ç•Œè¿›è¡Œç»†ç²’åº¦çš„æ§åˆ¶ã€‚</p>

<p>å¦å¤–ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸è¦å°†é•¿æœŸå­˜æ´»çš„å¯¹è±¡ä¿ç•™åœ¨å…¶é¢„æœŸä½œç”¨åŸŸä¹‹å¤–ï¼Œä»¥å…é€ æˆå†…å­˜æ³„æ¼ï¼Œæ­£å¦‚ Compose åº“ä¸­çš„ä»¥ä¸‹æ³¨é‡Šæ‰€ç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * é‡è¦æç¤ºï¼šä¿ç•™å€¼çš„ä¿å­˜æ—¶é—´æ¯”å…¶æ‰€å…³è”çš„å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸé•¿ã€‚</span>
</span><span class='line'><span class="cm"> * å¦‚æœä¿ç•™å¯¹è±¡çš„ä¿å­˜æ—¶é—´è¶…è¿‡å…¶é¢„æœŸçš„</span>
</span><span class='line'><span class="cm"> * ç”Ÿå‘½å‘¨æœŸï¼Œåˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚è¯·è°¨æ…é€‰æ‹©ä¿ç•™çš„æ•°æ®ç±»å‹ã€‚åˆ‡å‹¿ä¿ç•™ Android ä¸Šä¸‹æ–‡æˆ–</span>
</span><span class='line'><span class="cm"> * ç›´æ¥æˆ–é—´æ¥å¼•ç”¨ä¸Šä¸‹æ–‡ï¼ˆåŒ…æ‹¬è§†å›¾ï¼‰çš„å¯¹è±¡ã€‚</span>
</span><span class='line'><span class="cm"> */</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æµ‹è¯•ä¿ç•™æœºåˆ¶</h2>

<p>ä¸€ä¸ªæœ‰è¶£çš„<a href="https://github.com/androidx/androidx/blob/942319dfe9d751390febcef640d43290886f1a0b/compose/runtime/runtime-retain/src/commonTest/kotlin/androidx/compose/runtime/retain/RetainTests.kt#L866">å†…éƒ¨å•å…ƒæµ‹è¯•ç”¨ä¾‹</a> è¡¨æ˜ï¼Œè¯¥åº“å¯ä»¥å¤„ç†è¾¹ç¼˜æƒ…å†µå¹¶ä¿è¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">retain_duplicateRetainKeys</span><span class="p">()</span> <span class="p">=</span> <span class="n">compositionTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="n">ControlledRetainScope</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showContent</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">compose</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">showContent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// All have same key!</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Hide and show content</span>
</span><span class='line'>    <span class="n">showContent</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>    <span class="n">recomposeScope</span><span class="p">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span class='line'>    <span class="n">advance</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">showContent</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>    <span class="n">recomposeScope</span><span class="p">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span class='line'>    <span class="n">advance</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// All values correctly restored despite duplicate keys</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æµ‹è¯•éªŒè¯äº†å³ä½¿å­˜åœ¨é‡å¤çš„é”®ï¼ˆåœ¨å¾ªç¯æˆ–ç”Ÿæˆçš„å†…å®¹ä¸­å¾ˆå¸¸è§ï¼‰ï¼Œå€¼ä¹Ÿèƒ½é€šè¿‡åè¿›å…ˆå‡º (LIFO) é¡ºåºä¸å…¶ä¿ç•™è°ƒç”¨æ­£ç¡®é…å¯¹ã€‚</p>

<h2>ç»“è®º</h2>

<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¢ç´¢äº† <code>retain{}</code>ã€<code>RetainScope</code>ã€<code>RetainObserver</code> å’Œ <code>RetainedEffect</code> API çš„å·¥ä½œåŸç†åŠå…¶å†…éƒ¨æœºåˆ¶ã€‚äº†è§£è¿™äº›å†…éƒ¨æœºåˆ¶æœ‰åŠ©äºæˆ‘ä»¬æ›´å¥½åœ°å†³å®šä½•æ—¶ä½¿ç”¨ <code>retain{}</code>ã€<code>remember{}</code> å’Œ <code>rememberSaveable{}</code>ï¼Œå¦‚ä½•æ„å»ºä¿ç•™èµ„æºï¼Œä»¥åŠé¢„æœŸçš„æ€§èƒ½ç‰¹å¾ã€‚</p>

<p>æ— è®ºæ˜¯æ„å»ºå¯æ—‹è½¬çš„è§†é¢‘æ’­æ”¾å™¨ã€ä¿ç•™æ»šåŠ¨ä½ç½®çš„å¯¼èˆªç³»ç»Ÿï¼Œè¿˜æ˜¯åœ¨é…ç½®æ›´æ”¹åä¿æŒçŠ¶æ€çš„å¤æ‚è¡¨å•ï¼Œ<code>retain{}</code> éƒ½èƒ½åœ¨ Jetpack Compose ä¸­æä¾›åŸºäºä½œç”¨åŸŸçš„çŠ¶æ€ä¿å­˜åŠŸèƒ½ã€‚</p>

<p>å¦‚æœä½ æƒ³äº†è§£æœ€æ–°çš„æŠ€èƒ½ã€æ–°é—»ã€æŠ€æœ¯æ–‡ç« ã€é¢è¯•é—®é¢˜å’Œå®ç”¨ä»£ç æŠ€å·§ï¼Œè¯·æŸ¥çœ‹ <a href="https://github.com/doveletter/">Dove Letter</a>ã€‚å¦‚æœä½ æƒ³æ·±å…¥äº†è§£é¢è¯•å‡†å¤‡ï¼Œåƒä¸‡ä¸è¦é”™è¿‡ç»ˆæ Android é¢è¯•æŒ‡å—ï¼š<a href="https://www.android.skydoves.me/">Manifest Android Interview</a>ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kotlinäº’æ–¥é”(Mutex)ï¼šåç¨‹çš„çº¿ç¨‹å®‰å…¨å®ˆæŠ¤ç¥]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex/"/>
    <updated>2025-10-15T15:05:51+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒKotlin Mutex: Thread-Safe Concurrency for Coroutinesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://carrion.dev/en/posts/kotlin-mutex-concurrency-guide/">https://carrion.dev/en/posts/kotlin-mutex-concurrency-guide/</a>ï¼Œç”±Ignacio CarriÃ³nå‘å¸ƒäº2025å¹´10æœˆ3æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex/"><img src="file:///Users/alexhilton/Downloads/kotlin_mutex.webp" title="auto auto" ></a></p>

<!-- more -->


<p>ä½¿ç”¨ Kotlin åç¨‹æ„å»ºå¹¶å‘åº”ç”¨ç¨‹åºæ—¶ï¼Œä¿æŠ¤å…±äº«çš„å¯å˜çŠ¶æ€è‡³å…³é‡è¦ã€‚è™½ç„¶ä¼ ç»Ÿçš„ Java åŒæ­¥å·¥å…·ï¼ˆä¾‹å¦‚ <code>synchronized</code> å—å’Œ <code>ReentrantLock</code>ï¼‰å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†å®ƒä»¬ä¼šé˜»å¡çº¿ç¨‹ï¼Œå¹¶ä¸”ä¸åç¨‹çš„æŒ‚èµ·æ¨¡å‹ä¸å…¼å®¹ã€‚å› æ­¤ï¼Œå¼•å…¥ <code>Mutex</code>â€”â€”ä¸€ä¸ªåç¨‹å‹å¥½çš„åŒæ­¥åŸè¯­ï¼Œå®ƒæä¾›äº’æ–¥è€Œä¸é˜»å¡çº¿ç¨‹ã€‚</p>

<p>æœ¬æŒ‡å—æ¢è®¨äº†ä½•æ—¶ä½¿ç”¨ Mutexã€æœ€ä½³å®è·µä»¥åŠå®ƒä¸å…¶ä»–å¹¶å‘æ§åˆ¶æœºåˆ¶çš„æ¯”è¾ƒã€‚</p>

<h2>TL;DRï¼šçœæµç‰ˆæœ¬çš„å»ºè®®</h2>

<ul>
<li>å½“éœ€è¦ä¿æŠ¤å¤šä¸ªåç¨‹è®¿é—®çš„å…±äº«å¯å˜çŠ¶æ€æ—¶ï¼Œè¯·ä½¿ç”¨ <code>Mutex</code>ã€‚</li>
<li>åœ¨åç¨‹ä»£ç ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨ <code>Mutex</code> è€Œä¸æ˜¯ <code>synchronized</code>ï¼Œä»¥é¿å…é˜»å¡çº¿ç¨‹ã€‚</li>
<li>ä½¿ç”¨ <code>mutex.withLock { }</code> è‡ªåŠ¨è·å–å’Œé‡Šæ”¾é”ã€‚</li>
<li>å¯¹äºæ›´å¤æ‚çš„çŠ¶æ€ç®¡ç†åœºæ™¯ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ <code>Actor</code> æˆ– <code>StateFlow</code>ã€‚</li>
<li>å¯¹äºç®€å•çš„è®¡æ•°å™¨ï¼Œè¯·æ”¹ç”¨ <code>AtomicInteger</code> æˆ– <code>AtomicReference</code>ã€‚</li>
<li>å¦‚æœéœ€è¦å°†å¹¶å‘è®¿é—®é™åˆ¶ä¸ºå¤šä¸ªè®¸å¯ï¼Œè¯·ä½¿ç”¨ <code>Semaphore</code>ã€‚</li>
<li>å¦‚æœä¸ä½¿ç”¨ <code>withLock</code>ï¼Œè¯·å§‹ç»ˆåœ¨ finally å—ä¸­é‡Šæ”¾é”ã€‚</li>
</ul>


<h2>ä»€ä¹ˆæ˜¯äº’æ–¥é”ï¼Ÿ</h2>

<p><code>Mutex</code>ï¼ˆäº’æ–¥ï¼‰æ˜¯ <code>kotlinx.coroutines</code> ä¸­çš„åŒæ­¥åŸè¯­ï¼Œç”¨äºç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåç¨‹å¯ä»¥æ‰§è¡Œä¸´ç•ŒåŒºã€‚ä¸é˜»å¡çº¿ç¨‹çš„ä¼ ç»Ÿé”ä¸åŒï¼ŒMutex ä¼šæš‚åœåç¨‹ï¼Œä»è€Œä½¿çº¿ç¨‹å¯ä»¥è‡ªç”±åœ°æ‰§è¡Œå…¶ä»–å·¥ä½œã€‚</p>

<p>åŸºæœ¬ç»“æ„ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.sync.Mutex</span>
</span><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.sync.withLock</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">protectedOperation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Critical section - only one coroutine at a time</span>
</span><span class='line'>        <span class="c1">// Modify shared state safely here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…³é”®ç‰¹æ€§ï¼š</p>

<ul>
<li>éé˜»å¡ï¼šæš‚åœåç¨‹è€Œä¸æ˜¯é˜»å¡çº¿ç¨‹</li>
<li>å…¬å¹³ï¼šé»˜è®¤æŒ‰å…ˆè¿›å…ˆå‡ºé¡ºåºæˆäºˆè®¿é—®æƒé™</li>
<li>ä¸é‡å…¥å®‰å…¨ï¼šæŒæœ‰é”çš„åç¨‹æ— æ³•å†æ¬¡è·å–é”ï¼ˆé˜²æ­¢æ­»é”ï¼‰</li>
<li>è½»é‡çº§ï¼šæ¯”çº¿ç¨‹é˜»å¡é”æ›´é«˜æ•ˆ</li>
</ul>


<h2>äº’æ–¥é”çš„æ ¸å¿ƒç”¨ä¾‹</h2>

<p>æœ€å¸¸è§çš„ç”¨ä¾‹â€”â€”ç¡®ä¿å¯¹å…±äº«å˜é‡çš„å®‰å…¨è®¿é—®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">CounterService</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">++</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getCount</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. åè°ƒèµ„æºè®¿é—®</h3>

<p>å½“å¤šä¸ªåç¨‹éœ€è¦å¯¹æŸä¸ªèµ„æºè¿›è¡Œç‹¬å è®¿é—®æ—¶ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">FileWriter</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">file</span><span class="p">:</span> <span class="n">File</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">appendLine</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">file</span><span class="p">.</span><span class="n">appendText</span><span class="p">(</span><span class="s">&quot;$line\n&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3.ç¡®ä¿é¡ºåºæ‰§è¡Œ</h3>

<p>å³ä½¿æ“ä½œæ˜¯å¹¶å‘è§¦å‘çš„ï¼Œä¹Ÿå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">OrderProcessor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">orders</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">processOrder</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Ensure orders are processed sequentially</span>
</span><span class='line'>            <span class="n">orders</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>            <span class="n">validateOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>            <span class="n">persistOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–</h3>

<p>åœ¨æŒ‚èµ·ä¸Šä¸‹æ–‡ä¸­å®ç°çº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿåˆå§‹åŒ–ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DatabaseConnection</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getConnection</span><span class="p">():</span> <span class="n">Connection</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">connection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">connection</span><span class="o">!!</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Double-check inside lock</span>
</span><span class='line'>            <span class="n">connection</span> <span class="o">?:</span> <span class="n">createConnection</span><span class="p">().</span><span class="n">also</span> <span class="p">{</span> <span class="n">connection</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">createConnection</span><span class="p">():</span> <span class="n">Connection</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="c1">// Simulate connection setup</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Connection</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æœ€ä½³å®è·µ</h2>

<h3>1. å§‹ç»ˆä½¿ç”¨ withLock</h3>

<p>å³ä½¿å‘ç”Ÿå¼‚å¸¸ï¼ŒwithLock ä¹Ÿä¼šè‡ªåŠ¨å¤„ç†é”çš„è·å–å’Œé‡Šæ”¾ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âœ… Good: Automatic cleanup</span>
</span><span class='line'><span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dangerousOperation</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âŒ Bad: Manual management, error-prone</span>
</span><span class='line'><span class="n">mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
</span><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dangerousOperation</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. ä¿æŒä¸´ç•ŒåŒºè¾ƒå°</h3>

<p>å°½é‡å‡å°‘é”çš„æŒæœ‰æ—¶é—´ä»¥å‡å°‘äº‰ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âœ… Good: Lock only for critical section</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">validated</span> <span class="p">=</span> <span class="n">validateName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">// Outside lock</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userCache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">validated</span> <span class="c1">// Only this needs protection</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">notifyObservers</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span> <span class="c1">// Outside lock</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âŒ Bad: Holding lock during slow operations</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUserSlow</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">validated</span> <span class="p">=</span> <span class="n">validateName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">// Slow operation inside lock</span>
</span><span class='line'>        <span class="n">userCache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">validated</span>
</span><span class='line'>        <span class="n">notifyObservers</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span> <span class="c1">// I/O inside lock</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. é¿å…åµŒå¥—é”</h3>

<p>äº’æ–¥é”ä¸å¯é‡å…¥ã€‚é¿å…ä¸¤æ¬¡è·å–åŒä¸€ä¸ªé”ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âŒ Bad: Deadlock!</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">problematic</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">helperFunction</span><span class="p">()</span> <span class="c1">// Tries to acquire mutex again</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">helperFunction</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Will suspend forever</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âœ… Good: Restructure to avoid nesting</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">better</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">helperFunctionUnsafe</span><span class="p">()</span> <span class="c1">// No lock acquisition</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">helperFunctionUnsafe</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Assumes caller holds lock</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. ä¼˜å…ˆè€ƒè™‘æ— é”æ›¿ä»£æ–¹æ¡ˆ</h3>

<p>å¯¹äºç®€å•æ“ä½œï¼ŒåŸå­ç±»å‹é€Ÿåº¦æ›´å¿«ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âœ… Better for simple counters</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">()</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âŒ Overkill for a simple counter</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">counter</span><span class="p">++</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5.æ–‡æ¡£é”ä¸å˜é‡</h3>

<p>æ˜ç¡®é”ä¿æŠ¤çš„å¯¹è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserCache</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span> <span class="c1">// Protects userMap and lastUpdate</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">userMap</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">lastUpdate</span> <span class="p">=</span> <span class="m">0L</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">userMap</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="n">lastUpdate</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>äº’æ–¥é” vs. å…¶ä»–åŒæ­¥æ–¹æ³•</h2>

<h3>äº’æ–¥é” vs. synchronized</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Traditional synchronized (blocks thread)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SynchronizedCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">count</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Synchronized</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">count</span><span class="p">++</span> <span class="c1">// Thread blocked while waiting</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Mutex (suspends coroutine)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">count</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">count</span><span class="p">++</span> <span class="c1">// Coroutine suspended, thread free</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ä½•æ—¶è¯¥ç”¨å“ªä¸ªï¼š</strong></p>

<ul>
<li>å¯¹äºéæš‚åœä»£ç å’Œæ—§ç‰ˆ Java äº’æ“ä½œï¼Œè¯·ä½¿ç”¨ <code>synchronized</code></li>
<li>å¯¹äºæš‚åœå‡½æ•°å’ŒåŸºäºåç¨‹çš„ä»£ç ï¼Œè¯·ä½¿ç”¨ <code>Mutex</code></li>
<li>åœ¨åç¨‹ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>Mutex</code> æ•ˆç‡æ›´é«˜ï¼Œå› ä¸ºçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡</li>
</ul>


<h3>äº’æ–¥é” vs. ä¿¡å·é‡</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Only one coroutine at a time</span>
</span><span class='line'><span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Semaphore: N coroutines at a time</span>
</span><span class='line'><span class="k">val</span> <span class="py">semaphore</span> <span class="p">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="n">permits</span> <span class="p">=</span> <span class="m">3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Example: Rate limiting API calls</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ApiClient</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">semaphore</span> <span class="p">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">5</span><span class="p">)</span> <span class="c1">// Max 5 concurrent requests</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">makeRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">semaphore</span><span class="p">.</span><span class="n">withPermit</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ä½•æ—¶ä½¿ç”¨è°ï¼š</strong></p>

<ul>
<li>éœ€è¦ç‹¬å è®¿é—®ï¼ˆå•æ¬¡è®¸å¯ï¼‰æ—¶ä½¿ç”¨ <code>Mutex</code></li>
<li>éœ€è¦å°†å¹¶å‘é™åˆ¶ä¸º N ä¸ªæ“ä½œæ—¶ä½¿ç”¨ <code>Semaphore</code></li>
</ul>


<h3>äº’æ–¥é” vs. Actor</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Manual synchronization</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexBasedCache</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">=</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">value</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Actor: Message-based synchronization</span>
</span><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">CacheMessage</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">response</span><span class="p">:</span> <span class="n">CompletableDeferred</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">?&gt;)</span> <span class="p">:</span> <span class="n">CacheMessage</span><span class="p">()</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Put</span><span class="p">(</span><span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">:</span> <span class="n">CacheMessage</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">CoroutineScope</span><span class="p">.</span><span class="n">cacheActor</span><span class="p">()</span> <span class="p">=</span> <span class="n">actor</span><span class="p">&lt;</span><span class="n">CacheMessage</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">msg</span> <span class="k">in</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">Get</span> <span class="p">-&gt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">key</span><span class="p">])</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">Put</span> <span class="p">-&gt;</span> <span class="n">cache</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ä½•æ—¶ä½¿ç”¨è°ï¼š</strong></p>

<ul>
<li>ä½¿ç”¨ <code>Mutex</code> è¿›è¡Œç›´æ¥æ–¹æ³•è°ƒç”¨çš„ç®€å•åŒæ­¥</li>
<li>å¯¹äºå¤æ‚çš„çŠ¶æ€æœºæˆ–éœ€è¦æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä½¿ç”¨ <code>Actor</code></li>
<li>Actor æä¾›æ›´å¥½çš„å°è£…æ€§ï¼Œå¹¶ä¸”å¯ä»¥å¤„ç†èƒŒå‹</li>
</ul>


<h3>Mutex ä¸ StateFlow</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Imperative state management</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">state</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">state</span> <span class="p">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// StateFlow: Reactive state management</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FlowState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_state</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span> <span class="c1">// Thread-safe built-in</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ä½•æ—¶ä½¿ç”¨å“ªä¸ªï¼š</strong></p>

<ul>
<li>éœ€è¦è‡ªå®šä¹‰åŒæ­¥é€»è¾‘æ—¶ä½¿ç”¨ <code>Mutex</code></li>
<li>ä½¿ç”¨ <code>StateFlow</code> è¿›è¡Œå†…ç½®çº¿ç¨‹å®‰å…¨çš„å¯è§‚å¯ŸçŠ¶æ€</li>
<li><code>StateFlow</code> æ›´é€‚åˆ UI çŠ¶æ€å’Œå“åº”å¼æ¶æ„</li>
</ul>


<h3>Mutex ä¸åŸå­ç±»å‹</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// AtomicInteger: Lock-free for simple operations</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">()</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">addAndGet</span><span class="p">(</span><span class="n">delta</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">addAndGet</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Mutex: For complex operations</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ComplexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">history</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">++</span>
</span><span class='line'>            <span class="n">history</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="c1">// Multiple operations</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ä½•æ—¶ä½¿ç”¨å“ªä¸ªï¼š</strong></p>

<ul>
<li>ä½¿ç”¨åŸå­ç±»å‹è¿›è¡Œå•å˜é‡æ“ä½œï¼ˆè®¡æ•°å™¨ã€æ ‡å¿—ï¼‰</li>
<li>éœ€è¦åè°ƒå¤šä¸ªå˜é‡æ—¶ä½¿ç”¨ <code>Mutex</code></li>
<li>åŸå­æ“ä½œé€Ÿåº¦æ›´å¿«ï¼Œä½†å—é™äºç‰¹å®šæ“ä½œ</li>
</ul>


<h2>å¸¸è§é™·é˜±</h2>

<h3>1. å¿˜è®°ä½¿ç”¨ suspend</h3>

<p>äº’æ–¥æ“ä½œéœ€è¦æš‚åœï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âŒ Won&#39;t compile</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">broken</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="p">}</span> <span class="c1">// Error: suspend function called in non-suspend context</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âœ… Correct</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">correct</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. é•¿æ—¶é—´æ“ä½œæœŸé—´æŒæœ‰é”</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âŒ Bad: Holding lock during I/O</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">bad</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="c1">// Network call inside lock</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âœ… Good: Fetch outside lock</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">good</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. å‡è®¾å¯é‡å…¥</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âŒ Deadlock: Mutex is not reentrant</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">outer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">inner</span><span class="p">()</span> <span class="c1">// Deadlock!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">inner</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Never reached</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. ä¸å¤„ç†å–æ¶ˆ</h3>

<p>æŒæœ‰é”æ—¶åŠ¡å¿…è€ƒè™‘å–æ¶ˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// âœ… Good: withLock handles cancellation</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">proper</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doWork</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span> <span class="c1">// Lock released even on cancellation</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// âŒ Risky: Manual lock management</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">risky</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doWork</span><span class="p">()</span> <span class="c1">// If cancelled here, lock stays acquired</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ€§èƒ½è€ƒé‡</h2>

<ul>
<li><strong>äº’æ–¥ vs. synchronized</strong>ï¼šåœ¨åç¨‹å¯†é›†å‹ä»£ç ä¸­ï¼Œäº’æ–¥æ›´é«˜æ•ˆï¼Œå› ä¸ºçº¿ç¨‹ä¸ä¼šè¢«é˜»å¡</li>
<li><strong>äº‰ç”¨</strong>ï¼šé«˜äº‰ç”¨ä¼šé™ä½æ€§èƒ½ï¼›è€ƒè™‘åˆ†ç‰‡ï¼ˆä¸ºä¸åŒçš„é”®è®¾ç½®å¤šä¸ªé”ï¼‰</li>
<li><strong>é”ç²’åº¦</strong>ï¼šæ›´ç»†ç²’åº¦çš„é”ï¼ˆæ›´å¤šé”ï¼Œæ¯ä¸ªé”ä¿æŠ¤æ›´å°‘çš„æ•°æ®ï¼‰å¯å‡å°‘äº‰ç”¨</li>
<li><strong>æ— é”æ›¿ä»£æ–¹æ¡ˆ</strong>ï¼šå¯¹äºç®€å•æ“ä½œï¼ŒåŸå­ç±»å‹å’Œ <code>StateFlow</code> é€Ÿåº¦æ›´å¿«</li>
</ul>


<p>ç¤ºä¾‹ï¼šåˆ†ç‰‡ä»¥å‡å°‘äº‰ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">ShardedCache</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">shardCount</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutexes</span> <span class="p">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">shardCount</span><span class="p">)</span> <span class="p">{</span> <span class="n">Mutex</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">caches</span> <span class="p">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">shardCount</span><span class="p">)</span> <span class="p">{</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">key</span><span class="p">.</span><span class="n">hashCode</span><span class="p">()</span> <span class="n">and</span> <span class="p">(</span><span class="n">shardCount</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">index</span> <span class="p">=</span> <span class="n">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="n">mutexes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">caches</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">value</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Data</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">index</span> <span class="p">=</span> <span class="n">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutexes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">caches</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>çœŸå®ç¤ºä¾‹ï¼šçº¿ç¨‹å®‰å…¨çš„Repository</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserRepository</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">api</span><span class="p">:</span> <span class="n">UserApi</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">database</span><span class="p">:</span> <span class="n">UserDatabase</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Check cache first (read lock)</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="k">return</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Try database (outside lock)</span>
</span><span class='line'>        <span class="n">database</span><span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">user</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Fetch from API (outside lock)</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">fetchUser</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
</span><span class='line'>            <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>                <span class="n">database</span><span class="p">.</span><span class="n">insertUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">user</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">null</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="n">database</span><span class="p">.</span><span class="n">updateUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearCache</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æµ‹è¯•äº’æ–¥é”ä¿æŠ¤çš„ä»£ç </h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">concurrent</span> <span class="n">increments</span> <span class="n">should</span> <span class="n">be</span> <span class="n">thread</span><span class="p">-</span><span class="n">safe</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">CounterService</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Launch 1000 concurrent increments</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">jobs</span> <span class="p">=</span> <span class="n">List</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jobs</span><span class="p">.</span><span class="n">joinAll</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Should be exactly 1000</span>
</span><span class='line'>    <span class="n">assertEquals</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">counter</span><span class="p">.</span><span class="n">getCount</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">mutex</span> <span class="n">prevents</span> <span class="n">race</span> <span class="n">conditions</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Simulate race condition</span>
</span><span class='line'>    <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">val</span> <span class="py">current</span> <span class="p">=</span> <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">]</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>                    <span class="n">delay</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c1">// Simulate work</span>
</span><span class='line'>                    <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">current</span> <span class="p">+</span> <span class="m">1</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertEquals</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ€»ç»“</h2>

<p><code>Mutex</code> æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œç”¨äºåœ¨åŸºäºåç¨‹çš„åº”ç”¨ç¨‹åºä¸­ä¿æŠ¤å…±äº«å¯å˜çŠ¶æ€ã€‚å®ƒæä¾›çº¿ç¨‹å®‰å…¨çš„åŒæ­¥ï¼Œè€Œä¸ä¼šé˜»å¡çº¿ç¨‹ï¼Œä½¿å…¶æˆä¸ºå¹¶å‘åç¨‹ä»£ç çš„ç†æƒ³é€‰æ‹©ã€‚</p>

<p><strong>å…³é”®è¦ç‚¹</strong>ï¼š</p>

<ul>
<li>ä½¿ç”¨ <code>withLock</code> è¿›è¡Œè‡ªåŠ¨é”ç®¡ç†</li>
<li>ä¿æŒä¸´ç•ŒåŒºç®€æ´é«˜æ•ˆ</li>
<li>é€‚å½“æ—¶è€ƒè™‘æ›´ç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼ˆä¾‹å¦‚åŸå­æ“ä½œã€StateFlowï¼‰</li>
<li>äº†è§£ä½•æ—¶ä½¿ç”¨ Mutex è€Œéå…¶ä»–åŒæ­¥åŸè¯­</li>
<li>å§‹ç»ˆå¦¥å–„å¤„ç†å–æ¶ˆæ“ä½œ</li>
</ul>


<p>è®°ä½ï¼šæœ€å¥½çš„åŒæ­¥å°±æ˜¯æ²¡æœ‰åŒæ­¥ã€‚å°½å¯èƒ½åœ°ï¼Œè®¾è®¡ç³»ç»Ÿæ—¶ï¼Œé€šè¿‡ä½¿ç”¨ä¸å¯å˜æ•°æ®ç»“æ„ã€æ¶ˆæ¯ä¼ é€’ï¼ˆActors/Channelsï¼‰æˆ–å“åº”å¼æµï¼ˆFlow/StateFlowï¼‰æ¥å®Œå…¨é¿å…å…±äº«å¯å˜çŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå½“ä½ åœ¨åç¨‹ä»£ç ä¸­ç¡®å®éœ€è¦äº’æ–¥æ—¶ï¼Œ<code>Mutex</code> æ˜¯ä½ çš„æœ€ä½³é€‰æ‹©ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[çªç ´é€Ÿåº¦éšœç¢ï¼šéé˜»å¡å¯åŠ¨ç”»é¢å¦‚ä½•å°†Android åº”ç”¨å¯åŠ¨æ—¶é—´ç¼©çŸ­90%]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash/"/>
    <updated>2025-10-14T14:41:32+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒBreaking the Speed Barrier: How Non-Blocking Splash Screens Cut Android App Launch Time by 90%ã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90">https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90</a>ï¼Œç”±Sankalp Chauhanå‘å¸ƒäº2025å¹´9æœˆ28æ—¥ã€‚</p></blockquote>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#overview">æ¦‚è¿°</a></h2>

<p>æ­£å€¼ä½³èŠ‚æœŸé—´ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªåº”ç”¨ä¸Šéƒ½èƒ½çœ‹åˆ°ç²¾ç¾çš„å¯åŠ¨ç”»é¢å’Œè‡ªå®šä¹‰å¾½æ ‡ã€‚åœ¨å¼€å‘è¿™äº›åº”ç”¨æ—¶ï¼Œæ¯ä¸ª Android å¼€å‘è€…éƒ½ä¼šé¢ä¸´å¯åŠ¨ç”»é¢çš„å›°å¢ƒï¼šç”¨æˆ·æœŸæœ›è·å¾—ç¾è§‚ä¸”å“ç‰ŒåŒ–çš„å¯åŠ¨ä½“éªŒï¼Œä½† Google åŸç”Ÿçš„å¯åŠ¨ç”»é¢ API å´å­˜åœ¨æ˜æ˜¾çš„å±€é™æ€§ã€‚åˆ›å»ºè‡ªå®šä¹‰ <strong>SplashActivity</strong> çš„å¸¸è§è§£å†³æ–¹æ¡ˆçœ‹ä¼¼åˆç†ï¼Œä½†å´ä¼šå¼•å…¥éšè—çš„æ€§èƒ½æŸå¤±ï¼Œå¯¼è‡´åº”ç”¨è¿è¡Œç¼“æ…¢ä¸”å“åº”è¿Ÿé’ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash/"><img src="https://sankalpchauhan.com/2db6f13d4b8881938f2fccacd47ff90b/untitled-design-1-.mp4.gif" title="auto auto" ></a></p>

<!-- more -->


<p>ä¸ºäº†åº”å¯¹è¿™ä¸€æŒ‘æˆ˜ï¼Œæˆ‘å¼€å‘äº†ä¸€ä¸ªåä¸º<strong>EventSplash</strong>çš„æµ‹è¯•åº“ï¼Œè¯¥åº“å®ç°äº†ä¸€ç§éé˜»å¡å¯åŠ¨ç”»é¢æ–¹æ³•ã€‚å®Œæ•´çš„å®ç°å’ŒåŸºå‡†æµ‹è¯•ä»£ç å¯åœ¨ GitHub ä¸Šè·å–ï¼š<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment">fast-splash-experiment</a>ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E3%80%82">https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E3%80%82</a></p>

<p>æœ¬æ¡ˆä¾‹ç ”ç©¶é€šè¿‡ä¸€é¡¹å¯¹ç…§å®éªŒï¼Œæ¯”è¾ƒäº†ä¼ ç»Ÿçš„åŸºäºæ´»åŠ¨çš„å¯åŠ¨ç”»é¢å’Œåˆ›æ–°çš„åŸºäºè§†å›¾çš„å¯åŠ¨ç”»é¢æ–¹æ³•ï¼Œå¹¶æä¾›äº†å®è¯è¯æ®ã€‚ä½¿ç”¨<strong>ä¿å®ˆçš„åŒç±»æ¯”è¾ƒ</strong>ï¼Œç»“æœæ˜¾ç¤ºï¼š<strong>é¡µé¢åŠ è½½æ—¶é—´ç¼©çŸ­ 90%</strong>ï¼Œ<strong>é¦–æ¬¡å†…å®¹ç»˜åˆ¶æ—¶é—´æå‡ 78%</strong>ï¼Œ<strong>å®Œå…¨ç»˜åˆ¶æ—¶é—´ç¼©çŸ­ 41%</strong>ã€‚</p>

<p>æˆ‘ä»¬å°†æ¢ç´¢ Lottie ç­‰å¤æ‚åŠ¨ç”»å¯èƒ½å¸¦æ¥çš„æ˜¾è‘—ä¼˜åŠ¿ï¼ŒåŒæ—¶æ˜ç¡®å¹¶å‘å¤„ç†çš„åˆ©å¼Šæƒè¡¡å’Œèµ„æºæˆæœ¬ã€‚</p>

<ul>
<li><strong>é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP)</strong>ï¼šå±å¹•ä¸Šå‡ºç°ç¬¬ä¸€ä¸ªæœ‰æ„ä¹‰å†…å®¹çš„æ—¶é—´</li>
<li><strong>å®Œå…¨ç»˜åˆ¶æ—¶é—´ (FPT)</strong>ï¼šå±å¹•å®Œå…¨æ¸²æŸ“å¹¶å¯äº¤äº’çš„æ—¶é—´</li>
<li><strong>å†·å¯åŠ¨</strong>ï¼šåº”ç”¨åœ¨è¿›ç¨‹æœªè¿è¡Œæ—¶å¯åŠ¨ï¼ˆæ€§èƒ½å½±å“æœ€å¤§ï¼‰</li>
<li><strong>å¡é¡¿</strong>ï¼šç”¨æˆ·è®¤ä¸ºæ€§èƒ½ä¸ä½³çš„å¡é¡¿æˆ–æ‰å¸§</li>
<li><strong>TTID/TTFD</strong>ï¼šåˆå§‹æ˜¾ç¤ºæ—¶é—´/å®Œå…¨ç»˜åˆ¶æ—¶é—´ï¼ˆAndroid å®˜æ–¹æŒ‡æ ‡ï¼‰</li>
<li><strong>å†…å­˜å‹åŠ›</strong>ï¼šå¯ç”¨å†…å­˜æä½æ—¶çš„ç³»ç»ŸçŠ¶æ€</li>
<li><strong>ä½å†…å­˜ç»ˆæ­¢ç¨‹åº (LMK)</strong>ï¼šåœ¨å†…å­˜å‹åŠ›ä¸‹ç»ˆæ­¢è¿›ç¨‹çš„ Android å®ˆæŠ¤è¿›ç¨‹</li>
<li><strong>Choreographer.doFrame</strong>ï¼šAndroid çš„å¸§åè°ƒç³»ç»Ÿï¼Œç”¨äºç®¡ç†åŠ¨ç”»ã€è¾“å…¥å’Œç»˜åˆ¶</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-problem-statement">é—®é¢˜å£°æ˜</a></h3>

<p>Google åŸç”Ÿçš„ Android 12+ SplashScreen API æ€§èƒ½å‡ºè‰²ï¼Œä½†è‡ªå®šä¹‰é€‰é¡¹æœ‰é™ <a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>ã€‚å®ƒä¸æ”¯æŒï¼š</p>

<ul>
<li>è§†é¢‘èƒŒæ™¯</li>
<li>Lottie åŠ¨ç”»</li>
<li>å¤æ‚çš„å“ç‰Œå…ƒç´ </li>
<li>ä¿ƒé”€/æ´»åŠ¨æœŸé—´çš„ä¿ƒé”€å†…å®¹</li>
<li>è‡ªå®šä¹‰è¿‡æ¸¡æ•ˆæœ</li>
</ul>


<p>è¿™è¿«ä½¿å¼€å‘è€…ä¸å¾—ä¸è¿›è¡Œè‡ªå®šä¹‰å®ç°ï¼Œé€šå¸¸ä½¿ç”¨ä¸“ç”¨çš„â€œSplashActivityâ€ã€‚è™½ç„¶è¿™ç§æ–¹æ³•æä¾›äº†åˆ›ä½œè‡ªç”±ï¼Œä½†å®ƒä¼šåˆ›å»ºä¸€ä¸ª<strong>é˜»å¡åºåˆ—</strong>ï¼Œä»è€Œå»¶è¿Ÿåº”ç”¨ä¸»å†…å®¹çš„æ˜¾ç¤ºã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-traditional-splash-activities-hurt-performance">ä¸ºä»€ä¹ˆä¼ ç»Ÿçš„é—ªå±æ´»åŠ¨ä¼šæŸå®³æ€§èƒ½</a></h3>

<p>Android æ–‡æ¡£å¼ºè°ƒï¼Œåº”ç”¨åº”è¯¥é’ˆå¯¹å†·å¯åŠ¨è¿›è¡Œä¼˜åŒ–ï¼Œå› ä¸ºè¿™â€œä¹Ÿå¯ä»¥æé«˜æ¸©å¯åŠ¨å’Œçƒ­å¯åŠ¨çš„æ€§èƒ½â€<a href="https://developer.android.com/topic/performance/vitals/launch-time">[2]</a>ã€‚ç„¶è€Œï¼Œä¼ ç»Ÿçš„é—ªå±å®ç°æ–¹å¼è¿èƒŒäº†è¿™ä¸€åŸåˆ™ã€‚</p>

<p>å½“ä½ ä½¿ç”¨å•ç‹¬çš„â€œSplashActivityâ€æ—¶ï¼Œç³»ç»Ÿå¿…é¡»ï¼š</p>

<ol>
<li>åˆ›å»ºå¹¶åˆå§‹åŒ–å¯åŠ¨ç”»é¢ Activity</li>
<li>æ‰©å±•å¯åŠ¨ç”»é¢è§†å›¾</li>
<li>è¿è¡Œå¯åŠ¨ç”»é¢åŠ¨ç”»ç›´è‡³å®Œæˆ</li>
<li>é”€æ¯å¯åŠ¨ç”»é¢ Activity</li>
<li>åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸» Activity</li>
<li>æ‰©å±•ä¸»å†…å®¹è§†å›¾</li>
</ol>


<p>è¿™ç§é¡ºåºæµç¨‹æ„å‘³ç€ä½ çš„ä¸»å†…å®¹åœ¨å¯åŠ¨ç”»é¢å®Œæˆä¹‹å‰æ— æ³•å¼€å§‹åŠ è½½ï¼Œè¿™æ˜¯ä¸€ä¸ªå½±å“ç”¨æˆ·æ„ŸçŸ¥æ€§èƒ½çš„æ ¹æœ¬æ¶æ„ç¼ºé™·ã€‚</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-journey-exploring-different-approaches">æŠ˜è…¾ï¼šæ¢ç´¢ä¸åŒçš„æ–¹æ³•</a></h2>

<p>åœ¨æœ€ç»ˆç¡®å®š EventSplash å®ç°æ–¹æ¡ˆä¹‹å‰ï¼Œæˆ‘æ¢ç´¢äº†å‡ ç§æ–¹æ³•ã€‚äº†è§£è¿™äº›æ¢ç´¢ä¸ºæœ€ç»ˆçš„è®¾è®¡å†³ç­–æä¾›äº†å®è´µçš„èƒŒæ™¯ï¼Œå¹¶å±•ç¤ºäº†æ€§èƒ½ä¼˜åŒ–çš„è¿­ä»£æœ¬è´¨ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#discarded-approach-the-translucent-activity-overlay">å¼ƒç”¨çš„æ–¹æ³•ï¼šåŠé€æ˜ Activity è¦†ç›–</a></h3>

<p>æœ€åˆçš„æƒ³æ³•æ˜¯ä½¿ç”¨å¸¦æœ‰åŠé€æ˜ä¸»é¢˜çš„â€œSplashActivityâ€è¦†ç›–â€œMainActivityâ€ã€‚ç†è®ºä¸Šï¼ŒMainActivity å¯ä»¥åœ¨åå°åŠ è½½ï¼Œè€Œå¯åŠ¨ç”»é¢åˆ™æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢ã€‚</p>

<p><strong>å¯åŠ¨é¡ºåºï¼š</strong></p>

<ol>
<li>åº”ç”¨ä»¥å…·æœ‰åŠé€æ˜ä¸»é¢˜çš„ SplashActivity å¯åŠ¨</li>
<li>SplashActivity æ˜¾ç¤ºåœ¨ MainActivity ä¹‹ä¸Šï¼Œä½†ä¸ä¼šå®Œå…¨é®æŒ¡ MainActivity</li>
<li>çŸ­æš‚å»¶è¿Ÿæˆ–åˆå§‹åŒ–å®Œæˆåï¼ŒSplashActivity ç»“æŸï¼ŒMainActivity æ˜¾éœ²å‡ºæ¥</li>
</ol>


<p><strong>å¼ƒç”¨åŸå› ï¼š</strong></p>

<p>è¿™ç§æ–¹æ³•å¯¼è‡´<strong>14% çš„æ€§èƒ½ä¸‹é™</strong>ã€‚é—®é¢˜åœ¨äº Android å¤„ç† Activity ç”Ÿå‘½å‘¨æœŸå’Œæ¸²æŸ“çš„æ–¹å¼ã€‚ç³»ç»Ÿå¹¶éçœŸæ­£å¹¶è¡Œå¯åŠ¨ä¸¤ä¸ª Activityã€‚ç›¸åï¼Œå®ƒåˆ›å»ºäº†ä¸€ç§é¡ºåºä¾èµ–å…³ç³»ï¼ŒGPU è¢«è¿«ç»„åˆä¸¤ä¸ªç‹¬ç«‹çš„ Activity ç¼“å†²åŒºï¼Œè¿™ä¼šåœ¨ RAM å’Œç”µæ± æ–¹é¢é€ æˆå·¨å¤§çš„å¼€é”€ï¼Œæœ‰æ—¶ç”šè‡³ä¼šç¦ç”¨çª—å£è¿‡æ¸¡åŠ¨ç”»ã€‚</p>

<p>æ­£å¦‚ Android æ–‡æ¡£ä¸­å…³äºåŠé€æ˜ Activity çš„è¯´æ˜ <a href="https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iv-49946659b094">[3]</a>ï¼š</p>

<blockquote><p>â€œçª—å£ç®¡ç†å™¨ä¼šä¿æŒåŸå…ˆçš„å±å¹•è¡¨é¢æŒ‰ Z è½´é¡ºåºæ’åˆ—ï¼Œå¹¶å°†æ–°çš„å±å¹•è¡¨é¢æ··åˆåœ¨å…¶ä¸Šæ–¹ã€‚åŸå…ˆçš„ Activity ä»ç„¶å¯ä»¥é€šè¿‡æ–°çª—å£ä¸­ä»»ä½•é€æ˜æˆ–éƒ¨åˆ†é€æ˜çš„åƒç´ çœ‹åˆ°ã€‚â€</p></blockquote>

<p>æ­£æ˜¯è¿™ç§æ··åˆæ“ä½œå¯¼è‡´äº†æ€§èƒ½ä¸‹é™ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-winning-approach-the-gated-splash-screen-mechanism">åˆ¶èƒœä¹‹é“ï¼šé—¨æ§å¯åŠ¨ç”»é¢æœºåˆ¶</a></h3>

<p>æˆ‘æœ€ç»ˆæ‰¾åˆ°äº†ä¸€ç§æ›´å¤æ‚çš„æ–¹æ³•ï¼Œå®ƒé‡‡ç”¨äº†<strong>é—¨æ§å¯åŠ¨ç”»é¢æœºåˆ¶</strong>ã€‚æ­¤æ–¹æ³•ä½¿ç”¨â€œViewTreeObserver.OnPreDrawListenerâ€æ¥é˜»æ­¢æ‰€æœ‰ UI æ¸²æŸ“ï¼Œç›´åˆ°æ»¡è¶³ç‰¹å®šæ¡ä»¶ä¸ºæ­¢ã€‚</p>

<p><strong>å·¥ä½œåŸç†ï¼š</strong></p>

<ol>
<li>å¯åŠ¨æ—¶ï¼Œä¼šç«‹å³å°† <code>OnPreDrawListener</code> é™„åŠ åˆ° Activity çš„ <code>decorView</code> ä¸Šã€‚</li>
<li>ç›‘å¬å™¨çš„ <code>onPreDraw()</code> æ–¹æ³•è¿”å› <code>false</code>ï¼Œä»è€Œæœ‰æ•ˆé˜»æ­¢æ‰€æœ‰ç»˜åˆ¶æ“ä½œã€‚</li>
<li>ç›‘å¬å™¨ä»…åœ¨æ‰€æœ‰æ¡ä»¶éƒ½æ»¡è¶³æ—¶æ‰è¿”å› <code>true</code>ï¼Œå…è®¸å†…å®¹æ¸²æŸ“ã€‚</li>
</ol>


<p><strong>å…³é”®å®ç°ï¼š</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// The gate mechanism</span>
</span><span class='line'>
</span><span class='line'><span class="n">gate</span><span class="p">.</span><span class="n">onPreDraw</span><span class="p">()</span> <span class="err">â†’</span> <span class="n">returns</span> <span class="k">false</span> <span class="p">=</span> <span class="n">BLOCK</span> <span class="n">all</span> <span class="n">drawing</span>
</span><span class='line'>
</span><span class='line'><span class="n">gate</span><span class="p">.</span><span class="n">onPreDraw</span><span class="p">()</span> <span class="err">â†’</span> <span class="n">returns</span> <span class="k">true</span> <span class="p">=</span> <span class="n">ALLOW</span> <span class="n">drawing</span> <span class="n">to</span> <span class="n">proceed</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•å®Œå…¨ç¬¦åˆ Android å®˜æ–¹æ–‡æ¡£ä¸­å…³äºå»¶é•¿å¯åŠ¨ç”»é¢åœ¨å±å¹•ä¸Šåœç•™æ—¶é—´çš„å»ºè®® <a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>:</p>

<blockquote><p>â€œå¦‚æœä½ éœ€è¦åŠ è½½å°‘é‡æ•°æ®ï¼Œä¾‹å¦‚ä»æœ¬åœ°ç£ç›˜å¼‚æ­¥åŠ è½½åº”ç”¨å†…è®¾ç½®ï¼Œå¯ä»¥ä½¿ç”¨ ViewTreeObserver.OnPreDrawListener æš‚åœåº”ç”¨ä»¥ç»˜åˆ¶å…¶ç¬¬ä¸€å¸§ã€‚â€</p></blockquote>

<p>EventSplash åº“æ‰©å±•äº†è¿™ä¸€æ¦‚å¿µï¼Œåœ¨åº”ç”¨å¯åŠ¨æ—¶æä¾›å¯¹ç”¨æˆ·å¯è§å†…å®¹çš„å¸§å®Œç¾æ§åˆ¶ï¼Œé˜²æ­¢ä»»ä½•å†…å®¹é—ªçƒï¼Œç¡®ä¿æ— ç¼ä½“éªŒã€‚</p>

<p><img src="https://sankalpchauhan.com/static/6810168ee26fb4ae7c236e03fbdd71bc/e5715/view-hirearchy.png" alt="DecorView å°†åŒ…å«æˆ‘ä»¬çš„ SplashView å’Œ ContentView" /></p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-experiment-measuring-real-world-impact">å®éªŒï¼šæµ‹é‡å®é™…å½±å“</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#test-environment">æµ‹è¯•ç¯å¢ƒ</a></h3>

<ul>
<li><strong>è®¾å¤‡</strong>ï¼šå°ç±³ POCO F1ï¼ŒAndroid 10</li>
<li><strong>æ„å»º</strong>ï¼šå‘å¸ƒé…ç½®</li>
<li><strong>æ–¹æ³•</strong>ï¼šæ¯ä¸ªé…ç½® 35 æ¬¡å†·å¯åŠ¨ï¼Œæ¯æ¬¡è¿è¡Œä¹‹é—´æš‚åœ 2 ç§’</li>
<li><strong>æŒ‡æ ‡</strong>ï¼šè‡ªå®šä¹‰ PerfTracker åº“ï¼Œç”¨äºæµ‹é‡é¡µé¢åŠ è½½æ—¶é—´ã€FCP å’Œ FPT</li>
<li><strong>è„šæœ¬</strong>ï¼šé€šè¿‡ <code>perf_loop.sh</code> è‡ªåŠ¨æ‰§è¡Œå¯é‡å¤æ€§</li>
</ul>


<p>æ‰€æœ‰æµ‹è¯•ä»£ç å’Œè„šæœ¬å‡å¯åœ¨ <a href="https://github.com/sankalpchauhan-me/fast-splash-experiment">GitHub ä»£ç åº“</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E8%8E%B7%E5%8F%96%EF%BC%8C%E4%BB%A5%E7%A1%AE%E4%BF%9D%E5%8F%AF%E9%87%8D%E5%A4%8D%E6%80%A7%E3%80%82">https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E8%8E%B7%E5%8F%96%EF%BC%8C%E4%BB%A5%E7%A1%AE%E4%BF%9D%E5%8F%AF%E9%87%8D%E5%A4%8D%E6%80%A7%E3%80%82</a></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#implementation-approaches-tested">æµ‹è¯•çš„å®ç°æ–¹æ³•</a></h3>

<ol>
<li><strong>é»˜è®¤é˜»å¡é—ªå±</strong>ï¼šç®€å•çš„ <code>SplashActivity</code> å’ŒåŸºæœ¬è·¯ç”±ï¼ˆä¿å®ˆçš„åŸºå‡†ï¼‰</li>
<li><strong>é»˜è®¤éé˜»å¡é—ªå±</strong>ï¼šEventSplash åº“å’Œç®€å•çš„å åŠ å±‚</li>
<li><strong>Lottie é˜»å¡é—ªå±</strong>ï¼šä¼ ç»Ÿæ–¹æ³•å’Œå¤æ‚çš„åŠ¨ç”»</li>
<li><strong>Lottie éé˜»å¡é—ªå±</strong>ï¼šEventSplash ä¸ Lottie åŠ¨ç”»å¹¶è¡Œè¿è¡Œ</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#results-conservative-claims-with-dramatic-potential">ç»“æœï¼šä¿å®ˆçš„å£°æ˜ï¼Œä½†æ•ˆæœæ˜¾è‘—æ½œåŠ›</a></h2>

<p><img src="https://sankalpchauhan.com/static/b4c51a8a6d8ebb0f3f12161c0441e89d/e5715/performance_comparison.png" alt="æ€§èƒ½å¯¹æ¯”" /></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-honest-comparison-default-splash-performance">çœŸå®å¯¹æ¯”ï¼šé»˜è®¤é—ªå±æ€§èƒ½</a></h3>

<p>ä¸ºäº†è¿›è¡Œ<strong>åŒç±»æ¯”è¾ƒ</strong>ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨åœ¨é»˜è®¤çš„é—ªå±å®ç°ä¸­ï¼Œé˜»å¡æ–¹æ³•åªæ˜¯ç®€å•åœ°ä¸ºäº†è·¯ç”±ç›®çš„è€Œæ‰©å¤§ Activityï¼š</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> æ–¹æ³• </th>
<th style="text-align:center;"> é¡µé¢åŠ è½½æ—¶é—´ (æ¯«ç§’) </th>
<th style="text-align:center;"> FCP (æ¯«ç§’) </th>
<th style="text-align:center;"> FPT (æ¯«ç§’) </th>
<th style="text-align:center;"> ç”¨æˆ·å½±å“ </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> <strong>é»˜è®¤é˜»å¡</strong> </td>
<td style="text-align:center;"> 366 </td>
<td style="text-align:center;"> 744 </td>
<td style="text-align:center;"> 2,195 </td>
<td style="text-align:center;"> æ˜æ˜¾çš„å»¶è¿Ÿ </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>é»˜è®¤éé˜»å¡</strong> </td>
<td style="text-align:center;"> 37 </td>
<td style="text-align:center;"> 164 </td>
<td style="text-align:center;"> 1,295 </td>
<td style="text-align:center;"> æµç•…ã€å“åº”è¿…é€Ÿ </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>æå‡</strong> </td>
<td style="text-align:center;"> <strong>90%</strong> </td>
<td style="text-align:center;"> <strong>78%</strong> </td>
<td style="text-align:center;"> <strong>41%</strong> </td>
<td style="text-align:center;"> <strong>æ˜¾è‘—æå‡</strong> </td>
</tr>
</tbody>
</table>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-lottie-animation-advantage">Lottie åŠ¨ç”»çš„ä¼˜åŠ¿</a></h3>

<p>å½“æˆ‘ä»¬å¼•å…¥å¤æ‚çš„ Lottie åŠ¨ç”»æ—¶ï¼Œæ¶æ„ä¸Šçš„å·®å¼‚ä¼šæ›´åŠ æ˜æ˜¾å‘éŸ³ï¼š</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> æ–¹æ³• </th>
<th style="text-align:center;"> é¡µé¢åŠ è½½æ—¶é—´ (æ¯«ç§’) </th>
<th style="text-align:center;"> FCP (æ¯«ç§’) </th>
<th style="text-align:center;"> FPT (æ¯«ç§’) </th>
<th style="text-align:center;"> å¤‡æ³¨ </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> <strong>Lottie é˜»å¡</strong> </td>
<td style="text-align:center;"> 2,228 </td>
<td style="text-align:center;"> 2,347 </td>
<td style="text-align:center;"> 3,524 </td>
<td style="text-align:center;"> <em>åŒ…å«åŠ¨ç”»æ—¶é•¿</em> </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>Lottie éé˜»å¡</strong> </td>
<td style="text-align:center;"> 109 </td>
<td style="text-align:center;"> 312 </td>
<td style="text-align:center;"> 1,467 </td>
<td style="text-align:center;"> <em>åŠ¨ç”»å¹¶è¡Œè¿è¡Œ</em> </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>æå‡</strong> </td>
<td style="text-align:center;"> <strong>95%</strong> </td>
<td style="text-align:center;"> <strong>87%</strong> </td>
<td style="text-align:center;"> <strong>58%</strong> </td>
<td style="text-align:center;"> <strong>æ˜¾è‘—æå‡</strong> </td>
</tr>
</tbody>
</table>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#understanding-the-lottie-numbers">ç†è§£ Lottie æ•°å€¼</a></h3>

<p><strong>é‡è¦æç¤º</strong>ï¼šLottie é˜»å¡æ•°å€¼åœ¨è®¾è®¡ä¸ŠåŒ…å«åŠ¨ç”»æ—¶é•¿ï¼Œç”¨æˆ·å¿…é¡»ç­‰å¾…æ•´ä¸ªåŠ¨ç”»å®Œæˆåæ‰èƒ½çœ‹åˆ°ä»»ä½•ä¸»è¦å†…å®¹ã€‚åœ¨éé˜»å¡æ–¹æ³•ä¸­ï¼Œ<strong>åŠ¨ç”»å’Œå†…å®¹åŠ è½½å¹¶è¡Œè¿è¡Œ</strong>ï¼Œå› æ­¤å½“ Lottie åŠ¨ç”»å®Œæˆæ—¶ï¼ŒFPT é€šå¸¸å·²ç»å®Œæˆæˆ–æ¥è¿‘å®Œæˆã€‚</p>

<p>è¿™ç§å¹¶è¡Œæ‰§è¡Œæ˜¯å…¶å…³é”®çš„æ¶æ„ä¼˜åŠ¿ï¼š<strong>æ— éœ€ç‰ºç‰²æ€§èƒ½å³å¯è·å¾—ç²¾ç¾çš„åŠ¨ç”»</strong>ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#performance-improvements-breakdown">æ€§èƒ½æ”¹è¿›ç»†åˆ†</a></h3>

<p><img src="https://sankalpchauhan.com/static/620f7ce36b7f1d75840820adb257fa7f/e5715/improvement_chart.png" alt="æ”¹è¿›å›¾è¡¨" />
æ”¹è¿›å›¾è¡¨</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recap-what-happened">å›é¡¾ï¼šå‘ç”Ÿäº†ä»€ä¹ˆ</a></h3>

<p>å³ä½¿ä¸ä¿å®ˆçš„é»˜è®¤å¯åŠ¨ç”»é¢ç›¸æ¯”ï¼Œéé˜»å¡æ–¹æ³•ä¹Ÿå®ç°äº†<strong>90% çš„é¡µé¢åŠ è½½é€Ÿåº¦æå‡æ¬¡</strong>ã€‚ç”¨æˆ·ä½“éªŒä»â€œæ˜æ˜¾çš„å»¶è¿Ÿâ€è½¬å˜ä¸ºâ€œæµç•…ä¸”å“åº”è¿…é€Ÿâ€ã€‚</p>

<p>å¯¹äºåƒ Lottie è¿™æ ·çš„å¤æ‚åŠ¨ç”»ï¼Œå…¶ä¼˜åŠ¿æ›´åŠ æ˜¾è‘—ï¼Œå› ä¸ºä¼ ç»Ÿæ–¹æ³•è¿«ä½¿ç”¨æˆ·ç­‰å¾…æ•´ä¸ªåŠ¨ç”»åºåˆ—ï¼Œç„¶åæ‰ä¼šå‡ºç°ä»»ä½•æœ‰æ„ä¹‰çš„å†…å®¹ã€‚</p>

<p><img src="https://sankalpchauhan.com/6f6ac6fcfed426f343bb76cd31f4694e/comparison.mp4.gif" alt="æ—§ç”¨æˆ·ä½“éªŒä¸æ–°ç”¨æˆ·ä½“éªŒå¯¹æ¯”" /></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-the-technical-mechanism">åŸå› ï¼šæŠ€æœ¯æœºåˆ¶</a></h3>

<p>æ€§èƒ½æå‡æºäº<strong>å¹¶è¡Œæ‰§è¡Œ</strong>ã€‚ä¼ ç»Ÿæ–¹æ³•<strong>é¡ºåº</strong>è¿è¡Œå¯åŠ¨ç”»é¢å’Œä¸»å†…å®¹ï¼Œè€ŒåŸºäºè§†å›¾çš„æ–¹æ³•<strong>å¹¶å‘</strong>è¿è¡Œå®ƒä»¬ï¼š</p>

<p><strong>ä¼ ç»Ÿï¼ˆé¡ºåºï¼‰</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Splash</span> <span class="nt">Activity</span> <span class="err">â†’</span> <span class="nt">Animation</span> <span class="err">â†’</span> <span class="nt">Destroy</span> <span class="err">â†’</span> <span class="nt">Main</span> <span class="nt">Activity</span> <span class="err">â†’</span> <span class="nt">Content</span> <span class="nt">Load</span> <span class="err">â†’</span> <span class="nt">Display</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>éé˜»å¡ï¼ˆå¹¶è¡Œï¼‰</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Main</span> <span class="nt">Activity</span> <span class="o">+</span> <span class="nt">Content</span> <span class="nt">Load</span> <span class="o">(</span><span class="nt">background</span><span class="o">)</span>
</span><span class='line'>     <span class="err">â†“</span>
</span><span class='line'><span class="nt">Splash</span> <span class="nt">View</span> <span class="o">(</span><span class="nt">overlay</span><span class="o">)</span> <span class="err">â†’</span> <span class="nt">Remove</span> <span class="nt">overlay</span> <span class="err">â†’</span> <span class="nt">Display</span> <span class="nt">loaded</span> <span class="nt">content</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ¶æ„å·®å¼‚å½»åº•æ¶ˆé™¤äº†é˜»å¡ç“¶é¢ˆã€‚</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#deep-dive-understanding-the-technical-implementation">æ·±å…¥æ¢ç©¶ï¼šç†è§£æŠ€æœ¯å®ç°</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#traditional-splash-activity-implementation">ä¼ ç»Ÿçš„ Splash Activity å®ç°</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">SplashActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>        <span class="n">installSplashScreen</span><span class="p">()</span>
</span><span class='line'>        <span class="n">enableEdgeToEdge</span><span class="p">()</span>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Loader</span> <span class="p">{</span> <span class="c1">// Blocks until animation completes</span>
</span><span class='line'>                <span class="n">startActivity</span><span class="p">(</span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="n">@SplashActivity</span><span class="p">,</span> <span class="n">MainActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">Loader</span><span class="p">(</span><span class="n">onComplete</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">composition</span> <span class="k">by</span> <span class="n">rememberLottieComposition</span><span class="p">(</span><span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">RawRes</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sale_tags</span><span class="p">))</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">progress</span> <span class="k">by</span> <span class="n">animateLottieCompositionAsState</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Animation blocks main content loading</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="p">==</span> <span class="m">1.0f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">onComplete</span><span class="p">.</span><span class="n">invoke</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#event-splash-non-blocking-implementation">EventSplashï¼šéé˜»å¡å®ç°</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">EventSplash</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">activity</span><span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">config</span><span class="p">:</span> <span class="n">EventSplashConfig</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">decorView</span><span class="p">:</span> <span class="n">ViewGroup</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">decorView</span> <span class="k">as</span> <span class="n">ViewGroup</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">composeView</span><span class="p">:</span> <span class="n">ComposeView</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Gate prevents premature display until main content ready</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">gate</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">ViewTreeObserver</span><span class="p">.</span><span class="n">OnPreDrawListener</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onPreDraw</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">isReady</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">decorView</span><span class="p">.</span><span class="n">viewTreeObserver</span><span class="p">.</span><span class="n">removeOnPreDrawListener</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>                <span class="k">true</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">false</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">decorView</span><span class="p">.</span><span class="n">viewTreeObserver</span><span class="p">.</span><span class="n">addOnPreDrawListener</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
</span><span class='line'>        <span class="n">setupSplashCompose</span><span class="p">()</span> <span class="c1">// Non-blocking overlay</span>
</span><span class='line'>        <span class="n">isReady</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">setupSplashCompose</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">view</span> <span class="p">=</span> <span class="n">ComposeView</span><span class="p">(</span><span class="n">activity</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">layoutParams</span> <span class="p">=</span> <span class="n">ViewGroup</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="n">MATCH_PARENT</span><span class="p">,</span> <span class="n">MATCH_PARENT</span><span class="p">)</span>
</span><span class='line'>            <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">getProvider</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">Content</span><span class="p">(</span><span class="n">onFinish</span> <span class="p">=</span> <span class="p">{</span> <span class="n">dismiss</span><span class="p">()</span> <span class="p">})</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">composeView</span> <span class="p">=</span> <span class="n">view</span>
</span><span class='line'>        <span class="n">decorView</span><span class="p">.</span><span class="n">addView</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="c1">// Overlay on main content</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#usage-comparison">ä½¿ç”¨æƒ…å†µæ¯”è¾ƒ</a></h3>

<p><strong>ä¼ ç»Ÿæ–¹æ³•</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Requires separate activity, blocks main content</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Main content only loads after splash completes</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>EventSplash æ–¹æ³•</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Non-blocking: splash displays while content loads</span>
</span><span class='line'>        <span class="n">EventSplashApi</span><span class="p">.</span><span class="n">attachTo</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="n">with</span><span class="p">(</span><span class="n">getSaleConfig</span><span class="p">()).</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Main content loads immediately in parallel</span>
</span><span class='line'>            <span class="n">MainAppContent</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recap-implementation-differences">å›é¡¾ï¼šå®ç°å·®å¼‚</a></h3>

<p>ä¼ ç»Ÿæ–¹æ³•éœ€è¦å•ç‹¬çš„ Activity ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ EventSplash ä¼šæ³¨å…¥ä¸€ä¸ªä¸ä¸»å†…å®¹åŠ è½½è¿‡ç¨‹å…±å­˜çš„è§†å›¾å åŠ å±‚ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-architectural-advantages">åŸå› ï¼šæ¶æ„ä¼˜åŠ¿</a></h3>

<ol>
<li><strong>å•ä¸€ Activity ä¸Šä¸‹æ–‡</strong>ï¼šæ¶ˆé™¤ Activity è½¬æ¢å¼€é”€</li>
<li><strong>å¹¶è¡Œå¤„ç†</strong>ï¼šä¸»å†…å®¹åœ¨å¯åŠ¨ç”»é¢æ˜¾ç¤ºæ—¶åŠ è½½</li>
<li><strong>å‡å°‘å†…å­˜å ç”¨</strong>ï¼šæ²¡æœ‰é‡å¤çš„ Activity å¯¹è±¡</li>
<li><strong>å‡å°‘ Choreographer.doFrame å¾ªç¯</strong>ï¼šå‡å°‘æ¸²æŸ“ç®¡çº¿å‹åŠ›</li>
<li><strong>ä¼˜åŒ–è§†å›¾å±‚çº§</strong>ï¼šä½¿ç”¨å•ä¸€è£…é¥°è§†å›¾ï¼Œè€Œéå¤šä¸ªç‹¬ç«‹çš„ Activity</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-choreographer-do-frame-problem">Choreographer.doFrame é—®é¢˜</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#understanding-frame-rendering-issues">ç†è§£å¸§æ¸²æŸ“é—®é¢˜</a></h3>

<p>Android çš„æ¸²æŸ“ç³»ç»Ÿä¾èµ–äº <code>Choreographer.doFrame</code> æ¥åè°ƒåŠ¨ç”»ã€è¾“å…¥å’Œç»˜åˆ¶ <a href="https://developer.android.com/topic/performance/vitals/render">[4]</a>ã€‚æ–‡æ¡£è­¦å‘Šï¼š</p>

<blockquote><p>â€œå¦‚æœ Systrace æ˜¾ç¤º Choreographer#doFrame çš„å¸ƒå±€éƒ¨åˆ†å·¥ä½œè¿‡å¤šæˆ–è¿‡äºé¢‘ç¹ï¼Œåˆ™æ„å‘³ç€ä½ é‡åˆ°äº†å¸ƒå±€æ€§èƒ½é—®é¢˜â€</p></blockquote>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-splash-activities-cause-jank">ä¸ºä»€ä¹ˆé—ªå± Activity ä¼šå¯¼è‡´å¡é¡¿</a></h3>

<p>ä¼ ç»Ÿçš„é—ªå±å®ç°ä¼šé€ æˆå¤šä¸ªæ€§èƒ½ç“¶é¢ˆï¼š</p>

<ol>
<li><strong>åŒé‡å¸ƒå±€ä¼ é€’</strong>ï¼šæ¯ä¸ª Activity éƒ½éœ€è¦å•ç‹¬çš„è§†å›¾å¡«å……å’Œå¸ƒå±€</li>
<li><strong>ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€</strong>ï¼šæ“ä½œç³»ç»Ÿå¿…é¡»ç®¡ç†å¤šä¸ª Activity ä¸Šä¸‹æ–‡</li>
<li><strong>å†…å­˜å‹åŠ›</strong>ï¼šé‡å¤çš„è§†å›¾å±‚æ¬¡ç»“æ„ä¼šæ¶ˆè€—é¢å¤–çš„ RAM</li>
<li><strong>å¸§æ—¶åºé—®é¢˜</strong>ï¼šActivity è½¬æ¢ä¼šè§¦å‘é¢å¤–çš„ doFrame å‘¨æœŸ</li>
</ol>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#perfetto-analysis-insights">Perfetto åˆ†ææ´å¯Ÿ</a></h3>

<p>ä½¿ç”¨ Perfetto åˆ†æè½¨è¿¹æ—¶ï¼Œä¼ ç»Ÿçš„å¯åŠ¨ç”»é¢ä¼šæ˜¾ç¤ºï¼š</p>

<ul>
<li><code>Choreographer.doFrame</code> æ‰§è¡Œæ—¶é—´å»¶é•¿</li>
<li>å¸ƒå±€è†¨èƒ€å¤šæ¬¡å³°å€¼</li>
<li>åƒåœ¾å›æ”¶å‹åŠ›å¢åŠ </li>
<li>ä¸»çº¿ç¨‹å¯ç”¨æ€§å»¶è¿Ÿ</li>
</ul>


<p>åŸºäºè§†å›¾çš„æ–¹æ³•é€šè¿‡åœ¨æ•´ä¸ªå¯åŠ¨è¿‡ç¨‹ä¸­ç»´æŠ¤å•ä¸€æ¸²æŸ“ä¸Šä¸‹æ–‡æ¥æ¶ˆé™¤è¿™äº›é—®é¢˜ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#critical-consideration-concurrent-processing-isnt-free">âš ï¸ å…³é”®è€ƒè™‘ï¼šå¹¶å‘å¤„ç†å¹¶éå…è´¹</a></h3>

<p>è™½ç„¶æˆ‘ä»¬çš„ç»“æœæ˜¾ç¤ºæ€§èƒ½æ˜¾è‘—æå‡ï¼Œä½†<strong>éé˜»å¡æ–¹æ³•ä¹Ÿå¸¦æ¥äº†ä¸€ç³»åˆ—æŒ‘æˆ˜</strong>ï¼Œå¿…é¡»ä»”ç»†è€ƒè™‘ã€‚åŒæ—¶è¿è¡Œå¯åŠ¨åŠ¨ç”»å’Œä¸»å†…å®¹åŠ è½½ä¼šå¸¦æ¥é¢å¤–çš„èµ„æºå‹åŠ›ï¼Œè€Œé¡ºåºåŠ è½½æ–¹æ³•åˆ™ä¸ä¼šå‡ºç°è¿™ç§å‹åŠ›ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#memory-pressure-the-primary-concern">å†…å­˜å‹åŠ›ï¼šä¸»è¦é—®é¢˜</a></h3>

<p><strong>å³°å€¼å†…å­˜ä½¿ç”¨é‡å¢åŠ </strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='nix'><span class='line'><span class="o">//</span> Memory usage pattern comparison
</span><span class='line'>Traditional Approach<span class="p">:</span>
</span><span class='line'>Splash<span class="p">:</span> <span class="mi">50</span>MB <span class="err">â†’</span> <span class="mi">0</span>MB <span class="err">â†’</span> Main Content<span class="p">:</span> <span class="mi">120</span><span class="ss">MB =</span> Peak<span class="p">:</span> <span class="mi">120</span>MB
</span><span class='line'>
</span><span class='line'>Non-blocking Approach<span class="p">:</span>
</span><span class='line'>Splash <span class="o">+</span> Main Content<span class="p">:</span> <span class="mi">50</span>MB <span class="o">+</span> <span class="mi">120</span><span class="ss">MB =</span> Peak<span class="p">:</span> <span class="mi">170</span>MB
</span></code></pre></td></tr></table></div></figure>


<p><strong>å®é™…å½±å“</strong>ï¼š</p>

<ul>
<li><strong>ç®€å•çš„é—ªå±å åŠ </strong>åœ¨å¹¶å‘æ‰§è¡ŒæœŸé—´ä¼šå¢åŠ  20-50MB çš„å†…å­˜</li>
<li><strong>Lottie åŠ¨ç”»</strong>åœ¨æ¸²æŸ“æœŸé—´å¯èƒ½ä¼šæ¶ˆè€— 50-100MB ä»¥ä¸Šçš„å†…å­˜</li>
<li><strong>ç»¼åˆå³°å€¼ä½¿ç”¨é‡</strong>å¯èƒ½æ¯”é¡ºåºåŠ è½½æ–¹æ³•é«˜å‡º 40-70%</li>
<li><strong>ä½ç«¯è®¾å¤‡</strong>ï¼ˆ1-2GB RAMï¼‰å®¹æ˜“å—åˆ°å†…å­˜å‹åŠ›çš„å½±å“</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#low-memory-killer-risk">ä½å†…å­˜æ€æ‰‹é£é™©</a></h3>

<p>Android çš„ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹ä¼šç›‘æ§ç³»ç»Ÿå†…å­˜ï¼Œå¹¶å¯èƒ½åœ¨å‹åŠ›ä¸‹ç»ˆæ­¢åº”ç”¨ <a href="https://source.android.com/docs/core/perf/lmkd">[5]</a>:</p>

<blockquote><p>â€œå†…å­˜å‹åŠ›æ˜¯æŒ‡ç³»ç»Ÿå†…å­˜ä¸è¶³çš„çŠ¶æ€ï¼Œéœ€è¦ Android é€šè¿‡é™åˆ¶æˆ–ç»ˆæ­¢ä¸é‡è¦çš„è¿›ç¨‹æ¥é‡Šæ”¾å†…å­˜â€</p></blockquote>

<p><strong>é£é™©å› ç´ </strong>:</p>

<ul>
<li>å¯åŠ¨è¿‡ç¨‹ä¸­ç»ˆæ­¢åº”ç”¨è¿›ç¨‹ä¼šå¯¼è‡´ç³Ÿç³•çš„ç”¨æˆ·ä½“éªŒ</li>
<li>åå°åº”ç”¨è¢«æ›´é¢‘ç¹åœ°ç»ˆæ­¢</li>
<li>å¹¶å‘åˆ†é…å¯¼è‡´çš„å†…å­˜ç¢ç‰‡</li>
<li>åœ¨é¢„ç®—è®¾å¤‡ä¸Šå°¤å…¶æˆé—®é¢˜</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#cpu-and-battery-implications">CPU å’Œç”µæ± å½±å“</a></h3>

<p><strong>CPU å¼€é”€å¢åŠ </strong>ï¼š</p>

<ul>
<li><code>Choreographer.doFrame</code> å¤„ç†å¤šä¸ªå¹¶å‘æ“ä½œ</li>
<li>ä¸»çº¿ç¨‹å›  UI å·¥ä½œé‡å è€Œå˜å¾—æ›´åŠ ç¹å¿™</li>
<li>GPU æ¸²æŸ“ç®¡çº¿åŒæ—¶å¤„ç†å¯åŠ¨ç”»é¢å’Œå†…å®¹</li>
</ul>


<p><strong>åŠŸè€—é—®é¢˜</strong>ï¼šç ”ç©¶è¡¨æ˜ï¼Œâ€œæ™ºèƒ½æ‰‹æœºä¸Šçš„ UI æ¸²æŸ“éœ€è¦å¼ºå¤§çš„ CPU å’Œ GPU æ‰èƒ½æ»¡è¶³ç”¨æˆ·æ„ŸçŸ¥çš„æµç•…åº¦ï¼Œå¹¶ä¸”è¿™å äº†ç›¸å½“ä¸€éƒ¨åˆ†çš„åŠŸè€—â€<a href="https://www.sciencedirect.com/science/article/abs/pii/S1383762122001540">[6]</a>ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#device-compatibility-challenges">è®¾å¤‡å…¼å®¹æ€§æŒ‘æˆ˜</a></h3>

<p><strong>ä½ç«¯è®¾å¤‡æ³¨æ„äº‹é¡¹</strong>:</p>

<ul>
<li>å•æ ¸æˆ–åŒæ ¸å¤„ç†å™¨éš¾ä»¥å¹¶è¡ŒåŒ–</li>
<li>æœ‰é™çš„ RAM ä½¿å¾—å†…å­˜å‹åŠ›è‡³å…³é‡è¦</li>
<li>è¾ƒæ…¢çš„å­˜å‚¨é€Ÿåº¦åŠ å‰§åŠ è½½å»¶è¿Ÿ</li>
<li>ä¼˜åŠ¿å¯èƒ½æ— æ³•è½¬åŒ–ä¸ºä½ç«¯è®¾å¤‡çš„ä¼˜åŠ¿</li>
</ul>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#when-not-to-use-non-blocking-approach">ä½•æ—¶ä¸åº”ä½¿ç”¨éé˜»å¡æ–¹æ³•</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#scenarios-where-traditional-approach-may-be-better">ä¼ ç»Ÿæ–¹æ³•å¯èƒ½æ›´ä½³çš„åœºæ™¯ï¼š</a></h3>

<ol>
<li><strong>èµ„æºæå…¶å—é™çš„è®¾å¤‡</strong>ï¼ˆ&lt; 2GB RAMï¼‰</li>
<li><strong>ç”µæ± å…³é”®å‹åº”ç”¨</strong>ï¼ŒåŠŸè€—è‡³å…³é‡è¦</li>
<li><strong>ç®€å•çš„å¯åŠ¨ç”»é¢</strong>ï¼Œæ²¡æœ‰å¤æ‚çš„åŠ¨ç”»</li>
<li><strong>å¯åŠ¨å¤„ç†ç¹é‡çš„åº”ç”¨</strong>ï¼Œå·²ç»ç»™åº”ç”¨å¸¦æ¥äº†å‹åŠ›ç³»ç»Ÿ</li>
<li><strong>é—ç•™ä»£ç åº“</strong>ï¼Œé‡æ„é£é™©å¤§äºæ”¶ç›Š</li>
</ol>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#risk-mitigation-strategies">é£é™©ç¼“è§£ç­–ç•¥</a></h3>

<p><strong>è‡ªé€‚åº”å®æ–½</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AdaptiveSplashStrategy</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">chooseSplashApproach</span><span class="p">():</span> <span class="n">SplashConfig</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">isLowEndDevice</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">SimpleSplashConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="n">isBatteryLow</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ReducedAnimationConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="n">isHighPerformanceDevice</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">FullLottieConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">DefaultConfig</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">isLowEndDevice</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">activityManager</span> <span class="p">=</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">ACTIVITY_SERVICE</span><span class="p">)</span> <span class="k">as</span> <span class="n">ActivityManager</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">activityManager</span><span class="p">.</span><span class="n">isLowRamDevice</span> <span class="p">||</span>
</span><span class='line'>               <span class="n">Runtime</span><span class="p">.</span><span class="n">getRuntime</span><span class="p">().</span><span class="n">maxMemory</span><span class="p">()</span> <span class="p">&lt;</span> <span class="m">256</span> <span class="p">*</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">1024</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>å†…å­˜ç›‘æ§</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">monitorMemoryPressure</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">memoryInfo</span> <span class="p">=</span> <span class="n">ActivityManager</span><span class="p">.</span><span class="n">MemoryInfo</span><span class="p">()</span>
</span><span class='line'>    <span class="n">activityManager</span><span class="p">.</span><span class="n">getMemoryInfo</span><span class="p">(</span><span class="n">memoryInfo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">memoryInfo</span><span class="p">.</span><span class="n">lowMemory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Fallback to simpler splash</span>
</span><span class='line'>        <span class="n">simplifyOrDismissSplash</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#industry-context-and-validation">è¡Œä¸šèƒŒæ™¯å’ŒéªŒè¯</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#alignment-with-industry-best-practices">ä¸è¡Œä¸šæœ€ä½³åšæ³•ä¿æŒä¸€è‡´å®è·µ</a></h3>

<p>EventSplash æ–¹æ³•ç¬¦åˆæœ€æ–°çš„è¡Œä¸šè¶‹åŠ¿å’Œå®˜æ–¹å»ºè®®ã€‚åƒ Turo è¿™æ ·çš„å…¬å¸é€šè¿‡æ¶ˆé™¤ä¸“ç”¨çš„å¯åŠ¨æ´»åŠ¨ä¹Ÿå–å¾—äº†ç±»ä¼¼çš„æ•ˆæœã€‚æ­£å¦‚ä»–ä»¬çš„æ¡ˆä¾‹ç ”ç©¶ <a href="https://medium.com/androiddevelopers/turo-reduced-its-app-startup-time-by-77-using-android-developer-tools-and-best-practices-bcf82f596bcf">[7]</a> ä¸­æ‰€è¿°ï¼š</p>

<blockquote><p>â€œæœ€åˆï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸“ç”¨çš„ SplashActivity æ¥è¿è¡Œæ‰€æœ‰å¯åŠ¨å·¥ä½œï¼Œç„¶åå†å°†åº”ç”¨è·¯ç”±åˆ° HomeActivityã€‚ç„¶è€Œï¼Œæœ€æ–°çš„æŒ‡å—å»ºè®®ä¸è¦é‡‡ç”¨è¿™ç§æ–¹æ³•ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ç§»é™¤äº†å¤šä½™çš„ SplashActivityï¼Œå¹¶å°†æ‰€æœ‰å¯åŠ¨é€»è¾‘è½¬ç§»åˆ°äº†æ ¹ Activityã€‚â€</p></blockquote>

<p>Turo ä½¿ç”¨ç±»ä¼¼çš„åŸç†å®ç°äº†<strong>77% çš„å¯åŠ¨æ—¶é—´ç¼©çŸ­</strong>ã€‚</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#validation-through-official-documentation">é€šè¿‡å®˜æ–¹æ–‡æ¡£éªŒè¯</a></h3>

<p>Android å®˜æ–¹æ–‡æ¡£æ˜ç¡®å»ºè®®ä½¿ç”¨â€œViewTreeObserver.OnPreDrawListenerâ€è¿›è¡Œå¯åŠ¨ç”»é¢ç®¡ç†ï¼Œ<a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>ï¼Œè¿™è¿›ä¸€æ­¥éªŒè¯äº†è¯¥æ–¹æ³•ï¼Œè€Œè¿™æ­£æ˜¯ EventSplash çš„æ ¸å¿ƒå®ç°ã€‚</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#best-practices-and-common-pitfalls">æœ€ä½³å®è·µå’Œå¸¸è§é™·é˜±</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#dos">å»ºè®®âœ…</a></h3>

<ul>
<li>åœ¨æ€§èƒ½å¼ºå¤§çš„è®¾å¤‡ä¸Šï¼Œ<strong>ä½¿ç”¨åŸºäºè§†å›¾çš„å¯åŠ¨ç”»é¢å®ç°</strong>è‡ªå®šä¹‰åŠ¨ç”»</li>
<li>æ ¹æ®è®¾å¤‡æ€§èƒ½<strong>å®æ–½è‡ªé€‚åº”ç­–ç•¥</strong></li>
<li>ä½¿ç”¨çœŸå®è®¾å¤‡**æµ‹é‡æ€§èƒ½ï¼Œå¹¶è·¨è®¾å¤‡å±‚çº§å‘å¸ƒç‰ˆæœ¬</li>
<li>ç›‘æ§å†…å­˜ä½¿ç”¨æƒ…å†µ**å¹¶å®æ–½å†…å­˜æ³„æ¼é¢„é˜²</li>
<li>é’ˆå¯¹æœ€åæƒ…å†µè¿›è¡Œå†·å¯åŠ¨ä¼˜åŒ–</li>
<li>åœ¨ä½ç«¯è®¾å¤‡ä¸Šè¿›è¡Œå¹¿æ³›æµ‹è¯•**ä»¥ç¡®ä¿å¹¿æ³›çš„å…¼å®¹æ€§</li>
<li><strong>ä¸ºå¯åŠ¨ç”»é¢å®æ–½é€‚å½“çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong></li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#donts">æ³¨æ„äº‹é¡¹âŒ</a></h3>

<ul>
<li><strong>ä¸è¦æƒ³å½“ç„¶åœ°è®¤ä¸ºä¸€åˆ€åˆ‡</strong>ï¼šè®¾å¤‡æ€§èƒ½å·®å¼‚å·¨å¤§</li>
<li><strong>ä¸è¦å¿½è§†å†…å­˜å‹åŠ›</strong>ï¼šç›‘æ§å¹¶é€‚åº”ç³»ç»Ÿé™åˆ¶</li>
<li><strong>ä¸è¦åœ¨æœªè€ƒè™‘æ›¿ä»£æ–¹æ¡ˆçš„æƒ…å†µä¸‹ä½¿ç”¨å•ç‹¬çš„ SplashActivity</strong></li>
<li><strong>ä¸è¦ç”¨å¯åŠ¨ç”»é¢åŠ¨ç”»é˜»ç¢ä¸»å†…å®¹åŠ è½½</strong></li>
<li><strong>ä¸è¦å¿½ç•¥ Play ç®¡ç†ä¸­å¿ƒå†…çš„ Android Vitals æŒ‡æ ‡</strong></li>
<li><strong>ä¸è¦åªåœ¨é«˜ç«¯è®¾å¤‡</strong>æˆ–è°ƒè¯•ç‰ˆæœ¬ä¸Šè¿›è¡Œæµ‹è¯•</li>
<li><strong>ä¸è¦åœ¨å¯åŠ¨ç”»é¢ä¸­åˆ›å»ºå¤æ‚çš„è§†å›¾å±‚æ¬¡ç»“æ„</strong></li>
<li><strong>ä¸è¦åœ¨å¯åŠ¨ç”»é¢ä¸­æ‰§è¡Œç¹é‡çš„æ“ä½œ</strong></li>
<li><strong>ä¸è¦å¿˜è®°æ¸…ç†å¯åŠ¨ç”»é¢</strong>å¹¶æ¸…é™¤ç¼“å­˜</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#common-pitfalls">å¸¸è§é™·é˜±</a></h3>

<ol>
<li><strong>å†…å­˜æ³„æ¼</strong>ï¼šæœªèƒ½æ¸…é™¤ LottieCompositionCache</li>
<li><strong>è®¾å¤‡èƒ½åŠ›å‡è®¾</strong>ï¼šæœªé€‚åº”ä½ç«¯è®¾å¤‡é™åˆ¶</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸé—®é¢˜</strong>ï¼šæœªæ­£ç¡®å¤„ç† Activity çŠ¶æ€å˜åŒ–</li>
<li><strong>åŠ¨ç”»å†²çª</strong>ï¼šé—ªå±åŠ¨ç”»å¹²æ‰°ä¸»å†…å®¹</li>
<li><strong>æµ‹è¯•åå·®</strong>ï¼šä»…åœ¨å¿«é€Ÿè®¾å¤‡æˆ–è°ƒè¯•ç‰ˆæœ¬ä¸Šè¿›è¡Œæµ‹è¯•</li>
<li><strong>æŒ‡æ ‡è¯¯è§£</strong>ï¼šå…³æ³¨åŠ¨ç”»æ—¶é•¿è€Œéç”¨æˆ·æ„ŸçŸ¥çš„æ€§èƒ½</li>
<li><strong>èµ„æºç›‘æ§ç–å¿½</strong>ï¼šæœªç›‘æ§å†…å­˜å’Œ CPU ä½¿ç”¨æ¨¡å¼</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#making-informed-architectural-decisions">åˆ¶å®šæ˜æ™ºçš„æ¶æ„å†³ç­–</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#decision-framework">å†³ç­–æ¡†æ¶</a></h3>

<p>åœ¨é€‰æ‹©å¯åŠ¨ç”»é¢æ–¹æ¡ˆæ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š</p>

<p><strong>è®¾å¤‡å—ä¼—ç‰¹å¾</strong>ï¼š</p>

<ul>
<li>ä½ çš„ç”¨æˆ·ä¸­æœ‰å¤šå°‘æ¯”ä¾‹ä½¿ç”¨ä½ç«¯è®¾å¤‡ï¼Ÿ</li>
<li>ä½ æ”¯æŒçš„æœ€ä½ RAM é…ç½®æ˜¯å¤šå°‘ï¼Ÿ</li>
<li>ä½ æ˜¯å¦ç„å‡†äº†æ‹¥æœ‰å»‰ä»·è®¾å¤‡çš„æ–°å…´å¸‚åœºï¼Ÿ</li>
</ul>


<p><strong>åº”ç”¨ç‰¹æ€§</strong>ï¼š</p>

<ul>
<li>ä½ çš„ä¸»è¦å†…å®¹åŠ è½½å¤æ‚åº¦å¦‚ä½•ï¼Ÿ</li>
<li>ä½ æ˜¯å¦å¯¹ç½‘ç»œä¾èµ–æ€§å¾ˆå¼ºï¼Ÿ</li>
<li>ä½ å½“å‰çš„å†…å­˜å ç”¨æ˜¯å¤šå°‘ï¼Ÿ</li>
</ul>


<p><strong>ä¸šåŠ¡éœ€æ±‚</strong>ï¼š</p>

<ul>
<li>è‡ªå®šä¹‰å¯åŠ¨åŠ¨ç”»å¯¹ä½ çš„å“ç‰Œæœ‰å¤šé‡è¦ï¼Ÿ</li>
<li>ä½ èƒ½å®ç°æ¸è¿›å¼å¢å¼ºå—ï¼Ÿ</li>
<li>ä½ çš„å¼€å‘å’Œæµ‹è¯•èƒ½åŠ›å¦‚ä½•ï¼Ÿ</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recommended-strategy">æ¨èç­–ç•¥</a></h3>

<p><strong>æ¸è¿›å¼å¢å¼ºæ–¹æ³•</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">EventSplashApi</span><span class="p">.</span><span class="n">attachTo</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withFallback</span><span class="p">(</span><span class="n">SimpleSplashConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// Low-end devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withStandard</span><span class="p">(</span><span class="n">ImageSplashConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// Mid-range devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withEnhanced</span><span class="p">(</span><span class="n">LottieConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// High-end devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">adaptToDevice</span><span class="p">()</span>
</span><span class='line'>    <span class="c1">// Automatic selection</span>
</span><span class='line'>    <span class="p">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤æ–¹æ³•æä¾›ï¼š</p>

<ul>
<li>é€‚ç”¨äºæ‰€æœ‰è®¾å¤‡çš„<strong>åŸºæœ¬åŠŸèƒ½</strong></li>
<li>åœ¨èµ„æºå…è®¸çš„æƒ…å†µä¸‹<strong>å¢å¼ºä½“éªŒ</strong></li>
<li>æ ¹æ®è®¾å¤‡æ€§èƒ½<strong>è‡ªåŠ¨é€‚é…</strong></li>
<li>åœ¨å†…å­˜å‹åŠ›ä¸‹<strong>ä¼˜é›…é™çº§</strong></li>
</ul>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#insights-recommendations">è§è§£ä¸å»ºè®®</a></h2>

<p>éé˜»å¡å¯åŠ¨ç”»é¢æ–¹æ³•<strong>æ˜¾è‘—æå‡æ€§èƒ½</strong>ï¼ˆä¿å®ˆæµ‹è¯•ä¸­é¡µé¢åŠ è½½é€Ÿåº¦æå‡ 90%ï¼Œå¤æ‚åŠ¨ç”»ä¸‹æœ€é«˜å¯è¾¾ 95%ï¼‰ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›ä¸è¶³ã€‚<strong>å¹¶å‘å¤„ç†ä¼šå¢åŠ å³°å€¼å†…å­˜ä½¿ç”¨é‡å’Œ CPU å¼€é”€</strong>ï¼Œè¿™åœ¨ä½ç«¯è®¾å¤‡ä¸Šå¯èƒ½ä¼šé€ æˆé—®é¢˜ã€‚</p>

<p><strong>å…³é”®è§è§£</strong>ï¼šå…¶ä¼˜åŠ¿æ˜¾è‘—ä¸”å¯è¡¡é‡ï¼Œä½†ä¹Ÿä¼´éšç€èµ„æºæˆæœ¬ï¼Œå¿…é¡»é€šè¿‡è‡ªé€‚åº”çš„å®æ–½ç­–ç•¥è¿›è¡Œç®¡ç†ã€‚</p>

<p><strong>è¯šæŒšå»ºè®®</strong>ï¼šä½¿ç”¨éé˜»å¡æ–¹æ³•å¹¶ç»“åˆè®¾å¤‡æ„ŸçŸ¥å›é€€æœºåˆ¶ã€‚å³ä½¿æ˜¯ä¿å®ˆä¼°è®¡ï¼Œä¹Ÿèƒ½æ˜¾â€‹â€‹ç¤ºå‡ºæ˜¾è‘—çš„æ€§èƒ½æå‡ï¼Œå…¶æ¶æ„ä¼˜åŠ¿ä¹Ÿä»¤äººä¿¡æœã€‚ç„¶è€Œï¼Œè¯¥å®ç°å¿…é¡»è¶³å¤Ÿå¤æ‚ï¼Œæ‰èƒ½æ”¯æŒæ‰€æœ‰ Android è®¾å¤‡ã€‚</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#conclusion">ç»“è®º</a></h2>

<p>_æœ¬æ¡ˆä¾‹ç ”ç©¶è¡¨æ˜ï¼Œæ€§èƒ½ä¼˜åŒ–éœ€è¦åœ¨ä¿æŒè¯šå®å£°æ˜çš„åŒæ—¶å¹³è¡¡ç›¸äº’ç«äº‰çš„çº¦æŸæ¡ä»¶ã€‚éé˜»å¡ã€åŸºäºè§†å›¾çš„æ–¹æ³•æä¾›äº†æ˜¾è‘—ä¸”å¯è¡¡é‡çš„ä¼˜åŠ¿ï¼Œä½†æˆåŠŸå®æ–½éœ€è¦æ·±å…¥äº†è§£å…¶æ”¶ç›Šå’Œæˆæœ¬ã€‚</p>

<p>é€šè¿‡æ‘†è„±ä¼ ç»Ÿçš„â€œSplashActivityâ€æ¨¡å¼ï¼Œé‡‡ç”¨æ›´å¤æ‚ã€æ›´å¹¶å‘çš„æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºé€Ÿåº¦æ›´å¿«ã€å“åº”æ›´çµæ•çš„ Android åº”ç”¨ï¼Œå¹¶åœ¨æ•´ä¸ªç”Ÿæ€ç³»ç»Ÿä¸­å¯é åœ°è¿è¡Œã€‚</p>

<p><strong>æˆ‘ä»¬çš„ç›®æ ‡ä¸ä»…ä»…æ˜¯æ„å»ºæ›´å¿«çš„åº”ç”¨ï¼Œè€Œæ˜¯æ„å»ºä½¿ç”¨ä½“éªŒå³æ—¶ã€æ„‰æ‚¦çš„åº”ç”¨ï¼Œå› ä¸ºæœ€ç»ˆï¼Œæ€§èƒ½æ˜¯ç”¨æˆ·èƒ½å¤Ÿæ³¨æ„åˆ°å¹¶æ¬£èµçš„åŠŸèƒ½ã€‚</strong></p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#references">å‚è€ƒ</a></h2>

<ol>
<li><a href="https://developer.android.com/develop/ui/views/launch/splash-screen">é—ªå± | è§†å›¾ | Android å¼€å‘è€…</a></li>
<li><a href="https://developer.android.com/topic/performance/vitals/launch-time">åº”ç”¨å¯åŠ¨æ—¶é—´ | åº”ç”¨è´¨é‡ | Android å¼€å‘è€…</a></li>
<li><a href="https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iv-49946659b094">Android ç”Ÿå‘½å‘¨æœŸé€ŸæŸ¥è¡¨ â€” ç¬¬å››éƒ¨åˆ†ï¼šViewModelã€åŠé€æ˜ Activity å’Œå¯åŠ¨æ¨¡å¼ | ä½œè€…ï¼šJose AlcÃ©rreca</a></li>
<li><a href="https://developer.android.com/topic/performance/vitals/render">æ¸²æŸ“ç¼“æ…¢ | åº”ç”¨è´¨é‡ | Android å¼€å‘è€…</a></li>
<li><a href="https://source.android.com/docs/core/perf/lmkd">ä½å†…å­˜ç»ˆæ­¢å®ˆæŠ¤è¿›ç¨‹ (lmkd) | Android å¼€æºé¡¹ç›®</a></li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S1383762122001540">ç§»åŠ¨ UI æ¸²æŸ“åŠŸè€—ç ”ç©¶</a></li>
<li><a href="https://medium.com/androiddevelopers/turo-reduced-its-app-startup-time-by-77-using-android-developer-tools-and-best-practices-bcf82f596bcf">Turo åˆ©ç”¨ Android å¼€å‘è€…å·¥å…·å’Œæœ€ä½³å®è·µå°†å…¶åº”ç”¨å¯åŠ¨æ—¶é—´ç¼©çŸ­äº† 77%</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[çµæ´»ã€ç°ä»£çš„Androidåº”ç”¨æ¶æ„ï¼šå®Œæ•´åˆ†æ­¥æŒ‡å—]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture/"/>
    <updated>2025-10-13T15:05:25+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒA flexible, modern Android app architecture: complete step-by-stepã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993">https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993</a>ï¼Œç”±Tom Colvinå‘å¸ƒäº2023å¹´7æœˆ4æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*ykKTTMXsKNzLJ7In" title="auto auto" ></a></p>

<!-- more -->


<p>æˆ‘æœ€è¿‘å†™äº†ä¸€ç¯‡å…³äº<a href="https://juejin.cn/post/7553894051460694055">ä¼˜ç§€ Android åº”ç”¨æ¶æ„èƒŒåçš„ç†è®º</a>çš„æ–‡ç« ã€‚è¿™ç¯‡æ–‡ç« æˆä¸ºäº†æˆ‘è¿„ä»Šä¸ºæ­¢æœ€å—æ¬¢è¿çš„æ–‡ç« ï¼Œè®¸å¤šäººéƒ½æ…·æ…¨åœ°è¡¨ç¤ºå®ƒå¯¹ä»–ä»¬å¾ˆæœ‰å¸®åŠ©ã€‚</p>

<p>æœ€å¸¸è§çš„é—®é¢˜ä¹‹ä¸€æ˜¯ï¼šâ€œä½†æ˜¯ X å‘¢ï¼Ÿå®ƒä¸å¤ªç¬¦åˆè§„åˆ™ã€‚â€ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸€ç›´è¯´ï¼š</p>

<blockquote><p>è¦å­¦ä¹ åŸåˆ™ï¼Œè€Œä¸æ˜¯ç›²ç›®éµå¾ªè§„åˆ™ã€‚</p></blockquote>

<p>æœ¬æ–‡æ—¨åœ¨å±•ç¤ºå®è·µçš„ä¸€é¢ï¼šé€šè¿‡ç¤ºä¾‹æ¥æ•™æˆ Android æ¶æ„ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œè¿™æ„å‘³ç€å±•ç¤ºå„ç§æ¶æ„å†³ç­–æ˜¯å¦‚ä½•åˆ¶å®šçš„ã€‚æˆ‘ä»¬ä¼šé‡åˆ°æœ‰å¤šç§å¯èƒ½ç­”æ¡ˆçš„æƒ…å†µï¼Œåœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šä¾é åŸåˆ™ï¼Œè€Œä¸æ˜¯æ­»è®°ç¡¬èƒŒä¸€å¥—è§„åˆ™ã€‚</p>

<p>æ‰€ä»¥ï¼Œè®©æˆ‘ä»¬ä¸€èµ·æ„å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºå§ã€‚</p>

<h2>ä»‹ç»æˆ‘ä»¬å°†è¦æ„å»ºçš„åº”ç”¨ç¨‹åº</h2>

<p>æˆ‘ä»¬å°†ä¸ºè¡Œæ˜Ÿè§‚æµ‹è€…æ„å»ºä¸€æ¬¾åº”ç”¨ç¨‹åºã€‚å®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:640/1*7C7vCDdsppHzE1DQkI3QJA.gif" alt="åº”ç”¨ç¨‹åºï¼ˆå…¨çƒæ’åç¬¬ä¸€çš„è¡Œæ˜Ÿè§‚æµ‹åº”ç”¨ç¨‹åºï¼‰æ¼”ç¤ºï¼šæ·»åŠ ç¤ºä¾‹è¡Œæ˜Ÿã€æ·»åŠ è‡ªå®šä¹‰è¡Œæ˜Ÿã€åˆ é™¤è¡Œæ˜Ÿä»¥åŠåˆ·æ–°" /></p>

<p>æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°†å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p>

<ul>
<li>åˆ—å‡ºä½ ä¹‹å‰å‘ç°çš„æ‰€æœ‰è¡Œæ˜Ÿ</li>
<li>æ·»åŠ æ–°å‘ç°çš„è¡Œæ˜Ÿ</li>
<li>åˆ é™¤è¡Œæ˜Ÿï¼ˆä»¥é˜²ä½ æ„è¯†åˆ°ä½ çš„å‘ç°å®é™…ä¸Šåªæ˜¯æœ›è¿œé•œé•œå¤´ä¸Šçš„ä¸€å°å—ç—•è¿¹ï¼‰</li>
<li>æ·»åŠ ä¸€äº›ç¤ºä¾‹è¡Œæ˜Ÿï¼Œä»¥ä¾¿ç”¨æˆ·äº†è§£åº”ç”¨ç¨‹åºçš„å·¥ä½œåŸç†</li>
</ul>


<p>å®ƒå°†å…·æœ‰ç¦»çº¿æ•°æ®ç¼“å­˜ä»¥åŠåœ¨çº¿æ•°æ®åº“è®¿é—®åŠŸèƒ½ã€‚</p>

<p>ä¸æˆ‘çš„æ¼”ç¤ºä¸€æ ·ï¼Œæˆ‘é¼“åŠ±ä½ å°è¯•ä¸åŒçš„åšæ³•ï¼šæ·»åŠ é¢å¤–åŠŸèƒ½ï¼Œè€ƒè™‘æœªæ¥å¯èƒ½å‡ºç°çš„è§„æ ¼å˜æ›´ï¼ŒæŒ‘æˆ˜è‡ªæˆ‘ã€‚åœ¨è¿™é‡Œï¼Œå­¦ä¹ çš„é‡ç‚¹åœ¨äº<em>ä»£ç èƒŒåçš„æ€è€ƒè¿‡ç¨‹</em>ï¼Œè€Œä¸æ˜¯ä»£ç æœ¬èº«ã€‚æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³ä»æœ¬æ•™ç¨‹ä¸­è·å¾—æœ€å¤§æ”¶è·ï¼Œä¸è¦ç›²ç›®åœ°å¤åˆ¶ä»£ç ã€‚</p>

<p>è¿™æ˜¯æˆ‘ä»¬æœ€ç»ˆçš„ä»“åº“ï¼š<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>ã€‚</p>

<h2>ä»‹ç»æˆ‘ä»¬å°†è¦ä½¿ç”¨çš„æ¶æ„åŸåˆ™</h2>

<p>æˆ‘ä»¬å°†å‚è€ƒ SOLID åŸåˆ™ã€æ•´æ´æ¶æ„åŸåˆ™ä»¥åŠ Google è‡ªå·±çš„ç°ä»£åº”ç”¨æ¶æ„åŸåˆ™ã€‚</p>

<p>æˆ‘ä»¬ä¸ä¼šå°†è¿™äº›åŸåˆ™è§†ä¸ºç¡¬æ€§è§„å®šï¼Œå› ä¸ºæˆ‘ä»¬è¶³å¤Ÿèªæ˜ï¼Œèƒ½å¤Ÿæ„å»ºæ›´é€‚åˆæˆ‘ä»¬åº”ç”¨ï¼ˆå°¤å…¶æ˜¯æ›´ç¬¦åˆæˆ‘ä»¬é¢„æœŸåº”ç”¨å¢é•¿æ–¹å¼ï¼‰çš„æ¶æ„ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ ä¸¥æ ¼éµå¾ªæ•´æ´æ¶æ„ï¼Œä½ å°†å¼€å‘å‡ºç¨³å®šã€å¯é ã€å¯æ‰©å±•çš„è½¯ä»¶ï¼Œä½†å¯¹äºå•ä¸€ç”¨é€”çš„åº”ç”¨æ¥è¯´ï¼Œä½ çš„ä»£ç å¯èƒ½ä¼šè¿‡äºå¤æ‚ã€‚Google çš„åŸåˆ™å¯ä»¥ç”Ÿæˆæ›´ç®€å•çš„ä»£ç ï¼Œä½†å¦‚æœæœ‰ä¸€å¤©è¯¥åº”ç”¨å¯èƒ½ç”±å¤šä¸ªå¤§å‹å¼€å‘å›¢é˜Ÿç»´æŠ¤ï¼Œåˆ™è¿™äº›åŸåˆ™å°±ä¸å¤ªé€‚ç”¨äº†ã€‚</p>

<p>æˆ‘ä»¬å°†ä» Google çš„æ‹“æ‰‘ç»“æ„å¼€å§‹ï¼Œå¹¶åœ¨æ­¤è¿‡ç¨‹ä¸­å‚è€ƒæ•´æ´æ¶æ„ã€‚</p>

<p>Google çš„æ‹“æ‰‘ç»“æ„å¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1200/1*tuohW6OJuZD8tMcAYjPBSg.png" alt="" /></p>

<p>æˆ‘ä»¬å°†é€æ­¥å®ç°è¿™äº›åŠŸèƒ½ï¼Œ<a href="https://juejin.cn/post/7553894051460694055">æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« </a> å¯¹æ¯ä¸ªéƒ¨åˆ†éƒ½è¿›è¡Œäº†æ›´æ·±å…¥çš„ä»‹ç»ã€‚è¿™é‡Œå†ç®€å•åœ°æ¦‚è¿°ä¸€ä¸‹ï¼š</p>

<h3>UI å±‚</h3>

<p>UI å±‚å®ç°ç”¨æˆ·ç•Œé¢ã€‚å®ƒåˆ†ä¸ºï¼š</p>

<ul>
<li><strong>UI å…ƒç´ </strong>ï¼Œå³ç”¨äºåœ¨å±å¹•ä¸Šç»˜åˆ¶å†…å®¹çš„æ‰€æœ‰ä¸“æœ‰ä»£ç ã€‚åœ¨ Android ä¸­ï¼Œä¸»è¦é€‰æ‹©æ˜¯ Jetpack Composeï¼ˆæ­¤å¤„ä½¿ç”¨ <code>@Composable</code>ï¼‰æˆ– XMLï¼ˆæ­¤å¤„åŒ…å«ä½ çš„ XML æ–‡ä»¶å’Œèµ„æºï¼‰ã€‚</li>
<li><strong>çŠ¶æ€æŒæœ‰è€…</strong>ï¼Œç”¨äºå®ç°ä½ åå¥½çš„ MVVM / MVC / MVP / &hellip; æ‹“æ‰‘ç»“æ„ã€‚åœ¨æ­¤åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è§†å›¾æ¨¡å‹ã€‚</li>
</ul>


<h3>é¢†åŸŸå±‚</h3>

<p>é¢†åŸŸå±‚ç”¨äºåŒ…å«é«˜çº§ä¸šåŠ¡é€»è¾‘çš„<strong>ç”¨ä¾‹</strong>ã€‚ä¾‹å¦‚â€‹â€‹ï¼Œå½“æˆ‘ä»¬æƒ³è¦æ·»åŠ ä¸€ä¸ªæ˜Ÿçƒæ—¶ï¼ŒAddPlanetUseCase å°†æè¿°æ‰§è¡Œæ­¤æ“ä½œæ‰€éœ€çš„ä¸€ç³»åˆ—æ­¥éª¤ã€‚å®ƒåªæ˜¯â€œåšä»€ä¹ˆâ€çš„åˆ—è¡¨ï¼Œè€Œä¸æ˜¯â€œæ€ä¹ˆåšâ€çš„åˆ—è¡¨ï¼šä¾‹å¦‚ï¼Œæˆ‘ä»¬ä¼šè¯´â€œä¿å­˜ Planet å¯¹è±¡çš„æ•°æ®â€ã€‚è¿™æ˜¯ä¸€ä¸ªé«˜çº§æŒ‡ä»¤ã€‚æˆ‘ä»¬ä¸ä¼šè¯´â€œå°†å…¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜â€ï¼Œæ›´ä¸ç”¨è¯´â€œä½¿ç”¨ Room æ•°æ®åº“å°†å…¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜â€äº†â€”â€”è¿™äº›åº•å±‚å®ç°ç»†èŠ‚åº”è¯¥æ”¾åœ¨å…¶ä»–åœ°æ–¹ã€‚</p>

<h3>æ•°æ®å±‚</h3>

<p>Google æ•¦ä¿ƒæˆ‘ä»¬ä¸ºåº”ç”¨ä¸­çš„æ‰€æœ‰æ•°æ®æä¾›å•ä¸€å¯ä¿¡æ¥æºï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ç§è·å–æœ€ç»ˆâ€œæ­£ç¡®â€æ•°æ®ç‰ˆæœ¬çš„æ–¹æ³•ã€‚è¿™å°±æ˜¯æ•°æ®å±‚å°†è¦æä¾›çš„å†…å®¹ï¼ˆæ¶µç›–é™¤æè¿°ç”¨æˆ·åˆšåˆšè¾“å…¥å†…å®¹çš„æ•°æ®ç»“æ„ä¹‹å¤–çš„æ‰€æœ‰æ•°æ®ç»“æ„ï¼‰ã€‚å®ƒåˆ†ä¸ºï¼š</p>

<ul>
<li><strong>å­˜å‚¨åº“</strong>ï¼Œç”¨äºç®¡ç†å„ç§ç±»å‹çš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªè¡Œæ˜Ÿæ•°æ®å­˜å‚¨åº“ï¼Œå®ƒå°†æä¾›å¯¹å·²å‘ç°è¡Œæ˜Ÿçš„ CRUDï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰æ“ä½œã€‚å®ƒè¿˜å°†å¤„ç†æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ç¼“å­˜å’Œè¿œç¨‹ç¼“å­˜ä¸­çš„æƒ…å†µï¼Œä¸ºä¸åŒç±»å‹çš„æ“ä½œé€‰æ‹©åˆé€‚çš„æ•°æ®æºï¼Œå¹¶ç®¡ç†å½“ä¸¤ä¸ªæ•°æ®æºåŒ…å«ä¸åŒæ•°æ®å‰¯æœ¬æ—¶çš„å¤„ç†æ–¹å¼ã€‚è¿™é‡Œæˆ‘ä»¬å°†è®¨è®ºæœ¬åœ°ç¼“å­˜ï¼Œä½†æˆ‘ä»¬ä¸ä¼šè®¨è®ºæˆ‘ä»¬å°†ä½¿ç”¨å“ªäº›ç¬¬ä¸‰æ–¹æŠ€æœ¯æ¥å®ç°å®ƒã€‚</li>
<li><strong>æ•°æ®æº</strong>ï¼Œç”¨äºç®¡ç†æ•°æ®å­˜å‚¨çš„å…·ä½“ç»†èŠ‚ã€‚å½“å­˜å‚¨åº“è¯·æ±‚â€œè¿œç¨‹å­˜å‚¨ Xâ€æ—¶ï¼Œå®ƒä¼šè¯·æ±‚æ•°æ®æºæ‰§è¡Œæ­¤æ“ä½œã€‚æ•°æ®æºä»…åŒ…å«é©±åŠ¨ä¸“æœ‰æŠ€æœ¯æ‰€éœ€çš„ä»£ç â€”â€”å¯èƒ½æ˜¯ Firebaseã€HTTP API æˆ–å…¶ä»–æŠ€æœ¯ã€‚</li>
</ul>


<h2>è‰¯å¥½çš„æ¶æ„å…è®¸å»¶è¿Ÿå†³ç­–</h2>

<p>åœ¨æ­¤é˜¶æ®µï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†åº”ç”¨çš„åŠŸèƒ½ï¼Œä»¥åŠä¸€äº›å…³äºå¦‚ä½•ç®¡ç†æ•°æ®çš„åŸºæœ¬æƒ³æ³•ã€‚</p>

<p>è¿˜æœ‰ä¸€äº›äº‹æƒ…æˆ‘ä»¬å°šæœªç¡®å®šã€‚æˆ‘ä»¬è¿˜ä¸çŸ¥é“ UI çš„å…·ä½“å¤–è§‚ï¼Œä¹Ÿä¸çŸ¥é“å°†ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ¥æ„å»ºå®ƒï¼ˆJetpack Composeã€XML ç­‰ï¼‰ã€‚æˆ‘ä»¬ä¸çŸ¥é“æœ¬åœ°ç¼“å­˜å°†é‡‡ç”¨ä½•ç§å½¢å¼ã€‚æˆ‘ä»¬ä¸çŸ¥é“å°†ä½¿ç”¨å“ªç§ä¸“æœ‰è§£å†³æ–¹æ¡ˆæ¥è®¿é—®åœ¨çº¿æ•°æ®ã€‚æˆ‘ä»¬ä¸çŸ¥é“æ˜¯å¦æ”¯æŒæ‰‹æœºã€å¹³æ¿ç”µè„‘æˆ–å…¶ä»–è®¾å¤‡ã€‚</p>

<p><strong>_é—®é¢˜ï¼šæˆ‘ä»¬éœ€è¦äº†è§£ä»¥ä¸Šä»»ä½•å†…å®¹æ‰èƒ½åˆ¶å®šæ¶æ„å—ï¼Ÿ</strong></p>

<p><strong>_ç­”æ¡ˆï¼šä¸éœ€è¦ï¼</strong></p>

<p>ä»¥ä¸Šéƒ½æ˜¯åº•å±‚è€ƒè™‘å› ç´ ï¼ˆåœ¨æ•´æ´æ¶æ„ä¸­ï¼Œå®ƒä»¬çš„ä»£ç ä½äºæœ€å¤–å±‚ï¼‰ã€‚å®ƒä»¬æ˜¯<em>å®ç°ç»†èŠ‚</em>ï¼Œè€Œä¸æ˜¯<em>é€»è¾‘</em>ã€‚SOLID çš„ä¾èµ–å€’ç½®åŸåˆ™å‘Šè¯‰æˆ‘ä»¬ï¼Œä»»ä½•ä»£ç éƒ½ä¸åº”ä¾èµ–äºå®ƒä»¬ã€‚</p>

<p>æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬åº”è¯¥èƒ½å¤Ÿåœ¨ä¸äº†è§£ä¸Šè¿°ä»»ä½•çŸ¥è¯†çš„æƒ…å†µä¸‹ç¼–å†™ï¼ˆå¹¶æµ‹è¯•ï¼ï¼‰åº”ç”¨ç¨‹åºçš„å…¶ä½™ä»£ç ã€‚å½“æˆ‘ä»¬äº†è§£ä¸Šè¿°é—®é¢˜çš„ç­”æ¡ˆæ—¶ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™çš„ä»»ä½•ä»£ç éƒ½æ— éœ€æ›´æ”¹ã€‚</p>

<p>è¿™æ„å‘³ç€ä»£ç ç”Ÿäº§é˜¶æ®µå¯ä»¥åœ¨è®¾è®¡å¸ˆå®Œæˆè®¾è®¡ä¹‹å‰ä»¥åŠåˆ©ç›Šç›¸å…³è€…å†³å®šä½¿ç”¨ç¬¬ä¸‰æ–¹æŠ€æœ¯ä¹‹å‰å¼€å§‹ã€‚å› æ­¤ï¼Œ<em>è‰¯å¥½çš„æ¶æ„å…è®¸å»¶è¿Ÿå†³ç­–</em>ã€‚ï¼ˆå¹¶ä¸”èƒ½å¤Ÿçµæ´»åœ°æ’¤é”€ä»»ä½•æ­¤ç±»å†³ç­–ï¼Œè€Œä¸ä¼šå¯¼è‡´ä¸¥é‡çš„ä»£ç é—®é¢˜ï¼‰ã€‚</p>

<h2>æˆ‘ä»¬é¡¹ç›®çš„æ¶æ„å›¾</h2>

<p>è¿™æ˜¯æˆ‘ä»¬å°†è¡Œæ˜Ÿè§‚æµ‹å‘˜çš„åº”ç”¨ç¨‹åºèå…¥ Google æ‹“æ‰‘ç»“æ„çš„åˆæ­¥å°è¯•ã€‚</p>

<h3>æ•°æ®å±‚</h3>

<p>æˆ‘ä»¬å°†æœ‰ä¸€ä¸ªç”¨äºè¡Œæ˜Ÿæ•°æ®çš„<strong>å­˜å‚¨åº“</strong>ï¼Œä»¥åŠä¸¤ä¸ª<strong>æ•°æ®æº</strong>ï¼šä¸€ä¸ªç”¨äºæœ¬åœ°ç¼“å­˜ï¼Œä¸€ä¸ªç”¨äºè¿œç¨‹æ•°æ®ã€‚</p>

<h3>UI å±‚</h3>

<p>å°†â€‹â€‹æœ‰ä¸¤ä¸ª<strong>çŠ¶æ€æŒæœ‰è€…</strong>ï¼Œä¸€ä¸ªç”¨äºè¡Œæ˜Ÿåˆ—è¡¨é¡µé¢ï¼Œå¦ä¸€ä¸ªç”¨äºæ·»åŠ è¡Œæ˜Ÿé¡µé¢ã€‚æ¯ä¸ªé¡µé¢è¿˜ä¼šæœ‰ä¸€ç»„<strong>UI å…ƒç´ </strong>ï¼Œè¿™äº›å…ƒç´ å°†ä½¿ç”¨ç›®å‰å°šå¾…ç¡®å®šçš„æŠ€æœ¯ç¼–å†™ã€‚</p>

<h3>é¢†åŸŸå±‚</h3>

<p>æœ‰ä¸¤ç§éå¸¸æœ‰æ•ˆçš„é¢†åŸŸå±‚æ¶æ„æ–¹æ³•ï¼š</p>

<ol>
<li>æˆ‘ä»¬å¯ä»¥åªåœ¨é‡å¤ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹æ·»åŠ ç”¨ä¾‹ã€‚åœ¨æˆ‘ä»¬çš„åº”ç”¨ä¸­ï¼Œå”¯ä¸€é‡å¤çš„é€»è¾‘æ˜¯æ·»åŠ è¡Œæ˜Ÿï¼šç”¨æˆ·æ·»åŠ ç¤ºä¾‹è¡Œæ˜Ÿåˆ—è¡¨å’Œæ‰‹åŠ¨è¾“å…¥è‡ªå·±çš„è¡Œæ˜Ÿè¯¦ç»†ä¿¡æ¯æ—¶éƒ½éœ€è¦å®ƒã€‚å› æ­¤ï¼Œæˆ‘ä»¬åªåˆ›å»ºä¸€ä¸ªç”¨ä¾‹ï¼šAddPlanetUseCaseã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åˆ é™¤è¡Œæ˜Ÿï¼‰ï¼ŒçŠ¶æ€æŒæœ‰è€…å°†ç›´æ¥ä¸å­˜å‚¨åº“äº¤äº’ã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥ä¸ºä¸å­˜å‚¨åº“çš„æ¯æ¬¡äº¤äº’æ·»åŠ ç”¨ä¾‹ï¼Œè¿™æ ·çŠ¶æ€æŒæœ‰è€…å’Œå­˜å‚¨åº“ä¹‹é—´å°±ä¸ä¼šæœ‰ä»»ä½•ç›´æ¥è”ç³»ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°†æœ‰æ·»åŠ è¡Œæ˜Ÿã€åˆ é™¤è¡Œæ˜Ÿå’Œåˆ—å‡ºè¡Œæ˜Ÿçš„ç”¨ä¾‹ã€‚</li>
</ol>


<p>ç¬¬äºŒç§æ–¹æ³•çš„å¥½å¤„æ˜¯å®ƒéµå¾ªäº†æ•´æ´æ¶æ„çš„è§„åˆ™ã€‚æˆ‘ä¸ªäººè®¤ä¸ºè¿™ç§æ–¹æ³•å¯¹äºå¤§å¤šæ•°åº”ç”¨æ¥è¯´æœ‰ç‚¹å¤ªé‡äº†ï¼Œæ‰€ä»¥æˆ‘å€¾å‘äºé€‰æ‹©ç¬¬ä¸€ç§ã€‚è¿™å°±æ˜¯æˆ‘ä»¬è¦åšçš„ã€‚</p>

<p>è¿™ç»™äº†æˆ‘ä»¬ä»¥ä¸‹æ¶æ„å›¾ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*69Zaett5v82b0uzpF1dgOg.png" alt="æˆ‘ä»¬åº”ç”¨çš„æ¶æ„å›¾ï¼šæ˜¾ç¤º UIã€é¢†åŸŸå’Œæ•°æ®å±‚çš„æ¶æ„å›¾" /></p>

<h2>æˆ‘ä»¬åº”è¯¥ä»å“ªäº›ä»£ç å¼€å§‹ï¼Ÿ</h2>

<p>è§„åˆ™æ˜¯ï¼š</p>

<blockquote><p>ä»é«˜å±‚ä»£ç å¼€å§‹ï¼Œç„¶åé€æ­¥å‘ä¸‹ã€‚</p></blockquote>

<p>è¿™æ„å‘³ç€é¦–å…ˆè¦å†™å‡ºç”¨ä¾‹ï¼Œå› ä¸ºè¿™æ ·åšå¯ä»¥å‘Šè¯‰æˆ‘ä»¬å­˜å‚¨åº“å±‚æœ‰å“ªäº›éœ€æ±‚ã€‚ä¸€æ—¦æˆ‘ä»¬çŸ¥é“å­˜å‚¨åº“éœ€è¦ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºæ•°æ®æºéœ€è¦ä»€ä¹ˆæ¥æ”¯æŒå®ƒã€‚</p>

<p>åŒæ ·ï¼Œç”±äºç”¨ä¾‹å‘Šè¯‰æˆ‘ä»¬ç”¨æˆ·å¯èƒ½é‡‡å–çš„æ‰€æœ‰æ“ä½œï¼Œæˆ‘ä»¬å°±å¯ä»¥äº†è§£ UI çš„æ‰€æœ‰è¾“å…¥å’Œè¾“å‡ºã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ UI éœ€è¦åŒ…å«å“ªäº›å†…å®¹ï¼Œä»è€Œå¯ä»¥ç¼–å†™çŠ¶æ€æŒæœ‰è€…ï¼ˆè§†å›¾æ¨¡å‹ï¼‰ã€‚æœ‰äº†çŠ¶æ€æŒæœ‰è€…ï¼Œæˆ‘ä»¬å°±çŸ¥é“éœ€è¦ç¼–å†™å“ªäº› UI å…ƒç´ ã€‚</p>

<p>å½“ç„¶ï¼Œä¸€æ—¦é«˜çº§å·¥ç¨‹å¸ˆå’Œé¡¹ç›®åˆ©ç›Šç›¸å…³è€…å°±å°†è¦ä½¿ç”¨çš„æŠ€æœ¯è¾¾æˆä¸€è‡´ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ— é™æœŸåœ°æ¨è¿Ÿç¼–å†™ UI å…ƒç´ å’Œæ•°æ®æºï¼ˆå³æ‰€æœ‰åº•å±‚ä»£ç ï¼‰ã€‚</p>

<p>ç†è®ºåˆ°æ­¤ç»“æŸã€‚ç°åœ¨è®©æˆ‘ä»¬å¼€å§‹æ„å»ºåº”ç”¨ç¨‹åºã€‚æˆ‘ä¼šå‘ä½ ä»¬è¯¦ç»†ä»‹ç»æˆ‘ä»¬åšå‡ºçš„å†³å®šã€‚</p>

<h2>æ­¥éª¤ 0ï¼šåˆ›å»ºé¡¹ç›®</h2>

<p>æ‰“å¼€ Android Studio å¹¶åˆ›å»ºä¸€ä¸ªâ€œæ— æ´»åŠ¨â€é¡¹ç›®ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*SQ52XlNqWwTEQ9GfsluAQA.png" alt="Android Studioâ€œNo Activityâ€é¡¹ç›®" /></p>

<p>åœ¨ä¸‹ä¸€ä¸ªå±å¹•ä¸Šï¼Œå°†å…¶å‘½åä¸º PlanetSpottersï¼Œå…¶ä»–å†…å®¹ä¿æŒä¸å˜ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*wkq8joirefCSsxeR-y3bnw.png" alt="Android Studioâ€œæ–°å»ºé¡¹ç›®â€å±å¹•æ˜¾ç¤ºè¾“å…¥çš„åç§°ä¸ºâ€œPlanetSpottersâ€" /></p>

<h3>æ·»åŠ ä¾èµ–æ³¨å…¥</h3>

<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œå®ƒæœ‰åŠ©äºåº”ç”¨ SOLID çš„ä¾èµ–å€’ç½®åŸåˆ™ã€‚ Hilt æ˜¯æˆ‘æœ€å–œæ¬¢çš„é€‰æ‹©ï¼Œè€Œä¸”å€¼å¾—åº†å¹¸çš„æ˜¯ï¼Œå®ƒä¹Ÿæ˜¯ Google ç‰¹åˆ«æ¨èçš„ã€‚</p>

<p>è¦ <a href="https://developer.android.com/training/dependency-injection/hilt-android">æ·»åŠ  Hilt</a>ï¼Œè¯·åœ¨æ ¹ Gradle æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span> <span class="n">version</span> <span class="s1">&#39;2.44.2&#39;</span> <span class="n">apply</span> <span class="kc">false</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶åœ¨ app/build.gradle æ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;kotlin-kapt&#39;</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">compileOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sourceCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>    <span class="n">targetCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">kotlinOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">jvmTarget</span> <span class="o">=</span> <span class="s1">&#39;17&#39;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">implementation</span> <span class="s2">&quot;com.google.dagger:hilt-android:2.44.2&quot;</span>
</span><span class='line'>  <span class="n">kapt</span> <span class="s2">&quot;com.google.dagger:hilt-compiler:2.44.2&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Allow references to generated code</span>
</span><span class='line'><span class="n">kapt</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">correctErrorTypes</span> <span class="kc">true</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ï¼ˆè¯·æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„å°†å…¼å®¹æ€§è®¾ç½®ä¸º Java 17ï¼Œè¿™æ˜¯ Hilt ä½¿ç”¨çš„ Kapt çš„è¦æ±‚ã€‚ä½ éœ€è¦ Android Studio Flamingo æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ã€‚</p>

<p>æœ€åï¼Œæ·»åŠ  Application ç±»çš„é‡å†™ï¼Œå…¶ä¸­åŒ…å« <code>@HiltAndroidApp</code> æ³¨è§£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åº”ç”¨çš„åŒ…æ–‡ä»¶å¤¹ï¼ˆæ­¤å¤„ä¸º <code>com.tdcolvin.planetspotters</code>ï¼‰ä¸­åˆ›å»ºä¸€ä¸ªåä¸º PlanetSpottersApplication çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">android.app.Application</span>
</span><span class='line'><span class="k">import</span> <span class="nn">dagger.hilt.android.HiltAndroidApp</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltAndroidApp</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetSpottersApplication</span><span class="p">:</span> <span class="n">Application</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>â€¦â€¦ç„¶åï¼Œé€šè¿‡å°†æ–‡ä»¶æ·»åŠ åˆ°æ¸…å•ä¸­ï¼Œå‘Šè¯‰æ“ä½œç³»ç»Ÿå®ä¾‹åŒ–å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;application</span>
</span><span class='line'>        <span class="err">....</span>
</span><span class='line'>        <span class="na">android:name=</span><span class="s">&quot;.PlanetSpottersApplication&quot;</span>
</span><span class='line'>        <span class="err">...</span>
</span><span class='line'>    <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    ...
</span><span class='line'><span class="nt">&lt;/manifest&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸€æ—¦æˆ‘ä»¬æœ‰äº†ä¸» Activityï¼Œæˆ‘ä»¬å°±éœ€è¦ä¸ºå…¶æ·»åŠ  <code>@AndroidEntryPoint</code>ã€‚ä½†ç°åœ¨ï¼Œæˆ‘ä»¬çš„ Hilt è®¾ç½®å°±å®Œæˆäº†ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬å°†é€šè¿‡åœ¨ app/build.gradle ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç æ¥æ·»åŠ å¯¹å…¶ä»–æœ‰ç”¨åº“çš„æ”¯æŒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Coroutines</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//viewModelScope</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ­¥éª¤ 1ï¼šåˆ—å‡ºç”¨æˆ·å¯ä»¥æ‰§è¡Œå’ŒæŸ¥çœ‹çš„æ‰€æœ‰åŠŸèƒ½</h2>

<p>æ­¤æ­¥éª¤æ˜¯ç¼–å†™ç”¨ä¾‹å’Œå­˜å‚¨åº“çš„å‡†å¤‡å·¥ä½œã€‚å›æƒ³ä¸€ä¸‹ï¼Œç”¨ä¾‹æ˜¯ç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„å•ä¸ªä»»åŠ¡ï¼Œå¹¶ä»¥é«˜å±‚æ¬¡æè¿°ï¼ˆæè¿°â€œä»€ä¹ˆâ€ï¼Œè€Œä¸æ˜¯â€œå¦‚ä½•â€ï¼‰ã€‚</p>

<p>å› æ­¤ï¼Œè®©æˆ‘ä»¬ä»å†™å‡ºè¿™äº›ä»»åŠ¡å¼€å§‹ï¼›åˆ—å‡ºç”¨æˆ·å¯ä»¥åœ¨åº”ç”¨ä¸­æ‰§è¡Œå’ŒæŸ¥çœ‹çš„æ‰€æœ‰åŠŸèƒ½çš„è¯¦å°½åˆ—è¡¨ã€‚</p>

<p>å…¶ä¸­ä¸€äº›ä»»åŠ¡æœ€ç»ˆä¼šè¢«ç¼–ç ä¸ºç”¨ä¾‹ã€‚ï¼ˆäº‹å®ä¸Šï¼Œåœ¨æ¸…æ™°æ¶æ„ä¸‹ï¼Œæ‰€æœ‰æ­¤ç±»ä»»åŠ¡éƒ½å¿…é¡»ä»¥ç”¨ä¾‹çš„å½¢å¼ç¼–å†™ï¼‰ã€‚å…¶ä»–ä»»åŠ¡å°†ç”± UI å±‚ç›´æ¥ä¸å­˜å‚¨åº“å±‚é€šä¿¡æ¥å®Œæˆã€‚</p>

<p>è¿™é‡Œéœ€è¦ä¸€ä»½ä¹¦é¢è§„èŒƒã€‚å®ƒä¸éœ€è¦ UI è®¾è®¡ï¼Œä½†å¦‚æœæœ‰çš„è¯ï¼Œå®ƒæ— ç–‘æœ‰åŠ©äºå¯è§†åŒ–ã€‚</p>

<p>æˆ‘ä»¬çš„åˆ—è¡¨å¦‚ä¸‹ï¼š</p>

<h3>è·å–å·²å‘ç°è¡Œæ˜Ÿçš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨ä¼šè‡ªåŠ¨æ›´æ–°</h3>

<p><strong>è¾“å…¥</strong>ï¼šæ— </p>

<p><strong>è¾“å‡º</strong>ï¼šFlow&lt;List<Planet>></p>

<p><strong>æ“ä½œ</strong>ï¼šä»å­˜å‚¨åº“è¯·æ±‚å½“å‰å·²å‘ç°è¡Œæ˜Ÿçš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å¿…é¡»ä»¥è¡¨å•å½¢å¼æä¾›ï¼Œä»¥ä¾¿åœ¨å‘ç”Ÿå˜æ›´æ—¶åŠæ—¶é€šçŸ¥æˆ‘ä»¬ã€‚</p>

<h3>è·å–å•ä¸ªå·²å‘ç°è¡Œæ˜Ÿçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯¥åˆ—è¡¨ä¼šè‡ªåŠ¨æ›´æ–°</h3>

<p><strong>è¾“å…¥</strong>ï¼šString â€” æˆ‘ä»¬è¦è·å–çš„è¡Œæ˜Ÿçš„ ID</p>

<p><strong>è¾“å‡º</strong>ï¼šFlow<Planet></p>

<p><strong>æ“ä½œ</strong>ï¼šä»å­˜å‚¨åº“è¯·æ±‚å…·æœ‰æŒ‡å®š ID çš„è¡Œæ˜Ÿï¼Œå¹¶åœ¨å‘ç”Ÿå˜æ›´æ—¶é€šçŸ¥æˆ‘ä»¬ã€‚</p>

<h3>æ·»åŠ /ç¼–è¾‘æ–°å‘ç°çš„è¡Œæ˜Ÿ</h3>

<p><strong>è¾“å…¥</strong>ï¼š</p>

<ul>
<li>planetId: String? â€” å¦‚æœéç©ºï¼Œåˆ™ä¸ºè¦ç¼–è¾‘çš„è¡Œæ˜Ÿçš„ IDã€‚å¦‚æœä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨æ·»åŠ ä¸€é¢—æ–°è¡Œæ˜Ÿã€‚</li>
<li>nameï¼šå­—ç¬¦ä¸² â€” è¡Œæ˜Ÿåç§°</li>
<li>distanceLyï¼šæµ®ç‚¹å‹ â€” è¡Œæ˜Ÿä¸åœ°çƒçš„è·ç¦»ï¼ˆå…‰å¹´ï¼‰</li>
<li>discoverï¼šæ—¥æœŸ â€” å‘ç°æ—¥æœŸ</li>
</ul>


<p><strong>è¾“å‡º</strong>ï¼šæ— ï¼ˆå®Œæˆå³æˆåŠŸï¼Œæ— å¼‚å¸¸ï¼‰</p>

<p><strong>æ“ä½œ</strong>ï¼šæ ¹æ®è¾“å…¥åˆ›å»ºä¸€ä¸ª Planet å¯¹è±¡ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å­˜å‚¨åº“ï¼ˆä»¥æ·»åŠ åˆ°å…¶æ•°æ®æºï¼‰</p>

<h3>æ·»åŠ ä¸€äº›ç¤ºä¾‹è¡Œæ˜Ÿ</h3>

<p><strong>è¾“å…¥</strong>ï¼šæ— </p>

<p><strong>è¾“å‡º</strong>ï¼šæ— ï¼ˆå‡ºé”™æ—¶æŠ›å‡ºï¼‰</p>

<p><strong>æ“ä½œ</strong>ï¼šè¯·æ±‚å­˜å‚¨åº“æ·»åŠ ä¸‰é¢—ç¤ºä¾‹è¡Œæ˜Ÿï¼Œå…¶å‘ç°æ—¥æœŸä¸ºå½“å‰æ—¶é—´ï¼šTrenzaloreï¼ˆ300 å…‰å¹´ï¼‰ã€Skaroï¼ˆ0.5 å…‰å¹´ï¼‰ã€Gallifreyï¼ˆ40 å…‰å¹´ï¼‰ã€‚</p>

<h3>åˆ é™¤è¡Œæ˜Ÿ</h3>

<p><strong>è¾“å…¥</strong>ï¼šå­—ç¬¦ä¸² â€” å¾…åˆ é™¤è¡Œæ˜Ÿçš„ ID</p>

<p><strong>è¾“å‡º</strong>ï¼šæ— ï¼ˆå‡ºé”™æ—¶æŠ›å‡ºï¼‰</p>

<p><strong>æ“ä½œ</strong>ï¼šè¯·æ±‚å­˜å‚¨åº“åˆ é™¤å…·æœ‰æŒ‡å®š ID çš„è¡Œæ˜Ÿã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬æœ‰äº†è¿™ä¸ªåˆ—è¡¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç¼–å†™ç”¨ä¾‹å’Œå­˜å‚¨åº“äº†ã€‚</p>

<h2>æ­¥éª¤ 2ï¼šç¼–å†™ç”¨ä¾‹ï¼ˆUsec asesï¼‰</h2>

<p>ä»æ­¥éª¤ 1 å¼€å§‹ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ã€‚ä¹‹å‰æˆ‘ä»¬å†³å®šï¼Œåœ¨è¿™äº›ä»»åŠ¡ä¸­ï¼Œå”¯ä¸€è¦ç¼–å†™ä¸ºç”¨ä¾‹çš„ä»»â€‹â€‹åŠ¡æ˜¯â€œæ·»åŠ æ˜Ÿçƒâ€ã€‚ï¼ˆæˆ‘ä»¬å†³å®šåªæ·»åŠ é‚£äº›åœ¨åº”ç”¨çš„ä¸åŒåŒºåŸŸé‡å¤æ‰§è¡Œä»»åŠ¡çš„ç”¨ä¾‹ï¼‰ã€‚</p>

<p>è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä¸€ä¸ªå¯ä»¥åœ¨è¿™é‡Œç¼–å†™çš„ç”¨ä¾‹ï¼š<strong>AddPlanetUseCase</strong>ã€‚</p>

<p>ä¸€ä¸ªå¾ˆæ£’çš„ Kotlin æŠ€å·§æ˜¯å°†ç”¨ä¾‹çš„é€»è¾‘æ”¾åœ¨ <code>operator fun invoke(â€¦)</code> å‡½æ•°ä¸­ã€‚è¿™æ ·å°±å¯ä»¥åƒè°ƒç”¨å‡½æ•°ä¸€æ ·è°ƒç”¨ä»£ç æ¥â€œè°ƒç”¨â€ç±»å®ä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span> <span class="p">=</span> <span class="err">â€¦</span><span class="c1">//Use our instance as if it were a function:</span>
</span><span class='line'><span class="n">addPlanetUseCase</span><span class="p">(</span><span class="err">â€¦</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯æˆ‘ä»¬ä½¿ç”¨è¯¥æŠ€å·§ç¼–å†™çš„ AddPlanetUseCase ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddPlanetUseCase</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please specify a planet name&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a positive distance&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">discovered</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="n">Date</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a discovery date in the past&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œçš„ PlanetsRepository æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒåˆ—å‡ºäº†å­˜å‚¨åº“å°†æ‹¥æœ‰çš„æ–¹æ³•ã€‚ç¨åä¼šè¯¦ç»†ä»‹ç»ï¼ˆç‰¹åˆ«æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åˆ›å»ºæ¥å£è€Œä¸æ˜¯ç±»ï¼‰ã€‚ä½†ç°åœ¨æˆ‘ä»¬å…ˆåˆ›å»ºå®ƒï¼Œè¿™æ ·æˆ‘ä»¬çš„ä»£ç å°±èƒ½ç¼–è¯‘äº†ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æè¿° Planet çš„æ•°æ®ç±»å‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Planet</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">discovered</span><span class="p">:</span> <span class="n">Date</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>addPlanet æ–¹æ³•ï¼ˆç±»ä¼¼äºç”¨ä¾‹ä¸­çš„ invoke å‡½æ•°ï¼‰è¢«å£°æ˜ä¸º <code>suspend</code>ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å®ƒä¼šæ¶‰åŠåå°å·¥ä½œã€‚ç¨åæˆ‘ä»¬ä¼šå‘æ­¤æ¥å£æ·»åŠ æ›´å¤šæ–¹æ³•ï¼Œä½†ç›®å‰è¿™å·²ç»è¶³å¤Ÿäº†ã€‚</p>

<p>é¡ºä¾¿è¯´ä¸€å¥ï¼Œä½ å¯èƒ½ä¼šé—®ï¼Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦è´¹å¿ƒåˆ›å»ºä¸€ä¸ªå¦‚æ­¤ç®€å•çš„ç”¨ä¾‹ï¼Ÿç­”æ¡ˆåœ¨äºå®ƒå¯èƒ½ä¼šå¦‚ä½•å‘å±•ã€‚æœªæ¥å®ƒå¯èƒ½ä¼šå˜å¾—æ›´åŠ å¤æ‚ï¼Œè€Œå¤–éƒ¨ä»£ç å¯ä»¥ä¸è¿™ç§å¤æ‚æ€§éš”ç¦»å¼€æ¥ã€‚</p>

<h2>æ­¥éª¤ 2.1ï¼šæµ‹è¯•ç”¨ä¾‹</h2>

<p>æˆ‘ä»¬ç°åœ¨å·²ç»ç¼–å†™äº†ç”¨ä¾‹ï¼Œä½†æ— æ³•è¿è¡Œå®ƒã€‚é¦–å…ˆï¼Œå®ƒä¾èµ–äº <code>PlanetsRepository</code> æ¥å£ï¼Œè€Œæˆ‘ä»¬è¿˜æ²¡æœ‰å®ƒçš„å®ç°ã€‚Hilt ä¸çŸ¥é“è¯¥å¦‚ä½•å¤„ç†å®ƒã€‚</p>

<p>ä½†æˆ‘ä»¬å¯ä»¥ç¼–å†™æµ‹è¯•ï¼Œæä¾›ä¸€ä¸ªä¼ªé€ çš„ <code>PlanetsRepository</code> å®ä¾‹ï¼Œå¹¶ä½¿ç”¨æˆ‘ä»¬çš„æµ‹è¯•æ¡†æ¶è¿è¡Œå®ƒã€‚è¿™å°±æ˜¯ä½ ç°é˜¶æ®µåº”è¯¥åšçš„äº‹æƒ…ã€‚</p>

<p>ç”±äºè¿™æ˜¯ä¸€ä¸ªå…³äºæ¶æ„çš„æ•™ç¨‹ï¼Œæµ‹è¯•çš„å…·ä½“ç»†èŠ‚è¶…å‡ºäº†èŒƒå›´ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥ç•™ä½œç»ƒä¹ ã€‚ä½†è¯·æ³¨æ„ï¼Œè‰¯å¥½çš„æ¶æ„è®¾è®¡ä½¿æˆ‘ä»¬èƒ½å¤Ÿå°†ç»„ä»¶æ‹†åˆ†æˆæ˜“äºæµ‹è¯•çš„éƒ¨åˆ†ã€‚</p>

<h2>æ­¥éª¤ 3ï¼šæ•°æ®å±‚ï¼Œç¼–å†™ PlanetsRepository</h2>

<p>è¯·è®°ä½ï¼Œå­˜å‚¨åº“çš„ä½œç”¨æ˜¯æ•´ç†ä¸åŒçš„æ•°æ®æºï¼Œç®¡ç†å®ƒä»¬ä¹‹é—´çš„å·®å¼‚ï¼Œå¹¶æä¾› CRUD æ“ä½œã€‚</p>

<h3>ä½¿ç”¨ä¾èµ–å€’ç½®å’Œä¾èµ–æ³¨å…¥</h3>

<p>æ ¹æ®æ•´æ´æ¶æ„å’Œä¾èµ–å€’ç½®åŸåˆ™ï¼ˆæ›´å¤šä¿¡æ¯è¯·å‚é˜…æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…å¤–éƒ¨ä»£ç ä¾èµ–äºå­˜å‚¨åº“å®ç°å†…éƒ¨çš„ä»£ç ã€‚è¿™æ ·ï¼Œç”¨ä¾‹æˆ–è§†å›¾æ¨¡å‹ï¼ˆä¾‹å¦‚ï¼‰å°±ä¸ä¼šå—åˆ°å­˜å‚¨åº“ä»£ç æ›´æ”¹çš„å½±å“ã€‚</p>

<p>è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¹‹å‰å°† PlanetsRepository åˆ›å»ºä¸ºæ¥å£ï¼ˆè€Œä¸æ˜¯ç±»ï¼‰ã€‚è°ƒç”¨ä»£ç å°†ä»…ä¾èµ–äºæ¥å£ï¼Œä½†å®ƒå°†é€šè¿‡ä¾èµ–æ³¨å…¥æ¥æ”¶å®ç°ã€‚ç°åœ¨æˆ‘ä»¬å°†å‘æ¥å£æ·»åŠ æ›´å¤šæ–¹æ³•ï¼Œå¹¶åˆ›å»ºå®ƒçš„å®ç°ï¼Œæˆ‘ä»¬å°†å…¶å‘½åä¸º <strong>DefaultPlanetsRepository</strong>ã€‚</p>

<p>ï¼ˆè¡¥å……ï¼šä¸€äº›å¼€å‘å›¢é˜Ÿä¹ æƒ¯å°†å®ç°å‘½åä¸º <code>&lt;æ¥å£åç§°&gt;Impl</code>ï¼›ä¾‹å¦‚ <code>PlanetsRepositoryImpl</code>ã€‚æˆ‘è®¤ä¸ºè¿™ç§çº¦å®šä¸åˆ©äºä»£ç å¯è¯»æ€§ï¼šç±»ååº”è¯¥èƒ½å¤Ÿè¯´æ˜å®ç°æ¥å£çš„åŸå› ã€‚æ‰€ä»¥æˆ‘é¿å…ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ä½†æˆ‘è¿˜æ˜¯æåˆ°äº†å®ƒï¼Œå› ä¸ºå®ƒçš„ä½¿ç”¨éå¸¸å¹¿æ³›ã€‚ï¼‰</p>

<h3>ä½¿ç”¨ Kotlin Flows å®ç°æ•°æ®å¯ç”¨</h3>

<p>å¦‚æœä½ è¿˜æ²¡æœ‰æ¥è§¦è¿‡ <a href="https://developer.android.com/kotlin/flow">Kotlin Flows</a>ï¼Œé‚£å°±èµ¶ç´§åœä¸‹æ‰‹å¤´çš„å·¥ä½œï¼Œç°åœ¨å°±å»äº†è§£ä¸€ä¸‹å§ã€‚å®ƒä»¬å°†æ”¹å˜ä½ çš„ç”Ÿæ´»ã€‚</p>

<p>å®ƒä»¬æä¾›äº†ä¸€ä¸ªæ•°æ®â€œç®¡é“â€ï¼Œä¼šéšç€æ–°ç»“æœçš„å‡ºç°è€Œå˜åŒ–ã€‚åªè¦è°ƒç”¨è€…æ³¨å†Œäº†è¯¥ç®¡é“ï¼Œä»–ä»¬å°±ä¼šåœ¨å‘ç”Ÿå˜æ›´æ—¶æ”¶åˆ°æ›´æ–°ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬çš„ UI å¯ä»¥éšç€æ•°æ®æ›´æ–°è€Œè‡ªåŠ¨æ›´æ–°ï¼Œå‡ ä¹æ— éœ€ä»»ä½•é¢å¤–æ“ä½œã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œè¿‡å»æˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨å‘ UI æ ‡è®°æ•°æ®å·²æ›´æ”¹ã€‚</p>

<p>å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œä¾‹å¦‚ RxJava å’Œ MutableLiveDataï¼Œå®ƒä»¬å…·æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†å®ƒä»¬ä¸å¦‚ Flows çµæ´»æ˜“ç”¨ã€‚</p>

<h3>æ·»åŠ æ— å¤„ä¸åœ¨çš„ WorkResult ç±»</h3>

<p>WorkResult ç±»æ˜¯æ•°æ®å±‚çš„å¸¸è§è¿”å›å€¼ã€‚å®ƒå…è®¸æˆ‘ä»¬æè¿°ç‰¹å®šè¯·æ±‚æ˜¯å¦æˆåŠŸï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">WorkResult</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">exception</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è°ƒç”¨ä»£ç å¯ä»¥æ£€æŸ¥ç»™å®šçš„ WorkResult æ˜¯â€œSuccessâ€ã€â€œErrorâ€è¿˜æ˜¯â€œLoadingâ€å¯¹è±¡ï¼ˆåè€…è¡¨ç¤ºè¯·æ±‚å°šæœªå®Œæˆï¼‰ï¼Œä»è€Œç¡®å®šè¯·æ±‚æ˜¯å¦æˆåŠŸã€‚</p>

<h3>æˆ‘ä»¬çš„å­˜å‚¨åº“æ¥å£</h3>

<p>è®©æˆ‘ä»¬å°†ä»¥ä¸Šæ‰€æœ‰å†…å®¹ç»“åˆèµ·æ¥ï¼Œåˆ¶å®šæ„æˆ PlanetsRepository çš„æ–¹æ³•å’Œå±æ€§çš„è§„èŒƒã€‚</p>

<p>å®ƒæœ‰ä¸¤ç§è·å–è¡Œæ˜Ÿçš„æ–¹æ³•ã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•é€šè¿‡ ID è·å–å•ä¸ªè¡Œæ˜Ÿï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç¬¬äºŒä¸ªæ–¹æ³•è·å–ä¸€ä¸ªä»£è¡¨è¡Œæ˜Ÿåˆ—è¡¨çš„ Flowï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯å„è‡ªæ•°æ®çš„å”¯ä¸€çœŸå®æ¥æºã€‚æ¯æ¬¡æˆ‘ä»¬éƒ½ä¼šè¿”å›å­˜å‚¨åœ¨æœ¬åœ°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å¤„ç†è¿™äº›æ–¹æ³•çš„é¢‘ç¹è¿è¡Œï¼Œè€Œä¸”æœ¬åœ°æ•°æ®æ¯”è®¿é—®è¿œç¨‹æ•°æ®æºæ›´å¿«ã€æ›´ä¾¿å®œã€‚ä½†æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–¹æ³•æ¥åˆ·æ–°æœ¬åœ°ç¼“å­˜ã€‚è¿™å°†ä»è¿œç¨‹æ•°æ®æºæ›´æ–°æœ¬åœ°æ•°æ®æºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦æ·»åŠ ã€æ›´æ–°å’Œåˆ é™¤è¡Œæ˜Ÿçš„æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ‰€ä»¥æˆ‘ä»¬çš„ç•Œé¢ç°åœ¨çœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>è¾¹å†™è¾¹å†™æ•°æ®æºæ¥å£</h3>

<p>ä¸ºäº†ç¼–å†™å®ç°æ¥å£çš„ç±»ï¼Œæˆ‘ä»¬éœ€è¦å…³æ³¨æ•°æ®æºéœ€è¦å“ªäº›æ–¹æ³•ã€‚å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªæ•°æ®æºï¼šLocalDataSource å’Œ RemoteDataSourceã€‚æˆ‘ä»¬è¿˜æ²¡æœ‰å†³å®šä½¿ç”¨å“ªç§ç¬¬ä¸‰æ–¹æŠ€æœ¯â€”â€”è€Œä¸”ç°åœ¨ä¹Ÿä¸éœ€è¦ã€‚</p>

<p>ç°åœ¨è®©æˆ‘ä»¬åˆ›å»ºæ¥å£å®šä¹‰ï¼Œä»¥ä¾¿æˆ‘ä»¬è¾¹å†™è¾¹æ·»åŠ æ–¹æ³•ç­¾åï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.local</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.remote</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‡†å¤‡å¥½å¡«å……è¿™äº›æ¥å£åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥ç¼–å†™ DefaultPlanetsRepository äº†ã€‚è®©æˆ‘ä»¬é€ä¸€è°ƒç”¨è¿™äº›æ–¹æ³•ï¼š</p>

<h3>ç¼–å†™ getPlanetFlow() å’Œ getPlanetsFlow()</h3>

<p>è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¾ˆç®€å•ï¼›æˆ‘ä»¬è¿”å›æœ¬åœ°æ•°æ®æºä¸­çš„æ•°æ®ã€‚ ï¼ˆä¸ºä»€ä¹ˆä¸ä½¿ç”¨è¿œç¨‹æ•°æ®æºï¼Ÿå› ä¸ºæœ¬åœ°æ•°æ®æºçš„å­˜åœ¨æ˜¯ä¸ºäº†å¿«é€Ÿã€è½»é‡åœ°è®¿é—®æ•°æ®ã€‚è¿œç¨‹æ•°æ®æºå¯èƒ½å§‹ç»ˆæ˜¯æœ€æ–°çš„ï¼Œä½†é€Ÿåº¦å¾ˆæ…¢ã€‚å¦‚æœæˆ‘ä»¬ç¡®å®éœ€è¦æœ€æ–°çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨è°ƒç”¨ getPlanetsFlow() ä¹‹å‰ä½¿ç”¨ä¸‹é¢çš„ refershPlanets()ã€‚ï¼‰</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ‰€ä»¥è¿™ä¾èµ–äº LocalDataSource ä¸­çš„ getPlanetFlow() å’Œ getPlanetsFlow() å‡½æ•°ã€‚æˆ‘ä»¬ç°åœ¨å°†å®ƒä»¬æ·»åŠ åˆ°æ¥å£ä¸­ï¼Œä»¥ä¾¿ä»£ç èƒ½å¤Ÿç¼–è¯‘ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ç¼–å†™ refreshPlanets()</h3>

<p>è¦æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œæˆ‘ä»¬ä»è¿œç¨‹æ•°æ®æºè·å–å½“å‰çš„è¡Œæ˜Ÿåˆ—è¡¨ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°æœ¬åœ°æ•°æ®æºã€‚ï¼ˆç„¶åï¼Œæœ¬åœ°æ•°æ®æºå¯ä»¥â€œæ³¨æ„åˆ°â€æ›´æ”¹ï¼Œå¹¶é€šè¿‡ getPlanetsFlow() è¿”å›çš„ Flow å‘å‡ºæ–°çš„è¡Œæ˜Ÿåˆ—è¡¨ã€‚ï¼‰</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">getPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™éœ€è¦åœ¨æ¯ä¸ªæ•°æ®æºæ¥å£ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–¹æ³•ï¼Œç°åœ¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ³¨æ„æ‰€æœ‰è¿™äº›æ–¹æ³•éƒ½è¢«å£°æ˜ä¸ºâ€œsuspend funâ€ã€‚è¿™å°†çº¿ç¨‹å’Œåç¨‹ä¸Šä¸‹æ–‡çš„è´£ä»»è½¬äº¤ç»™è°ƒç”¨è€…ã€‚</p>

<h3>ç¼–å†™ addPlanet() å’Œ deletePlanet()</h3>

<p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½éµå¾ªç›¸åŒçš„æ¨¡å¼ï¼šå¯¹è¿œç¨‹æ•°æ®æºæ‰§è¡Œå†™å…¥æ“ä½œï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™å°†æ›´æ”¹é•œåƒåˆ°æœ¬åœ°ç¼“å­˜ã€‚</p>

<p>æˆ‘ä»¬æœŸæœ›è¿œç¨‹æ•°æ®æºåœ¨ Planet å¯¹è±¡å†™å…¥æ•°æ®åº“åä¸ºå…¶åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„ IDï¼Œå› æ­¤ RemoteDataSource çš„ addPlanet() å‡½æ•°è¿”å›ä¸€ä¸ªæ›´æ–°åçš„ Planet å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰éç©ºçš„IDï¼ˆNonNull IDï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetWithId</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planetWithId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®Œæˆæ‰€æœ‰è¿™äº›ä¹‹åï¼Œæœ€ç»ˆçš„æ•°æ®æºæ¥å£å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">):</span> <span class="n">Planet</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬ç¨åä¼šç¼–å†™å®ç°è¿™äº›æ¥å£çš„ä»£ç ï¼Œä½†ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ UIã€‚</p>

<h2>æ­¥éª¤ 4ï¼šçŠ¶æ€æŒæœ‰è€…ï¼Œç¼–å†™ PlanetsListViewModel</h2>

<p>å›æƒ³ä¸€ä¸‹ï¼ŒUI å±‚ç”± UI å…ƒç´ å’ŒçŠ¶æ€æŒæœ‰è€…å±‚ç»„æˆï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*Z0Px8K4iaChOzLPxDd9GPw.png" alt="UIå±‚" /></p>

<p>ç›®å‰æˆ‘ä»¬è¿˜ä¸çŸ¥é“è¦ä½¿ç”¨ä»€ä¹ˆæŠ€æœ¯æ¥ç»˜åˆ¶ UIï¼Œæ‰€ä»¥è¿˜ä¸èƒ½ç¼–å†™ UI å…ƒç´ å±‚ã€‚ä½†è¿™æ²¡å…³ç³»ï¼›æˆ‘ä»¬å¯ä»¥ç»§ç»­ç¼–å†™çŠ¶æ€æŒæœ‰è€…ï¼Œè€Œä¸”ä¸€æ—¦æˆ‘ä»¬åšå‡ºå†³å®šï¼Œå®ƒä»¬å°±æ— éœ€æ›´æ”¹ã€‚è¿™å°±æ˜¯ä¼˜ç§€æ¶æ„çš„æ›´å¤šä¼˜åŠ¿ï¼</p>

<h3>ç¼–å†™ PlanetsListViewModel çš„è§„èŒƒ</h3>

<p>UI å°†åŒ…å«ä¸¤ä¸ªé¡µé¢ï¼Œä¸€ä¸ªç”¨äºåˆ—å‡ºå’Œåˆ é™¤è¡Œæ˜Ÿï¼Œå¦ä¸€ä¸ªç”¨äºæ·»åŠ æˆ–ç¼–è¾‘è¡Œæ˜Ÿã€‚PlanetsListViewModel ä¸ºå‰è€…æä¾›æ”¯æŒã€‚è¿™æ„å‘³ç€å®ƒéœ€è¦å°†æ•°æ®æš´éœ²ç»™è¡Œæ˜Ÿåˆ—è¡¨å±å¹•çš„ UI å…ƒç´ ï¼Œå¹¶ä¸”å¿…é¡»å‡†å¤‡å¥½åœ¨ç”¨æˆ·æ‰§è¡Œæ“ä½œæ—¶æ¥æ”¶æ¥è‡ª UI å…ƒç´ çš„äº‹ä»¶ã€‚</p>

<p>å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬çš„ PlanetsListViewModel éœ€è¦æš´éœ²ï¼š</p>

<ul>
<li>æè¿°é¡µé¢å½“å‰çŠ¶æ€çš„ Flowï¼ˆè‡³å…³é‡è¦çš„æ˜¯ï¼Œå®ƒåŒ…å«è¡Œæ˜Ÿåˆ—è¡¨ï¼‰</li>
<li>åˆ·æ–°åˆ—è¡¨çš„æ–¹æ³•</li>
<li>åˆ é™¤è¡Œæ˜Ÿçš„æ–¹æ³•</li>
<li>æ·»åŠ ç¤ºä¾‹è¡Œæ˜Ÿçš„æ–¹æ³•ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£åº”ç”¨çš„åŠŸèƒ½</li>
</ul>


<h3>PlanetsListUiState å¯¹è±¡ï¼šé¡µé¢çš„å½“å‰çŠ¶æ€</h3>

<p>æˆ‘å‘ç°å°†é¡µé¢çš„æ•´ä¸ªçŠ¶æ€åŒ…å«åœ¨ä¸€ä¸ªæ•°æ®ç±»ä¸­å¾ˆæœ‰å¸®åŠ©ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">PlanetsListUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯·æ³¨æ„ï¼Œæˆ‘å·²å°†å…¶ä¸è§†å›¾æ¨¡å‹å®šä¹‰åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚å®ƒä»…åŒ…å«ç®€å•å¯¹è±¡ï¼šæ²¡æœ‰ Flow ç­‰ï¼Œåªæœ‰åŸå§‹ç±»å‹ã€æ•°ç»„å’Œç®€å•çš„æ•°æ®ç±»ã€‚å¦è¯·æ³¨æ„ï¼Œæ‰€æœ‰å­—æ®µéƒ½æœ‰é»˜è®¤å€¼â€”â€”è¿™å°†åœ¨åé¢å¸®åŠ©æˆ‘ä»¬ã€‚</p>

<p>ï¼ˆæœ‰ä¸€äº›å¾ˆå¥½çš„ç†ç”±è®©ä½ ç”šè‡³ä¸å¸Œæœ› Planet å¯¹è±¡å‡ºç°åœ¨ä¸Šé¢çš„ä»£ç ä¸­ã€‚æ•´æ´æ¶æ„çš„çº¯ç²¹ä¸»ä¹‰è€…ä¼šæŒ‡å‡ºï¼Œåœ¨ Planet çš„å®šä¹‰å’Œä½¿ç”¨ä¹‹é—´ï¼Œå±‚çº§è·³è·ƒå¤ªå¤šäº†ã€‚çŠ¶æ€æå‡åŸåˆ™å‘Šè¯‰æˆ‘ä»¬ï¼Œåªæä¾›æˆ‘ä»¬éœ€è¦çš„ç²¾ç¡®æ•°æ®ã€‚ä¾‹å¦‚ï¼Œç°åœ¨æˆ‘ä»¬åªéœ€è¦ Planet çš„åç§°å’Œè·ç¦»ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”è¯¥åªæä¾›è¿™äº›ï¼Œè€Œä¸æ˜¯æ•´ä¸ª Planet å¯¹è±¡ã€‚æˆ‘ä¸ªäººè®¤ä¸ºè¿™ä¸å¿…è¦åœ°å¢åŠ äº†ä»£ç çš„å¤æ‚æ€§ï¼Œå¹¶ä½¿æœªæ¥çš„ä¿®æ”¹æ›´åŠ å›°éš¾ï¼Œä½†ä½ å¯ä»¥ä¸åŒæ„ï¼ï¼‰</p>

<p>å®šä¹‰å¥½ä¹‹åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥åœ¨è§†å›¾æ¨¡å‹ä¸­åˆ›å»ºä¸€ä¸ªçŠ¶æ€å˜é‡æ¥æš´éœ²å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.ui.planetslist</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetsListViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">planets</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">planets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">planets</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">initialValue</span> <span class="p">=</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>çœ‹çœ‹å¦‚ä½•æ ¹æ®åˆšä»å­˜å‚¨åº“æ”¶åˆ°çš„ä¸åŒç±»å‹çš„ç»“æœæ¥åˆ›å»ºâ€œä¸‹ä¸€ä¸ªâ€UI çŠ¶æ€ï¼Ÿ</p>

<p><code>.stateIn(â€¦)</code> çš„ <code>scope</code> å’Œ <code>started</code> å‚æ•°å®‰å…¨åœ°é™åˆ¶äº†æ­¤ StateFlow çš„ç”Ÿå‘½å‘¨æœŸã€‚æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… <a href="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3">Manual Vivo çš„ç²¾å½©æ–‡ç« </a>ã€‚</p>

<h3>æ·»åŠ ç¤ºä¾‹è¡Œæ˜Ÿ</h3>

<p>ä¸ºäº†æ·»åŠ è¿™ 3 ä¸ªç¤ºä¾‹è¡Œæ˜Ÿï¼Œæˆ‘ä»¬åå¤è°ƒç”¨ä¸ºæ­¤åˆ›å»ºçš„ç”¨ä¾‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">addSamplePlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Skaro&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">0.5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Trenzalore&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Galifrey&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">80F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">planets</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">addPlanetUseCase</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>åˆ·æ–°å’Œåˆ é™¤</h3>

<p>åˆ·æ–°å’Œåˆ é™¤å‡½æ•°çš„ç»“æ„éå¸¸ç›¸ä¼¼ï¼Œåªéœ€è°ƒç”¨ç›¸åº”çš„å­˜å‚¨åº“å‡½æ•°å³å¯ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">refreshPlanetsList</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ­¥éª¤ 5ï¼šç¼–å†™ AddEditPlanetViewModel</h2>

<p>AddEditPlanetViewModel ä¸ºç”¨äºæ·»åŠ æ–°è¡Œæ˜Ÿæˆ–ç¼–è¾‘ç°æœ‰è¡Œæ˜Ÿçš„å±å¹•æä¾›æ”¯æŒã€‚</p>

<p>æ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€åšçš„é‚£æ ·â€”â€”äº‹å®ä¸Šï¼Œè¿™ä¹Ÿæ˜¯ä»»ä½•è§†å›¾æ¨¡å‹çš„è‰¯å¥½å®è·µâ€”â€”æˆ‘ä»¬å°†ä¸º UI æ˜¾ç¤ºçš„æ‰€æœ‰å†…å®¹å®šä¹‰ä¸€ä¸ªæ•°æ®ç±»ï¼Œå¹¶ä¸ºå…¶å®šä¹‰ä¸€ä¸ªå•ä¸€çš„æ•°æ®æºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">AddEditPlanetUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetName</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDistanceLy</span><span class="p">:</span> <span class="n">Float</span> <span class="p">=</span> <span class="m">1.0F</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDiscovered</span><span class="p">:</span> <span class="n">Date</span> <span class="p">=</span> <span class="n">Date</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isPlanetSaved</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">():</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæˆ‘ä»¬æ­£åœ¨ç¼–è¾‘ä¸€ä¸ªæ˜Ÿçƒï¼ˆè€Œä¸æ˜¯æ·»åŠ ä¸€ä¸ªæ–°çš„æ˜Ÿçƒï¼‰ï¼Œæˆ‘ä»¬å¸Œæœ›è§†å›¾çš„åˆå§‹çŠ¶æ€ä»£è¡¨è¯¥æ˜Ÿçƒçš„å½“å‰çŠ¶æ€ã€‚</p>

<p>æŒ‰ç…§è‰¯å¥½å®è·µï¼Œæ­¤å±å¹•åªä¼šä¼ é€’æˆ‘ä»¬æ­£åœ¨ç¼–è¾‘çš„æ˜Ÿçƒçš„ IDã€‚ï¼ˆæˆ‘ä»¬ä¸ä¼šä¼ é€’æ•´ä¸ª Planet å¯¹è±¡â€”â€”è¿™å¯èƒ½ä¼šå˜å¾—å¤ªå¤§å¤ªå¤æ‚ï¼‰ã€‚Android çš„ Lifecycle ç»„ä»¶ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª SavedStateHandleï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­è·å–æ˜Ÿçƒ ID å¹¶åŠ è½½ Planet å¯¹è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">savedStateHandle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">[</span><span class="n">PlanetsDestinationsArgs</span><span class="p">.</span><span class="n">PLANET_ID_ARG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planetId</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!</span><span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">||</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">planet</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetName</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDiscovered</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">discovered</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¯·æ³¨æ„æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨è¿™ç§æ¨¡å¼æ›´æ–° UI çŠ¶æ€ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span> <span class="p">...</span> <span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åªéœ€ä¸€è¡Œç®€å•çš„ä»£ç ï¼Œå³å¯åˆ›å»ºä¸€ä¸ªæ–°çš„ AddEditPlanetUiStateï¼Œå…¶å€¼ä»å‰ä¸€ä¸ªå¤åˆ¶è€Œæ¥ï¼Œå¹¶é€šè¿‡ uiState Flow å°†å…¶å‘é€å‡ºå»ã€‚</p>

<p>ä»¥ä¸‹æ˜¯ä½¿ç”¨è¯¥æŠ€æœ¯æ›´æ–°è¡Œæ˜Ÿå„é¡¹å±æ€§çš„å‡½æ•°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">setPlanetName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetName</span> <span class="p">=</span> <span class="n">name</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">setPlanetDistanceLy</span><span class="p">(</span><span class="n">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">distanceLy</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åï¼Œæˆ‘ä»¬ä½¿ç”¨ AddPlanetUseCase ä¿å­˜è¡Œæ˜Ÿå¯¹è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">savePlanet</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">addPlanetUseCase</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Planet</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">planetId</span> <span class="p">=</span> <span class="n">planetId</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">name</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetName</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">distanceLy</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDistanceLy</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">discovered</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDiscovered</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isPlanetSaved</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ­¥éª¤ 6ï¼šç¼–å†™æ•°æ®æºå’Œ UI å…ƒç´ </h2>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å®Œæˆäº†æ•´ä¸ªæ¶æ„ï¼Œå¯ä»¥ç¼–å†™æœ€åº•å±‚çš„ä»£ç äº†ã€‚ä¹Ÿå°±æ˜¯ UI å…ƒç´ å’Œæ•°æ®æºã€‚å¯¹äº UI å…ƒç´ ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä½¿ç”¨ Jetpack Compose æ¥æ”¯æŒæ‰‹æœºå’Œå¹³æ¿ç”µè„‘ã€‚å¯¹äºæœ¬åœ°æ•°æ®æºï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Room DB ç¼–å†™ç¼“å­˜ï¼›å¯¹äºè¿œç¨‹æ•°æ®æºï¼Œæˆ‘ä»¬å¯ä»¥æ¨¡æ‹Ÿè®¿é—®è¿œç¨‹ APIã€‚</p>

<p>è¿™äº›å±‚åº”è¯¥å°½å¯èƒ½ç²¾ç®€ã€‚ä¾‹å¦‚ï¼ŒUI å…ƒç´ ä»£ç ä¸åº”åŒ…å«ä»»ä½•è®¡ç®—æˆ–é€»è¾‘ï¼Œè€Œåº”ä»…åŒ…å«è·å–è§†å›¾æ¨¡å‹ç»™å®šçŠ¶æ€å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ‰€éœ€çš„ä»£ç ã€‚é€»è¾‘æ˜¯ä¸ºè§†å›¾æ¨¡å‹ç¼–å†™çš„ã€‚</p>

<p>å¯¹äºæ•°æ®æºï¼Œåªéœ€ç¼–å†™å®ç° LocalDataSource å’Œ RemoteDataSource æ¥å£ä¸­å‡½æ•°æ‰€éœ€çš„æœ€å°‘ä»£ç å³å¯ã€‚</p>

<p>å…·ä½“çš„ç¬¬ä¸‰æ–¹æŠ€æœ¯ï¼ˆä¾‹å¦‚ Compose å’Œ Roomï¼‰ä¸åœ¨æœ¬æ•™ç¨‹çš„è®¨è®ºèŒƒå›´å†…ï¼Œä½†ä½ å¯ä»¥åœ¨<a href="https://github.com/tdcolvin/PlanetSpotters">ä»£ç ä»“åº“</a> ä¸­æŸ¥çœ‹è¿™äº›å±‚çš„ç¤ºä¾‹å®ç°ã€‚</p>

<h3>å°†åº•å±‚ä»£ç ç•™åˆ°æœ€å</h3>

<p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬èƒ½å¤Ÿå°†åº”ç”¨ç¨‹åºçš„è¿™äº›éƒ¨åˆ†ç•™åˆ°æœ€åã€‚è¿™éå¸¸æœ‰ç›Šï¼Œå› ä¸ºå®ƒä¸ºåˆ©ç›Šç›¸å…³è€…æä¾›äº†å……è¶³çš„æ—¶é—´æ¥å†³å®šä½¿ç”¨å“ªäº›ç¬¬ä¸‰æ–¹æŠ€æœ¯ä»¥åŠåº”ç”¨ç¨‹åºçš„å¤–è§‚ã€‚å³ä½¿åœ¨ç¼–å†™ä»£ç ä¹‹åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ’¤é”€è¿™äº›å†³å®šï¼Œè€Œä¸ä¼šå½±å“åº”ç”¨ç¨‹åºçš„ä»»ä½•å…¶ä»–éƒ¨åˆ†ã€‚</p>

<p>å®Œæ•´çš„ä»£ç åº“ä½äºï¼š<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>ã€‚</p>

<p>æœ¬æ•™ç¨‹æœ‰å¾ˆå¤šå†…å®¹éœ€è¦å­¦ä¹ ï¼›ç¥è´ºä½ åšæŒåˆ°æœ€åã€‚å¸Œæœ›æœ¬æ•™ç¨‹å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚æˆ‘æ²¡æœ‰å¾½ç« ï¼ˆæ›´ä¸ç”¨è¯´æ–‡å‡­ï¼‰å¯ä»¥é¢å‘â€”â€”ä½†è¯·éšæ„ï¼ˆç”šè‡³é¼“åŠ±ï¼‰è‡ªå·±åˆ¶ä½œä¸€ä¸ªï¼Œå¹¶å°†ç»“æœå‘å¸ƒåœ¨è¿™é‡Œã€‚</p>

<p>å½“ç„¶ï¼Œå¦‚æœä½ æœ‰ä»»ä½•é—®é¢˜æˆ–æ„è§ï¼Œæˆ–è€…ä½ ä¸åŒæ„æŸäº›è§‚ç‚¹ï¼ˆå®é™…ä¸Š<em>ç‰¹åˆ«æ˜¯</em>å¦‚æœä½ ä¸åŒæ„æŸäº›è§‚ç‚¹ï¼‰ï¼Œè¯·åˆ†äº«ï¼è¯·åœ¨æ­¤å¤„ç•™è¨€ï¼Œæˆ‘ä¼šå°½åŠ›å›å¤æ‰€æœ‰äººã€‚</p>

<p>æœ€åï¼Œæˆ‘ç›®å‰æ¯å‘¨æä¾›å‡ èŠ‚å…è´¹è¯¾ç¨‹ï¼Œå¸®åŠ©ä»»ä½•æœ‰ Android å¼€å‘æˆ–åº”ç”¨ä¸šåŠ¡ç›¸å…³ç»éªŒçš„äººå£«ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé¢„çº¦ï¼š<a href="https://calendly.com/tdcolvin/android-assistance">calendly.com/tdcolvin/android-assistance</a>ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å¦‚ä½•æ„å»ºAndroidåº”ç”¨ï¼šæ·±å…¥æ¢è®¨åŸåˆ™è€Œéè§„åˆ™]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app/"/>
    <updated>2025-10-11T13:34:02+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒHow to architect Android apps: a deep dive into principles, not rulesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/how-to-architect-android-apps-a-deep-dive-into-principles-not-rules-2f1eb7f26402">https://proandroiddev.com/how-to-architect-android-apps-a-deep-dive-into-principles-not-rules-2f1eb7f26402</a>ï¼Œç”±Tom Colvinå‘å¸ƒäº2023å¹´5æœˆ25æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*kT0PbUHF8ld0sU0t" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å¤šæ•° Android å¼€å‘è€…éƒ½ç»å†è¿‡è¿™æ ·çš„åœºæ™¯â€¦â€¦ä½ è¢«è¦æ±‚ä¸ºåº”ç”¨æ·»åŠ ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œä½†è¿™æ ·åšä¼šè¿«ä½¿ä½ ä¿®æ”¹å…¶ä»–éƒ¨åˆ†ï¼Œç„¶ååˆä¿®æ”¹å…¶ä»–éƒ¨åˆ†ï¼Œç›´åˆ°ä½ çš„ä¿®æ”¹å˜å¾—éå¸¸ç¹çï¼Œæ— æ³•æµ‹è¯•ã€‚</p>

<p>ä½ å¯èƒ½ä¹Ÿå¼€å‘è¿‡è¿™æ ·çš„åº”ç”¨ï¼Œç”¨ä¸€äº›ä¸é è°±çš„æ–¹å¼è¿›è¡Œä¿®æ”¹æ¯”å¼„æ¸…æ¥šå¦‚ä½•æ­£ç¡®åœ°åšæŸä»¶äº‹è¦å®¹æ˜“å¾—å¤šã€‚æˆ–è€…ï¼Œåº”ç”¨æŸä¸ªéƒ¨åˆ†çš„ä¿®æ”¹ä¼šå¯¼è‡´æ•°ç™¾ä¸ªå®Œå…¨ä¸ç›¸å…³çš„ bug çªç„¶å‡ºç°ã€‚</p>

<p>è¿™äº›éƒ½æ˜¯ç³Ÿç³•æ¶æ„çš„æ ‡å¿—ã€‚</p>

<p>å› æ­¤ï¼Œæœ¬æ–‡åŸºäºæˆ‘çš„æ¼”è®²ã€Šåˆ«è·Ÿæ¶æ„ä½œå¯¹ã€‹æ¢è®¨å¦‚ä½•æ„å»ºä¼˜ç§€çš„åº”ç”¨æ¶æ„ã€‚</p>

<h3>æ­£ç¡®çš„æ–¹æ³•</h3>

<p>å› ä¸ºå½“ä½ æ„å»ºäº†ä¼˜ç§€çš„åº”ç”¨æ¶æ„åï¼Œä½ ä¼šå‘ç°å®ƒå®‰å…¨å¯é ã€å¯æµ‹è¯•ä¸”æ˜“äºç»´æŠ¤ã€‚ä½ å°†èƒ½å¤Ÿæ¨è¿Ÿè¯¸å¦‚ä½¿ç”¨å“ªä¸ªåç«¯ä¹‹ç±»çš„å†³ç­–ï¼Œå¹¶åœ¨ä¹‹åç›¸å¯¹è½»æ¾åœ°æ’¤é”€è¿™äº›å†³ç­–ã€‚å¯¹æˆ‘ä»¬å¼€å‘è€…æ¥è¯´ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªæ˜ç¡®çš„â€œæ­£ç¡®æ–¹æ³•â€ï¼Œå¯ä»¥æ­£ç¡®åœ°éš”ç¦»éœ€è¦éš”ç¦»çš„éƒ¨åˆ†ï¼Œè¿™æ„å‘³ç€å³ä½¿æ˜¯æœ€åˆçº§çš„å¼€å‘è€…ä¹Ÿèƒ½åœ¨å›¢é˜Ÿä¸­å‘æŒ¥ä½œç”¨ã€‚</p>

<p>å…³äºæ„å»ºè½¯ä»¶æ¶æ„çš„â€œæ­£ç¡®â€æ–¹æ³•æœ‰å¾ˆå¤šå»ºè®®ï¼Œå…¶ä¸­å¾ˆå¤šéƒ½ç›¸äº’çŸ›ç›¾ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä¸ºä½ æä¾›æ¶æ„èƒŒåçš„â€œåŸåˆ™â€ï¼Œä»¥ä¾¿ä½ èƒ½å¤Ÿè‡ªè¡Œå†³å®šä»€ä¹ˆæ¶æ„é€‚åˆä½ è‡ªå·±çš„åº”ç”¨ã€‚æ‰€ä»¥ï¼Œæœ¬æ–‡æ¢è®¨çš„æ˜¯åŸåˆ™ï¼Œè€Œä¸æ˜¯è§„åˆ™ã€‚</p>

<blockquote><p>è¦æˆä¸ºä¸€åä¼˜ç§€çš„æ¶æ„å¸ˆï¼Œå­¦ä¹ åŸåˆ™ï¼Œè€Œä¸æ˜¯è§„åˆ™ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥æ ¹æ®ä½ çš„è½¯ä»¶å’Œå›¢é˜Ÿå®šåˆ¶åˆé€‚çš„æ¶æ„ã€‚</p></blockquote>

<h2>SOLID è§„åˆ™</h2>

<p>SOLID è§„åˆ™æ˜¯è®¸å¤šæ¶æ„æ¡†æ¶çš„åŸºç¡€ï¼Œå› æ­¤å¿…é¡»å®Œå…¨ç†è§£ã€‚æˆ‘ä¸ä¼šæ·±å…¥æ¢è®¨è¿™äº›è§„åˆ™ï¼Œå› ä¸ºå…¶ä»–äººå·²ç»åœ¨è¿™æ–¹é¢åšå¾—å¾ˆå¥½ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬å…ˆç®€å•å›é¡¾ä¸€ä¸‹ï¼š</p>

<h3>S = è´£ä»»åˆ†ç¦»</h3>

<p>è¯¥åŸåˆ™è§„å®šï¼Œä¸€ä¸ªç±»æˆ–æ¨¡å—<em>åº”è¯¥åªæœ‰ä¸€ä¸ªæ›´æ”¹ç†ç”±</em>ã€‚æˆ–è€…è¯´ï¼Œå®ƒåº”è¯¥åªå¯¹ä¸€ä¸ª<em>å‚ä¸è€…</em>è´Ÿè´£ã€‚è¿™æœ¬è´¨ä¸Šæ„å‘³ç€ï¼šå°†é‚£äº›å°†å•ç‹¬æ¼”è¿›çš„äº‹ç‰©éš”ç¦»å¼€æ¥ã€‚</p>

<h3>O = å¼€æ”¾-å°é—­</h3>

<p>ä½ çš„ä»£ç åº”è¯¥å…è®¸ä½ é€šè¿‡æ·»åŠ ä»£ç è€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰ä»£ç æ¥æ·»åŠ æ–°åŠŸèƒ½ã€‚</p>

<h3>L = é‡Œæ°æ›¿æ¢</h3>

<p>ä»¥éº»çœç†å·¥å­¦é™¢è®¡ç®—æœºç§‘å­¦å®¶ Barbara Liskov çš„åå­—å‘½åã€‚è¯¥åŸåˆ™è§„å®šï¼Œä½ åº”è¯¥èƒ½å¤Ÿä½¿ç”¨ä»»ä½•æ´¾ç”Ÿç±»æ¥æ›¿æ¢åŸºç±»ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œåœ¨æ´¾ç”ŸåŸºç±»æ—¶ï¼Œä¸åº”å°è¯•æ›´æ”¹å…¶å«ä¹‰ã€‚</p>

<h3>I = æ¥å£éš”ç¦»</h3>

<p>ä¸åº”å¼ºè¿«å®¢æˆ·ç«¯ä½¿ç”¨ä¸é€‚åˆä»–ä»¬çš„æ¥å£ã€‚æ‹¥æœ‰å¤šä¸ªåŒ…å«ä¸€ä¸¤ä¸ªæ–¹æ³•çš„å°å‹æ¥å£ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå¤§å‹æ¥å£ï¼Œè¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåå¤„ã€‚</p>

<h3>D = ä¾èµ–å€’ç½®</h3>

<p>é«˜çº§ç±»ä¸åº”ä¾èµ–äºä½çº§ç±»ã€‚ç›¸åï¼Œå®ƒä»¬åº”è¯¥éƒ½ä¾èµ–äºæŠ½è±¡ã€‚</p>

<p>æ­£ç¡®åº”ç”¨ä¾èµ–å€’ç½®åŸåˆ™å¯ä»¥æ­£ç¡®å½¢æˆæ¶æ„è¾¹ç•Œã€‚è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£å…¶å·¥ä½œåŸç†ã€‚</p>

<h2>æ¶æ„è¾¹ç•Œå’Œä¾èµ–å€’ç½®</h2>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨å…è®¸ç”¨æˆ·åˆ›å»ºå’Œä¿å­˜ä¸ªäººèµ„æ–™ã€‚æˆ‘ä»¬ä½¿ç”¨ Firebase æ¥å®ç°è¿™ä¸€ç‚¹ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„å®ç°ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/1*qORZctRds2AE60uxiH4w5Q.png" alt="æµç¨‹å›¾æ˜¾ç¤º User ç±»çš„ saveProfile æ–¹æ³•ç›´æ¥è°ƒç”¨ FirebaseProfileSaver ç±»ï¼Œè¿™æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºè¿åäº†ä¾èµ–å€’ç½®åŸåˆ™" /></p>

<p>è¿™é‡Œï¼ŒUser ç±»è°ƒç”¨äº† FirebaseProfileSaver ç±»ä¸­çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä½¿ç”¨ Firebase ä¿å­˜ä¸ªäººèµ„æ–™ã€‚User ç±»è¢«ç§°ä¸º<em>é«˜çº§</em>ç±»ï¼Œå› ä¸ºå®ƒåŒ…å«ä¸šåŠ¡é€»è¾‘ï¼ˆå³ï¼Œå®ƒæ˜¯çº¯é€»è¾‘ï¼Œè€Œä¸æ˜¯å…³äºæ•°æ®å¦‚ä½•è¯»å†™åˆ°ç³»ç»Ÿçš„å…·ä½“ç»†èŠ‚ï¼‰ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼Œâ€œFirebaseProfileSaverâ€æ˜¯ä¸€ä¸ª<em>ä½çº§</em>ç±»ï¼Œä¹‹æ‰€ä»¥è¿™æ ·ç§°å‘¼æ˜¯å› ä¸ºå®ƒåŒ…å«å®ç°ç»†èŠ‚ï¼Œå³ä¸ºç‰¹å®šæŠ€æœ¯ç¼–å†™çš„ä»£ç ã€‚</p>

<p>è¿™ç§å¸ƒå±€è¿åäº†ä¾èµ–å€’ç½®åŸåˆ™ï¼Œå› ä¸ºé«˜çº§çš„ä¸œè¥¿ä¾èµ–äºä½çº§çš„ä¸œè¥¿ã€‚æˆ‘æ‰€è¯´çš„ä¾èµ–ï¼Œæ˜¯æŒ‡ä¸¥æ ¼çš„æºä»£ç å«ä¹‰ï¼šåœ¨â€œUserâ€ç±»ä¸­ï¼Œæœ‰ä¸€è¡Œä»£ç å†™ç€â€œimport x.y.FirebaseProfileSaverâ€æˆ–ç±»ä¼¼çš„ä»£ç ã€‚ä¹Ÿè®¸ä¾èµ–å…³ç³»è¢«ç§»é™¤äº†å‡ å±‚â€”â€”æ¯”å¦‚â€œUserâ€å¯¼å…¥äº†â€œXâ€ï¼Œè€Œâ€œXâ€åˆå¯¼å…¥äº†â€œYâ€ï¼Œè€Œâ€œYâ€åˆå¯¼å…¥äº†â€œFirebaseProfileSaverâ€â€”â€”ä½†å…³é”®åœ¨äºï¼Œä½ å¯ä»¥æ²¿ç€ä¾èµ–å…³ç³»çš„æ–¹å‘ç”»ä¸€ç»„ç®­å¤´ï¼Œæœ€ç»ˆä»â€œUserâ€æŒ‡å‘â€œFirebaseProfileSaverâ€ã€‚</p>

<p>ä¸ºä»€ä¹ˆè¿™ä¼šæ˜¯ä¸ªé—®é¢˜ï¼Ÿä¸€ä¸ªé—®é¢˜æ˜¯Firebaseçš„å˜æ›´å¹¶ä¸æ˜¯å­¤ç«‹çš„ã€‚å¦‚æœFirebase SDKæœ‰ä¸€å¤©å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆæ˜¾ç„¶â€œFirebaseProfileSaverâ€ä¹Ÿéœ€è¦éšä¹‹æ”¹å˜ï¼›ä½†æ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå› ä¸ºå®ƒä¼šå½±å“â€œUserâ€åŠå…¶ä¾èµ–çš„ä»»ä½•å†…å®¹ã€‚æµ‹è¯•æ›´æ”¹æ„å‘³ç€æµ‹è¯•æ‰€æœ‰å†…å®¹ã€‚</p>

<p>è€Œä¸”å®ƒä¹Ÿä¸å¤ªçµæ´»ã€‚å¦‚æœæˆ‘ä»¬æƒ³ä» Firebase è¿ç§»åˆ°å…¶ä»–è¿œç¨‹å­˜å‚¨æä¾›å•†ï¼Œæˆ‘ä»¬æœ€ç»ˆå¯èƒ½ä¸å¾—ä¸é‡å†™åº”ç”¨ç¨‹åºçš„å¤§éƒ¨åˆ†å†…å®¹ã€‚</p>

<h3>ä¾èµ–å€’ç½®ï¼šâ€œæ’å¤´æ’åº§â€è§£å†³æ–¹æ¡ˆ</h3>

<p>è§£å†³æ–¹æ¡ˆæ˜¯å°†â€œFirebaseProfileSaverâ€è®¾ç½®ä¸ºä¸€ç§â€œæ’å¤´â€ï¼Œå°†â€œUserâ€ç±»è®¾ç½®ä¸ºä¸€ç§â€œæ’åº§â€ã€‚â€œUserâ€ç±»å¿…é¡»å¯¹â€œFirebaseProfileSaverâ€ä¸€æ— æ‰€çŸ¥ï¼›ä½†å®ƒå¯ä»¥åœ¨æŠ½è±¡ä¸­äº†è§£ä¿å­˜é…ç½®æ–‡ä»¶çš„è¿‡ç¨‹ã€‚æ— è®ºæˆ‘ä»¬å°†ä»€ä¹ˆâ€œæ’å¤´â€æ’å…¥â€œUserâ€çš„â€œå¥—æ¥å­—â€ï¼ˆå¯ä»¥æ˜¯â€œFirebaseProfileSaverâ€ã€â€œRoomDatabaseProfileSaverâ€æˆ–â€œMyProprietaryAPIProfileSaverâ€ï¼‰ï¼Œâ€œå¥—æ¥å­—â€éƒ½çŸ¥é“å¦‚ä½•ä¸ä¹‹é€šä¿¡ï¼Œå› ä¸ºä»â€œå¥—æ¥å­—â€çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬çš„æ“ä½œæ–¹å¼éƒ½ç›¸åŒã€‚</p>

<p>å› æ­¤ï¼Œâ€œFirebaseProfileSaverâ€è¢«é‡æ„ä¸ºé€‚åˆè¯¥å¥—æ¥å­—çš„æ’å¤´ã€‚</p>

<p>å®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*oZXp4UqYwNb2Rhdo2I0_cQ.png" alt="æµç¨‹å›¾å±•ç¤ºäº†ä¸€ä¸ª User ç±»ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ª saveProfile æ–¹æ³•ï¼Œå®ƒè°ƒç”¨äº† ProfileSaver æ¥å£ä¸Šçš„ saveProfile æ–¹æ³•ã€‚å¦å¤–ï¼ŒFirebaseProfileSaver ç±»å®ç°äº†è¯¥æ¥å£ã€‚å³å›¾ï¼šæ­£ç¡®åº”ç”¨äº†ä¾èµ–å€’ç½®åŸåˆ™" /></p>

<p>è¿™é‡Œï¼Œ<code>User</code> ç±»åªçŸ¥é“å¦‚ä½•æŠ½è±¡åœ°ä¸â€œ<code>ProfileSaver</code>â€äº¤äº’ã€‚é‡è¦çš„æ˜¯ï¼Œå®ƒæ²¡æœ‰æåŠä»»ä½•ä¸ Firebase ç›¸å…³çš„å†…å®¹ã€‚</p>

<p>ç„¶åï¼Œ<code>FirebaseProfileSaver</code> å®ç°äº† <code>ProfileSaver</code> æ¥å£ã€‚<code>User</code> ç±»å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ï¼Œå› æ­¤ï¼Œè‡³å…³é‡è¦çš„æ˜¯ï¼Œå®ƒçš„ä»»ä½•é€»è¾‘éƒ½ä¸åŸºäº Firebase çš„å·¥ä½œæ–¹å¼ã€‚</p>

<p>è¿™éš”ç¦»äº† Firebase é€»è¾‘ã€‚æˆ‘ä»¬å¯ä»¥åƒä¸Šå›¾ä¸€æ ·åœ¨ä½çº§ä»£ç å’Œé«˜çº§ä»£ç ä¹‹é—´ç”»ä¸€æ¡çº¢çº¿ã€‚è¿™æ¡çº¢çº¿å°±æ˜¯æ¶æ„è¾¹ç•Œã€‚</p>

<p>æ³¨æ„ä¾èµ–å…³ç³»ç®­å¤´ç°åœ¨æ˜¯å¦‚ä½•ä»ä½çº§æŒ‡å‘é«˜çº§çš„ã€‚ä¸å†å­˜åœ¨ä»»ä½•å¯ä»¥éµå¾ªçš„ä»â€œUserâ€ç±»å¼€å§‹åˆ° Firebase ç»“æŸçš„ä¾èµ–ç®­å¤´åºåˆ—ã€‚</p>

<h2>æ¶æ„è¾¹ç•Œåº”è¯¥æ”¾åœ¨å“ªé‡Œï¼Ÿ</h2>

<p>æ˜¾ç„¶ï¼Œæ­£ç¡®è®¾ç½®æ¶æ„è¾¹ç•Œå¯¹äºè‰¯å¥½çš„æ¶æ„è‡³å…³é‡è¦ã€‚ä»ä¸Šæ–‡æ¥çœ‹ï¼Œè¾¹ç•Œä¼¼ä¹è¶Šå¤šè¶Šå¥½â€”â€”ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚</p>

<p>æ¶æ„è¾¹ç•Œä¼šå¸¦æ¥ç»´æŠ¤å¼€é”€ã€‚å®ƒä»¬ä¼šäº§ç”Ÿæ›´å¤šä»£ç ï¼Œè€Œä¸”ä¸€æ—¦è®¾ç½®äº†è¾¹ç•Œï¼Œæ¯ä¸ªæœªæ¥çš„å¼€å‘äººå‘˜éƒ½å¿…é¡»éµå®ˆå®ƒã€‚</p>

<p>è€Œä¸”ï¼Œå¸¦æœ‰è¾¹ç•Œçš„ä»£ç å¯è¯»æ€§ä¼šå¤§å¤§é™ä½ã€‚ä»ä¸Šæ–‡æ¥çœ‹ï¼Œ<code>User</code> ç±»çš„ <code>profileSaver.saveProfile()</code> è°ƒç”¨å®é™…ä¸Šè§¦å‘äº† Firebase é€»è¾‘ï¼Œè¿™ä¸€ç‚¹å¹¶ä¸æ˜æ˜¾ã€‚å› æ­¤ï¼Œæ–°å¼€å‘äººå‘˜çš„å…¥èŒåŸ¹è®­ä¼šå˜å¾—æ›´åŠ æ£˜æ‰‹ï¼Œä»£ç å®¡æŸ¥ä¹Ÿä¼šæ›´åŠ å›°éš¾ã€‚</p>

<p>æ•´æ´æ¶æ„ (Clean Architecture) æ˜¯åˆç†åŒ–æ¶æ„è¾¹ç•Œçš„ä¸€ç§å°è¯•ã€‚</p>

<h2>Android åº”ç”¨çš„æ•´æ´æ¶æ„æ€ä¹ˆæ ·ï¼Ÿ</h2>

<p>æ•´æ´æ¶æ„æ˜¯ç”±èµ„æ·±æ¶æ„å¸ˆ Robert C Martin æ•´ç†çš„ä¸€å¥—åŸåˆ™ï¼Œå®ƒåœ¨ä¸€å®šç¨‹åº¦ä¸Šæä¾›äº†ä¸€ç§å°†è½¯ä»¶åˆç†åŒ–ä¸ºä¸€ç»„é€‰å®šå±‚çº§çš„æ–¹æ³•ï¼Œè¿™äº›å±‚çº§ç”±æ¶æ„è¾¹ç•Œåˆ’åˆ†ã€‚</p>

<p>å…¶è‘—åçš„å›¾è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*iq1PK8t-7rusKw4r" alt="è‘—åçš„æ•´æ´æ¶æ„å›¾ï¼Œå‡ºè‡ªç½—ä¼¯ç‰¹Â·CÂ·é©¬ä¸çš„è‘—ä½œã€Šæ•´æ´æ¶æ„ã€‹ã€‚æ•´æ´æ¶æ„å›¾ç”±ä¸€ç³»åˆ—åŒå¿ƒåœ†ç»„æˆã€‚æœ€å†…åœˆæ ‡è®°ä¸ºå®ä½“ï¼Œå…¶æ¬¡æ˜¯ç”¨ä¾‹ï¼Œç„¶åæ˜¯æ¥å£é€‚é…å™¨ï¼Œæœ€å¤–åœˆæ˜¯æ¡†æ¶å’Œé©±åŠ¨ç¨‹åº" /></p>

<p>è¿™å¼ åˆ†å±‚å›¾çš„ä¸­å¿ƒæ˜¯é«˜çº§ä»£ç ï¼ˆå³çº¯é€»è¾‘ï¼‰ï¼Œå¤–å›´æ˜¯ä½çº§ä»£ç ã€‚å®ƒéµå¾ªä¾èµ–è§„åˆ™ï¼ˆæœ¬è´¨ä¸Šæ˜¯ SOLID ä¾èµ–å€’ç½®åŸåˆ™çš„äº§ç‰©ï¼‰ï¼Œè¯¥è§„åˆ™è§„å®šä½çº§ä»£ç å¯ä»¥ä¾èµ–äºé«˜çº§ä»£ç ï¼Œä½†åè¿‡æ¥åˆ™ä¸è¡Œã€‚å› æ­¤ï¼Œä¸Šå›¾ä¸­è¡¨ç¤ºä¾èµ–å…³ç³»çš„ç®­å¤´å§‹ç»ˆæŒ‡å‘å†…éƒ¨ã€‚</p>

<p>é‚£ä¹ˆï¼Œè¿™äº›å±‚çº§ç”±ä»€ä¹ˆç»„æˆå‘¢ï¼Ÿ</p>

<h3>ç”¨ä¾‹å’Œå®ä½“ï¼ˆé»„è‰²å’Œçº¢è‰²åœ†åœˆï¼‰</h3>

<p>åœ¨æ¸…æ™°æ¶æ„å›¾çš„æ­£ä¸­å¤®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç”¨ä¾‹å±‚å’Œå®ä½“å±‚ã€‚å®ƒä»¬åŒ…å«åº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™äº›é€»è¾‘æ˜¯æ§åˆ¶åº”ç”¨è¡Œä¸ºçš„çº¯é€»è¾‘ï¼Œä¸å…·ä½“çš„å®ç°ç»†èŠ‚æ— å…³ã€‚</p>

<p>è¿™ç§åŒºåˆ«å¯èƒ½ä¼šé€ æˆæ··æ·†ï¼Œå› æ­¤æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ã€‚</p>

<p>ä¸€ä¸ªä¿å­˜ç”¨æˆ·ä¸ªäººèµ„æ–™çš„ç”¨ä¾‹ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>

<ol>
<li>è¿è¡Œä¸€äº›å®‰å…¨æ€§/ä¸€è‡´æ€§æ£€æŸ¥ã€‚ç¡®ä¿æ­£åœ¨ä¿å­˜çš„ä¸ªäººèµ„æ–™åŒ…å«æœ‰æ•ˆæ•°æ®ï¼Œå¹¶ä¸”ç”¨æˆ·æœ‰æƒæ‰§è¡Œæ­¤æ“ä½œã€‚</li>
<li>è¿œç¨‹ä¿å­˜æ•°æ®</li>
<li>åœ¨æœ¬åœ°ç¼“å­˜æ–°çš„ä¸ªäººèµ„æ–™</li>
<li>é€šçŸ¥ UI éœ€è¦æ›´æ–°</li>
</ol>


<p>ä½ å¯ä»¥è¯´è¿™äº›éƒ½æ˜¯ä¸šåŠ¡é€»è¾‘ï¼Œå› ä¸ºå®ƒä»¬ä¸â€œæˆ‘ä»¬åœ¨åšä»€ä¹ˆâ€æœ‰å…³ï¼Œè€Œä¸æ˜¯â€œæˆ‘ä»¬å¦‚ä½•åšâ€ã€‚ä¾‹å¦‚ï¼Œåœ¨æ­¥éª¤ 2 ä¸­ï¼Œæˆ‘ä»¬ä¸ä¼šè¯´æ˜ä½¿ç”¨å“ªä¸ªè¿œç¨‹ API æ¥ä¿å­˜æ•°æ®ï¼›åœ¨æ­¥éª¤ 4 ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿä¸å…³å¿ƒè¦æ›´æ–°çš„ UI æ˜¯ Android æ‰‹æœºå±å¹•ã€ç½‘é¡µè¿˜æ˜¯ PDFã€‚</p>

<p>ä¸€ä¸ªç”¨ä¾‹ä»£è¡¨æ¥è‡ªå•ä¸ªå‚ä¸è€…çš„å•ä¸€éœ€æ±‚ï¼ˆè¯·å‚é˜…ä¸Šæ–‡ SOLID çš„å•ä¸€èŒè´£åŸåˆ™ï¼‰ã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ­¥éª¤åˆ—è¡¨â€”â€”ä½ æ— éœ€æ‰§è¡Œä»»ä½•å…¶ä»–æ“ä½œå³å¯ä¿å­˜é…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”å°è¯•ä»…è¿è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ­¥éª¤æ¯«æ— æ„ä¹‰ã€‚</p>

<h3>æ¥å£é€‚é…å™¨ï¼ˆç»¿è‰²åœ†åœˆï¼‰</h3>

<p>è¿™æ˜¯ç”¨ä¾‹ç»†èŠ‚çš„ä½“ç°ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªç”¨ä¾‹è¦æ±‚åœ¨æœ¬åœ°ç¼“å­˜ä¸€äº›æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè®¨è®º SQL æ•°æ®åº“ã€‚æˆ‘ä»¬ä»ç„¶ä¸ä¼šè®¨è®ºç‰¹å®šå“ç‰Œçš„ SQL æ•°æ®åº“â€”â€”ä»»ä½•ä¸“æœ‰æŠ€æœ¯éƒ½åº”æ”¾åœ¨åé¢è®¨è®ºã€‚å¦‚æœæœ‰å¤šä¸ªæ•°æ®æºï¼Œåˆ™æ¥å£é€‚é…å™¨å±‚åº”è¯¥å¯¹å®ƒä»¬è¿›è¡Œæ•´ç†å¹¶ç®¡ç†å·®å¼‚ã€‚</p>

<p>å‡ ä¹æ‰€æœ‰ MVVMã€MVCã€MVP ç­‰æ‹“æ‰‘ç»“æ„éƒ½åº”è¯¥æ”¾åœ¨è¿™é‡Œã€‚åŒæ ·ï¼Œè¿™é‡Œä¸æ¶‰åŠä¸“æœ‰æŠ€æœ¯â€”â€”æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œä¸è®¨è®º Jetpack Compose æˆ– Android XMLâ€”â€”ä½†æˆ‘ä»¬ç¡®å®ä¿å­˜äº†è¿™äº›éƒ¨åˆ†å°†è¦ä½¿ç”¨çš„çŠ¶æ€ã€‚</p>

<h3>æ¡†æ¶å’Œé©±åŠ¨ç¨‹åºï¼ˆè“è‰²åœ†åœˆï¼‰</h3>

<p>æ‰€æœ‰ä½¿ç”¨ä¸“æœ‰æŠ€æœ¯çš„å†…å®¹éƒ½æ”¾åœ¨è¿™é‡Œã€‚è¿™äº›æ˜¯<em>å®ç°ç»†èŠ‚</em>ã€‚</p>

<p>Jetpack Compose çš„ <code>@Composable</code> ä»£ç ä¹Ÿæ”¾åœ¨è¿™é‡Œã€‚HTML ä»£ç ä¹Ÿæ”¾åœ¨è¿™é‡Œã€‚æ­¤å¤–ï¼ŒFirebase ä»£ç ã€ä»»ä½• API çš„å…·ä½“ç»†èŠ‚ã€SQL å‘½ä»¤ä»¥åŠä»»ä½•æ ‡æœ‰ Room æ³¨è§£ï¼ˆä¾‹å¦‚ <code>@Entity</code>ï¼‰çš„å†…å®¹ä¹Ÿæ”¾åœ¨è¿™é‡Œâ€¦â€¦</p>

<p>æ­¤å±‚çš„ä»£ç å¾ˆéš¾æµ‹è¯•ï¼Œå› ä¸ºå®ƒé€šå¸¸ä¾èµ–äºä¸“æœ‰æŠ€æœ¯ã€‚ä¾‹å¦‚ï¼ŒJetpack Compose æµ‹è¯•ä¾èµ–äºä¸“é—¨ä¸º Jetpack Compose ç¼–å†™çš„å·¥å…·ï¼ˆæˆ–è€…å¯èƒ½æ˜¯ä¸º Android ç¼–å†™çš„å·¥å…·ï¼Œä½†é‡ç‚¹ä¾ç„¶å­˜åœ¨ï¼‰ã€‚å› æ­¤ï¼Œè¯·å°½å¯èƒ½ç²¾ç®€æ­¤å±‚ã€‚é€»è¾‘åº”è¯¥æ”¾åœ¨æ›´é«˜çš„å±‚çº§ã€‚è¿™åªæ˜¯å°†æ¥å£é€‚é…å™¨çš„è¦æ±‚â€œç¿»è¯‘â€åˆ°ä½ æ­£åœ¨ä½¿ç”¨çš„ç‰¹å®šæŠ€æœ¯æ‰€éœ€çš„æœ€ä½é™åº¦ã€‚</p>

<p>è¿™ä¸€å±‚ä¹Ÿæ˜¯<em>æ˜“å¤±æ€§çš„</em>ã€‚å®ƒå¯èƒ½ä¼šåœ¨æ²¡æœ‰ä½ è¾“å…¥çš„æƒ…å†µä¸‹å‘ç”Ÿå˜åŒ–å’Œä¸­æ–­ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨ä½¿ç”¨çš„ API çªç„¶éœ€è¦ä¸åŒç±»å‹çš„èº«ä»½éªŒè¯ï¼Œä½ å°†ä¸å¾—ä¸ä¿®æ”¹ä»£ç ä»¥é€‚åº”ï¼Œæ— è®ºæ—¶æœºæ˜¯å¦åˆé€‚æˆ–ä½ æ˜¯å¦æ„¿æ„æ¥å—è¿™ç§å˜åŒ–ã€‚åŒæ ·ï¼Œå°½å¯èƒ½ç²¾ç®€è¿™ä¸€å±‚å¯ä»¥å‡å°‘æ­¤ç±»æ›´æ”¹å¯¹ä»£ç åº“å…¶ä½™éƒ¨åˆ†çš„å½±å“ã€‚</p>

<h2>Android ä¸“ç”¨ä»£ç åœ¨ Clean Architecture ä¸­ä½äºä½•å¤„ï¼Ÿ</h2>

<p>æ ¹æ® Clean Architecture çš„å®˜æ–¹å®šä¹‰ï¼ŒAndroid æ˜¯ä¸€é¡¹ä¸“æœ‰æŠ€æœ¯ï¼Œå› æ­¤åº”å°†å…¶é™åˆ¶åœ¨æ¡†æ¶å’Œé©±åŠ¨ç¨‹åºï¼ˆè“è‰²ï¼‰å±‚ã€‚ä»»ä½•å¸¦æœ‰â€œimport android.x.yâ€æˆ–â€œimport androidx.x.yâ€çš„ä»£ç éƒ½ä¸åº”è¶…å‡ºæ­¤å±‚ã€‚</p>

<p>è¿™åœ¨å®è·µä¸­å¯èƒ½éå¸¸éš¾ä»¥å®ç°ã€‚</p>

<p>ä¸€ä¸ªä¾‹å­æ˜¯æƒé™è¯·æ±‚ï¼Œæœ‰æ—¶åœ¨è§†å›¾æ¨¡å‹ï¼ˆå³æ¥å£é€‚é…å™¨åŒºåŸŸï¼‰ä¸­æåŠä¼šæ›´æ–¹ä¾¿ï¼ˆä¸”æ›´å…·å¯è¯»æ€§ï¼‰ã€‚</p>

<p>å› æ­¤ï¼Œè¿™å®Œç¾åœ°è¯ é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘å¸Œæœ›æœ¬æ–‡å…³æ³¨çš„æ˜¯â€œåŸåˆ™â€è€Œâ€‹â€‹éâ€œè§„åˆ™â€ã€‚å¦‚æœä½ ä¸ºäº†éµå¾ªæŸæ¡è§„åˆ™è€Œè´¹å°½å¿ƒæ€ï¼Œé‚£ä¹ˆè¯·è€ƒè™‘å…¶èƒŒåçš„åŸåˆ™â€”â€”å®ƒä»¬å¯èƒ½ä¸ä½ çš„æƒ…å†µç›¸å…³ï¼Œä¹Ÿå¯èƒ½ä¸ç›¸å…³ã€‚</p>

<p>å°±æ­¤ç¤ºä¾‹è€Œè¨€ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºå…è®¸åœ¨æ¥å£é€‚é…å™¨ä¸­æåŠ Android æ˜¯å¯ä»¥æ¥å—çš„ã€‚æ¯•ç«Ÿï¼Œä½ æ­£åœ¨æ„å»ºä¸€æ¬¾ Android åº”ç”¨ï¼Œé™¤éä½ æœªæ¥æœ‰ç›¸å½“å¤§çš„å¯èƒ½æ€§ä¼šä¸ iOS æˆ– Web åº”ç”¨å…±äº«å®Œå…¨ç›¸åŒçš„ä»£ç åº“ï¼Œå¦åˆ™ä½ æ²¡æœ‰å¿…è¦ä¸ºäº†é¿å… Android è€Œä¿®æ”¹ä»£ç ã€‚æ˜¾ç„¶ï¼ŒiOS å’Œ Web åº”ç”¨é€šå¸¸éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„ä»£ç åº“ã€‚</p>

<h2>ä»€ä¹ˆé€ å°±äº†ä¸€æ¬¾ä¼˜ç§€çš„åº”ç”¨ï¼Ÿæˆ‘ä»¬å¦‚ä½•æ„å»ºå®ƒï¼Ÿ</h2>

<p>ä¸€æ¬¾åº”ç”¨åº”è¯¥ä¸“æ³¨äºä¸€ä»¶äº‹ï¼Œå¹¶ä¸”åšå¥½å®ƒã€‚å®ƒçš„ç›®çš„ä¸ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå‘ç”Ÿå¤ªå¤§å˜åŒ–ï¼Œå°½ç®¡å®ƒåœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­å¯èƒ½ä¼šæ¨å‡ºè®¸å¤šæ–°åŠŸèƒ½ï¼Œä½†å®ƒçš„ç›®æ ‡å—ä¼—å‡ ä¹ä»æœªæ”¹å˜ï¼ˆæ ¹æ®å•ä¸€èŒè´£åŸåˆ™ï¼Œå®ƒçš„è§’è‰²å§‹ç»ˆç›¸åŒï¼‰ã€‚äº‹å®ä¸Šï¼Œå¦‚æœåˆ©ç›Šç›¸å…³è€…å¼€å§‹è¦æ±‚ä½ çš„åº”ç”¨è¿åˆå…¶ä»–ç±»å‹çš„ç”¨æˆ·ï¼Œä½ é€šå¸¸æœ€å¥½ä¸ºä»–ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„åº”ç”¨ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ»¡è¶³ä»–ä»¬çš„éœ€æ±‚ã€‚å¾®è½¯å¹¶æ²¡æœ‰å•ä¸€çš„ Office åº”ç”¨ï¼›ç›¸åï¼Œå®ƒæœ‰ç‹¬ç«‹çš„ Wordã€Excel å’Œ Powerpoint åº”ç”¨ï¼Œæ¯ä¸ªåº”ç”¨éƒ½ç”±ä¸åŒçš„ç”¨æˆ·ä½¿ç”¨ï¼Œæœ‰ç€ä¸åŒçš„éœ€æ±‚ã€‚</p>

<p>æ‰€ä»¥ä½ å¯èƒ½ä¼šè¯´ï¼Œæ•´æ´æ¶æ„ï¼ˆClean Architectureï¼‰â€”â€”å…¶ä¸­è®¸å¤šåŸåˆ™æ—¨åœ¨ä¿æŠ¤ä½ å…å— Android åº”ç”¨ä¸­ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„æ­¤ç±»æ›´æ”¹çš„å½±å“â€”â€”å¯¹äºæˆ‘ä»¬çš„ç›®çš„æ¥è¯´å®åœ¨å¤ªè¿‡ç¹çã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘åŒæ„ä½ çš„è§‚ç‚¹ã€‚</p>

<p>è°·æ­Œä¼¼ä¹ä¹ŸåŒæ„è¿™ä¸€ç‚¹ã€‚å®ƒè‡ªå·±çš„æ¶æ„å»ºè®®â€”â€”ç§°ä¹‹ä¸ºâ€œç°ä»£åº”ç”¨æ¶æ„â€ï¼ˆModern App Architectureï¼‰â€”â€”æ˜¯æ•´æ´æ¶æ„çš„ä¸€ä¸ªç•¥å¾®å®½æ¾çš„ç‰ˆæœ¬ã€‚</p>

<h2>Google çš„ç°ä»£åº”ç”¨æ¶æ„</h2>

<p>Google å°†å…¶æ¶æ„ç®€åŒ–ä¸ºä¸‰å±‚ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:938/1*Y9TFujbKQzLtY1rJynlmSA.png" alt="Google ç°ä»£åº”ç”¨æ¶æ„çš„æ‹“æ‰‘ç»“æ„ï¼šæµç¨‹å›¾å±•ç¤ºäº† Google ç°ä»£åº”ç”¨æ¶æ„çš„ä¸‰ä¸ªå±‚çº§ã€‚UI å±‚æŒ‡å‘é¢†åŸŸå±‚ï¼ˆæ ‡è®°ä¸ºå¯é€‰ï¼‰ã€‚æ•°æ®å±‚ä¹ŸæŒ‡å‘é¢†åŸŸå±‚ã€‚" /></p>

<p>å¹¿ä¹‰ä¸Šè®²ï¼ŒUI å±‚ç”¨äºå¤„ç†ç”¨æˆ·çš„è¾“å…¥å’Œè¾“å‡ºï¼Œå¹¶æ›´æ–°æ˜¾ç¤ºå†…å®¹ã€‚é¢†åŸŸå±‚ç”¨äºå¤„ç†ä¸šåŠ¡é€»è¾‘â€”â€”å‡ ä¹ä¸ Clean Architecture çš„ç”¨ä¾‹å®Œå…¨ç›¸åŒã€‚æ•°æ®å±‚ç”¨äºä»åº”ç”¨çš„å­˜å‚¨æœºåˆ¶è¯»å–å’Œå†™å…¥æ•°æ®ã€‚</p>

<p>è¿™æ˜¯ä¸€ç§å•å‘æ¶æ„ã€‚çŠ¶æ€ä»…å‘ä¸ŠæµåŠ¨ï¼Œäº‹ä»¶ä»…å‘ä¸‹æµåŠ¨ã€‚</p>

<p>è®©æˆ‘ä»¬æ›´è¯¦ç»†åœ°äº†è§£è¿™ä¸€åˆ‡çš„å«ä¹‰ã€‚</p>

<h3>UI å±‚ï¼šUI å…ƒç´ å’ŒçŠ¶æ€æŒæœ‰è€…</h3>

<p><img src="https://miro.medium.com/v2/resize:fit:950/1*81Y6jlUs43MnvwwvBu7zzw.png" alt="ç°ä»£åº”ç”¨æ¶æ„çš„ UI å±‚ï¼šä¸Šå›¾ä¸­ UI å±‚çš„æ‰©å±•ï¼Œæ˜¾ç¤ºå®ƒç”± UI å…ƒç´ å’ŒçŠ¶æ€æŒæœ‰è€…ç»„æˆ" /></p>

<p>UI å±‚åˆ†ä¸º UI å…ƒç´ å’ŒçŠ¶æ€æŒæœ‰è€…ã€‚</p>

<p>UI å…ƒç´ éƒ¨åˆ†ä»…åŒ…å«ä¸ºä¸“æœ‰æŠ€æœ¯ç¼–å†™çš„ä»£ç ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Jetpack Composeï¼Œè¯·å°†ä½ çš„ @Composable ä»£ç æ”¾åœ¨æ­¤å¤„ã€‚å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Fragments å’Œ XMLï¼Œé‚£ä¹ˆ @Composable ä»£ç ä¹Ÿæ”¾åœ¨æ­¤å¤„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œæ²¡æœ‰å…¶ä»–å†…å®¹ã€‚æ²¡æœ‰é€»è¾‘ï¼Œä¹Ÿæ²¡æœ‰æ•°æ®ã€‚</p>

<p>ï¼ˆâ€œæ— é€»è¾‘â€è§„åˆ™æœ‰æ—¶å¯¹äº XML æ•°æ®ç»‘å®šçš„ç”¨æˆ·æ¥è¯´å¾ˆå›°éš¾ã€‚ä¾‹å¦‚ï¼Œæ•°æ®ç»‘å®šå…è®¸ä½ å®Œå…¨åœ¨ XML ä»£ç ä¸­å®ç°æ‘„æ°åº¦/åæ°åº¦åˆ‡æ¢ã€‚ä¸è¦è¿™æ ·åšã€‚ï¼‰</p>

<p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œé€»è¾‘å’Œæ•°æ®åˆ™æ”¾åœ¨çŠ¶æ€æŒæœ‰è€…ä¸­ã€‚å®ƒä»¬ä¹‹æ‰€ä»¥è¢«ç§°ä¸ºâ€œé¢†åŸŸå±‚â€ï¼Œæ˜¯å› ä¸ºå®ƒä»¬ä¿å­˜ç€ UI çš„çŠ¶æ€ã€‚æƒ³æƒ³è§†å›¾æ§åˆ¶å™¨ã€‚å®ƒä»¬åŒ…å«æ”¯æŒ UI æ§ä»¶çš„å˜é‡â€”â€”æ‰€ä»¥ï¼Œå‡è®¾ä½ çš„ UI æœ‰ä¸€ä¸ªæ–‡æœ¬å­—æ®µï¼Œé‚£ä¹ˆåŒ…å«è¯¥æ–‡æœ¬å­—æ®µå†…å®¹çš„å˜é‡å°±æ”¾åœ¨è¿™é‡Œã€‚</p>

<p>ä¸€ä¸ªå¾ˆå¥½çš„å»ºè®®æ˜¯å°†è¿™æ ·çš„çŠ¶æ€å˜é‡æš´éœ²ç»™ Kotlin Flowsã€‚è¿™å·§å¦™åœ°å°è£…äº†å®ƒä»¬çš„åŠ¨æ€ç‰¹æ€§ï¼Œå¹¶æä¾›äº†ä¸€ç§å†…ç½®æœºåˆ¶æ¥å‘ UI å‘å‡ºéœ€è¦æ›´æ–°çš„ä¿¡å·ã€‚</p>

<h3>é¢†åŸŸå±‚ï¼šç”¨ä¾‹</h3>

<p>é¢†åŸŸå±‚åŒ…å«çš„ç”¨ä¾‹ä¸â€œæ¸…æ™°æ¶æ„â€ä¸­çš„ç”¨ä¾‹å®Œå…¨ç›¸åŒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯ç”±å•ä¸ªå‚ä¸è€…æ‰§è¡Œå•ä¸ªä»»åŠ¡æ‰€éœ€æ­¥éª¤çš„å®Œæ•´åˆ—è¡¨ã€‚</p>

<p>ä½†åœ¨ Google çš„æ¶æ„ä¸­ï¼Œè¿™ä¸€å±‚æ˜¯å¯é€‰çš„ã€‚è¿™æ„å‘³ç€å°†çº¯ä¸šåŠ¡é€»è¾‘æ”¾åœ¨çŠ¶æ€æŒæœ‰è€…ï¼ˆæ¯”å¦‚è§†å›¾æ¨¡å‹ï¼‰ä¸­å¹¶æ²¡æœ‰é”™ã€‚</p>

<p>å½“ä¸šåŠ¡é€»è¾‘åœ¨å¤šä¸ªçŠ¶æ€æŒæœ‰è€…ä¹‹é—´é‡ç”¨æ—¶ï¼Œå°†ä¸šåŠ¡é€»è¾‘æå–åˆ°é¢†åŸŸå±‚ä¸­å¯ä»¥é¿å…ä»£ç é‡å¤ã€‚æ¯”å¦‚è¯´ï¼Œåº”ç”¨ç¨‹åºçš„å¤šä¸ªéƒ¨åˆ†å…è®¸æ›´æ–°ç”¨æˆ·çš„ä¸ªäººèµ„æ–™ï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ª <code>UpdateUserProfileUseCase</code> å¹¶åœ¨éœ€è¦çš„åœ°æ–¹å¼•ç”¨å®ƒã€‚</p>

<h3>æ•°æ®å±‚ï¼šå­˜å‚¨åº“å’Œæ•°æ®æº</h3>

<p>æ•°æ®å±‚åˆ†ä¸ºå­˜å‚¨åº“å’Œæ•°æ®æºã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:950/1*gmZwdLcQrrLRkSGnR3PL1w.png" alt="ç°ä»£åº”ç”¨æ¶æ„çš„æ•°æ®å±‚ï¼šç°ä»£åº”ç”¨æ¶æ„å›¾çš„æ‰©å±•ï¼Œæ˜¾ç¤ºæ•°æ®å±‚åˆ†ä¸ºå­˜å‚¨åº“å’Œæ•°æ®æº" /></p>

<p>å­˜å‚¨åº“è´Ÿè´£æä¾›æ•°æ®å’Œä¿å­˜æ•°æ®ã€‚å®ƒåŒ…å« <code>getUserProfile()</code> å’Œ <code>saveUserProfile(â€¦)</code> æ–¹æ³•ã€‚</p>

<p>æ•°æ®æºæ‰§è¡Œä¸“æœ‰å·¥ä½œï¼Œä¾‹å¦‚é€šè¿‡è°ƒç”¨ API æˆ–ç¼–å†™ SQL å‘½ä»¤ã€‚</p>

<p>é€šå¸¸ï¼Œä¸€ä¸ªå­˜å‚¨åº“è´Ÿè´£å¤šä¸ªæ•°æ®æºã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½å°†æ•°æ®å­˜å‚¨åœ¨è¿œç¨‹å­˜å‚¨åº“å’Œç›¸åŒçš„æœ¬åœ°ç¼“å­˜ä¸­ã€‚æ¯ä¸ªå­˜å‚¨åº“éƒ½å°†ä½œä¸ºå•ç‹¬çš„æ•°æ®æºå®ç°ã€‚ç„¶åï¼Œåœ¨è¯»å–ç”¨æˆ·ä¸ªäººèµ„æ–™æ—¶ï¼Œå­˜å‚¨åº“å¯èƒ½ä¼šå°è¯•ä»æœ¬åœ°ç¼“å­˜è¯»å–ï¼Œå¦‚æœç¼“å­˜ä¸ºç©ºï¼Œåˆ™å›é€€åˆ°è¿œç¨‹æ•°æ®åº“ã€‚è¿™æ ·ï¼Œè´Ÿè´£å¤šä¸ªæ•°æ®æºçš„å­˜å‚¨åº“å¿…é¡»åè°ƒä½¿ç”¨å“ªä¸ªæ•°æ®æºä»¥åŠå¦‚ä½•åŒæ­¥å®ƒä»¬ã€‚</p>

<p>å†æ¬¡å¼ºè°ƒï¼Œä½¿ç”¨ Kotlin Flows å‘è°ƒç”¨è€…æä¾›æ•°æ®æ˜¯ä¸€ç§å¾ˆå¥½çš„åšæ³•ã€‚</p>

<h2>æ¯”è¾ƒ Google çš„ç°ä»£åº”ç”¨æ¶æ„ä¸ Clean Architecture</h2>

<p>ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œç°ä»£åº”ç”¨æ¶æ„å’Œ Clean Architecture å„è‡ªä½¿ç”¨â€œå±‚â€ä¸€è¯æ¥è¡¨ç¤ºç•¥æœ‰ä¸åŒçš„å«ä¹‰ã€‚ä»¥ä¸‹æ˜¯å®ƒä»¬ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*9Ds8N-6LZNDNclnZEyX48w.png" alt="ç°ä»£åº”ç”¨æ¶æ„å¦‚ä½•ä¸ Clean Architecture ç›¸é€‚åº”ï¼šç°ä»£åº”ç”¨æ¶æ„å’Œ Clean Architecture å›¾è¡¨çš„æ¯”è¾ƒï¼Œæ˜¾ç¤ºï¼šUI å±‚ä¸ Clean Architecture çš„ UI å’Œ Presenter å¯¹åº”ï¼ˆåˆ†åˆ«ä½äºæ¡†æ¶å’Œé©±åŠ¨ç¨‹åºå±‚ä»¥åŠæ¥å£é€‚é…å™¨å±‚ï¼‰ã€‚é¢†åŸŸå±‚ä¸ Clean Architecture çš„ç”¨ä¾‹å±‚å’Œå®ä½“å±‚å¯¹åº”ã€‚æ•°æ®å±‚ä¸ Clean Architecture çš„å­˜å‚¨åº“å’Œ Presenter å¯¹åº”ï¼ˆåˆ†åˆ«ä½äºæ¥å£é€‚é…å™¨å±‚ä»¥åŠæ¡†æ¶å’Œé©±åŠ¨ç¨‹åºå±‚ï¼‰ã€‚" /></p>

<p>Google çš„ UI å±‚ä¸å…¶æ•°æ®å±‚ä¸€æ ·ï¼Œä½äº Clean Architecture çš„å¤–å±‚ä¸¤å±‚ï¼ˆæ¥å£é€‚é…å™¨ã€æ¡†æ¶å’Œé©±åŠ¨ç¨‹åºï¼‰ã€‚å®ƒçš„é¢†åŸŸå±‚å®Œå…¨ç­‰åŒäº Clean Architecture çš„ç”¨ä¾‹å’Œå®ä½“ã€‚</p>

<p>å…¶ä¸­ä¸€äº›ç•Œé™æ¯”ä¸Šå›¾æ˜¾ç¤ºçš„è¦æ¨¡ç³Šä¸€äº›ã€‚ä¾‹å¦‚ï¼ŒGoogle å¹¶ä¸åå¯¹ä½ å°†ä¸šåŠ¡é€»è¾‘æ”¾ç½®åœ¨ UI å±‚ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè‡ªå·±çš„é¢†åŸŸå±‚è¢«æ ‡è®°ä¸ºå¯é€‰çš„åŸå› ã€‚</p>

<p>UI å±‚å’Œæ•°æ®å±‚éƒ½ç­‰åŒäº Clean Architecture çš„æ¥å£é€‚é…å™¨å±‚å’Œæ¡†æ¶/é©±åŠ¨ç¨‹åºå±‚ã€‚</p>

<h2>æ€»ç»“â€¦â€¦</h2>

<p>æœ¬æ–‡æ·±å…¥æ¢è®¨äº†è‰¯å¥½æ¶æ„èƒŒåçš„åŸåˆ™ï¼Œå¹¶ä»¥ä¸¤ç§å¸¸è§èŒƒå¼ä¸ºçµæ„Ÿï¼šClean Architecture å’Œ Google çš„ç°ä»£åº”ç”¨æ¶æ„ã€‚</p>

<p>å½“ç„¶ï¼Œä½ éœ€è¦è‡ªè¡Œå†³å®šå“ªç§æ¶æ„æœ€é€‚åˆä½ çš„åº”ç”¨ç¨‹åºã€‚æˆ‘å¸Œæœ›é€šè¿‡æä¾›æ€è·¯è€Œä¸æ˜¯åƒµåŒ–çš„æ¡†æ¶ï¼Œä¸ºä½ æä¾›ä¸€ä¸ªå·¥å…·åŒ…ï¼Œä»¥ä¾¿ä½ è‡ªè¡Œåšå‡ºå†³å®šã€‚</p>

<p>æˆ‘å–œæ¬¢å›ç­”å…³äºæ¶æ„çš„å…·ä½“é—®é¢˜ï¼Œæ‰€ä»¥è¯·éšæ—¶åœ¨è¿™é‡Œç•™ä¸‹ä½ çš„ç­”æ¡ˆï¼Œæˆ‘ä¼šå°½å¿«å›å¤ã€‚å½“æ²¡æœ‰å”¯ä¸€çš„â€œæ­£ç¡®â€ç­”æ¡ˆï¼Œè€Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œè®¨è®ºæ—¶ï¼Œè¿™æ‰æ˜¯æœ€æœ‰è¶£çš„ã€‚</p>

<p>åœ¨ä»¥åçš„æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ä¸Šè¿°å†…å®¹é€æ­¥æŒ‡å¯¼ä½ ä½¿ç”¨ Kotlin å’Œ Compose åˆ›å»ºæ¶æ„è‰¯å¥½çš„ç¤ºä¾‹åº”ç”¨ç¨‹åºã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[é¢å‘å¼€å‘è€…çš„ç³»ç»Ÿè®¾è®¡ï¼šåƒå»ºç­‘å¸ˆä¸€æ ·æ€è€ƒ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"/>
    <updated>2025-09-24T14:31:48+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒSystem Design for Developers: Think Like an Architectã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28">https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28</a>ï¼Œç”±Saurabh Singhå‘å¸ƒäº2025å¹´8æœˆ25æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*b1eSMQdryXSteTJredbMtA.png" title="auto auto" ></a></p>

<!-- more -->


<blockquote><p>â€œå»ºç­‘æ˜¯ä¸€ç§ç¤¾ä¼šè¡Œä¸ºï¼Œä¹Ÿæ˜¯äººç±»æ´»åŠ¨çš„ç‰©è´¨èˆå°ã€‚â€â€”â€” Spiro Kostof</p></blockquote>

<p>æ­£å¦‚å»ºç­‘å¸ˆä¸ä¼šåœ¨æ²¡æœ‰è“å›¾çš„æƒ…å†µä¸‹å¼€å§‹å»ºé€ ä¸€æ ·ï¼Œå¼€å‘è€…ä¹Ÿä¸åº”è¯¥åœ¨æ²¡æœ‰ç³»ç»Ÿè®¾è®¡çš„æƒ…å†µä¸‹å¼€å§‹ç¼–ç ã€‚ç„¶è€Œï¼Œè®¸å¤šå¼€å‘è€…ç›´æ¥è¿›å…¥å®ç°é˜¶æ®µï¼Œå´å‘ç°è‡ªå·±é™·å…¥äº†æŠ€æœ¯å€ºåŠ¡ã€æ€§èƒ½ç“¶é¢ˆå’Œæ¶æ„å™©æ¢¦çš„è¿·å®«ä¹‹ä¸­ï¼Œè€Œè¿™äº›æœ¬å¯ä»¥é€šè¿‡é€‚å½“çš„è§„åˆ’æ¥é¿å…ã€‚</p>

<p>ç³»ç»Ÿè®¾è®¡æ˜¯ä¸€é—¨è‰ºæœ¯å’Œç§‘å­¦ï¼Œå®ƒå®šä¹‰ç³»ç»Ÿçš„æ¶æ„ã€ç»„ä»¶ã€æ¨¡å—ã€æ¥å£å’Œæ•°æ®ï¼Œä»¥æ»¡è¶³ç‰¹å®šéœ€æ±‚ã€‚å®ƒå°±åƒä¸€åº§å±¹ç«‹ç™¾å¹´çš„æˆ¿å±‹å’Œä¸€åº§å› è‡ªèº«é‡é‡è€Œå€’å¡Œçš„æˆ¿å±‹ä¹‹é—´çš„åŒºåˆ«ã€‚</p>

<h2>å»ºç­‘å¸ˆçš„æ€ç»´æ–¹å¼ï¼šåˆ†è§£å¤æ‚é—®é¢˜</h2>

<h2>åˆ†å±‚æ€è€ƒï¼Œè€Œéç›´çº¿æ€è€ƒ</h2>

<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ æ­£åœ¨è®¾è®¡ä¸€åº§æ‘©å¤©å¤§æ¥¼ã€‚ä½ ä¸ä¼šå…ˆå†³å®šç¬¬ 47 å±‚çš„å¢™å£è¦åˆ·ä»€ä¹ˆé¢œè‰²ã€‚ä½ ä¼šå…ˆä»åœ°åŸºå¼€å§‹ï¼Œç„¶åæ˜¯ç»“æ„æ¡†æ¶ï¼Œæ¥ç€æ˜¯ç”µæ°”å’Œç®¡é“ç³»ç»Ÿï¼Œæœ€åæ˜¯å®¤å†…è®¾è®¡ã€‚</p>

<p>è½¯ä»¶ç³»ç»Ÿä¹Ÿéµå¾ªåŒæ ·çš„åŸåˆ™ã€‚æƒ³è±¡ä¸€ä¸‹<strong>å¯è§†åŒ–é¡µé¢æ„å»ºå™¨åº”ç”¨ç¨‹åº</strong>â€”â€”æƒ³æƒ³ Webflowã€Wix æˆ– Squarespace ç­‰å·¥å…·ï¼Œå®ƒä»¬å…è®¸ç”¨æˆ·é€šè¿‡æ‹–æ”¾ç•Œé¢åˆ›å»ºç½‘é¡µï¼Œè€Œæ— éœ€ç¼–å†™ä»£ç ã€‚è¿™äº›ç³»ç»Ÿéå¸¸å¤æ‚ï¼Œç”¨æˆ·å¯ä»¥ï¼š</p>

<ul>
<li>å°†ç»„ä»¶ï¼ˆæŒ‰é’®ã€å›¾ç‰‡ã€æ–‡æœ¬å—ï¼‰ä»åº“æ‹–æ”¾åˆ°ç”»å¸ƒä¸Š</li>
<li>é€šè¿‡å¯è§†åŒ–æ§ä»¶è‡ªå®šä¹‰å±æ€§ï¼ˆé¢œè‰²ã€å­—ä½“ã€å¤§å°ï¼‰</li>
<li>åœ¨æ„å»ºè¿‡ç¨‹ä¸­å®æ—¶é¢„è§ˆé¡µé¢</li>
<li>å°†ç½‘ç«™ç›´æ¥å‘å¸ƒåˆ° Web ä¸Š</li>
<li>ä¸å›¢é˜Ÿæˆå‘˜å®æ—¶åä½œ</li>
</ul>


<p>æ¶æ„å¸ˆæ— éœ€æ·±å…¥ç ”ç©¶æ‹–æ”¾åŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯é¦–å…ˆæ€è€ƒï¼š</p>

<p>åŸºç¡€å±‚ï¼šæ ¸å¿ƒå®ä½“æœ‰å“ªäº›ï¼Ÿ</p>

<p>é¡µé¢ã€ç»„ä»¶ã€æ¨¡æ¿ã€ç”¨æˆ·ã€é¡¹ç›®</p>

<p>ç»“æ„å±‚ï¼šè¿™äº›å®ä½“ä¹‹é—´å¦‚ä½•å…³è”ï¼Ÿ</p>

<p>ç”¨æˆ·åˆ›å»ºé¡¹ç›®
é¡¹ç›®åŒ…å«é¡µé¢
é¡µé¢ç”±ç»„ä»¶ç»„æˆ
ç»„ä»¶å¯ä»¥ä¿å­˜ä¸ºæ¨¡æ¿</p>

<p>ç³»ç»Ÿå±‚ï¼šå®ƒä»¬å¦‚ä½•é€šä¿¡ï¼Ÿ</p>

<ul>
<li>ç”¨äº CRUD æ“ä½œçš„ RESTful API</li>
<li>ç”¨äºå®æ—¶åä½œçš„ WebSocket è¿æ¥</li>
<li>ç”¨äºç»„ä»¶æ›´æ–°çš„äº‹ä»¶é©±åŠ¨æ¶æ„</li>
</ul>


<p><strong>ç•Œé¢å±‚</strong>ï¼šç”¨æˆ·å¦‚ä½•äº¤äº’ï¼Ÿ</p>

<ul>
<li>ç”¨äºé¡¹ç›®ç®¡ç†çš„ä»ªè¡¨ç›˜</li>
<li>ç”¨äºé¡µé¢ç¼–è¾‘çš„ç”»å¸ƒ</li>
<li>ç”¨äºé€‰æ‹©çš„ç»„ä»¶åº“</li>
<li>ç”¨äºæµ‹è¯•çš„é¢„è§ˆæ¨¡å¼</li>
</ul>


<p>æ­£å¦‚è½¯ä»¶å·¥ç¨‹å¸ˆ Grady Booch æ›¾ç»è¯´è¿‡çš„ï¼šâ€œä¼˜ç§€è½¯ä»¶çš„åŠŸèƒ½åœ¨äºåŒ–ç¹ä¸ºç®€ã€‚â€ è¿™ç§åˆ†å±‚æ–¹æ³•å°†æå…¶å¤æ‚çš„å†…å®¹è½¬åŒ–ä¸ºæ˜“äºç®¡ç†çš„æ¨¡å—ã€‚</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šåˆ†å±‚æ¶æ„</h2>

<p><strong>ç°åœ¨å°±æ‹¿èµ·çº¸ç¬”ï¼</strong>åœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œè¯·å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š</p>

<ol>
<li><strong>ç”»å››ä¸ªæ°´å¹³çŸ©å½¢</strong>ï¼Œå¹¶å°†å®ƒä»¬å æ”¾åœ¨ä¸€èµ·</li>
<li><strong>ä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ ‡æ³¨</strong>ï¼šç•Œé¢ã€ç³»ç»Ÿã€ç»“æ„ã€åŸºç¡€</li>
<li><strong>é€‰æ‹©ä½ æ—¥å¸¸ä½¿ç”¨çš„ä»»ä½•åº”ç”¨</strong>ï¼ˆNetflixã€Amazonã€WhatsAppï¼‰</li>
<li><strong>åœ¨æ¯ä¸€å±‚</strong>ä¸­å¡«å…¥ä½ è®¤ä¸ºåº”è¯¥å¡«å…¥çš„å†…å®¹</li>
</ol>


<p>Netflix ç¤ºä¾‹ï¼š_</p>

<ul>
<li>ç•Œé¢ï¼šæœç´¢æ ã€è§†é¢‘æ’­æ”¾å™¨ã€æ¨è</li>
<li>ç³»ç»Ÿï¼šæµåª’ä½“æœåŠ¡ã€æ¨èå¼•æ“ã€ç”¨æˆ·èº«ä»½éªŒè¯</li>
<li>ç»“æ„ï¼šç”¨æˆ·è§‚çœ‹ç”µå½±ï¼Œç”µå½±æœ‰è¯„åˆ†</li>
<li>åŸºç¡€ï¼šç”¨æˆ·ã€ç”µå½±ã€è¯„åˆ†ã€è®¢é˜…</li>
</ul>


<p><strong>ä¸ºä»€ä¹ˆè¦ç”»è¿™ä¸ªï¼Ÿ</strong>ä½ çš„å¤§è„‘å¯¹ä½ æ‰‹ç»˜å†…å®¹çš„è®°å¿†åŠ›æ¯”ä½ åˆšåˆšé˜…è¯»çš„å†…å®¹å¼º 6 å€ã€‚è¿™å¼ ç®€å•çš„è‰å›¾ä¼šè®©ä½ ç«‹åˆ»ç†è§£æ–‡ç« çš„å…¶ä½™éƒ¨åˆ†ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:2000/1*k5g3kjh3ugcfUf5CWJjoFw.jpeg" alt="æˆ‘åœ¨é‡æ–°è®¾è®¡è§†é¢‘å¹³å°æ¶æ„æ—¶ç”»äº†è¿™å¼ è‰å›¾ã€‚äº§å“ç»ç†ç»ˆäºæ˜ç™½äº†ä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸èƒ½ç®€å•åœ°â€œæ·»åŠ ä¸€ä¸ªåŠŸèƒ½â€â€”â€”ä»–èƒ½çœ‹åˆ°å®ƒä¼šå½±å“åˆ°å“ªä¸ªå±‚çº§ã€‚è¿™å¼ å›¾é¿å…äº†3ä¸ªæœˆçš„æŠ€æœ¯å€ºåŠ¡ï¼" /></p>

<h2>åˆ†è§£ç­–ç•¥</h2>

<p>åˆ†è§£å¤æ‚é—®é¢˜å°±åƒè§£å‰–æ‰‹è¡¨ã€‚ä½ éœ€è¦äº†è§£æ¯ä¸ªé½¿è½®ã€å¼¹ç°§å’Œæœºæ¢°è£…ç½®ï¼Œç„¶åæ‰èƒ½æ„å»ºæˆ–ä¿®å¤æ•´ä¸ªé’Ÿè¡¨ã€‚</p>

<p><strong>åŠŸèƒ½åˆ†è§£ç¤ºä¾‹</strong>ï¼šå¯è§†åŒ–é¡µé¢æ„å»ºå™¨</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Page</span> <span class="n">Builder</span> <span class="n">System</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Authentication</span> <span class="o">&amp;</span> <span class="n">Authorization</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">User</span> <span class="n">registration</span><span class="o">/</span><span class="n">login</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Role</span><span class="o">-</span><span class="n">based</span> <span class="n">permissions</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Session</span> <span class="n">management</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Project</span> <span class="n">Management</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Project</span> <span class="n">CRUD</span> <span class="n">operations</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Version</span> <span class="n">control</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Collaboration</span> <span class="n">features</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Page</span> <span class="n">Editor</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Canvas</span> <span class="n">rendering</span> <span class="n">engine</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Component</span> <span class="n">management</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Drag</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">drop</span> <span class="n">interface</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Real</span><span class="o">-</span><span class="n">time</span> <span class="n">preview</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="n">Component</span> <span class="n">Library</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Built</span><span class="o">-</span><span class="ow">in</span> <span class="n">components</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â”œâ”€â”€</span> <span class="n">Custom</span> <span class="n">components</span>
</span><span class='line'><span class="err">â”‚</span>   <span class="err">â””â”€â”€</span> <span class="n">Template</span> <span class="n">system</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="n">Export</span> <span class="o">&amp;</span> <span class="n">Publishing</span>
</span><span class='line'>    <span class="err">â”œâ”€â”€</span> <span class="n">Static</span> <span class="n">site</span> <span class="n">generation</span>
</span><span class='line'>    <span class="err">â”œâ”€â”€</span> <span class="n">Hosting</span> <span class="n">integration</span>
</span><span class='line'>    <span class="err">â””â”€â”€</span> <span class="n">SEO</span> <span class="n">optimization</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¯ä¸ªåˆ†æ”¯éƒ½å¯ä»¥ç‹¬ç«‹å¼€å‘ã€å•ç‹¬æµ‹è¯•ï¼Œå¹¶ç³»ç»Ÿåœ°é›†æˆã€‚è¿™ç§æ–¹æ³•éµå¾ª Unix å“²å­¦ï¼šâ€œä¸“å¿ƒåšå¥½ä¸€ä»¶äº‹ã€‚â€</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šç³»ç»Ÿåˆ†è§£æ ‘</h2>

<p><strong>åˆè¯¥ç”»è‰å›¾äº†ï¼</strong> è¿™ä¸ªç»ƒä¹ å¯ä»¥è®­ç»ƒä½ çš„â€œæ¶æ„å¸ˆå¤§è„‘â€ï¼š</p>

<ol>
<li><strong>ç”»ä¸€ä¸ªæ ‘å½¢ç»“æ„</strong>ï¼Œä»¥â€œé¡µé¢æ„å»ºå™¨â€ä¸ºæ ¹</li>
<li><strong>æ·»åŠ  5 ä¸ªä¸»è¦åˆ†æ”¯</strong>ï¼ˆæ€è€ƒï¼šå“ªäº›æ˜¯å¤§å—ï¼Ÿï¼‰</li>
<li><strong>åœ¨æ¯ä¸ªåˆ†æ”¯ä¸‹ï¼Œæ·»åŠ  2-3 ä¸ªå¶å­</strong>ï¼ˆè¾ƒå°çš„éƒ¨åˆ†ï¼‰</li>
<li><strong>ä½¿ç”¨ç®€å•çš„æ–¹æ¡†å’Œçº¿æ¡</strong>â€”â€”æ— éœ€å¤æ‚çš„å›¾è¡¨ï¼</li>
</ol>


<p><em>ä½ çš„ç»˜å›¾å¯èƒ½çœ‹èµ·æ¥åƒï¼š</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="nf">Page Builder</span>
</span><span class='line'><span class="nf">   /</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   \</span>
</span><span class='line'><span class="nf"> Auth  Pages  Components  Export</span>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span><span class="nf"></span>
</span><span class='line'><span class="nf">Login  Create   Library   HTML</span>
</span><span class='line'><span class="nf">Signup Edit</span>
</span><span class='line'>
</span><span class='line'><span class="nf">Custom</span>
</span><span class='line'>
</span><span class='line'><span class="nf">PDF</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ç¥å¥‡æ—¶åˆ»</strong>ï¼šå½“ä½ æ— æ³•è¿›ä¸€æ­¥åˆ†è§£ä¸€ä¸ªæ–¹æ¡†æ—¶ï¼Œè¿™å¯èƒ½å°±æ˜¯ä¸€ä¸ªå¼€å‘äººå‘˜ä¸€å‘¨çš„å·¥ä½œã€‚å¦‚æœè§‰å¾—æ–¹æ¡†å¤ªå¤§ï¼Œå°±è¿›ä¸€æ­¥åˆ†è§£å®ƒï¼</p>

<h2>å¯æ‰©å±•æ€§ï¼šä»Šå¤©æ„å»ºï¼Œåº”å¯¹æœªæ¥çš„é—®é¢˜</h2>

<h2>æˆé•¿å‹æ€ç»´</h2>

<blockquote><p>â€œç§ä¸€æ£µæ ‘çš„æœ€ä½³æ—¶æœºæ˜¯20å¹´å‰ï¼Œå…¶æ¬¡æ˜¯ç°åœ¨ã€‚â€â€”â€”ä¸­å›½è°šè¯­</p></blockquote>

<p>å¯æ‰©å±•æ€§è§„åˆ’å°±åƒä¸ºæˆ¿å­é€‰æ‹©åœ°åŸºã€‚ä½ å¯èƒ½ä»ä¸€æ ‹å°å±‹å¼€å§‹ï¼Œä½†å¦‚æœä½ è®¡åˆ’æ‰©å»ºæˆä¸€åº§è±ªå®…ï¼Œä½ å°±éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿæ”¯æ’‘æœªæ¥å‘å±•çš„åœ°åŸºã€‚</p>

<p>è€ƒè™‘ä¸‰ä¸ªå¯æ‰©å±•æ€§ç»´åº¦ï¼š</p>

<p><strong>å‚ç›´æ‰©å±•ï¼ˆå‘ä¸Šæ‰©å±•ï¼‰</strong>ï¼šå°±åƒåœ¨å»ºç­‘ç‰©ä¸­å¢åŠ æ›´å¤šæ¥¼å±‚</p>

<ul>
<li>å¢åŠ ç°æœ‰æœåŠ¡å™¨ä¸Šçš„ CPUã€RAM æˆ–å­˜å‚¨ç©ºé—´</li>
<li>ç®€å•ä½†å­˜åœ¨ç‰©ç†é™åˆ¶</li>
<li>å•ç‚¹æ•…éšœ</li>
</ul>


<p><strong>æ°´å¹³æ‰©å±•ï¼ˆå‘å¤–æ‰©å±•ï¼‰</strong>ï¼šå°±åƒåœ¨ç»¼åˆä½“ä¸­å»ºé€ æ›´å¤šå»ºç­‘ç‰©</p>

<ul>
<li>æ·»åŠ æ›´å¤šæœåŠ¡å™¨ä»¥åˆ†æ•£è´Ÿè½½</li>
<li>æ›´å¤æ‚ä½†å‡ ä¹ä¸å—é™åˆ¶</li>
<li>æ›´å¥½çš„å®¹é”™èƒ½åŠ›</li>
</ul>


<p><strong>åŠŸèƒ½æ‰©å±•</strong>ï¼šå°±åƒä¸ºä¸åŒç”¨é€”å»ºé€ ä¸“ç”¨å»ºç­‘ç‰©</p>

<ul>
<li>å¾®æœåŠ¡æ¶æ„</li>
<li>æ¯ä¸ªæœåŠ¡å¤„ç†ç‰¹å®šåŠŸèƒ½</li>
<li>ç‹¬ç«‹æ‰©å±•å’Œéƒ¨ç½²</li>
</ul>


<h2>å¯æ‰©å±•æ€§çš„çº¢ç»¿ç¯ç³»ç»Ÿ</h2>

<p><strong>ğŸŸ¢ ç»¿ç¯å†³ç­–ï¼ˆç¬¬ä¸€å¤©ï¼‰</strong>ï¼š</p>

<ul>
<li>ç®€å•çš„å•ä½“æ¶æ„</li>
<li>å•ä¸€æ•°æ®åº“</li>
<li>ä½¿ç”¨ Redis è¿›è¡ŒåŸºæœ¬ç¼“å­˜</li>
<li>é™æ€èµ„æºçš„ CDN</li>
</ul>


<p><strong>ğŸŸ¡ é»„ç¯å†³ç­–ï¼ˆæµé‡å¢é•¿ï¼‰</strong>ï¼š</p>

<ul>
<li>æ•°æ®åº“åªè¯»å‰¯æœ¬</li>
<li>åº”ç”¨æœåŠ¡å™¨é›†ç¾¤</li>
<li>API é€Ÿç‡é™åˆ¶</li>
<li>ç›‘æ§å’ŒæŠ¥è­¦ç³»ç»Ÿ</li>
</ul>


<p><strong>ğŸ”´ çº¢ç¯å†³ç­–ï¼ˆé«˜æµé‡ï¼‰</strong>ï¼š</p>

<ul>
<li>å¾®æœåŠ¡æ¶æ„</li>
<li>æ•°æ®åº“åˆ†ç‰‡</li>
<li>ç”¨äºå¼‚æ­¥å¤„ç†çš„æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>è‡ªåŠ¨æ‰©å±•åŸºç¡€è®¾æ–½</li>
</ul>


<p>å¯¹äºæˆ‘ä»¬çš„é¡µé¢æ„å»ºå™¨ç¤ºä¾‹ï¼Œä½ å¯ä»¥ä»ä¸€ä¸ªç®€å•çš„ Python FastAPI æœåŠ¡å™¨å’Œ PostgreSQL æ•°æ®åº“å¼€å§‹ã€‚éšç€æµé‡çš„å¢é•¿ï¼Œä½ å°†å¼•å…¥ï¼š</p>

<ol>
<li><strong>ç¼“å­˜å±‚</strong>ï¼šç”¨äºä¼šè¯å­˜å‚¨å’Œé¢‘ç¹è®¿é—®çš„æ¨¡æ¿çš„ Redis</li>
<li><strong>CDN</strong>ï¼šç”¨äºæœåŠ¡ç»„ä»¶èµ„æºå’Œç”Ÿæˆé¡µé¢çš„ CloudFront</li>
<li><strong>æ•°æ®åº“ä¼˜åŒ–</strong>ï¼šç”¨äºåˆ†æçš„è¯»å–å‰¯æœ¬ï¼Œä¸ºä¸åŒåŸŸæä¾›ç‹¬ç«‹çš„æ•°æ®åº“</li>
<li><strong>æœåŠ¡åˆ†ç¦»</strong>ï¼šç”¨äºæ¸²æŸ“ã€æ–‡ä»¶ç®¡ç†å’Œç”¨æˆ·ç®¡ç†çš„ä¸“ç”¨å¾®æœåŠ¡</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*93OTsJ_L4-7WhICsL2EL4w.jpeg" alt="æˆ‘ç»˜åˆ¶äº§å“ç›®æ ‡çš„è‰å›¾" /></p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ‰©å±•æ¼”è¿›</h2>

<p><strong>è¿™å¼ å›¾å°†æˆä¸ºä½ çš„æ‰©å±•è·¯çº¿å›¾ï¼</strong></p>

<ol>
<li>åœ¨ä½ çš„çº¸ä¸Š<strong>ç”»ä¸‰åˆ—</strong>ï¼Œåˆ†åˆ«æ ‡è®°ä¸ºï¼šâ€œç¬¬ 1 å¤©â€ã€â€œç¬¬ 6 ä¸ªæœˆâ€ã€â€œç¬¬ 2 å¹´â€</li>
<li><p><strong>åœ¨æ¯ä¸€åˆ—ä¸­ï¼Œç”»å‡ºä½ çš„æ¶æ„å›¾ï¼š</strong></p></li>
<li><p>ç¬¬ 1 å¤©ï¼šç”»ä¸¤ä¸ªæ–¹æ¡†ï¼ˆå‰ç«¯ã€APIï¼‰ï¼Œä¸‹æ–¹ç”»ä¸€ä¸ªåœ†æŸ±ä½“ï¼ˆæ•°æ®åº“ï¼‰</p></li>
<li>ç¬¬ 6 ä¸ªæœˆï¼šæ·»åŠ æ›´å¤šæ–¹æ¡†ï¼ˆRedis ç¼“å­˜ã€CDN äº‘ã€è´Ÿè½½å‡è¡¡å™¨ï¼‰</li>
<li>ç¬¬ 2 å¹´ï¼šå°† API æ–¹æ¡†æ‹†åˆ†æˆå¤šä¸ªå°æ–¹æ¡†ï¼ˆç”¨æˆ·æœåŠ¡ã€é¡¹ç›®æœåŠ¡ç­‰ï¼‰</li>
</ol>


<p><strong>3. åœ¨å„åˆ—ä¹‹é—´ç”»ç®­å¤´</strong>ï¼Œå±•ç¤ºæ¼”è¿›è¿‡ç¨‹</p>

<p><strong>4. åœ¨æ¯åˆ—ä¸Šæ–¹ç”»ä¸€äº›ç®€ç¬”ç”»</strong>ï¼Œå±•ç¤ºç”¨æˆ·æ•°é‡ï¼š100 â†’ 1 ä¸‡ â†’ 100 ä¸‡</p>

<p><strong>ä»ä½ çš„å›¾ä¸­å¾—å‡ºçš„å…³é”®æ´å¯Ÿï¼š</strong>æ³¨æ„å¤æ‚æ€§æ˜¯å¦‚ä½•é€æ¸å¢é•¿çš„ï¼Œè€Œä¸æ˜¯ä¸€ä¸‹å­å¢é•¿çš„ã€‚è¿™å°±æ˜¯çœŸå®ç³»ç»Ÿæ¼”è¿›çš„æ–¹å¼ï¼</p>

<h2>èŒè´£ä¸‰ä½ä¸€ä½“ï¼šæ•°æ®åº“ã€API å’Œå‰ç«¯</h2>

<h2>ä¸‰å±‚æ¶æ„ç†å¿µ</h2>

<p>å°† Web åº”ç”¨ç¨‹åºæƒ³è±¡æˆä¸€å®¶é¤å…ï¼š</p>

<p><strong>å‰ç«¯ï¼ˆé¤å…ï¼‰</strong>ï¼šå®¢æˆ·äº’åŠ¨çš„åœ°æ–¹</p>

<ul>
<li>ç”¨æˆ·ç•Œé¢å’Œä½“éªŒ</li>
<li>è¾“å…¥éªŒè¯å’Œæ ¼å¼åŒ–</li>
<li>çŠ¶æ€ç®¡ç†å’Œè·¯ç”±</li>
</ul>


<p><strong>APIï¼ˆå¨æˆ¿ï¼‰</strong>ï¼šé­”æ³•å‘ç”Ÿçš„åœ°æ–¹</p>

<ul>
<li>ä¸šåŠ¡é€»è¾‘å¤„ç†</li>
<li>æ•°æ®è½¬æ¢å’ŒéªŒè¯</li>
<li>ä¸å¤–éƒ¨æœåŠ¡é›†æˆ</li>
</ul>


<p><strong>æ•°æ®åº“ï¼ˆé£Ÿå“å‚¨è—å®¤ï¼‰</strong>ï¼šé£Ÿæå­˜å‚¨çš„åœ°æ–¹</p>

<ul>
<li>æ•°æ®æŒä¹…åŒ–å’Œæ£€ç´¢</li>
<li>æ•°æ®å®Œæ•´æ€§å’Œå…³ç³»</li>
<li>æ€§èƒ½ä¼˜åŒ–</li>
</ul>


<blockquote><p>â€œå¥½çš„æ¶æ„ä¸åœ¨äºç»“æ„æœ¬èº«ï¼Œè€Œåœ¨äºå®ƒæ‰€åˆ›é€ çš„ç©ºé—´ã€‚â€ â€” å®‰è—¤å¿ é›„</p></blockquote>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šé¤å…æ¶æ„</h2>

<p><strong>è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»˜ç”»ç»ƒä¹ æ¥å…·ä½“åŒ–è¿™ä¸€ç‚¹ï¼š</strong></p>

<ol>
<li><p><strong>ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„é¤å…å¹³é¢å›¾</strong>ï¼Œå…¶ä¸­åŒ…å«ä¸‰ä¸ªåŒºåŸŸï¼š</p></li>
<li><p>é¤å…ï¼ˆé¡¾å®¢å°±åº§çš„åœ°æ–¹ï¼‰</p></li>
<li>å¨æˆ¿ï¼ˆå‡†å¤‡é£Ÿç‰©çš„åœ°æ–¹ï¼‰</li>
<li>å‚¨è—å®¤ï¼ˆå­˜æ”¾é£Ÿæçš„åœ°æ–¹ï¼‰</li>
</ol>


<p><strong>2. ç°åœ¨ç»˜åˆ¶ç®­å¤´è¡¨ç¤ºæ•°æ®æµå‘ï¼š</strong></p>

<ul>
<li>é¡¾å®¢ç‚¹é¤ â†’ å¨æˆ¿</li>
<li>å¨æˆ¿ç´¢å–é£Ÿæ â†’ å‚¨è—å®¤</li>
<li><p>å¨æˆ¿é€å‡ºå‡†å¤‡å¥½çš„é£Ÿç‰© â†’ é¤å…</p></li>
<li><p><strong>ä¸ºæ¯ä¸ªåŒºåŸŸæ ‡æ³¨ç›¸åº”çš„ Web å¯¹åº”é¡¹ï¼š</strong></p></li>
<li><p>é¤å… = å‰ç«¯</p></li>
<li>å¨æˆ¿ = API</li>
<li>å‚¨è—å®¤ = æ•°æ®åº“</li>
</ul>


<p><strong>ä¸ºä»€ä¹ˆè¿™æ ·åšæœ‰æ•ˆï¼š</strong>ç°åœ¨ä½ çš„å¤§è„‘å·²ç»å¯¹æŠ½è±¡çš„ç³»ç»Ÿæ¦‚å¿µæœ‰äº†ç‰©ç†éšå–»ã€‚æ¯æ¬¡è®¾è®¡ç³»ç»Ÿæ—¶ï¼Œæƒ³è±¡ä¸€ä¸‹è¿™å®¶é¤å…çš„åœºæ™¯ï¼</p>

<h2>èŒè´£è¾¹ç•Œ</h2>

<p><strong>æ•°æ®åº“èŒè´£</strong>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">âœ…</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">handles</span> <span class="n">data</span> <span class="n">integrity</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">email</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">UNIQUE</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">created_at</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">NOW</span><span class="p">()</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">âœ…</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">enforces</span> <span class="n">relationships</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">pages</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="n">INTEGER</span> <span class="n">REFERENCES</span> <span class="n">projects</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="n">ON</span> <span class="n">DELETE</span> <span class="n">CASCADE</span><span class="p">,</span>
</span><span class='line'>    <span class="n">title</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>API èŒè´£</strong>ï¼ˆPython å’Œ FastAPIï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># âœ… Good: API handles business logic</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span><span class="nd">@app.post</span><span class="p">(</span><span class="s">&quot;/api/pages&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">create_page</span><span class="p">(</span>
</span><span class='line'>    <span class="n">page_data</span><span class="p">:</span> <span class="n">PageCreateModel</span><span class="p">,</span>
</span><span class='line'>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
</span><span class='line'><span class="p">):</span>
</span><span class='line'>    <span class="c"># Validate user permissions</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_user_edit_project</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">page_data</span><span class="o">.</span><span class="n">project_id</span><span class="p">):</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s">&quot;Unauthorized&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Apply business rules</span>
</span><span class='line'>    <span class="n">page</span> <span class="o">=</span> <span class="n">await</span> <span class="n">create_page_with_defaults</span><span class="p">(</span><span class="n">page_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Return appropriate response</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Page created successfully&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>å‰ç«¯èŒè´£</strong>ï¼ˆAngularï¼‰ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// âœ… Good: Frontend handles user interaction</span>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;app-page-editor&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;./page-editor.component.html&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageEditorComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">components</span><span class="o">:</span> <span class="nx">Component</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Handle user interactions</span>
</span><span class='line'>  <span class="nx">onComponentDrop</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">Position</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">addComponent</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">next</span><span class="o">:</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateComponents</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">error</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">complete</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>æ¶æ„æ¨¡å¼ï¼šä¼Ÿå¤§ç³»ç»Ÿçš„åŸºçŸ³</h2>

<h2>æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨ (MVC)ï¼šç»å…¸æ¨¡å¼</h2>

<p>MVC å°±åƒç»„ç»‡ä¸€åœºæˆå‰§æ¼”å‡ºï¼š</p>

<ul>
<li><strong>æ¨¡å‹</strong>ï¼šå‰§æœ¬å’Œæ•…äº‹ï¼ˆæ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼‰</li>
<li><strong>è§†å›¾</strong>ï¼šèˆå°å’Œæ¼”å‘˜ï¼ˆç”¨æˆ·ç•Œé¢ï¼‰</li>
<li><strong>æ§åˆ¶å™¨</strong>ï¼šå¯¼æ¼”ï¼ˆæ¨¡å‹å’Œï¼ˆæŸ¥çœ‹ï¼‰</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># Model: Page data and operations</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span> <span class="nx">import</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">Integer</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">JSON</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">declarative</span> <span class="nx">import</span> <span class="nx">declarative_base</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span><span class="k">class</span> <span class="nc">PageModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;pages&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">components</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
</span><span class='line'>        <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="o">//</span> <span class="nv">View: </span><span class="nx">Page</span> <span class="nx">rendering</span> <span class="p">(</span><span class="nx">Angular</span> <span class="nx">Component</span><span class="p">)</span>
</span><span class='line'><span class="nx">@Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nv">selector: </span><span class="s">&#39;app-page-view&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">template: </span><span class="o">`</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;page&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span>
</span><span class='line'>        <span class="o">*</span><span class="nx">ngFor</span><span class="o">=</span><span class="s">&quot;let component of pageModel.components&quot;</span>
</span><span class='line'>        <span class="p">[</span><span class="nx">componentData</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;component&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;/</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="nx">export</span> <span class="k">class</span> <span class="nx">PageViewComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">@Input</span><span class="p">()</span> <span class="nv">pageModel: </span><span class="nx">PageModel</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Controller: Coordination logic (Angular Service)</span>
</span><span class='line'><span class="err">@</span><span class="nx">Injectable</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">providedIn</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageController</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">async</span> <span class="nx">updateTitle</span><span class="p">(</span><span class="nx">pageId</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">newTitle</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">updatedPage</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">updatePage</span><span class="p">(</span><span class="nx">pageId</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
</span><span class='line'>    <span class="c1">// Emit event to refresh view</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">pageUpdated</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">updatedPage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>äº‹ä»¶é©±åŠ¨æ¶æ„ï¼šç¥ç»ç³»ç»Ÿ</h2>

<p>äº‹ä»¶é©±åŠ¨æ¶æ„å°±åƒäººç±»çš„ç¥ç»ç³»ç»Ÿâ€”â€”å½“æŸä¸ªéƒ¨åˆ†å‘ç”Ÿäº‹ä»¶æ—¶ï¼Œå…¶ä»–éƒ¨åˆ†ä¼šè‡ªåŠ¨åšå‡ºååº”ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Event system for page builder</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">asyncio</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">EventBus</span><span class="p">:</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">async</span> <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span class='line'>        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="p">[])</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">])</span><span class="c"># Usage</span>
</span><span class='line'><span class="n">event_bus</span> <span class="o">=</span> <span class="n">EventBus</span><span class="p">()</span><span class="c"># Auto-save feature</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">auto_save_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">auto_save</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">show_save_indicator</span><span class="p">()</span><span class="c"># Analytics tracking</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">analytics_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">analytics</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&#39;Component Added&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;component_type&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;component&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;page_id&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>å¾®æœåŠ¡ï¼šä¸“ä¸šå›¢é˜Ÿ</h2>

<p>å¾®æœåŠ¡å°±åƒä¸€ä¸ªçˆµå£«ä¹å›¢â€”â€”æ¯ä¸ªéŸ³ä¹å®¶ï¼ˆæœåŠ¡ï¼‰éƒ½æ˜¯å„è‡ªä¹å™¨çš„ä¸“å®¶ï¼Œä½†ä»–ä»¬å…±åŒåŠªåŠ›ï¼Œåˆ›é€ å‡ºç¾å¦™çš„éŸ³ä¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Docker Compose for Page Builder Microservices</span>
</span><span class='line'>version: <span class="s1">&#39;3.8&#39;</span>
</span><span class='line'>services:
</span><span class='line'>  user-service:
</span><span class='line'>    image: pagebuilder/user-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://users_db
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8001:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      project-service:
</span><span class='line'>    image: pagebuilder/project-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://projects_db
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8002:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      rendering-service:
</span><span class='line'>    image: pagebuilder/rendering-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>      - <span class="nv">S3_BUCKET</span><span class="o">=</span>pagebuilder-assets
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8003:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      frontend:
</span><span class='line'>    image: pagebuilder/angular-frontend
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;4200:80&quot;</span>
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">API_GATEWAY_URL</span><span class="o">=</span>http://api-gateway:8080
</span><span class='line'>
</span><span class='line'>      api-gateway:
</span><span class='line'>    image: pagebuilder/api-gateway:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">USER_SERVICE_URL</span><span class="o">=</span>http://user-service:8000
</span><span class='line'>      - <span class="nv">PROJECT_SERVICE_URL</span><span class="o">=</span>http://project-service:8000
</span><span class='line'>      - <span class="nv">RENDERING_SERVICE_URL</span><span class="o">=</span>http://rendering-service:8000
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8080:8000&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä½•æ—¶ä½¿ç”¨æ¯ç§æ¨¡å¼</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Kx0t7cKSgdtO0Q1PpRiLXg.jpeg" alt="è¿™æ˜¯æˆ‘åœ¨ä¸€æ¬¡æ¶æ„è¯„å®¡ä¼šä¸Šç”»çš„è‰å›¾ï¼Œå½“æ—¶å›¢é˜Ÿå°±å„ç§æ¨¡å¼äº‰è®ºäº†ä¸¤ä¸ªå°æ—¶ã€‚è¿™å¼ å›¾åœ¨5åˆ†é’Ÿå†…å°±ç»“æŸäº†è¿™åœºäº‰è®ºâ€”â€”æ¯ä¸ªäººéƒ½æ¸…æ¥šåœ°çœ‹åˆ°äº†ä»–ä»¬çš„é¡¹ç›®ä¸ä¸€ä¸ªæ¨¡å¼çš„å¯¹åº”å…³ç³»ã€‚ç°åœ¨ï¼Œæˆ‘æŠŠè¿™å¼ ç…§ç‰‡ä¿å­˜åœ¨æ‰‹æœºé‡Œï¼Œæ¯æ¬¡æ¶æ„è®¨è®ºæ—¶éƒ½ä¼šæ‹¿å‡ºæ¥ç”¨ã€‚" /></p>

<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ MVC</strong>ï¼š</p>

<ul>
<li>æ„å»ºä¼ ç»Ÿ Web åº”ç”¨ç¨‹åº</li>
<li>å›¢é˜Ÿç†Ÿæ‚‰è¯¥æ¨¡å¼</li>
<li>éœ€è¦æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»</li>
</ul>


<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨äº‹ä»¶é©±åŠ¨</strong>ï¼š</p>

<ul>
<li>å®æ—¶åŠŸèƒ½å¾ˆé‡è¦</li>
<li>éœ€è¦å¤šä¸ªç³»ç»Ÿå“åº”å˜åŒ–</li>
<li>éœ€è¦æ¾æ•£è€¦åˆ</li>
</ul>


<p><strong>åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨å¾®æœåŠ¡</strong>ï¼š</p>

<ul>
<li>å›¢é˜Ÿè§„æ¨¡ > 10 åå¼€å‘äººå‘˜</li>
<li>ä¸åŒéƒ¨åˆ†çš„æ‰©å±•èƒ½åŠ›ä¸åŒ</li>
<li>ç‹¬ç«‹éƒ¨ç½²è‡³å…³é‡è¦</li>
</ul>


<p>æ­£å¦‚ Martin Fowler æ‰€è¨€ï¼šâ€œå‚»ç“œä¹Ÿèƒ½å†™å‡ºè®¡ç®—æœºèƒ½ç†è§£çš„ä»£ç ã€‚ä¼˜ç§€çš„ç¨‹åºå‘˜å†™å‡ºäººç±»èƒ½ç†è§£çš„ä»£ç ã€‚â€</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ¶æ„æ¨¡å¼æ¯”è¾ƒ</h2>

<p><strong>åˆ›å»ºä½ çš„ä¸ªäººæ¶æ„æ¨¡å¼é€ŸæŸ¥è¡¨ï¼š</strong></p>

<ol>
<li>åœ¨ä½ çš„çº¸ä¸Š<strong>ç”»å‡ºä¸‰ä¸ªéƒ¨åˆ†</strong>ï¼šâ€œMVCâ€ã€â€œäº‹ä»¶é©±åŠ¨â€ã€â€œå¾®æœåŠ¡â€</li>
<li><p><strong>å¯¹äº MVCï¼š</strong>ç”»å‡ºä¸‰ä¸ªç›¸è¿çš„æ–¹æ¡†ï¼ˆæ¨¡å‹ â†” æ§åˆ¶å™¨ â†” è§†å›¾ï¼‰</p></li>
<li><p>åœ¨ä¸‹é¢å†™ä¸Šï¼šâ€œé€‚åˆï¼šä¼ ç»Ÿåº”ç”¨ï¼Œæ¸…æ™°çš„åˆ†ç¦»â€</p></li>
</ol>


<p><strong>3.å¯¹äºäº‹ä»¶é©±åŠ¨ï¼š</strong> ç”»ä¸€ä¸ªä¸­å¿ƒåœ†åœˆï¼Œæ ‡è®°ä¸ºâ€œäº‹ä»¶æ€»çº¿â€ï¼Œå¹¶ç”¨ç®­å¤´å‘å¤–è¾å°„åˆ°å¤šä¸ªæ–¹æ¡†ã€‚</p>

<ol>
<li>åœ¨ä¸‹é¢å†™ï¼šâ€œé€‚ç”¨äºï¼šå®æ—¶åŠŸèƒ½ï¼Œæ¾è€¦åˆâ€</li>
</ol>


<p><strong>5. å¯¹äºå¾®æœåŠ¡ï¼š</strong> ç”» 6-8 ä¸ªç‹¬ç«‹çš„å°æ–¹æ¡†ï¼Œå¹¶ç”¨è™šçº¿è¿æ¥å®ƒä»¬ã€‚</p>

<ul>
<li>åœ¨ä¸‹é¢å†™ï¼šâ€œé€‚ç”¨äºï¼šå¤§å‹å›¢é˜Ÿï¼Œç‹¬ç«‹æ‰©å±•â€</li>
</ul>


<p><strong>6. æ·»åŠ å†³ç­–æ ‘ï¼š</strong> ä»é—®é¢˜åˆ°æ¨¡å¼ç”»ç®­å¤´ï¼š</p>

<ul>
<li>â€œå›¢é˜Ÿå°‘äº 5 äººï¼Ÿâ€ â†’ MVC</li>
<li>â€œéœ€è¦å®æ—¶åŠŸèƒ½å—ï¼Ÿâ€ â†’ äº‹ä»¶é©±åŠ¨</li>
<li>â€œå¤šä¸ªå›¢é˜Ÿï¼Ÿâ€ â†’ å¾®æœåŠ¡</li>
</ul>


<p><strong> å°†æ­¤å›¾æ”¾åœ¨æ‰‹è¾¹ï¼</strong> è¿™æ˜¯ä½ æœªæ¥ä»»ä½•é¡¹ç›®çš„æ¶æ„å†³ç­–æµç¨‹å›¾ã€‚</p>

<h2>ç»˜åˆ¶çœŸæ­£æœ‰ç”¨çš„ç³»ç»Ÿå›¾</h2>

<h2>è§†è§‰ä¼ è¾¾çš„è‰ºæœ¯</h2>

<blockquote><p>â€œä¸€å›¾èƒœåƒè¨€ï¼Œä½†ä¸€å¼ å¥½çš„å›¾è¡¨èƒœè¿‡åƒæ¬¡ä¼šè®®ã€‚â€ â€” æœªçŸ¥</p></blockquote>

<p>ç³»ç»Ÿå›¾æ˜¯è½¯ä»¶æ¶æ„çš„è“å›¾ã€‚å®ƒä»¬åº”è¯¥è®²è¿°ä¸€ä¸ªæ•…äº‹ï¼Œè€Œä¸æ˜¯åˆ¶é€ æ··ä¹±ã€‚</p>

<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šå›¾è¡¨å±‚æ¬¡ç»“æ„</h2>

<p><strong>ç»ƒä¹ ä¸‰å±‚ç³»ç»Ÿå›¾ç»˜åˆ¶æ–¹æ³•ï¼š</strong></p>

<p><strong>ç¬¬ä¸€å±‚ - ä¸Šä¸‹æ–‡ï¼ˆ30 ç§’ç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>ç»˜åˆ¶ä¸‰ä¸ªå½¢çŠ¶</strong>ï¼šåœ†å½¢ï¼ˆç”¨æˆ·ï¼‰ã€çŸ©å½¢ï¼ˆä½ çš„ç³»ç»Ÿï¼‰ã€äº‘ï¼ˆå¤–éƒ¨æœåŠ¡ï¼‰</li>
<li><strong>ç”¨å¸¦æ ‡ç­¾çš„ç®­å¤´è¿æ¥</strong>ï¼šâ€œHTTP è¯·æ±‚â€ã€â€œAPI è°ƒç”¨â€ã€â€œæ•°æ®åŒæ­¥â€</li>
<li><strong>è¿™å›ç­”äº†</strong>â€œæˆ‘ä»¬çš„ç³»ç»Ÿè¿æ¥åˆ°ä»€ä¹ˆï¼Ÿâ€</li>
</ol>


<p><strong>ç¬¬äºŒå±‚ - å®¹å™¨ï¼ˆ2 åˆ†é’Ÿç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>å°†ç³»ç»ŸçŸ©å½¢åˆ†æˆå››ä¸ªéƒ¨åˆ†</strong>ï¼šå‰ç«¯ã€API ç½‘å…³ã€æœåŠ¡ã€æ•°æ®åº“</li>
<li><strong>ç”¨ç®­å¤´</strong>æ˜¾ç¤ºå®ƒä»¬ä¹‹é—´çš„æ•°æ®æµ**</li>
<li><strong>è¿™å›ç­”äº†</strong>â€œä¸»è¦éƒ¨åˆ†æ˜¯ä»€ä¹ˆï¼Ÿâ€</li>
</ol>


<p><strong>ç¬¬ä¸‰çº§â€”â€”ç»„ä»¶ï¼ˆ5 åˆ†é’Ÿç»˜åˆ¶ï¼‰ï¼š</strong></p>

<ol>
<li><strong>é€‰æ‹©ä¸€ä¸ªå®¹å™¨ï¼ˆä¾‹å¦‚å‰ç«¯ï¼‰å¹¶å°†å…¶åˆ†è§£</strong>ä¸ºæ¨¡å—</li>
<li><strong>å±•ç¤ºæ¨¡å—å¦‚ä½•åœ¨è¯¥å®¹å™¨å†…äº¤äº’</strong></li>
<li><strong>è¿™å°†å›ç­”</strong>â€œè¿™ä¸ªç»„ä»¶å†…éƒ¨æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿâ€</li>
</ol>


<p><strong>æœ¬ç»ƒä¹ çš„å¼ºå¤§ä¹‹å¤„ï¼š</strong>åªéœ€é€‰æ‹©è¦ç»˜åˆ¶çš„å›¾çº¸ï¼Œå³å¯åœ¨ä»»ä½•ç»†èŠ‚å±‚é¢è§£é‡Šä»»ä½•ç³»ç»Ÿï¼</p>

<h2>å›¾è¡¨çš„å±‚æ¬¡ç»“æ„</h2>

<p><strong>ä¸Šä¸‹æ–‡å›¾</strong>ï¼š30,000 è‹±å°ºçš„è§†è§’</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Users]</span> --&gt; <span class="cm">[Page Builder System]</span> --&gt; <span class="cm">[CDN]</span>
</span><span class='line'>           |
</span><span class='line'>           v
</span><span class='line'>      <span class="cm">[Database]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>å®¹å™¨å›¾</strong>ï¼šæ„å»ºæ¨¡å—</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Web Browser]</span> --&gt; <span class="cm">[Load Balancer]</span> --&gt; <span class="cm">[Web Application]</span>
</span><span class='line'>                                         |
</span><span class='line'>                                         v
</span><span class='line'><span class="cm">[File Storage]</span> &lt;-- <span class="cm">[API Gateway]</span> &lt;-- <span class="cm">[Cache Layer]</span>
</span><span class='line'>                        |
</span><span class='line'>                        v
</span><span class='line'>                   <span class="cm">[Database Cluster]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>ç»„ä»¶å›¾</strong>ï¼šå†…éƒ¨ç»“æ„</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='mathematica'><span class='line'><span class="n">Web</span><span class="w"> </span><span class="n">Application</span><span class="err">:</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Project</span><span class="w"> </span><span class="n">Management</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Page</span><span class="w"> </span><span class="n">Editor</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Canvas</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Toolbar</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Properties</span><span class="w"> </span><span class="n">Panel</span><span class="w"></span>
</span><span class='line'><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="n">Library</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">â””â”€â”€</span><span class="w"> </span><span class="n">Export</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>æœ‰æ•ˆçš„å›¾è¡¨ç»˜åˆ¶åŸåˆ™</h2>

<ol>
<li><strong>ä»ç”¨æˆ·æ—…ç¨‹å¼€å§‹</strong>ï¼šæ¯ä¸ªå›¾è¡¨éƒ½åº”è¯¥å›ç­”â€œæ•°æ®å¦‚ä½•ä»ç”¨æˆ·æ“ä½œæµå‘ç»“æœï¼Ÿâ€</li>
<li><strong>ä½¿ç”¨ä¸€è‡´çš„ç¬¦å·</strong>ï¼šçŸ©å½¢è¡¨ç¤ºè¿›ç¨‹ï¼Œåœ†æŸ±ä½“è¡¨ç¤ºæ•°æ®å­˜å‚¨ï¼Œåœ†å½¢è¡¨ç¤ºå¤–éƒ¨å®ä½“</li>
<li><strong>æ¸…æ™°åœ°æ˜¾ç¤ºå…³ç³»</strong>ï¼šç®­å¤´åº”æŒ‡ç¤ºæ•°æ®æµæ–¹å‘å¹¶è¿›è¡Œæ ‡è®°</li>
<li><strong>åˆ†å±‚å›¾è¡¨</strong>ï¼šä»é«˜å±‚å¼€å§‹ï¼Œç„¶åæ”¾å¤§åˆ°ç‰¹å®šåŒºåŸŸ</li>
<li><strong>åŒ…å«ä¸æ„‰å¿«çš„è·¯å¾„</strong>ï¼šæ˜¾ç¤ºé”™è¯¯å¤„ç†å’Œæ•…éšœåœºæ™¯</li>
</ol>


<h2>æ•´åˆï¼šå¯è§†åŒ–é¡µé¢æ„å»ºå™¨æ¡ˆä¾‹ç ”ç©¶</h2>

<p>è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„å¯è§†åŒ–é¡µé¢æ„å»ºå™¨è®¾è®¡ä¸€ä¸ªå®Œæ•´çš„ç³»ç»Ÿæ¶æ„ï¼š</p>

<h2>é«˜å±‚æ¶æ„</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coq'><span class='line'><span class="nc">Frontend</span> <span class="o">(</span><span class="nc">Angular</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Editor</span> <span class="nc">Canvas</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Component</span> <span class="nc">Library</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nc">Project</span> <span class="nc">Dashboard</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nc">Shared</span> <span class="nc">Services</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nt">API</span> <span class="nt">Gateway</span> <span class="o">(</span><span class="nt">Python</span><span class="o">/</span><span class="nt">FastAPI</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Authentication</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Project</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Component</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">Rendering</span> <span class="nt">ServiceData</span> <span class="nt">Layer</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">PostgreSQL</span> <span class="o">(</span><span class="nt">structured</span> <span class="nt">data</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Redis</span> <span class="o">(</span><span class="nt">caching</span><span class="o">)</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">S3</span> <span class="o">(</span><span class="nt">file</span> <span class="nt">storage</span><span class="o">)</span><span class="nt">Infrastructure</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">CDN</span> <span class="o">(</span><span class="nt">CloudFront</span><span class="o">)</span>
</span><span class='line'><span class="err">â”œâ”€â”€</span> <span class="nt">Load</span> <span class="nt">Balancer</span>
</span><span class='line'><span class="err">â””â”€â”€</span> <span class="nt">Auto-scaling</span> <span class="nt">Groups</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç»„ä»¶æ·»åŠ çš„æ•°æ®æµ</h2>

<ol>
<li><strong>ç”¨æˆ·æ“ä½œ</strong>ï¼šå°†ç»„ä»¶ä»åº“æ‹–åˆ°ç”»å¸ƒ</li>
<li><strong>å‰ç«¯</strong>ï¼šéªŒè¯ä½ç½®ï¼Œå‘é€ API è¯·æ±‚</li>
<li><strong>API ç½‘å…³</strong>ï¼šéªŒè¯è¯·æ±‚ï¼Œè·¯ç”±åˆ°ç»„ä»¶æœåŠ¡</li>
<li><strong>ç»„ä»¶æœåŠ¡</strong>ï¼šéªŒè¯ä¸šåŠ¡è§„åˆ™ï¼Œæ›´æ–°æ•°æ®åº“</li>
<li><strong>äº‹ä»¶æ€»çº¿</strong>ï¼šå‘å‡ºâ€œcomponent_addedâ€äº‹ä»¶</li>
<li><strong>æ¸²æŸ“æœåŠ¡</strong>ï¼šç”Ÿæˆæ›´æ–°åçš„é¡µé¢é¢„è§ˆ</li>
<li><strong>WebSocket</strong>ï¼šé€šçŸ¥å…¶ä»–åä½œè€…</li>
<li><strong>å‰ç«¯</strong>ï¼šä½¿ç”¨æ–°ç»„ä»¶æ›´æ–° UI</li>
</ol>


<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šæ•°æ®æµæ˜ å°„</h2>

<p><strong>å°†è¿™ä¸ªæŠ½è±¡çš„æµç¨‹è½¬åŒ–ä¸ºä¸€ä¸ªå¯è§†åŒ–çš„æ•…äº‹ï¼š</strong></p>

<ol>
<li><strong>åœ¨ä¸€ä¸ªæµç¨‹ä¸­ç”»å‡º 8 ä¸ªæ–¹æ¡†</strong>ï¼ˆæ¯ä¸ªæ–¹æ¡†å¯¹åº”ä¸Šé¢çš„æ¯ä¸ªæ­¥éª¤ï¼‰</li>
<li><strong>ç”¨ç®­å¤´è¿æ¥å®ƒä»¬</strong>ä»¥æ˜¾ç¤ºé¡ºåº</li>
<li><strong>åœ¨æ¯ä¸ªæ–¹æ¡†ä¸Šæ–¹å†™å‡ºæ‰€éœ€æ—¶é—´</strong>ï¼šâ€œ50 æ¯«ç§’â€ã€â€œ200 æ¯«ç§’â€ã€â€œ100 æ¯«ç§’â€ç­‰ã€‚</li>
<li><strong>åœ¨æ¯ä¸ªæ–¹æ¡†ä¸‹æ–¹ï¼Œæ³¨æ˜å¯èƒ½å‡ºç°çš„é—®é¢˜</strong>ï¼šâ€œç½‘ç»œè¶…æ—¶â€ã€â€œèº«ä»½éªŒè¯å¤±è´¥â€ã€â€œæ•°æ®åº“å®•æœºâ€</li>
<li><p><strong>ç°åœ¨ç”»å‡ºç¬¬äºŒä¸ªç‰ˆæœ¬</strong>ï¼Œå±•ç¤ºæ­¥éª¤ 4 å¤±è´¥æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p></li>
<li><p>ç”¨çº¢è‰²è™šçº¿ç”»ä¸€æ¡â€œæ‚²ä¼¤çš„è·¯å¾„â€ç®­å¤´</p></li>
<li>æ˜¾ç¤ºè¿”å›ç»™ç”¨æˆ·çš„é”™è¯¯æ¶ˆæ¯</li>
<li>æ·»åŠ é‡è¯•é€»è¾‘å’Œå›é€€é€‰é¡¹</li>
</ol>


<p><strong>æœ¬ç»ƒä¹ å°†æ•™ä¼šä½ ï¼š</strong>æ¯ä¸ªç”¨æˆ·æ“ä½œå®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿç¼–æ’ã€‚ç»˜åˆ¶ç®­å¤´å¯ä»¥å¸®åŠ©ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‘ç”Ÿæ½œåœ¨æ•…éšœä¹‹å‰å‘ç°å®ƒä»¬ï¼</p>

<p><strong>é¢å¤–æç¤ºï¼š</strong> ä¸ºç®­å¤´æ·»åŠ é¢œè‰²ä»£ç â€”â€”ç»¿è‰²ä»£è¡¨æ­£å¸¸è·¯å¾„ï¼Œçº¢è‰²ä»£è¡¨é”™è¯¯ï¼Œè“è‰²ä»£è¡¨é‡è¯•ã€‚</p>

<h2>å¯æ‰©å±•æ€§è€ƒè™‘å› ç´ </h2>

<p><strong>æµé‡æ¨¡å¼</strong>ï¼š</p>

<ul>
<li>é«˜è¯»å–æ“ä½œï¼ˆæµè§ˆé¡µé¢ï¼‰</li>
<li>çªå‘å†™å…¥æ“ä½œï¼ˆç¼–è¾‘ä¼šè¯ï¼‰</li>
<li>å¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆå›¾ç‰‡ã€èµ„æºï¼‰</li>
</ul>


<p><strong>æ‰©å±•ç­–ç•¥</strong>ï¼š</p>

<ul>
<li>å°†æ¸²æŸ“åçš„é¡µé¢ç¼“å­˜åœ¨ CDN ä¸­</li>
<li>ä½¿ç”¨åªè¯»å‰¯æœ¬è¿›è¡Œé¡µé¢æµè§ˆ</li>
<li>å°†å¤§æ–‡ä»¶å¤„ç†æ’é˜Ÿ</li>
<li>å®ç° WebSocket è¿æ¥æ± </li>
</ul>


<h2>è¦ç‚¹ï¼šé€‚ç”¨äºä»»ä½• Web åº”ç”¨ç¨‹åºçš„åŸåˆ™</h2>

<h2>ç³»ç»Ÿè®¾è®¡çš„é»„é‡‘æ³•åˆ™</h2>

<ol>
<li><strong>ä»ç®€å•å¼€å§‹ï¼Œè§„åˆ’å¤æ‚</strong>ï¼šä»å•ä½“åº”ç”¨å¼€å§‹ï¼Œä½†è¦é’ˆå¯¹å¾®æœåŠ¡è¿›è¡Œè®¾è®¡</li>
<li><strong>å¿«é€Ÿå¤±è´¥ï¼Œå¿«é€Ÿå­¦ä¹ </strong>ï¼šä»ç¬¬ä¸€å¤©å¼€å§‹æ„å»ºç›‘æ§å’ŒæŠ¥è­¦åŠŸèƒ½</li>
<li><strong>æ•°æ®ä¸ºç‹</strong>ï¼šå…ˆè®¾è®¡æ•°æ®æ¨¡å‹ï¼Œå…¶ä»–ä¸€åˆ‡éƒ½æ°´åˆ°æ¸ æˆ</li>
<li><strong>å®‰å…¨æ€§ä¸å¯æˆ–ç¼º</strong>ï¼šåœ¨æ¯ä¸€å±‚éƒ½æ„å»ºèº«ä»½éªŒè¯å’Œæˆæƒæœºåˆ¶</li>
<li><strong>æ€§èƒ½æ˜¯å…³é”®ç‰¹æ€§</strong>ï¼šç”¨æˆ·æ›´å®¹æ˜“æ³¨æ„åˆ°åº”ç”¨ç¨‹åºè¿è¡Œç¼“æ…¢ï¼Œè€Œä¸æ˜¯åŠŸèƒ½ç¼ºå¤±</li>
</ol>


<h2>æ¶æ„æ¸…å•</h2>

<p>åœ¨ç¼–å†™ç¬¬ä¸€è¡Œä»£ç ä¹‹å‰ç¼–å†™ä»£ç æ—¶ï¼Œè¯·é—®è‡ªå·±ï¼š</p>

<ul>
<li>[ ] æ ¸å¿ƒå®ä½“åŠå…¶å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>[ ] è¯¥ç³»ç»Ÿå¦‚ä½•å¤„ç† 10 å€äºå½“å‰æµé‡çš„æƒ…å†µï¼Ÿ</li>
<li>[ ] å•ç‚¹æ•…éšœç‚¹åœ¨å“ªé‡Œï¼Ÿ</li>
<li>[ ] ä¸åŒçš„å›¢é˜Ÿå°†å¦‚ä½•åœ¨è¯¥ç³»ç»Ÿä¸Šåä½œï¼Ÿ</li>
<li>[ ] å‡ºç°é—®é¢˜æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</li>
<li>[ ] æˆ‘ä»¬å°†å¦‚ä½•ç›‘æ§å’Œè°ƒè¯•é—®é¢˜ï¼Ÿ</li>
<li>[ ] å®‰å…¨éšæ‚£æ˜¯ä»€ä¹ˆï¼Ÿ</li>
</ul>


<h2>ğŸ“ äº’åŠ¨ç»ƒä¹ ï¼šä½ çš„ç³»ç»Ÿè®¾è®¡æ¨¡æ¿</h2>

<p><strong>åˆ›å»ºä½ çš„ä¸ªäººç³»ç»Ÿè®¾è®¡æ¨¡æ¿ï¼Œå¯ç”¨äºä»»ä½•é¡¹ç›®ï¼š</strong></p>

<ol>
<li><strong>ç»˜åˆ¶ä¸€ä¸ªåŒ…å«ä»¥ä¸‹éƒ¨åˆ†çš„ç©ºç™½æ¨¡æ¿ï¼š</strong></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”Œâ”€â”€â”€â”€â”€â”€ å®ä½“ä¸å…³ç³» â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€ æµé‡ä¸æ‰©å±• â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
</span><span class='line'>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”Œâ”€ æ•…éšœç‚¹ â”€â”€â”€â”€â”€â”€
</span><span class='line'>â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€ å›¢é˜Ÿè¾¹ç•Œ â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
</span><span class='line'>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p><strong>å¡«å†™æˆ‘ä»¬çš„é¡µé¢æ„å»ºå™¨ç¤ºä¾‹ï¼š</strong></p></li>
<li><p>å®ä½“ï¼šç”¨æˆ·ã€é¡¹ç›®ã€é¡µé¢ã€ç»„ä»¶</p></li>
<li>æµé‡ï¼šæµè§ˆæ—¶è¯»å–é‡å¤§ï¼Œç¼–è¾‘æ—¶å†™å…¥é‡å¤§</li>
<li>æ•…éšœï¼šæ•°æ®åº“å®•æœºã€CDN é€Ÿåº¦æ…¢ã€WebSocket æ–­å¼€è¿æ¥</li>
<li>å›¢é˜Ÿï¼šå‰ç«¯å›¢é˜Ÿã€API å›¢é˜Ÿã€åŸºç¡€è®¾æ–½å›¢é˜Ÿ</li>
</ol>


<p><strong>2. å¤åˆ¶æ­¤æ¨¡æ¿</strong> â€” å°†å…¶ç”¨äºæœªæ¥çš„æ¯ä¸ªé¡¹ç›®</p>

<p><strong>ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼š</strong> æ‹¥æœ‰ä¸€è‡´çš„æ€ç»´æ¡†æ¶å¯ä»¥é˜²æ­¢ä½ å¿˜è®°å…³é”®æ–¹é¢ã€‚ä½ çš„ç»˜å›¾å°†æˆä¸ºä½ çš„ç³»ç»Ÿè®¾è®¡æ¸…å•ï¼</p>

<h2>ä½ çš„ç»˜å›¾ä¹‹æ—…ï¼šä»è‰å›¾åˆ°ç³»ç»Ÿ</h2>

<p>å¦‚æœä½ å®Œæˆäº†æœ¬æ–‡çš„ç»˜å›¾ç»ƒä¹ ï¼Œé‚£ä¹ˆä½ ç°åœ¨æ‹¥æœ‰ï¼š</p>

<ol>
<li><strong>åˆ†å±‚æ¶æ„æ¨¡æ¿</strong>ï¼ˆç”¨äºåˆ†è§£ä»»ä½•å¤æ‚ç³»ç»Ÿï¼‰</li>
<li><strong>åˆ†è§£æ ‘æ–¹æ³•</strong>ï¼ˆç”¨äºç»„ç»‡å¼€å‘å·¥ä½œï¼‰</li>
<li><strong>æ‰©å±•æ¼”è¿›è·¯çº¿å›¾</strong>ï¼ˆç”¨äºè§„åˆ’å‘å±•é˜¶æ®µï¼‰</li>
<li><strong>é¤å…éšå–»å›¾</strong>ï¼ˆç”¨äºè§£é‡Šä¸‰å±‚æ¶æ„ï¼‰</li>
<li><strong>æ¶æ„æ¨¡å¼å¯¹æ¯”å›¾</strong>ï¼ˆç”¨äºé€‰æ‹©æ­£ç¡®çš„æ–¹æ³•ï¼‰</li>
<li><strong>ä¸‰å±‚å›¾è¡¨ç³»ç»Ÿ</strong>ï¼ˆç”¨äºåœ¨ä»»ä½•ç»†èŠ‚å±‚é¢è¿›è¡Œæ²Ÿé€šï¼‰</li>
<li><strong>æ•°æ®æµæ˜ å°„æŠ€æœ¯</strong>ï¼ˆç”¨äºç†è§£ç³»ç»Ÿäº¤äº’ï¼‰</li>
<li><strong>å¯å¤ç”¨ç³»ç»Ÿè®¾è®¡æ¨¡æ¿</strong>ï¼ˆç”¨äºä¸€è‡´çš„é¡¹ç›®è§„åˆ’ï¼‰</li>
</ol>


<p><strong>è¿™äº›æ‰‹ç»˜å›¾è¡¨æ¯”ä»»ä½•æ˜‚è´µçš„å·¥å…·éƒ½æ›´æœ‰ä»·å€¼</strong>ï¼Œå› ä¸ºï¼š</p>

<ul>
<li>é€šè¿‡ç»˜åˆ¶å®ƒä»¬ï¼Œä½ çš„å¤§è„‘å»ºç«‹äº†æ›´æ·±å±‚æ¬¡çš„è”ç³»</li>
<li>ä½ å¯ä»¥éšæ—¶éšåœ°é‡æ–°åˆ›å»ºå®ƒä»¬</li>
<li>å®ƒä»¬æ ¹æ®ä½ å¯¹ç³»ç»Ÿçš„ç†è§£è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶</li>
<li>å®ƒä»¬å¼¥åˆäº†æŠ½è±¡æ¦‚å¿µä¸å®è·µä¹‹é—´çš„å·®è·å®æ–½</li>
</ul>


<p><strong>ä¿ç•™ä½ çš„å›¾çº¸ï¼</strong> æŠŠå®ƒä»¬è´´åœ¨ä½ çš„æ˜¾ç¤ºå™¨ä¸Šï¼Œç”¨æ‰‹æœºæ‹ç…§ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªâ€œç³»ç»Ÿè®¾è®¡é€Ÿå†™æœ¬â€ï¼Œè®©å®ƒéšç€æ¯ä¸ªé¡¹ç›®çš„è¿›å±•è€Œä¸æ–­æ›´æ–°ã€‚</p>

<h2>æ€»ç»“</h2>

<blockquote><p>â€œæ¶æ„å¸ˆèº«å¤„ä¸¤ä¸ªä¸–ç•Œä¹‹é—´ã€‚ä½ å¿…é¡»æ„¿æ„æ‰“ç ´åŸºæœ¬çš„å‡è®¾ã€‚â€â€”â€”å®‰è—¤å¿ é›„</p></blockquote>

<p>ç³»ç»Ÿè®¾è®¡å¹¶éè¦åˆ›é€ å®Œç¾çš„æ¶æ„ï¼Œè€Œæ˜¯è¦åšå‡ºæ˜æ™ºçš„æƒè¡¡ã€‚æ¯ä¸ªå†³ç­–éƒ½æœ‰å…¶åæœï¼Œæ¯ä¸ªæ¨¡å¼éƒ½æœ‰å…¶åˆ©å¼Šï¼Œæ¯ä¸ªè§£å†³æ–¹æ¡ˆéƒ½ä¼šäº§ç”Ÿæ–°çš„é—®é¢˜éœ€è¦è§£å†³ã€‚</p>

<p>æœ€å¥½çš„æ¶æ„å¸ˆå¹¶éç²¾é€šæ‰€æœ‰æ¨¡å¼å’ŒæŠ€æœ¯ï¼Œè€Œæ˜¯èƒ½å¤Ÿå€¾å¬éœ€æ±‚ã€ç†è§£çº¦æŸï¼Œå¹¶è®¾è®¡å‡ºèƒ½å¤Ÿä¸ç”¨æˆ·å’Œç»„ç»‡å’Œè°å…±å­˜çš„ç³»ç»Ÿã€‚</p>

<p>è®°ä½ï¼šä½ ä¸ä»…ä»…æ˜¯åœ¨æ„å»ºè½¯ä»¶ï¼Œä½ è¿˜åœ¨ä¸ºå›¢é˜Ÿæœªæ¥çš„æˆåŠŸå¥ å®šåŸºç¡€ã€‚æ„å»ºå¥½å®ƒï¼Œæ¸…æ™°åœ°è®°å½•å®ƒï¼Œå¹¶å§‹ç»ˆåšå¥½æ¼”è¿›çš„å‡†å¤‡ã€‚</p>

<p>ä¿—è¯è¯´ï¼Œâ€œå‡ å‘¨çš„ç¼–ç æ—¶é—´å¯ä»¥èŠ‚çœæ•°å°æ—¶çš„è§„åˆ’æ—¶é—´ã€‚â€ æŠ•èµ„äºç³»ç»Ÿè®¾è®¡ï¼Œæœªæ¥çš„ä½ ï¼ˆå’Œå›¢é˜Ÿï¼‰ä¼šæ„Ÿè°¢ä½ ã€‚</p>

<p>åƒä¸ªåº”ç”¨ç¨‹åºçš„æ—…ç¨‹å§‹äºä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„ç³»ç»Ÿã€‚ä»Šå¤©å°±å¼€å§‹åƒæ¶æ„å¸ˆä¸€æ ·æ€è€ƒï¼Œè§è¯ä½ çš„åº”ç”¨ç¨‹åºä»è„†å¼±çš„åŸå‹è½¬å˜ä¸ºç»å¾—èµ·æ—¶é—´è€ƒéªŒçš„å¼ºå¤§ã€å¯æ‰©å±•çš„å¹³å°ã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[runBlockingå®è·µï¼šå“ªé‡Œè¯¥ä½¿ç”¨ï¼Œå“ªé‡Œä¸è¯¥ç”¨]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"/>
    <updated>2025-09-23T14:34:01+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒrunBlocking in practice: Where it should be used and where notã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://kt.academy/article/run_blocking">https://kt.academy/article/run_blocking</a>ï¼Œç”±Marcin MoskaÅ‚aå‘å¸ƒäº2025å¹´9æœˆ1æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"><img src="https://kt.academy/_next/image?url=https%3A%2F%2Fmarcinmoskala.com%2Fkt-academy-articles%2Fpromotion%2Frun_blocking.png&w=3840&q=75" title="auto auto" ></a></p>

<!-- more -->


<p>ä¼ ç»Ÿæ„ä¹‰ä¸Šè®²ï¼ŒJava å’Œ Kotlin é¡¹ç›®éƒ½åŸºäºé˜»å¡è°ƒç”¨(blocking)ã€‚æˆ‘æ‰€è¯´çš„é˜»å¡è°ƒç”¨æ˜¯æŒ‡å‡½æ•°åœ¨ç­‰å¾…æŸäº›æ“ä½œï¼ˆä¾‹å¦‚ï¼Œç­‰å¾…ç½‘ç»œå“åº”ï¼‰æ—¶ä¼šé˜»å¡è°ƒç”¨è€…çš„çº¿ç¨‹ã€‚Kotlin åç¨‹æœ€é‡è¦çš„è§„åˆ™ä¹‹ä¸€æ˜¯ï¼Œæˆ‘ä»¬ä¸åº”è¯¥åœ¨æŒ‚èµ·å‡½æ•°(suspending function)ä¸Šè¿›è¡Œé˜»å¡è°ƒç”¨ï¼ˆé™¤éæˆ‘ä»¬ä½¿ç”¨å…è®¸é˜»å¡è°ƒç”¨çš„è°ƒåº¦ç¨‹åºï¼Œä¾‹å¦‚ <code>Dispatchers.IO</code>ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using withContext(Dispatchers.IO) to make a blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">=</span> <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½†æ˜¯å¦‚ä½•åå…¶é“è€Œè¡Œä¹‹å‘¢ï¼Ÿå¦‚ä½•å°†æŒ‚èµ·è°ƒç”¨è½¬æ¢ä¸ºé˜»å¡è°ƒç”¨ï¼Ÿä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>runBlocking</code>ï¼</p>

<h2><a href="#how-runblocking-works"><code>runBlocking</code> çš„å·¥ä½œåŸç†</a></h2>

<p><code>runBlocking</code> åœ¨è°ƒç”¨å®ƒçš„çº¿ç¨‹ä¸Šå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶é˜»å¡è¯¥çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆã€‚å› æ­¤ï¼ŒrunBlocking æœ¬è´¨ä¸Šæ˜¯åŒæ­¥çš„ï¼Œå› ä¸ºå¦‚æœæˆ‘ä»¬å¤šæ¬¡è°ƒç”¨å®ƒï¼Œç¬¬äºŒä¸ªè°ƒç”¨è¦ç­‰åˆ°ç¬¬ä¸€ä¸ªè°ƒç”¨å®Œæˆåæ‰ä¼šå¯åŠ¨ã€‚ä½œä¸ºä¸€ä¸ªåŒæ­¥åç¨‹æ„å»ºå™¨ï¼Œ<code>runBlocking</code> è¿”å›å®ƒå¯åŠ¨çš„åç¨‹çš„ç»“æœã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting main&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Finishing first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">result</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting second runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;ABCD&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Second runBlocking finished with result: $result&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;[${Thread.currentThread().name}] $message&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// [main] Starting main</span>
</span><span class='line'><span class="c1">// [main] Starting first runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Finishing first runBlocking</span>
</span><span class='line'><span class="c1">// [main] Starting second runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Second runBlocking finished with result: ABCD</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç”±äº <code>runBlocking</code> å¯åŠ¨äº†ä¸€ä¸ªä½œç”¨åŸŸï¼Œå®ƒä¼šç­‰å¾…å…¶ä¸­å¯åŠ¨çš„æ‰€æœ‰åç¨‹å®Œæˆã€‚è¿™æ„å‘³ç€å®ƒä¼šç­‰å¾…æ‰€æœ‰å­åç¨‹å®Œæˆã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸‹é¢çš„ç¨‹åºè¦ç­‰åˆ°æ‰€æœ‰ä¸‰ä¸ªå¼‚æ­¥åç¨‹éƒ½å®Œæˆæ‰ä¼šå®Œæˆã€‚ä¸ºäº†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ <code>runBlocking</code> å®šä¹‰ç»“æœï¼Œæˆ‘è¿˜è®©è¿™ä¸ªç¨‹åºä» <code>main</code> å‡½æ•°è¿”å› <code>0</code>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="m">0</span> <span class="c1">// result from main</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">delayAndPrintHello</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">1000L</span><span class="p">)</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;World!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// Hello</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> çš„è¡Œä¸ºå¯èƒ½ä¼šè®©ä½ æƒ³èµ· <code>coroutineScope</code>ï¼Œè¿™å¹¶éå·§åˆï¼Œå› ä¸ºå®ƒä»¬éƒ½å¯åŠ¨åŒæ­¥åç¨‹ï¼Œä½† <code>runBlocking</code> æ˜¯é˜»å¡çš„ï¼Œè€Œ <code>coroutineScope</code> æ˜¯æš‚åœçš„ã€‚è¿™æ„å‘³ç€å®Œå…¨ä¸åŒçš„ç”¨æ³•ï¼Œæˆ‘ä»¬åªåœ¨æš‚åœå‡½æ•°ä¸­ä½¿ç”¨ <code>coroutineScope</code>ï¼Œè€Œæˆ‘ä»¬æ°¸è¿œä¸åº”è¯¥åœ¨æš‚åœå‡½æ•°ä¸­ä½¿ç”¨ <code>runBlocking</code>ã€‚è¿™ä¹Ÿæ„å‘³ç€ <code>coroutineScope</code> ä¸å…¶è°ƒç”¨è€…å»ºç«‹å…³ç³»ï¼Œå¹¶ä¸”å§‹ç»ˆå¤„äºåç¨‹å±‚æ¬¡ç»“æ„çš„ä¸­é—´ï¼Œè€Œ <code>runBlocking</code> åˆ™å¯åŠ¨ä¸€ä¸ªæ–°çš„åç¨‹å±‚æ¬¡ç»“æ„ã€‚</p>

<h2><a href="#the-practice-of-using-runblocking">ä½¿ç”¨ <code>runBlocking</code> çš„å®è·µ</a></h2>

<p>åœ¨æ­£ç¡®å®ç°çš„åŸºäºåç¨‹çš„é¡¹ç›®ä¸­ï¼Œå¹¶ä½¿ç”¨è®¾è®¡è‰¯å¥½çš„åç¨‹å‹å¥½åº“ï¼Œæˆ‘ä»¬å‡ ä¹ä¸éœ€è¦ä½¿ç”¨ <code>runBlocking</code>ã€‚å¦‚æœæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ç»å¸¸ä½¿ç”¨å®ƒï¼Œé‚£å°±è¢«è®¤ä¸ºæ˜¯ä»£ç å¼‚å‘³ã€‚ç„¶è€Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒrunBlocking æ˜¯æœ‰ç”¨çš„ï¼Œç”šè‡³æ˜¯å¿…è¦çš„ã€‚ä¹Ÿæœ‰ä¸€äº›æƒ…å†µä¸‹ï¼ŒrunBlocking ä¸åº”è¯¥è¢«ä½¿ç”¨ã€‚æˆ‘ä»¬è¿˜ä¼šè®¨è®ºé‚£äº›æ›¾ç»éœ€è¦ runBlocking ä½†ç°åœ¨æœ‰äº†æ›´å¥½çš„æ›¿ä»£æ–¹æ¡ˆçš„æƒ…å†µã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚</p>

<h2><a href="#where-to-use-runblocking">åœ¨å“ªé‡Œä½¿ç”¨ <code>runBlocking</code></a></h2>

<p><code>runBlocking</code> åº”è¯¥ç”¨äºéœ€è¦å¯åŠ¨åç¨‹å¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å…¶å®Œæˆçš„æƒ…å†µã€‚è¿™æ„å‘³ç€å®ƒå¯ä»¥åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ï¼š</p>

<ul>
<li>æˆ‘ä»¬éœ€è¦ç­‰å¾…åç¨‹çš„ç»“æœã€‚</li>
<li>æˆ‘ä»¬å¯ä»¥é˜»å¡å½“å‰çº¿ç¨‹ã€‚</li>
</ul>


<p>ä¸€ä¸ªå¸¸è§çš„ Android ç¤ºä¾‹æ˜¯åœ¨ Retrofit å®¢æˆ·ç«¯ä¸­è®¾ç½®ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œå°†ä»¤ç‰Œé™„åŠ åˆ°ç½‘ç»œè°ƒç”¨ã€‚è·å–ä»¤ç‰Œå¯èƒ½éœ€è¦å‘èµ·ç½‘ç»œè°ƒç”¨ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è·å–ä»¤ç‰Œã€‚åŒæ—¶ï¼Œæ‹¦æˆªå™¨éœ€è¦ç»“æœæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªæ‹¦æˆªå™¨åœ¨ Retrofit çš„æ± ä¸­å¯åŠ¨ï¼Œå› æ­¤å¯ä»¥è°ƒç”¨å®ƒçš„è°ƒç”¨ã€‚è¿™ä½¿å¾—å®ƒæˆä¸ºä½¿ç”¨ <code>runBlocking</code> çš„ç†æƒ³åœºæ‰€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddTokenInterceptor</span><span class="p">:</span> <span class="n">Interceptor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">Interceptor</span><span class="p">.</span><span class="n">Chain</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getToken</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">request</span><span class="p">().</span><span class="n">newBuilder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Bearer $token&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨åç«¯ç³»ç»Ÿä¸Šï¼Œæœ‰æ—¶æˆ‘ä»¬éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ä»¥ç­‰å¾…åç¨‹å®Œæˆï¼Œä¾‹å¦‚ä¸ºäº†è®©æˆ‘ä»¬çš„å·¥å…·æ­£ç¡®æµ‹é‡æ­¤è¿›ç¨‹çš„æ‰§è¡Œæ—¶é—´ï¼Œæˆ–è€…å½“æˆ‘ä»¬éœ€è¦è°ƒç”¨æŸäº›é˜»å¡è„šæœ¬å¹¶è·å–å…¶ç»“æœæ—¶ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@MeasureExecutionTime</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">runDataMigrationScript</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">sourceData</span> <span class="p">=</span> <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">transformedData</span> <span class="p">=</span> <span class="n">transformData</span><span class="p">(</span><span class="n">sourceData</span><span class="p">)</span>
</span><span class='line'>    <span class="n">writeDataToTarget</span><span class="p">(</span><span class="n">transformedData</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™äº›æƒ…å†µå¾ˆå°‘è§ï¼Œå¤§å¤šæ•°åç«¯é¡¹ç›®ä¸éœ€è¦ä½¿ç”¨ <code>runBlocking</code>ã€‚é™¤éå®ƒä»¬æœ‰ä¸€äº›åŸºäºé˜»å¡è°ƒç”¨çš„é—ç•™ä»£ç ã€‚è€ƒè™‘ä»¥ä¸‹ <code>UserService</code>ï¼Œå®ƒåœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ç”¨äºç®¡ç†ç”¨æˆ·ã€‚æˆ‘ä»¬å·²ç»å°†å…¶è¿ç§»åˆ°æš‚åœè°ƒç”¨ï¼Œä½†æˆ‘ä»¬ä»ç„¶æœ‰ä¸€äº›åŸºäºé˜»å¡è°ƒç”¨çš„é—ç•™æ§åˆ¶å™¨å’ŒæœåŠ¡ã€‚ä¸ºäº†é¿å…é‡å†™æ‰€æœ‰è¿™äº›ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæš‚åœå‡½æ•°æä¾›é˜»å¡æ›¿ä»£æ–¹æ¡ˆã€‚è¿™äº›æ›¿ä»£æ–¹æ¡ˆå¯ä»¥é€šè¿‡ä½¿ç”¨ <code>runBlocking</code> åŒ…è£…æš‚åœå‡½æ•°æ¥å®ç°ï¼ˆä½ ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨ä¸€äº›è°ƒåº¦å™¨ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserService</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">userRepository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Blocking alternative for legacy parts of our application</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">findUserByIdBlocking</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™å¯èƒ½æ˜¯ <code>runBlocking</code> æœ€é‡è¦çš„ç”¨é€”ï¼Œå®ƒå……å½“äº†ä»é˜»å¡åˆ°æš‚åœçš„æ¡¥æ¢ã€‚ä¸€äº›åº“ä¸º Java å®šä¹‰äº†é˜»å¡æ›¿ä»£æ–¹æ¡ˆã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">readDataFromSource</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">readDataFromSourceBlocking</span><span class="p">():</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#where-not-to-use-runblocking">å“ªäº›æƒ…å†µä¸‹ä¸åº”ä½¿ç”¨ <code>runBlocking</code></a></h2>

<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸åº”ä½¿ç”¨ <code>runBlocking</code>ã€‚æ­¤å¤–ï¼Œåˆ‡å‹¿åœ¨æŒ‚èµ·å‡½æ•°ä¸­ç›´æ¥ä½¿ç”¨ <code>runBlocking</code>ã€‚<code>runBlocking</code> ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå› æ­¤ä¸åº”åœ¨æŒ‚èµ·å‡½æ•°ä¸­è¿›è¡Œé˜»å¡è°ƒç”¨ï¼ˆé™¤éä½¿ç”¨å…è®¸é˜»å¡è°ƒç”¨çš„è°ƒåº¦ç¨‹åºï¼Œä¾‹å¦‚ <code>Dispatchers.IO</code>ï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆå¯èƒ½ä¸éœ€è¦ <code>runBlocking</code>ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// runBlocking is most likely not needed</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä¸åº”åœ¨ä¸éœ€è¦ç­‰å¾…ç»“æœçš„å‡½æ•°ä¸­ä½¿ç”¨ <code>runBlocking</code>ã€‚å¦‚æœä½ åªéœ€è¦å¯åŠ¨åç¨‹ï¼Œé€šå¸¸æœ€å¥½ä½¿ç”¨ <code>launch</code> å¯åŠ¨å¼‚æ­¥åç¨‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking used where we do not need to await result</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜åº”æ³¨æ„ï¼Œä¸è¦åœ¨ä¸åº”è¢«é˜»å¡çš„çº¿ç¨‹ä¸Šä½¿ç”¨ <code>runBlocking</code>ã€‚è¿™åœ¨ Android ä¸Šå°¤å…¶æˆé—®é¢˜ï¼Œå› ä¸ºé˜»å¡ä¸»çº¿ç¨‹ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå¡æ­»ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking on the main thread</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨åç«¯ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ <code>synchronized</code> å—ä¸­ä½¿ç”¨å®ƒï¼Œå¯èƒ½ä¼šå‡ºç°é—®é¢˜ã€‚ä¸€ä¸ªæŠ€å·§æ˜¯ä½¿ç”¨ <code>launch</code> å®ç°å›è°ƒå‡½æ•°ã€‚ä½†æ˜¯ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæœ€å¥½é‡æ–°è®¾è®¡ä»£ç ï¼Œä½¿ç”¨æš‚åœè€Œä¸æ˜¯é˜»å¡è°ƒç”¨ï¼Œå¹¶ä½¿ç”¨åç¨‹å‹å¥½çš„å·¥å…·ï¼ˆæˆ‘ä»¬å°†åœ¨<em>åŒæ­¥åç¨‹</em>è¯¾ç¨‹ä¸­è®¨è®ºï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Possibly incorrect: runBlocking inside synchronized block</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getUser</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// One solution: use launch to implement a callback</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>        <span class="n">callback</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">getUser</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#outdated-runblocking-uses">è¿‡æ—¶çš„ <code>runBlocking</code> ç”¨æ³•</a></h2>

<p><code>runBlocking</code> ä¼ ç»Ÿä¸Šç”¨äºåŒ…è£… <code>main</code> å‡½æ•°ä½“ã€‚å®ƒçš„å±æ€§éå¸¸é€‚åˆæ­¤ç›®çš„ï¼šå®ƒå¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå› æ­¤å®ƒå¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°æˆ–å¯åŠ¨å…¶ä»–åç¨‹ï¼Œå¹¶ä¸”å®ƒä¼šé˜»å¡çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç¡®ä¿ç¨‹åºä¸ä¼šåœ¨æ‰€æœ‰è¿™äº›è¿›ç¨‹å®Œæˆä¹‹å‰ç»“æŸã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> ä»ç„¶å¯ä»¥ä»¥è¿™ç§æ–¹å¼ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨å¤§å¤šæ•°ç°ä»£æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å–œæ¬¢ä½¿ç”¨ Kotlin 1.3 ä¸­å¼•å…¥çš„æŒ‚èµ· <code>main</code> å‡½æ•°ã€‚æ­¤ç±»å‡½æ•°åœ¨åº•å±‚è¢«ä¸€ä¸ªç±»ä¼¼äº <code>runBlocking</code> çš„é˜»å¡æ„å»ºå™¨åŒ…è£…ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å…³é”®åŒºåˆ«åœ¨äº <code>runBlocking</code> è®¾ç½®äº†ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œä½¿å…¶æ‰€æœ‰å­åç¨‹åœ¨å…¶æ­£åœ¨ä½¿ç”¨çš„åŒä¸€çº¿ç¨‹ä¸Šè¿è¡Œã€‚æŒ‚èµ· main å‡½æ•°ä¸ä¼šè®¾ç½®è°ƒåº¦å™¨ï¼Œå› æ­¤å…¶å­åç¨‹é»˜è®¤åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šè¿è¡Œã€‚å¼•å…¥æ­¤æ›´æ”¹æ˜¯å› ä¸º <code>runBlocking</code> ä½¿ç”¨çš„å•çº¿ç¨‹è°ƒåº¦å™¨ç»å¸¸å¯¼è‡´æ„å¤–è¡Œä¸ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// main</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// DefaultDispatcher-worker-1</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> çš„ç¬¬äºŒä¸ªä¼ ç»Ÿç”¨é€”æ˜¯åœ¨æµ‹è¯•ä¸­ã€‚å®ƒè¢«ç”¨æ¥åŒ…è£…æµ‹è¯•ä¸»ä½“ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥è°ƒç”¨æŒ‚èµ·å‡½æ•°å¹¶åœ¨å…¶ä¸­å¯åŠ¨åç¨‹ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æ›´å€¾å‘äºä½¿ç”¨ <code>kotlinx-coroutines-test</code> åº“ä¸­çš„ <code>runTest</code>ï¼Œå®ƒæ˜¯ <code>runBlocking</code> çš„ä¸€ä¸ªæ›´å¼ºå¤§ã€æ›´çµæ´»çš„æ›¿ä»£æ–¹æ¡ˆã€‚å®ƒå…è®¸æˆ‘ä»¬æ§åˆ¶æ—¶é—´ã€ç”Ÿæˆåå°ä½œç”¨åŸŸå¹¶è·Ÿè¸ªå­åç¨‹ä¸Šçš„å¼‚å¸¸ã€‚<code>runTest</code> å°†åœ¨<em>æµ‹è¯•åç¨‹</em>è¯¾ç¨‹ä¸­è®¨è®ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserRepositoryTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userRepository</span> <span class="p">=</span> <span class="n">InMemoryUserRepository</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userService</span> <span class="p">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">userRepository</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Test</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">testGetUser</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span> <span class="c1">// previously runBlocking</span>
</span><span class='line'>        <span class="c1">// given</span>
</span><span class='line'>        <span class="n">userRepository</span><span class="p">.</span><span class="n">hasUser</span><span class="p">(</span><span class="n">UserEntity</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">,</span> <span class="s">&quot;John Doe&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// when</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userService</span><span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// then</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#%E6%80%BB%E7%BB%93">æ€»ç»“</a></h2>

<ul>
<li><code>runBlocking</code> æ˜¯ä¸€ä¸ªé˜»å¡åç¨‹æ„å»ºå™¨ï¼Œå®ƒå¯åŠ¨ä¸€ä¸ªåç¨‹å¹¶é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°å®ƒå®Œæˆã€‚</li>
<li><code>runBlocking</code> æ˜¯ä»é˜»å¡ä¸–ç•Œ(blocking)åˆ°æŒ‚èµ·ä¸–ç•Œ(suspending)çš„æ¡¥æ¢ï¼Œå®ƒç”¨äºåœ¨éœ€è¦é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°åç¨‹å®Œæˆçš„åœ°æ–¹å¯åŠ¨åç¨‹ã€‚</li>
<li>å¦‚æœä½ éœ€è¦åœ¨é¡¹ç›®ä¸­é¢‘ç¹ä½¿ç”¨ <code>runBlocking</code>ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯ä¸€ç§ä»£ç å¼‚å‘³ã€‚åœ¨è®¾è®¡åˆç†çš„åŸºäºåç¨‹çš„é¡¹ç›®ä¸­ï¼Œåº”è¯¥å°½é‡å°‘ç”¨ï¼Œæˆ–è€…å¹²è„†ä¸ç”¨ã€‚</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android ViewModelæ•°æ®åŠ è½½ï¼šåŸºäºFlowæ¶æ„çš„æœ€ä½³å®è·µ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"/>
    <updated>2025-09-22T14:50:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒAndroid ViewModel Data Loading: Best Practices and Flow-Based Architectureã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://funkymuse.dev/posts/properly-load-data/">https://funkymuse.dev/posts/properly-load-data/</a>ï¼Œç”±FunkyMuseäº2025å¹´8æœˆ29æ—¥ã€‚</p></blockquote>

<p>Android å¼€å‘ä¸­çš„æ¶æ„è®¨è®ºç»å¸¸å¼•å‘æ¿€çƒˆçš„äº‰è®ºâ€”â€”æœ‰æ—¶è¤’è´¬ä¸ä¸€ã€‚æ’°å†™è¿™äº›ä¸»é¢˜çš„æ–‡ç« å¹¶ä¸å®¹æ˜“ï¼Œä½†è¿™æ­£æ˜¯å®ƒçš„ä»·å€¼æ‰€åœ¨ã€‚</p>

<p>æœ¬æ–‡é˜è¿°äº†æˆ‘å¯¹æ•°æ®åŠ è½½æ¨¡å¼çš„ç‹¬åˆ°è§è§£ï¼Œè¿™äº›è§è§£æºäºæˆ‘çš„ç»éªŒä»¥åŠè¿‘æœŸæ‰‹æœ¯åçš„æ¢å¤ï¼ˆå…¶ä¸­ä¸€æ¬¡æ‰‹æœ¯ä»åœ¨è¿›è¡Œä¸­ï¼‰ã€‚</p>

<p>ä¸å¦¨å°†æ­¤è§†ä¸ºæˆ‘åœ¨ 2025 å¹´å¯¹æ•°æ®åŠ è½½æ¨¡å¼çš„ç†è§£å’ŒæŠ€èƒ½çš„æ¦‚è¿°ã€‚</p>

<p>æˆ‘å¯èƒ½æ¯”å…¶ä»–äººæ›´æ™šåŠ å…¥è¿™åœºè®¨è®ºï¼Œä½†è¿Ÿåšæ€»æ¯”ä¸åšå¥½ã€‚</p>

<h2>æŒ‘æˆ˜ï¼šAndroid ViewModel ä¸­å¸¸è§çš„æ•°æ®åŠ è½½åæ¨¡å¼</h2>

<p>â€œå¤§å¤šæ•°â€Android å¼€å‘è€…ä½¿ç”¨ ViewModel æ¥ç®¡ç† UI çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ç”±è§†å›¾ï¼ˆFragmentã€Activity æˆ–å¯ç»„åˆç»„ä»¶ï¼‰æ”¶é›†ã€‚ä¸ºäº†æ˜¾ç¤ºæœ‰æ„ä¹‰çš„å†…å®¹ï¼Œä½ éœ€è¦ä»çœŸå®æ•°æ®æºåŠ è½½æ•°æ®ï¼Œå°†å…¶è½¬æ¢ä¸ºè§†å›¾çŠ¶æ€ï¼Œç„¶åå…¬å¼€ä»¥ä¾›ä½¿ç”¨ã€‚</p>

<p>ä»¥å‰æ˜¯ LiveDataï¼Œç°åœ¨æ˜¯ Flowï¼Œå®ƒå……å½“è§†å›¾å’Œ ViewModel ä¹‹é—´çš„ç²˜åˆå‰‚ï¼ˆå¤§å¤šæ•°æƒ…å†µä¸‹ï¼‰ã€‚æœ‰ä¸€äº›è§£å†³æ–¹æ¡ˆä½¿ç”¨ <a href="https://github.com/cashapp/molecule">molecule</a>ï¼Œä½†è¿™è¶…å‡ºäº†æˆ‘ä»¬çš„è®¨è®ºèŒƒå›´ã€‚</p>

<p><a href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"><img src="https://funkymuse.dev/assets/img/load_data/zhui.png" title="auto auto" ></a></p>

<!-- more -->


<p>æ­£å¦‚è¿™ç¯‡ <a href="https://x.com/github_skydoves/status/1829315087611707848">Twitter è®¨è®º</a> æ‰€ç¤ºï¼Œå¤§å¤šæ•°å¼€å‘è€…åœ¨ <code>ViewModel</code> çš„ init {} å—ä¸­åŠ è½½æ•°æ®ã€‚è™½ç„¶è¿™ç§æ–¹æ³•çœ‹ä¼¼åˆä¹é€»è¾‘ï¼Œä½†å®ƒå¸¦æ¥äº†ä¸€äº›æ¶æ„é—®é¢˜ï¼ŒIan Lake å’Œå…¶ä»–äººè®¤ä¸ºè¿™æ˜¯åæ¨¡å¼â€”â€”åŒ…æ‹¬ä½¿ç”¨ <code>LaunchedEffect</code> è¿›è¡Œæ•°æ®åŠ è½½ã€‚</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/jokes.png"><img src="https://funkymuse.dev/assets/img/load_data/jokes.png" alt="Irony" /></a></p>

<p>è®½åˆºçš„æ˜¯ï¼Œå³ä½¿æ˜¯å®˜æ–¹ç¤ºä¾‹æœ‰æ—¶ä¹Ÿä¼šä¸è¿™äº›æœ€ä½³åšæ³•ç›¸çŸ›ç›¾ï¼š</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/irony.png"><img src="https://funkymuse.dev/assets/img/load_data/irony.png" alt="Irony" /></a></p>

<h3>å¼€å‘è€…ä¸ºä½•é€‰æ‹© init {} å—ï¼ˆä»¥åŠå®ƒä¸ºä½•å­˜åœ¨é—®é¢˜ï¼‰</h3>

<p>ViewModel çš„ init {} å—çš„å¸å¼•åŠ›æ˜¾è€Œæ˜“è§â€”â€”å®ƒç¡®ä¿æ•°æ®åŠ è½½åœ¨é…ç½®æ›´æ”¹åä¾ç„¶æœ‰æ•ˆï¼Œä»è€Œé¿å…äº†ä¸å¿…è¦çš„ API è°ƒç”¨æˆ–æ•°æ®åº“è¯»å–ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•ä¹Ÿå¸¦æ¥äº†å››ä¸ªå…³é”®é—®é¢˜ï¼š</p>

<h4>é—®é¢˜ 1ï¼šå¯¼èˆªè¿”å›æ ˆå¤æ‚åŒ–</h4>

<p>ä½¿ç”¨ init {} è¿›è¡Œæ•°æ®åŠ è½½æ—¶ï¼Œè¿”å›åˆ°åŒ…å«ç°æœ‰ ViewModel çš„å±å¹•ä¸ä¼šè§¦å‘é‡æ–°åˆå§‹åŒ–ã€‚è¿™è¿«ä½¿å¼€å‘è€…åœ¨ onStart æˆ– onResume ä¸­æ·»åŠ å˜é€šé€»è¾‘æ¥æ£€æŸ¥æ•°æ®æ–°é²œåº¦ï¼Œä»è€Œåˆ›å»ºéš¾ä»¥ç»´æŠ¤çš„æ„å¤§åˆ©é¢æ¡å¼ä»£ç ã€‚</p>

<h4>é—®é¢˜ 2ï¼šè°ƒåº¦ç¨‹åºç«äº‰æ¡ä»¶</h4>

<p>åœ¨ init {} ä¸­åŠ è½½æ•°æ®é€šå¸¸ä½¿ç”¨ viewModelScopeï¼Œå®ƒåœ¨ Dispatchers.Main.immediate ä¸Šè¿è¡Œã€‚è¿™ç§å³æ—¶è°ƒåº¦ç¨‹åºå¯èƒ½ä¼šå¯¼è‡´ç«äº‰æ¡ä»¶ï¼Œå³æ•°æ®å¤„ç†åœ¨ UI ç»„åˆä¹‹å‰å°±å·²å®Œæˆï¼Œå°¤å…¶æ˜¯åœ¨ Jetpack Compose åº”ç”¨ä¸­ã€‚</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/darkness.png"><img src="https://funkymuse.dev/assets/img/load_data/darkness.png" alt="Darkness" /></a></p>

<h4>é—®é¢˜ #3ï¼šæ•°æ®è¿‡æœŸé—®é¢˜</h4>

<p>ç°ä»£ CRUD åº”ç”¨ç¨‹åºéœ€è¦æ›´æ–°æ•°æ®ã€‚ç”¨æˆ·å¯èƒ½ä¼šä»å…¶ä»–å±å¹•è¿”å›ï¼Œæˆ–è€…åœ¨ç›¸å½“é•¿ä¸€æ®µæ—¶é—´åä»æš‚åœçŠ¶æ€æ¢å¤ã€‚<code>init {}</code> æ–¹æ³•æ²¡æœ‰æä¾›å†…ç½®çš„æ•°æ®æ–°é²œåº¦éªŒè¯æœºåˆ¶ã€‚</p>

<h4>é—®é¢˜ #4ï¼šæµ‹è¯•å›°éš¾</h4>

<p>æ¯æ¬¡è¿è¡Œæµ‹è¯•æ—¶ï¼Œä½ éƒ½å¿…é¡»æ„å»º ViewModel æ‰èƒ½æˆåŠŸè¿è¡Œè¯¥ç‰¹å®šæµ‹è¯•ç”¨ä¾‹çš„ <code>init {}</code> ä»£ç å—ã€‚</p>

<h2>åŸºäº Flow çš„è§£å†³æ–¹æ¡ˆï¼šå°†å†·æµè½¬æ¢ä¸ºçƒ­æµ</h2>

<p>è¯¥è§£å†³æ–¹æ¡ˆåˆ©ç”¨ Kotlin Flowsâ€”â€”å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨ StateFlow å’Œé€‚å½“çš„å…±äº«ç­–ç•¥å°†å†·æµè½¬æ¢ä¸ºçƒ­æµã€‚å¯ä»¥å°†å…¶è§†ä¸º Katy Perry çš„â€œHot N Coldâ€æ–¹æ³•ï¼Œä½†æ‰€æœ‰è¾¹ç¼˜æƒ…å†µçš„è¡Œä¸ºéƒ½æ˜¯å¯é¢„æµ‹çš„ã€‚</p>

<h3>æ„å»ºåŸºç¡€ï¼šç”¨ä¾‹å’Œ ViewModel ç»“æ„</h3>

<p><strong>è¯·æ³¨æ„ï¼Œæ­¤ä»£ç ä»…ç”¨äºæ¼”ç¤ºç›®çš„ï¼Œå¦‚ä½•æ„å»ºç”±ä½ å†³å®šï¼Œé™¤åŠ è½½éƒ¨åˆ†å¤–ï¼Œå¹¶éæœ€ä½³å®è·µ</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">provideFactory</span><span class="p">(</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">creator</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span>
</span><span class='line'><span class="p">)</span> <span class="p">=</span> <span class="n">viewModelFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">initializer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">creator</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>æ³¨æ„ï¼šæ­¤å·¥å‚æ¨¡å¼ä»…ç”¨äºæ¼”ç¤ºç›®çš„</em></p>

<p>æˆ‘ä»¬çš„ç”¨ä¾‹å¤„ç†æ•°æ®æ£€ç´¢ã€æ ¼å¼åŒ–å’Œä¸šåŠ¡é€»è¾‘è½¬æ¢ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">GetUserDetailsUseCase</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">authRepository</span><span class="p">:</span> <span class="n">AuthRepository</span> <span class="p">=</span> <span class="n">AuthRepository</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dispatcher</span><span class="p">:</span> <span class="n">CoroutineDispatcher</span> <span class="p">=</span> <span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">billingCache</span><span class="p">:</span> <span class="n">BillingCache</span> <span class="p">=</span> <span class="n">BillingCache</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dateFormatter</span><span class="p">:</span> <span class="n">DateFormatter</span> <span class="p">=</span> <span class="n">DataFormatter</span><span class="p">()</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">withContext</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetailsResponseModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">authRepository</span><span class="p">.</span><span class="n">getUserDetails</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">userDetails</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">details</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">creationDate</span> <span class="p">=</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">format</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">details</span><span class="p">.</span><span class="n">creationDate</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">DateFormatter</span><span class="p">.</span><span class="n">Format</span><span class="p">.</span><span class="n">UTC_SHORT</span>
</span><span class='line'>                    <span class="p">).</span><span class="n">getOrNull</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">avatar</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isPremium</span> <span class="p">=</span> <span class="n">billingCache</span><span class="p">.</span><span class="n">isPremium</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">email</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">email</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">create</span><span class="p">()</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤ç”¨ä¾‹å°è£…äº†ä»å­˜å‚¨åº“æ£€ç´¢æ•°æ®ã€æ—¥æœŸæ ¼å¼åŒ–ã€é«˜çº§çŠ¶æ€éªŒè¯ä»¥åŠå‡†å¤‡ç”¨æˆ·ä¿¡æ¯ä»¥ä¾›æ˜¾ç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span>
</span><span class='line'>            <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•æœ‰å‡ ä¸ªå…³é”®ä¼˜åŠ¿ï¼š</p>

<ul>
<li><strong>æ•°æ®æ–°é²œåº¦</strong>ï¼š5 ç§’è¶…æ—¶æ—¶é—´ä¸ Android çš„ ANR é˜ˆå€¼ä¸€è‡´ï¼Œç¡®ä¿åœ¨è¶…æ—¶åæ”¶é›†å™¨é‡æ–°å‡ºç°æ—¶æ•°æ®èƒ½å¤Ÿåˆ·æ–°ã€‚</li>
<li><strong>é…ç½®å˜æ›´å¤„ç†</strong>ï¼šåœ¨è¶…æ—¶çª—å£å†…ï¼Œå³ä½¿é…ç½®å‘ç”Ÿå˜åŒ–ï¼Œæ•°æ®ä¹Ÿèƒ½æŒä¹…ä¿å­˜ã€‚</li>
<li><strong>èµ„æºæ•ˆç‡</strong>ï¼šé¿å…ä¸å¿…è¦çš„ç½‘ç»œè°ƒç”¨ï¼Œä»¥å®ç°å¿«é€Ÿå¯¼èˆªæ¨¡å¼ã€‚</li>
</ul>


<p><em>ä¸“ä¸šæç¤ºï¼šå¯¹äºéœ€è¦å®æ—¶æ•°æ®æ–°é²œåº¦çš„åº”ç”¨ç¨‹åºï¼Œè¯·å°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 0</em></p>

<h3>æ·»åŠ ç”¨æˆ·äº¤äº’ï¼šå®ç°åˆ·æ–°åŠŸèƒ½</h3>

<p>å®é™…åº”ç”¨ç¨‹åºéœ€è¦ç”¨æˆ·ä¸»åŠ¨å‘èµ·çš„æ•°æ®åˆ·æ–°åŠŸèƒ½ã€‚äº§å“ç»ç†å–œæ¬¢æ»‘åŠ¨åˆ·æ–°ï¼Œä½†æˆ‘ä»¬çš„åŸºæœ¬æµç¨‹æ— æ³•é€‚åº”è¿™ç§æ¨¡å¼ã€‚è®©æˆ‘ä»¬æ¥å¢å¼ºæˆ‘ä»¬çš„æ¶æ„ï¼š</p>

<p>æˆ‘ä»¬ä½¿ç”¨åœ¨ä¸»æµç¨‹æ”¶é›†å™¨ä¸­è§¦å‘çš„ <code>MutableSharedFlow</code> æ¥å®ç°è¿™ä¸€ç‚¹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å®Œç¾ï¼æˆ‘ä»¬æˆåŠŸé‡æ„äº†é‡å¤çš„æ•°æ®åŠ è½½é€»è¾‘ï¼Œå¹¶å®ç°äº†åˆ·æ–°åŠŸèƒ½ã€‚ç„¶è€Œï¼Œè¿™è¿˜ä¸ç®—å®Œã€‚</p>

<h3>ä¼˜åŒ–çŠ¶æ€ç®¡ç†ï¼šæ¶ˆé™¤å†—ä½™çŠ¶æ€è¾“å‡º</h3>

<p>ä¸ºäº†é¿å…ä¸å¿…è¦çš„ UI æ›´æ–°ï¼Œæˆ‘ä»¬å°†æ·»åŠ  <code>distinctUntilChanged()</code> æ¥è¿‡æ»¤é‡å¤çš„çŠ¶æ€è¾“å‡ºã€‚</p>

<h3>å¤„ç†å¤æ‚çš„çŠ¶æ€æ›´æ–°</h3>

<p>å¯¹äºæ„å›¾ä¿®æ”¹ UI çŠ¶æ€è€Œä¸éœ€è¦é‡æ–°åŠ è½½æ•°æ®çš„åœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æµç¨‹æ“ä½œä¸­è®¿é—®å½“å‰çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œåˆ‡æ¢ç”µå­é‚®ä»¶å¯è§æ€§â€”â€”è¿™éœ€è¦ä¿®æ”¹çŠ¶æ€è€Œä¸æ˜¯é‡æ–°åŠ è½½æ•°æ®ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateParameters</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//do some changes here</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™é‡Œçš„æŒ‘æˆ˜åœ¨äºå¦‚ä½•åœ¨æµç¨‹ä¸­è®¿é—®å½“å‰çŠ¶æ€ã€‚è®©æˆ‘ä»¬é€šè¿‡å†…éƒ¨è·Ÿè¸ªçŠ¶æ€æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>æ™ºèƒ½æ•°æ®ç¼“å­˜ï¼šæ¡ä»¶åŠ è½½ç­–ç•¥</h3>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å®ç°å¤æ‚çš„ç¼“å­˜è¡Œä¸ºäº†ã€‚ç”±äº <code>currentState</code> åœ¨ ViewModel ç”Ÿå‘½å‘¨æœŸå†…æŒç»­å­˜åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç«‹å³å‘å‡ºç¼“å­˜æ•°æ®ï¼Œå¹¶ä»…åœ¨å¿…è¦æ—¶æœ‰æ¡ä»¶åœ°åŠ è½½æ–°æ•°æ®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//i added error check just because this is for demonstration of this edge case</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤æ¨¡å¼æä¾›æ™ºèƒ½ç¼“å­˜â€”â€”å³ä½¿åœ¨ 5 ç§’è¶…æ—¶åï¼Œä½ ä¹Ÿå¯ä»¥æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©æ˜¯å¦é‡æ–°è·å–æ•°æ®ï¼š</p>

<ul>
<li><strong>æ˜‚è´µçš„ API è°ƒç”¨</strong>ï¼šåœ¨ ViewModel ä¸­ç¼“å­˜æ•°æ®ä»¥å‡å°‘ç½‘ç»œå¼€é”€</li>
<li><strong>é™æ€åç«¯æ•°æ®</strong>ï¼šé¿å…å¯¹å¾ˆå°‘æ›´æ”¹çš„ä¿¡æ¯è¿›è¡Œä¸å¿…è¦çš„è¯·æ±‚</li>
<li><strong>å®æ—¶éœ€æ±‚</strong>ï¼šå¼ºåˆ¶åˆ·æ–°éœ€è¦æ›´æ–°æ•°æ®çš„åº”ç”¨ç¨‹åº</li>
</ul>


<h3>åˆ›å»ºå¯å¤ç”¨çš„æŠ½è±¡</h3>

<p>é‡å¤ç¼–å†™æ­¤æ¨¡å¼ä¼šå˜å¾—éå¸¸ç¹çã€‚è®©æˆ‘ä»¬ä» ViewModel æ‰©å±•å‡½æ•°å¼€å§‹ï¼Œåˆ›å»ºå¯å¤ç”¨çš„æŠ½è±¡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshMechanism</span><span class="p">:</span> <span class="n">SharedFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshMechanism</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh mechanism but no way to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshMechanism</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh data but no mechanism to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshMechanism</span><span class="o">?.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">refreshData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ‰äº†æˆ‘ä»¬æŠ½è±¡çš„æ‰©å±•å‡½æ•°ï¼ŒViewModel å˜å¾—æ›´åŠ ç®€æ´ï¼š</p>

<p><em>æ³¨æ„ï¼šæ­¤æŠ½è±¡æ¶µç›–äº† 90% çš„å¸¸è§ç”¨ä¾‹ï¼Œä½†ä¸æ”¯æŒå¤æ‚çš„æµç¨‹é“¾å¼æ“ä½œ</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">refreshMechanism</span> <span class="p">=</span> <span class="n">refreshListener</span><span class="p">,</span>
</span><span class='line'>        <span class="n">refreshData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºæ›´å¤æ‚çš„åŸºç±»æ¥æ¶ˆé™¤é‡å¤çš„ <code>refreshListener</code> å£°æ˜ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">ViewModelLoader</span><span class="p">&lt;</span><span class="n">State</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Intent</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Trigger</span> <span class="p">:</span> <span class="n">Any</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_trigger</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Trigger</span><span class="p">&gt;()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>        <span class="n">triggerData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5000L</span><span class="p">,</span> <span class="c1">//matching ANR timeout in Android</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">triggerData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_trigger</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">triggerParams</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">triggerData</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>                <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>                <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">abstract</span> <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">currentState</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">open</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">Intent</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">fun</span> <span class="nf">sendTrigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_trigger</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬çš„æœ€ç»ˆå®ç°å°†å˜å¾—éå¸¸ç®€æ´ä¸”æ˜“äºç»´æŠ¤ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModelLoader</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">triggerData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>å¤„ç† UI çŠ¶æ€å¤æ‚æ€§</h3>

<p>æ­¤æŠ½è±¡ä½¿ç”¨å¸ƒå°”æ ‡å¿—ï¼ˆ<code>isLoading</code>ã€<code>isError</code>ï¼‰ï¼Œè¿™äº›æ ‡å¿—å¯èƒ½ä¼šåˆ›å»ºæ¨¡ç³ŠçŠ¶æ€ã€‚ä¸ºäº†æ›´æ¸…æ™°åœ°ç®¡ç†çŠ¶æ€ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨å¯†å°ç±»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">UIState</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Success</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Error</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Idle</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¯¹äºéœ€è¦åŒæ—¶æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆä¾‹å¦‚ Snackbarsï¼‰å’Œç°æœ‰æ•°æ®çš„åœºæ™¯ï¼Œä½ å¯ä»¥åˆ›å»ºæ›´å¤æ‚çš„çŠ¶æ€æŒæœ‰è€…ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UIStateHolder</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">UIState</span> <span class="p">=</span> <span class="n">UIState</span><span class="p">.</span><span class="n">Idle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">payload</span><span class="p">:</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™ç§æ–¹æ³•å¯ä»¥å®ç°çµæ´»çš„ UI çŠ¶æ€ç®¡ç†ï¼ŒåŒæ—¶ä¿æŒ UI çŠ¶æ€å’Œæ•°æ®è´Ÿè½½ä¹‹é—´çš„æ˜ç¡®åˆ†ç¦»ï¼Œä½†å¯èƒ½ä¼šå¢åŠ è®¤çŸ¥è´Ÿè·ï¼Œå¹¶å¼•å…¥æ›´å¤šçš„æ˜ å°„è¡Œä¸ºå’Œè§£åŒ…é€»è¾‘ã€‚</p>

<h3>è¶…è¶Š ViewModel</h3>

<p>æ­¤æ¨¡å¼ä¸ä»…é™äº ViewModelã€‚é€šè¿‡æä¾›è‡ªå®šä¹‰åç¨‹ä½œç”¨åŸŸï¼Œä½ å¯ä»¥åœ¨ä»»ä½•ç»„ä»¶ï¼ˆå¯ç»„åˆç»„ä»¶ã€å­˜å‚¨åº“æˆ–ä¸šåŠ¡é€»è¾‘å±‚ï¼‰ä¸­ä½¿ç”¨æ­¤æ•°æ®åŠ è½½æ–¹æ³•ã€‚</p>

<h2>æµç»„åˆæ¨¡å¼</h2>

<p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹è¿˜åœ¨äºå¯ä»¥ç»„åˆå¤šä¸ªæ•°æ®æºã€‚ä»¥ä¸‹æ˜¯å¤„ç†å•æµå’ŒåŒæµçš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span>
</span><span class='line'>        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">newValue</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">transform</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç»„åˆåŒæµçš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T1</span><span class="p">,</span> <span class="k">reified</span> <span class="n">T2</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow1</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T1</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">flow2</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T2</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue1</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span> <span class="n">newValue2</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">combine</span><span class="p">(</span><span class="n">flow1</span><span class="p">,</span> <span class="n">flow2</span><span class="p">)</span> <span class="p">{</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">transform</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™äº›æ‰©å±•å…è®¸ä½ è½»æ¾ç»„åˆå¤šä¸ªæ•°æ®æºï¼ŒåŒæ—¶ä¿æŒç›¸åŒçš„æ™ºèƒ½ç¼“å­˜å’ŒçŠ¶æ€ç®¡ç†åŸåˆ™ã€‚</p>

<h3>æµ‹è¯•åŸºäºæµçš„ ViewModel</h3>

<p>åœ¨ç»“æŸä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ¢ç´¢å¦‚ä½•ä½¿ç”¨ fakes å’Œ Turbine è¿›è¡Œæµæµ‹è¯•ï¼Œæ­£ç¡®åœ°æµ‹è¯•æˆ‘ä»¬çš„ <code>UserAccountDetailsViewModel</code> å®ç°ã€‚</p>

<h4>ä½¿ç”¨ Fakes å’Œ Turbine è®¾ç½®æµ‹è¯•ä¾èµ–é¡¹</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@OptIn</span><span class="p">(</span><span class="n">ExperimentalCoroutinesApi</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccountDetailsViewModelTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">testDispatcher</span> <span class="p">=</span> <span class="n">StandardTestDispatcher</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">fakeGetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">FakeGetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">UserAccountDetailsViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Before</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">setMain</span><span class="p">(</span><span class="n">testDispatcher</span><span class="p">)</span>
</span><span class='line'>        <span class="n">viewModel</span> <span class="p">=</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@After</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">resetMain</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fake implementation for realistic testing, this sounds funny to write haha</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FakeGetUserDetailsUseCase</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">userDetailsToReturn</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setSuccessResponse</span><span class="p">(</span><span class="n">userDetails</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="n">userDetails</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setErrorResponse</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Expose execution count when testing caching/performance behavior</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getExecutionCount</span><span class="p">()</span> <span class="p">=</span> <span class="n">executionCount</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span><span class="p">++</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span> <span class="c1">// Simulate network delay</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">shouldReturnError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Network error&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">userDetailsToReturn</span> <span class="o">?:</span> <span class="n">createDefaultUserDetails</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createDefaultUserDetails</span><span class="p">()</span> <span class="p">=</span> <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>        <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;default@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æˆåŠŸå’Œå¤±è´¥åœºæ™¯çš„å‚æ•°åŒ–æµ‹è¯•</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@ParameterizedTest</span>
</span><span class='line'><span class="n">@ValueSource</span><span class="p">(</span><span class="n">booleans</span> <span class="p">=</span> <span class="p">[</span><span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">])</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">handle</span> <span class="n">both</span> <span class="n">success</span> <span class="n">and</span> <span class="n">error</span> <span class="n">scenarios</span><span class="err">`</span><span class="p">(</span><span class="n">shouldSucceed</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;success@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Focus on behavior, not implementation details</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">successState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;success@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">userInfo</span><span class="p">).</span><span class="n">isNull</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">refresh</span> <span class="n">data</span> <span class="k">when</span> <span class="n">refresh</span> <span class="n">intent</span> <span class="k">is</span> <span class="n">triggered</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial successful load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;initial@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2022-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">initialState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">initialState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;initial@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Change response and trigger refresh</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;refreshed@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://new-avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">refreshedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// New Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;refreshed@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Verify both initial load and refresh were called</span>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•ä»… UI çŠ¶æ€å˜åŒ–</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">toggle</span> <span class="n">email</span> <span class="n">visibility</span> <span class="n">without</span> <span class="n">triggering</span> <span class="n">data</span> <span class="n">reload</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Successful initial load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;test@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">loadedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Toggle email visibility</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="k">true</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">toggledState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•æ•°æ®ç¼“å­˜è¡Œä¸º</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">use</span> <span class="n">cached</span> <span class="n">data</span> <span class="k">when</span> <span class="n">returning</span> <span class="n">to</span> <span class="n">screen</span> <span class="n">quickly</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;cached@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When First collection</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">firstState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">firstState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cancel</span><span class="p">()</span> <span class="c1">// Simulate leaving screen</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When Quick return (simulating navigation back within timeout)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should have cached data immediately (no Loadin)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">cachedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">expectNoEvents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>æµ‹è¯•é”™è¯¯æ¢å¤</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">recover</span> <span class="n">from</span> <span class="n">Error</span> <span class="n">on</span> <span class="n">successful</span> <span class="n">refresh</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial error</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Error</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Fix the response and refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;recovered@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should recover successfully</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">recoveredState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;recovered@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ä¸ºä»€ä¹ˆè¦æµ‹è¯•åŸºäºæµçš„ ViewModel çš„åŸåˆ™</h3>

<p>å“¦â€¦â€¦è¿™å¯èƒ½ä¼šå¼•å‘ä¸€äº›äº‰è®ºï¼Œä½†è¿™é‡Œæœ‰ä¸€ç¯‡å¾ˆæ£’çš„æ–‡ç« ï¼Œå®ƒæä¾›äº†æ›´å¥½çš„æè¿°ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“æœ¬æ–‡å…³äºæˆ‘ä¸ºä»€ä¹ˆä½¿ç”¨ Fakes çš„ç›®çš„ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªç®€çŸ­çš„æ€»ç»“ï¼Œå¯ä»¥è¡¥å……æ–‡ç« é¡¶éƒ¨</p>

<ol>
<li><strong>ä½¿ç”¨ Fakes è€Œé Mocks</strong>ï¼šFake æä¾›é€¼çœŸçš„è¡Œä¸ºï¼Œå¹¶ä¸”æ›´æ˜“äºç»´æŠ¤ï¼Œå°¤å…¶æ˜¯åœ¨å¦‚ä»Š LLM çš„å¸®åŠ©ä¸‹â€¦â€¦</li>
<li><strong>å‚æ•°åŒ–æµ‹è¯•</strong>ï¼šç”¨ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹åŒæ—¶æµ‹è¯•æˆåŠŸå’Œå¤±è´¥è·¯å¾„</li>
<li><strong>ä½¿ç”¨ Turbine è¿›è¡Œæµç¨‹æµ‹è¯•</strong>ï¼šç®€æ´ã€å¯Œæœ‰è¡¨ç°åŠ›çš„æµç¨‹æµ‹è¯•ï¼Œå¹¶è¿›è¡Œé€‚å½“çš„çŠ¶æ€éªŒè¯</li>
<li><strong>æµ‹è¯•çŠ¶æ€è½¬æ¢</strong>ï¼šéªŒè¯å®Œæ•´çš„çŠ¶æ€æµç¨‹ï¼Œè€Œä¸ä»…ä»…æ˜¯æœ€ç»ˆçŠ¶æ€</li>
<li><strong>è°¨æ…æ‰§è¡Œè®¡æ•°</strong>ï¼šä»…åœ¨æµ‹è¯•ç¼“å­˜ã€æ€§èƒ½æˆ–é‡è¯•è¡Œä¸ºæ—¶éªŒè¯è°ƒç”¨è®¡æ•°</li>
<li><strong>å…³æ³¨è¡Œä¸º</strong>ï¼šæµ‹è¯•ç”¨æˆ·ä½“éªŒï¼Œè€Œä¸æ˜¯å®ç°ç»†èŠ‚ï¼ˆæˆ‘æƒ³è¿™ä¸€ç‚¹æ˜¾è€Œæ˜“è§ï¼‰</li>
</ol>


<h3>ç»“è®º</h3>

<p>æœ¬æ–‡å¯¹ Android ViewModel ä¸­åŸºäºæµç¨‹çš„æ•°æ®åŠ è½½çš„æ¢ç´¢ï¼Œè§£å†³äº†ä¼ ç»Ÿ <code>init {}</code> å—æ–¹æ³•çš„æ ¹æœ¬æŒ‘æˆ˜ã€‚è™½ç„¶æ¶µç›–æ‰€æœ‰æ¶æ„å˜ä½“ä¼šå¾ˆç¹çï¼Œä½†è¯¥æ¨¡å¼æˆåŠŸå¤„ç†äº†å¤§çº¦ 90% çš„å¸¸è§ç”¨ä¾‹ã€‚</p>

<p>æŠ½è±¡åŸºç±»æ–¹æ³•ï¼ˆ<code>ViewModelLoader</code>ï¼‰æä¾›äº†æœ€å¯é¢„æµ‹å’Œå¯ç»´æŠ¤çš„è§£å†³æ–¹æ¡ˆï¼Œå®ƒæä¾›ï¼š</p>

<ul>
<li><strong>å¯é¢„æµ‹çš„çŠ¶æ€ç®¡ç†</strong>ï¼šæ¸…æ™°çš„çŠ¶æ€è§¦å‘å™¨å’Œæ„å›¾å¤„ç†</li>
<li><strong>å†…ç½®æµ‹è¯•æ”¯æŒ</strong>ï¼šå…·æœ‰é€‚å½“åç¨‹å¤„ç†çš„å¯æµ‹è¯•æ¶æ„</li>
<li><strong>çµæ´»æ€§</strong>ï¼šæ˜“äºæ‰©å±•æ•ˆæœå’Œæ··åˆ MVI æ¨¡å¼</li>
<li><strong>ç¼“å­˜å’Œåˆ·æ–°</strong>ï¼šç¼“å­˜å’Œåˆ·æ–°æœºåˆ¶ï¼ˆæœ¬æ–‡å°†å°½å¯èƒ½è¯¦ç»†åœ°ä»‹ç»ï¼‰</li>
</ul>


<h3>å…³é”®è¦ç‚¹</h3>

<ol>
<li><strong>åŸºäºæµçš„åŠ è½½</strong>æ¶ˆé™¤äº†ç«äº‰æ¡ä»¶ï¼Œæé«˜äº†æµ‹è¯•çš„ç®€æ˜“æ€§ï¼Œå¹¶è§£å†³äº† <code>init {}</code> å—ä¸­å›ºæœ‰çš„å›æ ˆé—®é¢˜</li>
<li><strong>å…·æœ‰é€‚å½“å…±äº«ç­–ç•¥çš„ StateFlow</strong> æä¾›äº†æœ€ä½³çš„ç”Ÿå‘½å‘¨æœŸæ„ŸçŸ¥æ•°æ®ç®¡ç†</li>
<li><strong>æŠ½è±¡å±‚</strong>å‡å°‘äº†æ ·æ¿ä»£ç ï¼ŒåŒæ—¶ä¿æŒäº†çµæ´»æ€§</li>
<li><strong>å…¨é¢çš„æµ‹è¯•</strong>ç¡®ä¿æ‰€æœ‰ç”¨ä¾‹çš„å¯é æ€§</li>
</ol>


<p>è¯·è®°ä½ï¼Œè¿™åªæ˜¯ä¼—å¤šæ¶æ„æ–¹æ³•ä¸­çš„ä¸€ç§ï¼Œå®ƒè§£å†³äº†æˆ‘çš„é—®é¢˜ï¼Œä½†å¯èƒ½æ— æ³•è§£å†³ä½ çš„é—®é¢˜ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯äº†è§£æ½œåœ¨é—®é¢˜å¹¶è¯„ä¼°æ­¤è§£å†³æ–¹æ¡ˆæ˜¯å¦ç¬¦åˆä½ çš„ç‰¹å®šéœ€æ±‚ã€‚éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè¿™ä¸ªè§£å†³æ–¹æ¡ˆå°†ç»å†è®¸å¤šå˜åŒ–ï¼Œç”šè‡³å¯èƒ½è¢«æ·˜æ±°ã€‚æœ€è¿‘ï¼Œæˆ‘æ›´å¤šåœ°æŠ•å…¥åˆ°ä½¿ç”¨ Ktor è¿›è¡Œåç«¯å¼€å‘ï¼Œè¿™æœ¬èº«å°±æ˜¯ä¸€æ¬¡å¾ˆæ£’çš„ä½“éªŒã€‚</p>

<p>è¯¥æ¶æ„æˆåŠŸåœ°ä¸º iOS å’Œ Android å¹³å°ä¸Šçš„ <a href="https://wallhub.app/">WallHub</a> æä¾›äº†æ”¯æŒï¼Œè¯æ˜äº†å…¶åœ¨ç°å®ä¸–ç•Œä¸­çš„â€œå¯è¡Œæ€§â€ä»¥åŠè·¨å¹³å°é€‚åº”æ€§ï¼ˆå¦‚æœå¯ä»¥è¿™ä¹ˆè¯´çš„è¯ï¼‰ã€‚</p>

<p>ç»§ç»­æ½œæ°´ï¼Œç›´åˆ°ä¸‹ä¸€ç¯‡æ–‡ç« â€¦â€¦</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Androidåº”ç”¨çš„æ¶æ„æ¼”è¿›]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"/>
    <updated>2025-09-13T12:34:01+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒArchitectural Evolution of and Android appã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://herrbert74.github.io/posts/architectural-evolution-of-an-app/">https://herrbert74.github.io/posts/architectural-evolution-of-an-app/</a>ï¼Œç”±Zsolt Bertalanå‘å¸ƒäº20258æœˆ19æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"><img src="https://herrbert74.github.io/assets/img/posts/20250818_arch_evolution.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>æœ¬æ–‡å°†è§£é‡Š Android åº”ç”¨åœ¨å‘å±•è¿‡ç¨‹ä¸­å¯èƒ½ç»å†çš„å„ä¸ªé˜¶æ®µã€‚ä¸åŒçš„æ¶æ„å¯èƒ½çœ‹èµ·æ¥æˆªç„¶ä¸åŒï¼ˆæ›´ä¸ç”¨è¯´å¯¹ç»†èŠ‚çš„ä¸åŒçœ‹æ³•ï¼‰ï¼Œä½†å…¶èƒŒåçš„ç†å¿µæ˜¯ç›¸åŒçš„ã€‚æˆ‘å°†é€šè¿‡æ•´æ´æ¶æ„ (Clean Architecture) å’Œæˆ‘çš„ <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> ä»£ç åº“ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82</a></p>

<p>æˆ‘è¿˜æƒ³ä»‹ç»ä¸€ä¸‹å¤§å‹åº”ç”¨ä¸­çš„å¸¸è§æ¨¡å¼ï¼š<strong>è¶…çº§å±‚</strong> å’Œ <strong>åŠŸèƒ½ç»„</strong>ã€‚æ¯å½“æˆ‘å¼€å‘çš„åº”ç”¨è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼Œéƒ½ä¼šç”¨åˆ°è¿™äº›æ¨¡å¼ï¼Œä½†æˆ‘ä»æœªåˆ¶å®šè¿‡ç›¸å…³çš„åŸºæœ¬è§„åˆ™ã€‚æˆ‘å¸Œæœ›æŠŠå®ƒä»¬å†™ä¸‹æ¥ï¼Œèƒ½è®©æˆ‘å’Œå…¶ä»–äººæ›´å®¹æ˜“ç†è§£ã€‚</p>

<h3>è¶…çº§å±‚</h3>

<p>ä½ å¯èƒ½è¿˜è®°å¾—æˆ‘ä¹‹å‰çš„æ–‡ç« ï¼Œæˆ‘çš„åº”ç”¨æœ‰ä¸€ä¸ªç‹¬ç«‹çš„<strong>é¢†åŸŸå±‚</strong>ï¼Œ<strong>æ•°æ®å±‚å’Œå±•ç°å±‚ï¼ˆä»ç°åœ¨å¼€å§‹æ˜¯UIå±‚ï¼‰</strong>éƒ½ä¾èµ–äºå®ƒã€‚è¿™äº›æ˜¯åŸºæœ¬çš„æ°´å¹³å±‚ã€‚åŒ…å«å®ƒä»¬çš„å‚ç›´å±‚ä¹Ÿç§°ä¸ºåŠŸèƒ½å±‚ã€‚</p>

<p>æˆ‘åˆ›é€ äº† <strong>â€œè¶…çº§å±‚â€</strong> è¿™ä¸ªæœ¯è¯­ï¼Œæ˜¯ä¸ºäº†åœ¨åŸºæœ¬æ°´å¹³å±‚ä¹‹ä¸Šå¼•å…¥ä¸€ä¸ªæ›´å¹¿æ³›çš„å±‚æ¬¡ç»“æ„ã€‚æˆ‘ä»¬éœ€è¦å®ƒä»¬ï¼Œå› ä¸ºæ°´å¹³å±‚çš„èŒƒå›´å¯èƒ½æœ‰æ‰€ä¸åŒï¼Œè¿™æ„å‘³ç€å®ƒä»¬ä¸ä»…å¯ä»¥æ¶µç›–åŠŸèƒ½å±‚ï¼Œè¿˜å¯ä»¥æ¶µç›–æ›´å¹¿æ³›çš„èŒƒå›´ã€‚æˆ‘å°†å®šä¹‰<strong>åŠŸèƒ½å±‚</strong>ã€<strong>åŠŸèƒ½ç»„</strong>ã€<strong>åº”ç”¨çº§ï¼ˆå…±äº«ï¼‰</strong>å’Œ<strong>å¤šåº”ç”¨çº§ï¼ˆåŸºç¡€ï¼‰</strong> è¶…çº§å±‚ã€‚</p>

<p>è¯·å‚é˜…ä¸‹å›¾ã€‚</p>

<p><img src="file:///Users/alexhilton/Downloads/arch-envolve-1.png" alt="" /></p>

<p>åœ¨æˆ‘ä¸Šé¢è§£é‡Šçš„åŸºæœ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æœ‰<strong>åŠŸèƒ½å±‚</strong>ï¼Œå…¶ä¸­æ•´æ´æ¶æ„å±‚ä»…åœ¨åŠŸèƒ½å±‚å†…éƒ¨å¯è§ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œ<strong>åŠŸèƒ½ç»„</strong>å±‚æ˜¯ä»‹äºåº”ç”¨èŒƒå›´å±‚å’ŒåŠŸèƒ½èŒƒå›´å±‚ä¹‹é—´çš„ä¸­é—´å±‚ã€‚ç”±äºå®ƒæ˜¯å¯¹è¶…çº§å±‚çš„æœ€åä¸”æœ€ä¸æ˜æ˜¾çš„è¡¥å……ï¼Œæˆ‘å°†åœ¨ç¨åè¯¦ç»†è®¨è®ºã€‚</p>

<p><strong>å…±äº«ã€é€šç”¨æˆ–åº”ç”¨èŒƒå›´å±‚</strong>é€šå¸¸åŒ…å«ä¸ä¸šåŠ¡ç›¸å…³æˆ–æ•´ä¸ªåº”ç”¨ç‹¬æœ‰çš„ç±»ã€‚è¿™æ˜¯å¯ä»¥æ·»åŠ é¢†åŸŸã€æ•°æ®å’Œ UI æ¨¡å—çš„æœ€ä½å±‚ã€‚</p>

<p><strong>åŸºç¡€å±‚ã€åŸºç¡€è®¾æ–½å±‚æˆ–åŸºç¡€ç»“æ„å±‚</strong>å¯ä»¥è·¨å¤šä¸ªåº”ç”¨ä½¿ç”¨ã€‚å®ƒä¸åŒ…å«é¢†åŸŸã€æ•°æ®æˆ– UI å±‚ï¼Œä½†åŒ…å«è¿™äº›å±‚ä¹‹é—´é€šç”¨çš„ç±»ã€‚æˆ‘é€šå¸¸æœ‰ä¸€ä¸ª<strong>Kotlin æ¨¡å—å’Œä¸€ä¸ª Android åŸºç¡€æ¨¡å—</strong>ã€‚æˆ‘åˆ›å»ºäº† <a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/">BaBeStudios-Base</a> åº“é¡¹ç›®ï¼ˆ<a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82">https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82</a> BaBeStudios-Base ä¹Ÿå¯ä» <a href="https://mvnrepository.com/artifact/io.bitbucket.babestudios">MavenCentral</a> è·å–ï¼Œä½†ç›®å‰å°šæ— ç›¸å…³æ–‡æ¡£ã€‚</p>

<p>éšç€åº”ç”¨ç¨‹åºè§„æ¨¡çš„æ‰©å¤§å’Œæ¨¡å—çš„å¼•å…¥ï¼Œä½ éœ€è¦å¼•å…¥ä¸Šè¿°å„å±‚ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹éšç€åº”ç”¨ç¨‹åºè§„æ¨¡çš„æ‰©å¤§ï¼Œæˆ‘é€šå¸¸é‡‡å–çš„æ¨¡å—åŒ–æ­¥éª¤ã€‚</p>

<h3>æ­¥éª¤ 1ï¼šå•æ¨¡å—</h3>

<p>å½“ä½ ç¡®å®šåº”ç”¨ç¨‹åºè§„æ¨¡ä¸ä¼šè¶…è¿‡<strong>æœ€å¤§è§„æ¨¡</strong>ï¼Œæˆ–è€…æ—¶é—´ç´§è¿«æ—¶ï¼Œä½ å¯ä»¥é€‰æ‹©å•æ¨¡å—åº”ç”¨ç¨‹åºæˆ–å•ä½“åº”ç”¨ã€‚æˆ‘ä¸ç¡®å®šå•æ¨¡å—åº”ç”¨ç¨‹åºçš„æœ€å¤§è§„æ¨¡æ˜¯å¤šå°‘ã€‚è¿™å¯èƒ½å› äººè€Œå¼‚ã€‚</p>

<p>æ­¤æœ€å¤§è§„æ¨¡ä¹Ÿä¸åŒäº<strong>é˜ˆå€¼è§„æ¨¡ï¼Œä½ åº”è¯¥ä»è¯¥é˜ˆå€¼å¼€å§‹æ¨¡å—åŒ–åº”ç”¨ç¨‹åº</strong>ï¼Œæˆ–è€…æ›´é€šä¿—åœ°è¯´ï¼Œä½ åº”è¯¥ä»è¯¥é˜ˆå€¼åˆ‡æ¢åˆ°æµç¨‹çš„ä¸‹ä¸€æ­¥ã€‚æˆ‘è®¤ä¸ºé˜ˆå€¼å¤§å°è¿œå°äºå•æ¨¡å—åº”ç”¨ç¨‹åºçš„æœ€å¤§å¤§å°ï¼Œè¿™æ„å‘³ç€ä½ åº”è¯¥åœ¨è¾¾åˆ°è¯¥é™åˆ¶ä¹‹å‰å°±å¼€å§‹æ¨¡å—åŒ–ã€‚</p>

<p>å¯¹äºå¤§å¤šæ•°åº”ç”¨ç¨‹åºï¼Œæˆ‘ç”šè‡³å»ºè®®<strong>ä»æ¨¡å—åŒ–å¼€å§‹</strong>ï¼Œè€Œä¸æ˜¯ä»å•ä¸ªæ¨¡å—å¼€å§‹ï¼Œå› ä¸ºä¸æ¥è¿‘é™åˆ¶ï¼ˆæ¯”å¦‚ 10 æˆ– 20 kLOCï¼‰æ—¶æ‰å¼€å§‹æ¨¡å—åŒ–ç›¸æ¯”ï¼Œè¿™æ ·åšçš„å¼€é”€å’Œå¹²æ‰°ç¨‹åº¦è¦å°å¾—å¤šã€‚</p>

<p>è¿™æ˜¯ä¸€ä¸ªå•æ¨¡å—åº”ç”¨ç¨‹åºçš„åŒ…æ ‘ç¤ºä¾‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>â”œâ”€â”€ data
</span><span class='line'>â”‚   â”œâ”€â”€ database
</span><span class='line'>â”‚   â”œâ”€â”€ <span class="nb">local</span>
</span><span class='line'>â”‚   â”œâ”€â”€ repository
</span><span class='line'>â”‚   â””â”€â”€ remote
</span><span class='line'>â”œâ”€â”€ domain
</span><span class='line'>â”‚   â”œâ”€â”€ api
</span><span class='line'>â”‚   â”œâ”€â”€ model
</span><span class='line'>â”‚   â””â”€â”€ usecase
</span><span class='line'>â”œâ”€â”€ presentation
</span><span class='line'>â”‚   â”œâ”€â”€ master
</span><span class='line'>â”‚   â””â”€â”€ detail
</span><span class='line'>â””â”€â”€ shared
</span></code></pre></td></tr></table></div></figure>


<p>ä¸Šé¢å›¾ä¸­çš„å¶å­èŠ‚ç‚¹ä»£è¡¨åŒ…ï¼Œå®ƒä»¬å¯ä»¥åŒ…å«æ­¤å¤„æœªæ˜¾ç¤ºçš„å…¶ä»–åŒ…ã€‚ä¸‹é¢æˆ‘å°†å±•ç¤ºä¸€ä¸ªç±»ä¼¼çš„æ¨¡å—ç»“æ„ï¼Œå…¶ä¸­ä»¥å†’å·å¼€å¤´çš„åç§°ä»£è¡¨æ¨¡å—ï¼ŒåŒå†’å·ä»£è¡¨æ ¹æ¨¡å—ã€‚</p>

<h3>æ­¥éª¤ 2ï¼šç®€å•æ¨¡å—åŒ–</h3>

<p>å¯¹äº<strong>å°å‹åº”ç”¨ç¨‹åº</strong>ï¼Œæˆ‘ä½¿ç”¨ç®€å•æ¨¡å—åŒ–ï¼Œè€Œä¸æ˜¯ä¸‹ä¸€ç« çš„å®Œå…¨æ¨¡å—åŒ–ã€‚è¿™é‡Œæˆ‘ä»¬åªä»‹ç»<strong>æ¯ä¸ªåŠŸèƒ½çš„æ¨¡å—</strong>ã€‚æ¯ä¸ªåŠŸèƒ½å°†åŒ…å«ä¸€ä¸ªé¢†åŸŸæ¨¡å—ï¼Œä»¥åŠä¾èµ–äºé¢†åŸŸæ¨¡å—çš„æ•°æ®å’Œå‘ˆç°æ¨¡å—ï¼ˆåœ¨æˆ‘çš„ä¾‹å­ä¸­ï¼‰ã€‚</p>

<p>æˆ‘ä»¬è¿˜å¼•å…¥äº†ä¸€ä¸ª<strong>å…±äº«æ¨¡å—</strong>ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰åŠŸèƒ½æ¨¡å—çš„é€šç”¨ä»£ç ã€‚</p>

<p>åº”ç”¨ç¨‹åºçš„è¶…å±‚ç”±ä¸€æ¡<strong>æ°´å¹³çº¿</strong>åˆ†éš”ã€‚æ¯ä¸ªå±‚éƒ½ä¾èµ–äºå…¶ä¸‹æ–¹çš„æ‰€æœ‰å±‚ã€‚æ•°æ®å’Œå‘ˆç°ä¾èµ–äºé¢†åŸŸæ¨¡å—ï¼Œä½†è¿™å¹¶æœªåœ¨å›¾ä¸­æ˜¾ç¤ºã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>::feature:Feature A
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featurea/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featurea/:domain
</span><span class='line'>â””â”€â”€ :feature/:featurea/:presentation
</span><span class='line'>
</span><span class='line'>::feature:Feature B
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featureb/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featureb/:domain
</span><span class='line'>â””â”€â”€ :feature/:featureb/:presentation
</span><span class='line'>
</span><span class='line'> ::feature:Feature C
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ :feature/:featurec/:data
</span><span class='line'>â”œâ”€â”€ :feature/:featurec/:domain
</span><span class='line'>â””â”€â”€ :feature/:featurec/:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::shared:data
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ database
</span><span class='line'>â”œâ”€â”€ <span class="nb">local</span>
</span><span class='line'>â”œâ”€â”€ repository
</span><span class='line'>â””â”€â”€ remote
</span><span class='line'>
</span><span class='line'>::shared:domain
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ api
</span><span class='line'>â”œâ”€â”€ model
</span><span class='line'>â””â”€â”€ usecase
</span><span class='line'>
</span><span class='line'>::shared:presentation
</span><span class='line'>
</span><span class='line'>â”œâ”€â”€ compose
</span><span class='line'>â”œâ”€â”€ design
</span><span class='line'>â””â”€â”€ util
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::base:kotlin
</span></code></pre></td></tr></table></div></figure>


<h3>æ­¥éª¤ 4ï¼šåŠŸèƒ½ç»„</h3>

<p>å½“ä½ çš„åº”ç”¨å®Œå…¨æ¨¡å—åŒ–åï¼Œå…±äº«å±‚ä¼šé€æ¸æˆä¸ºå•ä½“åº”ç”¨ï¼Œå¹¶æˆä¸ºæ„å»ºè¿‡ç¨‹ä¸­çš„<strong>ç“¶é¢ˆ</strong>ã€‚</p>

<p>æˆ‘ç»å¸¸åœ¨è¶…è¿‡ä¸€å®šè§„æ¨¡çš„åº”ç”¨ï¼ˆå¤§çº¦ 50 åˆ° 80 kLOCï¼‰æ—¶é‡åˆ°è¿™ç§æƒ…å†µã€‚ä½ éœ€è¦å…±äº«å¤ªå¤šå†…å®¹ï¼Œå› æ­¤ä½ çš„<strong>å…±äº«é¢†åŸŸæ¨¡å—å’Œå±•ç¤ºæ¨¡å—</strong>å˜å¾—è¿‡å¤§ã€‚ä½ å¼€å§‹æ³¨æ„åˆ°ï¼Œåœ¨æ‰€æœ‰å‚ç›´æ¨¡å—ä¹‹é—´å…±äº«ä»£ç ä¹Ÿæ˜¯ä¸€ç§æµªè´¹ï¼Œå› ä¸ºä½ åªæƒ³åœ¨ä¸¤ä¸ªæˆ–æœ€å¤šä¸‰ä¸ªæˆ–å››ä¸ªæ¨¡å—ä¹‹é—´å…±äº«ä»£ç ã€‚ä½ ä¼šå‘ç°è¶Šæ¥è¶Šå¤šçš„æ–°ä»£ç è¢«æ·»åŠ åˆ°è¿™äº›æ¨¡å—ä¸­ï¼Œè€Œ<strong>å¢é‡ç¼“å­˜</strong>çš„æ•ˆç‡è¶Šæ¥è¶Šä½ï¼Œå› ä¸ºä½ é¢‘ç¹åœ°ä¿®æ”¹ä»£ç ï¼Œå¯¼è‡´å®ƒä»¬å¤±æ•ˆã€‚</p>

<p>ä½ å¯èƒ½ä¼šè¯´ï¼Œå¯ä»¥é€šè¿‡é€‚å½“åœ°é‡æ„å’Œæ„å»ºåº”ç”¨ç¨‹åºï¼Œæˆ–è€…å¤åˆ¶ä¸€äº›ä»£ç æ¥é¿å…è¿™ç§æƒ…å†µï¼Œä½†è¿™å¯èƒ½æ¯”ä½ æƒ³è±¡çš„è¦éš¾ã€‚æˆ‘å‘ç°è¿™äº›å»ºè®®å¹¶æ²¡æœ‰èµ·åˆ°ä»€ä¹ˆå¸®åŠ©ä½œç”¨ã€‚æˆ–è€…ä½ å¯èƒ½æ‰‹å¤´æœ‰ä¸€ä¸ªé—ç•™åº”ç”¨ï¼Œæ²¡æœ‰æ—¶é—´å®Œç¾åœ°é‡æ„æ‰€æœ‰å†…å®¹ã€‚</p>

<p>æˆ‘ç›®å‰è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯è¯†åˆ«<strong>åŠŸèƒ½ç»„</strong>ï¼Œå³ä¸€ç»„å…·æœ‰å¤§é‡å…¬å…±ä¾èµ–é¡¹çš„åŠŸèƒ½ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥é€šè¿‡åˆ›å»º<strong>æ›´å…·å‡èšåŠ›</strong>çš„æ¨¡å—ï¼Œæ°´å¹³æ‹†åˆ†å…±äº«å±‚ä¸­çš„éƒ¨åˆ†ä»£ç ã€‚</p>

<p>æˆ‘æœ€è¿‘å¼€å‘çš„æ‰€æœ‰å¤§å‹åº”ç”¨ä¸­éƒ½æœ‰ä¸¤ä¸ªä¸åŒçš„åŠŸèƒ½ç»„ã€‚</p>

<p>ç¬¬ä¸€ä¸ªåŠŸèƒ½ç»„ä¸<strong>æ ¸å¿ƒä¸šåŠ¡</strong>åŠŸèƒ½ç›¸å…³ï¼šä¾‹å¦‚ï¼Œä¸€ä¸ªæ¨¡å—å›´ç»•äº§å“åˆ—è¡¨ï¼Œå¦ä¸€ä¸ªæ¨¡å—å›´ç»•äº§å“è¯¦æƒ…ï¼Œç¬¬ä¸‰ä¸ªæ¨¡å—å›´ç»•æ”¶è—äº§å“ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªåŠŸèƒ½ç»„å‘½åä¸º<strong>äº§å“</strong>ã€‚å¦ä¸€ä¸ªåŠŸèƒ½ç»„å›´ç»•<strong>æ”¯ä»˜ã€å¹¿å‘Šæˆ–è®¢é˜…</strong>ï¼Œæˆ–è€…æœ‰æ—¶æ˜¯è¿™äº›åŠŸèƒ½çš„ç»„åˆã€‚è¿™å…³ç³»åˆ°åº”ç”¨çš„ç›ˆåˆ©æ–¹å¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠŸèƒ½ç»„å‘½åä¸º<strong>â€œæ”¯ä»˜â€</strong>ã€‚</p>

<p>å¤§å‹åº”ç”¨ä¸­å¯èƒ½ä¼šæœ‰äº”ä¸ªæˆ–æ›´å¤šåŠŸèƒ½ç»„ã€‚æ¯ä¸ªåŠŸèƒ½ç»„å°†åŒ…å«é¢†åŸŸæ¨¡å—ã€æ•°æ®æ¨¡å—å’Œæ¼”ç¤ºæ¨¡å—ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>feature/Feature A
</span><span class='line'>
</span><span class='line'>feature/Feature B
</span><span class='line'>
</span><span class='line'>feature/Feature C
</span><span class='line'>
</span><span class='line'>feature/Feature D
</span><span class='line'>
</span><span class='line'>feature/Feature E
</span><span class='line'>
</span><span class='line'>feature/Feature F
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:data
</span><span class='line'>
</span><span class='line'>:domain
</span><span class='line'>
</span><span class='line'>:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:kotlin-base
</span></code></pre></td></tr></table></div></figure>


<h3>ä½•æ—¶ä½¿ç”¨å“ªä¸€æ­¥ï¼Ÿ</h3>

<p>ä½ è‚¯å®šå¸Œæœ›å°†å•ä½“åº”ç”¨ç”¨äºæ°¸è¿œä¸ä¼šæŠ•å…¥ç”Ÿäº§æˆ–ä¸€æ¬¡æ€§ä½¿ç”¨çš„åº”ç”¨ç¨‹åºã€‚è¿™äº›åº”ç”¨ç¨‹åºå¯ä»¥æ˜¯<strong>æ¦‚å¿µéªŒè¯</strong> (PoC, Proof of Concept) åº”ç”¨ç¨‹åºã€ç”¨äºç¬¬ä¸‰æ–¹é”™è¯¯çš„<strong>æœ€å°å¯å¤ç°ç¤ºä¾‹</strong> (MRE, Minimum Reproducible Example) åº”ç”¨ç¨‹åºï¼Œæˆ–ç”¨äºæ±‚èŒç”³è¯·çš„<strong>æµ‹è¯•æŒ‘æˆ˜</strong>åº”ç”¨ç¨‹åºã€‚</p>

<p>å¯¹äºæ‰€æœ‰å…¶ä»–æƒ…å†µï¼Œæˆ‘å»ºè®®å…ˆä»éƒ¨åˆ†æˆ–å®Œå…¨æ¨¡å—åŒ–å¼€å§‹ï¼Œç„¶åæ ¹æ®éœ€è¦å‡çº§åˆ°ä¸‹ä¸€æ­¥ï¼Œæˆ–è€…å°½å¯èƒ½æå‰å‡çº§ï¼Œä»¥å‡å°‘ä»¥åçš„éº»çƒ¦ã€‚</p>

<p>ä½ å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> ä»£ç åº“ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82</a></p>

<p>FlickSlate å°šæœªå‡çº§åˆ°åŠŸèƒ½ç»„ã€‚è¿™æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºå…±äº«å±‚è¿˜æ— æ³•æ‹†åˆ†ä¸ºåŠŸèƒ½ç»„ã€‚è¯¥åº”ç”¨æ²¡æœ‰ç›ˆåˆ©åŠŸèƒ½ï¼Œæ‰€ä»¥åªèƒ½å¯¹èŠ‚ç›®è¿›è¡Œåˆ†ç»„ï¼Œä¸è¿‡ç›®å‰å…±äº«å±‚å·²ç»å®Œç¾åœ°å®ç°äº†è¿™ä¸€ç‚¹ã€‚</p>

<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æºäºæˆ‘å¯¹äº’è”ç½‘ä¸Šå…³äºä½•æ—¶ä»¥åŠå¦‚ä½•æ¨¡å—åŒ–çš„å»ºè®®ä¸€æ¦‚è€Œè®ºçš„ä¸æ»¡ï¼šè¦ä¹ˆå»ºè®®ä¸åŠ åŒºåˆ†åœ°è¿›è¡Œæ¨¡å—åŒ–ï¼Œè¦ä¹ˆæœ‰äººå¯¹ä»»ä½•è¿›è¡Œæ¨¡å—åŒ–çš„äººå¤§å–Šâ€œè¿‡åº¦å·¥ç¨‹â€ã€‚æˆ‘å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ åœ¨ä½•æ—¶ä»¥åŠå¦‚ä½•è¿›è¡Œæ¨¡å—åŒ–æ–¹é¢åšå‡ºæ›´æ˜æ™ºçš„å†³å®šã€‚</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compose Unstyledï¼šCompose UIä¸­å¤±ä¼ â€‹â€‹çš„è®¾è®¡ç³»ç»Ÿå±‚]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/10/compose-unstyled/"/>
    <updated>2025-09-10T16:17:33+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/10/compose-unstyled</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCompose Unstyled: The missing Design System layer for Compose UIã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://composables.com/blog/introducing-compose-unstyled">https://composables.com/blog/introducing-compose-unstyled</a>ï¼Œç”±Alex Stylå‘å¸ƒäº2025å¹´8æœˆ7æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/10/compose-unstyled/"><img src="https://composables.com/og_unstyled.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>ä½¿ç”¨ Compose UI æ„å»ºåº”ç”¨çš„æœ€å¤§é—®é¢˜æ˜¯ Material Compose çš„çµæ´»æ€§ä¸è¶³ã€‚Material Compose çš„å¯å®šåˆ¶æ€§ä¸è¶³ä»¥è®©ä½ åœ¨å…¶ä¸Šæ„å»ºè‡ªå·±çš„è®¾è®¡ç³»ç»Ÿï¼Œå› æ­¤ä½ æœ€ç»ˆåªèƒ½å¯¹å…¶ç»„ä»¶è¿›è¡Œä¿®æ”¹ã€‚å¦ä¸€æ–¹é¢ï¼ŒCompose Foundation åˆè¿‡äºâ€œåŸå§‹â€â€”â€”å®ƒæœ‰è¡Œå’Œåˆ—ï¼Œä½†æ²¡æœ‰æŒ‰é’®æˆ–åº•éƒ¨è¡¨å•ã€‚è€Œä¸”ï¼Œç”±äºä¸»é¢˜è®¾ç½®ä¸ Material ç»‘å®šï¼Œå¦‚æœä¸å®Œå…¨éµå¾ª Material çš„è®¾è®¡å†³ç­–ï¼Œä½ ç”šè‡³æ— æ³•ä¸ºä½ çš„åº”ç”¨è®¾ç½®ä¸»é¢˜ã€‚</p>

<p>ä½ å¯ä»¥ä»å¤´å¼€å§‹æ„å»ºæ‰€æœ‰å†…å®¹ï¼Œä½†è°æœ‰æ—¶é—´è¿™æ ·åšå‘¢ï¼Ÿè€ƒè™‘åˆ°ä¸åŒçš„çŠ¶æ€ã€å¯è®¿é—®æ€§å’Œè¾¹ç¼˜æƒ…å†µï¼Œåƒåº•éƒ¨è¡¨å•è¿™æ ·çš„å•ä¸ªç»„ä»¶å¯èƒ½éœ€è¦ 3-4 å‘¨æ‰èƒ½å®Œæˆã€‚è¿™ä¸ªé—®é¢˜åœ¨ Compose Multiplatform ä¸­å˜å¾—æ›´åŠ ä¸¥é‡â€”â€”Material åœ¨ iOS ä¸Šçœ‹èµ·æ¥ç¬¨æ‹™ï¼Œåœ¨æ¡Œé¢ä¸Šæ˜¾å¾—ä¸æˆæ¯”ä¾‹ã€‚</p>

<p>æˆ‘éœ€è¦ä¸€ä¸ªçµæ´»çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥åœ¨ä»»ä½•å¹³å°ä¸Šä½¿ç”¨ï¼Œè€Œä¸å— Material çš„é™åˆ¶ã€‚äºæ˜¯æˆ‘æ’¸èµ·è¢–å­ï¼Œè‡ªå·±åŠ¨æ‰‹æ„å»ºäº†ä¸€ä¸ªï¼š</p>

<p><strong><a href="https://composables.com/docs/com.composables/core">Compose Unstyled</a> æ˜¯åŸºäº Compose Foundation çš„ APIï¼Œå¯è½»æ¾æ„å»ºä»»ä½•è®¾è®¡ç³»ç»Ÿ</strong> ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82%E5%AE%83%E6%8F%90%E4%BE%9B%E6%97%A0%E6%A0%B7%E5%BC%8F%E3%80%81%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89%E7%81%B5%E6%B4%BB%E7%9A%84%E4%B8%BB%E9%A2%98">https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82%E5%AE%83%E6%8F%90%E4%BE%9B%E6%97%A0%E6%A0%B7%E5%BC%8F%E3%80%81%E5%8F%AF%E8%AE%BF%E9%97%AE%E7%9A%84%E7%BB%84%E4%BB%B6%EF%BC%8C%E5%B9%B6%E9%85%8D%E6%9C%89%E7%81%B5%E6%B4%BB%E7%9A%84%E4%B8%BB%E9%A2%98</a> APIâ€”â€”æ‰€æœ‰å…³äºç”¨æˆ·ä½“éªŒå’Œå¯è®¿é—®æ€§çš„ç¹çå·¥ä½œéƒ½å·²ä¸ºä½ å¤„ç†ã€‚</p>

<p>Unstyled ä¸­çš„ç»„ä»¶å®Œå…¨æ— éœ€æ¸²æŸ“ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåœ¨å±å¹•ä¸Šæ˜¾ç¤ºä»»ä½•å†…å®¹ã€‚ä½ å¯ä»¥å°†å®ƒä»¬è§†ä¸ºâ€œç»„ä»¶æ¨¡å¼â€ï¼Œå®ƒä»¬å°†â€œåº•éƒ¨è¡¨å•â€æˆ–â€œè¿›åº¦æ¡â€çš„æ¦‚å¿µå¼•å…¥ä½ çš„åº”ç”¨ï¼Œè€Œæ— éœ€ä½ æ‹…å¿ƒç”¨æˆ·ä½“éªŒã€é”®ç›˜å¯¼èˆªæˆ–å¯è®¿é—®æ€§å®ç°ã€‚åªéœ€æ·»åŠ æ ·å¼å³å¯ã€‚</p>

<h2>ç®€æ´çš„ APIï¼Œæä¾›ä½ æ‰€éœ€çš„æ ·å¼</h2>

<p>Compose Unstyled ä¸æä¾›ä»»ä½•ç‰¹æ®Šçš„æ ·å¼ APIã€‚æ‰€æœ‰æ“ä½œéƒ½é€šè¿‡ <code>Modifier</code> å®Œæˆã€‚å¦‚æœä½ çŸ¥é“å¦‚ä½•è®¾ç½® <code>Box()</code> çš„æ ·å¼ï¼Œé‚£ä¹ˆä½ å°±çŸ¥é“å¦‚ä½•è®¾ç½® Compose Unstyled ä¸­æ¯ä¸ªç»„ä»¶çš„æ ·å¼ã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Compose Unstyled æ„å»ºæ¨¡æ€åº•éƒ¨è¡¨å•çš„ç®€å•ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…å«è‡ªå®šä¹‰å®šä½ç‚¹ï¼ˆè¡¨å•åœ¨å±å¹•ä¸Šâ€œåœç•™â€çš„ä½ç½®ï¼‰ä»¥åŠä½ é€‰æ‹©çš„æ ·å¼ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">Peek</span> <span class="p">=</span> <span class="n">SheetDetent</span><span class="p">(</span><span class="s">&quot;peek&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">containerHeight</span><span class="p">,</span> <span class="n">sheetHeight</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">containerHeight</span> <span class="p">*</span> <span class="m">0.6f</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">BoxWithConstraints</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Brush</span><span class="p">.</span><span class="n">linearGradient</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF800080</span><span class="p">),</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFDA70D6</span><span class="p">)))))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">modalSheetState</span> <span class="p">=</span> <span class="n">rememberModalBottomSheetState</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialDetent</span> <span class="p">=</span> <span class="n">Hidden</span><span class="p">,</span>
</span><span class='line'>        <span class="n">detents</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="n">Hidden</span><span class="p">,</span> <span class="n">Peek</span><span class="p">,</span> <span class="n">FullyExpanded</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span>
</span><span class='line'>        <span class="n">modalSheetState</span><span class="p">.</span><span class="n">targetDetent</span> <span class="p">=</span> <span class="n">Peek</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">modalSheetState</span><span class="p">.</span><span class="n">targetDetent</span> <span class="p">=</span> <span class="n">Peek</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="n">WindowInsets</span><span class="p">.</span><span class="n">navigationBars</span><span class="p">.</span><span class="n">only</span><span class="p">(</span><span class="n">WindowInsetsSides</span><span class="p">.</span><span class="n">Horizontal</span><span class="p">).</span><span class="n">asPaddingValues</span><span class="p">()),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">6.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">14.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">),</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Show Sheet&quot;</span><span class="p">,</span> <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">(</span><span class="m">500</span><span class="p">))</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isCompact</span> <span class="p">=</span> <span class="n">maxWidth</span> <span class="p">&lt;</span> <span class="m">600.</span><span class="n">dp</span>
</span><span class='line'>    <span class="n">ModalBottomSheet</span><span class="p">(</span><span class="n">state</span> <span class="p">=</span> <span class="n">modalSheetState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Scrim</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scrimColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">enter</span> <span class="p">=</span> <span class="n">fadeIn</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">exit</span> <span class="p">=</span> <span class="n">fadeOut</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">12.</span><span class="n">dp</span><span class="p">).</span><span class="n">let</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="n">isCompact</span><span class="p">)</span> <span class="n">it</span> <span class="k">else</span> <span class="n">it</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">56.</span><span class="n">dp</span><span class="p">)</span> <span class="p">}.</span><span class="n">displayCutoutPadding</span><span class="p">().</span><span class="n">statusBarsPadding</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">WindowInsets</span><span class="p">.</span><span class="n">navigationBars</span><span class="p">.</span><span class="n">only</span><span class="p">(</span><span class="n">WindowInsetsSides</span><span class="p">.</span><span class="n">Horizontal</span><span class="p">).</span><span class="n">asPaddingValues</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Sheet</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">topStart</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">,</span> <span class="n">topEnd</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">widthIn</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="m">640.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="n">topStart</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">,</span> <span class="n">topEnd</span> <span class="p">=</span> <span class="m">28.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>                <span class="n">contentColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">600.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">TopCenter</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">DragIndication</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">22.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.4f</span><span class="p">),</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">100</span><span class="p">)).</span><span class="n">width</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">).</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œæˆ‘çŸ¥é“ä½ å¯èƒ½ä¼šæƒ³ã€‚â€œAlexï¼è¿™ API çœŸå¥‡æ€ªã€‚ä¸ºä»€ä¹ˆæˆ‘éœ€è¦ä¸€ä¸ª <code>ModalBottomSheet</code> å’Œä¸€ä¸ª <code>Sheet</code>ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ Slots å‘¢ï¼Ÿâ€</p>

<p>è¿™ä¸ªè®¾è®¡é€‰æ‹©æ˜¯ç»è¿‡æ·±æ€ç†Ÿè™‘çš„ï¼š</p>

<h2>è®¾è®¡ç†å¿µ</h2>

<p>Compose Unstyled ä¸ä¼šæ›¿ä½ åšå‡ºä»»ä½•è®¾è®¡å†³ç­–ï¼Œè€Œæ˜¯è®©ä½ å®Œå…¨æŒæ§å¸ƒå±€ã€‚äº‹å®ä¸Šï¼Œå¦‚æœä½ è¢«è¿«ä½¿ç”¨æ— æ³•æ ¹æ®éœ€æ±‚æ›´æ”¹çš„æ ·å¼ï¼Œåˆ™ä¼šè¢«è§†ä¸ºé”™è¯¯ï¼ˆè¯·æäº¤ GitHub é—®é¢˜ï¼Œä»¥ä¾¿æˆ‘è¿›è¡Œè°ƒæŸ¥ï¼‰ã€‚</p>

<p>ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›å°†åº•éƒ¨è¡¨å•æ”¾ç½®åœ¨å±å¹•çš„å·¦ä¾§æˆ–å³ä¾§ã€‚å½“ä½ æƒ³è¦æ±‚å¼€å‘è€…æä¾›ä¸€ä¸ªåœ¨å¸ƒå±€ä¸Šå…·æœ‰ä¸¥æ ¼ä½ç½®çš„ç»„ä»¶æ—¶ï¼ŒåŸºäºæ’æ§½çš„ API éå¸¸å®ç”¨ã€‚</p>

<p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥å°† <code>ModalBottomSheet</code> ç»„ä»¶è§†ä¸ºè¡¨å•å¯ä»¥ç§»åŠ¨çš„åŒºåŸŸã€‚<code>Sheet</code> æ˜¯ç”¨æˆ·å¯ä»¥ä¸ä¹‹äº¤äº’çš„å®é™…è¡¨å•ã€‚é€šè¿‡æä¾›è¿™æ ·çš„ç»„ä»¶ï¼Œå®ƒä¸ºå¼€å‘è€…æä¾›äº†æ¸…æ™°çš„ APIï¼Œå¹¶æ¸…æ¥šåœ°è¯´æ˜äº†ç»„ä»¶çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼Œ<code>Scrim()</code> ç»„ä»¶å…·æœ‰ <em>enter</em> å’Œ <em>exit</em> è¿‡æ¸¡å‚æ•°ã€‚ Compose Unstyled ä¼šåœ¨æ°å½“çš„æ—¶æœºä¸ºçº±å¹•æ·»åŠ å’Œéšè—åŠ¨ç”»ï¼Œä»¥å®ç°æœ€ä½³ç”¨æˆ·ä½“éªŒã€‚ä½ åªéœ€æŒ‡å®šâ€œå¦‚ä½•â€å®ç°å³å¯ã€‚</p>

<p>ç”±äº Compose Unstyled åœ¨å¤–è§‚æ–¹é¢éå¸¸å¼€æ”¾ï¼Œå› æ­¤ä¸åŸå§‹çš„ Compose Foundation ç»„ä»¶ç›¸æ¯”ï¼Œå®ƒæ²¡æœ‰ä»»ä½•å¹³å°é™åˆ¶ã€‚Foundation ä¸­çš„â€œå¯¹è¯æ¡†â€å…·æœ‰å›ºå®šçš„æœ€å¤§å°ºå¯¸ï¼Œè¿™ä½¿å¾—å®ƒä»¬åœ¨è¯¸å¦‚å…¨å±å¯¹è¯æ¡†ç­‰æƒ…å†µä¸‹éš¾ä»¥å·¥ä½œã€‚</p>

<p>Compose Unstyled ä¸­çš„æ‰€æœ‰ç»„ä»¶åœ¨æ‰€æœ‰å¹³å°ä¸Šçš„å·¥ä½œæ–¹å¼å®Œå…¨ç›¸åŒã€‚è¿™æ˜¯æœ‰æ„ä¸ºä¹‹ï¼Œå› ä¸ºæ­¤ç±»å†³ç­–åº”è¯¥å±äºè®¾è®¡ç³»ç»Ÿå±‚çš„ä¸€éƒ¨åˆ†ã€‚å°½ç®¡è¿™ä¼šç»™å¼€å‘è€…å¸¦æ¥æ›´å¤šè´Ÿæ‹…ï¼Œä½†ç”±äºæ²¡æœ‰â€œé™·é˜±â€ï¼Œå®ƒå¤§å¤§ç¼©çŸ­äº†å¼€å‘æ—¶é—´ã€‚ç»„ä»¶çš„æ ·å¼ä¸ä½ æè¿°çš„å®Œå…¨ä¸€è‡´ã€‚</p>

<p>è¿™ä¸ä¼šä½¿ Compose Unstyled ä¸åº•å±‚å¹³å°è„±èŠ‚ã€‚åœ¨ä½¿ç”¨å¯¹è¯æ¡†å’Œæ¨¡æ€åº•éƒ¨èœå•ç­‰æ¨¡æ€çª—å£æ—¶ï¼Œè®¾ç½®ç³»ç»Ÿçª—å£çš„æ ·å¼æ˜¯ Android æ ·å¼è®¾ç½®çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCompose Unstyled æä¾›äº†ä¸€ä¸ª <code>LocalModalWindow</code> ç»„åˆæœ¬åœ°æ¥å£ï¼Œå…è®¸ä½ è®¿é—®æ¸²æŸ“æ¨¡æ€çª—å£çš„ <code>Window</code>ã€‚è¯·æ³¨æ„ï¼Œæ­¤ç±» API ä»…é€‚ç”¨äº Android ç›®æ ‡å¹³å°ï¼Œä¸å±äºé€šç”¨ç›®æ ‡å¹³å° APIã€‚</p>

<p>æœ€åï¼Œæ¯ä¸ªç»„ä»¶çš„ä»£ç éƒ½åŒ…å«åœ¨å…¶è‡ªå·±çš„æ–‡ä»¶ä¸­ï¼Œå³ä½¿ä½ ä¸æ˜¯ Compose ä¸“å®¶ï¼Œä¹Ÿèƒ½è½»æ¾ç†è§£ã€‚ä½ æ— éœ€æ‹…å¿ƒä»»ä½•é™åˆ¶ã€‚å¦‚æœä½ ç°åœ¨éœ€è¦æ›´æ”¹æŸäº›å†…å®¹ï¼Œå¹¶ä¸”è¿«ä¸åŠå¾…åœ°æƒ³è¦æäº¤é”™è¯¯å¹¶åœ¨åº“çº§åˆ«ä¿®å¤å®ƒï¼Œä½ åªéœ€å°†ç»„ä»¶çš„å•ä¸ªæ–‡ä»¶å¤åˆ¶ç²˜è´´åˆ°ä½ çš„ä»£ç åº“ä¸­å³å¯ã€‚è¿™ä¸ºä½ èŠ‚çœäº†é€šå¸¸éœ€è¦ä½ è‡ªå·±å®Œæˆçš„ 4 å‘¨å·¥ä½œæ—¶é—´ã€‚</p>

<h2>æ»‘å—</h2>

<p>ä»¥ä¸‹æ˜¯å¦‚ä½•æ„å»ºä¸€ä¸ªå…·æœ‰ä½ æ‰€é€‰æ ·å¼çš„æ»‘å—ã€‚</p>

<p>å®ƒä¸ Compose çš„â€œInteractionStateâ€é›†æˆï¼Œä»¥ä¾¿ä½ å¯ä»¥æŒ‰ç…§è‡ªå·±æƒ³è¦çš„æ–¹å¼å®Œå–„ç»„ä»¶ã€‚é”®ç›˜äº¤äº’åŠŸèƒ½å¼€ç®±å³ç”¨ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æŒ‰ä¸‹é”®ç›˜ä¸Šçš„â€œå‘ä¸Šâ€æˆ–â€œå‘ä¸‹â€é”®æ¥å¢åŠ æˆ–å‡å°‘å€¼ï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-1.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Brush</span><span class="p">.</span><span class="n">linearGradient</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFED213A</span><span class="p">),</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF93291E</span><span class="p">)))),</span>   <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isFocused</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsFocusedAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isPressed</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsPressedAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">rememberSliderState</span><span class="p">(</span><span class="n">initialValue</span> <span class="p">=</span> <span class="m">0.7f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Row</span><span class="p">(</span><span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">,</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">).</span><span class="n">widthIn</span><span class="p">(</span><span class="n">max</span> <span class="p">=</span> <span class="m">480.</span><span class="n">dp</span><span class="p">).</span><span class="n">fillMaxWidth</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span> <span class="p">-=</span> <span class="m">0.1f</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">VolumeDown</span><span class="p">,</span> <span class="s">&quot;Decrease&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Slider</span><span class="p">(</span>
</span><span class='line'>            <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span><span class="p">,</span>
</span><span class='line'>            <span class="n">state</span> <span class="p">=</span> <span class="n">state</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">track</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// the &#39;not yet completed&#39; part of the track</span>
</span><span class='line'>                    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxHeight</span><span class="p">().</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF93291E</span><span class="p">)))</span>
</span><span class='line'>                    <span class="c1">// the &#39;completed&#39; part of the track</span>
</span><span class='line'>                    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxHeight</span><span class="p">().</span><span class="n">fillMaxWidth</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">thumb</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">thumbSize</span> <span class="k">by</span> <span class="n">animateDpAsState</span><span class="p">(</span><span class="n">targetValue</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">isPressed</span><span class="p">)</span> <span class="m">22.</span><span class="n">dp</span> <span class="k">else</span> <span class="m">18.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">thumbInteractionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">isHovered</span> <span class="k">by</span> <span class="n">thumbInteractionSource</span><span class="p">.</span><span class="n">collectIsHoveredAsState</span><span class="p">()</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">glowColor</span> <span class="k">by</span> <span class="n">animateColorAsState</span><span class="p">(</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">isFocused</span> <span class="p">||</span> <span class="n">isHovered</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.33f</span><span class="p">)</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Transparent</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="c1">// keep the size fixed to ensure that the resizing animation is always centered</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">36.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">CircleShape</span><span class="p">).</span><span class="n">background</span><span class="p">(</span><span class="n">glowColor</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Thumb</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="n">thumbSize</span><span class="p">).</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">).</span><span class="n">hoverable</span><span class="p">(</span><span class="n">thumbInteractionSource</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span> <span class="p">+=</span> <span class="m">0.1f</span> <span class="p">},</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">VolumeUp</span><span class="p">,</span> <span class="s">&quot;Increase&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ä¸‹æ‹‰èœå•</h2>

<p>ä¸‹æ‹‰èœå•çš„æ­£ç¡®å®ç°éå¸¸å¤æ‚ï¼Œå°¤å…¶æ˜¯åœ¨é”®ç›˜å¯¼èˆªå’Œç„¦ç‚¹ç®¡ç†æ–¹é¢ã€‚</p>

<p>è¦å……åˆ†ä½“éªŒæ­¤ç»„ä»¶ï¼Œè¯·åœ¨æ¡Œé¢ä¸Šè¯•ç”¨ï¼šç‚¹å‡»â€œOptionsâ€æŒ‰é’®ä»¥èšç„¦æ¼”ç¤ºï¼Œç„¶åä½¿ç”¨é”®ç›˜çš„ä¸Šä¸‹ç®­å¤´é”®è¿›è¡Œå¯¼èˆªï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-2.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DropdownOption</span><span class="p">(</span><span class="k">val</span> <span class="py">text</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">icon</span><span class="p">:</span> <span class="n">ImageVector</span><span class="p">,</span> <span class="k">val</span> <span class="py">enabled</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="k">val</span> <span class="py">dangerous</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">options</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Select All&quot;</span><span class="p">,</span> <span class="n">Maximize</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Copy&quot;</span><span class="p">,</span> <span class="n">Copy</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Cut&quot;</span><span class="p">,</span> <span class="n">Scissors</span><span class="p">,</span> <span class="n">enabled</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Paste&quot;</span><span class="p">,</span> <span class="n">Clipboard</span><span class="p">),</span>
</span><span class='line'>    <span class="n">DropdownOption</span><span class="p">(</span><span class="s">&quot;Delete&quot;</span><span class="p">,</span> <span class="n">Trash2</span><span class="p">,</span> <span class="n">dangerous</span> <span class="p">=</span> <span class="k">true</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="k">var</span> <span class="py">expanded</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">DropdownMenu</span><span class="p">(</span><span class="n">onExpandRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">true</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Button</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">6.</span><span class="n">dp</span><span class="p">),</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">true</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">14.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Options&quot;</span><span class="p">,</span> <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">(</span><span class="m">500</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span><span class="n">ChevronDown</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">DropdownMenuPanel</span><span class="p">(</span>
</span><span class='line'>        <span class="n">expanded</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">240.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">enter</span> <span class="p">=</span> <span class="n">scaleIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">120</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">LinearOutSlowInEasing</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialScale</span> <span class="p">=</span> <span class="m">0.8f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">transformOrigin</span> <span class="p">=</span> <span class="n">TransformOrigin</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">0f</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">+</span> <span class="n">fadeIn</span><span class="p">(</span><span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">30</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">exit</span> <span class="p">=</span> <span class="n">scaleOut</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">delayMillis</span> <span class="p">=</span> <span class="m">75</span><span class="p">),</span> <span class="n">targetScale</span> <span class="p">=</span> <span class="m">1f</span><span class="p">)</span> <span class="p">+</span> <span class="n">fadeOut</span><span class="p">(</span><span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">75</span><span class="p">))</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">options</span><span class="p">.</span><span class="n">forEachIndexed</span> <span class="p">{</span> <span class="n">index</span><span class="p">,</span> <span class="n">option</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="p">==</span> <span class="m">1</span> <span class="p">||</span> <span class="n">index</span> <span class="p">==</span> <span class="n">options</span><span class="p">.</span><span class="n">lastIndex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Separator</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFBDBDBD</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">expanded</span> <span class="p">=</span> <span class="k">false</span> <span class="p">},</span> <span class="n">enabled</span> <span class="p">=</span> <span class="n">option</span><span class="p">.</span><span class="n">enabled</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">vertical</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">),</span> <span class="n">contentColor</span> <span class="p">=</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">dangerous</span><span class="p">)</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFC62828</span><span class="p">)</span> <span class="k">else</span> <span class="n">LocalContentColor</span><span class="p">.</span><span class="n">current</span><span class="p">).</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="m">1f</span> <span class="k">else</span> <span class="m">0.5f</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Icon</span><span class="p">(</span><span class="n">option</span><span class="p">.</span><span class="n">icon</span><span class="p">,</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="n">text</span> <span class="p">=</span> <span class="n">option</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">horizontal</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥åŠæ›´å¤šæœªæ ·å¼åŒ–çš„ç»„ä»¶ï¼Œä¾‹å¦‚ï¼š</p>

<ul>
<li><a href="https://composables.com/docs/com.composables/core/textfield">TextField</a>ï¼Œå…¨é¢æ”¯æŒå±å¹•é˜…è¯»å™¨çš„æ— éšœç¢åŠŸèƒ½</li>
<li><a href="https://composables.com/docs/com.composables/core/button">Button</a></li>
<li><a href="https://composables.com/docs/com.composables/core/dialog">Dialog</a></li>
<li><a href="https://composables.com/docs/com.composables/core/radiogroup">Radio Group</a></li>
<li><a href="https://composables.com/docs/com.composables/core/tabgroup">TabGroup</a>ï¼Œç”¨äºæ„å»ºæ ‡ç­¾å¼å¯¼èˆªï¼Œä¾‹å¦‚åº•éƒ¨åº”ç”¨æ æˆ–é¡¶éƒ¨æ ‡ç­¾æ¡Œé¢</li>
<li><a href="https://composables.com/docs/com.composables/core/checkbox">å¤é€‰æ¡†</a></li>
<li><a href="https://composables.com/docs/com.composables/core/tristatecheckbox">ä¸‰æ€å¤é€‰æ¡†</a></li>
<li><a href="https://composables.com/docs/com.composables/core/toggleswitch">åˆ‡æ¢å¼€å…³</a></li>
<li><a href="https://composables.com/docs/com.composables/core/scrollarea">æ»šåŠ¨æ¡</a>ï¼ˆæ²¡é”™ï¼Œå°±æ˜¯æ»šåŠ¨æ¡ã€‚ï¼‰</li>
</ul>


<p>æ¯ä¸ªç»„ä»¶åœ¨æ„å»ºæ—¶éƒ½å……åˆ†è€ƒè™‘äº†å¯è®¿é—®æ€§ï¼ŒåŒ…æ‹¬åˆç†çš„è¯­ä¹‰å’Œå®Œæ•´çš„é”®ç›˜å¯¼èˆªæ”¯æŒã€‚</p>

<p>ä½ å¯ä»¥<a href="https://composables.com/docs/com.composables/core">åœ¨æ–‡æ¡£ä¸­æ‰¾åˆ°å®Œæ•´çš„ç»„ä»¶åˆ—è¡¨ -></a>ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82">https://composables.com/docs/com.composables/core%EF%BC%89%E3%80%82</a></p>

<h2>ä½¿ç”¨ä½ çš„è®¾è®¡ä»¤ç‰Œè‡ªå®šä¹‰ Compose ä¸»é¢˜</h2>

<p>Compose Unstyled åŒ…å«ä¸€ä¸ªçµæ´»çš„ä¸»é¢˜ç³»ç»Ÿï¼Œå¯ä¸ä»»ä½•è®¾è®¡ç³»ç»Ÿä»¤ç‰Œå…¼å®¹ã€‚</p>

<p>ä»¥ä¸‹æ˜¯å¦‚ä½•ä½¿ç”¨ä½ é€‰æ‹©çš„è®¾è®¡ä»¤ç‰Œåˆ›å»ºå®Œå…¨è‡ªå®šä¹‰çš„ä¸»é¢˜ï¼š</p>

<p>ä»¥ä¸‹æ˜¯åˆ›å»º Compose Theme å‡½æ•°çš„ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// define your theme properties</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">colors</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;colors&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">typography</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;typography&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">shapes</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;shapes&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">elevation</span> <span class="p">=</span> <span class="n">ThemeProperty</span><span class="p">&lt;</span><span class="n">Dp</span><span class="p">&gt;(</span><span class="s">&quot;elevation&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">// define your theme tokens.</span>
</span><span class='line'><span class="c1">// those are the potential values of your theme properties</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">background</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;background&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">card</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;surface&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onCard</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onCard&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">outline</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;outline&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">accent</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;accent&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">primary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;primary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onPrimary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onPrimary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">onSecondary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;onSecondary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">secondary</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Color</span><span class="p">&gt;(</span><span class="s">&quot;secondary&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">subtle</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Dp</span><span class="p">&gt;(</span><span class="s">&quot;subtle&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">titleMedium</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;titleMedium&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">bodyMedium</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">TextStyle</span><span class="p">&gt;(</span><span class="s">&quot;bodyMedium&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">cardShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;cardShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">albumCoverShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;albumCoverShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">buttonShape</span> <span class="p">=</span> <span class="n">ThemeToken</span><span class="p">&lt;</span><span class="n">Shape</span><span class="p">&gt;(</span><span class="s">&quot;buttonShape&quot;</span><span class="p">)</span>
</span><span class='line'><span class="c1">// create your Compose Theme and assign values to each token</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">LightTheme</span> <span class="p">=</span> <span class="n">buildTheme</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;LightTheme&quot;</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">colors</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">accent</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span>
</span><span class='line'>        <span class="n">card</span> <span class="n">to</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">onCard</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF1E293B</span><span class="p">),</span>
</span><span class='line'>        <span class="n">outline</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFE2E8F0</span><span class="p">),</span>
</span><span class='line'>        <span class="n">primary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF2563EB</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onPrimary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>        <span class="n">secondary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFE2E8F0</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onSecondary</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF64748B</span><span class="p">),</span>
</span><span class='line'>        <span class="n">background</span> <span class="n">to</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF8F9FA</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">typography</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">titleMedium</span> <span class="n">to</span> <span class="n">TextStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">fontSize</span> <span class="p">=</span> <span class="m">18.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">SemiBold</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontFamily</span> <span class="p">=</span> <span class="n">loadInterFont</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">bodyMedium</span> <span class="n">to</span> <span class="n">TextStyle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">fontSize</span> <span class="p">=</span> <span class="m">14.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Normal</span><span class="p">,</span>
</span><span class='line'>            <span class="n">fontFamily</span> <span class="p">=</span> <span class="n">loadInterFont</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">shapes</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">cardShape</span> <span class="n">to</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">albumCoverShape</span> <span class="n">to</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">buttonShape</span> <span class="n">to</span> <span class="n">CircleShape</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">properties</span><span class="p">[</span><span class="n">elevation</span><span class="p">]</span> <span class="p">=</span> <span class="n">mapOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">subtle</span> <span class="n">to</span> <span class="m">8.</span><span class="n">dp</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨æ–°çš„ä¸»é¢˜å‡½æ•°åŒ…è£…ä½ çš„åº”ç”¨ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MusicPlayerApp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LightTheme</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">MusicPlayerCard</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç„¶åï¼Œå®ƒä¼šä½¿ç”¨ <code>Theme</code> å¯¹è±¡æˆäºˆå…¶å­ç»„ä»¶å¯¹ä¸»é¢˜çš„è®¿é—®æƒé™ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MusicPlayerCard</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">sliderState</span> <span class="p">=</span> <span class="n">rememberSliderState</span><span class="p">(</span><span class="n">initialValue</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">outline</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">shadow</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">elevation</span><span class="p">][</span><span class="n">subtle</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">card</span><span class="p">],</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">cardShape</span><span class="p">])</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ProvideContentColor</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onCard</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Column</span><span class="p">(</span><span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span><span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">,</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">spacedBy</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">Res</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">just_hoist_it_cover</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">albumCoverShape</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">primary</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">80.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Album Cover&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">contentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Just hoist it!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">typography</span><span class="p">][</span><span class="n">titleMedium</span><span class="p">])</span>
</span><span class='line'>                        <span class="n">Spacer</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;The Deprecated&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">style</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">typography</span><span class="p">][</span><span class="n">bodyMedium</span><span class="p">],</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onSecondary</span><span class="p">]</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">Slider</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">state</span> <span class="p">=</span> <span class="n">sliderState</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">track</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">height</span><span class="p">(</span><span class="m">4.</span><span class="n">dp</span><span class="p">).</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>                            <span class="c1">// the empty part of the track</span>
</span><span class='line'>                            <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">secondary</span><span class="p">]))</span>
</span><span class='line'>                            <span class="c1">// the filled part of the track</span>
</span><span class='line'>                            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(</span><span class="n">sliderState</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">background</span><span class="p">(</span><span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">accent</span><span class="p">])</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>                    <span class="n">thumb</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Thumb</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">accent</span><span class="p">],</span>
</span><span class='line'>                            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                            <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">]</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span> <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">SpaceEvenly</span><span class="p">,</span> <span class="n">verticalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterVertically</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">SkipBack</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Previous&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">backgroundColor</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">primary</span><span class="p">],</span> <span class="n">contentColor</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">colors</span><span class="p">][</span><span class="n">onPrimary</span><span class="p">],</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">Pause</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Pause&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="p">},</span> <span class="n">contentPadding</span> <span class="p">=</span> <span class="n">PaddingValues</span><span class="p">(</span><span class="m">12.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">Theme</span><span class="p">[</span><span class="n">shapes</span><span class="p">][</span><span class="n">buttonShape</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Icon</span><span class="p">(</span><span class="n">imageVector</span> <span class="p">=</span> <span class="n">Lucide</span><span class="p">.</span><span class="n">SkipForward</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Next&quot;</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>è½®å»“ä¿®é¥°ç¬¦</h2>

<p>æœ€åä½†åŒæ ·é‡è¦çš„æ˜¯ï¼ŒCompose Unstyled å¼•å…¥äº†ä¸€äº› Compose Foundation ä¸­ç¼ºå°‘çš„æ ·å¼ <code>Modifier</code>ï¼Œä½†è¿™äº›ä¿®é¥°ç¬¦å¯¹äºæ„å»ºè§†è§‰ä¸°å¯Œçš„ç•Œé¢å¿…ä¸å¯å°‘ï¼š</p>

<h3>è½®å»“</h3>

<p>ä¸ Compose Foundation çš„ <code>border()</code> ä¿®é¥°ç¬¦ä¸åŒï¼Œæ­¤ä¿®é¥°ç¬¦ä¸ä¼šå½±å“å¸ƒå±€ã€‚å®ƒè¿˜ä¼šåœ¨ç»„ä»¶å‘¨å›´è€Œä¸æ˜¯å†…éƒ¨è¿›è¡Œç»˜åˆ¶ã€‚å½“ä½ éœ€è¦ä¸€ä¸ªä¸é˜´å½±å®Œç¾èåˆçš„åŠé€æ˜è½®å»“æ—¶ï¼Œè¿™ä¸ªåŠŸèƒ½éå¸¸æ–¹ä¾¿ï¼š</p>

<p><img src="file:///Users/alexhilton/Downloads/compose-style-3.png" alt="" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span><span class="p">,</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>  <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">,</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">outline</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">CircleShape</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ç„¦ç‚¹ç¯</h3>

<p>ç„¦ç‚¹ç¯åœ¨å¤„ç†é”®ç›˜å¯¼èˆªå’Œç„¦ç‚¹æ—¶éå¸¸é‡è¦ã€‚å®ƒä»¬åªæœ‰åœ¨è·å¾—ç„¦ç‚¹æ—¶æ‰ä¼šæ¸²æŸ“è½®å»“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="n">SimpleButton</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">focusRing</span><span class="p">(</span>
</span><span class='line'>        <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span><span class="p">,</span>
</span><span class='line'>        <span class="n">width</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF3B82F6</span><span class="p">),</span>
</span><span class='line'>        <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span>
</span><span class='line'>    <span class="p">),</span>
</span><span class='line'>    <span class="n">interactionSource</span> <span class="p">=</span> <span class="n">interactionSource</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>ç„¶åå‘¢ï¼Ÿ</h2>

<p>å³å°†æ¨å‡ºçš„ç»„ä»¶åŒ…æ‹¬ï¼š</p>

<ul>
<li>ä¾§è¾¹æ </li>
<li>å·¥å…·æç¤º</li>
<li>ä¸Šä¸‹æ–‡èœå•</li>
</ul>


<p>ä»¥åŠæ›´å¤šã€‚</p>

<p>å¦‚æœä½ æ„¿æ„ä¸ºè¯¥é¡¹ç›®æä¾›èµ„é‡‘æ”¯æŒï¼Œæˆ‘ä»¬è¿˜æä¾›<a href="https://composables.com/ui-kit">æ­£åœ¨åˆ¶ä½œä¸­çš„ UI Kit</a>ï¼ˆé“¾æ¥ï¼š<a href="https://composables.com/ui-kit%EF%BC%89%E3%80%82%E8%AF%A5">https://composables.com/ui-kit%EF%BC%89%E3%80%82%E8%AF%A5</a> UI Kit æ˜¯ä¸€å¥—å®Œæ•´çš„è®¾è®¡ç³»ç»Ÿï¼Œé€‚ç”¨äºè§¦æ§å’ŒæŒ‡é’ˆåº”ç”¨ã€‚</p>

<p>ä¸ºäº†ä½¿è¿™äº› API å®Œç¾æ— ç¼ºï¼Œæˆ‘ä»¬æŠ•å…¥äº†å¤§é‡çš„å·¥ä½œå’Œä¸“ä¸šçŸ¥è¯†ã€‚é€šè¿‡èµ„é‡‘æ”¯æŒè¯¥é¡¹ç›®ï¼Œä½ å°†åœ¨æœªæ¥å‡ å¹´è·å¾—æ›´å¤šèµ„æºï¼Œè€Œæˆ‘åˆ™å¯ä»¥ç»§ç»­ä»äº‹å¼€æºå·¥ä½œï¼ŒåŒæ—¶æ”¯ä»˜æˆ¿ç§Ÿã€‚</p>

<p>æƒ³è¦éšæ—¶äº†è§£æœ€æ–°åŠ¨æ€ï¼Ÿè¯·åŠ¡å¿…<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/">åœ¨ Github ä¸Šå…³æ³¨ Unstyled</a>ï¼ˆé“¾æ¥:<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/%EF%BC%89%E3%80%82">https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/%EF%BC%89%E3%80%82</a></p>

<p>æƒ³è¦è¯„è®ºè¿™ç¯‡æ–‡ç« å—ï¼Ÿ<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106">åœ¨ GitHub ä¸Šè®¨è®º â†’</a>ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106%EF%BC%89">https://github.com/composablehorizo%E2%80%8B%E2%80%8Bns/compose-unstyled/discussions/106%EF%BC%89</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[è¿è¡Œæ—¶ç€è‰²å™¨å®æˆ˜ï¼šå®ç°å…ƒçƒï¼ˆMetaballsï¼‰åŠ¨æ•ˆ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders/"/>
    <updated>2025-09-06T15:19:16+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒMetaballs with Runtimeshadersã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/metaballs-with-runtimeshaders-bb7e5f6b27c2">https://medium.com/@off.mind.by/metaballs-with-runtimeshaders-bb7e5f6b27c2</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025810ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/06/metaballs-with-runtimeshaders/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*fQOua40zD_PlbsejLeHBeg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä»Šå¤©æˆ‘æƒ³å‘å¤§å®¶ä»‹ç»ä¸€ç§æœ€ç®€å•å´åˆå‡ºäººæ„æ–™åœ°ä»¤äººå°è±¡æ·±åˆ»çš„æ•ˆæœï¼šå…ƒçƒã€‚</p>

<p>å…ƒçƒæ˜¯ä¸€ç§çœ‹èµ·æ¥åƒæœ‰æœºä½“çš„å½¢çŠ¶ï¼Œå…¶ç‰¹ç‚¹æ˜¯å®ƒä»¬èƒ½å¤Ÿåœ¨è¿‘è·ç¦»å†…èåˆåœ¨ä¸€èµ·ï¼Œå½¢æˆå•ä¸ªè¿ç»­çš„ç‰©ä½“ã€‚</p>

<p>ä½¿ç”¨ GLSL ç€è‰²å™¨åˆ›å»ºè¿™ç§æ•ˆæœéå¸¸ç®€å•ï¼Œåªéœ€å‡ è¡Œä»£ç å³å¯ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°å…³äºå¦‚ä½•å°†å…¶ç§»æ¤åˆ° AGSL å¹¶åœ¨ Compose ä¸­ä½¿ç”¨çš„æ•™ç¨‹ã€‚ç„¶è€Œï¼Œä¸»è¦çš„é—®é¢˜æ˜¯è¿™ç§æ•ˆæœéœ€è¦ä¸¤ä¸ªï¼ˆæˆ–æ›´å¤šï¼‰ç‰©ä½“ã€‚æˆ‘æ‰¾åˆ°çš„æ‰€æœ‰æ•™ç¨‹éƒ½åªæ˜¯åœ¨å•ä¸ªç€è‰²å™¨ä¸­æ¨¡æ‹Ÿä¸¤ä¸ªç»„ä»¶ã€‚è¿™ç§æ–¹æ³•åœ¨è§†è§‰ä¸Šå¾ˆæœ‰æ•ˆï¼Œä½†åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨æ—¶ä¼šå¸¦æ¥å¾ˆå¤šé™åˆ¶ã€‚å› æ­¤ï¼Œæˆ‘å¼€å§‹ä»¥ä¸€ç§æ¯ä¸ªå…ƒç´ åªæ‰­æ›²è‡ªèº«çš„æ–¹å¼æ¥æ„å»ºè¿™ç§æ•ˆæœâ€”â€”å°½å¯èƒ½åœ°è®©ä¸€åˆ‡çœ‹èµ·æ¥å…¬å¹³ã€å¹²å‡€ã€‚</p>

<p>å¥½äº†ï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»æ˜ç™½äº†ä¸ºä»€ä¹ˆè¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªmetaballæ•™ç¨‹ï¼Œè€Œæ˜¯ä¸€ä¸ªå…¨æ–°çš„æ•™ç¨‹â€”â€”é‚£å°±å¼€å§‹å§ï¼å’Œå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘æŠŠæ‰€æœ‰å†…å®¹åˆ†è§£æˆå‡ ä¸ªéƒ¨åˆ†ï¼š</p>

<ul>
<li>é¦–å…ˆï¼Œæˆ‘ä¼šå¿«é€Ÿè§£é‡Šä¸€ä¸‹è¿™ç§æ•ˆæœåœ¨ç»å…¸å®ç°ä¸­çš„å·¥ä½œåŸç†ï¼Œç„¶åæˆ‘ä»¬ä¼šè¿›è¡Œå“ªäº›ä¸åŒçš„è°ƒæ•´ã€‚</li>
<li>ç„¶åï¼Œæˆ‘ä¼šä»‹ç»ä¸€ä¸‹Composeçš„ç®€å•è®¾ç½®ï¼Œè®©å®ƒè¿è¡Œèµ·æ¥ã€‚</li>
<li>æœ€åï¼Œæˆ‘ä»¬ä¼šæ›´è¯¦ç»†åœ°ä»‹ç»ç€è‰²å™¨æœ¬èº«ã€‚</li>
</ul>


<p>æœ€ç»ˆï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1192/1*2oZU3pJdUVUq1eR56tVTNw.gif" alt="è¿™åªæ˜¯å…¶ä¸­ä¸€ä¸ªé€‰é¡¹ï¼›è¿™ç§æ•ˆæœæ˜¯é«˜åº¦å¯å®šåˆ¶çš„ã€‚" /></p>

<blockquote><p>å¼€å§‹ä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹â€”â€”æˆ‘ä¸ä¼šä¸ºæˆ‘åˆ¶ä½œçš„æ¯ä¸ªæ•ˆæœéƒ½åˆ¶ä½œæ•™ç¨‹ï¼Œä½†ä½ å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E6%89%80%E6%9C%89%E6%95%99%E7%A8%8B%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E6%89%80%E6%9C%89%E6%95%99%E7%A8%8B%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸Šæ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœå…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>è¦åˆ›å»ºå…ƒçƒæ•ˆæœï¼Œæˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸€ä¸‹åŸºç¡€çŸ¥è¯†ã€‚å¦‚ä½•åœ¨ç€è‰²å™¨ä¸­ç»˜åˆ¶ä¸€ä¸ªç®€å•çš„åœ†åœˆï¼Ÿæœ€ç®€å•çš„æ–¹æ³•æ˜¯å®šä¹‰ä¸€ä¸ªä¸­å¿ƒå’Œä¸€ä¸ªåŠå¾„ï¼Œç„¶åä½¿ç”¨ step å‡½æ•°ã€‚å¦‚æœåƒç´ æ¯”åŠå¾„æ›´é è¿‘ä¸­å¿ƒï¼Œåˆ™è¿”å› 1ï¼›å¦‚æœåƒç´ æ¯”åŠå¾„æ›´è¿œç¦»ä¸­å¿ƒï¼Œåˆ™è¿”å› 0ã€‚å®é™…ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span> <span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">p</span><span class="o">-</span><span class="n">center</span><span class="p">),</span> <span class="n">radius</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">b1</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>è¿™æ®µä»£ç æ˜¯ç”¨ GLSL ç¼–å†™çš„ï¼Œè€Œä¸æ˜¯ AGSLï¼Œä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ° shadertoy.com ä¸­ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œæ‰€æœ‰ä»£ç éƒ½å°†é‡‡ç”¨ç›¸åŒçš„æ–¹æ³•ï¼Œè®©ä½ æ— éœ€è¿è¡Œ Android Studio å³å¯æ›´è½»æ¾åœ°æµ‹è¯•å’ŒæŸ¥çœ‹ç»“æœã€‚</p></blockquote>

<p><em>ç»“æœæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„åœ†åœˆã€‚å¦‚æœä½ å¯¹ç€è‰²å™¨ç¨æœ‰äº†è§£ï¼Œè¿™éƒ¨åˆ†åº”è¯¥å¾ˆå®¹æ˜“ç†è§£ã€‚</em></p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*PTHu_h9ayCxqi-EgVN2nVQ.png" alt="æœ€ç®€å•çš„åœ†åœˆ" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ·»åŠ ç¬¬äºŒä¸ªåœ†åœˆï¼Œå¹¶å°†å®ƒä»¬æ°´å¹³æ”¾ç½®ï¼Œä½¿å®ƒä»¬ç•¥å¾®åˆ†å¼€ï¼Œè€Œä¸æ˜¯åŒæ—¶ä½äºä¸­å¿ƒã€‚è¿™æ¬¡ï¼Œæˆ‘ä»¬ä¸å†ä½¿ç”¨æ­¥é•¿å‡½æ•°æ¥å®šä¹‰è¾¹ç¼˜ï¼Œè€Œæ˜¯ä½¿ç”¨åè·ç¦»ã€‚æˆ‘ä»¬ä»ç„¶ä¼šå¾—åˆ°ä¸¤ä¸ªåœ†åœˆï¼Œä½†è¾¹ç¼˜ä¸å†æ˜¯é”åˆ©çš„ï¼Œè€Œæ˜¯å¹³æ»‘çš„æ¸å˜ï¼Œä½¿åœ†åœˆçœ‹èµ·æ¥æ›´åƒå‘å…‰çš„ç‚¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">center</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">dist</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">circles</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">circles</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rXfBtvZOlpnK98XEy7HyUA.png" alt="" /></p>

<p>å¦‚ä½ æ‰€è§ï¼Œåœ¨æœ€ç»ˆå›¾åƒä¸­ï¼Œæˆ‘ä»¬å°†ä¸¤ä¸ªåœ†çš„å€¼ç›¸åŠ ã€‚å³ä½¿ç°åœ¨ï¼Œå¦‚æœä½ å°†å®ƒä»¬ç§»è¿‘ï¼Œä½ ä¹Ÿä¼šçœ‹åˆ°å®ƒä»¬å¼€å§‹åˆå¹¶ã€‚åŸºæœ¬ä¸Šï¼Œæ•ˆæœå·²ç»å­˜åœ¨â€”â€”å‰©ä¸‹çš„å°±æ˜¯å¯¹æœ€ç»ˆå€¼åº”ç”¨ä¸€äº›å‡½æ•°ï¼Œæˆ–è€…å†æ¬¡ä½¿ç”¨ step å‡½æ•°æˆªæ–­ä½äºç‰¹å®šé˜ˆå€¼çš„æ‰€æœ‰å†…å®¹ï¼Œä¿ç•™å…¶å†…éƒ¨å†…å®¹ã€‚å°±è¿™æ ·â€”â€”å…ƒçƒæ•ˆæœå®Œæˆäº†ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">ball</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">center</span><span class="p">,</span> <span class="k">float</span> <span class="n">radius</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">center</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">radius</span> <span class="o">/</span> <span class="n">dist</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">void</span> <span class="n">mainImage</span><span class="p">(</span> <span class="k">out</span> <span class="k">vec4</span> <span class="n">fragColor</span><span class="p">,</span> <span class="k">in</span> <span class="k">vec2</span> <span class="n">fragCoord</span> <span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Normalized pixel coordinates (from -0.5 to 0.5)   </span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span><span class="o">/</span><span class="n">iResolution</span><span class="p">.</span><span class="n">xy</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">iResolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// make circles moving slightly along horizontal direction</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">horiz</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">iTime</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="o">+</span><span class="n">horiz</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">ball</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.3</span><span class="o">-</span><span class="n">horiz</span><span class="p">,</span><span class="mf">0.</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">circles</span> <span class="o">=</span> <span class="n">b1</span> <span class="o">+</span> <span class="n">b2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="n">circles</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fragColor</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rIVQla9lc5qbYGaCMVmI4g.gif" alt="æœ€ç®€å•çš„å…ƒçƒæ•ˆæœ" /></p>

<p>å½“ç„¶ï¼Œé™¤äº†é˜¶è·ƒå‡½æ•°ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ SmoothStepï¼Œæ·»åŠ è·ç¦»çš„å¹³æ–¹åæ¯”ï¼Œæˆ–è€…å°è¯•ä¸åŒçš„å…¬å¼ï¼Œè°ƒæ•´ç³»æ•°ç­‰ç­‰ã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¯èƒ½çš„ï¼Œå¹¶ä¸”éƒ½ä¼šæ”¹å˜æœ€ç»ˆçš„å¤–è§‚ï¼Œä½†æ ¸å¿ƒæ€æƒ³ä¿æŒä¸å˜ï¼šæˆ‘ä»¬ç”¨å¹³æ»‘è¡°å‡å…¬å¼å®šä¹‰åœ†ï¼Œå°†ç»“æœç›¸åŠ ï¼Œå¹¶åœ¨æŸä¸ªé˜ˆå€¼å¤„è¿›è¡Œæˆªæ–­ã€‚è¿™æ ·ï¼Œå½“å½¢çŠ¶æ¥è¿‘æ—¶ï¼Œå®ƒä»¬çš„åœºä¹‹å’Œä¼šè¶…è¿‡é˜ˆå€¼ï¼Œä»è€Œåˆå¹¶æˆä¸€ä¸ªå½¢çŠ¶â€”â€”è€Œå½“å®ƒä»¬ç›¸è·è¾ƒè¿œæ—¶ï¼Œåˆ™ä¸ä¼šåˆå¹¶ã€‚</p>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•åˆ›å»ºå…ƒçƒæ•ˆæœï¼Œçœ‹èµ·æ¥æˆ‘ä»¬åªéœ€æ‰“å¼€ Android Studio å°±å¯ä»¥å¼€å§‹æ„å»ºäº†ï¼ç„¶è€Œï¼Œæˆ‘ä»¬å¾ˆå¿«å°±ä¼šé‡åˆ°ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ul>
<li>ç›®å‰ï¼Œæ‰€æœ‰æŒ‰é’®éƒ½åƒåœ†å½¢ä¸€æ ·å·¥ä½œâ€”â€”è¿™æ˜¯æ„æ–™ä¹‹ä¸­çš„ã€‚ä½†å¦‚æœæˆ‘ä»¬å¸Œæœ›åˆå¹¶æŒ‰é’®å…·æœ‰å…¶ä»–å½¢çŠ¶ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä¾‹å¦‚ SDF æ–¹æ³•ã€‚å³ä¾¿å¦‚æ­¤ï¼Œå½¢çŠ¶ä»ç„¶åœ¨ç€è‰²å™¨å†…éƒ¨å®šä¹‰ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸èƒ½ç®€å•åœ°åœ¨ Compose è§†å›¾ä¸­åº”ç”¨ RoundedCornerShape å¹¶æœŸæœ›å®ƒèƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚</li>
<li>ä¸¤ä¸ªæŒ‰é’®å¿…é¡»åœ¨åŒä¸€ä¸ªç€è‰²å™¨ä¸­å®šä¹‰ã€‚å¦‚æœæœ‰ä¸‰ä¸ªæŒ‰é’®ï¼Œåˆ™ä¸‰ä¸ªæŒ‰é’®éƒ½å¿…é¡»ä½äºåŒä¸€ä¸ªç€è‰²å™¨ä¸­ã€‚æœ€é‡è¦çš„æ˜¯â€”â€”æˆ‘ä»¬å¦‚ä½•å¤„ç†è¿™äº›æŒ‰é’®çš„ç‚¹å‡»ï¼Ÿ</li>
</ul>


<p>å¦‚æœä½ æŸ¥æ‰¾æœ‰å…³æ­¤æ•ˆæœçš„æ–‡ç« ï¼Œä½ ä¼šå‘ç°è¿™ä¸¤ä¸ªé—®é¢˜é€šå¸¸è¢«å¿½ç•¥ã€‚ç„¶è€Œï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œå®ƒä»¬è‡³å…³é‡è¦â€”â€”è¿™æ­£æ˜¯æˆ‘å†³å®šæ’°å†™æœ¬æ•™ç¨‹çš„åŸå› ã€‚æˆ‘å»ºè®®é‡‡ç”¨ä¸€ç§ä¸åŒçš„æ–¹æ³•æ¥è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ç€è‰²å™¨å†…éƒ¨å®šä¹‰å½¢çŠ¶ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†å˜å½¢åæ ‡ç³»æœ¬èº«ï¼Œä»è€Œè§£å†³ä¸åŒå½¢çŠ¶çš„é—®é¢˜ã€‚</p>

<p>å…¶æ¬¡ï¼Œæ•ˆæœä¸­çš„æ¯ä¸ªå…ƒç´ éƒ½ä¼šè·å¾—è‡ªå·±çš„ç€è‰²å™¨å®ä¾‹ï¼Œä½†æˆ‘ä»¬ä¹Ÿä¼šå°†ç›¸é‚»å…ƒç´ çš„åæ ‡ä¼ é€’ç»™å®ƒã€‚è¿™è§£å†³äº†ç‚¹å‡»å¤„ç†é—®é¢˜ï¼Œå› ä¸ºç°åœ¨æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯ç»„åˆå…ƒç´ ï¼Œæ‹¥æœ‰è‡ªå·±çš„å±æ€§å’Œ lambda è¡¨è¾¾å¼ã€‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*7yVd3iok98-pQNLWIhP1mQ.png" alt="ç»¿è‰²è¡¨ç¤ºå¯ç»„åˆå…ƒç´ ã€‚ç²‰è‰²è¡¨ç¤ºç€è‰²å™¨" /></p>

<p>å› æ­¤ï¼Œæˆ‘ä»¬çš„ä»»åŠ¡å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªä¸»è¦çš„å­ä»»åŠ¡ã€‚ä¸€æ—¦è§£å†³äº†è¿™ä¸¤ä¸ªå­ä»»åŠ¡ï¼Œæˆ‘ä»¬å°±èƒ½å¾—åˆ°æœ€ç»ˆçš„æ•ˆæœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å­¦ä¹ å¦‚ä½•å˜å½¢ç”»å¸ƒä»¥è·å¾—ä¸å…ƒçƒç›¸åŒçš„è§†è§‰æ•ˆæœã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æ”¶é›†å®¹å™¨ä¸­æ¯ä¸ªå­å…ƒç´ çš„ä½ç½®æ•°æ®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™å…¶ä»–ç€è‰²å™¨ã€‚è®©æˆ‘ä»¬å…ˆä»ç¬¬ä¸€éƒ¨åˆ†å¼€å§‹ã€‚</p>

<p>è®©æˆ‘ä»¬ä»ä½¿ç”¨ç€è‰²å™¨æ‰€éœ€çš„æœ€ç®€å•çš„è®¾ç½®å¼€å§‹ã€‚ä¸‹é¢æ˜¯å¯ç»„åˆéƒ¨åˆ†â€”â€”ä½ å¯ä»¥ç›´æ¥å¤åˆ¶ç²˜è´´åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼Œå®ƒåº”è¯¥å¯ä»¥ç«‹å³è¿è¡Œã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MetaballShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">metaballShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF171717</span><span class="p">)),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span><span class="n">shader</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ShadedButton</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">:</span> <span class="n">RuntimeShader</span><span class="p">,)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">boxSize</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">boxSize</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF6F6F6</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>            <span class="n">imageVector</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">MoreVert</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Expand Menu&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tint</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥ä¸‹æ˜¯ç€è‰²å™¨ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Language</span><span class="p">(</span><span class="s">&quot;AGSL&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">metaballShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">vec2</span> <span class="n">o</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">o</span> <span class="p">/</span> <span class="n">r</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">&gt;=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="p">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">uv</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">p</span> <span class="p">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="p">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>        <span class="n">vec4</span> <span class="k">final</span> <span class="p">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="m">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="k">final</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘å·²ç»åŒ…å«äº†ä¸¤ä¸ªå¿…è¦çš„æ–¹æ³•ï¼šä¸€ä¸ªç”¨äºè§„èŒƒåŒ–ï¼Œä¸€ä¸ªç”¨äºä»è¾“å…¥çº¹ç†ä¸­è·å–é¢œè‰²ã€‚æˆ‘åœ¨ä¹‹å‰çš„è¯¾ç¨‹ä¸­ä»‹ç»è¿‡è¿™äº›æ–¹æ³•ï¼Œå› æ­¤ä½ å¯ä»¥ç®€å•åœ°å°†å®ƒä»¬è§†ä¸ºå¿…éœ€çš„æ ·æ¿ä»£ç â€”â€”å®ƒä»¬ä¸ä¼šå½±å“æ•ˆæœçš„æ ¸å¿ƒé€»è¾‘â€”â€”æˆ–è€…æŸ¥çœ‹æˆ‘ä¹‹å‰çš„æ•™ç¨‹ï¼Œæˆ‘åœ¨é‚£é‡Œè¯¦ç»†è§£é‡Šäº†å®ƒä»¬ã€‚æœ¬è¯¾ç¨‹å·²ç»ç›¸å½“ä¸°å¯Œï¼Œç”šè‡³å¯èƒ½ä¿¡æ¯é‡è¿‡å¤§ï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚</p></blockquote>

<p>å¤ªå¥½äº†ï¼å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œæˆ‘ä»¬å°†å¾—åˆ°ä¸€ä¸ªå°šæœªæ·»åŠ ä»»ä½•å†…å®¹çš„ç€è‰²å™¨â€”â€”å®ƒåªæ˜¯ç»˜åˆ¶æ‰€æœ‰å†…å®¹ï¼Œå°±åƒç€è‰²å™¨æ ¹æœ¬ä¸å­˜åœ¨ä¸€æ ·ã€‚ç»“æœåº”è¯¥åªæ˜¯ä¸€ä¸ªæ™®é€šçš„æŒ‰é’®ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*V_yEnqGelKeDKYaPwUklTg.png" alt="æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯ä¸€ä¸ªæŒ‰é’® :)" /></p>

<p>åœ¨æœ€ç»ˆçš„ä»£ç ä¸­ï¼Œå˜å½¢å°†åŸºäºå…¶ä»–å…ƒç´ ï¼Œä½†ç”±äºæˆ‘ä»¬ç›®å‰è¿˜æ²¡æœ‰è¿™äº›å…ƒç´ ï¼Œæˆ‘åªéœ€æ·»åŠ ä¸€ä¸ªè™šæ‹Ÿç‚¹å¹¶å°†å…¶ç»˜åˆ¶åœ¨ç”»å¸ƒä¸Šå³å¯ã€‚è¿™åªæ˜¯æµ‹è¯•ä»£ç ï¼Œæˆ‘ä»¬ç¨åä¼šå°†å…¶ç§»é™¤ã€‚æˆ‘è¿˜ä¼šå°†æ—¶é—´ä¼ é€’ç»™ç€è‰²å™¨ï¼Œå¹¶ä½¿è¯¥ç‚¹æ°´å¹³ç§»åŠ¨ã€‚è¿™å°†æ˜¯æˆ‘ä»¬çš„è™šæ‹Ÿç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒä½œä¸ºç”»å¸ƒå˜å½¢çš„å‚è€ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">//...</span>
</span><span class='line'> <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>  <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>       <span class="c1">//...</span>
</span><span class='line'>        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'><span class="c1">//...</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ç€è‰²å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ·»åŠ æ—¶é—´ç»Ÿä¸€å‡½æ•°ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¹¶æ·»åŠ è™šæ‹Ÿåœ†ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">float</span> <span class="n">getCircle</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">pivot</span> <span class="o">-</span> <span class="n">p</span><span class="p">),</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŒæ—¶å°†è™šæ‹Ÿåœ†æ·»åŠ åˆ°æœ€ç»ˆè¾“å‡ºä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">//...</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">circleHorizontalPosition</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">time</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">;</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">helperCicrle</span> <span class="o">=</span> <span class="n">getCircle</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="n">circleHorizontalPosition</span><span class="p">,</span> <span class="mf">0.</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">final</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">final</span><span class="p">,</span> <span class="n">helperCicrle</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span> <span class="n">helperCicrle</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">final</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ ·ï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°ä¸€ä¸ªçº¢è‰²çš„å‚è€ƒç‚¹ï¼Œæˆ‘ä»¬å°†ä»¥æ­¤ä¸ºåŸºç¡€æ¥æ‰­æ›²æŒ‰é’®ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*rikNEHT918EmDeWLzQsWbA.gif" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•è®¡ç®—æ§åˆ¶ç‚¹å¯¹æŒ‰é’®çš„å½±å“ï¼Œä½¿ç”¨ä¸è®¡ç®—å…ƒçƒå®Œå…¨ç›¸åŒçš„æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">controlPoint</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dist</span><span class="p">;</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">circleHorizontalPosition</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mf">0.2</span><span class="o">*</span><span class="n">time</span><span class="p">)</span><span class="o">*</span><span class="mf">2.</span><span class="p">;</span>
</span><span class='line'>        <span class="k">vec2</span> <span class="n">controlPointPos</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">circleHorizontalPosition</span><span class="p">,</span> <span class="mf">0.</span><span class="p">);</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">helperCicrle</span> <span class="o">=</span> <span class="n">getCircle</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">controlPointPos</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">getInfluence</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">controlPointPos</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">uv</span> <span class="o">*=</span> <span class="mf">1.</span><span class="o">-</span><span class="n">influence</span><span class="p">;</span> <span class="c1">// why here is 1 - influence was explained in Deform the Canvas tutorial</span>
</span><span class='line'>        <span class="k">vec4</span> <span class="n">final</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">final</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">final</span><span class="p">,</span><span class="n">helperCicrle</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">),</span><span class="n">helperCicrle</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">final</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*ivjxpAXa4_O6hDtt.gif" alt="å¤Ÿæç¬‘çš„ï¼Œä½†è¿™ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„" /></p>

<p>ç»“æœå¾ˆæç¬‘ï¼Œä½†ä¸æ˜¯æˆ‘ä»¬çš„é¢„æœŸã€‚å†…éƒ¨çš„ç‘•ç–µï¼ˆâ€œæ´â€æ•ˆæœï¼‰å¯ä»¥é€šè¿‡å°†å½±å“å€¼é™åˆ¶åœ¨ 0 åˆ° 1 ä¹‹é—´è½»æ¾ä¿®å¤ã€‚ç„¶è€Œï¼Œè¿™ä»ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ç»“æœâ€”â€”æˆ‘ä»¬å¾—åˆ°çš„æ˜¯æ§åˆ¶ç‚¹å‘¨å›´çš„åŒºåŸŸè†¨èƒ€äº†ï¼Œè€Œæˆ‘ä»¬éœ€è¦çš„æ•ˆæœå‡ ä¹æ˜¯ç›¸åçš„ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ</p>

<p>ç­”æ¡ˆå¾ˆç®€å•ï¼Œä¹Ÿæœ‰ç‚¹æ„æ€â€”â€”è™½ç„¶æˆ‘èŠ±äº†ä¸€äº›æ—¶é—´æ‰æ˜ç™½ã€‚è¿™ä¸ªæƒ³æ³•æ˜¯å°†åæ ‡ä¸­å¿ƒåˆ°æ§åˆ¶ç‚¹çš„è·ç¦»ä¸ä¸¤ä¸ªè·ç¦»ä¹‹å’Œè¿›è¡Œæ¯”è¾ƒï¼šä»ä¸­å¿ƒåˆ°å½“å‰ç‚¹ (uv) çš„è·ç¦»ï¼Œä»¥åŠä»å½“å‰ç‚¹åˆ°æ§åˆ¶ç‚¹çš„è·ç¦»ã€‚ä¸‹å›¾æ˜¯æŒ‰é’®å†…éƒ¨ä¸€ä¸ªéšæœºç‚¹çš„ç¤ºæ„å›¾ã€‚è¿™ä¸ªè·ç¦»æ€»æ˜¯å¤§äºç›´æ¥åˆ°ä¸­å¿ƒçš„è·ç¦»ï¼Œè€Œè¿™ä¸ªæŠ€å·§å°±æ˜¯è®©æˆ‘ä»¬å®ç°å…ƒçƒæ•ˆæœçš„å…³é”®ï¼</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*n7kIFbwMCFNmhinMLfBP6g.png" alt="å¦‚æœæˆ‘ä»¬å°†ç»¿è‰²åˆ°çº¢è‰²çš„è·ç¦»åŠ ä¸Šåˆ°ä¸­å¿ƒçš„è·ç¦»ï¼Œé‚£ä¹ˆç»¿è‰²åˆ°çº¢è‰²çš„è·ç¦»æ€»æ˜¯å¤§äºä¸­å¿ƒåˆ°çº¢è‰²çš„è·ç¦»ã€‚" /></p>

<p>æ‰€ä»¥ï¼Œä¸ºäº†å°†æˆ‘ä»¬ç°åœ¨çš„æ•ˆæœå˜æˆå‡ ä¹å®Œæ•´çš„æ•ˆæœï¼ˆé™¤äº†å¼ºåº¦è®¾ç½®å’Œå…¶ä»–ä¸€äº›å°çš„è°ƒæ•´ï¼‰ï¼Œæˆ‘ä»¬å®é™…ä¸Šåªéœ€è¦å°†ä¸­å¿ƒæ·»åŠ åˆ°è·ç¦»è®¡ç®—ä¸­â€”â€”å°±è¿™æ ·ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">controlPoint</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// float dist = length(controlPoint-uv); - was like that</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span> <span class="c1">//added length(uv);</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="n">dist</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*ArDCdZxeCKBBmsfQ.gif" alt="æˆ‘ä»¬å·²ç»å¾—åˆ°äº†æƒ³è¦çš„ç»“æœ" /></p>

<blockquote><p><em>ç°åœ¨å¯ä»¥æ·»åŠ â€œmassâ€æˆ–é™¤ä»¥è·ç¦»çš„å¹³æ–¹æ¥åŠ å¿«æ·¡å‡ºé€Ÿåº¦ã€‚ä½†è¿™äº›éƒ½æ˜¯å®Œå–„çš„ç»†èŠ‚ï¼Œå¹¶éæ ¸å¿ƒæ•ˆæœé€»è¾‘çš„ä¸€éƒ¨åˆ†ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä½ è‡ªå·±å°è¯•ä¸€ä¸‹ getInfluence æ–¹æ³•ã€‚</em></p></blockquote>

<p>æœ€åä¸€æ­¥æ˜¯ä¼ é€’å¦ä¸€ä¸ªç»„ä»¶çš„åæ ‡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç€è‰²å™¨å†…çš„æ§åˆ¶ç‚¹ã€‚å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†è¿™é‡Œæœ‰ä¸€äº›éœ€è¦è®¨è®ºçš„åœ°æ–¹ã€‚å¯¹æˆ‘æ¥è¯´ï¼Œæœ€éš¾çš„éƒ¨åˆ†æ˜¯è·å–ä¸ç€è‰²å™¨æœ¬èº«ä½äºåŒä¸€â€œç³»ç»Ÿâ€ä¸­çš„åæ ‡ã€‚è™½ç„¶æ§åˆ¶ç‚¹ä½äºç€è‰²å™¨å†…éƒ¨ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ uv åˆ›å»ºäº†å®ƒï¼Œè€Œ uv å·²ç»æ ¹æ®è§†å›¾çš„å¤§å°è¿›è¡Œäº†å½’ä¸€åŒ–ã€‚ä½†æ˜¯ï¼Œç°åœ¨æˆ‘ä»¬è¦è·å–ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ä½ç½®ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•å°†æ‰€æœ‰è¿™äº›ç»“åˆèµ·æ¥å‘¢ï¼Ÿ</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬åœ¨å®¹å™¨ä¸­æ·»åŠ ç¬¬äºŒä¸ªæŒ‰é’®ï¼Œå¹¶å°†æ‰€æœ‰å¿…è¦çš„å‚æ•°ä¼ é€’ç»™ç€è‰²å™¨ã€‚ä¹‹åï¼Œæˆ‘ä»¬å°†æ·±å…¥ç€è‰²å™¨é€»è¾‘çš„æ ¸å¿ƒâ€”â€”åœ¨æˆ‘çœ‹æ¥ï¼Œè¿™æ˜¯æœ€æœ‰è¶£çš„éƒ¨åˆ†ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TestShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">metaballShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">parentBoxSize</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">firstButtonPosition</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">secondButtonPosition</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFF171717</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInParent</span><span class="p">()</span> <span class="p">+</span>
</span><span class='line'>                            <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">x</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">y</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">*</span> <span class="m">0.5f</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="n">icon</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Favorite</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shader</span> <span class="p">=</span> <span class="n">shader</span><span class="p">,</span>
</span><span class='line'>            <span class="n">parentBoxSize</span> <span class="p">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">otherViewPosition</span> <span class="p">=</span> <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">myPosition</span> <span class="p">=</span> <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">ShadedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">end</span> <span class="p">=</span> <span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">50.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onGloballyPositioned</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">positionInParent</span><span class="p">()</span> <span class="p">+</span>
</span><span class='line'>                            <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">x</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="p">*</span> <span class="m">0.5f</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">y</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">size</span><span class="p">.</span><span class="n">height</span> <span class="p">*</span> <span class="m">0.5f</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>            <span class="n">icon</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Star</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shader</span> <span class="p">=</span> <span class="n">shader</span><span class="p">,</span>
</span><span class='line'>            <span class="n">parentBoxSize</span> <span class="p">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">otherViewPosition</span> <span class="p">=</span> <span class="n">firstButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">myPosition</span> <span class="p">=</span> <span class="n">secondButtonPosition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ShadedButton</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">icon</span><span class="p">:</span> <span class="n">ImageVector</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">:</span> <span class="n">RuntimeShader</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">parentBoxSize</span><span class="p">:</span> <span class="n">IntSize</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">myPosition</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">otherViewPosition</span><span class="p">:</span> <span class="n">Offset</span><span class="p">,)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">boxSize</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">IntSize</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">boxSize</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">boxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;parentBoxSize&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;otherViewPosition&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">otherViewPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">otherViewPosition</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;positionInParent&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">myPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">myPosition</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFF6F6F6</span><span class="p">))</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>            <span class="n">imageVector</span> <span class="p">=</span> <span class="n">icon</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Expand Menu&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tint</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬æ·»åŠ çš„åªæ˜¯ä¼ é€’çˆ¶å®¹å™¨çš„å¤§å°å’Œç›¸é‚»è§†å›¾çš„ä¸­å¿ƒåæ ‡ã€‚è¯·è®°ä½ï¼Œç”±äº Compose å›è°ƒè¿”å›çš„ä½ç½®æ˜¯å·¦ä¸Šè§’ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨ä¼ é€’ä¹‹å‰å¯¹å…¶è¿›è¡Œä¸€äº›è°ƒæ•´ã€‚å¦å¤–ï¼Œè¯·è®°ä½ï¼Œç¬¬ä¸€ä¸ªç»„ä»¶åº”è¯¥åœ¨ otherViewPosition å‚æ•°ä¸­æ¥æ”¶ç¬¬äºŒä¸ªç»„ä»¶ï¼Œç¬¬äºŒä¸ªç»„ä»¶ä¹Ÿåº”è¯¥æ¥æ”¶ç¬¬ä¸€ä¸ªç»„ä»¶ã€‚æœ€é‡è¦çš„æ˜¯ä¸è¦æ··æ·†å®ƒä»¬ :)</p>

<p>è®©æˆ‘ä»¬ç»§ç»­è®¨è®ºç€è‰²å™¨ã€‚æˆ‘ä»¬å°†ä»æ·»åŠ å¿…è¦çš„ uniform å¼€å§‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">otherViewPosition</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">parentBoxSize</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positionInParent</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨åˆ°äº†æœ‰è¶£çš„éƒ¨åˆ†ï¼šä¹‹å‰çš„æ§åˆ¶ç‚¹ç°åœ¨éœ€è¦æ ¹æ®ä¸¤ä¸ªå‚æ•°æ¥è®¡ç®—â€”â€”çˆ¶çº§çš„å¤§å°ä»¥åŠç¬¬äºŒä¸ªè§†å›¾ç›¸å¯¹äºçˆ¶çº§çš„åæ ‡ã€‚</p>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è·å–å®¹å™¨å¤§å°ä¸æŒ‰é’®å¤§å°çš„æ¯”ç‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">float</span> <span class="n">parentRatio</span> <span class="o">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ getInfluence æ–¹æ³•ï¼Œå°±èƒ½å°†æ‰€æœ‰å†…å®¹æ•´åˆåˆ°ä¸€ä¸ªåæ ‡ç³»ä¸­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">otherViewPosition</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="mf">2.</span><span class="p">));</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">influence</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¬èµ·æ¥å¾ˆç®€å•ï¼Œä½†å®é™…ä¸Šï¼Œè¿‡ç¨‹ä¸­å‡ºç°äº†ä¸€äº›ä¸å¤ªæ˜æ˜¾çš„è®¡ç®—ã€‚è€Œä¸”è¿™äº›è®¡ç®—å¹¶éä¸€çœ¼å°±èƒ½è½»æ˜“æŒæ¡ã€‚æ‰€ä»¥æˆ‘å°½é‡æŠŠå®ƒè§£é‡Šå¾—æ¸…æ™°æ˜“æ‡‚ã€‚æ‰€ä»¥ï¼Œä»æ•´ä½“ä¸Šçœ‹ï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯è¿™æ ·çš„ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*ttaLU6zCxuP0vuHWmtkgGA.png" alt="å·¦è¾¹æ˜¯æˆ‘ä»¬çš„â€œæ´»åŠ¨â€è§†å›¾ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å§‹ç»ˆå¤„äºè§†å›¾ç€è‰²å™¨çš„â€œå†…éƒ¨â€ã€‚" /></p>

<p>å¥½çš„ï¼Œæˆ‘ä»¬æœ‰çˆ¶å®¹å™¨ã€å®ƒçš„å¤§å°ã€æˆ‘ä»¬è§†å›¾ç›¸å¯¹äºçˆ¶å®¹å™¨çš„ä½ç½®ï¼Œä»¥åŠç›¸é‚»è§†å›¾ï¼ˆæˆ‘ä»¬ä¹‹å‰ç¤ºä¾‹ä¸­çš„æ§åˆ¶ç‚¹ï¼‰çš„ä½ç½®ã€‚æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯å°†è¿™ä¸ªæ§åˆ¶ç‚¹æ”¾åˆ°æˆ‘ä»¬çš„UVåæ ‡ç³»ä¸­ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*S6fLIECuZWm-UYymAuwPbg.png" alt="ä»ä¸Šåˆ°ä¸‹çš„æ•´ä¸ªè¿‡ç¨‹" /></p>

<p>æˆ‘å°è¯•è‡ªä¸Šè€Œä¸‹åœ°è§£é‡Šäº†æ•´ä¸ªè¿‡ç¨‹ã€‚ç°åœ¨è®©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ä»£ç ï¼Œå¹¶é€æ­¥è®²è§£ä¸€ä¸‹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="n">float2</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>  <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">otherViewPosition</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>  <span class="k">float</span> <span class="n">parentRatio</span> <span class="o">=</span> <span class="n">parentBoxSize</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>  <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="n">parentRatio</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å‡è®¾çˆ¶å®¹å™¨çš„å®½åº¦ä¸º 500ã€‚æˆ‘ä»¬åœ¨å…¶ä¸­çš„ä½ç½®ä¸º 100ï¼Œç›¸é‚»è§†å›¾çš„ä½ç½®ä¸º 400ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬è·å–ä¸¤ä¸ªè§†å›¾ç›¸å¯¹äºçˆ¶å®¹å™¨çš„æ ‡å‡†åŒ–åæ ‡ï¼ˆåç§» -0.5ï¼‰ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬çš„ä½ç½®ä¸º -0.3ï¼Œç›¸é‚»è§†å›¾çš„ä½ç½®ä¸º 0.2ã€‚å› æ­¤ï¼Œå®ƒä»¬ä¹‹é—´çš„è·ç¦»ä¸º 0.5â€”â€”å³çˆ¶å®¹å™¨å®½åº¦çš„ä¸€åŠã€‚ä½†è¯·è®°ä½ï¼Œæˆ‘ä»¬ä½äºé™„åŠ åˆ°è‡ªèº«è§†å›¾çš„ç€è‰²å™¨å†…éƒ¨ï¼Œå› æ­¤å¿…é¡»å°†è¿™ä¸ªå€¼ä¹˜ä»¥çˆ¶å®¹å™¨å¤§å°ä¸æˆ‘ä»¬è§†å›¾å¤§å°çš„æ¯”å€¼ã€‚è¿™æ˜¯å…³é”®çš„ä¸€æ­¥ï¼šæˆ‘ä»¬ç°åœ¨å¾—åˆ°çš„ä¸æ˜¯ 0.5ï¼Œè€Œæ˜¯å¦ä¸€ä¸ªå€¼ï¼Œä½†å®ƒä½äºæˆ‘ä»¬è§†å›¾çš„åæ ‡ç³»ä¸­ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—è·ç¦»ï¼Œå¹¶æ‰§è¡Œä¹‹å‰å¯¹è™šæ‹Ÿæ§åˆ¶ç‚¹æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œï¼</p>

<blockquote><p>_è¿™é‡Œæˆ‘å°†æ‰€æœ‰å†…å®¹ç®€åŒ–ä¸ºæ°´å¹³åæ ‡ï¼Œä½†åŒæ ·çš„é€»è¾‘ä¹Ÿé€‚ç”¨äºå‚ç›´åæ ‡ã€‚æˆ‘åªæ˜¯ä¸æƒ³è®©æœ¬æ¥å°±å¾ˆå¤æ‚çš„è§£é‡Šæ›´åŠ éš¾ä»¥ç†è§£ã€‚</p></blockquote>

<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*OWQ-vSnQ3yAiPloRXBRXQw.png" alt="é™æ€çœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œä½†å¾ˆæ˜æ˜¾ä¸¤ä¸ªè§†å›¾æ˜¯ç›¸äº’å½±å“çš„ã€‚" /></p>

<p>æœ€åä¸€æ­¥æ˜¯ç”¨æ•°ç»„æ›¿æ¢è¿™ä¸¤ä¸ªè§†å›¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ·»åŠ ç¬¬ä¸‰ä¸ªã€ç¬¬å››ä¸ªç”šè‡³ç¬¬äº”ä¸ªæŒ‰é’®ã€‚</p>

<p>åœ¨ç€è‰²å™¨ä¸­ï¼Œä¸èƒ½ä½¿ç”¨åŠ¨æ€æ•°ç»„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è®¾ç½®ä¸€ä¸ªä¸Šé™â€”â€”æˆ‘é€‰æ‹©äº† 10 ä¸ªå…ƒç´ ã€‚æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå•ç‹¬çš„è®¡æ•°å™¨æ¥è®°å½•å®é™…æœ‰å¤šå°‘ä¸ªå…ƒç´ ã€‚ç”±äºæ•°ç»„ä¸èƒ½ç•™ç©ºï¼Œåœ¨ Compose ä¸­ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨ç”¨é›¶ä½ç½®å¡«å……æœªä½¿ç”¨çš„æ§½ä½ï¼Œä½†è®¡æ•°å™¨ä¼šç¡®ä¿è¿™ä¸ä¼šå½±å“æœ€ç»ˆç»“æœã€‚</p>

<p>å› æ­¤ï¼Œåœ¨ç€è‰²å™¨ä¸­ï¼Œuniform å˜é‡çœ‹èµ·æ¥å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">uniform</span> <span class="k">int</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positions</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">parentResolution</span><span class="p">;</span>
</span><span class='line'> <span class="k">uniform</span> <span class="n">float2</span> <span class="n">positionInParent</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœå¤šä¸ªç›¸é‚»å…ƒç´ åŒæ—¶å½±å“è§†å›¾ï¼ŒgetInfluence æ–¹æ³•å°†å¾ªç¯éå†æ‰€æœ‰å…ƒç´ å¹¶ç´¯ç§¯å½±å“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">getInfluence</span><span class="p">(</span><span class="n">float2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">posInParentNormalized</span> <span class="o">=</span> <span class="p">(</span><span class="n">positionInParent</span><span class="o">/</span><span class="n">parentBoxSize</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">controlPoint</span> <span class="o">=</span> <span class="n">positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">parentBoxSize</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">controlPoint</span><span class="p">.</span><span class="n">x</span><span class="o">-</span><span class="n">posInParentNormalized</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">dist</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span><span class="n">length</span><span class="p">(</span><span class="n">controlPoint</span><span class="o">-</span><span class="n">uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>        <span class="k">float</span> <span class="n">rawScale</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">pow</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span><span class="mf">2.</span><span class="p">);</span>
</span><span class='line'>        <span class="n">influence</span> <span class="o">+=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">rawScale</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">clamp</span><span class="p">(</span><span class="n">influence</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åœ¨ Compose ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªåˆ—è¡¨å¹¶ä»”ç»†ä¼ é€’æ‰€æœ‰å€¼ã€‚ä½ ä¹Ÿå¯ä»¥æ·»åŠ åŠ¨ç”»å’Œå…¶ä»–æ•ˆæœï¼Œä½†è¿™ä¼šä½¿ Compose ä»£ç è¿‡è½½ï¼Œåœ¨æœ¬è¯¾ä¸­æ›´éš¾ç†è§£ã€‚æœ¬æ•™ç¨‹å·²ç»ç›¸å½“ä¸°å¯Œï¼Œæ‰€ä»¥æˆ‘åªæ¼”ç¤ºå¦‚ä½•å°†å€¼ä¼ é€’åˆ°æ•°ç»„ä¸­â€”â€”å…¶ä½™çš„å®éªŒç•™ç»™ä½ è‡ªå·± :) è®°ä½ï¼Œä½ å¯ä»¥éšæ—¶æŸ¥çœ‹æˆ‘çš„ä»£ç åº“ä»¥è·å–å®Œæ•´ç‰ˆæœ¬ã€‚</p>

<p>ä¸‹é¢æ˜¯æˆ‘ç¼–å†™çš„ä¸€ä¸ªæ‰©å±•æ–¹æ³•ï¼Œç”¨äºæ–¹ä¾¿åœ°å‘ç€è‰²å™¨æ·»åŠ åˆ—è¡¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">RuntimeShader</span><span class="p">.</span><span class="n">setVec2ArrayUniform</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">values</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Pair</span><span class="p">&lt;</span><span class="n">Float</span><span class="p">,</span> <span class="n">Float</span><span class="p">&gt;&gt;,</span>
</span><span class='line'>
</span><span class='line'><span class="n">maxSize</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">10</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">require</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">size</span> <span class="p">&lt;=</span> <span class="n">maxSize</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;Too many elements for uniform &#39;$name&#39;. Maximum allowed is $maxSize, but got ${values.size}&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">padded</span> <span class="p">=</span> <span class="n">values</span> <span class="p">+</span> <span class="n">List</span><span class="p">(</span><span class="n">maxSize</span> <span class="p">-</span> <span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span> <span class="m">0f</span> <span class="n">to</span> <span class="m">0f</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">floatArray</span> <span class="p">=</span> <span class="n">padded</span><span class="p">.</span><span class="n">flatMap</span> <span class="p">{</span> <span class="n">listOf</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">second</span><span class="p">)</span> <span class="p">}.</span><span class="n">toFloatArray</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">floatArray</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç”¨æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'>  <span class="n">shader</span><span class="p">.</span><span class="n">setVec2ArrayUniform</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ä½ å¯ä»¥æ·»åŠ ä¸åŒçš„å…ƒç´ ï¼Œå¹¶è§‚å¯Ÿå®ƒä»¬åœ¨åŠ¨ç”»è¿‡ç¨‹ä¸­å¹³æ»‘åœ°åˆå¹¶æˆ–åˆ†ç¦»ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*s01C-TPOXIfOwZDg.gif" alt="ä»¥ä¸‹æ˜¯ä¸‰ä¸ªä¸åŒå½¢çŠ¶çš„è§†å›¾" /></p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚è¿™ä¸ªé¡¹ç›®åªæ˜¯æˆ‘çš„ä¸€ä¸ªçˆ±å¥½ï¼Œè¯´å®è¯ï¼Œæˆ‘çš„åŠ¨åŠ›å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ”¶åˆ°çš„åé¦ˆâ€”â€”æ‰€ä»¥æˆ‘éå¸¸é«˜å…´åœ¨é¢‘é“é‡Œè§åˆ°ä½ ã€‚å¦‚æœä½ æ„¿æ„ï¼Œè¯·åœ¨ä½ çš„ç¤¾äº¤åª’ä½“ä¸Šåˆ†äº«è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç©è½¬Shaderä¹‹å­¦ä¼šå¦‚ä½•å˜å½¢ç”»å¸ƒ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas/"/>
    <updated>2025-09-05T14:24:46+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒDeform the canvasã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/deform-the-canvas-57dc59bec42a">https://medium.com/@off.mind.by/deform-the-canvas-57dc59bec42a</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025å¹´8æœˆ2æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/05/deform-the-canvas/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*DTU5ja0MLebUmXQMg9qi9w.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä½¿ç”¨ç€è‰²å™¨æ—¶ï¼Œæˆ‘æ€»æ˜¯ç€è¿·äºå¦‚ä½•è½»æ¾åˆ›å»ºçœ‹èµ·æ¥ç²¾è‡´è€Œæ˜‚è´µçš„æ•ˆæœã€‚ä»Šå¤©çš„æ–‡ç« å°±æ˜¯å¦ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚æœ€è¿‘ï¼Œæˆ‘çš„ Telegram é¢‘é“çš„ä¸€ä½è®¢é˜…è€…é—®æˆ‘ï¼Œå¦‚ä½•åœ¨ç”¨æ‰‹æŒ‡æ‹–åŠ¨è§†å›¾æ—¶åˆ›å»ºæ‹‰ä¼¸æ•ˆæœã€‚è‡ªç„¶è€Œç„¶åœ°ï¼Œæˆ‘ç«‹åˆ»æƒ³åˆ°äº†ç”¨ç€è‰²å™¨æ¥å®ç°ã€‚ç°åœ¨ç»“æœå·²ç»å‡ºæ¥äº†ï¼Œæˆ‘å¾ˆé«˜å…´åˆ†äº«æˆ‘çš„æ„å»ºè¿‡ç¨‹ã€‚å’Œå¾€å¸¸ä¸€æ ·ï¼Œè¿™ç¯‡æ–‡ç« åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ï¼šç¬¬ä¸€éƒ¨åˆ†å±•ç¤ºäº† Compose çš„ç®€å•è®¾ç½®ï¼Œç¬¬äºŒéƒ¨åˆ†é€æ­¥è®²è§£ç€è‰²å™¨ï¼Œæœ€åï¼Œæˆ‘ä»¬å°†åœ¨ Compose ä¸­æ·»åŠ ä¸€äº›å°ç»†èŠ‚ï¼Œè¿™äº›ç»†èŠ‚å®é™…ä¸Šæ„æˆäº† 90% çš„è§†è§‰æ•ˆæœâ€”â€”å°½ç®¡è¿™å¯èƒ½æ„Ÿè§‰æœ‰ç‚¹ä¸å…¬å¹³ã€‚</p>

<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1196/1*M42RvZvThTrI7UMjelqb5w.gif" alt="æœ€ç»ˆç»“æœ" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰æ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> (é“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders">https://github.com/AleksiejVolkov/runtimeshaders</a>)ä¸Šæ‰¾åˆ°ã€‚ä½ è¿˜å¯ä»¥åœ¨æˆ‘çš„ <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸­æ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœçš„å…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>è®©æˆ‘ä»¬ä»æœ€åŸºæœ¬çš„ Compose è®¾ç½®å¼€å§‹ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä¸ä¼šåŒ…å«ä»»ä½•èƒŒæ™¯å›¾ç‰‡æˆ–é¢å¤–çš„æ ·å¼ã€‚æˆ‘ä»¬ä¼šå°½å¯èƒ½åœ°ä¿æŒç®€æ´ã€‚æˆ‘ä»¬åªéœ€è¦ä¸€ä¸ªåº”ç”¨ç€è‰²å™¨çš„å®¹å™¨ã€ä¸€äº›ç€è‰²å™¨æœ¬èº«çš„å‚æ•°ï¼Œä»¥åŠä¸€ä¸ªæ”¾ç½®åœ¨ç€è‰²å™¨ç›’å†…çš„èœå•æˆ–åˆ—è¡¨çš„åŸºæœ¬æ¨¡æ‹Ÿã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬å¼€å§‹æ‰€éœ€çš„åŸºæœ¬è®¾ç½®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">targetPercentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">percentage</span> <span class="p">=</span> <span class="n">animateFloatAsState</span><span class="p">(</span>
</span><span class='line'>    <span class="n">targetValue</span> <span class="p">=</span> <span class="n">targetPercentage</span><span class="p">,</span>
</span><span class='line'>    <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span>
</span><span class='line'>          <span class="n">durationMillis</span> <span class="p">=</span> <span class="m">1000</span><span class="p">,</span>
</span><span class='line'>          <span class="n">easing</span> <span class="p">=</span> <span class="n">ElasticOutEasing</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">pressed</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">fingerPosition</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">fingerStartPosition</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span><span class="n">Box</span><span class="p">(</span>
</span><span class='line'>  <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                    <span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">awaitPointerEventScope</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">event</span> <span class="p">=</span> <span class="n">awaitPointerEvent</span><span class="p">()</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">change</span> <span class="p">=</span> <span class="n">event</span><span class="p">.</span><span class="n">changes</span><span class="p">.</span><span class="n">firstOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="k">continue</span>
</span><span class='line'>                        <span class="n">pressed</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">pressed</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">.</span><span class="n">pressed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">.</span><span class="n">previousPressed</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                               <span class="n">fingerStartPosition</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">position</span>
</span><span class='line'>                            <span class="p">}</span>
</span><span class='line'>                            <span class="n">targetPercentage</span> <span class="p">=</span> <span class="m">1f</span>
</span><span class='line'>                            <span class="n">fingerPosition</span> <span class="p">=</span> <span class="n">change</span><span class="p">.</span><span class="n">position</span> <span class="p">-</span> <span class="n">fingerStartPosition</span>
</span><span class='line'>                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">targetPercentage</span> <span class="p">=</span> <span class="m">0f</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">event</span><span class="p">.</span><span class="n">changes</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">consume</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;touch&quot;</span><span class="p">,</span> <span class="n">fingerPosition</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">fingerPosition</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">targetPercentage</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">targetPercentage</span> <span class="p">==</span> <span class="m">0f</span><span class="p">)</span> <span class="m">1f</span> <span class="k">else</span> <span class="m">0f</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="c1">//... è¿™é‡Œæ˜¯ä¸‹æ‹‰åˆ—è¡¨æœ¬èº«æˆ–ä»»ä½•å…¶ä»–å¯ä»¥é€šè¿‡æ‹–åŠ¨æ‹‰ä¼¸çš„å¯ç»„åˆé¡¹</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>shader -</strong> è¿™æ˜¯ç€è‰²å™¨æœ¬èº«ï¼Œæˆ‘ä»¬å°†åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ç¼–å†™å®ƒã€‚</p>

<p><strong>targetPercentage</strong>ã€<strong>percentage</strong> å’Œ <strong>pressed -</strong> è¿™äº›æ§åˆ¶ä¼ é€’ç»™ç€è‰²å™¨çš„æ•ˆæœå¼ºåº¦ã€‚æˆ‘ä»¬éœ€è¦å®ƒä»¬æ¥ä¸ºç”¨æˆ·æŠ¬èµ·æ‰‹æŒ‡åçš„â€œåå¼¹â€æ•ˆæœæ·»åŠ åŠ¨ç”»æ•ˆæœã€‚æ€è·¯å¾ˆç®€å•ï¼šå½“æœ‰æ´»åŠ¨è§¦æ‘¸æ—¶ï¼Œå¼ºåº¦ä¸º 1ï¼ˆæœ€å¤§å€¼ï¼‰ï¼Œå½“ç”¨æˆ·æŠ¬èµ·æ‰‹æŒ‡æ—¶ï¼Œæˆ‘ä»¬å°†å…¶åŠ¨ç”»åŒ–ä¸º 0ã€‚æˆ‘ä»¬å°†ä½¿ç”¨è‡ªå®šä¹‰çš„ <strong><em>ElasticOutEasing</em></strong> æ¥ä»£æ›¿å¸¸è§„çš„çº¿æ€§åŠ¨ç”»ï¼Œæˆ‘å°†åœ¨æœ€åä¸€èŠ‚ä¸­å¯¹å…¶è¿›è¡Œæè¿°ã€‚</p>

<p><strong>fingerPosition</strong> å’Œ <strong>fingerStartPosition -</strong> æˆ‘ä»¬åªå°†å¢é‡å‘é‡ä¼ é€’ç»™ç€è‰²å™¨ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å…³å¿ƒæ–¹å‘å’Œå¼ºåº¦ï¼ˆå‘é‡é•¿åº¦ï¼‰ã€‚æ‹‰ä¼¸å§‹ç»ˆä»ä¸­å¿ƒå¼€å§‹ï¼ˆæˆ‘å‘ç°è¿™æ¯”ä»ç²¾ç¡®çš„è§¦æ‘¸ç‚¹å¼€å§‹æ›´ç¾è§‚ï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å­˜å‚¨ä¸¤ä¸ªå€¼ï¼Œå¹¶å°†å®ƒä»¬çš„å·®å€¼ä¼ é€’ç»™ç€è‰²å™¨ã€‚</p>

<p>æ¥ä¸‹æ¥ï¼Œåœ¨ <strong>onSizeChanged</strong> ä¸­ï¼Œæˆ‘ä»¬å°†è§†å›¾å¤§å°ä¼ é€’ç»™ç€è‰²å™¨ã€‚åœ¨ pointerInput ä¸­ï¼Œæˆ‘ä»¬è·Ÿè¸ªæ‹–åŠ¨å¹¶è®¡ç®—å¢é‡å‘é‡ã€‚æœ€åï¼Œåœ¨ <strong>graphicsLayer</strong> ä¸­ï¼Œæˆ‘ä»¬å°†å¢é‡å’Œæ•ˆæœå¼ºåº¦ä¼ é€’ç»™ç€è‰²å™¨ã€‚</p>

<p>æ¥ä¸‹æ¥æ˜¯åŒ…å«å°†è¦æ‹‰ä¼¸çš„è§†å›¾ç¤ºä¾‹çš„ä»£ç å—ã€‚å®ƒå®é™…ä¸Šåªæ˜¯ä¸€æ®µåŸºæœ¬çš„å ä½ç¬¦ä»£ç ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºä¸å€¼å¾—è¯¦ç»†åˆ†æã€‚æˆ‘å°†å…¶åŒ…å«åœ¨è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿â€”â€”è¿™æ ·ä½ å°±å¯ä»¥å¤åˆ¶å®ƒï¼Œè€Œä¸å¿…æ‹…å¿ƒè‡ªå·±ç¼–å†™å®ƒï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">actions</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;Cut&quot;</span><span class="p">,</span> <span class="s">&quot;Copy&quot;</span><span class="p">,</span> <span class="s">&quot;Paste&quot;</span><span class="p">,</span> <span class="s">&quot;Edit&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">Column</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">x8843484C</span><span class="p">),</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">border</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Gray</span><span class="p">,</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">actions</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">action</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">action</span><span class="p">,</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.8f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">vertical</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">action</span> <span class="p">!=</span> <span class="s">&quot;Edit&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">HorizontalDivider</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compose çš„è®¾ç½®å°±åˆ°è¿™é‡Œï¼è®©æˆ‘ä»¬å¼€å§‹ç¼–å†™ç€è‰²å™¨å§ï¼</p>

<p>æˆ‘ä»¬ä»æœ€ç®€å•çš„ç€è‰²å™¨å¼€å§‹ã€‚ä¸‹é¢æ˜¯è¾“å‡ºè¾“å…¥çš„æç®€ä»£ç ï¼Œæ— éœ€è¿›è¡Œä»»ä½•é‡å¤§æ›´æ”¹ã€‚æˆ‘å”¯ä¸€æ·»åŠ çš„æ˜¯ä¸€ä¸ªè¾…åŠ©æ–¹æ³•ï¼Œæ–¹ä¾¿ä»¥åä¿®æ”¹ã€‚å®ƒå«åš <strong>GetImageTexture</strong>ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œä½ å¯ä»¥ä½¿ç”¨ <strong>image.eval(fragCoord)</strong> è¿”å›æ‰€æœ‰æœªæ›´æ”¹çš„å›¾åƒï¼Œä½†æ˜¯ä¸€æ—¦åœ¨é‡æ–°æ˜ å°„å›¾åƒä¹‹å‰å¼€å§‹ä¿®æ”¹åæ ‡ï¼Œå°±éœ€è¦å¤„ç†å®½é«˜æ¯”å’Œå›¾åƒå¹³ç§»â€”â€”è¿™åŸºæœ¬ä¸Šå°±æ˜¯ä½¿ç”¨ä»¥ç”»å¸ƒä¸­å¿ƒä¸ºä¸­å¿ƒçš„åæ ‡ç³»ã€‚è¿™ä¸ªæ–¹æ³•å¯ä»¥å¤„ç†è¿™äº›é—®é¢˜ã€‚ä½ åªéœ€å‘å®ƒä¼ é€’æ ‡å‡†åŒ–çš„ UV åæ ‡ã€è‡ªå®šä¹‰ä¸­å¿ƒç‚¹å’Œåˆ†è¾¨ç‡ï¼Œå®ƒå°±ä¼šè¿”å›æ­£ç¡®çš„ç»“æœã€‚å¦‚æœä½ ç°åœ¨ä½¿ç”¨è¿™äº›è®¾ç½®è¿è¡Œç€è‰²å™¨ï¼Œä½ åº”è¯¥ä¼šçœ‹åˆ°ä¸ä¸ä½¿ç”¨ç€è‰²å™¨æ—¶å®Œå…¨ç›¸åŒçš„å›¾åƒã€‚è¿™æ˜¯ä¸€ä¸ªå¥½å…†å¤´ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float2</span> <span class="n">touch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="p">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span> <span class="p">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">p</span> <span class="p">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">float</span> <span class="n">ratio</span> <span class="p">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">img</span> <span class="p">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vec2</span><span class="p">(</span><span class="m">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">img</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">img</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä½ åœ¨è¿™é‡Œçœ‹åˆ°çš„åº”è¯¥éå¸¸ç†Ÿæ‚‰â€”â€”å‡ ä¹æ‰€æœ‰æˆ‘çš„ç€è‰²å™¨éƒ½æ˜¯è¿™æ ·å¯åŠ¨çš„ï¼Œè¯´å®è¯ï¼Œå¤§å¤šæ•°å…¶ä»–ç€è‰²å™¨ä¹Ÿæ˜¯å¦‚æ­¤ã€‚æˆ‘å†é‡å¤ä¸€éï¼šæˆ‘ä»¬è·å– fragCoordï¼Œå®ƒæ˜¯æ¯ä¸ªåƒç´ ç›¸å¯¹äºè§†å›¾ç”»å¸ƒçš„ä½ç½®ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ ‡å‡†åŒ–çš„ UV åæ ‡ç³»ï¼Œæ ¹æ®å®½é«˜æ¯”è¿›è¡Œè°ƒæ•´ï¼Œå¹¶åç§» 0.5â€”â€”è¿™å°†åŸç‚¹ç½®äºè§†å›¾çš„æ­£ä¸­å¤®ã€‚å¹¶éæ¯ä¸ªäººéƒ½è¿™æ ·åšï¼Œä½†æˆ‘è§‰å¾—è¿™æ ·æ›´æ–¹ä¾¿ã€‚å®ƒå¯ä»¥â€œå…è´¹â€åœ°å®ç°å¾ˆå¤šæ•ˆæœï¼Œæ¯”å¦‚é•œåƒè¡Œä¸ºï¼Œå› ä¸ºæˆ‘ä»¬åªå›´ç»•ä¸­å¿ƒè®¡ç®—ä¸€æ¬¡æ‰€æœ‰å†…å®¹ï¼Œè€Œä¸æ˜¯åˆ†åˆ«å¤„ç†æ¯æ¡è¾¹ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬ç”»å¸ƒçš„ç¤ºæ„å›¾ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*1aPwjWpXJgxlQ8-mCJ2JBA.png" alt="æ–¹å½¢ç”»å¸ƒçš„ç®€å• UV å›¾ç¤º" /></p>

<p>å¥½äº†ï¼Œç°åœ¨è¯¥äº†è§£ä¸€ä¸‹æˆ‘ä»¬æƒ³è¦å®ç°çš„æ•ˆæœäº†ã€‚æˆ‘ä»¬éœ€è¦ä»ä¸­å¿ƒï¼ˆåœ¨å½“å‰å®ç°ä¸­ï¼‰æ²¿ç€ç‰¹å®šå‘é‡æ‹‰ä¼¸ç”»å¸ƒï¼ŒåŒæ—¶ä¿æŒå…¶ä½™éƒ¨åˆ†ä¸å˜ã€‚é‚£ä¹ˆï¼Œå¦‚ä½•æ‹‰ä¼¸ç”»å¸ƒå‘¢ï¼Ÿå…¶å®ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ä¹˜ä»¥ä¸€ä¸ªæ•°å­—ï¼è®©æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹â€”â€”æ·»åŠ ä¸€ä¸ªæ¯”ä¾‹å˜é‡å¹¶å°è¯•ä¸€ä¸‹ã€‚æœ€åï¼Œæˆ‘ä»¬å°† UV ä¹˜ä»¥è¿™ä¸ªæ¯”ä¾‹å‘é‡ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">);</span>
</span><span class='line'><span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">scale</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="p">.</span><span class="n">y</span><span class="p">);</span><span class="k">vec4</span> <span class="n">img</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*_C7fYI8VQn5WKMOFUSnbdA.png" alt="å·¦è¾¹æ˜¯åŸå§‹å›¾åƒï¼Œå³è¾¹æ˜¯æˆ‘ä»¬åº”ç”¨äº†ç¼©æ”¾æ•ˆæœçš„å›¾åƒã€‚" /></p>

<p>å°è¯•ä½¿ç”¨ä¸åŒçš„<strong>scale</strong>å€¼æ¥æ›´å¥½åœ°æ„Ÿå—æ•ˆæœã€‚æ­£å¦‚ä½ æ‰€æ³¨æ„åˆ°çš„â€”â€”ä½¿ç”¨1ä¸ä¼šæ”¹å˜ä»»ä½•å€¼ï¼Œå› ä¸ºä¹˜ä»¥1åå€¼ä¿æŒä¸å˜ã€‚å°äº1çš„å€¼ä¼šæ‹‰ä¼¸å›¾åƒï¼Œè€Œå¤§äº1çš„å€¼ä¼šå‹ç¼©å›¾åƒã€‚è®°ä½è¿™ä¸€ç‚¹â€”â€”æˆ‘ä»¬ç¨åä¼šè®¡ç®—ç¼©æ”¾å¼ºåº¦å¹¶å°†å…¶ä»1ä¸­å‡å»ï¼Œè¿™æ ·å½“ç¼©æ”¾ä¸ºé›¶æ—¶ï¼Œæ•ˆæœä¹Ÿä¸ºé›¶ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¹˜ä»¥äº†ä¸€ä¸ªå•ä½å‘é‡ã€‚</p>

<p>å¤ªå¥½äº†ï¼Œç°åœ¨è®©æˆ‘ä»¬å°†è§¦æ‘¸ä½ç½®æ·»åŠ åˆ°è®¡ç®—ä¸­ã€‚ç®€å•å›é¡¾ä¸€ä¸‹â€”â€”æˆ‘ä»¬ä»è§¦æ‘¸ä¸­æ¥æ”¶äº†ä¸€ä¸ªä½ç§»å‘é‡ã€‚å› æ­¤ï¼Œå½“æ‰‹æŒ‡è§¦æ‘¸å±å¹•æ—¶ï¼Œå‘é‡ä¸º (0, 0)ã€‚å¦‚æœæˆ‘ä»¬å°†æ‰‹æŒ‡å‘å³ç§»åŠ¨ 20 åƒç´ ï¼Œåˆ™å¾—åˆ° (20, 0)ã€‚æˆ‘ä»¬é¦–å…ˆéœ€è¦å¯¹è¿™ä¸ªå‘é‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œå¹¶å°†å…¶ä¹˜ä»¥å®½é«˜æ¯”ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">nMouse</span> <span class="o">=</span> <span class="n">touch</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœæˆ‘ä»¬å°†æ‰‹æŒ‡å‘å·¦ç§»åŠ¨ 20 åƒç´ ï¼Œåˆ™ä¼šå¾—åˆ°ä¸€ä¸ª (-20, 0) çš„å‘é‡ã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸ä¼šç›´æ¥ä½¿ç”¨è¿™ä¸ªå‘é‡ä½œä¸ºæ¯”ä¾‹ï¼Œè€Œæ˜¯å–å…¶é•¿åº¦ã€‚å®ƒçœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">y</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>è®°ä½ï¼Œæ²¡æœ‰æ•ˆæœæ„å‘³ç€ä¹˜ä»¥ 1ï¼Œè€Œä¸æ˜¯ä¹˜ä»¥ 0ï¼Ÿè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä½¿ç”¨æ¯”ä¾‹å‘é‡æ—¶ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ä¹‹å‰å…ˆå°†å…¶ä» 1 ä¸­å‡å»ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">scale</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å¦‚æœä¸€åˆ‡è®¾ç½®æ­£ç¡®ï¼Œæˆ‘ä»¬ç°åœ¨åº”è¯¥èƒ½å¤Ÿæ§åˆ¶æ²¿ä¸¤ä¸ªè½´çš„æ‹‰ä¼¸ã€‚å¤§è‡´å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/1*ix2Fe4IcYGkQ_iHmSHJ3jA.gif" alt="" /></p>

<p>ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆå¥½â€”â€”ç°åœ¨æˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªæ–¹å‘ä¸Šåº”ç”¨æ‹‰ä¼¸ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‘é‡çš„ç‚¹ç§¯ã€‚åŸç†å¾ˆç®€å•ï¼šå¦‚æœå‘é‡æŒ‡å‘åŒä¸€æ–¹å‘ï¼Œåˆ™æ­¤è¿ç®—è¿”å›æ­£å€¼ï¼›å¦‚æœå‘é‡æŒ‡å‘ç›¸åæ–¹å‘ï¼Œåˆ™è¿”å›è´Ÿå€¼ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä½ åœ¨ä¸“ç”¨èµ„æºä¸Šé˜…è¯»æ›´å¤šå…³äºæ­¤è¿ç®—ï¼ˆä»¥åŠå…¶ä»–å‘é‡è¿ç®—ï¼‰çš„å†…å®¹ï¼Œå› ä¸ºçº¿æ€§ä»£æ•°æ˜¯ç€è‰²å™¨ä¸­ä¸€åˆ‡çš„åŸºç¡€ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºå®ƒåœ¨å®è·µä¸­çš„å·¥ä½œåŸç†ï¼</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">nMouse</span><span class="p">),</span> <span class="n">uv</span><span class="p">);</span>
</span><span class='line'><span class="n">scale</span> <span class="o">*=</span> <span class="n">influence</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*aKRAalWcQzf2Jugs18aEoQ.png" alt="åº”ç”¨ç‚¹ç§¯å" /></p>

<p>å¦‚ä½ æ‰€è§ï¼Œæ•ˆæœå·²ç»è¿‘ä¹å®Œç¾ï¼ä½†æˆ‘ä¸å¤ªå–œæ¬¢å¦ä¸€ä¾§åœ¨å¦ä¸€ä¸ªæ–¹å‘ä¸Šå˜å½¢ï¼ˆå³è¢«å‹ç¼©ï¼‰ã€‚è¿™æ˜¯ç‚¹ç§¯çš„å‰¯ä½œç”¨â€”â€”å½“å®ƒè¿”å›è´Ÿå€¼æ—¶ï¼Œç¼©æ”¾æ¯”ä¾‹ä¹Ÿä¼šå˜ä¸ºè´Ÿå€¼ï¼Œç”»å¸ƒçš„è¿™ä¸€éƒ¨åˆ†ä¼šè¢«æŒ¤å‹ã€‚æˆ‘å¸Œæœ›ä¿æŒè§†å›¾çš„è¿™ä¸€éƒ¨åˆ†ä¸å˜ï¼Œæ‰€ä»¥æˆ‘æ·»åŠ äº†ä¸€ä¸ªä»é›¶åˆ°å®šä¹‰æœ€å¤§å€¼çš„çº¿æ€§æ’å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">influence</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åä¸€æ­¥æ˜¯ä¹˜ä»¥â€œæ•ˆæœå¼ºåº¦â€ï¼Œæˆ‘ä»¬é€šè¿‡ç™¾åˆ†æ¯”å‚æ•°ä¼ é€’è¯¥å¼ºåº¦ï¼ˆä¹Ÿè®¸è¿™ä¸æ˜¯æœ€å¥½çš„å‘½åï¼Œä½†æˆ‘ä¹ æƒ¯è¿™æ ·ç§°å‘¼å®ƒï¼‰ã€‚è¿™ä¸ä¼šæ”¹å˜æ‹–åŠ¨è¿‡ç¨‹ä¸­çš„è¡Œä¸ºï¼Œä½†å®ƒå¯ä»¥è®©æˆ‘ä»¬åœ¨æ‹–åŠ¨ç»“æŸåå¹³æ»‘åœ°å°†è§†å›¾æ¢å¤åˆ°åŸå§‹çŠ¶æ€ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="n">scale</span> <span class="o">*=</span> <span class="n">percentage</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>å°±æ˜¯è¿™æ ·ï¼ç€è‰²å™¨å·²å‡†å¤‡å°±ç»ªã€‚ä»¥ä¸‹æ˜¯å®Œæ•´ä»£ç â€”â€”å°½ç®¡æœ€ç»ˆçš„è§†è§‰æ•ˆæœçœ‹èµ·æ¥ä¸°å¯Œè€Œå¤æ‚ï¼Œä½†å®ƒç®€æ´æ˜äº†ã€‚åœ¨æœ€ç»ˆç‰ˆæœ¬ä¸­ï¼Œæˆ‘è¿˜é™åˆ¶äº† x è½´å’Œ y è½´ä¸Šçš„æœ€å¤§ç¼©æ”¾å€¼ã€‚ä½ å¯ä»¥æ ¹æ®éœ€è¦éšæ„è°ƒæ•´è¿™äº›å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">float2</span> <span class="n">touch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>    <span class="n">p</span> <span class="o">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">nMouse</span> <span class="o">=</span> <span class="n">touch</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">nMouse</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">scale</span> <span class="o">=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="mf">0.3</span><span class="p">),</span> <span class="n">min</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">nMouse</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="mf">0.4</span><span class="p">));</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">influence</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">normalize</span><span class="p">(</span><span class="n">nMouse</span><span class="p">),</span> <span class="n">uv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">influence</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">influence</span><span class="p">);</span>
</span><span class='line'>    <span class="n">scale</span> <span class="o">*=</span> <span class="n">influence</span><span class="p">;</span>
</span><span class='line'>    <span class="n">scale</span> <span class="o">*=</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">uv</span> <span class="o">*=</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">scale</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">img</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">img</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æ¥çœ‹çœ‹æˆ‘ä» Compose ä¸­ç•™ä¸‹çš„éƒ¨åˆ†â€”â€”ElasticOutEasingã€‚åœ¨ Compose ä¸­åˆ›å»ºåŠ¨ç”»æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å†…ç½®çš„ç¼“åŠ¨å‡½æ•°ï¼Œä¹Ÿå¯ä»¥å®šä¹‰è‡ªå·±çš„ç¼“åŠ¨å‡½æ•°ã€‚æˆ‘ä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„å¼¹æ€§ç¼“åŠ¨å‡½æ•°ç¤ºä¾‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">ElasticOutEasing</span> <span class="p">=</span> <span class="n">Easing</span> <span class="p">{</span> <span class="n">t</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">p</span> <span class="p">=</span> <span class="m">0.3f</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="p">==</span> <span class="m">0f</span> <span class="p">||</span> <span class="n">t</span> <span class="p">==</span> <span class="m">1f</span><span class="p">)</span> <span class="n">t</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">s</span> <span class="p">=</span> <span class="n">p</span> <span class="p">/</span> <span class="m">4</span>
</span><span class='line'>        <span class="m">2f</span><span class="p">.</span><span class="n">pow</span><span class="p">(-</span><span class="m">10f</span> <span class="p">*</span> <span class="n">t</span><span class="p">)</span> <span class="p">*</span> <span class="n">sin</span><span class="p">((</span><span class="n">t</span> <span class="p">-</span> <span class="n">s</span><span class="p">)</span> <span class="p">*</span> <span class="p">(</span><span class="m">2f</span> <span class="p">*</span> <span class="n">PI</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span> <span class="p">/</span> <span class="n">p</span><span class="p">)</span> <span class="p">+</span> <span class="m">1f</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ­¤ç¼“åŠ¨å‡½æ•°åœ¨åŠ¨ç”»ç»“æŸæ—¶åˆ›å»ºç±»ä¼¼å¼¹è·³çš„æ•ˆæœã€‚å®ƒä¸€å¼€å§‹å¾ˆå¿«ï¼Œç„¶åç•¥å¾®è¶…è¿‡ç›®æ ‡å¹¶ç¨³å®šä¸‹æ¥ï¼Œæ¨¡ä»¿å¼¹ç°§çš„è¡Œä¸ºã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æŒ‡æ•°è¡°å‡ (2^-10t) ä¸æ­£å¼¦æ³¢ç›¸ç»“åˆï¼Œä»¥æ¨¡æ‹Ÿå¼¹æ€§è¿åŠ¨ã€‚å®ƒåœ¨èµ·å§‹ (0) å’Œç»“æŸ (1) å¤„è¿”å›ç²¾ç¡®å€¼ï¼Œä½†åœ¨ä¸¤è€…ä¹‹é—´æ·»åŠ äº†ä¸€ä¸ªæŠ–åŠ¨ã€‚</p>

<p>ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å¸¸è§„çš„çº¿æ€§ç¼“åŠ¨ï¼Œä½†ç»“æœçœ‹èµ·æ¥ä¼šæ›´åŠ å¹³æ·¡ã€‚è¿™æ­£æ˜¯æˆ‘åœ¨å¼€å¤´æåˆ°çš„â€”â€”è¿™ä¸ªå°ç»†èŠ‚ä¸ºæ•´ä½“æ•ˆæœçš„æµç•…åº¦å’Œä»¤äººæ»¡æ„çš„ä½“éªŒè´¡çŒ®äº† 90%ï¼</p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„ <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> æˆ–åœ¨ <a href="https://x.com/KrowaNaMostku">Twitter (X)</a> ä¸Šå…³æ³¨æˆ‘ã€‚è¿™ä¸ªé¡¹ç›®åªæ˜¯æˆ‘çš„ä¸€ä¸ªçˆ±å¥½ï¼Œè¯´å®è¯ï¼Œæˆ‘çš„åŠ¨åŠ›å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ”¶åˆ°çš„åé¦ˆâ€”â€”æ‰€ä»¥æˆ‘éå¸¸é«˜å…´åœ¨é¢‘é“é‡Œè§åˆ°ä½ ã€‚å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œè¯·å°†è¿™ç¯‡æ–‡ç« åˆ†äº«åˆ°ä½ çš„ç¤¾äº¤åª’ä½“ä¸Šï¼Œæˆ‘å°†ä¸èƒœæ„Ÿæ¿€ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[æ·±å…¥æµ…å‡ºç€è‰²å™¨ï¼šæåæ ‡ç³»ä¸ç‚«é…·ç¯å½¢è¿›åº¦æ¡]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader/"/>
    <updated>2025-08-18T14:20:10+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCircle bars with AGSLã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/circle-bars-with-agsl-37d0612c34a2">https://medium.com/@off.mind.by/circle-bars-with-agsl-37d0612c34a2</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2025å¹´1æœˆ6æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/18/circle-bar-with-shader/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*eA4A8yhl-BSTW4EoFMDRJw.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼ä»Šå¤©ï¼Œæˆ‘å°†å‘å¤§å®¶è®²è§£å¦‚ä½•ä½¿ç”¨æåæ ‡ç³»ã€‚è¿™æ˜¯ä¸€ä¸ªé‡è¦ä½†åˆç›¸å½“ç®€å•çš„ä¸»é¢˜ï¼Œå› æ­¤æˆ‘é€‰æ‹©äº†ä¸€ä¸ªç›´æˆªäº†å½“çš„æ•ˆæœï¼Œä»¥é¿å…è¿‡å¤šåœ°æ·±å…¥è®²è§£å…¶ä»–ç»†èŠ‚ã€‚ä¸å¾€å¸¸ä¸€æ ·ï¼Œæœ¬æ•™ç¨‹åˆ†ä¸ºå‡ ä¸ªéƒ¨åˆ†ã€‚é¦–å…ˆï¼Œæˆ‘å°†æ¦‚è¿°è®¾ç½®ç€è‰²å™¨æ‰€éœ€çš„æœ€ç®€ Compose ä»£ç ã€‚åœ¨ç¬¬äºŒéƒ¨åˆ†ä¸­ï¼Œæˆ‘å°†è¯¦ç»†è§£é‡Šç€è‰²å™¨æœ¬èº«ä»¥åŠä½¿ç”¨æåæ ‡çš„åŸç†ã€‚æœ€åï¼Œæˆ‘ä»¬å°†è¿›è¡Œä¸€äº›æ”¶å°¾å·¥ä½œï¼Œä½¿æ•ˆæœæ›´åŠ æƒŠè‰³ã€‚</p>

<p>æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ç°å¦‚ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*RA4vKEMtnGVL78RVxe9Avg.gif" alt="" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ¯ä¸ªæ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ä¸­æ‰¾åˆ°è§†é¢‘ã€æ–°æ•ˆæœçš„å…¬å‘Šä»¥åŠé—®é¢˜çš„è§£ç­”ã€‚æœŸå¾…åœ¨é‚£é‡Œè§åˆ°ä½ ï¼</p></blockquote>

<p>å’Œå¾€å¸¸ä¸€æ ·ï¼Œè®©æˆ‘ä»¬ä»å¸ƒå±€å¼€å§‹ã€‚æˆ‘å°†åŸºç¡€ Compose ç»„ä»¶å‘½åä¸ºâ€œTimerShaderScreenâ€ã€‚åœ¨ç»„ä»¶å†…éƒ¨ï¼Œæˆ‘ä»¬å°†ä»ä¸€ä¸ªâ€œColumnâ€å®¹å™¨å¼€å§‹ï¼Œè¯¥å®¹å™¨é¡¶éƒ¨åŒ…å«ä¸€ä¸ªè¾“å…¥å­—æ®µï¼Œåé¢è·Ÿç€ä¸€ä¸ªâ€œBoxâ€ã€‚è¿™ä¸ªâ€œBoxâ€åœ¨åŒä¸€å±‚çº§ä¸ŠåŒ…å«ä¸€ä¸ªå°†åº”ç”¨ç€è‰²å™¨çš„â€œBoxâ€å’Œä¸€ä¸ªæ˜¾ç¤ºå½“å‰è®¡æ—¶å™¨å€¼çš„â€œTextâ€å…ƒç´ ï¼ˆè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼‰ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªâ€œBoxâ€ï¼Œä½†è¿™ä¼šä½¿ç€è‰²å™¨ç¨å¾®å¤æ‚ä¸€äº›ã€‚ä¸ºäº†ç®€åŒ–æœ¬æ•™ç¨‹ï¼Œæˆ‘é€‰æ‹©äº†ç¨å¾®å¤æ‚çš„æ„å›¾ï¼Œä»¥ä½¿ç€è‰²å™¨ä¿æŒç®€æ´ã€‚åœ¨è¿™ä¸ªâ€œBoxâ€ä¹‹åï¼Œæœ‰ä¸€ä¸ªç”¨äºå¯åŠ¨è®¡æ—¶å™¨çš„æŒ‰é’®ã€‚æˆ‘æä¾›äº†ä¸€ä¸ªå¸ƒå±€å›¾ï¼Œä»¥ä¾¿æ›´æ¸…æ™°åœ°å±•ç¤ºï¼Œä½†æ€»çš„æ¥è¯´ï¼Œå¸ƒå±€æœ¬èº«å·²ç»éå¸¸ç®€å•äº†ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*oIa0bosA1IbHuMZVKw9tFw.png" alt="" /></p>

<p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ·»åŠ å¿…è¦çš„å˜é‡å¹¶å®šä¹‰æ•´ä¸ªå¸ƒå±€ã€‚ç”±äºæˆ‘ä»¬å°šæœªå‡†å¤‡å¥½ç€è‰²å™¨ï¼Œå› æ­¤ä½ å¯ä»¥æš‚æ—¶è·³è¿‡â€œRuntimeShaderâ€å˜é‡ï¼Œåªéœ€è¿è¡Œé¡¹ç›®å¹¶ç¡®ä¿ä¸€åˆ‡æ­£å¸¸å³å¯ã€‚æˆ‘æƒ³å¼ºè°ƒä¸€ä¸ªé‡è¦çš„ç»†èŠ‚ï¼šå¦‚æœä½ å°†ç€è‰²å™¨åº”ç”¨äºä¸€ä¸ªä¸åŒ…å«ä»»ä½•å†…å®¹çš„â€œBoxâ€ï¼Œåˆ™éœ€è¦ä¸ºå…¶è®¾ç½®èƒŒæ™¯é¢œè‰²ã€‚è¿™ç¡®ä¿å®ƒå‚ä¸åˆæˆï¼Œä»è€Œä½¿æˆ‘ä»¬çš„æ•ˆæœå¯è§ã€‚ä½†æ˜¯ï¼ŒåŠ¡å¿…åœ¨åº”ç”¨â€œgraphicsLayerâ€ä¹‹åè®¾ç½®èƒŒæ™¯é¢œè‰²ã€‚å¦åˆ™ï¼Œåªä¼šæ¸²æŸ“é¢œè‰²ï¼Œç€è‰²å™¨å°†ä¸å¯è§ã€‚ç›®å‰ï¼Œå¸ƒå±€åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TimerShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">startValue</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">20</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">percentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0.0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">isRunning</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">seconds</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">startValue</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// circularTimeShaderæ˜¯ä¸€ä¸ªåŒ…å«ç€è‰²å™¨ä»£ç çš„å­—ç¬¦ä¸²å¯¹è±¡ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹é¢çš„éƒ¨åˆ†ä¸­ç¼–å†™</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">circularTimerShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">),</span>
</span><span class='line'>        <span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">horizontalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterHorizontally</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">OutlinedTextField</span><span class="p">(</span>
</span><span class='line'>            <span class="n">value</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">startValue</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="n">startValue</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onValueChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">startValue</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">toIntOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start value&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">it</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">),</span> <span class="c1">// &lt;-- æˆ‘ä»¬å¿…é¡»æ·»åŠ ä¸€äº›é¢œè‰²ï¼Œå¦åˆ™ç©ºæ¡†å°±ä¼šä»æ„å›¾ä¸­ç§»é™¤ï¼Œå°±çœ‹ä¸å‡ºæ•ˆæœäº†</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">textAlign</span> <span class="p">=</span> <span class="n">TextAlign</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>                <span class="n">text</span> <span class="p">=</span> <span class="n">seconds</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">fontSize</span> <span class="p">=</span> <span class="m">50.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>                <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">FontWeight</span><span class="p">.</span><span class="n">Thin</span><span class="p">,</span>
</span><span class='line'>                <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">OutlinedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="p">!</span><span class="n">isRunning</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="s">&quot;Stop&quot;</span> <span class="k">else</span> <span class="s">&quot;Start&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯å®ƒåœ¨æ‰‹æœºä¸Šçš„å®é™…æ˜¾ç¤ºæ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:924/1*HPGAGRtgTmxrihj91xiRXw.png" alt="" /></p>

<p>å‰©ä¸‹çš„å°±æ˜¯æ·»åŠ è®¡æ—¶å™¨æœ¬èº«çš„é€»è¾‘ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹è¿›å…¥æ­£æ–‡äº†ã€‚é¦–å…ˆï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª <code>LaunchedEffect</code> æ¥åœ¨è®¡æ—¶å™¨è¿è¡Œæ—¶æ›´æ–°å…¶å€¼ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å°†åœ¨æ­¤ä»£ç å—ä¸­è®¡ç®—ç€è‰²å™¨çš„ <code>percentage</code>ã€‚ç”±äºæˆ‘ä»¬çš„ç€è‰²å™¨ä¼šä»è®¡æ—¶å™¨çš„èµ·å§‹å€¼å‘ä¸‹è¿‡æ¸¡åˆ°é›¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å¯¹ <code>percentage</code> å˜é‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶ç›¸åº”åœ°ä» 0 å˜ä¸º 1ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span> <span class="c1">// æ—¶é—´åˆ°æ—¶åœæ­¢å€’è®¡æ—¶</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">elapsedTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span> <span class="c1">// å·²ç”¨æ—¶é—´ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰</span>
</span><span class='line'>        <span class="n">percentage</span> <span class="p">=</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">)</span> <span class="p">/</span> <span class="n">startValue</span> <span class="c1">// å°†ç»è¿‡çš„æ—¶é—´å½’ä¸€åŒ–ä¸º[0,1]</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// å°†ç™¾åˆ†æ¯”é™åˆ¶åœ¨ [0, 1] ä¹‹é—´ä»¥é¿å…è¿‡å†²</span>
</span><span class='line'>        <span class="n">percentage</span> <span class="p">=</span> <span class="n">percentage</span><span class="p">.</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// è®¡ç®—å‰©ä½™ç§’æ•°</span>
</span><span class='line'>        <span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="p">((</span><span class="n">startValue</span> <span class="p">-</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">))).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="c1">// å»¶è¿Ÿä»¥æ§åˆ¶æ›´æ–°é¢‘ç‡</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Compose éƒ¨åˆ†å°±åˆ°æ­¤ä¸ºæ­¢ï¼›è®©æˆ‘ä»¬ç»§ç»­ç¼–å†™ç€è‰²å™¨å§ï¼</p>

<p>é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰æ¥è‡ª UI çš„å˜é‡ï¼Œä»¥åŠç€è‰²å™¨çš„æœ€ä½è®¾ç½®ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†è¿”å›åƒç´ ä¸å½’ä¸€åŒ–åæ ‡ä¸­å¿ƒçš„è·ç¦»ï¼Œä½œä¸ºé¢œè‰²ï¼š<code>length(uv)</code>ã€‚å¦‚æœè¿™éƒ¨åˆ†å†…å®¹ä¸å¤ªæ¸…æ¥šï¼Œå¼ºçƒˆå»ºè®®ä½ æŸ¥çœ‹æˆ‘çš„<a href="https://juejin.cn/post/7535292253813981247">æ•™ç¨‹</a>ï¼Œäº†è§£å¦‚ä½•åœ¨ Android ä¸­ä½¿ç”¨ç€è‰²å™¨ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">circularTimerShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>        <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>å› æ­¤ï¼Œç›®å‰æˆ‘ä»¬å¾—åˆ°çš„å¤§è‡´å¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*e2GHAO-1N7K0KBjN4wAYww.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•åœ¨æ ‡å‡†ç¬›å¡å°”å¹³é¢ä¸Šç»˜åˆ¶ä¸€ä¸ªâ€œæ …æ â€ï¼Œå³ä¸€ç³»åˆ—å‚ç›´çš„æ¡å½¢ã€‚å¦‚ä½•å®ç°è¿™ä¸ªæ•ˆæœï¼Ÿé¦–å…ˆï¼Œæˆ‘ä»¬å°† y è½´ä¸Šçš„æ‰€æœ‰å€¼é™åˆ¶åœ¨é›¶ä»¥ä¸‹ã€‚ç€è‰²å™¨ç°åœ¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿˜å°†æ²¿ x è½´è£å‰ªæ‰ä¸€åŠçš„åŒºåŸŸã€‚è®°ä½ï¼Œæˆ‘ä»¬çš„ <code>uv</code> åæ ‡åç§»äº† 0.5ï¼Œä½¿é›¶ç‚¹ä½äºä¸­å¿ƒã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ²¿ x è½´åœ¨é›¶ç‚¹å¤„è£å‰ªï¼Œåªç•™ä¸‹å³ä¸Šè±¡é™ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'><span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬å°† x è½´ä¸Šçš„åæ ‡ä¹˜ä»¥ 10ï¼Œå¹¶åªå–å°æ•°éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†å¾—åˆ°å¦‚ä¸‹æ‰€ç¤ºçš„ x è½´å€¼ï¼š<code>[0...1, 0...1, 0...1, ...]</code>ã€‚å†å°†å®ƒä»¬å¹³ç§» 0.5ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†â€œæ …æ â€ã€‚ä¸‹é¢ï¼Œæˆ‘æ¼”ç¤ºäº†æ„å»ºå‚ç›´æ¡çš„ä¸‰ä¸ªæ­¥éª¤ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">);</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*l7X_24sRzAI7iYZLqeWKFQ.png" alt="" /></p>

<p>ç°åœ¨åˆ°äº†æœ€æ¿€åŠ¨äººå¿ƒçš„éƒ¨åˆ†ï¼šå¦‚ä½•ä»ç¬›å¡å°”åæ ‡ç³»è¿‡æ¸¡åˆ°æåæ ‡ç³»ï¼Ÿæ¢å¥è¯è¯´ï¼Œå¦‚ä½•åˆ›å»ºç›¸åŒçš„â€œæ …æ â€ï¼Œä½†ä½¿å…¶çœ‹èµ·æ¥åƒåœ†å½¢ï¼Ÿè®©æˆ‘ä»¬æ¥å¼„æ¸…æ¥šã€‚</p>

<p>æˆ‘ä»¬ä¹ æƒ¯ç”¨ä¸¤ä¸ªå€¼æ¥æè¿°å‡½æ•°ï¼š<code>x</code> å’Œ <code>y</code>ã€‚è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿç¡®å®šåƒç´ åœ¨å¹³é¢ä¸Šçš„ç²¾ç¡®ä½ç½®å¹¶ä¸ºå…¶åˆ†é…é¢œè‰²ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œåæ ‡ç³»æ˜¯ <code>uv</code>ã€‚ä¸ºäº†å‚ç›´è£å‰ªï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>y</code>ï¼›ä¸ºäº†æ°´å¹³è£å‰ªâ€œæ …æ â€çš„å„ä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>x</code>ã€‚</p>

<p>æåæ ‡ç³»ä¸æ­¤éå¸¸ç›¸ä¼¼ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨çš„ä¸æ˜¯æ°´å¹³è½´å’Œå‚ç›´è½´ï¼Œè€Œæ˜¯åŠå¾„ï¼ˆä¸åŸç‚¹çš„è·ç¦»ï¼‰å’Œè§’åº¦ã€‚</p>

<p>æ¢å¥è¯è¯´ï¼Œç”±äºè¿™ä¸¤ä¸ªåæ ‡ç³»éƒ½åŒ…å«ä¸¤ä¸ªåˆ†é‡ï¼Œç†è§£å®ƒä»¬çš„å«ä¹‰ä½¿æˆ‘ä»¬èƒ½å¤Ÿç›¸å¯¹è½»æ¾åœ°å°†ç¬›å¡å°”åæ ‡ç³»ä¸­ä½¿ç”¨çš„å…¬å¼å’ŒæŠ€æœ¯åº”ç”¨äºæåæ ‡ç³»ã€‚ç„¶è€Œï¼Œæœ€ç»ˆçš„å›¾åƒçœ‹èµ·æ¥ä¼šâ€œå¼¯æ›²â€æˆä¸€ä¸ªåœ†å½¢ã€‚è®©æˆ‘ä»¬å°è¯•å°†â€œæ …æ â€è½¬æ¢ä¸ºæåæ ‡ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec2</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">atan</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬æ¢ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">// åŠå¾„</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span> <span class="c1">// è§’åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">*</span> <span class="n">fence</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*UR389J0im6ziWvc_d9ERzA.png" alt="æåæ ‡ç³»ä¸­çš„â€œæ …æ â€" /></p>

<p>ä½†æ˜¯ï¼Œä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œå…‰çº¿çš„å®½åº¦éšç€è¿œç¦»ä¸­å¿ƒè€Œå¢åŠ ã€‚æˆ‘ä»¬å¯ä»¥æ·»åŠ è¡¥å¿æ¥æ¶ˆé™¤è¿™ç§å½±å“ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å®½åº¦å·²è°ƒæ•´çš„è¿›åº¦æ¡</span>
</span><span class='line'><span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// Bar width</span>
</span><span class='line'><span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'><span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸ä»…éœ€è¦é™åˆ¶å†…åŠå¾„ï¼Œè¿˜éœ€è¦é™åˆ¶å¤–åŠå¾„ï¼Œä»¥åˆ›å»ºä¸€ä¸ªç¯ï¼Œè€Œä¸æ˜¯æ— é™å»¶ä¼¸çš„å…‰çº¿ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨è¿›åº¦æ¡ä¸Š</span>
</span><span class='line'><span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'><span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ€»çš„æ¥è¯´ï¼Œæ­¤æ—¶å®ƒçœ‹èµ·æ¥åº”è¯¥åƒè¿™æ ·ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// è¿›åº¦æ¡å®½åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬åŒ–ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// åŠå¾„</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è§’åº¦</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">innerMask</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å®½åº¦å·²è°ƒæ•´çš„è¿›åº¦æ¡</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨è¿›åº¦æ¡ä¸Š</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ç»“åˆè¿›åº¦æ¡å’Œå†…å±‚è’™ç‰ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1288/1*B_VJQme_vnEdXq0pEmfLZg.png" alt="" /></p>

<p>æœ€åä¸€æ­¥æ˜¯æ ¹æ® <code>percentage</code> çš„å€¼å¢åŠ åˆ—çš„å¤§å°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè§’åº¦ <code>theta</code> çš„å½“å‰èŒƒå›´æ˜¯ä» <code>-Pi</code> åˆ° <code>Pi</code>ï¼Œå› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œå½’ä¸€åŒ–ï¼Œå³å°†å…¶è½¬æ¢ä¸ºä» <code>0</code> åˆ° <code>1</code> çš„èŒƒå›´ã€‚è¿™æ ·å¯ä»¥æ›´å®¹æ˜“åœ°å°†å…¶ä¸ <code>percentage</code> çš„å€¼å¯¹é½ï¼Œå› ä¸º <code>percentage</code> çš„å€¼ä¹Ÿæ˜¯ä» <code>0</code> åˆ° <code>1</code> å˜åŒ–çš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// è¿˜å°†å…¶ç§»åŠ¨ï¼Œä½¿é›¶ä½äºé¡¶éƒ¨è€Œä¸æ˜¯å·¦ä¾§</span>
</span><span class='line'><span class="k">float</span> <span class="n">normalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ä¸ºâ€œwaveâ€åº”ç”¨å¦ä¸€ä¸ªè’™ç‰ˆï¼Œå®ƒå°†å–å†³äº <code>percentage</code> å˜é‡çš„å½“å‰å€¼ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬è¿˜éœ€è¦å°†è¿™ä¸ªæ³¢æµªçš„å€¼æ·»åŠ åˆ° <code>barRadius</code> ä¸­ï¼Œå¹¶åœ¨æœ€åå°†æ•´ä½“é®ç½©ä¹˜ä»¥ <code>waveMask</code>ã€‚æ­¤å¤–ï¼Œæˆ‘å°†æœ€ç»ˆ Alpha å€¼çš„å¸¸é‡å€¼æ›¿æ¢ä¸ºç»„åˆé®ç½©çš„å€¼ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬ç°åœ¨å¾—åˆ°äº†ä¸€ä¸ªå‡ ä¹å®Œæ•´çš„æ•ˆæœã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// å…¶ä½™ä»£ç  ...</span>
</span><span class='line'>
</span><span class='line'><span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">;</span> <span class="c1">// ä½¿ç”¨æ³¢å½¢è’™ç‰ˆè®¾ç½®æ¡å½¢åŠå¾„</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ...</span>
</span><span class='line'>
</span><span class='line'><span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span> <span class="o">*</span> <span class="n">waveMask</span><span class="p">;</span>
</span><span class='line'><span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">combinedMask</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*ZduMs_yVlmd5r7CxADMpRQ.gif" alt="" /></p>

<p>æˆ‘æƒ³åœ¨æœ¬èŠ‚ä¸­æ·»åŠ çš„æœ€åä¸€ç‚¹æ˜¯ç¨å¾®ä¼˜åŒ–ä¸€ä¸‹è’™ç‰ˆã€‚ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œæ¯ä¸ªåˆ—çš„å·¦å³è¾¹ç¼˜åŠå¾„ä¸åŒï¼Œä½†æˆ‘å¸Œæœ›å®ƒä»¬çš„é«˜åº¦ä¸€è‡´ã€‚è¿™æ ·å¯ä»¥ä½¿æ•ˆæœçœ‹èµ·æ¥æ›´ç®€æ´ä¸€äº›ã€‚ä»¥ä¸‹æ˜¯å®ç°æ–¹æ³•ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="c1">// åœ¨æ¯ä¸ªæ¡å½¢çš„ä¸­å¿ƒé‡‡æ ·æ³¢å½¢è’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">barIndex</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">);</span> <span class="c1">// ç¡®å®šæ¡çš„ç´¢å¼•</span>
</span><span class='line'><span class="k">float</span> <span class="n">centerTheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">barIndex</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">;</span> <span class="c1">// æ¡çš„ä¸­å¿ƒè§’</span>
</span><span class='line'><span class="k">float</span> <span class="n">centerNormalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">centerTheta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™ç‰ˆ</span>
</span><span class='line'><span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ€»çš„æ¥è¯´ï¼Œæ ¸å¿ƒæ•ˆæœç°åœ¨å·²ç»å®Œæˆã€‚ç„¶è€Œï¼Œåœ¨ç€è‰²å™¨ä¸­ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œ99% å¤æ‚è€Œæœ‰è¶£çš„å·¥ä½œæ„æˆäº†æ•ˆæœçš„åŸºç¡€ï¼Œä½†å•ç‹¬æ¥çœ‹ï¼Œæ•ˆæœå¯èƒ½çœ‹èµ·æ¥ç®€å•å¹³æ·¡ã€‚æ­£æ˜¯è¿™æœ€åçš„ 1% çš„æ¶¦è‰²ï¼Œæ‰èƒ½å½»åº•æ”¹å˜ä¸€åˆ‡ï¼</p>

<p>è®©æˆ‘ä»¬ä¸ºç€è‰²å™¨æ·»åŠ ä¸€ä¸ªæ¸å˜ã€‚æˆ‘ä½¿ç”¨äº†æœ€ç®€å•çš„ä¸€ä¸ªï¼Œå®ƒåœ¨ <a href="http://shadertoy.com/">ShaderToy</a> ï¼ˆé“¾æ¥ï¼š<a href="http://shadertoy.com/%EF%BC%89%E4%B8%AD%E5%90%AF%E5%8A%A8%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%BB%98%E8%AE%A4%E5%88%9B%E5%BB%BA%EF%BC%88%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E5%B9%B6%E7%82%B9%E5%87%BB%E5%8F%B3%E4%B8%8A%E8%A7%92%E7%9A%84%E2%80%9C%E6%96%B0%E5%BB%BA%E2%80%9D%E6%8C%89%E9%92%AE%E6%9F%A5%E7%9C%8B%EF%BC%89%E3%80%82%E6%88%91%E6%8A%8A%E5%AE%83%E7%A7%BB%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%AD%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E5%91%BD%E5%90%8D%E4%B8%BA">http://shadertoy.com/%EF%BC%89%E4%B8%AD%E5%90%AF%E5%8A%A8%E6%96%B0%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%BB%98%E8%AE%A4%E5%88%9B%E5%BB%BA%EF%BC%88%E4%BD%A0%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E5%B9%B6%E7%82%B9%E5%87%BB%E5%8F%B3%E4%B8%8A%E8%A7%92%E7%9A%84%E2%80%9C%E6%96%B0%E5%BB%BA%E2%80%9D%E6%8C%89%E9%92%AE%E6%9F%A5%E7%9C%8B%EF%BC%89%E3%80%82%E6%88%91%E6%8A%8A%E5%AE%83%E7%A7%BB%E5%88%B0%E4%BA%86%E4%B8%80%E4%B8%AA%E5%8D%95%E7%8B%AC%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%AD%EF%BC%8C%E5%B9%B6%E5%B0%86%E5%85%B6%E5%91%BD%E5%90%8D%E4%B8%BA</a> <code>gradient</code>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec3</span> <span class="n">gradient</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">uv</span><span class="p">.</span><span class="n">xyx</span> <span class="o">+</span> <span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œæˆ‘ä¸å†å°†æœ€ç»ˆé¢œè‰²ä¹˜ä»¥ <code>vec3(1.)</code>ï¼ˆå³ç™½è‰²ï¼‰ï¼Œè€Œæ˜¯å°†å…¶ä¹˜ä»¥æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„æ¸å˜ã€‚æ­¤å¤–ï¼Œæˆ‘è¿˜å¯¹å…¶ä½™åŒºåŸŸåº”ç”¨äº†ç›¸åŒçš„æ¸å˜ï¼Œä½† Alpha å€¼éå¸¸ä½ï¼Œè¿™ä¸ºæ•´ä¸ªå±å¹•å¢æ·»äº†å¾®å¦™çš„è¾‰å…‰ã€‚</p>

<blockquote><p>è¯·æ³¨æ„ï¼Œè¦çœ‹åˆ°è¿™ä¸ªæ•ˆæœï¼Œæˆ‘ä»¬è¿˜å¿…é¡»ä» Compose ä»£ç ä¸­ä¼ é€’ <code>time</code>ã€‚</p></blockquote>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*DXGRdfXQ67eQG7UMnMy8lw.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬è½¬åˆ°é¡¹ç›®çš„å¯ç»„åˆéƒ¨åˆ†ï¼Œå¹¶åœ¨æ–‡æœ¬å˜åŒ–æ—¶æ·»åŠ åŠ¨ç”»å’Œæ¨¡ç³Šæ•ˆæœã€‚æˆ‘ä¸ä¼šè¯¦ç»†ä»‹ç»è¿™ä¸€ç‚¹ï¼Œå› ä¸ºè¿™è¶…å‡ºäº†æœ¬è¯¾çš„èŒƒå›´ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ¬æ•™ç¨‹å®Œå…¨ä¸åŒ…å«ä»£ç ï¼Œæ„Ÿè§‰ä¸å¤ªå¯¹åŠ²ã€‚æ‰€ä»¥ï¼Œä»¥ä¸‹æ˜¯å¯ç»„åˆéƒ¨åˆ†ï¼ˆåŒ…å«æ—¶é—´æ›´æ–°å’Œæ–‡æœ¬åŠ¨ç”»ï¼‰çš„æœ€ç»ˆç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">TimerShaderScreen</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">:</span> <span class="n">PaddingValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">startValue</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">20</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">percentage</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableFloatStateOf</span><span class="p">(</span><span class="m">0.0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">isRunning</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">circularTimerShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">seconds</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">startValue</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">startTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span> <span class="c1">// æ—¶é—´åˆ°æ—¶åœæ­¢å€’è®¡æ—¶</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">elapsedTime</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span> <span class="p">-</span> <span class="n">startTime</span> <span class="c1">// å·²ç”¨æ—¶é—´ï¼ˆå•ä½æ˜¯æ¯«ç§’ï¼‰</span>
</span><span class='line'>            <span class="n">percentage</span> <span class="p">=</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">)</span> <span class="p">/</span> <span class="n">startValue</span> <span class="c1">// å°†ç»è¿‡çš„æ—¶é—´å½’ä¸€åŒ–ä¸º[0,1]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// å°†ç™¾åˆ†æ¯”é™åˆ¶åœ¨ [0, 1] ä¹‹é—´ä»¥é¿å…è¿‡å†²</span>
</span><span class='line'>            <span class="n">percentage</span> <span class="p">=</span> <span class="n">percentage</span><span class="p">.</span><span class="n">coerceIn</span><span class="p">(</span><span class="m">0f</span><span class="p">,</span> <span class="m">1f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// è®¡ç®—å‰©ä½™ç§’æ•°</span>
</span><span class='line'>            <span class="n">seconds</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="p">((</span><span class="n">startValue</span> <span class="p">-</span> <span class="p">(</span><span class="n">elapsedTime</span> <span class="p">/</span> <span class="m">1000f</span><span class="p">))).</span><span class="n">toInt</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span> <span class="c1">// å»¶è¿Ÿä»¥æ§åˆ¶æ›´æ–°é¢‘ç‡</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">paddingValues</span><span class="p">),</span>
</span><span class='line'>        <span class="n">verticalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">horizontalAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">CenterHorizontally</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">OutlinedTextField</span><span class="p">(</span>
</span><span class='line'>            <span class="n">value</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">startValue</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> <span class="n">startValue</span><span class="p">.</span><span class="n">toString</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onValueChange</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">startValue</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">toIntOrNull</span><span class="p">()</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Start value&quot;</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">250.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">it</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;percentage&quot;</span><span class="p">,</span> <span class="n">percentage</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="k">var</span> <span class="py">previousSeconds</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">seconds</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">coerceAtLeast</span><span class="p">(</span><span class="m">0</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">AnimatedContent</span><span class="p">(</span>
</span><span class='line'>                <span class="n">targetState</span> <span class="p">=</span> <span class="n">seconds</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">coerceAtLeast</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
</span><span class='line'>                <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="p">(</span><span class="n">slideInVertically</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">))</span> <span class="p">{</span> <span class="n">height</span> <span class="p">-&gt;</span> <span class="p">-</span><span class="n">height</span> <span class="p">}</span> <span class="p">+</span> <span class="n">fadeIn</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span>
</span><span class='line'>                            <span class="m">500</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">))</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">togetherWith</span><span class="p">(</span><span class="n">slideOutVertically</span><span class="p">(</span><span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">))</span> <span class="p">{</span> <span class="n">height</span> <span class="p">-&gt;</span> <span class="n">height</span> <span class="p">}</span> <span class="p">+</span> <span class="n">fadeOut</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">tween</span><span class="p">(</span><span class="m">500</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">))</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'>                <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;CountdownAnimation&quot;</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span> <span class="n">targetSeconds</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="c1">// æ£€æµ‹æ˜¯å¦æ­£åœ¨è½¬æ¢</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">isTransitioning</span> <span class="p">=</span> <span class="n">targetSeconds</span> <span class="p">!=</span> <span class="n">previousSeconds</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// è¿‡æ¸¡æœŸé—´æ¨¡ç³ŠåŠ¨ç”»</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">blurRadius</span> <span class="k">by</span> <span class="n">animateFloatAsState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">targetValue</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">isTransitioning</span><span class="p">)</span> <span class="m">30f</span> <span class="k">else</span> <span class="m">0f</span><span class="p">,</span> <span class="c1">// è¿‡æ¸¡æ—¶æ¨¡ç³Š</span>
</span><span class='line'>                    <span class="n">animationSpec</span> <span class="p">=</span> <span class="n">tween</span><span class="p">(</span><span class="n">durationMillis</span> <span class="p">=</span> <span class="m">500</span><span class="p">)</span> <span class="c1">// åŒ¹é…è¿‡æ¸¡æŒç»­æ—¶é—´</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// è½¬æ¢å®Œæˆåæ›´æ–° previousSeconds</span>
</span><span class='line'>                <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">targetSeconds</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">previousSeconds</span> <span class="p">=</span> <span class="n">targetSeconds</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="c1">// åº”ç”¨åŠ¨ç”»æ¨¡ç³Šæ•ˆæœ</span>
</span><span class='line'>                            <span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span><span class="p">.</span><span class="n">createBlurEffect</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">blurRadius</span><span class="p">,</span> <span class="n">blurRadius</span><span class="p">,</span> <span class="n">android</span><span class="p">.</span><span class="n">graphics</span><span class="p">.</span><span class="n">Shader</span><span class="p">.</span><span class="n">TileMode</span><span class="p">.</span><span class="n">CLAMP</span>
</span><span class='line'>                            <span class="p">).</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">},</span>
</span><span class='line'>                    <span class="n">textAlign</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">TextAlign</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">text</span> <span class="p">=</span> <span class="n">targetSeconds</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">fontSize</span> <span class="p">=</span> <span class="m">50.</span><span class="n">sp</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">fontWeight</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">text</span><span class="p">.</span><span class="n">font</span><span class="p">.</span><span class="n">FontWeight</span><span class="p">.</span><span class="n">Thin</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">OutlinedButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">isRunning</span> <span class="p">=</span> <span class="p">!</span><span class="n">isRunning</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">top</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isRunning</span><span class="p">)</span> <span class="s">&quot;Stop&quot;</span> <span class="k">else</span> <span class="s">&quot;Start&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ä»¥åŠæœ€ç»ˆçš„ç€è‰²å™¨ä»£ç ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">float</span> <span class="n">percentage</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span><span class="k">vec2</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">atan</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec2</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span><span class="k">vec3</span> <span class="n">gradient</span><span class="p">(</span><span class="k">vec2</span> <span class="n">uv</span><span class="p">,</span> <span class="k">float</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">uv</span><span class="p">.</span><span class="n">xyx</span> <span class="o">+</span> <span class="k">vec3</span><span class="p">(</span><span class="mo">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span><span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span> <span class="c1">// å½’ä¸€åŒ–åæ ‡</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">;</span> <span class="c1">// æ¡å½¢å®½åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è½¬æ¢ä¸ºæåæ ‡</span>
</span><span class='line'>    <span class="k">vec2</span> <span class="n">polar</span> <span class="o">=</span> <span class="n">cartesianToPolar</span><span class="p">(</span><span class="n">uv</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">r</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">x</span><span class="p">;</span> <span class="c1">// åŠå¾„</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">polar</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>    <span class="c1">// è§’åº¦</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">float</span> <span class="n">innerMask</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†é¡¶éƒ¨è®¾ä¸ºé›¶ï¼Œä½¿è§’åº¦æ ‡å‡†åŒ–</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">normalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">theta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å›ºå®šç™¾åˆ†æ¯”è¡¥å¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fixPercentage</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">+</span> <span class="n">percentage</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// åœ¨æ¯ä¸ªæ¡å½¢çš„ä¸­å¿ƒé‡‡æ ·æ³¢å½¢è’™æ¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barIndex</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">);</span> <span class="c1">// ç¡®å®šæ¡çš„ç´¢å¼•</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">centerTheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">barIndex</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">;</span> <span class="c1">// æ¡çš„ä¸­å¿ƒè§’</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">centerNormalizedAngle</span> <span class="o">=</span> <span class="n">mod</span><span class="p">((</span><span class="n">centerTheta</span> <span class="o">+</span> <span class="mf">1.57079632679</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.28318530718</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// è®¡ç®—æ¡å½¢ä¸­å¿ƒçš„æ³¢æµªè’™æ¿</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">wave</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">fixPercentage</span><span class="p">,</span> <span class="n">fixPercentage</span> <span class="o">-</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">centerNormalizedAngle</span><span class="p">);</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">waveMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="mf">0.32</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="mf">0.31</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å®½åº¦å·²è°ƒæ•´çš„æ¡å½¢å›¾æ¡ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">adjustedWidth</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">);</span> <span class="c1">// è¡¥å¿å¾„å‘ç¼©æ”¾</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">fence</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">adjustedWidth</span><span class="p">,</span> <span class="n">fract</span><span class="p">(</span><span class="n">theta</span> <span class="o">*</span> <span class="mf">10.0</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// å°†æ³¢æµªè’™ç‰ˆå‡åŒ€åœ°æ¶‚æŠ¹åœ¨å§å°ä¸Š</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barRadius</span> <span class="o">=</span> <span class="mf">0.3</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">wave</span><span class="p">;</span> <span class="c1">// ä½¿ç”¨æ³¢å½¢è’™ç‰ˆè®¾ç½®æ¡å½¢åŠå¾„</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">barMask</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">barRadius</span><span class="o">+</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">barRadius</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ç»“åˆæ¡å½¢å’Œå†…å±‚è’™ç‰ˆ</span>
</span><span class='line'>    <span class="k">float</span> <span class="n">combinedMask</span> <span class="o">=</span> <span class="n">barMask</span> <span class="o">*</span> <span class="n">fence</span> <span class="o">*</span> <span class="n">innerMask</span> <span class="o">*</span> <span class="n">waveMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
</span><span class='line'>    <span class="k">vec3</span> <span class="n">col</span> <span class="o">=</span> <span class="n">grad</span> <span class="o">*</span> <span class="n">combinedMask</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="n">grad</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">combinedMask</span> <span class="o">+</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ„Ÿè°¢é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”è®²è§£æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚ä½ çš„æ”¯æŒæ„ä¹‰é‡å¤§ï¼Œå¹¶æ¿€åŠ±ç€æˆ‘ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ç”¨Composeä¸­çš„Shaderå®ç°ä¸€ä¸ªé›ªèŠ±é£˜é£˜å¼¹çª—æ•ˆæœ]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader/"/>
    <updated>2025-08-17T14:02:24+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒSnow Dialog Shader Tutorialã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20">https://medium.com/@off.mind.by/snow-dialog-shader-tutorial-dde1b4a61e20</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´12æœˆ27æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/17/snow-dialog-shader/"><img src="https://miro.medium.com/v2/resize:fit:2000/1*oNN6ZtalbQEvYCpTx8gLWg.png" title="auto auto" ></a></p>

<!-- more -->


<p>å¤§å®¶å¥½ï¼åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘å°†å‘å¤§å®¶å±•ç¤ºå¦‚ä½•åˆ›å»ºé›ªèŠ±è¦†ç›–çš„å¯¹è¯æ¡†æ•ˆæœã€‚æ€»çš„æ¥è¯´ï¼Œè¯¥æ•ˆæœå¯ä»¥åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>

<ol>
<li><strong>è®¾ç½® Compose ä»£ç </strong>ï¼šè¿™ç¡®ä¿äº†åŸºç¡€æ•ˆæœçš„å®ç°ã€‚</li>
<li><strong>åˆ›å»ºå¯¹è¯æ¡†åº•éƒ¨ç§¯é›ªçš„ç€è‰²å™¨</strong>ï¼šè¿™æ˜¯æˆ‘åœ¨ä»Šå¤©æ•™ç¨‹ä¸­é‡ç‚¹è®²è§£çš„æ ¸å¿ƒæ•ˆæœã€‚</li>
<li><strong>æ·»åŠ é£˜è½çš„é›ªèŠ±</strong>ï¼šä¸ºæ­¤ï¼Œæˆ‘åœ¨ ShaderToy ä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªç°æˆçš„ç€è‰²å™¨ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–ï¼Œä½¿å…¶ä¸ä¼šå¯¹æ‰‹æœºæ€§èƒ½é€ æˆå¤ªå¤§è´Ÿæ‹…ã€‚ç¬¬ä¸‰éƒ¨åˆ†å°†åŒ…å«åŸå§‹ç€è‰²å™¨çš„é“¾æ¥ä»¥åŠä¸€äº›ä¼˜åŒ–è¯´æ˜ã€‚</li>
</ol>


<p>æœ¬æ•™ç¨‹ä¸»è¦è®²è§£å¦‚ä½•ä¸ºå¯¹è¯æ¡†åˆ›å»ºä¸æ–­å¢é•¿çš„é›ªç›–æ•ˆæœã€‚</p>

<p>æœ€ç»ˆæ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:804/1*SRa57BglcDzpLzAAw1UAPw.gif" alt="æœ€ç»ˆæ•ˆæœ" /></p>

<blockquote><p>åœ¨æ·±å…¥æ¢è®¨ä¹‹å‰ï¼Œæˆ‘æƒ³æé†’ä½ ï¼Œæˆ‘å¹¶æ²¡æœ‰ä¸ºæ‰€æœ‰æ•ˆæœåˆ›å»ºæ•™ç¨‹ã€‚ä¸è¿‡ï¼Œæ‰€æœ‰æ•ˆæœéƒ½å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/AleksiejVolkov/runtimeshaders">GitHub</a> ï¼ˆé“¾æ¥ï¼š<a href="https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84">https://github.com/AleksiejVolkov/runtimeshaders%EF%BC%89%E4%B8%8A%E6%89%BE%E5%88%B0%E3%80%82%E4%BD%A0%E8%BF%98%E5%8F%AF%E4%BB%A5%E5%9C%A8%E6%88%91%E7%9A%84</a> <a href="https://t.me/droidshaderworks">Telegram é¢‘é“</a> ï¼ˆé“¾æ¥ï¼š<a href="https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81">https://t.me/droidshaderworks%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E8%A7%86%E9%A2%91%E3%80%81%E6%96%B0%E6%95%88%E6%9E%9C%E5%85%AC%E5%91%8A%E4%BB%A5%E5%8F%8A%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E7%AD%94%E3%80%82%E6%9C%9F%E5%BE%85%E5%9C%A8%E9%82%A3%E9%87%8C%E8%A7%81%E5%88%B0%E4%BD%A0%EF%BC%81</a></p></blockquote>

<p>è®©æˆ‘ä»¬ä» Compose ä¸­ä¸ºæ•ˆæœè®¾ç½®ä¸€ä¸ªæœ€å°é¡µé¢å¼€å§‹ã€‚å®ƒåŒ…å«ä¸€å¼ èƒŒæ™¯å›¾ç‰‡å’Œä¸€ä¸ªä½äºä¸­å¿ƒçš„æŒ‰é’®ï¼Œç”¨äºè§¦å‘å¯¹è¯æ¡†ã€‚</p>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹è¯æ¡†ä¸åº”æ¥è‡ª Material åº“ï¼Œè€Œåº”ä½¿ç”¨ Compose ä¸­æœ€åŸºæœ¬çš„â€œAlertDialogâ€ã€‚</p>

<p>ä»¥ä¸‹æ˜¯æœ€ä½é…ç½®ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">SnowDialogScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showDialog</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>            <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">christmas_night</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Sample Image&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">contentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>        <span class="k">if</span> <span class="p">(!</span><span class="n">showDialog</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">showDialog</span> <span class="p">=</span> <span class="k">true</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Ho-ho-ho!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SnowedDialog</span> <span class="p">{</span> <span class="n">showDialog</span> <span class="p">=</span> <span class="k">false</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Merry Christmas!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">titleLarge</span><span class="p">)</span>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Happy New Year!&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">26.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>            <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">End</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Close&quot;</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">bodyMedium</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">primary</span><span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆï¼Œä½ åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*fnlF56ZxRxMwa7vHkCOudA.png" alt="é¢œè‰²å¯èƒ½ä¼šæœ‰æ‰€ä¸åŒï¼Œæ­¤å¤–è§‚å·²é’ˆå¯¹æš—é»‘æ¨¡å¼è¿›è¡Œäº†è°ƒæ•´" /></p>

<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç¼–å†™ç€è‰²å™¨äº†ï¼æˆ‘å°†ç®€è¦ä»‹ç»å¦‚ä½•è®¾ç½®ç€è‰²å™¨å¹¶å°†å…¶é™„åŠ åˆ°å¯¹è¯æ¡†ä¸­ã€‚æœ‰å…³è¿è¡Œæ—¶ç€è‰²å™¨çš„æ›´è¯¦ç»†ä»‹ç»å’Œåˆå­¦è€…æŒ‡å—ï¼Œä½ å¯ä»¥æŸ¥çœ‹æˆ‘çš„å¦ä¸€ä¸ª<a href="https://juejin.cn/post/7535292253813981247">æ•™ç¨‹</a>ã€‚</p>

<p>å¼€å§‹ä½¿ç”¨ç€è‰²å™¨æ‰€éœ€çš„æœ€ä½è¦æ±‚å¦‚ä¸‹æ‰€ç¤ºã€‚åœ¨å¯¹è¯æ¡†ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ ä¸€ä¸ª <code>runtimeShader</code>ï¼Œå¹¶ä½¿ç”¨ <code>graphicsLayer</code> å°†å…¶åˆ†é…ç»™ <code>Column</code>ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ä»å­—ç¬¦ä¸²ç¼–è¯‘æˆ‘ä»¬çš„ç€è‰²å™¨</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="c1">// pass resolution</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// apply shader </span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">// å…¶ä½™ä»£ç ä¿æŒä¸å˜</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//...</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Language</span><span class="p">(</span><span class="s">&quot;agsl&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uniform</span> <span class="n">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="n">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span> <span class="p">/</span> <span class="n">resolution</span> <span class="p">-</span> <span class="m">0.5</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)&gt;</span><span class="m">0.5</span> <span class="p">||</span> <span class="n">abs</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)&gt;</span><span class="m">0.5</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>             <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="m">0.0</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="n">float</span> <span class="n">ratio</span> <span class="p">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="p">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>         <span class="n">vec4</span> <span class="n">imageColor</span> <span class="p">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">vec4</span><span class="p">(</span><span class="n">vec3</span><span class="p">(</span><span class="m">1.0</span><span class="p">),</span> <span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç›®å‰ï¼Œå®ƒå°†æ˜¾ç¤ºä¸ºä¸€ä¸ªç©ºç™½çŸ©å½¢ï¼Œå°±åƒæˆ‘ä»¬çš„å¯¹è¯æ¡†ä¸€æ ·ï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*C5O1IMHS7MvK0lFnIqHFYA.png" alt="" /></p>

<p>åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘å…ˆå°½å¯èƒ½ç®€å•åœ°è§£é‡Šä¸€ä¸‹å®ç°æ­¤æ•ˆæœèƒŒåçš„é€»è¾‘ã€‚æˆ‘å°†ç®—æ³•åˆ†ä¸ºå››ä¸ªæ¦‚å¿µæ­¥éª¤ï¼š</p>

<ol>
<li><strong>æ‰¾åˆ°ä¸€ä¸ªå‡½æ•°</strong>æ¥å®šä¹‰é›ªè¾¹ç¼˜çš„è½®å»“ã€‚</li>
<li><strong>åœ¨ y è½´ä¸Š</strong>ç»˜åˆ¶æ­¤å‡½æ•°ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹**ï¼Œå¹¶å°†å…¶å‚ç›´ç§»å‘åº•éƒ¨è¾¹ç¼˜ã€‚</li>
<li><strong>å®šä¹‰ä¸€ä¸ªé®ç½©åŒºåŸŸ</strong>ï¼Œè¿™æ„å‘³ç€åœ¨æ­¤åŒºåŸŸä¹‹å¤–ï¼Œå‡½æ•°å°†è¢«å®Œå…¨å¿½ç•¥ï¼Œæˆ‘ä»¬åªéœ€ç»˜åˆ¶ç€è‰²å™¨ä»ç³»ç»Ÿæ¥æ”¶çš„å†…å®¹å³å¯ã€‚</li>
<li><strong>ä¿®æ”¹ä¾§é¢å’Œé¡¶éƒ¨çš„é®ç½©</strong>ï¼Œä½¿é›ªçš„å½¢çŠ¶æ›´è‡ªç„¶ï¼Œè€Œåº•éƒ¨è¾¹ç¼˜çš„è½®å»“åˆ™ç”±æˆ‘ä»¬çš„å‡½æ•°å¤„ç†ã€‚</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Vbq5YEL42g1tQsLjWKAokQ.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬åœ¨ç€è‰²å™¨ä¸­æŒ‰é¡ºåºå®ç°è¿™äº›æ­¥éª¤ã€‚ä¸ºç®€å•èµ·è§ï¼Œæˆ‘é€‰æ‹©äº†ä¸€ä¸ªåŸºæœ¬çš„æ­£å¼¦æ³¢ä½œä¸ºé›ªè¾¹ç¼˜çš„å‡½æ•°ã€‚æˆ‘æ·»åŠ äº†ä¸€äº›ç³»æ•°æ¥å‹ç¼©å®ƒå¹¶é™ä½å…¶æŒ¯å¹…ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ç™½è‰²å¡«å……æ­¤çº¿ä¸Šæ–¹çš„æ‰€æœ‰å†…å®¹ï¼ŒåŒæ—¶å¿½ç•¥å…¶ä¸‹æ–¹çš„æ‰€æœ‰å†…å®¹ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">vec4</span> <span class="n">snow</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">)</span><span class="o">*</span><span class="k">vec4</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>é€šè¿‡å‘ <code>uv.y</code> æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼Œæˆ‘ä»¬å¯ä»¥å‚ç›´ç§»åŠ¨æ•´ä¸ªå‡½æ•°ã€‚</p></blockquote>

<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦å°†è¯¥æ–¹æ³•ç§»è¿‘å¯¹è¯æ¡†çš„åº•éƒ¨è¾¹ç¼˜å¹¶æ·»åŠ ä¸€ä¸ªé®ç½©ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç®€å•çš„çŸ©å½¢åŒºåŸŸä½œä¸ºé®ç½©ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†åˆ«æŒ‡å®šæ¯ä¸ªè¾¹ç¼˜æ¥å®šä¹‰å®ƒã€‚è¿™ç§æ–¹æ³•å¯èƒ½çœ‹èµ·æ¥æœ‰ç‚¹å†—é•¿ï¼Œä½†å®ƒä½¿ä»£ç æ›´å®¹æ˜“ç†è§£ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'> <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span><span class="p">;</span>
</span><span class='line'>         <span class="n">snowEdge</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">leftBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">rightBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">topBound</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="n">snowMask</span> <span class="o">*=</span> <span class="n">snowEdge</span><span class="p">;</span>
</span><span class='line'>         <span class="k">vec4</span> <span class="n">imageColor</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">snowColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">imageColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">snowColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="o">+</span><span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>è°ƒæ•´åï¼Œæˆ‘ä»¬åº”è¯¥å¾—åˆ°ç±»ä¼¼è¿™æ ·çš„ç»“æœã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*GM2d-tsCUOAHnloMiDYAAA.png" alt="" /></p>

<p>ç°åœ¨å¯èƒ½ä¸æ˜¯æåŠè¿™ä¸€ç‚¹çš„æœ€ä½³æ—¶æœºï¼Œä¹Ÿè®¸åº”è¯¥æ—©ç‚¹æåŠï¼Œä½†åœ¨è¿™é‡Œå¼ºè°ƒè¿™ä¸€ç‚¹è‡³å…³é‡è¦ã€‚è¯·è®°ä½ï¼Œæˆ‘ä»¬å¯¹åæ ‡è¿›è¡Œäº†å½’ä¸€åŒ–ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†å¹³ç§»ï¼Œä½¿é›¶ç‚¹æ°å¥½ä½äºç”»å¸ƒï¼ˆå³å¯¹è¯æ¡†ï¼‰çš„ä¸­å¿ƒã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š<code>_float2 uv = fragCoord/resolution â€” 0.5;_</code></p>

<p>ç†è§£è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œå› ä¸ºç°åœ¨æˆ‘æƒ³å‡å°ä¸­å¿ƒæ­£å¼¦æ³¢çš„æŒ¯å¹…ï¼Œå¹¶éšç€æˆ‘ä»¬å‘å·¦å³ä¸¤ä¾§è¿œç¦»ä¸­å¿ƒè€Œå¢å¤§æŒ¯å¹…ã€‚ç†è§£åæ ‡ç³»çš„è®¾ç½®æ–¹å¼åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å°†å‡½æ•°ä¹˜ä»¥æ²¿ x è½´è·ç¦»ä¸­å¿ƒçš„è·ç¦»æ¥å®ç°è¿™ä¸€ç‚¹ã€‚è¿™æ ·ï¼Œå‡½æ•°å°†åœ¨ä¸­å¿ƒå¤„æ°å¥½è¿”å›é›¶ç‚¹ï¼Œå¹¶éšç€å‘å¤–ç§»åŠ¨è€Œå¢å¤§ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å°†å®ç°ä»¥ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*oW8OP3R2VFo0SkJmDhgVSw.png" alt="" /></p>

<p>ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å‡½æ•°è€Œä¸æ˜¯å¸¸é‡æ¥å®šä¹‰é®ç½©çš„é¡¶éƒ¨è¾¹ç•Œã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨å¦ä¸€ä¸ªæ­£å¼¦æ³¢ï¼Œä½†é—´éš”ç­‰äºå¯¹è¯æ¡†çš„å®½åº¦ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="mf">0.8</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">.2</span><span class="o">+</span><span class="mf">0.3</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å°†ä¸ºå·¦å³è¾¹ç•Œæ·»åŠ ç±»ä¼¼çš„ä»£ç ï¼šæˆ‘å¸Œæœ›å®ƒä»¬ä¹Ÿä½¿ç”¨æ­£å¼¦æ³¢ï¼Œä½†è¿™æ¬¡æ˜¯å‚ç›´è¿è¡Œçš„ã€‚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">+</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'><span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.4</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€åï¼Œæˆ‘ä»¬éœ€è¦ä¸ºåº•éƒ¨è¾¹ç¼˜æ·»åŠ ä¸€ä¸ªå¸¸é‡ï¼šè¿™æ˜¯ä¸€ä¸ªæ—¶é—´å˜é‡ï¼Œæˆ‘ä»¬ä¼šå°†å®ƒä» Compose ä¼ é€’ç»™ç€è‰²å™¨ã€‚åœ¨ç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€æ·»åŠ ç›¸åº”çš„ <code>uniform</code> å˜é‡ï¼Œå¹¶å°†åº•éƒ¨è¾¹ç¼˜å‡½æ•°ä¹˜ä»¥å®ƒå³å¯ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'><span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>    <span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>    <span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>        <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">fragCoord</span> <span class="o">/</span> <span class="n">resolution</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>         <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">ratio</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">adjustedTime</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowEdge</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">adjustedTime</span><span class="p">;</span>
</span><span class='line'>         <span class="n">snowEdge</span> <span class="o">=</span> <span class="n">step</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">snowEdge</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">topBound</span> <span class="o">=</span> <span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">ratio</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span><span class="o">*</span><span class="mf">0.8</span><span class="o">+</span><span class="mf">2.</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">.2</span><span class="o">+</span><span class="mf">0.3</span><span class="p">;</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">leftBound</span> <span class="o">=</span> <span class="o">-</span><span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">+</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'>         <span class="k">float</span> <span class="n">rightBound</span> <span class="o">=</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="o">-</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="mf">10.</span><span class="o">*</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="mf">0.4</span><span class="o">*</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span><span class="o">-</span><span class="n">topBound</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">float</span> <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">0.</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">leftBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">rightBound</span> <span class="o">&amp;&amp;</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">topBound</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">snowMask</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">snowMask</span> <span class="o">*=</span> <span class="n">snowEdge</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">vec4</span> <span class="n">imageColor</span> <span class="o">=</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">snowColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>         <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">imageColor</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">snowColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">snowMask</span><span class="o">+</span><span class="n">imageColor</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>åˆ«å¿˜äº†ä»composableä¸­æä¾›æ—¶é—´ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// è¿™é‡Œæä¾›æ—¶é—´ï¼š</span>
</span><span class='line'>                    <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="c1">// å…¶ä½™ä»£ç ä¿æŒä¸å˜</span>
</span></code></pre></td></tr></table></div></figure>


<p>æˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹æ•ˆæœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*5YYiM3lZYp42O8Fa9iS-4A.gif" alt="" /></p>

<p>å…³äºè¿™ä¸ªæ•ˆæœï¼Œæˆ‘æƒ³åˆ†äº«çš„å·®ä¸å¤šå°±æ˜¯è¿™äº›äº†ï¼è¿™æ˜¯æ ¸å¿ƒæ€æƒ³ï¼Œä»è¿™é‡Œå¼€å§‹ï¼Œä½ å¯ä»¥å°è¯•ä¸åŒçš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œæˆ‘ç”¨ä¸€ä¸ªåŸºäº Perlin å™ªå£°çš„æ›´æ··ä¹±çš„ç‰ˆæœ¬æ›¿æ¢äº†åŸºæœ¬çš„æ­£å¼¦æ³¢ã€‚</p>

<p>ä½†è¿™äº›åªæ˜¯ç»†èŠ‚ï¼Œåœ¨å®ç°ä¸Šå¯ä»¥æœ‰æ— é™çš„å˜åŒ–ã€‚åˆ›å»ºç€è‰²å™¨çš„å…³é”®åœ¨äºæŒæ¡å…¶èƒŒåçš„æ ¸å¿ƒæ€æƒ³ã€‚</p>

<p>ä½ å¯ä»¥åœ¨æˆ‘çš„ä»£ç åº“ä¸­æ‰¾åˆ°æˆ‘çš„å®ç°ï¼Œå…¶ä¸­è¿˜åŒ…å«å„ç§ç”¨äºä¸åŒå¢å¼ºåŠŸèƒ½çš„è¾…åŠ©æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œè¿™é‡Œæœ‰ä¸€ç³»åˆ—è¿‡æ¸¡æ•ˆæœï¼ˆçº¿æ€§ã€ä¸‰æ¬¡ã€æŒ‡æ•°ç­‰ï¼‰ã€‚</p>

<p>æ·»åŠ é›ªèŠ±æ˜¯æœ€åä¸€æ­¥ï¼Œä½†åˆ›å»ºé›ªã€é›¨ã€æ˜Ÿæ˜Ÿç­‰æ•ˆæœçš„æ–¹æ³•å€¼å¾—å¦å¼€ä¸€ä¸ªæ•™ç¨‹ã€‚ä¸‹æ¬¡æˆ‘ä¸€å®šä¼šè®²è§£ã€‚ä»Šå¤©ï¼Œæˆ‘åªæƒ³æä¸€ä¸‹ï¼Œä¸ºäº†å®ç°è¿™ä¸ªç‰¹å®šçš„æ•ˆæœï¼Œæˆ‘ä½¿ç”¨äº† <strong>Andrew Baldwin</strong> äº 2013 å¹´åœ¨ ShaderToy ä¸Šåˆ›å»ºçš„ç€è‰²å™¨ã€‚é“¾æ¥å¦‚ä¸‹ï¼š<a href="https://www.shadertoy.com/view/ldsGDn">https://www.shadertoy.com/view/ldsGDn</a></p>

<p>ç”±äºåŸå§‹ç€è‰²å™¨å¯¹äºæ‰‹æœºæ¥è¯´è¿‡äºåºå¤§ï¼Œæˆ‘åšäº†ä¸€äº›ç®€åŒ–ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜éœ€è¦ä¸€äº›é€‚é… AGSL çš„åŠŸèƒ½ã€‚è¿™æ˜¯æˆ‘çš„ç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='glsl'><span class='line'>  <span class="k">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">vec2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">int</span> <span class="n">uLayers</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">uDepth</span><span class="p">;</span>
</span><span class='line'>   <span class="k">uniform</span> <span class="k">float</span> <span class="n">uSpeed</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">const</span> <span class="k">int</span> <span class="n">MAX_LAYERS</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
</span><span class='line'>   <span class="k">const</span> <span class="k">float</span> <span class="n">WIDTH</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">vec2</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="k">vec2</span> <span class="n">o</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">o</span> <span class="o">/</span> <span class="n">r</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="o">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">*=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">uv</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="k">vec2</span> <span class="n">p</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">pivot</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">x</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">p</span><span class="p">.</span><span class="n">y</span> <span class="o">/=</span> <span class="n">r</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">r</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">+=</span> <span class="n">pivot</span><span class="p">;</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">*=</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">image</span><span class="p">.</span><span class="n">eval</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">vec4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>       <span class="n">float2</span> <span class="n">uv</span> <span class="o">=</span> <span class="n">NormalizeCoordinates</span><span class="p">(</span><span class="n">fragCoord</span><span class="p">,</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>       <span class="k">vec4</span> <span class="n">image</span> <span class="o">=</span> <span class="n">GetImageTexture</span><span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="k">vec2</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">resolution</span><span class="p">);</span>
</span><span class='line'>       <span class="k">const</span> <span class="k">mat3</span> <span class="n">p</span> <span class="o">=</span> <span class="k">mat3</span><span class="p">(</span><span class="mf">13.323122</span><span class="p">,</span> <span class="mf">23.5112</span><span class="p">,</span> <span class="mf">21.71123</span><span class="p">,</span> <span class="mf">21.1212</span><span class="p">,</span> <span class="mf">28.7312</span><span class="p">,</span> <span class="mf">11.9312</span><span class="p">,</span> <span class="mf">21.8112</span><span class="p">,</span> <span class="mf">14.7212</span><span class="p">,</span> <span class="mf">61.3934</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">float</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">y</span> <span class="o">/</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
</span><span class='line'>       <span class="k">vec3</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>       <span class="k">float</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="c1">// åˆå§‹åŒ– alpha</span>
</span><span class='line'>       <span class="k">float</span> <span class="n">dof</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">time</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">);</span>
</span><span class='line'>       <span class="k">for</span> <span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_LAYERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">uLayers</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span> <span class="c1">// å¦‚æœ i è¶…å‡º uLayersï¼Œåˆ™è·³å‡ºå¾ªç¯</span>
</span><span class='line'>
</span><span class='line'>           <span class="k">float</span> <span class="n">fi</span> <span class="o">=</span> <span class="k">float</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec2</span> <span class="n">q</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">uDepth</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡è°ƒåˆ¶å’Œæ—¶é—´è°ƒæ•´é›ªèŠ±ä½ç½®</span>
</span><span class='line'>           <span class="n">q</span> <span class="o">-=</span> <span class="k">vec2</span><span class="p">(</span><span class="n">q</span><span class="p">.</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">WIDTH</span> <span class="o">*</span> <span class="n">mod</span><span class="p">(</span><span class="n">fi</span> <span class="o">*</span> <span class="mf">7.238917</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">WIDTH</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">uSpeed</span> <span class="o">*</span> <span class="n">time</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">fi</span> <span class="o">*</span> <span class="n">uDepth</span> <span class="o">*</span> <span class="mf">0.03</span><span class="p">));</span>                      <span class="k">vec3</span> <span class="n">n</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">floor</span><span class="p">(</span><span class="n">q</span><span class="p">),</span> <span class="mf">31.189</span> <span class="o">+</span> <span class="n">fi</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">m</span> <span class="o">=</span> <span class="n">floor</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.00001</span> <span class="o">+</span> <span class="n">fract</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">mp</span> <span class="o">=</span> <span class="p">(</span><span class="mf">31415.9</span> <span class="o">+</span> <span class="n">m</span><span class="p">)</span> <span class="o">/</span> <span class="n">fract</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">m</span><span class="p">);</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">r</span> <span class="o">=</span> <span class="n">fract</span><span class="p">(</span><span class="n">mp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// ä½¿ç”¨åœ†å½¢maskçš„åœ†å½¢é›ªèŠ±å½¢çŠ¶</span>
</span><span class='line'>           <span class="n">float2</span> <span class="n">center</span> <span class="o">=</span> <span class="n">mod</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">r</span><span class="p">.</span><span class="n">xy</span><span class="p">;</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">distanceToCenter</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">center</span><span class="p">);</span> <span class="c1">// åœ†å‘¨è·ç¦»</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">flakeRadius</span> <span class="o">=</span> <span class="mf">0.015</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">r</span><span class="p">.</span><span class="n">z</span><span class="p">;</span> <span class="c1">// æ¯ä¸ªè–„ç‰‡çš„åŠå¾„ç•¥æœ‰ä¸åŒ</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡æ‰©å±•çš„å¹³æ»‘æ­¥è¿›å®ç°æ›´å¹³æ»‘çš„è¾¹ç¼˜</span>
</span><span class='line'>           <span class="k">float</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">flakeRadius</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">flakeRadius</span><span class="p">,</span> <span class="n">distanceToCenter</span><span class="p">)</span> <span class="o">*</span>
</span><span class='line'>                               <span class="n">smoothstep</span><span class="p">(</span><span class="n">flakeRadius</span><span class="p">,</span> <span class="n">flakeRadius</span> <span class="o">-</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">distanceToCenter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// Ensure flakes are white or transparent (prevent black color)</span>
</span><span class='line'>           <span class="k">vec3</span> <span class="n">flakeColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span> <span class="c1">// é›ªèŠ±è¦æ˜¯ç™½è‰²</span>
</span><span class='line'>           <span class="n">acc</span> <span class="o">+=</span> <span class="n">flakeColor</span> <span class="o">*</span> <span class="n">intensity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>           <span class="c1">// é€šè¿‡å¹³æ»‘è¿‡æ¸¡ç§¯ç´¯ alpha</span>
</span><span class='line'>           <span class="n">alpha</span> <span class="o">+=</span> <span class="n">intensity</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// å½’ä¸€åŒ– alpha ä»¥ç¡®ä¿å…¶ä¸è¶…è¿‡ 1.0</span>
</span><span class='line'>       <span class="n">alpha</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span><span class='line'>       <span class="k">vec3</span> <span class="n">finalColor</span> <span class="o">=</span> <span class="n">mix</span><span class="p">(</span><span class="n">image</span><span class="p">.</span><span class="n">rgb</span><span class="p">,</span> <span class="n">acc</span><span class="p">,</span> <span class="n">alpha</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">ratio</span> <span class="o">||</span> <span class="n">uv</span><span class="p">.</span><span class="n">y</span> <span class="o">&gt;</span> <span class="mf">.5</span><span class="o">*</span><span class="n">ratio</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="n">finalColor</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span><span class='line'>           <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>       <span class="k">return</span> <span class="k">vec4</span><span class="p">(</span><span class="n">finalColor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">+</span><span class="n">image</span><span class="p">.</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>å½“ç„¶ï¼Œä¸ºäº†è®©ä¸€äº›é›ªèŠ±å‡ºç°åœ¨å±å¹•å‰æ–¹ï¼Œè€Œå¦ä¸€äº›é›ªèŠ±é£˜åˆ°å±å¹•åæ–¹ï¼Œæˆ‘å¿…é¡»åœ¨è¿™ä¸ªç€è‰²å™¨ä¸­ä½¿ç”¨ä¸¤å±‚ã€‚è¿™æ˜¯å¯¹è¯æ¡†å¯ç»„åˆå‡½æ•°çš„æœ€ç»ˆæ•ˆæœï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">SnowedDialog</span><span class="p">(</span><span class="n">onDismiss</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">snowCapShader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">flakesShaderForeground</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">flakesShaderBackground</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">snowShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>            <span class="n">time</span> <span class="p">+=</span> <span class="m">0.01f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setIntUniform</span><span class="p">(</span><span class="s">&quot;uLayers&quot;</span><span class="p">,</span> <span class="m">5</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uDepth&quot;</span><span class="p">,</span> <span class="m">0.15f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uSpeed&quot;</span><span class="p">,</span> <span class="m">1.0f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setIntUniform</span><span class="p">(</span><span class="s">&quot;uLayers&quot;</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uDepth&quot;</span><span class="p">,</span> <span class="m">1.5f</span><span class="p">)</span>
</span><span class='line'>    <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;uSpeed&quot;</span><span class="p">,</span> <span class="m">0.8f</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BasicAlertDialog</span><span class="p">(</span>
</span><span class='line'>        <span class="n">onDismissRequest</span> <span class="p">=</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">properties</span> <span class="p">=</span> <span class="n">DialogProperties</span><span class="p">(</span><span class="n">usePlatformDefaultWidth</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                        <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">flakesShaderForeground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">flakesShaderForeground</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">flakesShaderBackground</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">flakesShaderBackground</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="m">0.1f</span><span class="p">))</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">Column</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">horizontal</span> <span class="p">=</span> <span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">shapes</span><span class="p">.</span><span class="n">large</span><span class="p">,</span> <span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">surface</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                            <span class="s">&quot;resolution&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">snowCapShader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span><span class="n">snowCapShader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Merry Christmas!&quot;</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">titleLarge</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Happy New Year!&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">26.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>                <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">End</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span> <span class="n">onDismiss</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">text</span> <span class="p">=</span> <span class="s">&quot;Close&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">bodyMedium</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">color</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">colorScheme</span><span class="p">.</span><span class="n">primary</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>æœ€ç»ˆç»“æœï¼š</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*UG3e4b_9AqY1J1kKCNFqAw.png" alt="" /></p>

<p>æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼å¦‚æœä½ è§‰å¾—æˆ‘çš„å®éªŒæœ‰è¶£ä¸”æˆ‘çš„è§£é‡Šå¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿åŠ å…¥æˆ‘çš„<a href="https://t.me/droidshaderworks">Telegramé¢‘é“</a>æˆ–åœ¨<a href="https://x.com/KrowaNaMostku">Twitter (X)</a>ä¸Šå…³æ³¨æˆ‘ã€‚ä½ çš„æ”¯æŒæ„ä¹‰é‡å¤§ï¼Œå¹¶æ¿€åŠ±ç€æˆ‘ã€‚ç¥ä½ æ’¸ç æ„‰å¿«ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[åˆæ¢Composeä¸­çš„ç€è‰²å™¨RuntimeShader]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader/"/>
    <updated>2025-08-15T14:21:24+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒFirst look at RuntimeShaders in Composeã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644">https://medium.com/@off.mind.by/first-look-at-runtimeshaders-in-compose-b0b431083644</a>ï¼Œç”±Alex Volkovå‘å¸ƒäº2024å¹´4æœˆ12æ—¥ã€‚</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/08/15/first-look-at-runtimeshader/"><img src="https://miro.medium.com/v2/resize:fit:1302/1*QXaDvaYryDIZ1GItjM1uqQ.png" title="auto auto" ></a></p>

<!-- more -->


<p>è‡ªä»æˆ‘ä»¬æœ‰æœºä¼šåœ¨ Compose ä¸­ä½¿ç”¨ RuntimeShaders è‡ªå®šä¹‰Shaderï¼ˆç€è‰²å™¨ï¼‰ä»¥æ¥ï¼Œå·²ç»è¿‡å»äº†ä¸€å¹´å¤šçš„æ—¶é—´ã€‚è¯´å®è¯ï¼Œæˆ‘åŸæœ¬ä»¥ä¸ºä¼šæœ‰å¤§é‡å…³äºè¿™ä¸ªä¸»é¢˜çš„æ–‡ç« ã€‚æˆ‘ä»¥ä¸ºç°åœ¨ Android ä¸Šåº”è¯¥å·²ç»å……æ–¥ç€æ— æ•°ä»¤äººæƒŠå¹çš„ç¤ºä¾‹ã€æ„æƒ³ä¸åˆ°çš„æ•ˆæœï¼Œä»¥åŠå¬åˆ°â€œç€è‰²å™¨â€è¿™ä¸ªè¯æ—¶è„‘æµ·ä¸­æµ®ç°çš„å…¶ä»–ä»¤äººç€è¿·çš„ä¸œè¥¿ã€‚ä½†äº‹å®å¹¶éå¦‚æ­¤ã€‚åœ¨ RuntimeShaders å¯ç”¨ä¹‹åï¼Œå‡ ä¹ç«‹åˆ»å°±å‡ºç°äº†å‡ ç¯‡æ–‡ç« ï¼Œä¹‹åå°±å†ä¹Ÿæ²¡æœ‰äº†ã€‚ä¸€ç‰‡å¯‚é™ã€‚</p>

<p>æˆ‘æƒ³ç­”æ¡ˆå¾ˆç®€å•ï¼šAndroid å¼€å‘è€…å¹¶ä¸ç†Ÿæ‚‰ç€è‰²å™¨ï¼Œè€Œç€è‰²å™¨ç¨‹åºå‘˜é€šå¸¸ä¸ä¼šç›´æ¥ä¸º Android ç¼–å†™ä»£ç ï¼›ä»–ä»¬é€šå¸¸ä¼šä½¿ç”¨æŸç§æ¸¸æˆå¼•æ“ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘çš„å‡è®¾æ­£ç¡®ï¼Œæˆ‘å¸Œæœ›ç”¨è¿™ç¯‡æ–‡ç« æ¥å¼¥åˆè¿™ä¸¤ä¸ªä¸–ç•Œä¹‹é—´çš„å·®è·ã€‚æˆ‘çœŸå¿ƒå¸Œæœ›ç€è‰²å™¨ç¼–å†™èƒ½å¤Ÿæ¸—é€åˆ° Android å¼€å‘é¢†åŸŸã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡çš„å‰©ä½™éƒ¨åˆ†ï¼Œæˆ‘å°†ä»‹ç»ä¸€äº›å¿…è¦çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥ä¾¿ä½ å¯ä»¥åä¸‹æ¥ç¼–å†™ç€è‰²å™¨å¹¶äº«å—å…¶æˆæœã€‚</p>

<p>å› æ­¤ï¼Œæˆ‘å‡è®¾ä½ å·²ç»å¯¹ Compose æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚æœ¬æ–‡ä¸ä¼šè¿‡å¤šè®¨è®ºç€è‰²å™¨ã€‚æˆ‘çš„ä¸»è¦é‡ç‚¹æ˜¯è¿æ¥è¿™ä¸¤ä¸ªä¸–ç•Œã€‚æˆ‘ä»¬å°†åœ¨æœªæ¥è®¨è®ºå…·ä½“çš„æŠ€æœ¯ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸¤ä¸ªé¡¹ç›®ï¼šä¸€ä¸ªå¸¦æœ‰èƒŒæ™¯å›¾åƒï¼Œé¡¶éƒ¨æœ‰ä¸€ä¸ªæ¡†ï¼Œæˆ‘ä»¬æš‚æ—¶å°†å…¶è®¾ç½®ä¸ºé»‘è‰²ã€‚ä»¥ä¸‹æ˜¯ä»£ç çš„ç®€åŒ–ç‰ˆæœ¬ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="n">VerySimpleShaderTheme</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">contentScale</span> <span class="p">=</span> <span class="n">androidx</span><span class="p">.</span><span class="n">compose</span><span class="p">.</span><span class="n">ui</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">ContentScale</span><span class="p">.</span><span class="n">Crop</span><span class="p">,</span>
</span><span class='line'>            <span class="n">painter</span> <span class="p">=</span> <span class="n">painterResource</span><span class="p">(</span><span class="n">id</span> <span class="p">=</span> <span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">background_pattern</span><span class="p">),</span>
</span><span class='line'>            <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>          <span class="p">){</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ç°åœ¨ï¼Œè¦å°†ç€è‰²å™¨æ·»åŠ åˆ°æ¡†ä¸­ï¼Œä½ éœ€è¦è·å–ç€è‰²å™¨æ–‡æœ¬æœ¬èº«ï¼Œè¯¥æ–‡æœ¬ä»¥å¸¸è§„å­—ç¬¦ä¸²å½¢å¼ä¼ é€’ã€‚ä½¿ç”¨æ­¤æ–‡æœ¬åˆ›å»ºä¸€ä¸ª <code>RuntimeShader</code> å¯¹è±¡ã€‚ç„¶åï¼Œå°†å…¶ä¼ é€’ç»™ <code>graphicsLayer</code> æ–¹æ³•ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="m">0.</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="m">0.0</span><span class="p">,</span> <span class="p">.</span><span class="m">5</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span>
</span><span class='line'>                                    <span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'>                       <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>è¿™æ˜¯ä¸€ä¸ªéå¸¸åŸºç¡€çš„ç€è‰²å™¨ç¤ºä¾‹ï¼Œå®ƒè¾“å‡ºé»‘è‰²ï¼Œé€æ˜åº¦ä¸º 50%ã€‚å®ƒçœ‹èµ·æ¥åƒä¸‹é¢çš„å±å¹•æˆªå›¾æ‰€ç¤ºï¼ˆèƒŒæ™¯åªæ˜¯æ¥è‡ªèµ„æºåº“çš„å›¾ç‰‡ï¼‰ã€‚å®ƒå¯èƒ½è¿˜ä¸å¤Ÿä»¤äººå°è±¡æ·±åˆ»ï¼Œä½†æˆ‘æƒ³åœ¨è¿™é‡Œå¼ºè°ƒä¸¤ä¸ªé‡è¦çš„ç»†èŠ‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬å¦‚ä½•å°†ç€è‰²å™¨åº”ç”¨åˆ°ç›’å­ä¸Šã€‚åœ¨æˆ‘ä»¬çš„ç€è‰²å™¨ä»£ç ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç€è‰²å™¨å¯¹è±¡ï¼Œä»¥ä¾¿åœ¨åˆ›å»º renderEffect æ—¶ä¼ é€’å®ƒã€‚ç¬¬äºŒä¸ªé‡è¦çš„ç»†èŠ‚æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºç›’å­æ·»åŠ ä¸€ä¸ªèƒŒæ™¯ï¼Œå¹¶ä¸”èƒŒæ™¯ä¸èƒ½å®Œå…¨é€æ˜ï¼›åªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬çš„ç€è‰²å™¨æ‰èƒ½åº”ç”¨åˆ°ç›’å­ä¸Šï¼Œå¦åˆ™å®ƒå°†ä¸å¯è§ã€‚</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*DWbBFHchSRHzeVv_9FuxvQ.png" alt="" /></p>

<p>åœ¨ä½¿ç”¨ç€è‰²å™¨æ—¶ï¼Œé€šå¸¸éœ€è¦å¯¹åæ ‡è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å…¶ä» 0 å˜ä¸º 1ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œä» -0.5 åˆ° 0.5ï¼Œè¿™æ ·åæ ‡ä¸­å¿ƒå°±ä½äºç”»å¸ƒçš„æ­£ä¸­å¤®ã€‚è¿™æœ‰åŠ©äºä½¿ç”¨å„ç§æ•°å­¦å…¬å¼ã€‚ç„¶è€Œï¼Œè¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œä¸ä»…éœ€è¦çŸ¥é“å½“å‰åƒç´ åæ ‡ï¼Œè¿˜éœ€è¦çŸ¥é“ç”»å¸ƒçš„æ€»å°ºå¯¸ã€‚ä¸ºäº†æ¼”ç¤ºå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸‹ä¸€ä¸ªé‡ç‚¹ï¼šå°†å‚æ•°ä»ä»£ç ä¼ é€’ç»™ç€è‰²å™¨ã€‚æˆ‘ä»¬å°†ä¼ é€’ç›’å­çš„å°ºå¯¸å¹¶ä¿®æ”¹ç€è‰²å™¨ï¼Œä½¿å…¶ç»˜åˆ¶ä¸€ä¸ªåœ†åœˆï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">xy</span> <span class="p">-</span> <span class="p">.</span><span class="m">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">),</span><span class="m">0.5</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">clipToBounds</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">onSizeChanged</span> <span class="p">{</span> <span class="n">size</span> <span class="p">-&gt;</span>
</span><span class='line'>                            <span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span>
</span><span class='line'>                                <span class="s">&quot;resolution&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="k">this</span><span class="p">.</span><span class="n">renderEffect</span> <span class="p">=</span> <span class="n">RenderEffect</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">createRuntimeShaderEffect</span><span class="p">(</span>
</span><span class='line'>                                    <span class="n">shader</span><span class="p">,</span> <span class="s">&quot;image&quot;</span>
</span><span class='line'>                                <span class="p">)</span>
</span><span class='line'>                                <span class="p">.</span><span class="n">asComposeRenderEffect</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'>                       <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*nBzr_W24ekFtGgf3xdz8QA.png" alt="" /></p>

<p>ç°åœ¨æˆ‘ä»¬å·²ç»å­¦ä¹ äº†å¦‚ä½•åˆ›å»ºè‡ªå·±çš„ç€è‰²å™¨å¹¶ä¸ºå…¶ä¼ é€’å‚æ•°ï¼Œé‡è¦çš„æ˜¯è¦ç†è§£ä½ å¯ä»¥ä¼ é€’ä»»ä½•ä½ éœ€è¦çš„å‚æ•°ï¼Œæ— è®ºæ˜¯æ—¶é—´ã€é¢œè‰²è¿˜æ˜¯ç€è‰²å™¨æ‰€éœ€çš„å…¶ä»–å‚æ•°ã€‚ä¸ºäº†å·©å›ºè¿™äº›çŸ¥è¯†ï¼Œæˆ‘å°†å‘ä½ å±•ç¤ºä¸€ä¸ªæˆ‘ä¸º Android åˆ¶ä½œçš„ç¬¬ä¸€ä¸ªç€è‰²å™¨çš„ç¤ºä¾‹â€”â€”ä¸€ä¸ªç”¨äºåŠ è½½çš„å‘å…‰åœ†åœˆã€‚æˆ‘ä»¬å°†ä¼ é€’å½“å‰æ—¶é—´æ¥ä¸ºå…¶æ·»åŠ åŠ¨ç”»æ•ˆæœï¼›ä¸‹é¢æ˜¯ä¸€ä¸ªæ­¤ç±»æ•ˆæœçš„ç®€å•ç¤ºä¾‹ï¼š</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='Kotlin'><span class='line'><span class="k">val</span> <span class="py">runtimeShader</span> <span class="p">=</span> <span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">shader</span> <span class="n">image</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float2</span> <span class="n">resolution</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float</span> <span class="n">radius</span><span class="p">;</span>
</span><span class='line'><span class="n">uniform</span> <span class="n">float</span> <span class="n">time</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">half4</span> <span class="n">main</span><span class="p">(</span><span class="n">float2</span> <span class="n">fragCoord</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">vec2</span> <span class="n">uv</span> <span class="p">=</span> <span class="n">fragCoord</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">xy</span> <span class="p">-</span> <span class="p">.</span><span class="m">5</span><span class="p">;</span>
</span><span class='line'>    <span class="n">uv</span><span class="p">.</span><span class="n">x</span> <span class="p">*=</span> <span class="n">resolution</span><span class="p">.</span><span class="n">x</span><span class="p">/</span><span class="n">resolution</span><span class="p">.</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float</span> <span class="n">radiusWithTime</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">+</span><span class="n">sin</span><span class="p">(</span><span class="n">time</span><span class="p">))*</span><span class="m">0.1</span> <span class="p">+</span> <span class="n">radius</span><span class="p">;</span>
</span><span class='line'>    <span class="n">float</span> <span class="n">glowingCircle</span> <span class="p">=</span> <span class="n">smoothstep</span><span class="p">(</span><span class="n">radiusWithTime</span><span class="p">,</span> <span class="n">radiusWithTime</span><span class="p">-</span><span class="n">radiusWithTime</span><span class="p">*</span><span class="m">0.3</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">));</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">half4</span><span class="p">(</span><span class="n">glowingCircle</span><span class="p">-</span><span class="n">step</span><span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">uv</span><span class="p">),</span><span class="n">radius</span><span class="p">*</span><span class="m">0.7</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;.trimIndent()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">shader</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">RuntimeShader</span><span class="p">(</span><span class="n">runtimeShader</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">var</span> <span class="py">time</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="m">0f</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;radius&quot;</span><span class="p">,</span> <span class="m">0.6f</span><span class="p">)</span>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">10</span><span class="p">)</span>
</span><span class='line'>        <span class="n">time</span><span class="p">+=</span><span class="m">0.01f</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">shader</span><span class="p">.</span><span class="n">setFloatUniform</span><span class="p">(</span><span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Lr85zuDhk8o0-TUgw993_A.png" alt="å®ƒå®é™…ä¸Šæœ‰ä¸€ä¸ªå…‰æ™•åŠ¨ç”»" /></p>

<p>æˆ‘å·²ç»æ¼”ç¤ºäº†æœ€åŸºç¡€çš„éƒ¨åˆ†ã€‚æˆ‘çš„ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªåˆ‡å…¥ç‚¹ï¼Œå¹¶å±•ç¤ºå®ƒæ˜¯å¤šä¹ˆçš„ç®€å•ã€‚å…³äºç€è‰²å™¨ï¼Œæˆ‘è¿˜æœ‰å¾ˆå¤šæƒ³è®¨è®ºçš„ï¼Œä½†æˆ‘ä»¬ç•™åˆ°ä¸‹æ¬¡å†è¯´ã€‚</p>

<p>æ„Ÿè°¢ä½ çš„å…³æ³¨ï¼Œç¥ä½ ä½¿ç”¨ Androidã€Compose å’ŒShaderï¼ˆç€è‰²å™¨ï¼‰é¡ºåˆ©è¿›å…¥éå‡¡çš„ UI ä¸–ç•Œã€‚æœŸå¾…ä¸ä½ ç›¸è§ï¼</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[å­¦ä¼šè¯´ä¸ï¼è®©ä½ å½»åº•å­¦ä¼šKotlin Flowçš„å–æ¶ˆæœºåˆ¶]]></title>
    <link href="https://alexhilton.github.io/blog/2025/08/08/flow-cancellation/"/>
    <updated>2025-08-08T12:25:21+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/08/08/flow-cancellation</id>
    <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡è¯‘è‡ªã€ŒCancellable Flows in Kotlin Coroutines: The Complete Guide to Flow Cancellation Techniquesã€ï¼ŒåŸæ–‡é“¾æ¥<a href="https://proandroiddev.com/cancellable-flows-in-kotlin-coroutines-the-complete-guide-to-flow-cancellation-techniques-8988a85fc158">https://proandroiddev.com/cancellable-flows-in-kotlin-coroutines-the-complete-guide-to-flow-cancellation-techniques-8988a85fc158</a>ï¼Œç”±Sahil Thakarå‘å¸ƒäº2025å¹´7æœˆ21æ—¥ã€‚</p></blockquote>

<p><strong>è¯‘è€…æŒ‰ï¼š</strong> æœ¬æ–‡å¹¶ä¸æ˜¯Flowçš„åŸºç¡€æ•™ç¨‹ï¼Œè€Œæ˜¯ä¸“é—¨è®²è§£å¦‚ä½•å–æ¶ˆflowçš„ï¼Œé€‚åˆå¯¹Flowæœ‰ä¸€å®šåŸºç¡€çš„åŒå­¦ã€‚å¦‚æœå¯¹Flowè¿˜ä¸å¤Ÿç†Ÿæ‚‰ï¼Œå¯ä»¥å…ˆè¡Œé˜…è¯»ä¸€ä¸‹ä¹‹å‰çš„æ–‡ç« ï¼š</p>

<ul>
<li><a href="https://juejin.cn/post/7336751931375648820">åŒ…æ•™åŒ…ä¼šçš„Kotlin Flowæ•™ç¨‹</a></li>
<li><a href="https://juejin.cn/post/7337517508151590947">ä¸“å®¶ä¹‹è·¯ä¸Šçš„Flowé«˜çº§ç§˜ç±</a></li>
</ul>

]]></content>
  </entry>
  
</feed>
