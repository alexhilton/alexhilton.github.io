<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[稀有猿诉]]></title>
  <link href="https://alexhilton.github.io/atom.xml" rel="self"/>
  <link href="https://alexhilton.github.io/"/>
  <updated>2026-01-12T12:53:23+00:00</updated>
  <id>https://alexhilton.github.io/</id>
  <author>
    <name><![CDATA[Alex Hilton]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Jetpack Compose内部的不同节点类型]]></title>
    <link href="https://alexhilton.github.io/blog/2026/01/12/node-types-in-jetpack-compose/"/>
    <updated>2026-01-12T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2026/01/12/node-types-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「The Different Node Types in Jetpack Compose」，原文链接<a href="https://www.grokkingandroid.com/the-different-node-types-in-jetpack-compose/">https://www.grokkingandroid.com/the-different-node-types-in-jetpack-compose/</a>，由Wolfram Rittmeyer发布于2025年12月30日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2026/01/12/node-types-in-jetpack-compose/"><img src="https://www.grokkingandroid.com/wordpress/wp-content/uploads/2025/12/ComposeUiNode-700x389.png" title="auto auto" ></a></p>

<!-- more -->


<p>如果你仔细观察 Compose，你会发现它很奇怪。你会发现很多函数都没有返回值。然而，<a href="https://developer.android.com/develop/ui/compose/mental-model">Android 文档</a>却说：</p>

<blockquote><p>可组合函数会生成 UI 层级结构。</p></blockquote>

<p>这到底是什么意思呢？从函数式编程的角度来看，你那些看似无害的无状态可组合函数实际上会产生大量的<em>副作用[1]</em>。其中就包括创建节点。</p>

<p>有时你可能会创建一些可组合函数来自己创建节点。但更多时候，你会直接委托给其他可组合函数来<em>创建节点[2]</em>。</p>

<p>那么，让我们来看看有哪些节点，它们的创建位置以及它们的用途：</p>

<ul>
<li>ComposeUiNode</li>
<li>LayoutNode</li>
<li>Modifier.Node</li>
<li>SemanticsNode</li>
</ul>


<h2>ComposeUiNode</h2>

<p>当你深入研究<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/layout/package-summary#Layout(androidx.compose.ui.Modifier,androidx.compose.ui.layout.MeasurePolicy)"><code>Layout</code></a>可组合对象时，你会发现它调用了<code>ReusableComposeNode[3]</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="n">@UiComposable</span>
</span><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="nf">Layout</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span> <span class="n">measurePolicy</span><span class="p">:</span> <span class="n">MeasurePolicy</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">compositeKeyHash</span> <span class="p">=</span> <span class="n">currentCompositeKeyHash</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">materialized</span> <span class="p">=</span> <span class="n">currentComposer</span><span class="p">.</span><span class="n">materialize</span><span class="p">(</span><span class="n">modifier</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">localMap</span> <span class="p">=</span> <span class="n">currentComposer</span><span class="p">.</span><span class="n">currentCompositionLocalMap</span>
</span><span class='line'>    <span class="n">ReusableComposeNode</span><span class="p">&lt;</span><span class="n">ComposeUiNode</span><span class="p">,</span> <span class="n">Applier</span><span class="p">&gt;(</span>
</span><span class='line'>        <span class="n">factory</span> <span class="p">=</span> <span class="n">ComposeUiNode</span><span class="p">.</span><span class="n">Constructor</span><span class="p">,</span>
</span><span class='line'>        <span class="n">update</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">set</span><span class="p">(</span><span class="n">measurePolicy</span><span class="p">,</span> <span class="n">SetMeasurePolicy</span><span class="p">)</span>
</span><span class='line'>            <span class="k">set</span><span class="p">(</span><span class="n">localMap</span><span class="p">,</span> <span class="n">SetResolvedCompositionLocals</span><span class="p">)</span>
</span><span class='line'>            <span class="k">set</span><span class="p">(</span><span class="n">materialized</span><span class="p">,</span> <span class="n">SetModifier</span><span class="p">)</span>
</span><span class='line'>            <span class="k">set</span><span class="p">(</span><span class="n">compositeKeyHash</span><span class="p">,</span> <span class="n">SetCompositeKeyHash</span><span class="p">)</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong><code>ReusableComposeNode</code>本身并不是一个节点。</strong> 上面的代码中并没有构造函数调用，而是对另一个可组合对象的调用。第八行的工厂参数看似无关紧要，但实际上非常重要。因为最终会创建节点的就是这个函数。它会创建一个 <code>ComposeUiNode</code>。</p>

<p><code>ReusableComposeNode</code> Composable 与 Compose 运行时紧密相关。这段代码告诉 Composer 应该启动一个 <code>GroupKind.ReusableNode</code> 类型的新组，然后代码会创建一个新节点，或者在重新组合时重用现有节点。最后，当使用 update 函数参数时，它会设置节点的内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="k">reified</span> <span class="n">E</span> <span class="p">:</span> <span class="n">Applier</span><span class="p">&gt;</span> <span class="n">ReusableComposeNode</span><span class="p">(</span>
</span><span class='line'>    <span class="n">noinline</span> <span class="n">factory</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">update</span><span class="p">:</span> <span class="n">@DisallowComposableCalls</span> <span class="n">Updater</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">currentComposer</span><span class="p">.</span><span class="n">applier</span> <span class="p">!</span><span class="k">is</span> <span class="n">E</span><span class="p">)</span> <span class="n">invalidApplier</span><span class="p">()</span>
</span><span class='line'>    <span class="n">currentComposer</span><span class="p">.</span><span class="n">startReusableNode</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">currentComposer</span><span class="p">.</span><span class="n">inserting</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">currentComposer</span><span class="p">.</span><span class="n">createNode</span><span class="p">(</span><span class="n">factory</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">currentComposer</span><span class="p">.</span><span class="n">useNode</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">Updater</span><span class="p">(</span><span class="n">currentComposer</span><span class="p">).</span><span class="n">update</span><span class="p">()</span>
</span><span class='line'>    <span class="n">currentComposer</span><span class="p">.</span><span class="n">endNode</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们看到工厂被传递给了 <code>createNode()</code> 调用。此调用会安排在所有插入操作处理完毕后创建节点。Compose 运行时内部会延迟执行许多操作以实现优化。这里我们并不关心具体何时发生，只需知道它<em>将会</em>发生即可。当它发生时，工厂将被调用。</p>

<p>现在让我们更仔细地看一下工厂本身：<code>ComposeUiNode.Constructor</code> 看起来像是 <code>ComposeUiNode</code> 的构造函数。但事实并非如此。实际上，<code>ComposeUiNode</code> 是一个接口，它本身并不执行任何操作。它实际上是 <code>LayoutNode</code> 使用的基接口。至于这个接口和构造函数的用途，在接口声明上方的注释中已经给出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="cm">/** Interface extracted from LayoutNode to not mark the whole LayoutNode class as @PublishedApi. */</span>
</span><span class='line'><span class="n">@PublishedApi</span>
</span><span class='line'><span class="k">internal</span> <span class="n">interface</span> <span class="n">ComposeUiNode</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="cm">/** Object of pre-allocated lambdas used to make use with ComposeNode allocation-less. */</span>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">Constructor</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ComposeUiNode</span> <span class="p">=</span> <span class="n">LayoutNode</span><span class="p">.</span><span class="n">Constructor</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">VirtualConstructor</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ComposeUiNode</span> <span class="p">=</span> <span class="p">{</span> <span class="n">LayoutNode</span><span class="p">(</span><span class="n">isVirtual</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>所以 <code>ComposeUiNode</code> 只是 <code>LayoutNode</code> 的一个抽象。</strong></p>

<h2>布局节点（LayoutNode）</h2>

<p>在上一节中，我们已经了解了 <code>LayoutNode</code> 的实际创建时间。基本上，每当调用 <code>Layout</code> 可组合组件时，都会创建 <code>LayoutNode</code>。<code>LayoutNode</code> 是树状结构中的元素，代表屏幕上的内容。它需要被测量，可以在其边界内放置子元素，也可以绘制内容。</p>

<p>每个 <code>LayoutNode</code> 都知道它的子元素和父元素。因此，<code>LayoutNode</code> 构成了一个节点树，代表了已发出的内容。需要明确的是：Compose 创建的树状结构与其他 UI 框架一样——但 Google 更倾向于使用一些更高级的命名方式。<strong>因此，每当你听到/读到有关可组合组件发出内容时，请将其理解为一个 LayoutNode 被创建并插入到树中。</strong></p>

<p><code>LayoutNode</code> 类实际上非常有趣，因此值得单独撰写一篇博文，我将在其中更详细地介绍它的一些方面。</p>

<p>这里有两点值得一提：</p>

<ul>
<li><code>Applier</code> 是调用 <code>LayoutNode</code> 相应树状结构处理方法的实例。 - <code>LayoutNode</code> 持有对 <code>Owner</code> 的引用。</li>
</ul>


<p>由于 <code>Applier</code> 和 <code>Owner</code> 在 Compose 中都是非常重要的概念，我将在单独的博文中分别介绍它们。</p>

<h3>LayoutNode 的用途</h3>

<p><code>LayoutNode</code> 构成 UI 树，并跟踪其父节点和子节点。UI 树本身的管理由 <code>Applier</code> 完成，我将在另一篇文章中介绍它。</p>

<p>另外，需要记住的一点是，<code>LayoutNode</code> 存储在 <code>SlotTable[4]</code> 中。因此，在重新组合时，如果运行时认为树的这一部分不需要更改，则可以重用现有的 <code>LayoutNode</code>。</p>

<p><code>LayoutNode</code> 还会保存其修饰符（参见下一节），并委托这些修饰符来决定该 <code>LayoutNode</code> 需要多少空间（测量）、在屏幕上放置元素的位置（布局）以及最终在屏幕上显示什么内容（绘制）。</p>

<p>还有更多内容——但正如我提到的，那是另一篇文章的一部分。</p>

<h2>Modifier.Node</h2>

<p>修饰符在内部由 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/Modifier.Node"><code>Modifier.Node</code></a> 对象表示。<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/Modifier.Node">根据文档</a>，它是“为应用于 androidx.compose.ui.layout.Layout 的每个 Modifier.Element 创建的生命周期更长的对象”。</p>

<p>这个“生命周期更长”很有意思。基本上，只要 <code>Modifier.Node</code> 属于 <code>LayoutNode</code> 的修饰符链，它就会一直存在。 <code>LayoutNode</code> 持有一个 <code>NodeChain</code> 类型的对象，该对象内部维护着一个修饰符列表，并检查该列表是否发生更改，以及 <code>Modifier.Node</code> 的生命周期方法（例如 <code>onAttach()</code>）是否被调用。</p>

<p><code>Modifier.Node</code> 有许多现有的子类型，例如 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/node/LayoutModifierNode"><code>LayoutModifierNode</code></a>（见下文）或 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/node/DrawModifierNode?hl=en"><code>DrawModifierNode</code></a>。后者负责实际在屏幕上绘制内容，我计划在另一篇文章中详细介绍。</p>

<p>由于 <code>LayoutNode</code> 是 <code>SlotTable</code> 的一部分，因此附加到 <code>LayoutNode</code> 的 <code>NodeChain</code> 对象的 <code>Modifier.Node</code> 显然也是 <code>SlotTable</code> 的一部分。</p>

<h3>特殊子类型：<code>LayoutModifierNode</code></h3>

<p><code>LayoutModifierNode</code>（<a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/node/LayoutModifierNode%EF%BC%89%E6%98%AF%E5%AE%9E%E9%99%85%E8%BF%9B%E8%A1%8C%E6%B5%8B%E9%87%8F%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E4%BB%AC%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%B1%8F%E5%B9%95%E4%B8%8A%E5%85%83%E7%B4%A0%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%92%8C%E4%BD%8D%E7%BD%AE%E3%80%82%E6%AD%A3%E5%A6%82%E6%96%87%E6%A1%A3%E6%89%80%E8%BF%B0%EF%BC%9A%E2%80%9C">https://developer.android.com/reference/kotlin/androidx/compose/ui/node/LayoutModifierNode%EF%BC%89%E6%98%AF%E5%AE%9E%E9%99%85%E8%BF%9B%E8%A1%8C%E6%B5%8B%E9%87%8F%E7%9A%84%E8%8A%82%E7%82%B9%EF%BC%8C%E5%9B%A0%E4%B8%BA%E5%AE%83%E4%BB%AC%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%B1%8F%E5%B9%95%E4%B8%8A%E5%85%83%E7%B4%A0%E7%9A%84%E5%A4%A7%E5%B0%8F%E5%92%8C%E4%BD%8D%E7%BD%AE%E3%80%82%E6%AD%A3%E5%A6%82%E6%96%87%E6%A1%A3%E6%89%80%E8%BF%B0%EF%BC%9A%E2%80%9C</a><code>LayoutModifierNode</code> 会改变其包裹内容的测量和布局方式。”。因此，在测量和布局过程中，每当遍历 <code>ModifierNode</code> 链时，这些节点实际上都会开始进行测量。</p>

<p>因此，所有想要改变其子元素位置或对整个 Composable 元素大小产生任何影响的修饰符都需要实现 <code>LayoutModifierNode</code> 接口。例如，<code>SizeNode</code> 就是一个实现 <code>LayoutModifierNode</code> 接口的例子，它是 <code>height()</code>、<code>width()</code> 或 <code>size()</code> 等修饰符实际使用的节点。</p>

<h2>SemanticsNode</h2>

<p>当你想要向设备的<em>辅助功能服务[5]</em>传递一些信息时，你可以使用 Compose 中的 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/Modifier#(androidx.compose.ui.Modifier).semantics(kotlin.Boolean,kotlin.Function1)"><code>semantics</code></a> 修饰符来告知系统要向用户传达哪些语义属性。</p>

<p>但是辅助功能服务并不了解 Compose。在其他平台上，这一点显而易见，但考虑到 Compose 向后兼容（而且它并非 Android 框架的组成部分），在 Android 上也是如此。</p>

<p>对于辅助功能，前面提到的 <code>Owner</code> 再次发挥作用。它持有一个 <code>SemanticsOwner</code>，该 <code>SemanticsOwner</code> 充当了与相应平台语义框架之间的桥梁。</p>

<p>为此，<code>SemanticsOwner</code> 维护着一个 <code>SemanticNode</code> 对象树，用于向辅助功能服务的用户描述屏幕内容。这也是我未来会更详细介绍的内容之一。</p>

<p>敬请期待更多关于 Compose 内部运作机制的见解。祝你编码愉快！</p>

<h2>脚注</h2>

<ul>
<li>[1] 我在本段中使用“副作用”一词，是因为它在<a href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)">计算机科学和函数式编程</a>中由来已久。我这里指的并非官方 Compose 文档中提到的<a href="https://developer.android.com/develop/ui/compose/side-effects">副作用</a>。Compose 文档至少在过去有时会提及副作用的这种用法——尽管实际上 Compose 函数并非纯函数。</li>
<li>[2] 如果在 Compose Compiler 插件完成工作后查看 Composable，你会发现它不仅创建了节点，而且你的函数还会进行大量调用，从而改变应用程序的全局状态。但这些调用并不会实际绘制任何内容。它们最多只会创建一些绘制操作，这些操作会被记录下来，并在系统认为需要绘制时，于未来的某个时间点被调用。我将在以后的两篇文章中分别介绍绘制过程以及编译器对代码所做的更改。</li>
<li>[3] 实际上，布局可组合对象共有三个。但它们最终都会调用 <code>ReusableComposeNode</code>。其他变体的示例也与之非常相似。</li>
<li>[4] 本系列文章中我可能不会介绍 SlotTable。我推荐 Richard Leland 的这篇关于 compose 的文章（<a href="https://medium.com/androiddevelopers/under-the-hood-of-jetpack-compose-part-2-of-2-37b2c20c6cdd%EF%BC%89%EF%BC%8C%E4%BB%A5%E5%8F%8A">https://medium.com/androiddevelopers/under-the-hood-of-jetpack-compose-part-2-of-2-37b2c20c6cdd%EF%BC%89%EF%BC%8C%E4%BB%A5%E5%8F%8A</a> Mohit Sarveiya 的关于 slotTable 的视频（<a href="https://codingwithmohit.com/%EF%BC%89%EF%BC%8C%E8%BF%99%E4%BA%9B%E8%A7%86%E9%A2%91%E8%AE%B2%E8%A7%A3%E4%BA%86%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8">https://codingwithmohit.com/%EF%BC%89%EF%BC%8C%E8%BF%99%E4%BA%9B%E8%A7%86%E9%A2%91%E8%AE%B2%E8%A7%A3%E4%BA%86%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8</a> slotTable。</li>
<li>[5] 设备上的辅助功能服务在 Android 系统中是 AccessibilityService 的实现，但在 iOS、桌面或 Web 端则有所不同，因此我在本文中使用“辅助功能服务”这个通用术语。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[务实的模块化：连接模块(wiring Modules)的妙用]]></title>
    <link href="https://alexhilton.github.io/blog/2026/01/03/pragmatic-modularization/"/>
    <updated>2026-01-03T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2026/01/03/pragmatic-modularization</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Pragmatic Modularization: The Case for Wiring Modules」，原文链接<a href="https://proandroiddev.com/pragmatic-modularization-the-case-for-wiring-modules-c936d3af3611">https://proandroiddev.com/pragmatic-modularization-the-case-for-wiring-modules-c936d3af3611</a>，由Alex Krafts发布于2025年11月22日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2026/01/03/pragmatic-modularization/"><img src="https://miro.medium.com/v2/resize:fit:1400/0*9waVavO74e0cqQg6" title="auto auto" ></a></p>

<!-- more -->


<p>如果你正在经历漫长的模块化之旅，你应该已经阅读过官方的<a href="https://developer.android.com/topic/modularization">Google 开发者指南</a>。你可能已经见过关于提供依赖项的这种具体建议：</p>

<blockquote><p>“……app 模块通常是添加依赖项的好地方。要提供实现，请将其指定为所选构建变体或测试源集的依赖项。”</p></blockquote>

<p>下图展示了这种模式的一个常见示例，其中 <code>:app</code> 模块使用 <code>:database:impl:room</code> 作为其 <code>main</code> 源集，并使用 <code>:database:impl:mock</code> 作为 <code>androidTest</code> 源集。这是一种强大且正确的测试依赖项管理方法。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1304/0*Q3MP_6C6i4qhNhQr.png" alt="图 1. App 模块提供实际实现。" /></p>

<p>但这种模式存在一个<strong>微妙之处</strong>。当这种逻辑应用于大型项目中所有功能实现时，可能会<strong>无意中造成构建速度瓶颈</strong>，尤其是在处理遗留应用模块时。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// :app/build.gradle.kts</span>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:database:api&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:database:impl:room&quot;</span><span class="p">))</span> <span class="c1">// &lt;--- This is the trap for incremental builds</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码是模块化的，但你的 <code>:app</code> 模块现在与 <code>:database:impl:room</code> 模块<strong>构建耦合</strong>。这意味着任何<strong>资源更改</strong>（例如添加字符串）或对<strong>实现自身的公共接口</strong>的任何更改（例如在 <code>:impl</code> 内部添加一个不属于官方 <code>:api</code> 模块的新的 <code>public</code> 辅助类）都会破坏编译避免机制，并强制整个 <code>:app</code> 模块重新编译，从而抵消模块化带来的主要速度优势。</p>

<blockquote><p>即使启用了非传递 R 类等优化，直接依赖关系通常也会强制构建系统验证使用者是否与生产者的新资源符号匹配。布线模块充当防火墙，防止频繁的资源检查影响到庞大的 App 模块。</p></blockquote>

<h2>“精简应用”的理想状态与“臃肿应用”的现实</h2>

<p>官方建议让 <code>:app</code> 模块提供实现，这非常有效，尤其是在 Google 指南中展示的场景下：为不同的构建版本（例如 <code>main</code> 和 <code>androidTest</code>）替换依赖项。</p>

<p>但是，如果将此模式误用作所有功能实现的<em>通用规则</em>，尤其是在包含<strong>“臃肿应用”模块</strong>的项目中，就会出现一个微妙的陷阱。</p>

<p>官方指南通常会隐含地假设一种架构理想：<strong>“精简应用”模块</strong>。“精简应用”只是一个轻量级的汇编器。它几乎不包含任何代码或资源。它<em>唯一</em>的任务是应用 <code>com.android.application</code> 插件并将所有功能模块打包成一个 APK 文件。如果你的 <code>:app</code> 模块很精简，重新编译它既快速又便宜，因此它依赖于 <code>:impl</code> 模块并无大碍。</p>

<p>但对我们大多数人来说，现实情况是<strong>“厚应用”模块</strong>。它是最初的单体应用，仍然充斥着遗留代码、资源和半模块化的功能。</p>

<p>当你的“厚应用”模块直接依赖于某个功能的 <code>:impl</code> 时，例如 <code>:app</code> -> &ldquo;:database:impl:room&rdquo;<code>，你就创建了一个会拖慢构建速度的瓶颈。你最大、最复杂的模块现在与该功能的内部细节**构建耦合**了。任何对</code>:impl<code>中资源或实现自身公共接口的更改都会破坏编译规避机制，并强制整个</code>:app` 模块重新编译。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1304/1*su8uLnwQsJMVWsUxrlVBSg.png" alt="图 2. “厚应用”瓶颈。由于庞大的 :app 模块直接依赖于实现，因此底层任何 ABI 更改都会触发顶层的完全重新编译。红色箭头展示了功能模块中的一个微小改动如何迫使资源密集型的 `:app` 模块重新构建，从而破坏了避免编译的策略。" /></p>

<p>“现在，一个纯粹主义者可能会说：‘你应该更加自律，永远不要让你的 <code>:app</code> 模块从 <code>:impl</code> 导入任何东西，即使是公共的。’</p>

<p>他们的说法没错。但是，在一个拥有数十位贡献者的‘厚应用’单体应用中，‘自律’是一种脆弱的防御手段。而连接模块模式<strong>在构建系统层面强制执行了这种自律。</strong>它使得开发者<em>不可能</em>意外地将 <code>:app</code> 模块与某个功能的实现细节耦合在一起，从而默认地保证了构建速度。”</p>

<h2>“理想”方案 vs. “赋能”方案</h2>

<p>这让团队面临两条道路：</p>

<ol>
<li>“理想”（但缓慢）方案：纯粹主义者的解决方案是将“臃肿的应用”模块重构为真正“精简”的模块……这才是正确的长期目标，但这需要数年时间，循序渐进。</li>
<li>“赋能”（但快速）方案：这是“连接模块”模式。这种模式并非理想方案的替代方案，而是实现理想方案的催化剂。它提供了团队所需的构建速度和稳定性，使团队有时间和信心真正执行长期的增量重构。</li>
</ol>


<p>虽然这会增加“模块蔓延”，但它以架构的纯粹性换取了工程速度。在大型团队中，速度通常是更关键的指标。</p>

<p>但这种观点将问题简单地二元化了。实际上，这种模式是一种<strong>务实的权衡</strong>。你是在<strong>有意识地做出权衡</strong>。你接受了新的、可控的成本（增加模块数量和配置），以解决一个令人头疼的日常问题（缓慢的增量构建）。这种新的、明确的“连接”债务通常远比“臃肿应用”的单体架构债务成本低得多，后者正在扼杀团队的开发速度。这种构建速度往往正是团队能够拥有时间和稳定性来进行更大规模、更长期的重构的关键所在。</p>

<p>像 Slack、Spotify 和 Uber 这样的大型 Android 代码库都公开讨论过一些模式，这些模式大量依赖于将实现细节隐藏在稳定的 API 之后。这并非权宜之计；这是大型团队保持构建速度快和代码库可维护性的根本方法。</p>

<h2>解决方案：“连接模块”模式</h2>

<blockquote><p>这种模式有时被称为聚合模块，但我们更倾向于使用“连接”，因为它更能体现其在连接架构中的积极作用。</p></blockquote>

<p>此解决方案引入了一个新的轻量级<strong>“连接模块”</strong>（例如，<code>:database:wiring</code>）。该模块充当“守门人”或该功能的稳定外观。</p>

<p>其原理很简单：</p>

<ol>
<li><code>:app</code> 模块<em>仅</em>依赖于新的、稳定的 <code>:database:wiring</code> 模块。</li>
<li>连接模块<em>是唯一</em>了解其自身内部 <code>:impl</code>（以及 <code>:ui</code>、<code>:domain</code> 等）模块的模块。</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// :app/build.gradle.kts (Corrected)</span>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:database:wiring&quot;</span><span class="p">))</span> <span class="c1">// NOW it&#39;s decoupled!</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:feature:home&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// :database:wiring/build.gradle.kts (The new &quot;Wiring Module&quot;)</span>
</span><span class='line'><span class="n">plugins</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">id</span><span class="p">(</span><span class="s">&quot;com.android.library&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">android</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">namespace</span> <span class="p">=</span> <span class="s">&quot;com.example.database.wiring&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Link the bindings internally without exposing the API transitively</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:database:api&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Hide the implementation details from the :app module</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">project</span><span class="p">(</span><span class="s">&quot;:database:impl:room&quot;</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种模式并非免费。这是一个务实的步骤，它能实现你承诺的快速增量构建，赋予你的团队速度和稳定性，从而支持那些规模更大、周期更长的重构。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1304/1*H2gD-qUVVI2r7CsTtMSt6Q.png" alt="图 3. 使用 :impl:room 模块 ABI 更改后的增量构建仅触发轻量级 :wiring 模块重建" /></p>

<p>现在，<code>:app</code> 模块仅依赖于稳定的 wiring 模块。</p>

<p><strong>关于依赖注入的说明：</strong></p>

<p>这个“wiring 模块”不仅仅是一个提升构建速度的技巧；它是你功能<strong>依赖注入绑定</strong>（例如 Dagger 或 Hilt 的 <code>@Module</code>）的理想存放位置。它的唯一职责就是将抽象的 <code>:api</code> 连接到具体的 <code>:impl</code>，这正是清晰依赖注入 (DI) 的精髓所在。</p>

<p>这种模式能够确保良好的架构，而构建速度的提升则是这种清晰分离带来的一个绝佳附加效果。</p>

<h2>为什么速度如此之快：理解编译避免</h2>

<p>这种结构并非权宜之计；它是启用 Gradle 最强大的构建速度提升功能——<strong>编译避免</strong>——的<em>正确</em>方法。</p>

<p>Gradle 团队在其精彩博文“<a href="https://blog.gradle.org/our-approach-to-faster-compilation">我们实现更快编译的方法</a>”中对此进行了解释。以下是关键要点：</p>

<ol>
<li><strong>Gradle 检查的是 ABI，而不是实现：</strong> 正如博文所述，Gradle 检查的是依赖项的<strong>应用程序二进制接口 (ABI)</strong>。ABI 是模块的“公共契约”或“公共结构”——即其公共类和方法签名。它<strong>不</strong>包含方法体等私有实现细节。</li>
<li><strong>旧方法会破坏这一点：</strong> 当你的 <code>:app</code> 模块直接依赖于 <code>:database:impl:room</code> 时，你实际上是在强制 Gradle 将整个实现都视为应用构建的一部分。正如我们之前提到的，<code>:database:impl:room</code> 中任何<strong>资源更改</strong>或对实现本身的<strong>公共接口</strong>（例如新增的 <code>public</code> 辅助函数）的更改，对于 <code>:app</code> 来说都是 ABI 不兼容的更改，从而导致需要完全重新编译。</li>
<li><p><strong>新方法可以解决这个问题：</strong> 使用我们的 <code>:database:wiring</code> 模块后：</p></li>
<li><p>开发人员更改了 <code>:database:impl:room</code> 中的一个文件。</p></li>
<li><code>:database:wiring</code> 模块重新编译（由于它很小，所以速度很快）。</li>
<li><strong>至关重要的是</strong>，正如 Gradle 博客文章中所解释的，这是一个 <strong>ABI 兼容的更改</strong>。连接模块的<em>公共结构</em>（即其 <code>api</code> 依赖项）并未改变。</li>
<li>Gradle 会检查 <code>:app</code>，发现其依赖项的 ABI 完全相同，因此<strong>完全跳过重新编译</strong> <code>:app</code>。</li>
</ol>


<p>这篇博文将此称为<strong>编译避免(Compilation Avoidance)</strong>（完全跳过模块的编译），并将其与<em>增量编译</em>（重新编译模块中的<em>某些</em>文件）区分开来。这种模式是实现主应用程序模块真正避免编译的最有效方法之一。</p>

<h2>实际应用：效果如何</h2>

<p>这并非纸上谈兵。我们在生产应用中使用 Gradle Profiler 来测试这种模式旨在解决的具体场景：在某个功能的 <code>:impl</code> 模块中进行破坏 ABI 的更改（例如，添加一个新的公共方法），然后运行增量 <code>:app:assembleDebug</code> 构建。</p>

<p>我们对八个不同的功能模块重复了此操作，并在引入连接模块前后分别对每个功能模块进行了平均 10 次运行。在旧配置中，<code>:app</code> 直接依赖于 <code>:feature:impl</code>，这些增量构建平均耗时约 <strong>99 秒</strong>。引入连接模块后，<code>:app</code> 仅依赖于 <code>:feature:wiring</code>，相同场景下的平均耗时降至约 <strong>63 秒</strong>。</p>

<p>在这八个功能模块中，速度提升幅度约为 <strong>29%</strong> 到 <strong>45%</strong>，在这种特定的增量构建场景下，平均提升幅度约为 <strong>36%</strong>。</p>

<p>在进行此次重构时，我恰好在研究是否值得将我的 MacBook 升级到更新的 Apple Silicon 机型。这个对比让我恍然大悟：对于这种工作负载，此次连接模块的更改所带来的构建速度提升，与升级到性能更强劲的高端 MacBook 机型**的效果不相上下。区别在于，这种重构能够有效地让参与项目的每个开发者都感受到“新机器”般的体验——而这仅仅是通过一个小的、有针对性的 Gradle 修改实现的，而非硬件升级。</p>

<h2>要点</h2>

<p>官方文档的建议在理论上是正确的，但理解实践中的权衡取舍至关重要。</p>

<p>对于任何实际的<strong>“厚应用”模块</strong>而言，直接依赖 <code>:impl</code> 模块通常会导致构建速度瓶颈，因为它将最大的模块与某个功能的内部变更耦合在一起。</p>

<p>保护构建速度至关重要。“模块连接”模式是一种非常实用且低成本的重构方式，它能显著提升日常工作流程的构建速度，而成本通常仅为完整 <code>:app</code> 模块重构的一小部分。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetpack ViewModel内幕：内部机制与跨平台设计]]></title>
    <link href="https://alexhilton.github.io/blog/2025/12/31/inside-jetpack-viewmodel/"/>
    <updated>2025-12-31T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/12/31/inside-jetpack-viewmodel</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Inside Jetpack ViewModel: Internal Mechanisms and Multiplatform Design」，原文链接<a href="https://proandroiddev.com/inside-jetpack-viewmodel-internal-mechanisms-and-multiplatform-design-2625671eaef8">https://proandroiddev.com/inside-jetpack-viewmodel-internal-mechanisms-and-multiplatform-design-2625671eaef8</a>，由Jaewoong Eum发布于2025年12月7日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/12/31/inside-jetpack-viewmodel/"><img src="https://miro.medium.com/v2/resize:fit:2000/format:webp/0*tOtkLxn9LUT6ZAsI" title="auto auto" ></a></p>

<!-- more -->


<p>Jetpack 的 ViewModel 已成为现代 Android 开发中不可或缺的组件，它为 UI 相关数据提供了一个生命周期感知容器，即使配置发生更改，数据也能保持不变。虽然其 API 表面上看起来很简单，但其内部机制却展现了围绕生命周期管理、跨平台抽象、资源清理和线程安全缓存等方面的设计决策。了解 ViewModel 的底层工作原理有助于你做出更优的架构决策，并避免一些不易察觉的错误。</p>

<p>本文将深入探讨 Jetpack ViewModel 的内部工作原理，包括 <code>ViewModelStore</code> 如何在配置更改后保留实例、<code>ViewModelProvider</code> 如何协调创建和缓存、工厂模式如何实现灵活的实例化、<code>CreationExtras</code> 如何实现无状态工厂、如何通过 Closeable 模式管理资源清理，以及 <code>viewModelScope</code> 如何将协程与 ViewModel 生命周期集成。</p>

<h2>根本问题：配置更改后的保留</h2>

<p>配置更改是 Android 开发面临的一项根本性挑战。当用户旋转设备、更改语言设置或触发任何配置更改时，系统会销毁并重新创建 Activity。Activity 中存储的所有数据都会丢失：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">userData</span><span class="p">:</span> <span class="n">User</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>  <span class="c1">// Lost on rotation!</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// Must reload data after every rotation</span>
</span><span class='line'>        <span class="n">loadUserData</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一种简单的方法是使用 <code>onSaveInstanceState()</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
</span><span class='line'>    <span class="n">outState</span><span class="p">.</span><span class="n">putParcelable</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span> <span class="n">userData</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>    <span class="n">userData</span> <span class="p">=</span> <span class="n">savedInstanceState</span><span class="o">?.</span><span class="n">getParcelable</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方法适用于小型、可序列化的数据。但是，对于大型数据集、网络连接或无法序列化的对象呢？对于持续进行的网络请求等操作呢？Bundle 方法在这些情况下会失效，原因既有大小限制，也有序列化/反序列化的高昂开销。</p>

<p>ViewModel 通过提供一个生命周期感知容器来解决这个问题，该容器通过保留对象模式（而非序列化）来应对配置更改。</p>

<h2>ViewModelStore：保留机制</h2>

<p>ViewModel 配置变更后仍能保留的核心是 <code>ViewModelStore</code>，它是一个简单的键值存储，用于保存 ViewModel 实例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">open</span> <span class="k">class</span> <span class="nc">ViewModelStore</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">map</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">ViewModel</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@RestrictTo</span><span class="p">(</span><span class="n">RestrictTo</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">LIBRARY_GROUP</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">:</span> <span class="n">ViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">oldViewModel</span> <span class="p">=</span> <span class="n">map</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">)</span>
</span><span class='line'>        <span class="n">oldViewModel</span><span class="o">?.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@RestrictTo</span><span class="p">(</span><span class="n">RestrictTo</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">LIBRARY_GROUP</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">ViewModel</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@RestrictTo</span><span class="p">(</span><span class="n">RestrictTo</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">LIBRARY_GROUP</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">keys</span><span class="p">():</span> <span class="n">Set</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">HashSet</span><span class="p">(</span><span class="n">map</span><span class="p">.</span><span class="n">keys</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">vm</span> <span class="k">in</span> <span class="n">map</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">vm</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">map</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现非常简单，就是一个 <code>MutableMap&lt;String, ViewModel&gt;</code>。关键不在于存储本身，而在于存储的保留方式。</p>

<h3>键替换行为</h3>

<p>请注意 <code>put</code> 方法的行为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">:</span> <span class="n">ViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">oldViewModel</span> <span class="p">=</span> <span class="n">map</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">)</span>
</span><span class='line'>    <span class="n">oldViewModel</span><span class="o">?.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果已存在具有相同键的 ViewModel，则旧的 ViewModel 会被立即清除。这确保了在替换 ViewModel 时能够正确清理。你可能想知道这种情况何时发生，它发生在你请求具有相同键但类型不同的 ViewModel 时：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// First request creates TestViewModel1 with key &quot;my_key&quot;</span>
</span><span class='line'><span class="k">val</span> <span class="py">vm1</span><span class="p">:</span> <span class="n">TestViewModel1</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="s">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">TestViewModel1</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Second request with same key but different type</span>
</span><span class='line'><span class="k">val</span> <span class="py">vm2</span><span class="p">:</span> <span class="n">TestViewModel2</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="s">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">TestViewModel2</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// vm1.onCleared() has been called, vm1 is no longer valid</span>
</span></code></pre></td></tr></table></div></figure>


<p>此行为已在测试套件中验证：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">twoViewModelsWithSameKey</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">key</span> <span class="p">=</span> <span class="s">&quot;the_key&quot;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">vm1</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">TestViewModel1</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">vm1</span><span class="p">.</span><span class="n">cleared</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">vw2</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="n">key</span><span class="p">,</span> <span class="n">TestViewModel2</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">vw2</span><span class="p">).</span><span class="n">isNotNull</span><span class="p">()</span>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">vm1</span><span class="p">.</span><span class="n">cleared</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ViewModelStoreOwner 契约</h3>

<p><code>ViewModelStoreOwner</code> 接口定义了谁拥有该存储：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">interface</span> <span class="n">ViewModelStoreOwner</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">val</span> <span class="py">viewModelStore</span><span class="p">:</span> <span class="n">ViewModelStore</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ComponentActivity</code>、<code>Fragment</code> 和 <code>NavBackStackEntry</code> 都实现了这个简单的接口。所有者的职责有两方面：</p>

<ol>
<li><strong>在配置更改后保留存储</strong>：存储必须在 Activity 重建后仍然存在。</li>
<li><strong>在真正完成后清除存储</strong>：当所有者被销毁而未重建时，调用 <code>ViewModelStore.clear()</code>。</li>
</ol>


<p>对于 Activity 而言，这通常使用 <code>NonConfigurationInstances</code> 来实现，这是一种特殊的机制，允许对象在配置更改后仍然存在。Activity 框架在 <code>onRetainNonConfigurationInstance()</code> 期间保留这些对象，并在 <code>getLastNonConfigurationInstance()</code> 中恢复它们。</p>

<h3>为什么简单的映射有效</h3>

<p>你可能期望使用复杂的缓存机制，但简单的 <code>MutableMap</code> 就足够了，原因如下：</p>

<ol>
<li><strong>大小有限</strong>：每个屏幕上的 ViewModel 数量很少（通常为 1-5 个）。</li>
<li><strong>字符串键</strong>：键由类名生成，使得查找复杂度为 O(1)，并且哈希分布良好。</li>
<li><strong>无需驱逐</strong>：ViewModel 仅在显式请求或所有者被销毁时才会被清除。</li>
<li><strong>线程安全</strong>：访问在 ViewModelProvider 级别同步。</li>
</ol>


<h2>ViewModelProvider：编排层</h2>

<p><code>ViewModelProvider</code> 是获取 ViewModel 实例的主要 API。它负责编排 store、factory 和创建 extras 之间的交互：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">actual</span> <span class="k">open</span> <span class="k">class</span> <span class="nc">ViewModelProvider</span>
</span><span class='line'><span class="k">private</span> <span class="n">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">impl</span><span class="p">:</span> <span class="n">ViewModelProviderImpl</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>        <span class="n">store</span><span class="p">:</span> <span class="n">ViewModelStore</span><span class="p">,</span>
</span><span class='line'>        <span class="n">factory</span><span class="p">:</span> <span class="n">Factory</span><span class="p">,</span>
</span><span class='line'>        <span class="n">defaultCreationExtras</span><span class="p">:</span> <span class="n">CreationExtras</span> <span class="p">=</span> <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Empty</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">ViewModelProviderImpl</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">defaultCreationExtras</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>        <span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelStoreOwner</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span>
</span><span class='line'>        <span class="n">store</span> <span class="p">=</span> <span class="n">owner</span><span class="p">.</span><span class="n">viewModelStore</span><span class="p">,</span>
</span><span class='line'>        <span class="n">factory</span> <span class="p">=</span> <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">getDefaultFactory</span><span class="p">(</span><span class="n">owner</span><span class="p">),</span>
</span><span class='line'>        <span class="n">defaultCreationExtras</span> <span class="p">=</span> <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">getDefaultCreationExtras</span><span class="p">(</span><span class="n">owner</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@MainThread</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">actual</span> <span class="n">operator</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">impl</span><span class="p">.</span><span class="n">getViewModel</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@MainThread</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">actual</span> <span class="n">operator</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">impl</span><span class="p">.</span><span class="n">getViewModel</span><span class="p">(</span><span class="n">modelClass</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>多平台抽象</h3>

<p>请注意 <code>ViewModelProviderImpl</code> 委托。ViewModel 库是一个 Kotlin 多平台库，支持 JVM、Android、iOS 和其他平台。Kotlin 多平台目前还不支持带有默认实现的 expect 类，因此通用逻辑被提取到内部实现类中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">ViewModelProviderImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">store</span><span class="p">:</span> <span class="n">ViewModelStore</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">factory</span><span class="p">:</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">defaultExtras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">lock</span> <span class="p">=</span> <span class="n">SynchronizedObject</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">getViewModel</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
</span><span class='line'>        <span class="n">key</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">getDefaultKey</span><span class="p">(</span><span class="n">modelClass</span><span class="p">),</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">modelClass</span><span class="p">.</span><span class="n">isInstance</span><span class="p">(</span><span class="n">viewModel</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">factory</span> <span class="k">is</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">OnRequeryFactory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">factory</span><span class="p">.</span><span class="n">onRequery</span><span class="p">(</span><span class="n">viewModel</span><span class="o">!!</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">return</span><span class="n">@synchronized</span> <span class="n">viewModel</span> <span class="k">as</span> <span class="n">T</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">modelExtras</span> <span class="p">=</span> <span class="n">MutableCreationExtras</span><span class="p">(</span><span class="n">defaultExtras</span><span class="p">)</span>
</span><span class='line'>            <span class="n">modelExtras</span><span class="p">[</span><span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">VIEW_MODEL_KEY</span><span class="p">]</span> <span class="p">=</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span><span class="n">@synchronized</span> <span class="n">createViewModel</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">modelClass</span><span class="p">,</span> <span class="n">modelExtras</span><span class="p">).</span><span class="n">also</span> <span class="p">{</span> <span class="n">vm</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">store</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">vm</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>获取或创建模式</h3>

<p><code>getViewModel</code> 方法实现了经典的获取或创建模式：</p>

<ol>
<li><strong>生成键</strong>：默认键基于类的规范名称。</li>
<li><strong>检查缓存</strong>：通过键查找已存在的 ViewModel。</li>
<li><strong>类型检查</strong>：验证缓存实例的类型是否正确。</li>
<li><strong>返回缓存</strong>：如果有效，则返回缓存的实例。</li>
<li><strong>创建新实例</strong>：如果未找到或类型错误，则通过工厂模式创建新实例。</li>
<li><strong>存储</strong>：将新实例放入存储中。</li>
</ol>


<h3>使用同步访问确保线程安全</h3>

<p><code>synchronized(lock)</code> 代码块确保线程安全访问。虽然 ViewModel 的访问通常来自主线程（如 <code>@MainThread</code> 所示），但同步机制可以防止后台线程访问 ViewModel 等极端情况，尤其是在测试场景或使用 <code>viewModelScope</code> 时。</p>

<h3>OnRequeryFactory 回调</h3>

<p><code>OnRequeryFactory</code> 是一种特殊的机制，用于在检索缓存的 ViewModel 时执行操作的工厂：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@RestrictTo</span><span class="p">(</span><span class="n">RestrictTo</span><span class="p">.</span><span class="n">Scope</span><span class="p">.</span><span class="n">LIBRARY_GROUP</span><span class="p">)</span>
</span><span class='line'><span class="k">public</span> <span class="n">actual</span> <span class="k">open</span> <span class="k">class</span> <span class="nc">OnRequeryFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">actual</span> <span class="k">open</span> <span class="k">fun</span> <span class="nf">onRequery</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">ViewModel</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>SavedStateHandle</code> 内部使用此机制在配置更改后将 ViewModel 与当前的 SavedStateRegistry 重新连接。当从缓存中检索 ViewModel 时，会调用工厂的 <code>onRequery</code> 方法，从而更新可能已更改的引用。</p>

<h3>从类名生成键</h3>

<p>默认的键生成机制可防止意外冲突：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">getDefaultKey</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">String</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">canonicalName</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">modelClass</span><span class="p">.</span><span class="n">canonicalName</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;Local and anonymous classes can not be ViewModels&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="s">&quot;$VIEW_MODEL_PROVIDER_DEFAULT_KEY:$canonicalName&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>前缀 <code>"androidx.lifecycle.ViewModelProvider.DefaultKey:"</code> 可确保键不会与用户提供的自定义键冲突。规范名称要求也解释了为什么本地类和匿名类不能是 ViewModel，因为它们没有规范名称：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">localViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">LocalViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelProvider</span><span class="p">[</span><span class="n">LocalViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'>        <span class="n">fail</span><span class="p">(</span><span class="s">&quot;Expected `IllegalArgumentException`&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">IllegalArgumentException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">hasMessageThat</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="s">&quot;Local and anonymous classes can not be ViewModels&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>工厂模式：灵活实例化</h2>

<p><code>ViewModelProvider.Factory</code> 是创建 ViewModel 实例的机制：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">actual</span> <span class="n">interface</span> <span class="n">Factory</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">unsupportedCreateViewModel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">actual</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">extras</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>方法重载链</h3>

<p>工厂接口有三个 <code>create</code> 方法变体，形成一个链：</p>

<ol>
<li><code>create(KClass&lt;T&gt;, CreationExtras)</code>：Kotlin 优先 API，委托给 Java 变体</li>
<li><code>create(Class&lt;T&gt;, CreationExtras)</code>：主要实现点，默认为无附加组件的变体</li>
<li><code>create(Class&lt;T&gt;)</code>：传统 API，默认抛出异常</li>
</ol>


<p>此链在保持向后兼容性的同时，也鼓励使用基于 <code>CreationExtras</code> 的现代方法。</p>

<h3>NewInstanceFactory：基于反射的创建</h3>

<p>最简单的工厂使用反射来创建带有无参构造函数的 ViewModel：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">open</span> <span class="k">class</span> <span class="nc">NewInstanceFactory</span> <span class="p">:</span> <span class="n">Factory</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">JvmViewModelProviders</span><span class="p">.</span><span class="n">createViewModel</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>JVM 实现使用反射并进行了细致的错误处理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">object</span> <span class="nc">JvmViewModelProviders</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">createViewModel</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">constructor</span> <span class="p">=</span>
</span><span class='line'>            <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">modelClass</span><span class="p">.</span><span class="n">getDeclaredConstructor</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">NoSuchMethodException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot create an instance of $modelClass&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Enforce public constructor for consistent behavior</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(!</span><span class="n">Modifier</span><span class="p">.</span><span class="n">isPublic</span><span class="p">(</span><span class="n">constructor</span><span class="p">.</span><span class="n">modifiers</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot create an instance of $modelClass&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">constructor</span><span class="p">.</span><span class="n">newInstance</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">InstantiationException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot create an instance of $modelClass&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">IllegalAccessException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot create an instance of $modelClass&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>公共修饰符检查对于测试一致性至关重要。在插桩测试中，R8 可能会移除访问修饰符，使私有构造函数可访问。JVM 测试严格执行访问限制。此显式检查可确保跨测试环境的行为一致性。</p>

<h3>AndroidViewModelFactory：应用感知创建</h3>

<p><code>AndroidViewModelFactory</code> 继承自 <code>NewInstanceFactory</code> 以支持 <code>AndroidViewModel</code>，后者需要一个 <code>Application</code> 参数。该工厂在保持向后兼容性的同时，也采用了现代的 <code>CreationExtras</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">open</span> <span class="k">class</span> <span class="nc">AndroidViewModelFactory</span>
</span><span class='line'><span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">?,</span>
</span><span class='line'>    <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNUSED_PARAMETER&quot;</span><span class="p">)</span> <span class="n">unused</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">NewInstanceFactory</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">application</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">application</span> <span class="p">=</span> <span class="n">extras</span><span class="p">[</span><span class="n">APPLICATION_KEY</span><span class="p">]</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">application</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">AndroidViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">isAssignableFrom</span><span class="p">(</span><span class="n">modelClass</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span class='line'>                        <span class="s">&quot;CreationExtras must have an application by `APPLICATION_KEY`&quot;</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="k">super</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">Class</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">app</span><span class="p">:</span> <span class="n">Application</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">AndroidViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">isAssignableFrom</span><span class="p">(</span><span class="n">modelClass</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">modelClass</span><span class="p">.</span><span class="n">getConstructor</span><span class="p">(</span><span class="n">Application</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">).</span><span class="n">newInstance</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">NoSuchMethodException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">&quot;Cannot create an instance of $modelClass&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">super</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该工厂实现了级联解析策略：首先检查是否将 <code>Application</code> 传递给了构造函数（传统方法），然后通过 <code>APPLICATION_KEY</code> 在 <code>CreationExtras</code> 中查找（现代无状态方法），最后对于常规 ViewModel 回退到 <code>NewInstanceFactory</code>，或者如果 <code>AndroidViewModel</code> 没有可用的 <code>Application</code>，则抛出异常。</p>

<p>私有构造函数中的 <code>unused: Int</code> 参数是一个巧妙的技巧，用于区分重载构造函数，因为如果使用 <code>null</code> 调用 <code>constructor()</code>，编译器将无法区分 <code>constructor(application: Application?)</code>。</p>

<p>实例化使用了反射（<code>modelClass.getConstructor(Application::class.java).newInstance(app)</code>），这意味着你的 <code>AndroidViewModel</code> 子类必须有一个接受且仅接受一个 <code>Application</code> 参数的构造函数。对于其他依赖项，你需要自定义工厂或依赖注入框架，例如 Hilt。</p>

<h3>InitializerViewModelFactory：基于 Lambda 的创建</h3>

<p>对于具有自定义依赖项的 ViewModel，<code>InitializerViewModelFactory</code> 提供了一种基于 DSL 的方法，可以减少样板代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">factory</span> <span class="p">=</span> <span class="n">viewModelFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">initializer</span> <span class="p">{</span> <span class="n">MyViewModel</span><span class="p">(</span><span class="k">get</span><span class="p">(</span><span class="n">MY_KEY</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">initializer</span> <span class="p">{</span> <span class="n">AnotherViewModel</span><span class="p">(</span><span class="k">get</span><span class="p">(</span><span class="n">ANOTHER_KEY</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该 DSL 由一个构建器类驱动，该构建器类收集初始化 Lambda 表达式，其中每个初始化器将一个 <code>KClass</code> 与其创建 Lambda 表达式配对：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@ViewModelFactoryDsl</span>
</span><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">InitializerViewModelFactoryBuilder</span> <span class="k">public</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">initializers</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">KClass</span><span class="p">&lt;*&gt;,</span> <span class="n">ViewModelInitializer</span><span class="p">&lt;*&gt;&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">addInitializer</span><span class="p">(</span>
</span><span class='line'>        <span class="n">clazz</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
</span><span class='line'>        <span class="n">initializer</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">require</span><span class="p">(</span><span class="n">clazz</span> <span class="p">!</span><span class="k">in</span> <span class="n">initializers</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;A `initializer` with the same `clazz` has already been added: ${clazz.canonicalName}.&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">initializers</span><span class="p">[</span><span class="n">clazz</span><span class="p">]</span> <span class="p">=</span> <span class="n">ViewModelInitializer</span><span class="p">(</span><span class="n">clazz</span><span class="p">,</span> <span class="n">initializer</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">build</span><span class="p">():</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">ViewModelProviders</span><span class="p">.</span><span class="n">createInitializerFactory</span><span class="p">(</span><span class="n">initializers</span><span class="p">.</span><span class="n">values</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>@ViewModelFactoryDsl</code> 注解是一个 DSL 标记，可防止嵌套的构建器作用域意外访问外部作用域的方法。初始化 Lambda 表达式接收 <code>CreationExtras</code> 作为其接收器，允许通过 <code>get()</code> 直接访问额外内容。</p>

<p>在创建时，工厂会通过初始化器进行线性搜索，以找到匹配的类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">VM</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">createViewModelFromInitializers</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">VM</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">,</span>
</span><span class='line'>    <span class="k">vararg</span> <span class="n">initializers</span><span class="p">:</span> <span class="n">ViewModelInitializer</span><span class="p">&lt;*&gt;,</span>
</span><span class='line'><span class="p">):</span> <span class="n">VM</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">initializers</span><span class="p">.</span><span class="n">firstOrNull</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">clazz</span> <span class="p">==</span> <span class="n">modelClass</span> <span class="p">}</span><span class="o">?.</span><span class="n">initializer</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">extras</span><span class="p">)</span> <span class="k">as</span> <span class="n">VM</span><span class="p">?</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">requireNotNull</span><span class="p">(</span><span class="n">viewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&quot;No initializer set for given class ${modelClass.canonicalName}&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>线性搜索是可以接受的，因为每个工厂创建的 ViewModel 数量通常很少（1-5 个），而且 ViewModel 的创建频率很低（每个生命周期一次）。</p>

<h2>CreationExtras：无状态工厂配置</h2>

<p><code>CreationExtras</code> 是一个类型安全的键值容器，用于在不使工厂成为有状态的情况下向其传递配置。工厂不再通过构造函数注入来持有依赖项，而是在创建时传递依赖项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">CreationExtras</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">internal</span> <span class="k">val</span> <span class="py">extras</span><span class="p">:</span> <span class="n">MutableMap</span><span class="p">&lt;</span><span class="n">Key</span><span class="p">&lt;*&gt;,</span> <span class="n">Any</span><span class="p">?&gt;</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">interface</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">abstract</span> <span class="n">operator</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">object</span> <span class="nc">Empty</span> <span class="p">:</span> <span class="n">CreationExtras</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>类型安全的键</h3>

<p>每个键都由其关联的值类型参数化，从而提供编译时类型安全。当你使用 <code>extras[APPLICATION_KEY]</code> 获取值时，返回类型会自动为 <code>Application?</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">APPLICATION_KEY</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">Application</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Companion</span><span class="p">.</span><span class="n">Key</span><span class="p">()</span>
</span><span class='line'><span class="k">val</span> <span class="py">VIEW_MODEL_KEY</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Companion</span><span class="p">.</span><span class="n">Key</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>键的创建使用了一个内联函数，该函数创建一个实现 <code>Key</code> 接口的新匿名对象。由于每个键都是一个唯一的对象实例，因此键之间通过标识（<code>===</code>）进行比较，即使两个键具有相同的类型参数，也不会发生意外冲突：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@JvmStatic</span>
</span><span class='line'><span class="k">public</span> <span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">Key</span><span class="p">():</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>用于修改的 MutableCreationExtras</h3>

<p>基类 <code>CreationExtras</code> 是只读的，而 <code>MutableCreationExtras</code> 允许添加条目。这种分离遵循 Kotlin 的集合设计理念（例如 <code>List</code> 与 <code>MutableList</code>），防止工厂意外修改共享的 extras：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">MutableCreationExtras</span>
</span><span class='line'><span class="k">public</span> <span class="n">constructor</span><span class="p">(</span><span class="n">initialExtras</span><span class="p">:</span> <span class="n">CreationExtras</span> <span class="p">=</span> <span class="n">Empty</span><span class="p">)</span> <span class="p">:</span> <span class="n">CreationExtras</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">extras</span> <span class="p">+=</span> <span class="n">initialExtras</span><span class="p">.</span><span class="n">extras</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">operator</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="k">set</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">t</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">t</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">override</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Key</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;):</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="n">extras</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">as</span> <span class="n">T</span><span class="p">?</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>与 ViewModelProvider 集成</h3>

<p><code>ViewModelProvider</code> 会在调用工厂之前自动将 ViewModel 的键添加到 extras 中，这对于像 <code>SavedStateHandle</code> 这样需要键来正确限定持久化范围的功能至关重要：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">modelExtras</span> <span class="p">=</span> <span class="n">MutableCreationExtras</span><span class="p">(</span><span class="n">defaultExtras</span><span class="p">)</span>
</span><span class='line'><span class="n">modelExtras</span><span class="p">[</span><span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">VIEW_MODEL_KEY</span><span class="p">]</span> <span class="p">=</span> <span class="n">key</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span><span class="n">@synchronized</span> <span class="n">createViewModel</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="n">modelClass</span><span class="p">,</span> <span class="n">modelExtras</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>HasDefaultViewModelProviderFactory</h3>

<p><code>ViewModelStoreOwner</code> 的实现可以通过 <code>HasDefaultViewModelProviderFactory</code> 接口提供默认的工厂和 extras。 <code>ComponentActivity</code> 和 <code>Fragment</code> 都实现了此接口，并提供了支持 <code>SavedStateHandle</code> 且预先填充了 <code>APPLICATION_KEY</code> 的工厂：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">interface</span> <span class="n">HasDefaultViewModelProviderFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">val</span> <span class="py">defaultViewModelProviderFactory</span><span class="p">:</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">val</span> <span class="py">defaultViewModelCreationExtras</span><span class="p">:</span> <span class="n">CreationExtras</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Empty</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ComponentActivity</code> 和 <code>Fragment</code> 都实现了此接口，并提供了支持 <code>SavedStateHandle</code> 和正确的 <code>CreationExtras</code> 且预先填充了 <code>APPLICATION_KEY</code> 的工厂。</p>

<p>从 <code>ViewModelStoreOwner</code> 创建 <code>ViewModelProvider</code> 时，会自动使用以下默认值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">getDefaultFactory</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelStoreOwner</span><span class="p">):</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span> <span class="p">=</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="k">is</span> <span class="n">HasDefaultViewModelProviderFactory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">owner</span><span class="p">.</span><span class="n">defaultViewModelProviderFactory</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">DefaultViewModelProviderFactory</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">getDefaultCreationExtras</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelStoreOwner</span><span class="p">):</span> <span class="n">CreationExtras</span> <span class="p">=</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">owner</span> <span class="k">is</span> <span class="n">HasDefaultViewModelProviderFactory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">owner</span><span class="p">.</span><span class="n">defaultViewModelCreationExtras</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Empty</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种模式支持渐进增强：简单的 ViewModel 使用默认工厂，而复杂的 ViewModel 可以通过 extras 获取丰富的配置，而无需更改获取 ViewModelProvider 的方式。</p>

<h2>ViewModel 类：资源管理</h2>

<p><code>ViewModel</code> 类通过 <code>AutoCloseable</code> 模式管理资源生命周期。<code>expect</code> 关键字表明这是一个 Kotlin 多平台声明，每个平台都提供自己的 <code>actual</code> 实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">expect</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ViewModel</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">()</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">(</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">(</span><span class="k">vararg</span> <span class="n">closeables</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">constructor</span><span class="p">(</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">,</span> <span class="k">vararg</span> <span class="n">closeables</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">open</span> <span class="k">fun</span> <span class="nf">onCleared</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@MainThread</span> <span class="k">internal</span> <span class="k">fun</span> <span class="nf">clear</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">addCloseable</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">closeable</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">open</span> <span class="k">fun</span> <span class="nf">addCloseable</span><span class="p">(</span><span class="n">closeable</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">&gt;</span> <span class="n">getCloseable</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">T</span><span class="p">?</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>ViewModelImpl 内部实现</h3>

<p>实际实现委托给 <code>ViewModelImpl</code>，遵循多平台模式，将通用逻辑提取到内部类中。<code>isCleared</code> 上的 <code>@Volatile</code> 注解确保跨线程可见，这对于清除后的保护机制至关重要：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">ViewModelImpl</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">lock</span> <span class="p">=</span> <span class="n">SynchronizedObject</span><span class="p">()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">keyToCloseables</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">AutoCloseable</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">closeables</span> <span class="p">=</span> <span class="n">mutableSetOf</span><span class="p">&lt;</span><span class="n">AutoCloseable</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Volatile</span> <span class="k">private</span> <span class="k">var</span> <span class="py">isCleared</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">constructor</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">constructor</span><span class="p">(</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">addCloseable</span><span class="p">(</span><span class="n">VIEW_MODEL_SCOPE_KEY</span><span class="p">,</span> <span class="n">viewModelScope</span><span class="p">.</span><span class="n">asCloseable</span><span class="p">())</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">constructor</span><span class="p">(</span><span class="k">vararg</span> <span class="n">closeables</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">closeables</span> <span class="p">+=</span> <span class="n">closeables</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">constructor</span><span class="p">(</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">,</span> <span class="k">vararg</span> <span class="n">closeables</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">addCloseable</span><span class="p">(</span><span class="n">VIEW_MODEL_SCOPE_KEY</span><span class="p">,</span> <span class="n">viewModelScope</span><span class="p">.</span><span class="n">asCloseable</span><span class="p">())</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">closeables</span> <span class="p">+=</span> <span class="n">closeables</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>两层可关闭存储</h3>

<p>该实现维护两个集合：<code>keyToCloseables</code> 用于注册后需要检索的资源（例如 <code>viewModelScope</code>），以及 <code>closeables</code> 用于即用即弃的清理。使用 <code>Set</code> 来管理匿名可关闭资源可以防止重复注册导致双重关闭。</p>

<h3>清除顺序</h3>

<p>当 ViewModel 被清除时，资源会按照特定的顺序进行清理。<code>isCleared = true</code> 标志会在同步代码块之前设置，以防止并发的 <code>addCloseable</code> 调用添加会被遗漏的资源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@MainThread</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">isCleared</span><span class="p">)</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">isCleared</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>    <span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">closeable</span> <span class="k">in</span> <span class="n">keyToCloseables</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">closeWithRuntimeException</span><span class="p">(</span><span class="n">closeable</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">closeable</span> <span class="k">in</span> <span class="n">closeables</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">closeWithRuntimeException</span><span class="p">(</span><span class="n">closeable</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">// Clear only resources without keys to prevent accidental recreation</span>
</span><span class='line'>        <span class="n">closeables</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>匿名 <code>closeables</code> 集合会被清除，但 <code>keyToCloseables</code> 会被有意保留。这可以防止在清除后代码访问 <code>viewModelScope</code> 等资源时意外地重新创建它们。</p>

<h3>清除后保护</h3>

<p>在清除 ViewModel 后添加可关闭对象会立即将其关闭，从而防止在协程仍在运行时 ViewModel 被清除时出现资源泄漏：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">addCloseable</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">closeable</span><span class="p">:</span> <span class="n">AutoCloseable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">isCleared</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">closeWithRuntimeException</span><span class="p">(</span><span class="n">closeable</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">oldCloseable</span> <span class="p">=</span> <span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span> <span class="n">keyToCloseables</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">closeable</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">closeWithRuntimeException</span><span class="p">(</span><span class="n">oldCloseable</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>此外，请注意，添加键值可关闭对象时，任何具有相同键值的现有可关闭对象都会自动关闭，从而支持替换模式。</p>

<h3>用于模拟的可空实现</h3>

<p>JVM 实现提供了一个可空的 <code>impl</code> 对象，以支持模拟框架。当你模拟 ViewModel 时，模拟对象不会调用真正的构造函数，因此 <code>impl</code> 对象永远不会被初始化。如果没有可空类型和安全调用（<code>impl?.clear()</code>），测试会因 <code>NullPointerException</code> 而崩溃：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="n">actual</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ViewModel</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">impl</span><span class="p">:</span> <span class="n">ViewModelImpl</span><span class="p">?</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="n">actual</span> <span class="n">constructor</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">impl</span> <span class="p">=</span> <span class="n">ViewModelImpl</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@MainThread</span>
</span><span class='line'>    <span class="k">internal</span> <span class="n">actual</span> <span class="k">fun</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">impl</span><span class="o">?.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onCleared</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>viewModelScope：协程集成</h2>

<p><code>viewModelScope</code> 扩展属性提供了一个生命周期感知的 <code>CoroutineScope</code>，当 ViewModel 被清除时，该作用域会自动取消：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">val</span> <span class="py">ViewModel</span><span class="p">.</span><span class="n">viewModelScope</span><span class="p">:</span> <span class="n">CoroutineScope</span>
</span><span class='line'>    <span class="k">get</span><span class="p">()</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">synchronized</span><span class="p">(</span><span class="n">VIEW_MODEL_SCOPE_LOCK</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">getCloseable</span><span class="p">(</span><span class="n">VIEW_MODEL_SCOPE_KEY</span><span class="p">)</span>
</span><span class='line'>                <span class="o">?:</span> <span class="n">createViewModelScope</span><span class="p">().</span><span class="n">also</span> <span class="p">{</span> <span class="n">scope</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">addCloseable</span><span class="p">(</span><span class="n">VIEW_MODEL_SCOPE_KEY</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>使用键控存储的延迟创建</h3>

<p>作用域在首次访问时延迟创建，并使用键控可关闭机制进行存储。键名故意设置得非常详细，以避免与用户自定义的键发生冲突：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="n">const</span> <span class="k">val</span> <span class="py">VIEW_MODEL_SCOPE_KEY</span> <span class="p">=</span>
</span><span class='line'>    <span class="s">&quot;androidx.lifecycle.viewmodel.internal.ViewModelCoroutineScope.JOB_KEY&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CloseableCoroutineScope</h3>

<p>协程和可关闭系统之间的桥梁是 <code>CloseableCoroutineScope</code>，它同时实现了 <code>CoroutineScope</code> 和 <code>AutoCloseable</code> 接口。在 ViewModel 清空期间调用 <code>close()</code> 时，所有正在运行的协程都会被取消：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">CloseableCoroutineScope</span><span class="p">(</span><span class="k">override</span> <span class="k">val</span> <span class="py">coroutineContext</span><span class="p">:</span> <span class="n">CoroutineContext</span><span class="p">)</span> <span class="p">:</span>
</span><span class='line'>    <span class="n">AutoCloseable</span><span class="p">,</span> <span class="n">CoroutineScope</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">constructor</span><span class="p">(</span><span class="n">coroutineScope</span><span class="p">:</span> <span class="n">CoroutineScope</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">coroutineScope</span><span class="p">.</span><span class="n">coroutineContext</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">close</span><span class="p">()</span> <span class="p">=</span> <span class="n">coroutineContext</span><span class="p">.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>平台感知调度器选择</h3>

<p>作为 Kotlin 多平台库，ViewModel 在没有主线程概念的平台上也能工作，因为它会回退到 <code>EmptyCoroutineContext</code>。请注意，这里使用的是 <code>Dispatchers.Main.immediate</code> 而不是 <code>Dispatchers.Main</code>，这样可以避免在已经在主线程上运行时进行不必要的重新调度：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">fun</span> <span class="nf">createViewModelScope</span><span class="p">():</span> <span class="n">CloseableCoroutineScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">dispatcher</span> <span class="p">=</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Dispatchers</span><span class="p">.</span><span class="n">Main</span><span class="p">.</span><span class="n">immediate</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">NotImplementedError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// In Native environments where `Dispatchers.Main` might not exist (e.g., Linux)</span>
</span><span class='line'>            <span class="n">EmptyCoroutineContext</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">_</span><span class="p">:</span> <span class="n">IllegalStateException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// In JVM Desktop environments where `Dispatchers.Main` might not exist (e.g., Swing)</span>
</span><span class='line'>            <span class="n">EmptyCoroutineContext</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">CloseableCoroutineScope</span><span class="p">(</span><span class="n">coroutineContext</span> <span class="p">=</span> <span class="n">dispatcher</span> <span class="p">+</span> <span class="n">SupervisorJob</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>SupervisorJob 实现子协程独立失败</h3>

<p>该作用域使用 <code>SupervisorJob()</code>，允许子协程独立失败。而使用普通的 <code>Job</code> 时，如果一个子协程失败，它会取消所有同级协程。这种设计符合 UI 应用程序的预期，即失败的网络请求不应该取消正在进行的数据库操作。</p>

<h2>ViewModelLazy：Kotlin 属性委托</h2>

<p><code>viewModels()</code> 委托使用了 <code>ViewModelLazy</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ViewModelLazy</span><span class="p">&lt;</span><span class="n">VM</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span>
</span><span class='line'><span class="n">@JvmOverloads</span>
</span><span class='line'><span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">viewModelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">VM</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">storeProducer</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ViewModelStore</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">factoryProducer</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">extrasProducer</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">CreationExtras</span> <span class="p">=</span> <span class="p">{</span> <span class="n">CreationExtras</span><span class="p">.</span><span class="n">Empty</span> <span class="p">},</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">VM</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">cached</span><span class="p">:</span> <span class="n">VM</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">VM</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">cached</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">viewModel</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">store</span> <span class="p">=</span> <span class="n">storeProducer</span><span class="p">()</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">factory</span> <span class="p">=</span> <span class="n">factoryProducer</span><span class="p">()</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">extras</span> <span class="p">=</span> <span class="n">extrasProducer</span><span class="p">()</span>
</span><span class='line'>                <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">factory</span><span class="p">,</span> <span class="n">extras</span><span class="p">).</span><span class="k">get</span><span class="p">(</span><span class="n">viewModelClass</span><span class="p">).</span><span class="n">also</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">cached</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModel</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">isInitialized</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="n">cached</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>双重缓存架构</h3>

<p>惰性委托会在首次访问后将 ViewModel 引用缓存到本地。这是一种双重缓存模式：</p>

<ol>
<li><strong>ViewModelStore 缓存</strong>：规范缓存，不受配置更改的影响。</li>
<li><strong>ViewModelLazy 缓存</strong>：本地缓存，用于避免重复创建 ViewModelProvider。</li>
</ol>


<p>本地缓存是一种优化，创建 <code>ViewModelProvider</code> 并查找 ViewModel 的开销很小，但缓存可以避免后续访问中哪怕是这种微小的开销。</p>

<h3>用于延迟访问的 Lambda 生产者</h3>

<p>所有三个生产者（store、factory、extras）都是 Lambda 表达式，允许延迟求值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">viewModel</span> <span class="k">by</span> <span class="n">viewModels</span> <span class="p">{</span> <span class="n">MyViewModelFactory</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'><span class="c1">// Factory is only created when viewModel is first accessed</span>
</span></code></pre></td></tr></table></div></figure>


<p>这对于 Fragment 尤其重要，因为在属性初始化期间 Activity 可能不可用。</p>

<h2>Android 特有：AGP 代码脱糖兼容性</h2>

<p>Android 有一个特殊的兼容层，用于处理混合使用针对不同 ViewModel 版本编译的库时出现的 AGP（Android Gradle 插件）代码脱糖问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="n">actual</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">VM</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">createViewModel</span><span class="p">(</span>
</span><span class='line'>    <span class="n">factory</span><span class="p">:</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span><span class="p">,</span>
</span><span class='line'>    <span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">VM</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">VM</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">factory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">,</span> <span class="n">extras</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">AbstractMethodError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">factory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">.</span><span class="n">java</span><span class="p">,</span> <span class="n">extras</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">AbstractMethodError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">factory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这一系列 try-catch 代码块用于处理使用旧版本 ViewModel 编译的工厂缺少较新版本的 <code>create</code> 方法的情况。当运行时调用编译后的字节码中不存在的方法时，就会出现 <code>AbstractMethodError</code> 错误，这种情况通常发生在旧工厂只有 <code>create(Class&lt;T&gt;)</code> 方法，而运行时需要 <code>create(Class&lt;T&gt;, CreationExtras)</code> 方法时。这种防御性级联机制能够优雅地降级到方法变体，确保 ViewModel 创建功能不受库版本不匹配的影响。</p>

<h2>性能特性和设计权衡</h2>

<p>ViewModel 系统在设计上做出了一些权衡，以平衡正确性、灵活性和性能。</p>

<h3>同步开销</h3>

<p><code>ViewModelProviderImpl</code> 和 <code>ViewModelImpl</code> 都使用同步块来实现线程安全访问：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="n">store</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于 ViewModel 访问通常发生在主线程上，临界区很短（简单的 map 操作），并且锁争用很少发生，因此这种同步开销非常小。该设计优先考虑正确性而非微优化，因为罕见的竞态条件代价远高于几乎察觉不到的同步开销。</p>

<h3>反射开销</h3>

<p><code>NewInstanceFactory</code> 使用 Java 反射来动态实例化 ViewModel 类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">modelClass</span><span class="p">.</span><span class="n">getDeclaredConstructor</span><span class="p">().</span><span class="n">newInstance</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于运行时类型检查和动态方法解析，反射比直接构造函数调用要慢。但是，这种开销可以忽略不计，因为 ViewModel 的创建频率很低（每个生命周期一次），而且无需编译时信息即可实例化任何 ViewModel 子类的灵活性远远超过了这点微小的开销。</p>

<h3>基于映射的存储</h3>

<p>使用 <code>MutableMap</code> 作为 ViewModelStore 可以提供 O(1) 的查找时间，但清除操作的时间复杂度为 O(n)，因为每个 ViewModel 都必须单独清除：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">clear</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">vm</span> <span class="k">in</span> <span class="n">map</span><span class="p">.</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">vm</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">map</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于 ViewModelStore 通常只包含 1-5 个 ViewModel，因此线性时间的清除操作实际上并无影响。使用标准 HashMap 的简洁性使得代码更易于理解和维护，对于这种有限的用例而言，其价值远大于理论上的优化。</p>

<h3>用于模拟的可空实现</h3>

<p>JVM ViewModel 中的可空 <code>impl</code> 会在每个操作中添加空值检查：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">impl</span><span class="o">?.</span><span class="n">clear</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种微小的开销可以实现正确的模拟行为。当模拟框架创建 ViewModel 模拟对象时，它们会绕过真正的构造函数，导致 <code>impl</code> 未初始化。可空类型可以防止测试中出现 <code>NullPointerException</code>，这是一个值得的权衡。</p>

<h2>实际应用模式：理解 ViewModel 的使用</h2>

<p>理解其内部机制有助于你在实际应用中识别模式和反模式。</p>

<h3>模式 1：作用域 ViewModel 共享</h3>

<p>可以使用 Activity 的 ViewModelStore 而不是每个 Fragment 自己的存储来在 Fragment 之间共享 ViewModel：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">FragmentA</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">sharedViewModel</span><span class="p">:</span> <span class="n">SharedViewModel</span> <span class="k">by</span> <span class="n">activityViewModels</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FragmentB</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">sharedViewModel</span><span class="p">:</span> <span class="n">SharedViewModel</span> <span class="k">by</span> <span class="n">activityViewModels</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>两个 Fragment 会获得相同的 ViewModel 实例，因为它们使用相同的 ViewModelStore（Activity 的）。这使得兄弟 Fragment 可以通过共享状态进行通信。内部机制：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// activityViewModels() uses:</span>
</span><span class='line'><span class="n">ViewModelProvider</span><span class="p">(</span>
</span><span class='line'>    <span class="n">store</span> <span class="p">=</span> <span class="n">requireActivity</span><span class="p">().</span><span class="n">viewModelStore</span><span class="p">,</span>  <span class="c1">// Same store for both fragments</span>
</span><span class='line'>    <span class="n">factory</span> <span class="p">=</span> <span class="p">...,</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>模式 2：自定义键用于多个实例</h3>

<p>你可以通过提供自定义键来拥有同一个 ViewModel 类的多个实例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">viewModel1</span><span class="p">:</span> <span class="n">MyViewModel</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="s">&quot;user_1&quot;</span><span class="p">,</span> <span class="n">MyViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span><span class='line'><span class="k">val</span> <span class="py">viewModel2</span><span class="p">:</span> <span class="n">MyViewModel</span> <span class="p">=</span> <span class="n">viewModelProvider</span><span class="p">[</span><span class="s">&quot;user_2&quot;</span><span class="p">,</span> <span class="n">MyViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>该键包含自定义字符串，从而在 ViewModelStore 中创建单独的缓存条目。这对于同时管理多个用户配置文件或聊天对话等场景非常有用。</p>

<h3>模式 3：使用 CreationExtras 进行工厂注入</h3>

<p>现代工厂是无状态的，在创建时通过 CreationExtras 接收所有依赖项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">MyViewModelFactory</span> <span class="p">:</span> <span class="n">ViewModelProvider</span><span class="p">.</span><span class="n">Factory</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="n">KClass</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span> <span class="n">extras</span><span class="p">:</span> <span class="n">CreationExtras</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">repository</span> <span class="p">=</span> <span class="n">extras</span><span class="p">[</span><span class="n">REPOSITORY_KEY</span><span class="p">]</span><span class="o">!!</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userId</span> <span class="p">=</span> <span class="n">extras</span><span class="p">[</span><span class="n">USER_ID_KEY</span><span class="p">]</span><span class="o">!!</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">MyViewModel</span><span class="p">(</span><span class="n">repository</span><span class="p">,</span> <span class="n">userId</span><span class="p">)</span> <span class="k">as</span> <span class="n">T</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这使得工厂可以作为单例，同时每次调用配置都不同，从而避免为每个具有不同依赖项的 ViewModel 创建新的工厂实例。</p>

<h3>反模式：在 ViewModel 中访问 Context</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Bad: Leaks Activity context</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Good: Use Application context via AndroidViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span><span class="p">(</span><span class="n">application</span><span class="p">:</span> <span class="n">Application</span><span class="p">)</span> <span class="p">:</span> <span class="n">AndroidViewModel</span><span class="p">(</span><span class="n">application</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Better: Don&#39;t hold Context at all, pass it to methods</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MyViewModel</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">loadData</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>第一种方法可能会导致 Activity 泄漏，因为 ViewModel 在持有已销毁 Activity 的引用时，配置更改仍然存在。请使用 <code>AndroidViewModel</code> 来获取 Application 上下文，或者在需要时将 Context 传递给各个方法。</p>

<h3>反模式：在 onCleared 中阻塞</h3>

<p>你知道 <code>onCleared()</code> 是在主线程上调用的吗？诸如网络关闭或数据库清理之类的阻塞操作应该使用协程的 <code>addCloseable</code> 方法卸载到后台线程：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Bad: Blocking call in onCleared</span>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">onCleared</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">networkClient</span><span class="p">.</span><span class="n">shutdown</span><span class="p">()</span>  <span class="c1">// May block the main thread until completing the shutdown process!</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Good: Use addCloseable for managed cleanup</span>
</span><span class='line'><span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">addCloseable</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">scope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span> <span class="n">networkClient</span><span class="p">.</span><span class="n">shutdown</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>结论</h2>

<p>Jetpack ViewModel 的内部机制展现了一个精心设计的生命周期感知状态管理系统。ViewModelStore 通过保留映射提供简单而有效的缓存，而 ViewModelProvider 则通过线程安全的访问和灵活的工厂支持来协调创建过程。CreationExtras 通过外部化配置来实现无状态工厂，而 AutoCloseable 集成则确保了资源的正确清理。</p>

<p>多平台架构将通用逻辑提取到内部实现类中，使该库能够支持 JVM、Android、iOS 和其他平台。viewModelScope 集成通过 closeable 机制提供自动协程取消功能，并为没有主线程的环境提供平台感知的调度器选择。</p>

<p>如果你想掌握最新的技能、新闻、技术文章、面试题和实用代码技巧，请查看<a href="https://github.com/doveletter/">Dove Letter</a>。想要更深入地了解面试准备，千万不要错过终极 Android 面试指南：<a href="https://www.android.skydoves.me/">Manifest Android Interview</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[学会在Jetpack Compose中加载Lottie动画资源]]></title>
    <link href="https://alexhilton.github.io/blog/2025/12/25/compose-lottie-resources/"/>
    <updated>2025-12-25T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/12/25/compose-lottie-resources</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「From File to Fetch」，原文链接<a href="https://proandroiddev.com/from-file-to-fetch-ed6dca1122c8">https://proandroiddev.com/from-file-to-fetch-ed6dca1122c8</a>，由Katie Barnett发布于2025年11月23日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/12/25/compose-lottie-resources/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*qaaJ_zFlqmNT3CKeLpsvKw.gif" title="auto auto" ></a></p>

<!-- more -->


<p>_注意：我与 Airbnb 及其 Lottie 项目（Lottie 的 GitHub 仓库）没有任何关联。](<a href="https://github.com/airbnb/lottie-android">https://github.com/airbnb/lottie-android</a>)我最近刚在一个应用中实现了 Lottie，想分享一些示例来佐证<a href="https://lottie.airbnb.tech/#/android-compose">官方文档</a>。</p>

<h2>了解 Lottie</h2>

<p>之前，我写过关于动画的文章<a href="https://medium.com/bilue/expanding-dialog-in-jetpack-compose-a6be40deab86">https://medium.com/bilue/card-flip-animation-with-jetpack-compose-f60aaaad4ac9</a>，也<a href="https://www.youtube.com/watch?v=ol9zpXu3g1U">在</a>上讨论过这个主题，以及我是如何创建原生动画的。但有时，我们想要一些更具艺术性的效果，不需要移动屏幕上的可组合元素；这时，我们就需要一个预先构建好的动画。</p>

<p>Lottie 就派上用场了。</p>

<p>如果你之前没有使用过 Lottie，它是由 Airbnb 开发人员开发的一个库，可以解析 Adob​​e After Effects 动画并将其导出为 JSON 格式。其理念是，设计师可以创建复杂的动画，而无需手动渲染。有很多设计工具的插件可以帮助创建动画，例如 Figma。如果你具备一定的设计天赋（我没有！），上手也很容易。</p>

<p>Lottie 已经存在一段时间了，可以在多个平台上渲染，例如 iOS、Web、Windows，当然还有 Android。它可用于 <a href="https://lottie.airbnb.tech/#/android">XML 视图</a>，但我今天要重点介绍的是它与 Jetpack Compose 的集成。</p>

<p>官方文档在这里 <a href="https://lottie.airbnb.tech/#/android-compose">https://lottie.airbnb.tech/#/android-compose</a>，但它并没有详细介绍如何使用 <code>LottieCompositionSpec</code> 中的多种不同源类​​型，以最便捷的方式提供我们的 Lottie 文件。实际上，某些应用可能需要处理多种源类型，尤其是在后端调用中指定特定动画的情况下。</p>

<p>我们将逐步介绍每种类型，但首先，让我们使用字符串来保存 Lottie 动画数据，从而进行基本设置。</p>

<h2>字符串来源</h2>

<p>使用任何 SDK 的第一步都是添加依赖项：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// build.gradle.kts</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="n">libs</span><span class="p">.</span><span class="n">lottie</span><span class="p">.</span><span class="n">compose</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// libs.version.toml</span>
</span><span class='line'><span class="na">[versions]</span>
</span><span class='line'><span class="n">lottie</span> <span class="p">=</span> <span class="s">&quot;6.6.6&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="na">[libraries]</span>
</span><span class='line'><span class="n">lottie</span><span class="p">-</span><span class="n">compose</span> <span class="p">=</span> <span class="p">{</span> <span class="n">group</span> <span class="p">=</span> <span class="s">&quot;com.airbnb.android&quot;</span><span class="p">,</span> <span class="n">name</span> <span class="p">=</span> <span class="s">&quot;lottie-compose&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">.</span><span class="n">ref</span> <span class="p">=</span> <span class="s">&quot;lottie&quot;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，在 Composable 中，我们需要创建 <code>LottieCompositionSpec</code>。对于 JSON 字符串，我们可以使用 <code>LottieCompositionSpec.JsonString(val jsonString: String)</code>，</p>

<p>并将字符串传递给它。接下来，使用 <code>rememberLottieComposition</code> 并传入 <code>spec</code> 来记住组合状态。最后，可以将此状态传递给 <code>LottieAnimation</code> 以显示动画。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpec</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">JsonString</span><span class="p">(</span><span class="n">JSON_STRING</span><span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">lottieComposition</span> <span class="p">=</span> <span class="n">rememberLottieComposition</span><span class="p">(</span>
</span><span class='line'>    <span class="n">spec</span> <span class="p">=</span> <span class="n">lottieCompositionSpec</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">LottieAnimation</span><span class="p">(</span><span class="n">composition</span> <span class="p">=</span> <span class="n">lottieComposition</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">const</span> <span class="k">val</span> <span class="py">JSON_STRING</span> <span class="p">=</span> <span class="s">&quot;{\&quot;v\&quot;:\&quot;4.10.1\&quot;,...\&quot;bm\&quot;:0}]}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:280/format:webp/1*pILmCNmRVMiswfyiq3yviw.gif" alt="Lottie动画来自 https://github.com/airbnb/lottie-android" /></p>

<p>现在，将动画存储在字符串中并非最易读或可持续的方式，更好的选择是使用Lottie JSON文件。一种方法是将其存储在assets目录中……</p>

<h2>Asset文件</h2>

<p>我们可以将Lottie文件存储为<code>.json</code>或<code>.lottie</code>文件（它们是同一种文件，只是扩展名不同），并将其存储在<code>app/assets</code>目录中。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*RYfpCujExeKM_FC0XOedPA.png" alt="" /></p>

<p>这里唯一的区别是我们需要使用 <code>LottieCompositionSpec.Asset(val assetName: String)</code> 并传递 <code>assets</code> 目录下的路径（你可以根据需要进行组织）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpecLottieFile</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">Asset</span><span class="p">(</span><span class="s">&quot;animations/android_wave.lottie&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpecJsonFile</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">Asset</span><span class="p">(</span><span class="s">&quot;animations/android_wave.json&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>类似地，我们可以使用 <code>LottieCompositionSpec.File(val fileName: String)</code> 从设备文件系统中的任何位置加载动画文件——只需确保应用程序已获得该文件的访问权限即可！</p>

<p>使用资源文件意味着我们无法获得编译时保护来确保文件存在，但我们可以使用 <code>res/raw</code> 目录。</p>

<h2>原始资源文件</h2>

<p>同样，这很简单，只需将文件添加到 <code>raw</code> 目录即可：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*I0jHURry7W04WUibyHvunA.png" alt="" /></p>

<p>现在，我们可以通过使用 <code>LottieCompositionSpec.RawRes</code> 和 <code>R.raw</code> 访问原始资源，从而获得编译时安全性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpec</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">RawRes</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">android_wave</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，如果我们希望在需要时动态获取 Lottie 文件，而不是将其打包到应用程序中，我们可以从 URL 加载它。</p>

<h2>URL 来源</h2>

<p>与上述类似，我们可以使用 <code>LottieCompositionSpec.Url</code> 加载以 URL 形式存储的 Lottie 文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpec</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">Url</span><span class="p">(</span><span class="s">&quot;https://url/AndroidWave.json&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果一切顺利，用户网络连接良好，这当然很好，但我们需要确保能够处理任何错误。</p>

<h3>错误响应和添加加载状态</h3>

<p>动画加载也可能需要一些时间，尤其是在动画文件较大或用户网络连接不佳的情况下。为此，我们可以使用 <code>LottieCompositionResult</code> 来检测动画的状态。</p>

<p>当动画正在下载或解析时，<code>LottieCompositionResult.isLoading</code> 将为 true；当解析成功且合成已准备好显示时，<code>LottieCompositionResult.isSuccess</code> 将为 true。我们还有两个状态：<code>LottieCompositionResult.isComplete</code>，当 <code>isLoading</code> 为 false 时（无论组合是否成功），它将为 true；最后是 <code>LottieCompositionResult.isFailure</code>，当出现不可恢复的错误时（即下文讨论的 <code>onRetry</code> lambda 返回 <code>false</code> 时），它将为 true。</p>

<p>为了展示标准的加载、错误和成功行为，我们可以像这样使用 <code>isLoading</code> 和 <code>isSuccess</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">lottieComposition</span><span class="p">.</span><span class="n">isLoading</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">contentAlignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CircularProgressIndicator</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lottieComposition</span><span class="p">.</span><span class="n">isSuccess</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">LottieAnimation</span><span class="p">(</span>
</span><span class='line'>        <span class="n">composition</span> <span class="p">=</span> <span class="n">lottieComposition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Image</span><span class="p">(</span>
</span><span class='line'>        <span class="n">imageVector</span> <span class="p">=</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Error</span><span class="p">,</span>
</span><span class='line'>        <span class="n">contentDescription</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>重试动画加载错误</h3>

<p>Lottie 提供了一种简单易用的方法，可以使用 <code>rememberLottieComposition</code> 中的 <code>onRetry</code> 来重试动画加载。我们可以通过两种方式使用它：</p>

<p><strong>反复重试直到达到某个限制</strong></p>

<p>在构造 <code>rememberLottieComposition</code> 时，我们可以指定 <code>onRetry</code> lambda，并返回 <code>true</code> 以继续重试，返回 <code>false</code> 以停止重试。 <code>onRetry</code> 包含一个 <code>failCount</code> 参数。这允许应用重试次数限制或指数退避。例如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">lottieComposition</span> <span class="p">=</span> <span class="n">rememberLottieComposition</span><span class="p">(</span>
</span><span class='line'>    <span class="n">spec</span> <span class="p">=</span> <span class="n">lottieCompositionSpec</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onRetry</span> <span class="p">=</span> <span class="p">{</span> <span class="n">failCount</span><span class="p">,</span> <span class="n">exception</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">Timber</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="s">&quot;Error loading animation: ${exception.message}&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">failCount</span> <span class="p">&lt;</span> <span class="m">5</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里我将动画设置为重试 5 次后停止。你可以在此 lambda 表达式中添加错误消息或其他任何有用的信息（但请使用上面描述的 <code>LottieCompositionResult.isLoading</code> 布尔值来显示加载行为，而不是在此处设置另一个变量）。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:280/format:webp/1*d9gomTwO-kr5K9mufbMinA.gif" alt="" /></p>

<p><strong>等待重试信号</strong></p>

<p>我们还可以允许动画等待重试，直到某个外部条件发生变化，例如按下按钮或恢复网络连接。</p>

<p>为此，我们使用 <code>rememberLottieRetrySignal</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">retrySignal</span> <span class="p">=</span> <span class="n">rememberLottieRetrySignal</span><span class="p">()</span>
</span><span class='line'><span class="k">var</span> <span class="py">url</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="s">&quot;https://bad/url&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">val</span> <span class="py">lottieCompositionSpec</span> <span class="p">=</span> <span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">Url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'><span class="k">val</span> <span class="py">lottieComposition</span> <span class="p">=</span> <span class="n">rememberLottieComposition</span><span class="p">(</span>
</span><span class='line'>    <span class="n">spec</span> <span class="p">=</span> <span class="n">lottieCompositionSpec</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onRetry</span> <span class="p">=</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">exception</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">Timber</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">exception</span><span class="p">,</span> <span class="s">&quot;Error loading animation: ${exception.message}&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">retrySignal</span><span class="p">.</span><span class="n">awaitRetry</span><span class="p">()</span>
</span><span class='line'>        <span class="k">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="n">Column</span><span class="p">(...)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">lottieComposition</span><span class="p">.</span><span class="n">isLoading</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lottieComposition</span><span class="p">.</span><span class="n">isSuccess</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">LottieAnimation</span><span class="p">(</span>
</span><span class='line'>            <span class="n">composition</span> <span class="p">=</span> <span class="n">lottieComposition</span><span class="p">.</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">TextButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">url</span> <span class="p">=</span> <span class="s">&quot;https://url/AndroidWave.json&quot;</span>
</span><span class='line'>        <span class="n">retrySignal</span><span class="p">.</span><span class="n">retry</span><span class="p">()</span>
</span><span class='line'>    <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Fix url &amp; retry&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这个简单的示例中，我将 URL 设置为无效 URL，然后在 <code>onRetry</code> 中，当发生错误时，我们可以使用记住的 <code>retrySignal</code> 来等待重试。 <code>retrySignal.awaitRetry()</code>。动画将保持加载状态，直到按钮点击时调用 <code>retrySignal.retry()</code>。如果你不希望保持加载状态，而是希望在重试之前显示错误信息，你可以完全省略 <code>retrySignal</code>，并更新已记住的 <code>url</code> 状态，这样 <code>LottieCompositionSpec</code> 将重新组合。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:280/format:webp/1*HZRs6-0_sZxmXImH999iVA.gif" alt="" /></p>

<h2>动画配置</h2>

<p>最后，动画加载正确后，我们可以使用一些其他配置项来优化动画效果。</p>

<p>虽然最好在 Lottie 文件本身（创建时完成）中控制这些动画行为，但你也可以通过以下方式调整动画的播放方式： <code>LottieAnimation</code> 本身是可组合的。要了解其功能，最好查看一些可用参数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// An excerpt from version 6.6.6 of the SDK</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">LottieAnimation</span><span class="p">(</span>
</span><span class='line'>    <span class="n">clipSpec</span><span class="p">:</span> <span class="n">LottieClipSpec</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">speed</span><span class="p">:</span> <span class="n">Float</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span>
</span><span class='line'>    <span class="n">iterations</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span>
</span><span class='line'>    <span class="n">reverseOnRepeat</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="n">alignment</span><span class="p">:</span> <span class="n">Alignment</span> <span class="p">=</span> <span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">,</span>
</span><span class='line'>    <span class="n">contentScale</span><span class="p">:</span> <span class="n">ContentScale</span> <span class="p">=</span> <span class="n">ContentScale</span><span class="p">.</span><span class="n">Fit</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span> <span class="c1">// + others for more advanced use, check out the SDK documentation</span>
</span><span class='line'><span class="p">)</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这里，我们可以控制：</p>

<ul>
<li><p><code>clipSpec</code>：动画播放的帧</p></li>
<li><p><code>speed</code>：动画速度</p></li>
<li><p><code>iterations</code>：动画运行次数（使用 <code>LottieConstants.IterateForever</code> 可无限循环）</p></li>
<li><p><code>reverseOnRepeat</code>：循环播放后反向播放</p></li>
<li><p><code>alignment</code> 和 <code>contentScale</code>：就像图像一样，我们可以调整动画在指定范围内的布局。</p></li>
</ul>


<p>现在你可以了解 Lottie 的所有用法，请务必为你正在开发的应用程序选择最佳方案，并选择最便捷的方式从你的设计团队获取文件，而无需费力地在不同文件格式之间进行转换。</p>

<p>再见！现在！</p>

<p><img src="https://miro.medium.com/v2/resize:fit:600/1*AbjuxEFO34XUsPCAs-U-Kw.gif" alt="" /></p>

<p>你可以在我的 GitHub 仓库的 <a href="https://github.com/KatieBarnett/Experiments/tree/main/jc-lottie">jc-lottie</a> 模块中找到上述示例代码。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetpack Compose 2025年12月版本新增功能]]></title>
    <link href="https://alexhilton.github.io/blog/2025/12/18/compose-december-2025/"/>
    <updated>2025-12-18T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/12/18/compose-december-2025</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「What&rsquo;s new in the Jetpack Compose December &lsquo;25 release」，原文链接<a href="https://android-developers.googleblog.com/2025/12/whats-new-in-jetpack-compose-december.html">https://android-developers.googleblog.com/2025/12/whats-new-in-jetpack-compose-december.html</a>，由Nick Butcher发布于2025年12月3日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/12/18/compose-december-2025/"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjaOFQLkqCBaw0FA8C7XCI7gKe-Z79r2dYH9QUOnWyZq_Qevh-EoHqRs6zTENmzLjHwKk_ECQlN_2EePI8-JyjCVH3PL2rOsbRdfKNZ6T" title="auto auto" ></a></p>

<!-- more -->


<p>现在，<a href="https://developer.android.com/jetpack/androidx/releases/compose">Jetpack Compose 2025年12月版本</a> 正式发布。该版本包含 Compose 核心模块 1.10 版和 Material 3 1.4 版（参见完整的 <a href="https://developer.android.com/develop/ui/compose/bom/bom-mapping">BOM 映射</a>），新增了多项功能并显著提升了性能。</p>

<p>要使用最新的版本，请将 Compose BOM 版本升级到 2025.12.00：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">implementation</span><span class="p">(</span><span class="n">platform</span><span class="p">(</span><span class="s">&quot;androidx.compose:compose-bom:2025.12.00&quot;</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>性能改进</h2>

<p>我们知道应用程序的运行时性能对你和你的用户至关重要，因此性能一直是 Compose 团队的首要任务。此版本带来了一系列改进——你只需升级到最新版本即可获得所有这些改进。我们的内部滚动性能基准测试表明，Compose 现在的性能与使用 Views 时的性能相当：</p>

<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEhmNWZbGEVpwg-kdd6kw9Ay8TyOjGS226GxU1oNQQCI0IBJ1aj_Pze-SQ0z9LGywbdbzIROkIv6hxKKMIXJ0sBs-q5U_cv-yslsXFRzdRihM0MxWI3q2j-LURfcILGe7i9KodgjuGgUkAoeeZspHUa11iDkAiJTs295rxSDtgSWK0VSEofLt2MWburL7II" alt="滚动性能基准测试比较了 Views 和 Jetpack Compose 在不同 Compose 版本下的性能" /></p>

<h3>延迟预取中的可暂停组合</h3>

<p>延迟预取中的可暂停组合预取功能现已默认启用。这是 Compose 运行时调度机制的一项根本性变革，旨在显著减少高 UI 负载下的卡顿现象。</p>

<p>此前，一旦合成开始，就必须运行至完成。如果合成较为复杂，则可能导致主线程阻塞超过一帧，从而造成 UI 卡顿。而现在，借助可暂停合成功能，运行时可以在时间不足时“暂停”其工作，并在下一帧恢复。当与延迟布局预取结合使用，提前准备帧时，此功能尤为有效。 Compose 1.9 中引入的 LazyLayout<a href="https://developer.android.com/reference/kotlin/androidx/compose/foundation/lazy/package-summary#rememberLazyListState(androidx.compose.foundation.lazy.layout.LazyLayoutCacheWindow,kotlin.Int,kotlin.Int)">CacheWindow</a> API 可以很好地预取更多内容，并利用可暂停的合成功能来显著提升 UI 性能。</p>

<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhaE5BKUo2mBxNKAmgD8nnrrbooEAbjCSxsGJbJx6DgTmMPx8BmTWsOg2I2_FXcOODSG8OAX31ueJfgipH2zdF1Y3v6CcIXGW3mWiWcHbemqnmVO-IYWKVJ-V6CiD9LDo_35nqyWrDgK3Y_HOdUDfL8StGnfgg34Ia6wda1bXoDT3xhMQb8w2hn_d2gLhQ/s16000/pausable.gif" alt="可暂停合成结合延迟预取有助于减少卡顿" /></p>

<p>我们还优化了其他方面的性能，例如改进了 Modifier.onPlaced。 Modifier.onVisibilityChanged 和其他修饰符实现。我们将继续投入资源来提升 Compose 的性能。</p>

<h2>新功能</h2>

<h3>Retain</h3>

<p>Compose 提供了一系列 API 来跨不同的生命周期保存和管理状态；例如，<code>remember</code> 可以在组合之间持久化状态，而 <code>rememberSavable</code>/<code>rememberSerializable</code> 可以在 Activity 或进程重建之间持久化状态。<code>retain</code> 是一个介于这些 API 之间的新 API，它允许你在配置更改时持久化值而无需序列化，但不会跨进程终止。由于 <code>retain</code> 不会序列化你的状态，因此你可以持久化诸如 lambda 表达式、流程以及位图等难以序列化的大型对象。例如，你可以使用 <code>retain</code> 来管理媒体播放器（例如 ExoPlayer），以确保媒体播放不会因配置更改而中断。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">MediaPlayer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">applicationContext</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span><span class="p">.</span><span class="n">applicationContext</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">exoPlayer</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="n">ExoPlayer</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}.</span><span class="n">build</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们要感谢 AndroidDev 社区（特别是 <a href="https://slackhq.github.io/circuit">Circuit</a> 团队），他们对该功能的设计产生了影响并做出了贡献。</p>

<h3>Material 1.4</h3>

<p>Material3 库的 1.4.0 版本新增了一些组件和增强功能：</p>

<ul>
<li><p>TextField 现在提供了一个基于 TextFieldState 的实验性版本，它提供了一种 <a href="https://developer.android.com/develop/ui/compose/text/user-input">更强大的</a> 方法来管理文本状态。此外，还新增了变体SecureTextField 和 OutlinedSecureTextField。Material Text 可组合元素现在支持自动调整大小功能（autoSize）。</p></li>
<li><p>轮播组件现在提供了一个新的 <a href="https://developer.android.com/reference/kotlin/androidx/compose/material3/carousel/package-summary#Horizo%E2%80%8B%E2%80%8BntalCenteredHeroCarousel(androidx.compose.material3.carousel.CarouselState,androidx.compose.ui.Modifier,androidx.compose.ui.unit.Dp,androidx.compose.ui.unit.Dp,androidx.compose.foundation.gestures.TargetedFlingBehavior,kotlin.Boolean,androidx.compose.ui.unit.Dp,androidx.compose.ui.unit.Dp,androidx.compose.foundation.layout.PaddingValues,kotlin.Function2)">Horizo​​ntalCenteredHeroCarousel</a><a href="https://m3.material.io/components/carousel/specs">variant</a>。</p></li>
<li><p><a href="https://developer.android.com/reference/kotlin/androidx/compose/material3/package-summary?_gl=1*1h4dj5y*_up*MQ..*_ga*NDE1MzI0NzAwLjE3NjQ2MTM1MzU.*_ga_6HH9YJMN9M*czE3NjQ2MTM1MzQkbzEkZzAkdDE3NjQ2MTM1MzQkajYwJGwwJGgxODIyOTM4OTMy#TimePicker(androidx.compose.material3.TimePickerState,androidx.compose.ui.Modifier,androidx.compose.material3.TimePickerColors,androidx.compose.material3.TimePickerLayoutType)">TimePicker</a> 现在支持在选择器模式和输入模式之间切换。</p></li>
<li><p>垂直拖拽手柄（<a href="https://developer.android.com/reference/kotlin/androidx/compose/material3/package-summary#VerticalDragHandle(androidx.compose.ui.Modifier,androidx.compose.material3.DragHandleSizes,androidx.compose.material3.DragHandleColors,androidx.compose.material3.DragHandleShapes,androidx.compose.foundation.interaction.MutableInteractionSource)">VerticalDragHandle</a>）帮助用户更改自适应空格的大小或者位置。</p></li>
</ul>


<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhTrvNyW_IJgSIqBWYlzweN3mkoZ_Uc3IMNj2Pu0cC1VdVqnja4nHA6kSCO2nk44MBi2diWEPu_oe0ozm2Jxh5jjXyJ7uqHdrdkyTrDaCgIifMpHLK9q3stUhD79QuLc7q_V4EisrNR7t4I3SMAxSq57EVzk8PGqiouXPRc-wI9Pu03vbuDU3_rnrA4THc/s16000/centered-hero-carousel.gif" alt="Horizontal centered hero carousel" /></p>

<p>请注意，<a href="https://m3.material.io/blog/building-with-m3-expressive">Material 3 Expressive</a> API 仍在 Material 3 库的 alpha 版本中持续开发。要了解更多信息，请观看<a href="https://www.youtube.com/embed/t9rrsqfB2tM">最近的演讲</a>。</p>

<h2>新的动画功能</h2>

<p>我们持续扩展动画 API，包括对自定义共享元素动画的更新。</p>

<h3>动态共享元素</h3>

<p>默认情况下，<code>sharedElement()</code> 和 <code>sharedBounds()</code> 动画会在目标状态中找到匹配的键时尝试为布局更改添加动画效果。但是，你可能希望根据某些条件（例如导航方向或当前 UI 状态）动态禁用​​此动画。</p>

<p>要控制共享元素过渡是否发生，你现在可以自定义传递给 <code>rememberSharedContentState()</code> 的 <code>SharedContentConfig</code>。<code>isEnabled</code> 属性决定共享元素是否处于活动状态。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">SharedTransitionLayout</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="py">transition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
</span><span class='line'>  <span class="n">transition</span><span class="p">.</span><span class="n">AnimatedContent</span> <span class="p">{</span> <span class="n">targetState</span> <span class="p">-&gt;</span>
</span><span class='line'>      <span class="c1">// Create the configuration that depends on state changing.</span>
</span><span class='line'>      <span class="k">fun</span> <span class="nf">animationConfig</span><span class="p">()</span> <span class="p">:</span> <span class="n">SharedTransitionScope</span><span class="p">.</span><span class="n">SharedContentConfig</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="k">object</span> <span class="err">: </span><span class="nc">SharedTransitionScope</span><span class="p">.</span><span class="n">SharedContentConfig</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">override</span> <span class="k">val</span> <span class="py">SharedTransitionScope</span><span class="p">.</span><span class="n">SharedContentState</span><span class="p">.</span><span class="n">isEnabled</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>                      <span class="k">get</span><span class="p">()</span> <span class="p">=</span>
</span><span class='line'>                          <span class="c1">// determine whether to perform a shared element transition</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>更多信息，请参阅<a href="https://developer.android.com/develop/ui/compose/animation/shared-elements/customize#dynamic-enable-disable">文档</a>。</p>

<h3>Modifier.skipToLookaheadPosition()</h3>

<p>此版本新增了一个修饰符 <a href="https://developer.android.com/reference/kotlin/androidx/compose/animation/SharedTransitionScope?hl=en#(androidx.compose.ui.Modifier).skipToLookaheadPosition(kotlin.Function0)">Modifier.skipToLookaheadPosition()</a>，用于在执行共享元素动画时保持可组合元素的最终位置。这使得可以执行类似“揭示”类型的过渡动画，例如 Androidify 示例中相机的渐进式揭示效果。更多信息，请参阅<a href="https://www.youtube.com/embed/0moEXBqNDZI">此处的视频提示</a>。</p>

<h3>共享元素过渡中的初始速度</h3>

<p>此版本新增了一个共享元素过渡 API：<code>prepareTransitionWithInitialVelocity</code>，允许你将初始速度（例如来自手势）传递给共享元素过渡：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">draggable2D</span><span class="p">(</span>
</span><span class='line'>          <span class="n">rememberDraggable2DState</span><span class="p">{</span><span class="n">offset</span><span class="p">+=</span><span class="n">it</span><span class="p">},</span>
</span><span class='line'>          <span class="n">onDragStopped</span> <span class="p">=</span> <span class="p">{</span> <span class="n">velocity</span> <span class="p">-&gt;</span>
</span><span class='line'>              <span class="c1">// Set up the initial velocity for the upcoming shared element</span>
</span><span class='line'>              <span class="c1">// transition.</span>
</span><span class='line'>            <span class="n">sharedContentStateForDraggableCat</span><span class="o">?.</span><span class="n">prepareTransitionWithInitialVelocity</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>
</span><span class='line'>              <span class="n">showDetails</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi-XdYTEA7H5BokZRoo_npAvjuSLPP3cXifTSHtonoHiuQVtav1w9ZKhIqlxQJKeX9AxyQnR0HjSe3t1Sy02jdMYiWI_mg1VoJST55CAKgBtkvHpgRatXJobhPVoimLQCJ-F6dfLRDt75vJANi46D4MhobglqRG7rSFb3VqglLcE6rNLx3c02Vzqiqr6IY/w288-h640/fling-shared.gif" alt="一个以初始速度开始的共享元素过渡，该初始速度来自手势" /></p>

<h3>面纱过渡动画</h3>

<p><a href="https://developer.android.com/reference/kotlin/androidx/compose/animation/EnterTransition">EnterTransition</a> 和 <a href="https://developer.android.com/reference/kotlin/androidx/compose/animation/ExitTransition?_gl=1*1m00og2*_up*MQ..*_ga*MjU3NDMyNzc5LjE3NjQ2MTE4NjM.*_ga_6HH9YJMN9M*czE3NjQ2MTE4NjMkbzEkZzAkdDE3NjQ2MTE4NjMkajYwJGwwJGgxMTk2NzM1MDk0">ExitTransition</a> 定义了动画的执行方式。 <a href="https://developer.android.com/reference/kotlin/androidx/compose/animation/package-summary#AnimatedVisibility">AnimatedVisibility</a>/ <a href="https://developer.android.com/refe%20rence/kotlin/androidx/compose/animation/package-summary#AnimatedContent">AnimatedContent</a> 可组合元素出现或消失。新增的实验性遮罩选项允许你指定颜色来遮盖或修饰内容；例如，在内容上方淡入/淡出半透明黑色图层：</p>

<p><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhemyKNMNnK50HVISQJlCz4fXPkkckq-ZdOgB3f8dolMzDe6UgCGq3_nVQhdfNb8au6cL00LHR0EJIQqxOQnnCXNSs8284eIMGroEp1V_F48JHkIk_kzPiYAov-nI3LAIG0_XXNjVQUIXwDvgH_rdMgF9wn_u605WU8oOD-uW-MSVKUHzyekqYsnFrEqms/w304-h640/veil_2.gif" alt="带遮蔽的动画内容 – 注意在动画过程中覆盖在网格内容上的半透明遮蔽层（或幕布）动画" /></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">AnimatedContent</span><span class="p">(</span>
</span><span class='line'>    <span class="n">targetState</span> <span class="p">=</span> <span class="n">page</span><span class="p">,</span>
</span><span class='line'>    <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">),</span>
</span><span class='line'>    <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>       <span class="k">if</span> <span class="p">(</span><span class="n">targetState</span> <span class="p">&gt;</span> <span class="n">initialState</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">(</span><span class="n">slideInHorizontally</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}</span> <span class="n">togetherWith</span>
</span><span class='line'>                    <span class="n">slideOutHorizontally</span> <span class="p">{</span> <span class="p">-</span><span class="n">it</span> <span class="p">/</span> <span class="m">2</span> <span class="p">}</span> <span class="p">+</span> <span class="n">veilOut</span><span class="p">(</span><span class="n">targetColor</span> <span class="p">=</span> <span class="n">veilColor</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">slideInHorizontally</span> <span class="p">{</span> <span class="p">-</span><span class="n">it</span> <span class="p">/</span> <span class="m">2</span> <span class="p">}</span> <span class="p">+</span>
</span><span class='line'>                      <span class="n">unveilIn</span><span class="p">(</span><span class="n">initialColor</span> <span class="p">=</span> <span class="n">veilColor</span><span class="p">)</span> <span class="n">togetherWith</span> <span class="n">slideOutHorizontally</span> <span class="p">{</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span> <span class="n">targetPage</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>即将发生的变更</h2>

<h3>弃用 Modifier.onFirstVisible</h3>

<p>Compose 1.9 引入了 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/Modifier#%28androidx.compose.ui.Modifier%29.onVisibilityChanged%28kotlin.Long,kotlin.Float,androidx.compose.ui.layout.LayoutBoundsHolder,kotlin.Function1%29">Modifier.onVisibilityChanged</a> 和 <a href="https://developer.android.com/reference/kotlin/androidx/compose/ui/Modifier#%28androidx.compose.ui.Modifier%29.onFirstVisible%28kotlin.Long,kotlin.Float,androidx.compose.ui.layout.LayoutBoundsHolder,kotlin.Function0%29">Modifier.onFirstVisible</a>。在审阅了你的反馈后，我们发现 <code>Modifier.onFirstVisible</code> 的约定无法确定性地执行；具体来说，就是无法确定某个元素何时首次可见。例如，Lazy 布局可能会释放滚动出视口的元素，然后在它们滚动回视口时重新组合它们。在这种情况下，<code>onFirstVisible</code> 回调会再次触发，因为它是一个新组合的元素。当导航回之前访问过的包含 <code>onFirstVisible</code> 的屏幕时，也会出现类似的行为。因此，我们决定在下一个 Compose 版本（1.11）中弃用此修饰符，并建议迁移到 <code>onVisibilityChanged</code>。有关更多信息，请参阅<a href="https://developer.android.com/develop/ui/compose/layouts/visibility-modifiers">文档</a>。</p>

<h3>测试中的协程分发</h3>

<p>我们计划更改测试中的协程分发，以改善测试的稳定性并捕获更多问题。目前，测试使用的是 UnconfinedTestDispatcher，这与生产环境的行为有所不同；例如，<a href="https://developer.android.com/develop/ui/compose/side-effects">副作用</a>可能会立即运行，而不是被放入队列。在未来的版本中，我们计划引入一个新的 API，默认使用 StandardTestDispatcher，以匹配生产环境的行为。你现在可以在 1.10 版本中尝试新的行为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@get</span><span class="p">:</span><span class="n">Rule</span> <span class="c1">// also createAndroidComposeRule, createEmptyComposeRule</span>
</span><span class='line'><span class="k">val</span> <span class="py">rule</span> <span class="p">=</span> <span class="n">createComposeRule</span><span class="p">(</span><span class="n">effectContext</span> <span class="p">=</span> <span class="n">StandardTestDispatcher</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用 StandardTestDispatcher 会将任务放入队列，因此你必须使用同步机制，例如 composeTestRule.waitForIdle() 或 composeTestRule.runOnIdle()。如果你的测试使用了 runTest，则必须确保 runTest 和你的 Compose 规则共享同一个 StandardTestDispatcher 实例以进行同步。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// 1. Create a SINGLE dispatcher instance</span>
</span><span class='line'><span class="n">valtestDispatcher</span> <span class="p">=</span> <span class="n">StandardTestDispatcher</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2. Pass it to your Compose rule</span>
</span><span class='line'><span class="n">@get</span><span class="p">:</span><span class="n">Rule</span>
</span><span class='line'><span class="n">valcomposeRule</span> <span class="p">=</span> <span class="n">createComposeRule</span><span class="p">(</span><span class="n">effectContext</span> <span class="p">=</span> <span class="n">testDispatcher</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="c1">// 3. Pass the *SAME INSTANCE* to runTest</span>
</span><span class='line'><span class="n">funmyTest</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span><span class="p">(</span><span class="n">testDispatcher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">composeRule</span><span class="p">.</span><span class="n">setContent</span><span class="p">{</span><span class="cm">/* ... */</span><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>工具</h2>

<p>优秀的 API 需要优秀的工具，<a href="http://d.android.com/studio">Android Studio</a> 为 Compose 开发者新增了多项功能：</p>

<ul>
<li><p><a href="https://developer.android.com/studio/preview/features#iterate-ui-agent">变换 UI</a>：右键单击 @Preview，选择“变换 UI”，然后用自然语言描述更改，即可迭代你的设计。</p></li>
<li><p><a href="https://developer.android.com/studio/preview/features#ui-tools-setup">生成 @Preview</a>：右键单击可组合元素，然后选择 Gemini > 生成 [可组合元素名称] 预览。</p></li>
<li><p><a href="https://developer.android.com/studio/preview/features#material-symbols-support">自定义 Material Symbols</a>：矢量资源向导新增了对图标变体的支持。</p></li>
<li><p><a href="https://developer.android.com/studio/preview/features#screen-to-code-agent">从屏幕截图生成代码</a> 或让 Gemini <a href="https://developer.android.com/studio/preview/features#match-ui-agent">将你现有的 UI 与目标图像匹配</a>。这可以与远程 <a href="https://developer.android.com/studio/preview/features#remote-mcp">MCP 支持</a> 结合使用，例如连接到 Figma 文件并从设计生成 Compose UI。</p></li>
<li><p><a href="https://developer.android.com/studio/preview/features#find-and-fix-ui-quality-issues">修复 UI 质量问题</a> 会审核你的 UI 是否存在常见问题，例如辅助功能问题，然后提出修复方案。</p></li>
</ul>


<p>要查看这些工具的实际应用，请观看此 <a href="https://www.youtube.com/embed/jTlW8JeCClA">最新演示</a>。</p>

<h2>尽情创作</h2>

<p>我们持续投入资源开发 Jetpack Compose，为你提供创建美观、丰富的用户界面所需的 API 和工具。我们重视你的反馈，请在我们的<a href="https://issuetracker.google.com/issues/new?component=612128">问题跟踪器</a>中分享你对这些更改的反馈，或你希望看到的后续功能。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[借助RemoteCompose开发动态化页面]]></title>
    <link href="https://alexhilton.github.io/blog/2025/12/11/intro-to-remotecompose/"/>
    <updated>2025-12-11T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/12/11/intro-to-remotecompose</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「RemoteCompose: Another Paradigm for Server-Driven UI in Jetpack Compose」，原文链接<a href="https://proandroiddev.com/remotecompose-another-paradigm-for-server-driven-ui-in-jetpack-compose-92186619ba8f">https://proandroiddev.com/remotecompose-another-paradigm-for-server-driven-ui-in-jetpack-compose-92186619ba8f</a>，由Jaewoong Eum发布于2025年11月29日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/12/11/intro-to-remotecompose/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*o9-kxXHKgJcB-Bvh" title="auto auto" ></a></p>

<!-- more -->


<p>构建动态用户界面一直是 Android 开发中的一项根本性挑战。传统方法要求每次 UI 需要更改时都必须重新编译和重新部署整个应用程序，这给 A/B 测试、功能开关和实时内容更新带来了极大的不便。</p>

<p>试想一下，你的营销团队想要测试一个新的结账按钮设计：在传统模式下，这种简单的更改需要开发人员花费时间、进行代码审查、QA 测试、提交到应用商店，以及等待数周才能获得用户采纳。RemoteCompose 的出现为解决这一问题提供了一个强大的方案，它使开发人员能够在运行时创建、传输和渲染 Jetpack Compose UI 布局，而无需重新编译。</p>

<p>本文将探讨 RemoteCompose 的概念，理解其核心架构，并探索它如何为 Jetpack Compose 的动态页面设计带来诸多优势。本文并非库的使用教程，而是着重探讨它所代表的 Android UI 开发范式转变。</p>

<h3><strong>集成与依赖</strong></h3>

<p>在深入探讨概念之前，我们先来了解如何将 RemoteCompose 添加到你的项目中。对于运行在 JVM 上且不依赖 Android 的服务器和后端：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="c1">// settings.gradle</span>
</span><span class='line'><span class="n">repositories</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">maven</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">url</span> <span class="o">=</span> <span class="n">uri</span><span class="o">(</span><span class="s2">&quot;https://androidx.dev/snapshots/builds/14511716/artifacts/repository&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// JVM server - no Android dependencies</span>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="o">(</span><span class="s2">&quot;androidx.compose.remote:remote-core:1.0.0-SNAPSHOT&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="o">(</span><span class="s2">&quot;androidx.compose.remote:remote-creation-compose:1.0.0-SNAPSHOT&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Compose-based app</span>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="o">(</span><span class="s2">&quot;androidx.compose.remote:remote-player-compose:1.0.0-SNAPSHOT&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="o">(</span><span class="s2">&quot;androidx.compose.remote:remote-tooling-preview:1.0.0-SNAPSHOT&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// View-based app</span>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="o">(</span><span class="s2">&quot;androidx.compose.remote:remote-player-view:1.0.0-SNAPSHOT&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意，RemoteCompose 仍在由 AndroidX 团队开发中，尚未正式发布；它仅可通过 AndroidX 快照 Maven 仓库获取。</p>

<h3>理解核心抽象</h3>

<p>RemoteCompose 的核心是一个框架，它支持 Compose UI 组件的远程渲染。它与传统 UI 方法的区别在于它遵循两个基本原则：声明式文档序列化和平台无关渲染。这些不仅仅是技术特性；这些架构决策从根本上改变了你对 UI 部署的思考方式。</p>

<p><strong>声明式文档序列化</strong></p>

<p>声明式文档序列化意味着你可以将任何 Jetpack Compose 布局捕获为紧凑的序列化格式。你可以把它想象成对 UI 进行“截图”，只不过你捕获的不是像素，而是实际的绘图指令。这个捕获的文档包含了重建 UI 所需的一切：形状、颜色、文本、图像、动画，甚至还有交互式触摸区域。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// On the server or creation side</span>
</span><span class='line'><span class="k">val</span> <span class="py">document</span> <span class="p">=</span> <span class="n">captureRemoteDocument</span><span class="p">(</span>
</span><span class='line'>    <span class="n">context</span> <span class="p">=</span> <span class="n">context</span><span class="p">,</span>
</span><span class='line'>    <span class="n">creationDisplayInfo</span> <span class="p">=</span> <span class="n">displayInfo</span><span class="p">,</span>
</span><span class='line'>    <span class="n">profile</span> <span class="p">=</span> <span class="n">profile</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">RemoteColumn</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">RemoteText</span><span class="p">(</span><span class="s">&quot;Dynamic Content&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">RemoteButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="cm">/* action */</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">RemoteText</span><span class="p">(</span><span class="s">&quot;Click Me&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果如何？一个可以通过网络发送的字节数组。这种方法的关键在于，创建端编写的是标准的 Compose 代码。无需学习新的 DSL，无需维护 JSON 模式，也无需掌握模板语言。只要可以用 Compose 编写，就可以用 RemoteCompose 捕获。</p>

<p>你可以捕获一个普通的 Compose 代码，它会捕获绘制调用（这些调用非常静态）。更常见的情况是，你应该拥有镜像 Compose 的 Remote* 专用 API，这些 API 专为序列化和远程播放而设计，例如 <code>RemoteColumn</code>、<code>RemoteButton</code>、<code>RemoteText</code> 等。</p>

<p><strong>平台无关渲染</strong></p>

<p>平台无关渲染意味着捕获的文档可以通过网络传输，并在任何 Android 设备上渲染，而无需原始的 Compose 代码。客户端设备不需要你的可组合函数、视图模型或业务逻辑——它只需要文档字节和一个播放器。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// On the client or player side</span>
</span><span class='line'><span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">document</span> <span class="p">=</span> <span class="n">remoteDocument</span><span class="p">.</span><span class="n">document</span><span class="p">,</span>
</span><span class='line'>    <span class="n">documentWidth</span> <span class="p">=</span> <span class="n">windowInfo</span><span class="p">.</span><span class="n">containerSize</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
</span><span class='line'>    <span class="n">documentHeight</span> <span class="p">=</span> <span class="n">windowInfo</span><span class="p">.</span><span class="n">containerSize</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">actionId</span><span class="p">,</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// Handle user interactions</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些特性并非仅仅是为了方便；它们是架构约束，能够真正实现 UI 定义与部署的解耦。文档格式不仅包含静态布局，还包含状态、动画和交互，从而完整地呈现了 UI 体验。</p>

<p><strong>​​方法比较：为什么不选择 JSON 或 WebView？</strong></p>

<p>在深入探讨之前，我们有必要了解 RemoteCompose 为什么选择这种方法而不是其他方案。</p>

<p>基于 JSON 的服务器端 UI，例如 Airbnb 的 Epoxy 或 Shopify 的方法，需要定义一个映射到原生组件的模式。这种方法适用于结构化内容，但难以处理复杂的动画和过渡效果、自定义绘图和图形、带有内联样式的富文本以及渐变和阴影等视觉效果。</p>

<p>WebView 提供了全面的灵活性，但由于其独立的渲染过程，会带来性能开销；此外，Web 样式与原生设计在外观和体验上存在不一致；每个 WebView 都会占用大量资源，造成内存压力；触摸处理也较为复杂，容易出现手势冲突。</p>

<p>RemoteCompose 另辟蹊径：捕获 Compose 实际执行的绘制操作。这意味着，你可以使用 Compose 构建的任何 UI，包括自定义 Canvas 绘制、复杂动画和 Material Design 组件，都可以被捕获并以原生性能远程重放。</p>

<h3><strong>基于文档的架构：创建与回放</strong></h3>

<p>RemoteCompose 的架构围绕着两个阶段的清晰分离而构建：文档创建和文档回放。理解这种分离是理解框架强大功能的关键。</p>

<p><strong>文档创建：将 UI 作为数据捕获</strong></p>

<p>创建阶段将 Compose UI 代码转换为序列化文档。这是通过捕获机制实现的，该机制会在 Canvas 层（Android 渲染管线的最底层）拦截绘制操作。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span> <span class="n">Content</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">RemoteComposeCreationState</span> <span class="p">(</span><span class="n">Tracks</span> <span class="n">state</span> <span class="n">and</span> <span class="n">modifiers</span><span class="p">)</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">CaptureComposeView</span> <span class="p">(</span><span class="n">Virtual</span> <span class="n">Display</span> <span class="p">-</span> <span class="n">no</span> <span class="n">actual</span> <span class="n">screen</span> <span class="n">needed</span><span class="p">)</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">RecordingCanvas</span> <span class="p">(</span><span class="n">Intercepts</span> <span class="n">every</span> <span class="n">draw</span> <span class="n">call</span><span class="p">)</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">Operations</span> <span class="p">(</span><span class="m">93</span><span class="p">+</span> <span class="n">operation</span> <span class="n">types</span> <span class="n">covering</span> <span class="n">all</span> <span class="n">drawing</span> <span class="n">primitives</span><span class="p">)</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">RemoteComposeBuffer</span> <span class="p">(</span><span class="n">Efficient</span> <span class="n">binary</span> <span class="n">serialization</span><span class="p">)</span>
</span><span class='line'>        <span class="err">↓</span>
</span><span class='line'><span class="n">ByteArray</span> <span class="p">(</span><span class="n">Network</span><span class="p">-</span><span class="n">ready</span><span class="p">,</span> <span class="n">typically</span> <span class="m">10</span><span class="p">-</span><span class="m">100</span><span class="n">KB</span> <span class="k">for</span> <span class="n">complex</span> <span class="n">UIs</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>创建端提供了一个完整的 Compose 集成层。你只需编写标准的 <code>@Composable</code> 函数，框架即可捕获所有内容：布局层级、修饰符、文本样式、图像、动画，甚至触摸处理程序。</p>

<p>其独特之处在于，捕获的文档是自包含的。它包含形状、颜色、渐变和阴影等视觉元素，以及带有字符串、字体、大小和样式的文本。图像可以嵌入为位图或 URL 以实现延迟加载。布局信息涵盖大小、位置、内边距和对齐方式。交互定义了触摸区域、点击处理程序和命名操作。状态变量可以在运行时更新，动画则通过基于时间的运动表达式来表达。</p>

<p>接收方无需访问你的代码库，只需访问文档字节即可。这与其他服务器驱动的 UI 方法有着本质区别，在其他方法中，客户端需要理解架构或拥有预构建的组件。</p>

<p><strong>文档播放：无需编译即可渲染</strong></p>

<p>播放阶段接收序列化的文档并将其渲染到屏幕上。播放器会遍历一系列操作，对 Canvas 执行每个操作。其概念类似于视频播放器解码帧的方式，只不过我们解码的是绘图指令而不是像素。</p>

<p>RemoteCompose 提供两种渲染后端以满足不同的架构需求。基于 Compose 的播放器推荐用于现代应用程序：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">DynamicScreen</span><span class="p">(</span><span class="n">document</span><span class="p">:</span> <span class="n">CoreDocument</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>        <span class="n">document</span> <span class="p">=</span> <span class="n">document</span><span class="p">,</span>
</span><span class='line'>        <span class="n">documentWidth</span> <span class="p">=</span> <span class="n">screenWidth</span><span class="p">,</span>
</span><span class='line'>        <span class="n">documentHeight</span> <span class="p">=</span> <span class="n">screenHeight</span><span class="p">,</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateUpdater</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// Handle named actions from the document</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="s">&quot;addToCart&quot;</span> <span class="p">-&gt;</span> <span class="n">cartManager</span><span class="p">.</span><span class="n">addItem</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                <span class="s">&quot;navigate&quot;</span> <span class="p">-&gt;</span> <span class="n">navController</span><span class="p">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                <span class="s">&quot;trackEvent&quot;</span> <span class="p">-&gt;</span> <span class="n">analytics</span><span class="p">.</span><span class="n">logEvent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">bitmapLoader</span> <span class="p">=</span> <span class="n">rememberBitmapLoader</span><span class="p">()</span>  <span class="c1">// For lazy image loading</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>基于 Compose 的播放器可以自然地与你现有的 Compose UI 集成。它是一个可组合的函数，你可以将其放置在组合层级结构中的任何位置，并像其他可组合函数一样对其应用修饰符和动画。</p>

<p>为了与现有的 View 层级结构兼容，我们还提供了一个基于 View 的播放器：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">LegacyActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">player</span><span class="p">:</span> <span class="n">RemoteComposePlayer</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="n">RemoteComposePlayer</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>        <span class="n">setContentView</span><span class="p">(</span><span class="n">player</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Load document from network</span>
</span><span class='line'>        <span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">fetchDocument</span><span class="p">(</span><span class="s">&quot;home-screen&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="n">player</span><span class="p">.</span><span class="n">setDocument</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">player</span><span class="p">.</span><span class="n">onNamedAction</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateUpdater</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// Handle actions</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>两种播放器提供相同的渲染保真度；选择哪种取决于你的应用程序架构。如果你完全使用 Compose，请使用可组合播放器。如果你是从 Views 迁移过来的，或者将其嵌入到 View 层级结构中，请使用基于 View 的播放器。</p>

<h3><strong>操作模型：一套全面的绘图词汇表</strong></h3>

<p>RemoteCompose 的优势在于其全面的操作模型。该框架定义了 93 种以上的不同操作，涵盖了 UI 渲染的方方面面。这并非随意设定的数字，而是表达任何 Canvas 绘图操作所需的完整词汇表。</p>

<p><strong>操作的重要性</strong></p>

<p>传统的服务器驱动型 UI 发送的是高级组件描述：“渲染一个带有文本‘提交’的按钮”。客户端必须解析这些描述并将其映射到原生组件。这导致服务器和客户端之间紧密耦合；双方必须就“按钮”的定义及其行为达成一致。</p>

<p>RemoteCompose 则在更底层运行：它不发送“渲染一个按钮”这样的描述，而是发送实际的绘图指令：“在这些坐标处绘制一个带有这种颜色的圆角矩形，然后在这个位置绘制带有这种字体的文本‘提交’”。客户端无需了解“按钮”的定义；它只需执行绘图操作即可。</p>

<p>这种底层方法意义深远。由于服务器和客户端无需就组件定义达成一致，因此无需进行模式同步。由于 Compose 中所有可能的视觉效果均可捕获，因此能够完整保留视觉保真度。由于新的视觉设计可在旧客户端上运行（它们只是不同的绘制操作），因此内置了向前兼容性。自定义组件无需注册即可自动运行。</p>

<p><strong>绘制操作</strong></p>

<p>绘制操作捕获 Canvas 绘制调用，这是 2D 图形的基本图元。这些图元包括：用于按钮、卡片和背景的矩形的 <code>DRAW_RECT</code>；用于带有圆角的 Material 曲面的 <code>DRAW_ROUND_RECT</code>；用于头像和指示器的 <code>DRAW_CIRCLE</code>；用于渲染带有完整样式的文本的 <code>DRAW_TEXT</code>；用于沿曲线绘制文本的 <code>DRAW_TEXT_ON_PATH</code>；以及用于图像的 <code>DRAW_BITMAP</code>。 <code>DRAW_TWEEN_PATH</code> 用于动画路径变形，等等。</p>

<p>每个操作都包含执行它所需的所有信息：坐标、颜色、绘制样式以及对文档中其他位置存储的数据（例如文本字符串或位图）的引用。</p>

<p><strong>布局操作</strong></p>

<p>布局操作定义组件层次结构和空间关系。<code>Component</code> 操作声明一个布局组件，而 <code>Container</code> 操作创建一个类似于 <code>Column</code> 或 <code>Row</code> 的容器，<code>ContainerEnd</code> 操作则关闭它。<code>LoopOperation</code> 操作用于循环列表内容。<code>Modifier</code> 包括用于背景颜色和可绘制对象的 <code>BackgroundModifier</code>、用于边框样式的 <code>BorderModifier</code>、用于内部间距的 <code>PaddingModifier</code> 以及用于触摸处理的 <code>ClickModifier</code>。</p>

<p>容器模型采用推送/弹出机制。当播放器遇到 <code>Container</code> 操作时，它会创建一个新的布局上下文。所有后续操作都将在该上下文中执行，直到 <code>ContainerEnd</code> 操作将其弹出。这与 Compose 的布局系统的工作方式类似。</p>

<p><strong>状态和表达式操作</strong></p>

<p>状态操作支持运行时可更改的动态值。<code>NamedVariable</code> 声明一个命名的状态变量。<code>ColorAttribute</code> 提供可自定义主题的颜色。<code>TimeAttribute</code> 引用动画时间。<code>FloatExpression</code> 和 <code>IntegerExpression</code> 每帧计算数学表达式。<code>ConditionalOp</code> 支持基于状态的条件渲染。</p>

<p>表达式系统功能强大。你可以嵌入公式，而不是静态值：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// These expressions are evaluated every frame</span>
</span><span class='line'><span class="k">val</span> <span class="py">opacity</span> <span class="p">=</span> <span class="n">FloatExpression</span><span class="p">(</span><span class="s">&quot;sin(time * 2) * 0.5 + 0.5&quot;</span><span class="p">)</span>  <span class="c1">// Pulsing effect</span>
</span><span class='line'><span class="k">val</span> <span class="py">rotation</span> <span class="p">=</span> <span class="n">FloatExpression</span><span class="p">(</span><span class="s">&quot;time * 90 % 360&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Continuous rotation</span>
</span><span class='line'><span class="k">val</span> <span class="py">position</span> <span class="p">=</span> <span class="n">FloatExpression</span><span class="p">(</span><span class="s">&quot;lerp(0, 100, time / 2)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Linear interpolation</span>
</span></code></pre></td></tr></table></div></figure>


<p>这使得完全在文档中定义丰富的动画成为可能——无需客户端动画代码。
​​
<strong>交互操作</strong></p>

<p>交互操作处理用户输入。<code>TouchOperation</code> 定义触摸区域，而 <code>CLICK_AREA</code> 处理简单的点击操作。<code>ParticlesCreate</code> 初始化粒子系统，<code>ParticlesLoop</code> 驱动粒子动画。</p>

<p>触摸操作注册带有命名操作的矩形区域。当用户点击某个区域时，播放器会触发相应的操作，宿主应用程序会通过回调函数来处理这些操作。这种设计既保持了文档格式的简洁性，又实现了丰富的交互功能。</p>

<h3>动态屏幕设计的优势</h3>

<p>现在，让我们通过常见应用场景中的真实案例，来探讨 RemoteCompose 为动态屏幕设计带来的切实优势。</p>

<p><strong>服务器驱动 UI，性能毫不妥协</strong></p>

<p>传统的服务器驱动 UI 方法需要权衡取舍。基于 JSON 的布局表达能力有限，无法实现复杂的动画或自定义绘制。WebView 会带来性能开销、外观不一致以及更高的内存占用。自定义 DSL 则会增加维护负担、学习曲线，并且对预定义组件有所限制。</p>

<p>RemoteCompose 提供了第三条路径：从服务器定义的布局进行原生 Compose 渲染。你既能充分利用 Compose 渲染引擎的强大功能，又能享受服务器驱动内容的灵活性。</p>

<p>例如，一个电商应用需要频繁更新产品卡片、添加新的徽章样式、促销叠加层或季节性主题。借助 RemoteCompose，服务器端允许营销团队无需发布应用即可更新卡片设计：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: We can update card designs without app release</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductCard</span><span class="p">(</span><span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Card</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">clickable</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;viewProduct&quot;</span><span class="p">,</span> <span class="n">product</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Product image with gradient overlay</span>
</span><span class='line'>            <span class="n">AsyncImage</span><span class="p">(</span>
</span><span class='line'>                <span class="n">url</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">imageUrl</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">().</span><span class="n">aspectRatio</span><span class="p">(</span><span class="m">1.5f</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Promotional badge - can be A/B tested server-side</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">hasPromotion</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">PromotionalBadge</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">text</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">promotionText</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">TopEnd</span><span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Price with sale styling</span>
</span><span class='line'>            <span class="n">PriceTag</span><span class="p">(</span>
</span><span class='line'>                <span class="n">originalPrice</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">originalPrice</span><span class="p">,</span>
</span><span class='line'>                <span class="n">salePrice</span> <span class="p">=</span> <span class="n">product</span><span class="p">.</span><span class="n">salePrice</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomStart</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端只需渲染服务器发送的内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Client-side: Just renders whatever the server sends</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductGrid</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">ProductViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">documents</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">productDocuments</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LazyVerticalGrid</span><span class="p">(</span><span class="n">columns</span> <span class="p">=</span> <span class="n">GridCells</span><span class="p">.</span><span class="n">Fixed</span><span class="p">(</span><span class="m">2</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">items</span><span class="p">(</span><span class="n">documents</span><span class="p">)</span> <span class="p">{</span> <span class="n">document</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>                <span class="n">document</span> <span class="p">=</span> <span class="n">document</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="p">==</span> <span class="s">&quot;viewProduct&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">navController</span><span class="p">.</span><span class="n">navigate</span><span class="p">(</span><span class="s">&quot;product/$value&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在，你的团队无需发布任何应用即可更新产品卡片设计，更改徽章颜色、添加动画和重新排列元素。由于它是原生应用，通过 Compose 的实际绘制管道渲染，因此 UI 的外观和体验与原生应用无异。</p>

<h3>大规模 A/B 测试</h3>

<p>传统的 A/B 测试 UI 变体需要在应用二进制文件中实现所有变体，为每个变体创建功能标志，发布包含所有变体的应用，然后等待用户采用后再衡量结果。从构思到获得数据，这个过程通常需要 2-4 周。</p>

<p>借助 RemoteCompose，你无需部署任何客户端即可测试 UI 变体。假设一个电商团队想要测试单页结账流程是否比多步骤向导转化率更高：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: Two completely different checkout experiences</span>
</span><span class='line'><span class="k">object</span> <span class="nc">CheckoutExperiments</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getCheckoutDocument</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">cart</span><span class="p">:</span> <span class="n">Cart</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">variant</span> <span class="p">=</span> <span class="n">experimentService</span><span class="p">.</span><span class="n">getVariant</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;checkout-flow&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">variant</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;single-page&quot;</span> <span class="p">-&gt;</span> <span class="n">captureSinglePageCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
</span><span class='line'>            <span class="s">&quot;multi-step&quot;</span> <span class="p">-&gt;</span> <span class="n">captureMultiStepCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
</span><span class='line'>            <span class="s">&quot;express&quot;</span> <span class="p">-&gt;</span> <span class="n">captureExpressCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>  <span class="c1">// New variant added without app update</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">captureSinglePageCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">captureSinglePageCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">:</span> <span class="n">Cart</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">displayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">SinglePageCheckout</span><span class="p">(</span>
</span><span class='line'>                <span class="n">cart</span> <span class="p">=</span> <span class="n">cart</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onPlaceOrder</span> <span class="p">=</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;placeOrder&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>                <span class="n">onUpdateQuantity</span> <span class="p">=</span> <span class="p">{</span> <span class="n">itemId</span><span class="p">,</span> <span class="n">qty</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;updateQuantity&quot;</span><span class="p">,</span> <span class="s">&quot;$itemId:$qty&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">captureMultiStepCheckout</span><span class="p">(</span><span class="n">cart</span><span class="p">:</span> <span class="n">Cart</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">displayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">MultiStepCheckout</span><span class="p">(</span>
</span><span class='line'>                <span class="n">cart</span> <span class="p">=</span> <span class="n">cart</span><span class="p">,</span>
</span><span class='line'>                <span class="n">steps</span> <span class="p">=</span> <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;Shipping&quot;</span><span class="p">,</span> <span class="s">&quot;Payment&quot;</span><span class="p">,</span> <span class="s">&quot;Review&quot;</span><span class="p">),</span>
</span><span class='line'>                <span class="n">onComplete</span> <span class="p">=</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;placeOrder&quot;</span><span class="p">,</span> <span class="n">cart</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端完全不知道显示的是哪个版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Client-side: Completely agnostic to which variant is shown</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CheckoutScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">CheckoutViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">document</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">checkoutDocument</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">document</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">doc</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>            <span class="n">document</span> <span class="p">=</span> <span class="n">doc</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateUpdater</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="k">when</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="s">&quot;placeOrder&quot;</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">placeOrder</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                    <span class="s">&quot;updateQuantity&quot;</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                        <span class="k">val</span> <span class="err">(</span><span class="py">itemId</span><span class="p">,</span> <span class="n">qty</span><span class="p">)</span> <span class="p">=</span> <span class="n">value</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="n">viewModel</span><span class="p">.</span><span class="n">updateQuantity</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span> <span class="n">qty</span><span class="p">.</span><span class="n">toInt</span><span class="p">())</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>结果即时且实时，这意味着无需等待应用商店审核或用户反馈。你甚至可以添加全新的版本，例如“快速结账”，而无需对客户端进行任何更改。实验会持续运行，直到获得统计学意义上的显著性，然后将获胜版本推广到所有用户，同样无需发布新应用。</p>

<h3>实时内容更新</h3>

<p>内容密集型应用常常需要在原生性能和内容新鲜度之间寻求平衡。以新闻应用为例：文章需要丰富的格式、嵌入式媒体和交互元素，但同时也需要随着新闻事件的进展实时更新。</p>

<p>一家报道重大事件的新闻机构需要实时更新文章布局。编辑团队可以根据新闻事件的进展调整布局：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: Editorial team can update layout as story develops</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ArticleLayoutService</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getArticleDocument</span><span class="p">(</span><span class="n">article</span><span class="p">:</span> <span class="n">Article</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">displayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ArticleLayout</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">ArticleLayout</span><span class="p">(</span><span class="n">article</span><span class="p">:</span> <span class="n">Article</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">().</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Breaking news banner - can be added/removed instantly</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">isBreaking</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">BreakingNewsBanner</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">()</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Headline with dynamic styling</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>                <span class="n">text</span> <span class="p">=</span> <span class="n">article</span><span class="p">.</span><span class="n">headline</span><span class="p">,</span>
</span><span class='line'>                <span class="n">style</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">isBreaking</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">HeadlineStyle</span><span class="p">.</span><span class="n">Breaking</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">HeadlineStyle</span><span class="p">.</span><span class="n">Standard</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Live updates indicator</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">article</span><span class="p">.</span><span class="n">hasLiveUpdates</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">LiveUpdatesIndicator</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">lastUpdate</span> <span class="p">=</span> <span class="n">article</span><span class="p">.</span><span class="n">lastUpdate</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">clickable</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;refreshArticle&quot;</span><span class="p">,</span> <span class="n">article</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Rich content blocks - can include any Compose UI</span>
</span><span class='line'>            <span class="n">article</span><span class="p">.</span><span class="n">contentBlocks</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">block</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="k">when</span> <span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">TextBlock</span> <span class="p">-&gt;</span> <span class="n">ArticleText</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">ImageBlock</span> <span class="p">-&gt;</span> <span class="n">ArticleImage</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">VideoBlock</span> <span class="p">-&gt;</span> <span class="n">VideoEmbed</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">LiveBlogBlock</span> <span class="p">-&gt;</span> <span class="n">LiveBlogTimeline</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">InteractiveChartBlock</span> <span class="p">-&gt;</span> <span class="n">DataVisualization</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                    <span class="k">is</span> <span class="n">PullQuoteBlock</span> <span class="p">-&gt;</span> <span class="n">PullQuote</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Related articles - layout can be A/B tested</span>
</span><span class='line'>            <span class="n">RelatedArticles</span><span class="p">(</span>
</span><span class='line'>                <span class="n">articles</span> <span class="p">=</span> <span class="n">article</span><span class="p">.</span><span class="n">relatedArticles</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onArticleClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;openArticle&quot;</span><span class="p">,</span> <span class="n">it</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>客户端只需渲染服务器提供的任何布局：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Client-side: Renders whatever layout the server sends</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ArticleScreen</span><span class="p">(</span><span class="n">articleId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">:</span> <span class="n">ArticleViewModel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">document</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">articleDocument</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">refreshing</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">isRefreshing</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SwipeRefresh</span><span class="p">(</span>
</span><span class='line'>        <span class="n">state</span> <span class="p">=</span> <span class="n">rememberSwipeRefreshState</span><span class="p">(</span><span class="n">refreshing</span><span class="p">),</span>
</span><span class='line'>        <span class="n">onRefresh</span> <span class="p">=</span> <span class="p">{</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">refresh</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">document</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">doc</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>                <span class="n">document</span> <span class="p">=</span> <span class="n">doc</span><span class="p">,</span>
</span><span class='line'>                <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="k">when</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="s">&quot;openArticle&quot;</span> <span class="p">-&gt;</span> <span class="n">navController</span><span class="p">.</span><span class="n">navigate</span><span class="p">(</span><span class="s">&quot;article/$value&quot;</span><span class="p">)</span>
</span><span class='line'>                        <span class="s">&quot;refreshArticle&quot;</span> <span class="p">-&gt;</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">refresh</span><span class="p">()</span>
</span><span class='line'>                        <span class="s">&quot;playVideo&quot;</span> <span class="p">-&gt;</span> <span class="n">videoPlayer</span><span class="p">.</span><span class="n">play</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>你的团队无需修改应用即可更新文章布局，添加实时博客时间线、嵌入交互式图表和更改字体。当新闻事件有进展时，他们可以立即在所有相关文章上添加“突发新闻”横幅。</p>

<h3>避免代码膨胀的功能标志</h3>

<p>传统的功能标志需要将所有变体都包含在二进制文件中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Traditional approach - all code ships, even unused variations</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">when</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">featureFlags</span><span class="p">.</span><span class="n">newHomeV3</span> <span class="p">-&gt;</span> <span class="n">NewHomeLayoutV3</span><span class="p">()</span>  <span class="c1">// Ships always</span>
</span><span class='line'>        <span class="n">featureFlags</span><span class="p">.</span><span class="n">newHomeV2</span> <span class="p">-&gt;</span> <span class="n">NewHomeLayoutV2</span><span class="p">()</span>  <span class="c1">// Ships always</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">OldHomeLayout</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Ships always</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这会带来几个问题。二进制文件会因为包含所有变体而增加应用程序的大小。即使未使用，也会包含无用代码。当功能标志配置错误时，可能会暴露未发布的功能，从而带来安全风险。随着时间的推移，旧的变体不断累积，导致技术债务不断增加。</p>

<p>使用 RemoteCompose，只会传输当前激活的变体：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: Only the active variation exists on the server</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HomeScreenService</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getHomeDocument</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">when</span> <span class="p">(</span><span class="n">featureFlags</span><span class="p">.</span><span class="n">getHomeVariant</span><span class="p">(</span><span class="n">user</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;v3&quot;</span> <span class="p">-&gt;</span> <span class="n">captureHomeV3</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>            <span class="s">&quot;v2&quot;</span> <span class="p">-&gt;</span> <span class="n">captureHomeV2</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">captureHomeDefault</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Client-side: No conditional code, no dead code</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">document</span><span class="p">:</span> <span class="n">CoreDocument</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">RemoteDocumentPlayer</span><span class="p">(</span><span class="n">document</span> <span class="p">=</span> <span class="n">document</span><span class="p">)</span>
</span><span class='line'>    <span class="c1">// That&#39;s it. No feature flags, no conditionals.</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这消除了二进制文件膨胀，因为不会传输旧的变体；由于只存在服务器端代码，因此消除了无用代码；并且由于配置错误只会显示不同的 UI 而不是未发布的代码，因此降低了安全风险。</p>

<p>设想一个社交媒体应用正在逐步重新设计其信息流：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: Complete control over who sees what</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FeedLayoutService</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getFeedDocument</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">posts</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Post</span><span class="p">&gt;):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">variant</span> <span class="p">=</span> <span class="n">rolloutService</span><span class="p">.</span><span class="n">getFeedVariant</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">displayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">variant</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">FeedVariant</span><span class="p">.</span><span class="n">NEW_DESIGN</span> <span class="p">-&gt;</span> <span class="n">NewFeedLayout</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
</span><span class='line'>                <span class="n">FeedVariant</span><span class="p">.</span><span class="n">NEW_DESIGN_COMPACT</span> <span class="p">-&gt;</span> <span class="n">NewFeedCompactLayout</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
</span><span class='line'>                <span class="n">FeedVariant</span><span class="p">.</span><span class="n">CLASSIC</span> <span class="p">-&gt;</span> <span class="n">ClassicFeedLayout</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Rollout service controls the percentage</span>
</span><span class='line'><span class="k">class</span> <span class="nc">RolloutService</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getFeedVariant</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span> <span class="n">FeedVariant</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// 5% get new design, 5% get compact variant, 90% get classic</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">hashCode</span><span class="p">()</span> <span class="p">%</span> <span class="m">100</span> <span class="p">&lt;</span> <span class="m">5</span> <span class="p">-&gt;</span> <span class="n">FeedVariant</span><span class="p">.</span><span class="n">NEW_DESIGN</span>
</span><span class='line'>            <span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">hashCode</span><span class="p">()</span> <span class="p">%</span> <span class="m">100</span> <span class="p">&lt;</span> <span class="m">10</span> <span class="p">-&gt;</span> <span class="n">FeedVariant</span><span class="p">.</span><span class="n">NEW_DESIGN_COMPACT</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">FeedVariant</span><span class="p">.</span><span class="n">CLASSIC</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Instant rollback if issues are detected</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">emergencyRollback</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// All users immediately get classic layout</span>
</span><span class='line'>        <span class="c1">// No app update needed</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果新设计导致问题（例如崩溃、用户互动度下降或用户投诉），可以立即回滚。只需更改服务器配置即可。无需紧急发布应用。</p>

<h3>跨平台一致性</h3>

<p>RemoteCompose 的文档格式与平台无关。同一文档可以在手机、平板电脑、折叠屏设备和 Wear OS 设备上渲染，并由相应的平台播放器负责渲染。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Creation <span class="o">(</span>Server/Backend<span class="o">)</span>
</span><span class='line'>    ↓
</span><span class='line'>RemoteComposeBuffer <span class="o">(</span>Platform-independent binary format<span class="o">)</span>
</span><span class='line'>    ↓
</span><span class='line'>┌─────────────────────────────────────────────────────────┐
</span><span class='line'>│
</span><span class='line'>
</span><span class='line'>│
</span><span class='line'>↓
</span><span class='line'>
</span><span class='line'>↓
</span><span class='line'>
</span><span class='line'>↓
</span><span class='line'>
</span><span class='line'>↓
</span><span class='line'>Android Phone
</span><span class='line'>
</span><span class='line'>Android Tablet
</span><span class='line'>
</span><span class='line'>Foldable Device
</span><span class='line'>
</span><span class='line'>Wear OS
</span><span class='line'><span class="o">(</span>Compose Player<span class="o">)</span> <span class="o">(</span>Compose Player<span class="o">)</span>  <span class="o">(</span>Compose Player<span class="o">)</span>   <span class="o">(</span>Wear Player<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>假设一款健身应用在手机和手表应用上都显示锻炼总结。相同的数据会针对不同的设备尺寸进行优化，呈现不同的内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server-side: Same data, different presentations</span>
</span><span class='line'><span class="k">class</span> <span class="nc">WorkoutSummaryService</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPhoneDocument</span><span class="p">(</span><span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">phoneDisplayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">PhoneWorkoutSummary</span><span class="p">(</span><span class="n">workout</span><span class="p">)</span>  <span class="c1">// Full detailed view</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getWatchDocument</span><span class="p">(</span><span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">watchDisplayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">WatchWorkoutSummary</span><span class="p">(</span><span class="n">workout</span><span class="p">)</span>  <span class="c1">// Glanceable summary</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">PhoneWorkoutSummary</span><span class="p">(</span><span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">WorkoutHeader</span><span class="p">(</span><span class="n">workout</span><span class="p">)</span>
</span><span class='line'>            <span class="n">HeartRateChart</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="n">heartRateData</span><span class="p">)</span>
</span><span class='line'>            <span class="n">PaceChart</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="n">paceData</span><span class="p">)</span>
</span><span class='line'>            <span class="n">SplitsTable</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="n">splits</span><span class="p">)</span>
</span><span class='line'>            <span class="n">MapView</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="n">route</span><span class="p">)</span>
</span><span class='line'>            <span class="n">ShareButton</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;share&quot;</span><span class="p">,</span> <span class="n">workout</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">WatchWorkoutSummary</span><span class="p">(</span><span class="n">workout</span><span class="p">:</span> <span class="n">Workout</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Optimized for small screen</span>
</span><span class='line'>        <span class="n">Column</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="k">type</span><span class="p">,</span> <span class="n">style</span> <span class="p">=</span> <span class="n">WatchTypography</span><span class="p">.</span><span class="n">Title</span><span class="p">)</span>
</span><span class='line'>            <span class="n">Row</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">StatBox</span><span class="p">(</span><span class="s">&quot;Duration&quot;</span><span class="p">,</span> <span class="n">workout</span><span class="p">.</span><span class="n">duration</span><span class="p">)</span>
</span><span class='line'>                <span class="n">StatBox</span><span class="p">(</span><span class="s">&quot;Distance&quot;</span><span class="p">,</span> <span class="n">workout</span><span class="p">.</span><span class="n">distance</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">MiniHeartRateIndicator</span><span class="p">(</span><span class="n">workout</span><span class="p">.</span><span class="n">avgHeartRate</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>两款设备都显示锻炼数据，但布局针对各自的设备尺寸进行了优化。任一布局的更新都会立即生效，无需在任一平台上更新应用。</p>

<h3>缩短发布周期</h3>

<p>最显著的优势在于运营层面：UI 更改不再需要发布应用。考虑一下简单 UI 调整的开发周期。</p>

<p>传统方法大约需要两到四周。第一天和第二天是开发人员实现。第三天和第四天用于代码审查和修改。第五天到第七天用于质量保证测试。第八天和第九天处理发布准备和应用商店提交。第十天到第十四天：等待应用商店审核。第十五天到第三十天用户逐步采用，通常两周内会有 50% 到 70% 的用户更新。大多数用户在两到四周内不会看到变化。</p>

<p>RemoteCompose 方法只需一到两天即可完成。第一天和第二天是开发人员在服务器端实现。部署只需几分钟。所有用户都能立即看到变化。</p>

<p>这种速度优势对于节假日促销活动至关重要，你可以根据需要在当天部署季节性主题；对于服务中断的紧急消息，你可以即时更新 UI；对于快速迭代，你可以快速测试想法并快速失败；对于竞争响应，你可以以小时而不是几周的时间对市场变化做出反应。</p>

<p>以一个准备迎接黑色星期五的电商应用为例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Traditional approach: Ship all variations weeks in advance</span>
</span><span class='line'><span class="c1">// Problem: All promotional code ships weeks early</span>
</span><span class='line'><span class="c1">// Risk: Date logic bugs could show promotions early</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">today</span> <span class="p">=</span> <span class="n">LocalDate</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
</span><span class='line'>    <span class="k">when</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">today</span> <span class="p">==</span> <span class="n">BlackFriday</span> <span class="p">-&gt;</span> <span class="n">BlackFridayHome</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Must ship by Oct 15</span>
</span><span class='line'>        <span class="n">today</span> <span class="k">in</span> <span class="n">BlackFridayWeek</span> <span class="p">-&gt;</span> <span class="n">BlackFridayWeekHome</span><span class="p">()</span>   <span class="c1">// Must ship by Oct 15</span>
</span><span class='line'>        <span class="n">today</span> <span class="p">==</span> <span class="n">CyberMonday</span> <span class="p">-&gt;</span> <span class="n">CyberMondayHome</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Must ship by Oct 15</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">RegularHome</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Remote approach: Deploy each promotion on the exact day</span>
</span><span class='line'><span class="c1">// Benefit: Each promotion deploys on the exact minute needed</span>
</span><span class='line'><span class="c1">// Flexibility: Can react to competitor moves in real-time</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HomeScreenService</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getHomeDocument</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">):</span> <span class="n">ByteArray</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">promotion</span> <span class="p">=</span> <span class="n">promotionService</span><span class="p">.</span><span class="n">getCurrentPromotion</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">captureRemoteDocument</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">displayInfo</span><span class="p">,</span> <span class="n">profile</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">promotion</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">BlackFridayPromotion</span> <span class="p">-&gt;</span> <span class="n">BlackFridayHome</span><span class="p">(</span><span class="n">promotion</span><span class="p">)</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">CyberMondayPromotion</span> <span class="p">-&gt;</span> <span class="n">CyberMondayHome</span><span class="p">(</span><span class="n">promotion</span><span class="p">)</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">FlashSale</span> <span class="p">-&gt;</span> <span class="n">FlashSaleHome</span><span class="p">(</span><span class="n">promotion</span><span class="p">)</span>  <span class="c1">// Can add new types anytime</span>
</span><span class='line'>                <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">RegularHome</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>状态管理：超越静态布局</h3>

<p>RemoteCompose 不仅限于静态布局。该框架包含一个状态管理系统，可以实现交互式、动态的 UI。</p>

<p><strong>远程状态变量</strong></p>

<p>状态可以嵌入文档中，并由客户端更新。这使得表单、计数器、切换开关和其他交互元素成为可能：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Creation side: Define interactive widget</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">QuantitySelector</span><span class="p">(</span><span class="n">initialQuantity</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">quantity</span> <span class="k">by</span> <span class="n">rememberRemoteState</span><span class="p">(</span><span class="s">&quot;quantity&quot;</span><span class="p">,</span> <span class="n">initialQuantity</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">fillMaxWidth</span><span class="p">(),</span>
</span><span class='line'>        <span class="n">horizontalArrangement</span> <span class="p">=</span> <span class="n">Arrangement</span><span class="p">.</span><span class="n">SpaceBetween</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">quantity</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">quantity</span><span class="p">--</span>
</span><span class='line'>                    <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;quantityChanged&quot;</span><span class="p">,</span> <span class="n">quantity</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Minus</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">quantity</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">style</span> <span class="p">=</span> <span class="n">MaterialTheme</span><span class="p">.</span><span class="n">typography</span><span class="p">.</span><span class="n">headlineMedium</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">quantity</span><span class="p">++</span>
</span><span class='line'>                <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;quantityChanged&quot;</span><span class="p">,</span> <span class="n">quantity</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Plus</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>播放器端通过操作回调处理状态更新：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Player side: Handle state updates</span>
</span><span class='line'><span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">document</span> <span class="p">=</span> <span class="n">document</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateUpdater</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;quantityChanged&quot;</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Update cart</span>
</span><span class='line'>                <span class="n">cartManager</span><span class="p">.</span><span class="n">setQuantity</span><span class="p">(</span><span class="n">itemId</span><span class="p">,</span> <span class="n">value</span><span class="p">.</span><span class="n">toInt</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// Optionally update remote state directly</span>
</span><span class='line'>                <span class="n">stateUpdater</span><span class="p">.</span><span class="n">updateState</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">state</span><span class="p">[</span><span class="s">&quot;quantity&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">RcInt</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">toInt</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>动画时间跟踪</strong></p>

<p>播放器跟踪动画时间并将其传递给文档，从而无需任何客户端动画代码即可实现基于时间的动画：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Server side: Define animated elements</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PulsingNotificationBadge</span><span class="p">(</span><span class="n">count</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Scale pulses between 0.9 and 1.1 over 1 second</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">scale</span> <span class="p">=</span> <span class="n">FloatExpression</span><span class="p">(</span><span class="s">&quot;0.9 + 0.2 * sin(time * 6.28)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Opacity pulses between 0.7 and 1.0</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">opacity</span> <span class="p">=</span> <span class="n">FloatExpression</span><span class="p">(</span><span class="s">&quot;0.7 + 0.3 * sin(time * 6.28)&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">scale</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">alpha</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Red</span><span class="p">,</span> <span class="n">CircleShape</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">24.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Text</span><span class="p">(</span>
</span><span class='line'>            <span class="n">text</span> <span class="p">=</span> <span class="n">count</span><span class="p">.</span><span class="n">toString</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">RemoteModifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The player automatically:</span>
</span><span class='line'><span class="c1">// 1. Tracks elapsed time since document load</span>
</span><span class='line'><span class="c1">// 2. Evaluates expressions each frame</span>
</span><span class='line'><span class="c1">// 3. Updates visual properties</span>
</span><span class='line'><span class="c1">// No client animation code needed</span>
</span></code></pre></td></tr></table></div></figure>


<p>这使得完全在文档格式中定义的流畅、高性能动画成为可能。表达式支持诸如 <code>sin</code>、<code>cos</code>、<code>lerp</code> 和 <code>clamp</code> 之类的数学函数，以及算术运算符和变量引用。</p>

<p><strong>双向通信</strong></p>

<p>操作系统支持文档与宿主应用之间的双向通信：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Document triggers actions for various purposes</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductDetailPage</span><span class="p">(</span><span class="n">product</span><span class="p">:</span> <span class="n">Product</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Column</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Analytics tracking</span>
</span><span class='line'>        <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;analytics&quot;</span><span class="p">,</span> <span class="s">&quot;product_viewed:${product.id}&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ProductImage</span><span class="p">(</span><span class="n">product</span><span class="p">.</span><span class="n">imageUrl</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Navigation action</span>
</span><span class='line'>        <span class="n">TextButton</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;navigate&quot;</span><span class="p">,</span> <span class="s">&quot;/reviews/${product.id}&quot;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;See all reviews&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Cart action with data</span>
</span><span class='line'>        <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;addToCart&quot;</span><span class="p">,</span> <span class="n">product</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Add to Cart&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// State update action</span>
</span><span class='line'>        <span class="k">var</span> <span class="py">isFavorite</span> <span class="k">by</span> <span class="n">rememberRemoteState</span><span class="p">(</span><span class="s">&quot;favorite&quot;</span><span class="p">,</span> <span class="n">product</span><span class="p">.</span><span class="n">isFavorite</span><span class="p">)</span>
</span><span class='line'>        <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">isFavorite</span> <span class="p">=</span> <span class="p">!</span><span class="n">isFavorite</span>
</span><span class='line'>                <span class="n">namedAction</span><span class="p">(</span><span class="s">&quot;toggleFavorite&quot;</span><span class="p">,</span> <span class="s">&quot;${product.id}:$isFavorite&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Icon</span><span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="n">isFavorite</span><span class="p">)</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Filled</span><span class="p">.</span><span class="n">Favorite</span> <span class="k">else</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Outlined</span><span class="p">.</span><span class="n">Favorite</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>宿主应用统一处理所有操作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Host app handles all actions uniformly</span>
</span><span class='line'><span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">document</span> <span class="p">=</span> <span class="n">document</span><span class="p">,</span>
</span><span class='line'>    <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateUpdater</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;analytics&quot;</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="err">(</span><span class="py">event</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span> <span class="p">=</span> <span class="n">value</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">analytics</span><span class="p">.</span><span class="n">logEvent</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">mapOf</span><span class="p">(</span><span class="s">&quot;productId&quot;</span> <span class="n">to</span> <span class="n">id</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="s">&quot;navigate&quot;</span> <span class="p">-&gt;</span> <span class="n">navController</span><span class="p">.</span><span class="n">navigate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>            <span class="s">&quot;addToCart&quot;</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cartManager</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>                <span class="c1">// Update UI to show confirmation</span>
</span><span class='line'>                <span class="n">stateUpdater</span><span class="p">.</span><span class="n">updateState</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">state</span><span class="p">[</span><span class="s">&quot;cartCount&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">RcInt</span><span class="p">((</span><span class="n">state</span><span class="p">[</span><span class="s">&quot;cartCount&quot;</span><span class="p">]</span> <span class="k">as</span><span class="p">?</span> <span class="n">RcInt</span><span class="p">)</span><span class="o">?.</span><span class="n">value</span><span class="o">?.</span><span class="n">plus</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="o">?:</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="s">&quot;toggleFavorite&quot;</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="err">(</span><span class="py">id</span><span class="p">,</span> <span class="n">isFavorite</span><span class="p">)</span> <span class="p">=</span> <span class="n">value</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="n">favoritesManager</span><span class="p">.</span><span class="n">setFavorite</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">isFavorite</span><span class="p">.</span><span class="n">toBoolean</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种双向通信意味着远程文档可以完全集成到你应用的导航、分析、状态管理和业务逻辑中，而文档本身无需了解你的具体实现。</p>

<h3><strong>实际应用架构模式</strong></h3>

<p>让我们来探讨一下 RemoteCompose 如何融入实际应用架构。</p>

<p><strong>模式 1：混合架构（推荐）</strong></p>

<p>大多数应用都能从混合架构中获益：关键页面使用本地 Compose 代码构建，而动态内容区域则使用 RemoteCompose。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Navigation: Local Compose (fast, reliable)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AppNavigation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NavHost</span><span class="p">(</span><span class="n">navController</span><span class="p">,</span> <span class="n">startDestination</span> <span class="p">=</span> <span class="s">&quot;home&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">HomeScreen</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;product/{id}&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">ProductScreen</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">arguments</span><span class="o">?.</span><span class="n">getString</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">))</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;cart&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">CartScreen</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">composable</span><span class="p">(</span><span class="s">&quot;checkout&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">CheckoutScreen</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Home screen: Remote (marketing can update freely)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">HomeScreen</span><span class="p">(</span><span class="n">viewModel</span><span class="p">:</span> <span class="n">HomeViewModel</span> <span class="p">=</span> <span class="n">hiltViewModel</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">document</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">homeDocument</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">when</span> <span class="p">(</span><span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">document</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">LoadingIndicator</span><span class="p">()</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>            <span class="n">document</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">document</span><span class="p">,</span>
</span><span class='line'>            <span class="n">onNamedAction</span> <span class="p">=</span> <span class="p">{</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span> <span class="n">handleAction</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="k">is</span> <span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">LocalFallbackHome</span><span class="p">()</span>  <span class="c1">// Graceful degradation</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Product screen: Hybrid (shell is local, content is remote)</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">ProductScreen</span><span class="p">(</span><span class="n">productId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">viewModel</span><span class="p">:</span> <span class="n">ProductViewModel</span> <span class="p">=</span> <span class="n">hiltViewModel</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">product</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">product</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">contentDocument</span> <span class="k">by</span> <span class="n">viewModel</span><span class="p">.</span><span class="n">contentDocument</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Scaffold</span><span class="p">(</span>
</span><span class='line'>        <span class="n">topBar</span> <span class="p">=</span> <span class="p">{</span> <span class="n">ProductTopBar</span><span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">},</span>  <span class="c1">// Local: consistent navigation</span>
</span><span class='line'>        <span class="n">bottomBar</span> <span class="p">=</span> <span class="p">{</span> <span class="n">AddToCartBar</span><span class="p">(</span><span class="n">product</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// Local: critical purchase flow</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span> <span class="n">padding</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// Remote: Rich product content, can be A/B tested</span>
</span><span class='line'>        <span class="n">contentDocument</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">doc</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">RemoteDocumentPlayer</span><span class="p">(</span>
</span><span class='line'>                <span class="n">document</span> <span class="p">=</span> <span class="n">doc</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>模式 2：文档缓存以实现离线支持</strong></p>

<p>远程文档可以缓存以供离线访问：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DocumentRepository</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">api</span><span class="p">:</span> <span class="n">DocumentApi</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">cache</span><span class="p">:</span> <span class="n">DocumentCache</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">connectivity</span><span class="p">:</span> <span class="n">ConnectivityManager</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getDocument</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">CoreDocument</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Try cache first</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">cached</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// Return cached immediately, refresh in background</span>
</span><span class='line'>            <span class="n">refreshInBackground</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">cached</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// No cache, must fetch</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">connectivity</span><span class="p">.</span><span class="n">isConnected</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">fetchAndCache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">OfflineException</span><span class="p">(</span><span class="s">&quot;No cached document and no connectivity&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">fetchAndCache</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">CoreDocument</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">bytes</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">fetchDocument</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">document</span> <span class="p">=</span> <span class="n">RemoteComposeBuffer</span><span class="p">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">ttl</span> <span class="p">=</span> <span class="m">1.</span><span class="n">hours</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">document</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">refreshInBackground</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">scope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">fetchAndCache</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Silent failure, cached version is still valid</span>
</span><span class='line'>                <span class="n">Log</span><span class="p">.</span><span class="n">w</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">&quot;Background refresh failed&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>模式 3：文档预加载以实现流畅导航</strong></p>

<p>预加载用户可能访问的页面的文档：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DocumentPreloader</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">DocumentRepository</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Preload when user enters a screen</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">preloadForScreen</span><span class="p">(</span><span class="n">screen</span><span class="p">:</span> <span class="n">Screen</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">keysToPreload</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">screen</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">HomeScreen</span> <span class="p">-&gt;</span> <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;featured&quot;</span><span class="p">,</span> <span class="s">&quot;categories&quot;</span><span class="p">,</span> <span class="s">&quot;promotions&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">CategoryScreen</span> <span class="p">-&gt;</span> <span class="n">screen</span><span class="p">.</span><span class="n">subcategories</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="s">&quot;category_${it.id}&quot;</span> <span class="p">}</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ProductScreen</span> <span class="p">-&gt;</span> <span class="n">listOf</span><span class="p">(</span><span class="s">&quot;reviews_${screen.productId}&quot;</span><span class="p">,</span> <span class="s">&quot;related_${screen.productId}&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">emptyList</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">keysToPreload</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">key</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">scope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">repository</span><span class="p">.</span><span class="n">getDocument</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1">// Caches for later</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Preload failure is not critical</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Usage in navigation</span>
</span><span class='line'><span class="n">navController</span><span class="p">.</span><span class="n">addOnDestinationChangedListener</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">arguments</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">preloader</span><span class="p">.</span><span class="n">preloadForScreen</span><span class="p">(</span><span class="n">destination</span><span class="p">.</span><span class="n">toScreen</span><span class="p">(</span><span class="n">arguments</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><strong>结论</strong></h3>

<p>RemoteCompose 代表了我们对 Android UI 开发思维方式的一次范式转变。通过将 Compose 布局转换为可移植文档格式，RemoteCompose 实现了服务器驱动的 UI、即时 A/B 测试、实时内容更新和跨平台一致性，同时保持了原生渲染性能。</p>

<p>该框架拥有包含 93 种以上操作的全面操作模型，充分展现了 Compose 的表达能力，包括动画、状态和交互。创建和播放的分离使得部署架构更加灵活：在后端生成具有完整 Compose 表达能力的文档，通过现有基础架构分发，并在任何 Android 设备上进行原生渲染。</p>

<p>关键在于找到合适的平衡点：对于动态、频繁变化的内容区域，使用 RemoteCompose；同时将关键流程保留在本地 Compose 代码中。这种混合方法在需要灵活性的地方提供服务器驱动 UI 的优势，在需要可靠性的地方提供编译代码的优势。</p>

<p>无论你是构建需要频繁更新布局的内容密集型应用、需要快速 A/B 测试的电子商务平台，还是需要快速迭代的企业级工具，RemoteCompose 都能为真正动态的 UI 提供架构基础。该框架处理了序列化、传输和渲染的复杂性，因此你可以专注于设计卓越的用户体验。</p>

<p>你可以观看他们最近关于<a href="https://speakerdeck.com/camaelon/introducing-remotecompose-break-your-ui-out-of-the-app-sandbox">RemoteCompose 简介：将你的 UI 从应用程序沙盒中解放出来</a>的演讲。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[深入理解withContext和launch的真正区别]]></title>
    <link href="https://alexhilton.github.io/blog/2025/12/05/real-diff-between-withcontext-and-launch/"/>
    <updated>2025-12-05T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/12/05/real-diff-between-withcontext-and-launch</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「The Real Difference Between withContext(Dispatchers.IO) and launch(Dispatchers.IO)」，原文链接<a href="https://proandroiddev.com/the-real-difference-between-withcontext-dispatchers-io-and-launch-dispatchers-io-b70ec00a33f2">https://proandroiddev.com/the-real-difference-between-withcontext-dispatchers-io-and-launch-dispatchers-io-b70ec00a33f2</a>，由
Anatolii Frolov发布于2025年11月20日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/12/05/real-diff-between-withcontext-and-launch/"><img src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nHuLhSAjZIEbeLHiFdMeSA.png" title="auto auto" ></a></p>

<!-- more -->


<p>在使用 Kotlin 协程时，很容易遇到两种看起来几乎相同的模式。它们都使用了 <code>Dispatchers.IO</code>。它们都将工作移出主线程。它们都出现在不同团队编写的仓库、服务层和 ViewModel 代码中。</p>

<p>但相似之处仅限于表面。它们的行为截然不同——这种差异会影响实际 Android 项目中的顺序、正确性，甚至线程安全。当后台操作影响 UI 状态或共享数据时，这一点尤为重要。</p>

<p>这种困惑不难理解。它们的语法几乎相同，并且都在同一个调度器上运行。但一个会暂停直到工作完成，而另一个会启动并行工作并立即返回。这创建了不同的执行路径，很容易被忽略。</p>

<p>本文解释了 <code>withContext(Dispatchers.IO)</code> 和 <code>launch(Dispatchers.IO)</code> 之间的真正区别，通过实际代码展示了它们的行为差异，并重点介绍了这种差异在生产环境 Android 应用中的重要性。</p>

<h2>看似相同的代码行为却截然不同</h2>

<p>以下两段代码看起来几乎一样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// work</span>
</span><span class='line'><span class="p">}</span><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// work</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>它们运行在同一个调度器上。它们都将工作转移到后台线程。但它们的行为<strong>并不</strong>相同。</p>

<p>以下是并排运行它们的结果：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Start&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">100</span><span class="p">)</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;Inside launch&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="s">&quot;Inside withContext&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;End&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Start
</span><span class='line'>Inside withContext
</span><span class='line'>End
</span><span class='line'>Inside launch
</span></code></pre></td></tr></table></div></figure>


<p>这展示了关键区别。</p>

<p><code>withContext</code> 会等待其工作完成才会继续执行。</p>

<p><code>launch</code> 则完全不等待——它并行运行，并在稍后完成。</p>

<h2>为什么会发生这种情况</h2>

<p><code>withContext</code> 是一个挂起函数。这意味着当前协程会在该行暂停，切换到 <code>Dispatchers.IO</code>，执行代码块，然后从中断的地方继续执行。这里的关键词是<strong>等待</strong>。在该行之后的任何代码都会等待代码块执行完毕。</p>

<p><code>launch</code> 会创建一个新的协程并立即返回。当前协程会立即继续执行，而新创建的代码块会独立执行。这是一种“触发并继续”模式。除非你显式地对新创建的协程调用 <code>join()</code>，否则不会有等待。</p>

<p>这不是一个 bug，而是协程构建器的设计决策。</p>

<p><code>withContext</code> 确保单个协程内部的执行顺序。</p>

<p><code>launch</code> 的设计本身就引入了并发性。</p>

<p>这种视觉上的相似性掩盖了行为上的差异。前者保持代码的可预测顺序，而后者引入了并行工作，这些工作可能会根据调度和负载情况随时完成。</p>

<h2>这种差异在实际项目中的重要性</h2>

<p>在许多 Android 场景中，任务完成的确切时间至关重要。哪怕是顺序上的细微差别，都可能导致一些难以察觉的 bug，直到生产环境才会被发现。</p>

<h3>1. 后台任务完成后更新 UI</h3>

<p>在 ViewModel 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userRepository</span><span class="p">.</span><span class="n">loadUser</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出（概念图）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>User loaded first
</span><span class='line'>UI updated second
</span></code></pre></td></tr></table></div></figure>


<p>由于 <code>withContext</code> 会等待，因此 UI 只有在加载完成后才会更新。</p>

<p>但如果将其替换为 <code>launch(Dispatchers.IO)</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">result</span><span class="p">:</span> <span class="n">User</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">result</span> <span class="p">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="n">loadUser</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">_state</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">result</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出（概念图）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>UI updated first
</span><span class='line'>User loaded later
</span></code></pre></td></tr></table></div></figure>


<p>这里，UI 在后台任务完成之前就更新了。语法上的视觉相似性掩盖了执行顺序的不同。</p>

<h3>2.协调多步骤后台操作</h3>

<p>在自定义仓库代码中，你可能需要操作严格按照顺序执行。例如，先保存数据，然后写入日志：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">fileWriter</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">logWriter</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Saved&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>suspend</code> 保证了操作顺序。日志写入必须在保存完成后才能进行。</p>

<p>但使用 <code>launch</code> 则：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">fileWriter</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">logWriter</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Saved&quot;</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这两个操作可以以任意顺序执行。在负载较高的情况下，日志写入可能早于保存操作。这听起来似乎无关紧要，但一旦调试或审计变得困难，就会造成问题。</p>

<h3>3. 访问共享状态</h3>

<p>使用 <code>withContext</code> 进行顺序执行在更新共享对象时更安全：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">cache</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用 <code>launch</code>，两个更新操作可以同时运行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">cache</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">item1</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">cache</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">item2</span><span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>除非缓存本身是线程安全的，否则并行写入可能会导致竞态条件。</p>

<h2>为什么这种差异容易被忽略</h2>

<p>主要原因是语法。两者都使用相同的括号。两者都显示 <code>Dispatchers.IO</code>。两者都将代码包裹在代码块中。人们的注意力会集中在调度器上，而不是协程构建器上。</p>

<p>另一个原因是许多现代库已经在内部处理线程。Room DAO 方法和 Retrofit 的挂起函数不需要 <code>withContext(Dispatchers.IO)</code>。由于这些库减少了手动切换调度器，开发者看到的协程构建器之间的明显差异较少。</p>

<p>这可能会造成一种错觉，即所有调度器的用法都可以互换，但对于自定义操作来说并非如此。</p>

<h2>与 async/await 的深入比较</h2>

<p>为了进一步突出差异，请比较以下三个示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">deferred</span> <span class="p">=</span> <span class="n">async</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span><span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">deferred</span><span class="p">.</span><span class="n">await</span><span class="p">()</span>
</span><span class='line'><span class="n">println</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>输出（概念图）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>loadData completes
</span><span class='line'>result printed
</span></code></pre></td></tr></table></div></figure>


<p><code>async</code> 的行为类似于 <code>launch</code>，但返回 <code>Deferred</code>。</p>

<p><code>await()</code> 会将其转换为顺序行为——就像 <code>withContext</code> 一样。</p>

<p>关键点：<strong>顺序行为仅在显式等待时发生。</strong></p>

<h2>异常处理行为</h2>

<p><code>withContext</code> 直接在调用协程中抛出异常。它们不会被延迟或存储。</p>

<p><code>launch</code> 将异常报告给其父作用域。如果该作用域有 supervisor 或自定义异常处理程序，则效果不同。异常不会立即中断调用者的执行路径。</p>

<p>这意味着：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Boom&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">println</span><span class="p">(</span><span class="s">&quot;Next&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>崩溃会在“Next”执行之前停止协程。</p>

<p>但使用 <code>launch</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">launch</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span> <span class="n">error</span><span class="p">(</span><span class="s">&quot;Boom&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="n">println</span><span class="p">(</span><span class="s">&quot;Next&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>“Next”仍然会打印。启动的协程会自行崩溃。</p>

<h2>需要记住的内容</h2>

<ul>
<li><p><code>withContext</code> <strong>等待</strong>代码块执行完毕后才会继续执行。</p></li>
<li><p><code>launch</code> 会启动<strong>并行</strong>工作并立即返回。</p></li>
<li><p>当<strong>结果或顺序</strong>至关重要时，请使用 <code>withContext</code>。</p></li>
<li><p>当你需要<strong>并发工作</strong>且无需阻塞调用者时，请使用 <code>launch</code>。</p></li>
<li><p>视觉上的相似性掩盖了行为上的差异——协程构建器定义了语义，而不是调度器。</p></li>
</ul>


<h2>总结</h2>

<p><code>withContext(Dispatchers.IO)</code> 和 <code>launch(Dispatchers.IO)</code> 看起来相似，但行为却不同。前者会暂停并确保顺序执行，而后者会创建并发并立即继续执行。当工作顺序、共享状态、UI 更新或异常处理依赖于工作完成时间时，这种差异至关重要。</p>

<p>理解这种区别可以使协程代码更易于预测，并避免那些只有在实际应用中才会显现的细微错误。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Jetpack Compose中的阴影艺术]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose/"/>
    <updated>2025-11-24T00:00:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「The Art of Shadows in Jetpack Compose」，原文链接<a href="https://medium.com/proandroiddev/the-art-of-shadows-in-jetpack-compose-63a75070882f">https://medium.com/proandroiddev/the-art-of-shadows-in-jetpack-compose-63a75070882f</a>，由Stefano Natali发布于2025年10月4日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/24/the-art-of-shadows-in-jetpack-compose/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*UjyqMyVg002OIDJ1Hdee8Q.png" title="auto auto" ></a></p>

<!-- more -->


<p>UI 中的阴影发挥着至关重要的作用：它们在视觉上<strong>提升</strong>元素，指示着<strong>交互性</strong>，并提供用户操作的即时<strong>反馈</strong>。多年来，我们一直依赖于<strong>高度</strong>属性，但 Jetpack Compose 现在提供了一套强大的工具，可以对<strong>阴影渲染</strong>进行精细控制。</p>

<p>Google 最近新增了一个<a href="https://developer.android.com/develop/ui/compose/graphics/draw/shadows">文档页面</a>，其中包含一系列有趣的用例。本文将探索 Compose 中的主要阴影修改器，并深入讲解创建渐变和炫酷特效等高级技巧，从而提升应用的风格。</p>

<p>本文讨论的所有技巧的完整代码示例都可以在我的 GitHub 仓库 <a href="https://github.com/stefanoq21/ComposePlayground"><strong>Compose Playground</strong></a> 中找到。</p>

<h2>阴影修改器（Shadow Modifiers）</h2>

<p>添加阴影最简单但自定义程度最低的方法是使用 <strong>Modifier.shadow()</strong>。与以往一样，它的行为依赖于<strong>基于高度的阴影</strong>，模拟来自上方的光源，阴影深度直接取决于你提供的高度值。其主要限制在于阴影始终被裁剪到可合成对象的形状内，并且你无法自定义扩展、颜色色调或偏移等属性。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">Box</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Modifier</span>
</span><span class='line'>        <span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="m">100.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">shadow</span><span class="p">(</span>
</span><span class='line'>            <span class="n">elevation</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">shape</span> <span class="p">=</span> <span class="n">RectangleShape</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:704/1*7Nkm6z8Ls4FyvDqCcKToDw.png" alt="" /></p>

<p>让我们从一些新功能开始，这些功能赋予我们更强大的力量。使用 <strong>dropShadow()</strong>，我们可以在内容后面创建自定义阴影。这个修饰符是创建复杂阴影的关键，它允许对内容后面的阴影进行精细控制，使元素看起来像是被抬升了一样。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>            <span class="n">radius</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">spread</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>            <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>            <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>              <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:990/1*kENF6x3L985dO65DSY0Zng.png" alt="" /></p>

<p>它使用 <strong>Shadow</strong> 参数，可以精确控制视觉效果。这个参数允许你使用几个关键属性来塑造阴影。 <strong>半径</strong> 决定了边缘的柔和度和扩散（模糊）程度。<strong>扩散</strong> 值控制阴影几何形状相对于可组合元素大小的扩展或收缩。最后，<strong>偏移</strong> 沿 <strong>X 轴和 Y 轴</strong>定位阴影，从而确定光源的视觉方向。结合阴影的<strong>颜色</strong>，这些属性可以实现完全自定义。</p>

<p>💡 <strong>顺序很重要：</strong>在修改器链中，<strong>dropShadow()</strong> 修改器必须出现在 <strong>background()</strong> 修改器<strong>之前</strong>，因为阴影先绘制，背景绘制在其上方。</p>

<p><strong>innerShadow()</strong> 修改器是 <strong>dropShadow()</strong> 的逆操作，它在可组合元素边界的<strong>内部</strong>创建阴影，从而实现元素凹陷或压入表面的视觉效果。与它的对应项一样，它也使用可自定义的<strong>Shadow</strong>对象，允许你使用<strong>半径</strong>、<strong>颜色</strong>、<strong>偏移</strong>和<strong>扩散</strong>来微调效果。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">innerShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">20.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">2.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">0.3f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1108/1*a7KFFaTXCk4KC-sm9AYUoQ.png" alt="" /></p>

<p>💡<strong>再次强调，顺序很重要：</strong><strong>innerShadow()</strong>修改器<strong>必须</strong>放在<strong>background()</strong>修改器<strong>之后</strong>。如果将其放在背景之前，内容将绘制在阴影之上，完全遮盖阴影。</p>

<p>这些修改器的真正强大之处在于它们的自定义和组合。通过叠加<strong>innerShadow()</strong>和<strong>dropShadow()</strong>，你可以创建复杂而逼真的视觉效果。我们来看一些高级用例。</p>

<h2>高级技巧：组合和自定义阴影</h2>

<h3>自定义阴影</h3>

<p>当你在 <strong>dropShadow()</strong> 函数中将 <strong>Brush</strong> 对象而非纯色传递给 <strong>Shadow</strong> 对象时，自定义的强大功能便显而易见。此功能允许你使用 <strong>Brush.sweepGradient</strong> 创建渐变效果。此外，无论你使用标准形状还是完全自定义的几何体，阴影始终会贴合可组合对象的形状。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialShapes</span><span class="p">.</span><span class="n">Cookie12Sided</span><span class="p">.</span><span class="n">toShape</span><span class="p">(),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">6.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">sweepGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="n">listOf</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Blue</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Yellow</span><span class="p">,</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">)</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="m">2.</span><span class="n">dp</span><span class="p">,</span> <span class="m">2.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'><span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">MaterialShapes</span><span class="p">.</span><span class="n">Cookie12Sided</span><span class="p">.</span><span class="n">toShape</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1122/1*a8xMvXOb3hS6icdGU0p1gg.png" alt="" /></p>

<h3>新粗犷主义阴影</h3>

<p>这种风格完美地展现了 <strong>dropShadow()</strong> 修改器在实现极致高对比度效果方面的强大功能。要实现新粗犷主义（Neobrutalism）那种粗犷、棱角分明的视觉效果，你必须使用 <code>dropShadow()</code> 函数，并设置模糊度为零，偏移量要明显，通常还要配合粗边框。具体来说，你需要同时设置 <code>radius = 0.dp</code> 和 <code>spread = 0.dp</code> 来消除扩散，然后应用鲜艳的色彩，并设置一个明显的偏移量，从而创建出标志性的锐利轮廓。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>     <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>     <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>        <span class="n">radius</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">spread</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>        <span class="n">color</span> <span class="p">=</span> <span class="n">dropShadowColor</span><span class="p">,</span>
</span><span class='line'>        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="m">8.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">border</span><span class="p">(</span>
</span><span class='line'>    <span class="m">8.</span><span class="n">dp</span><span class="p">,</span> <span class="n">borderColor</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'> <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">White</span><span class="p">,</span>
</span><span class='line'>    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*bdPpm0XYPfTXMuoNrVQuZw.png" alt="" /></p>

<h3>具有动效的阴影</h3>

<p>阴影并非只是静态的；它们可以制作成动画，从而提供即时的用户反馈。我们将要探索的最后一个高级技巧是创建交互式阴影，使其在特定操作（例如点击或按下）时平滑过渡。这项技术对于模拟物理交互至关重要，它能直观地确认元素的抬升或状态发生了变化。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'> <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">interactionSource</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableInteractionSource</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isPressed</span> <span class="k">by</span> <span class="n">interactionSource</span><span class="p">.</span><span class="n">collectIsPressedAsState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Create transition with pressed state</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">transition</span> <span class="p">=</span> <span class="n">updateTransition</span><span class="p">(</span>
</span><span class='line'>            <span class="n">targetState</span> <span class="p">=</span> <span class="n">isPressed</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;button_press_transition&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">=</span> <span class="n">tween</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>            <span class="n">durationMillis</span> <span class="p">=</span> <span class="m">400</span><span class="p">,</span> <span class="n">easing</span> <span class="p">=</span> <span class="n">Ease</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Animate all properties using the transition</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">shadowAlpha</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateFloat</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;shadow_alpha&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">)</span> <span class="m">0f</span> <span class="k">else</span> <span class="m">1f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//to animate the color</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">colorDropShadow</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateColor</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;shadow_color&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">pressed</span><span class="p">)</span> <span class="n">Color</span><span class="p">.</span><span class="n">Transparent</span> <span class="k">else</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">innerShadowAlpha</span> <span class="k">by</span> <span class="n">transition</span><span class="p">.</span><span class="n">animateFloat</span><span class="p">(</span>
</span><span class='line'>            <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;inner_shadow_alpha&quot;</span><span class="p">,</span> <span class="n">transitionSpec</span> <span class="p">=</span> <span class="p">{</span> <span class="n">buttonPressAnimation</span><span class="p">()</span> <span class="p">})</span> <span class="p">{</span> <span class="n">pressed</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">pressed</span><span class="p">)</span> <span class="m">0f</span> <span class="k">else</span> <span class="m">1f</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">clickable</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">interactionSource</span><span class="p">,</span> <span class="n">indication</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">//...</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">300.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">height</span><span class="p">(</span><span class="m">200.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">Center</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">dropShadow</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">radius</span> <span class="p">=</span> <span class="m">10.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">spread</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">)),</span>
</span><span class='line'>                        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.</span><span class="n">dp</span><span class="p">),</span>
</span><span class='line'>                        <span class="n">alpha</span> <span class="p">=</span> <span class="n">shadowAlpha</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="c1">// note that the background needs to be defined before defining the inner shadow</span>
</span><span class='line'>                <span class="p">.</span><span class="n">background</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">(</span><span class="m">0</span><span class="n">xFFFFFFFF</span><span class="p">),</span> <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">innerShadow</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">shape</span> <span class="p">=</span> <span class="n">RoundedCornerShape</span><span class="p">(</span><span class="m">70.</span><span class="n">dp</span><span class="p">),</span> <span class="n">shadow</span> <span class="p">=</span> <span class="n">Shadow</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">radius</span> <span class="p">=</span> <span class="m">8.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">spread</span> <span class="p">=</span> <span class="m">4.</span><span class="n">dp</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">color</span> <span class="p">=</span> <span class="n">Color</span><span class="p">.</span><span class="n">Green</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.5f</span><span class="p">)),</span>
</span><span class='line'>                        <span class="n">alpha</span> <span class="p">=</span> <span class="n">innerShadowAlpha</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">offset</span> <span class="p">=</span> <span class="n">DpOffset</span><span class="p">(</span><span class="n">x</span> <span class="p">=</span> <span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//...</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*idzAQ4lII7JweFZdCyfNqg.gif" alt="" /></p>

<p>好的，我们已经了解了如何使用 <strong>updateTransition</strong> API 来创建流畅的交互反馈。它首先使用 <strong>MutableInteractionSource</strong> 跟踪按下状态。该状态会驱动一个 <strong>400 毫秒的过渡动画</strong>，同时为两个方向相反的阴影添加动画效果。外部的 <strong>dropShadow</strong> 在按下时会淡出，而内部的 <strong>innerShadow</strong> 则会淡入。这种双阴影动画使组件从 <strong>抬升</strong> 状态平滑过渡到 <strong>凹陷</strong> 状态，从而在用户交互时提供清晰且动态的反馈。</p>

<h2>结论</h2>

<p>Compose 全新的阴影 API 标志着对传统 <strong>elevation</strong> 属性局限性的重大突破。它将核心概念拆分为 <strong>dropShadow()</strong> 和 <strong>innerShadow()</strong>，并赋予我们对 <strong>Shadow</strong> 对象属性的完全控制权。</p>

<p>无论你是打造简单的渐变效果、模拟物理深度，还是实现新粗野主义的高对比度视觉冲击，这种全新的自定义程度都意味着你的 <strong>UI 终于可以充分展现你设计的艺术愿景</strong>。</p>

<p>不妨尝试这些修饰符，为你的 Jetpack Compose 应用注入全新的创意维度！</p>

<p>如果你觉得这篇文章有趣，欢迎关注我，获取更多关于 Android 开发和 Jetpack Compose 的精彩内容。我会定期发布相关主题的文章。欢迎随时分享你的评论，或通过 <a href="https://bsky.app/profile/stefanoq21.bsky.social"><strong>Bluesky</strong></a> 或 <a href="http://www.linkedin.com/in/stefano-natali-q21"><strong>LinkedIn</strong></a> 与我联系，进行更深入的讨论。</p>

<p>祝你开心，编程快乐！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Jetpack Compose中创建CRT屏幕效果]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/12/crt-effects/"/>
    <updated>2025-11-12T13:42:48+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/12/crt-effects</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Creating a CRT Screen Effect in Jetpack Compose」，原文链接<a href="https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/">https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/</a>，由sinasamaki发布于2025年11月7日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/12/crt-effects/"><img src="https://www.sinasamaki.com/content/images/size/w2000/2025/11/CRT.png" title="auto auto" ></a></p>

<!-- more -->


<p>CRT 显示器具有独特而怀旧的外观：模糊的边缘、扫描线和轻微的色彩溢出。让我们尝试使用 <code>GraphicsLayer</code> 和一些巧妙的图层技巧在 Jetpack Compose 中重现这种效果。</p>

<h2>GraphicsLayer</h2>

<p>与上一篇文章一样，此效果的基础是 <code>GraphicsLayer</code>。它允许我们将内容绘制一次到屏幕外缓冲区。然后，我们可以以极低的性能开销多次使用不同的效果重新绘制它。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">graphicsLayer</span> <span class="p">=</span> <span class="n">rememberGraphicsLayer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">drawWithContent</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">graphicsLayer</span><span class="p">.</span><span class="n">record</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="n">@drawWithContent</span><span class="p">.</span><span class="n">drawContent</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">content</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>一旦我们将内容记录到 <code>graphicsLayer</code> 中，就可以使用 <code>drawLayer(graphicsLayer)</code> 根据需要多次绘制它。</p>

<p>我喜欢在黑色背景上绘制色彩鲜艳、饱和度高的内容，并运用这种效果。以下是我们将应用此效果的基础可组合对象。</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-09.39.28.png" alt="" /></p>

<h2>添加扫描线</h2>

<p>为了模拟 CRT 显示器上的水平扫描线，我们将使用重复渐变。让我们将其放入一个扩展函数中，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">blendMode</span><span class="p">:</span> <span class="n">BlendMode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">color</span> <span class="p">=</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">verticalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startY</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endY</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">horizontalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startX</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endX</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们手动定义颜色停止点，以便在颜色之间形成清晰的边缘，然后将 <code>tileMode</code> 设置为 <code>Repeated</code>。这样，再加上较短的起点和终点，就能得到许多重复的平行线。</p>

<p>扩展函数还会接收我们所需的透明度和 <code>BlendMode</code> 参数。</p>

<p>然后，我们可以使用此函数在 <code>graphicsLayer</code> 上绘制扫描线。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>        <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>将混合模式设置为 <code>DstOut</code> 会从绘制的内容中“减去”我们的渐变，从而产生这种效果。</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-09.39.55.png" alt="" /></p>

<h2>构建模糊图层</h2>

<p>为了实现 CRT 屏幕常见的发光效果，我们将多次绘制 <code>graphicsLayer</code> 图层，每次绘制时分别设置不同的模糊半径、透明度和缩放比例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">blurLayers</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.2f</span><span class="p">,</span> <span class="m">1.02f</span> <span class="n">to</span> <span class="m">1.03f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">2f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="m">0.9f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>        <span class="n">Triple</span><span class="p">(</span><span class="m">40.</span><span class="n">dp</span><span class="p">,</span> <span class="m">1f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们将使用一个 <code>Triple</code> 列表来存储每个图层的数据。该列表的顺序也定义了它们的绘制顺序。我建议你尝试调整这些值和顺序，以获得所需的效果。但这是我目前使用的方法。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">blurLayers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="p">-&gt;</span>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">Modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">matchParentSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">BlurredEdgeTreatment</span><span class="p">.</span><span class="n">Unbounded</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">scaleX</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">first</span>
</span><span class='line'>                <span class="n">scaleY</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">second</span>
</span><span class='line'>                <span class="k">this</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>                    <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，我们使用列表中的值绘制每个图层。在 <code>drawBehind</code> 修改器上方，我们将图层大小设置为与父图层匹配，并应用模糊、缩放和透明度。请记住将模糊设置为 <code>Unbounded</code>，使其超出包含它的可组合对象的边界。</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/Screenshot-2025-11-07-at-08.33.20.png" alt="" /></p>

<h2>屏幕抖动</h2>

<p>最后，我们来添加屏幕抖动效果，以模拟 CRT 显示器特有的抖动。我们可以通过创建一个 <code>Offset</code> 对象，并用 -1 到 1 之间的随机浮点值来更新它。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">var</span> <span class="py">shake</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">shake</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>            <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">32</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里只需在一个 while 循环中即可完成。可以调整延迟时间来控制闪烁的间隔频率。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">translationX</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">x</span>
</span><span class='line'>        <span class="n">translationY</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后可以使用修饰符来应用此偏移量。</p>

<p><img src="file:///Users/alexhilton/Downloads/crt_opt.gif" alt="" /></p>

<h2>整合所有功能</h2>

<p>让我们将所有这些功能组合成一个可轻松使用的组合。它会接收 <code>content</code> 参数以及 <code>flickerDelay</code> 参数，后者用于控制闪烁频率。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CRTBox</span><span class="p">(</span>
</span><span class='line'>    <span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flickerDelay</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">32</span><span class="p">,</span>
</span><span class='line'>    <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">shake</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="n">Offset</span><span class="p">.</span><span class="n">Zero</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">while</span> <span class="p">(</span><span class="n">flickerDelay</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">shake</span> <span class="p">=</span> <span class="n">Offset</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">Random</span><span class="p">.</span><span class="n">nextInt</span><span class="p">(-</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="p">*</span> <span class="n">Random</span><span class="p">.</span><span class="n">nextFloat</span><span class="p">(),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">delay</span><span class="p">(</span><span class="n">flickerDelay</span><span class="p">.</span><span class="n">toLong</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">graphicsLayer</span> <span class="p">=</span> <span class="n">rememberGraphicsLayer</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>            <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">translationX</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">x</span>
</span><span class='line'>                <span class="n">translationY</span> <span class="p">=</span> <span class="n">shake</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">drawWithContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">graphicsLayer</span><span class="p">.</span><span class="n">record</span> <span class="p">{</span> <span class="k">this</span><span class="n">@drawWithContent</span><span class="p">.</span><span class="n">drawContent</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">content</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">blurLayers</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">listOf</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">5.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">3f</span><span class="p">,</span> <span class="m">1.02f</span> <span class="n">to</span> <span class="m">1.03f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">0.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">8f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">1.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">9f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">10.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">6f</span><span class="p">,</span> <span class="m">1.001f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>                <span class="n">Triple</span><span class="p">(</span><span class="m">40.</span><span class="n">dp</span><span class="p">,</span> <span class="p">.</span><span class="m">7f</span><span class="p">,</span> <span class="m">1f</span> <span class="n">to</span> <span class="m">1f</span><span class="p">),</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">blurLayers</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Modifier</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">matchParentSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">blur</span><span class="p">(</span><span class="n">blur</span><span class="p">,</span> <span class="n">BlurredEdgeTreatment</span><span class="p">.</span><span class="n">Unbounded</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">graphicsLayer</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">scaleX</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">first</span>
</span><span class='line'>                        <span class="n">scaleY</span> <span class="p">=</span> <span class="n">scale</span><span class="p">.</span><span class="n">second</span>
</span><span class='line'>                        <span class="k">this</span><span class="p">.</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="p">.</span><span class="n">drawBehind</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">layer</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">drawLayer</span><span class="p">(</span><span class="n">graphicsLayer</span><span class="p">)</span>
</span><span class='line'>                            <span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="m">1f</span><span class="p">,</span> <span class="n">blendMode</span> <span class="p">=</span> <span class="n">BlendMode</span><span class="p">.</span><span class="n">DstOut</span><span class="p">)</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">layer</span><span class="p">(</span>
</span><span class='line'>    <span class="n">bounds</span><span class="p">:</span> <span class="n">Rect</span> <span class="p">=</span> <span class="n">size</span><span class="p">.</span><span class="n">toRect</span><span class="p">(),</span>
</span><span class='line'>    <span class="n">block</span><span class="p">:</span> <span class="n">DrawScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
</span><span class='line'><span class="p">)</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">drawIntoCanvas</span> <span class="p">{</span> <span class="n">canvas</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">canvas</span><span class="p">.</span><span class="n">withSaveLayer</span><span class="p">(</span>
</span><span class='line'>            <span class="n">bounds</span> <span class="p">=</span> <span class="n">bounds</span><span class="p">,</span>
</span><span class='line'>            <span class="n">paint</span> <span class="p">=</span> <span class="n">Paint</span><span class="p">(),</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">block</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">DrawScope</span><span class="p">.</span><span class="n">drawScanLines</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span> <span class="n">blendMode</span><span class="p">:</span> <span class="n">BlendMode</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">color</span> <span class="p">=</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Black</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">alpha</span> <span class="p">=</span> <span class="n">alpha</span><span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">verticalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.4f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startY</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endY</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>    <span class="n">drawRect</span><span class="p">(</span>
</span><span class='line'>        <span class="n">brush</span> <span class="p">=</span> <span class="n">Brush</span><span class="p">.</span><span class="n">horizontalGradient</span><span class="p">(</span>
</span><span class='line'>            <span class="m">0f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">color</span><span class="p">,</span>
</span><span class='line'>            <span class="m">0.1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="m">1f</span> <span class="n">to</span> <span class="n">Colors</span><span class="p">.</span><span class="n">Transparent</span><span class="p">,</span>
</span><span class='line'>            <span class="n">tileMode</span> <span class="p">=</span> <span class="n">TileMode</span><span class="p">.</span><span class="n">Repeated</span><span class="p">,</span>
</span><span class='line'>            <span class="n">startX</span> <span class="p">=</span> <span class="m">0f</span><span class="p">,</span>
</span><span class='line'>            <span class="n">endX</span> <span class="p">=</span> <span class="m">10f</span><span class="p">,</span>
</span><span class='line'>        <span class="p">),</span>
</span><span class='line'>        <span class="n">blendMode</span> <span class="p">=</span> <span class="n">blendMode</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后，你可以像使用其他可组合组件一样使用它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">CRTBox</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">Text</span><span class="p">(</span><span class="s">&quot;GAME OVER&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Sweeper 更新</h2>

<p>如果你想查看实际效果，请查看最新的 Sweeper 更新，该更新使用 CRT 效果创建了一个令人毛骨悚然的万圣节主题。</p>

<p><img src="https://www.sinasamaki.com/content/images/2025/11/IMG_9612-Edited-copy.jpeg" alt="" /></p>

<p><a href="https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper&amp;ref=sinasamaki.com">https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper</a></p>

<p><a href="https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495?ref=sinasamaki.com">https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495</a></p>

<p>感谢阅读，祝你好运！</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用CameraX 1.5进行高速拍摄和慢动作视频拍摄]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion/"/>
    <updated>2025-11-05T13:59:12+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「High-Speed Capture and Slow-Motion Video with CameraX 1.5」，原文链接<a href="https://android-developers.googleblog.com/2025/10/high-speed-capture-and-slow-motion.html">https://android-developers.googleblog.com/2025/10/high-speed-capture-and-slow-motion.html</a>，由Leo Huang发布于2025年10月28日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/05/camerax-slow-motion/"><img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhSMEQNJHjQybdOLzAewkopnpZ6OUC0jYiXboj3chVWnaFbKtD5bPA4azyqjM7_ffdGv_nBnvYUgoqvhISE7-lff-aGkF8f200ENGHF9" title="auto auto" ></a></p>

<!-- more -->


<p>清晰捕捉快速运动的画面是现代相机应用的关键特性。这可以通过高速拍摄来实现——即以 120 或 240 fps 等速率采集帧。这种高保真拍摄可用于两种截然不同的用途：创建高帧率视频以进行逐帧的详细分析，或生成慢动作视频，使动作在屏幕上呈现出戏剧性的展开效果。</p>

<p>以前，使用 Camera2 API 实现这些功能需要更多的人工操作。现在，CameraX 1.5 中新增的<a href="https://developer.android.com/reference/androidx/camera/video/HighSpeedVideoSessionConfig">高速 API</a>简化了整个流程，让你可以灵活地创建真正的高帧率视频或即用型慢动作短片。本文将向你展示如何掌握这两种方法。如果你是 CameraX 新手，可以先阅读<a href="https://developer.android.com/media/camera/camerax">CameraX 概述</a>快速上手。</p>

<h2>慢动作原理</h2>

<p>慢动作的基本原理是以远高于播放帧率的帧率来录制视频。例如，如果你以每秒 120 帧 (fps) 的帧率录制一个一秒钟的事件，然后以标准的 30 fps 播放该录像，则视频需要四秒钟才能播放完毕。这种时间的“拉伸”正是慢动作效果的来源，让你能够看到肉眼无法捕捉到的快速细节。</p>

<p>为确保最终输出视频流畅自然，通常应以至少 30 fps 的帧率进行渲染。这意味着，要制作 4 倍慢动作视频，原始拍摄帧率必须至少为 120 fps（120 fps 拍摄帧率 ÷ 4 = 30 fps 播放帧率）。</p>

<p>拍摄高帧率素材后，主要有两种方法可以实现所需效果：</p>

<ul>
<li><p>播放器控制的慢动作（高帧率视频）：高速录制的视频（例如 120 fps）直接保存为高帧率视频文件。然后，视频播放器负责降低播放速度。这样，用户可以灵活地在正常播放和慢动作播放之间切换。</p></li>
<li><p>即用型慢动作（重新编码的视频）：高速视频流经过处理和重新编码，生成标准帧率（例如 30 fps）的文件。慢动作效果是通过调整帧时间戳“嵌入”到视频中的。生成的视频无需特殊处理即可在任何标准视频播放器中以慢动作播放。虽然视频默认以慢动作播放，但视频播放器仍然可以提供播放速度控制，允许用户加快播放速度并以原始速度观看视频。</p></li>
</ul>


<p>CameraX API 简化了这一过程，为你提供了一种统一的方式来选择所需的播放方式，如下所示。</p>

<h2>全新高速视频 API</h2>

<p>全新的 CameraX 解决方案基于两个主要组件：</p>

<ul>
<li><p><a href="https://developer.android.com/reference/kotlin/androidx/camera/video/Recorder#getHighSpeedVideoCapabilities(androidx.camera.core.CameraInfo)">Recorder#getHighSpeedVideoCapabilities(CameraInfo)</a>: 此方法用于检查摄像头是否支持高速录制，如果支持，则可查看支持哪些分辨率（Quality 对象）。</p></li>
<li><p><a href="https://developer.android.com/reference/androidx/camera/video/HighSpeedVideoSessionConfig">HighSpeedVideoSessionConfig</a>: 这是一个特殊的配置对象，用于将你的 VideoCapture 和 Preview 使用场景分组，并指示 CameraX 创建一个统一的高速摄像头会话。请注意，虽然 VideoCapture 流将以配置的高帧率运行，但为了确保屏幕流畅显示，预览流通常会被摄像头系统限制在至少 30 FPS 的标准帧率。</p></li>
</ul>


<h2>入门指南</h2>

<p>开始之前，请确保已将必要的 CameraX 依赖项添加到应用程序的 build.gradle.kts 文件中。你需要 camera-video 组件以及 CameraX 核心库。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// build.gradle.kts (Module: app)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">camerax_version</span> <span class="p">=</span> <span class="s">&quot;1.5.1&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-core:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-camera2:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-lifecycle:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-video:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-view:$camerax_version&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>关于实验性 API 的说明</h3>

<p>需要注意的是，高速录制 API 目前处于实验阶段。这意味着它们在未来的版本中可能会发生变化。要使用它们，你必须通过在代码中添加以下注释来启用它们：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@kotlin</span><span class="p">.</span><span class="n">OptIn</span><span class="p">(</span><span class="n">ExperimentalSessionConfig</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">ExperimentalHighSpeedVideo</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>具体实现</h2>

<p>两种结果的实现都从相同的设置步骤开始。创建高帧率视频还是慢动作视频的选择取决于一个设置。</p>

<h3>1.设置高速拍摄</h3>

<p>首先，无论你的目标是什么，你都需要获取 <a href="https://developer.android.com/reference/androidx/camera/lifecycle/ProcessCameraProvider">ProcessCameraProvider</a>，检查设备功能，并创建你的使用场景。</p>

<p>以下代码块展示了在挂起函数中的完整设置流程。你可以从协程作用域调用此函数，例如 <code>lifecycleScope.launch</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Add the OptIn annotation at the top of your function or class</span>
</span><span class='line'>
</span><span class='line'><span class="n">@kotlin</span><span class="p">.</span><span class="n">OptIn</span><span class="p">(</span><span class="n">ExperimentalSessionConfig</span><span class="o">::</span><span class="k">class</span><span class="p">,</span> <span class="n">ExperimentalHighSpeedVideo</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setupCamera</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Asynchronously get the CameraProvider</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">cameraProvider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// -- CHECK CAPABILITIES --</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">cameraInfo</span> <span class="p">=</span> <span class="n">cameraProvider</span><span class="p">.</span><span class="n">getCameraInfo</span><span class="p">(</span><span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">videoCapabilities</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">getHighSpeedVideoCapabilities</span><span class="p">(</span><span class="n">cameraInfo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">videoCapabilities</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// This camera device does not support high-speed video.</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// -- CREATE USE CASES --</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// You can create a Recorder with default settings.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// CameraX will automatically select a suitable quality.</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">recorder</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Alternatively, to use a specific resolution, you can configure the</span>
</span><span class='line'>    <span class="c1">// Recorder with a QualitySelector. This is useful if your app has</span>
</span><span class='line'>    <span class="c1">// specific resolution requirements or you want to offer user</span>
</span><span class='line'>    <span class="c1">// preferences. </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// To use a specific quality, you can uncomment the following lines.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get the list of qualities supported for high-speed video. </span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// val supportedQualities = videoCapabilities.getSupportedQualities(DynamicRange.SDR)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Build the Recorder using the quality from the supported list.</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// val recorderWithQuality = Recorder.Builder()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//     .setQualitySelector(QualitySelector.from(supportedQualities.first()))</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//     .build()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Create the VideoCapture use case, using either recorder or recorderWithQuality</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">videoCapture</span> <span class="p">=</span> <span class="n">VideoCapture</span><span class="p">.</span><span class="n">withOutput</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Now you are ready to configure the session for your desired output...</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 选择输出</h3>

<p>现在，你需要决定要创建哪种类型的视频。此代码将在上面所示的 <code>setupCamera()suspend</code> 函数中运行。</p>

<h4>选项 A：创建高帧率视频</h4>

<p>如果你希望最终文件具有高帧率（例如，120fps 的视频），请选择此选项。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Create a builder for the high-speed session</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">sessionConfigBuilder</span> <span class="p">=</span> <span class="n">HighSpeedVideoSessionConfig</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">videoCapture</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">setPreview</span><span class="p">(</span><span class="n">preview</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query and apply a supported frame rate. Common supported frame rates include 120 and 240 fps.</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">supportedFrameRateRanges</span> <span class="p">=</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cameraInfo</span><span class="p">.</span><span class="n">getSupportedFrameRateRanges</span><span class="p">(</span><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setFrameRateRange</span><span class="p">(</span><span class="n">supportedFrameRateRanges</span><span class="p">.</span><span class="n">first</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<h4>选项 B：创建可直接播放的慢动作视频</h4>

<p>如果你希望视频在任何标准视频播放器中自动以慢动作播放，请选择此选项。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Create a builder for the high-speed session</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">sessionConfigBuilder</span> <span class="p">=</span> <span class="n">HighSpeedVideoSessionConfig</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">videoCapture</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">setPreview</span><span class="p">(</span><span class="n">preview</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// This is the key: enable automatic slow-motion!</span>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setSlowMotionEnabled</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Query and apply a supported frame rate. Common supported frame rates include 120, 240, and 480 fps.</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">supportedFrameRateRanges</span> <span class="p">=</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">cameraInfo</span><span class="p">.</span><span class="n">getSupportedFrameRateRanges</span><span class="p">(</span><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'><span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">setFrameRateRange</span><span class="p">(</span><span class="n">supportedFrameRateRanges</span><span class="p">.</span><span class="n">first</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个标志位是创建可直接播放的慢动作视频的关键。当 <code>setSlowMotionEnabled</code> 设置为 true 时，CameraX 会处理高速视频流并将其保存为标准的 30 fps 视频文件。慢动作播放速度由拍摄帧速率与标准播放速率的比值决定。</p>

<p>例如：</p>

<ul>
<li><p>以 120 fps 录制的视频将以 &frac14; 倍速播放 (120 ÷ 30 = 4)。</p></li>
<li><p>以 240 fps 录制的视频将以 1/8 倍速播放 (240 ÷ 30 = 8)。</p></li>
</ul>


<h2>整合所有步骤：录制视频</h2>

<p>配置好 HighSpeedVideoSessionConfig 并将其绑定到生命周期后，最后一步就是开始录制。准备输出选项、开始录制和处理视频事件的过程与标准视频捕获相同。</p>

<p>本文重点介绍高速配置，因此不会详细介绍录制过程。如需了解从准备 FileOutputOptions 或 MediaStoreOutputOptions 对象到处理 VideoRecordEvent 回调的完整指南，请参阅<a href="https://developer.android.com/media/camera/camerax/video-capture#videocapture-api-overview">VideoCapture 文档</a>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Bind the session config to the lifecycle</span>
</span><span class='line'>
</span><span class='line'><span class="n">cameraProvider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span> <span class="k">as</span> <span class="n">LifecycleOwner</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sessionConfigBuilder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span> <span class="c1">// Bind the config object from Option A or B</span>
</span><span class='line'>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the recording using the VideoCapture use case</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">recording</span> <span class="p">=</span> <span class="n">videoCapture</span><span class="p">.</span><span class="n">output</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">prepareRecording</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">outputOptions</span><span class="p">)</span> <span class="c1">// See docs for creating outputOptions</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span> <span class="n">recordEvent</span> <span class="p">-&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Handle recording events (e.g., Start, Pause, Finalize)</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Google Photos 对慢动作视频的支持</h2>

<p>在 CameraX 中启用 setSlowMotionEnabled(true) 后，生成的视频文件将被设计为可在标准视频播放器和图库应用中立即识别并播放为慢动作视频。谷歌相册尤其针对慢动作视频提供了增强功能，当拍摄帧速率为 120、240、360、480 或 960fps 时，功能更加完善：</p>

<ul>
<li>缩略图中的独特 UI 识别：在谷歌相册中，慢动作视频会通过特定的 UI 元素进行识别，从而与普通视频区分开来。</li>
</ul>


<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEjPLQRSSF3hvj89T9DvO92-JNi_rjtUXQ-i76ZuyX4GHv4KitBFPVP5oHdqxICQJUf3l7HaOQeI0skgVK9bPM0qz7GToNYiIMszVYj6IsE4-wGa4jqZfYka03TTlFwUTDdYq56unwoIwv1fTnJrNpWIZ-5Iybgk-hFHlvcy08Bkm8xM0adbvYjqVxH12xc" alt="普通视频缩略图" /></p>

<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEiDmd0jikxU58PkjrGG1K181pYs-G-drnrNG_q_mQqVJWkK4NdbuwDSB4jCbQzGAgYeyikORVsPT3pyQp_VCfw_7rNDzafFudhj0x56-bqNZc6mQuRktDCa7ycSx2-qsIJsCCTiQXmxxrtImiBOFwlTz3ufBtbGDsonZvqzSQqWbNugNt-bbDVvyQz7Hw8" alt="慢动作视频缩略图" /></p>

<ul>
<li>播放时可调整速度：播放慢动作视频时，Google Photos 提供控制选项，允许用户调整视频中哪些部分以慢速播放，哪些部分以正常速度播放，从而赋予用户更大的创作自由。编辑后的视频可以使用“分享”按钮导出为新的视频文件，同时保留你定义的慢动作片段。</li>
</ul>


<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEj-dp-bHPORhk_l0I4zkSEdzYUNRYvRwb2boA4KKgd1s4Sr1D61iAV2rWUD6dOdVezRn10qIGtMLae4brWI8RxlP9wFz18gsrZu4qOdAydWnhqgpmmsuLcHAMfo5Rv6XZIxtTCC5dSJeIJERbOKmPZyUXTOdweJ6EjQett5iOVl4yJzaLYR7rrHXz0WnAI" alt="正常视频播放" /></p>

<p><img src="https://blogger.googleusercontent.com/img/a/AVvXsEi4AaVc78zpZzsG-hgOsuPdAqwCuSD6bb1b6de366Agvy2c3OG5qJ5mSPg94GA8GjR-LXDU4H7zBCoI_Pe3SxrfdDPiTyPmimTRM49IcTkGovC2mccTu0GnwcSyVAL5iW7qnNlWHGCoGHU9EeX3-8bZiSsmLWr6Ljf5KfJjInUuCEODrqF-g8Je3iLvEF4" alt="慢动作视频播放（带编辑控制）" /></p>

<h2>关于设备支持的说明</h2>

<p>CameraX 的高速 API 依赖于底层 Android 的 <a href="https://developer.android.com/reference/android/media/CamcorderProfile">CamcorderProfile</a> 系统来确定设备支持的高速分辨率和帧速率。CamcorderProfile 经过 <a href="https://source.android.com/docs/compatibility/cts">Android 兼容性测试套件 (CTS)</a> 的验证，这意味着你可以信赖设备所报告的视频录制功能。</p>

<p>这意味着，设备内置相机应用能够录制慢动作视频并不能保证 CameraX 高速 API 能够正常工作。出现这种差异的原因是，设备制造商负责在其设备固件中填充 CamcorderProfile 条目，而有时必要的高速配置文件（例如 CamcorderProfile.QUALITY_HIGH_SPEED_1080P 和 CamcorderProfile.QUALITY_HIGH_SPEED_720P）可能并未包含在内。当缺少这些配置文件时，<code>Recorder.getHighSpeedVideoCapabilities()</code> 将返回 null。</p>

<p>因此，务必始终使用 <code>Recorder.getHighSpeedVideoCapabilities()</code> 以编程方式检查支持的功能，因为这是确保在不同设备上获得一致体验的最可靠方法。如果尝试在 <code>Recorder.getHighSpeedVideoCapabilities()</code> 返回 null 的设备上绑定 <code>HighSpeedVideoSessionConfig</code>，则操作将失败并抛出 <code>IllegalArgumentException</code> 异常。你可以在 Google Pixel 设备上确认支持，因为它们始终包含这些高速配置文件。此外，其他制造商的各种设备，例如 Motorola Edge 30、OPPO Find N2 Flip 和 Sony Xperia 1 V，也支持高速视频功能。</p>

<h2>结论</h2>

<p>CameraX 高速视频 API 功能强大且灵活。无论你是需要用于技术分析的真正高帧率视频素材，还是想为你的应用添加电影级的慢动作效果，HighSpeedVideoSessionConfig 都能提供统一且简便的解决方案。通过了解 setSlowMotionEnabled 标志的作用，你可以轻松支持这两种使用场景，并赋予用户更大的创作自由。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Compose CameraX现已稳定：给Composer的端到端指南]]></title>
    <link href="https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable/"/>
    <updated>2025-11-02T14:10:34+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Compose-Native CameraX Is Now Stable: End-to-End Guide for Jetpack Compose」，原文链接<a href="https://proandroiddev.com/goodbye-androidview-camerax-goes-full-compose-4d21ca234c4e">https://proandroiddev.com/goodbye-androidview-camerax-goes-full-compose-4d21ca234c4e</a>，由Ioannis Anifantakis发布于20251026。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/11/02/compose-camerax-is-stable/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*sizZteIZmrzNr4X1BeXcJg.png" title="auto auto" ></a></p>

<!-- more -->


<h2>简介</h2>

<p>还记得你在 Jetpack Compose 中的第一个相机页面吗？纯粹的声明式乐趣……直到预览。然后是熟悉的 <code>AndroidView(PreviewView)</code> 绕道。它确实有效，但总感觉不对：composables中间有一个 View 形状的空洞（类似于 <code>_iFrame_</code>_ ……），而且点击对焦的数学计算总是让人感觉不太可靠。</p>

<p>在 I/O 25 之后，这种妥协已经结束。</p>

<ul>
<li><strong>不再</strong> 使用 <code>**AndroidView(PreviewView)**</code> 进行相机预览。</li>
<li><strong>新增</strong> <code>**CameraXViewfinder**</code> 可组合项，可在 Compose 中直接渲染 CameraX <code>SurfaceRequest</code>。</li>
<li><strong>修正了内置坐标变换</strong>（点击对焦、叠加层），并建立了更简洁、更具声明性的心智模型。</li>
</ul>


<blockquote><p><strong><em>注意：</em></strong></p>

<p><em>“</em>在 I/O 25 大会上，Compose 支持已发布 <strong>alpha/beta</strong> 版本，稳定版已于 9 月发布——现在是时候了解一下了。”_</p></blockquote>

<h2>配套项目</h2>

<p>你可以在 <a href="https://github.com/ioannisa/CameraX-Composable-Demo/"><strong>GitHub 上的配套项目</strong></a> 找到本文的配套项目，该项目演示了 CameraX 中 Jetpack Compose 的新功能。</p>

<h3>权限用户体验（简要说明）</h3>

<p>本文将重点介绍 Compose + CameraX 的功能。<strong>配套项目</strong> 实现了完整的运行时流程：</p>

<ul>
<li>在预览入口点请求 <code>**CAMERA**</code>。</li>
<li>仅在用户开始录制时（按需麦克风）请求 <code>**RECORD_AUDIO**</code>。</li>
<li>一个小型的 <code>PermissionGate</code> 可组合函数负责处理 Compose 树中的授权/拒绝/重新请求。</li>
<li>为了满足 Lint 对 <code>@RequiresPermission</code> 的要求，调用点还会在调用与麦克风相关的 API 之前执行显式 <code>checkSelfPermission(...)</code>。</li>
</ul>


<p>请参阅代码库，了解具体的 <code>PermissionGate</code> 以及我们如何将其连接到 Capture 页面。</p>

<h2>实际变化是什么？</h2>

<p>CameraX 团队放弃了 <code>androidx.camera:camera-compose</code>，取而代之的是看似简单的 API：<code>**CameraXViewfinder**</code>。但这不仅仅是“将 <code>PreviewView</code> 封装在可组合项中”。这是对 Compose 的彻底重写，也是对相机 Surface 与 Compose 集成方式的根本性重新思考。</p>

<p>以下是架构层面的变化：</p>

<p><strong>Compose 目标优先</strong>
取景器渲染管道现在将 Compose 视为主要平台。Surface 生命周期、旋转处理和缩放都以 Compose 惯用的方式进行。</p>

<p><strong>开箱即用的正确坐标变换</strong>
还记得计算预览中的点击实际映射到相机传感器的位置，并考虑旋转、宽高比裁剪和缩放模式吗？<code>MutableCoordinateTransformer</code> 可以处理这些。点击对焦现在……可以正常工作了。</p>

<p><strong>真正的可组合语义</strong>
想要将预览 <code>clip()</code> 转换为自定义形状？应用 <code>graphicsLayer</code> 变换？使用 <code>AnimatedContent</code> 为其添加动画效果？现在，你可以轻松完成所有这些操作，而无需与渲染器冲突。它与其他可组合组件一样。</p>

<p><strong>CameraX 1.5.x 成熟度</strong>
整个技术栈都得到了完善：适用于 Kotlin 协程的 <code>ProcessCameraProvider.awaitInstance()</code>、全面稳定的构件以及更完善的文档。这并非 Beta 测试……它已准备好投入生产。</p>

<h2>为什么这真的很重要</h2>

<p>如果你一直在构建相机功能，<strong>你就会知道其中的痛点</strong>：</p>

<ul>
<li><strong>心智模型分裂</strong>：“用 Compose 思考 UI，用 View 思考相机，并在两者之间不断转换。”</li>
<li><strong>手势协调的噩梦</strong>：在 Compose 中处理触摸事件，在 View 坐标系中测光对焦，祈祷你的计算准确无误。</li>
<li><strong>Z 轴顺序难题</strong>：“PreviewView” 经常使用在单独图层中渲染的“SurfaceView”。Compose 叠加层无法可靠地位于顶部，因此十字线、参考线和按钮可能会消失在预览层后面。</li>
<li><strong>生命周期之舞</strong>：使用 CameraX 用例绑定将 Compose 重组与 View 生命周期同步</li>
</ul>


<p>所有这些摩擦？都消失了。</p>

<blockquote><p><strong>“现在，你可以像编写其他现代 Android 应用一样编写相机 UI。一个范例。一个心智模型。纯粹的 Compose。”</strong></p></blockquote>

<h2>代码演示</h2>

<p>让我们从最基本的开始——一个可以工作的相机预览（固定状态模式：将<strong>写入器</strong> <code>MutableStateFlow</code> 与<strong>读取器</strong> <code>collectAsState</code> 分离）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CameraPreview</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Writer: MutableStateFlow we can update from CameraX callbacks</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Reader: Compose state derived from the flow</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind CameraX use cases once</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// When CameraX needs a surface, publish it to Compose</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">request</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The actual Compose viewfinder</span>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>就是这样。没有 <code>AndroidView</code>。没有 <code>PreviewView</code>。只有一个可组合组件，它接收 <code>SurfaceRequest</code> 并进行渲染。</p>

<blockquote><p><strong><em>模式很简洁：“</em></strong>CameraX 发布 Surface 请求，Compose 处理它们。单向。没有回调在各个世界之间来回切换。”</p></blockquote>

<h3>可选：使用镜头切换按钮（FAB）进行预览（前/后）</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">PreviewWithLensSwitch</span><span class="p">(</span><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// remember current lens</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">useFront</span> <span class="k">by</span> <span class="n">rememberSaveable</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">selector</span> <span class="p">=</span> <span class="k">if</span> <span class="p">(</span><span class="n">useFront</span><span class="p">)</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_FRONT_CAMERA</span> <span class="k">else</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// bind when camera selector changes (front/back camera)</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">CameraXViewfinder</span><span class="p">(</span><span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">req</span><span class="p">,</span> <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">FloatingActionButton</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">useFront</span> <span class="p">=</span> <span class="p">!</span><span class="n">useFront</span> <span class="p">},</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomEnd</span><span class="p">).</span><span class="n">padding</span><span class="p">(</span><span class="m">16.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Rounded</span><span class="p">.</span><span class="n">Cameraswitch</span><span class="p">,</span> <span class="n">contentDescription</span> <span class="p">=</span> <span class="s">&quot;Switch camera&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>真正的考验：交互式相机控件</h2>

<p>旧方法的失败之处就在这里。让我们实现点击对焦和捏合缩放……这些功能过去需要对视图坐标系进行一些 hack（同样使用固定的写入/读取模式）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">InteractiveCameraPreview</span><span class="p">(</span>
</span><span class='line'>
</span><span class='line'><span class="n">modifier</span><span class="p">:</span> <span class="n">Modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'><span class="n">onFocusTap</span><span class="p">:</span> <span class="p">(</span><span class="n">success</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span> <span class="p">=</span> <span class="p">{})</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">camera</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind camera once</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">camera</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Coordinate transformer: Compose UI → Camera surface</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">coordinateTransformer</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableCoordinateTransformer</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>            <span class="n">coordinateTransformer</span> <span class="p">=</span> <span class="n">coordinateTransformer</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Tap-to-focus</span>
</span><span class='line'>                    <span class="n">detectTapGestures</span> <span class="p">{</span> <span class="n">offset</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">cam</span> <span class="p">=</span> <span class="n">camera</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTapGestures</span>
</span><span class='line'>
</span><span class='line'>                        <span class="c1">// Transform Compose coordinates to camera surface</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">surfacePoint</span> <span class="p">=</span> <span class="n">with</span><span class="p">(</span><span class="n">coordinateTransformer</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                            <span class="n">offset</span><span class="p">.</span><span class="n">transform</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">meteringFactory</span> <span class="p">=</span> <span class="n">SurfaceOrientedMeteringPointFactory</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">request</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">width</span><span class="p">.</span><span class="n">toFloat</span><span class="p">(),</span>
</span><span class='line'>                            <span class="n">request</span><span class="p">.</span><span class="n">resolution</span><span class="p">.</span><span class="n">height</span><span class="p">.</span><span class="n">toFloat</span><span class="p">()</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">focusPoint</span> <span class="p">=</span> <span class="n">meteringFactory</span><span class="p">.</span><span class="n">createPoint</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">surfacePoint</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">surfacePoint</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">action</span> <span class="p">=</span> <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">focusPoint</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">FLAG_AF</span> <span class="n">or</span> <span class="n">FocusMeteringAction</span><span class="p">.</span><span class="n">FLAG_AE</span>
</span><span class='line'>                        <span class="p">).</span><span class="n">setAutoCancelDuration</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="n">TimeUnit</span><span class="p">.</span><span class="n">SECONDS</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">cam</span><span class="p">.</span><span class="n">cameraControl</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">startFocusAndMetering</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">addListener</span><span class="p">(</span>
</span><span class='line'>                                <span class="p">{</span> <span class="n">onFocusTap</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">},</span>
</span><span class='line'>                                <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="p">.</span><span class="n">pointerInput</span><span class="p">(</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="c1">// Pinch-to-zoom</span>
</span><span class='line'>                    <span class="n">detectTransformGestures</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">cam</span> <span class="p">=</span> <span class="n">camera</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTransformGestures</span>
</span><span class='line'>                        <span class="k">val</span> <span class="py">zoomState</span> <span class="p">=</span> <span class="n">cam</span><span class="p">.</span><span class="n">cameraInfo</span><span class="p">.</span><span class="n">zoomState</span><span class="p">.</span><span class="n">value</span> <span class="o">?:</span> <span class="k">return</span><span class="n">@detectTransformGestures</span>
</span><span class='line'>
</span><span class='line'>                        <span class="k">val</span> <span class="py">newRatio</span> <span class="p">=</span> <span class="p">(</span><span class="n">zoomState</span><span class="p">.</span><span class="n">zoomRatio</span> <span class="p">*</span> <span class="n">zoom</span><span class="p">).</span><span class="n">coerceIn</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">zoomState</span><span class="p">.</span><span class="n">minZoomRatio</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">zoomState</span><span class="p">.</span><span class="n">maxZoomRatio</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>                        <span class="n">cam</span><span class="p">.</span><span class="n">cameraControl</span><span class="p">.</span><span class="n">setZoomRatio</span><span class="p">(</span><span class="n">newRatio</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>看看这个点击对焦的实现。注意你<strong>没有</strong>做的事情：</p>

<ul>
<li>无需手动旋转补偿</li>
<li>无需进行坐标映射的宽高比计算</li>
<li>无需进行视图 → 表面 → 传感器坐标链计算</li>
<li>无需进行“祈祷它在横向模式下能正常工作”的漫长测试</li>
</ul>


<p><code>MutableCoordinateTransformer</code> 可以处理所有这些。你点击 Compose 坐标系，它会转换为相机坐标系，就完成了。</p>

<p>这就是“技术上可行”和“实际易于实现”之间的区别。</p>

<h2>拍摄照片和视频</h2>

<p>添加拍摄功能遵循相同的简洁模式——绑定其他用例，并从 Compose 界面触发它们。</p>

<p>我们还将仅在尝试录制时请求<strong>麦克风</strong>，并使用简单的“PermissionGate”模式（与我们项目在需要时仅请求音频的方法一致）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">CameraScreen</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">camera</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Camera</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">imageCapture</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">ImageCapture</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">videoCapture</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">VideoCapture</span><span class="p">&lt;</span><span class="n">Recorder</span><span class="p">&gt;?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">activeRecording</span> <span class="k">by</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">&lt;</span><span class="n">Recording</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Bind all use cases</span>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">imageCapture</span> <span class="p">=</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">setCaptureMode</span><span class="p">(</span><span class="n">ImageCapture</span><span class="p">.</span><span class="n">CAPTURE_MODE_MINIMIZE_LATENCY</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">recorder</span> <span class="p">=</span> <span class="n">Recorder</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">setQualitySelector</span><span class="p">(</span><span class="n">QualitySelector</span><span class="p">.</span><span class="n">from</span><span class="p">(</span><span class="n">Quality</span><span class="p">.</span><span class="n">FHD</span><span class="p">))</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="n">videoCapture</span> <span class="p">=</span> <span class="n">VideoCapture</span><span class="p">.</span><span class="n">withOutput</span><span class="p">(</span><span class="n">recorder</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">camera</span> <span class="p">=</span> <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span>
</span><span class='line'>            <span class="n">lifecycleOwner</span><span class="p">,</span>
</span><span class='line'>            <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span>
</span><span class='line'>            <span class="n">preview</span><span class="p">,</span>
</span><span class='line'>            <span class="n">imageCapture</span><span class="o">!!</span><span class="p">,</span>
</span><span class='line'>            <span class="n">videoCapture</span><span class="o">!!</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Box</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Camera preview</span>
</span><span class='line'>        <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>                <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Compose UI controls</span>
</span><span class='line'>        <span class="n">Row</span><span class="p">(</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                <span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">Alignment</span><span class="p">.</span><span class="n">BottomCenter</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="n">padding</span><span class="p">(</span><span class="n">bottom</span> <span class="p">=</span> <span class="m">32.</span><span class="n">dp</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Capture photo button</span>
</span><span class='line'>            <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>                <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">capturePhoto</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">imageCapture</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">PhotoCamera</span><span class="p">,</span> <span class="s">&quot;Take Photo&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">Spacer</span><span class="p">(</span><span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">width</span><span class="p">(</span><span class="m">32.</span><span class="n">dp</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Video record toggle (mic requested only when needed)</span>
</span><span class='line'>            <span class="n">PermissionGate</span><span class="p">(</span>
</span><span class='line'>                <span class="n">permission</span> <span class="p">=</span> <span class="n">Permission</span><span class="p">.</span><span class="n">RECORD_AUDIO</span><span class="p">,</span>
</span><span class='line'>                <span class="c1">// Optional: custom UI if permission is not yet granted</span>
</span><span class='line'>                <span class="n">contentNonGranted</span> <span class="p">=</span> <span class="p">{</span> <span class="n">missing</span><span class="p">,</span> <span class="n">humanReadable</span><span class="p">,</span> <span class="n">requestPermissions</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="c1">// Minimal, inline UX: re-request directly</span>
</span><span class='line'>                    <span class="n">Button</span><span class="p">(</span><span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span> <span class="n">requestPermissions</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">Text</span><span class="p">(</span><span class="s">&quot;Grant $humanReadable&quot;</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">IconButton</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">onClick</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">activeRecording</span> <span class="p">=</span> <span class="n">toggleRecording</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">context</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">videoCapture</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">activeRecording</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">Icon</span><span class="p">(</span>
</span><span class='line'>                        <span class="k">if</span> <span class="p">(</span><span class="n">activeRecording</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">RadioButtonUnchecked</span>
</span><span class='line'>                        <span class="k">else</span> <span class="n">Icons</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="n">Stop</span><span class="p">,</span>
</span><span class='line'>                        <span class="s">&quot;Record Video&quot;</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">capturePhoto</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">imageCapture</span><span class="p">:</span> <span class="n">ImageCapture</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">capture</span> <span class="p">=</span> <span class="n">imageCapture</span> <span class="o">?:</span> <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="s">&quot;IMG_${System.currentTimeMillis()}.jpg&quot;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">contentValues</span> <span class="p">=</span> <span class="n">ContentValues</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">DISPLAY_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">MIME_TYPE</span><span class="p">,</span> <span class="s">&quot;image/jpeg&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// On Android 10+ you could also set RELATIVE_PATH = &quot;DCIM/CameraX&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">outputOptions</span> <span class="p">=</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">OutputFileOptions</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>        <span class="n">context</span><span class="p">.</span><span class="n">contentResolver</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MediaStore</span><span class="p">.</span><span class="n">Images</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">EXTERNAL_CONTENT_URI</span><span class="p">,</span>
</span><span class='line'>        <span class="n">contentValues</span>
</span><span class='line'>    <span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">capture</span><span class="p">.</span><span class="n">takePicture</span><span class="p">(</span>
</span><span class='line'>        <span class="n">outputOptions</span><span class="p">,</span>
</span><span class='line'>        <span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span><span class='line'>        <span class="k">object</span> <span class="err">: </span><span class="nc">ImageCapture</span><span class="p">.</span><span class="n">OnImageSavedCallback</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onImageSaved</span><span class="p">(</span><span class="n">output</span><span class="p">:</span> <span class="n">ImageCapture</span><span class="p">.</span><span class="n">OutputFileResults</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Success: output.savedUri</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="n">exception</span><span class="p">:</span> <span class="n">ImageCaptureException</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Handle error</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">toggleRecording</span><span class="p">(</span>
</span><span class='line'>    <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span>
</span><span class='line'>    <span class="n">videoCapture</span><span class="p">:</span> <span class="n">VideoCapture</span><span class="p">&lt;</span><span class="n">Recorder</span><span class="p">&gt;?,</span>
</span><span class='line'>    <span class="n">currentRecording</span><span class="p">:</span> <span class="n">Recording</span><span class="p">?</span>
</span><span class='line'><span class="p">):</span> <span class="n">Recording</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">capture</span> <span class="p">=</span> <span class="n">videoCapture</span> <span class="o">?:</span> <span class="k">return</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Stop if already recording</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">currentRecording</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">currentRecording</span><span class="p">.</span><span class="n">stop</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Start new recording</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span> <span class="p">=</span> <span class="s">&quot;VID_${System.currentTimeMillis()}.mp4&quot;</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">contentValues</span> <span class="p">=</span> <span class="n">ContentValues</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">put</span><span class="p">(</span><span class="n">MediaStore</span><span class="p">.</span><span class="n">Video</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">DISPLAY_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>        <span class="c1">// On Android 10+ you could also set RELATIVE_PATH = &quot;DCIM/CameraX&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">outputOptions</span> <span class="p">=</span> <span class="n">MediaStoreOutputOptions</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span>
</span><span class='line'>        <span class="n">context</span><span class="p">.</span><span class="n">contentResolver</span><span class="p">,</span>
</span><span class='line'>        <span class="n">MediaStore</span><span class="p">.</span><span class="n">Video</span><span class="p">.</span><span class="n">Media</span><span class="p">.</span><span class="n">EXTERNAL_CONTENT_URI</span>
</span><span class='line'>    <span class="p">).</span><span class="n">setContentValues</span><span class="p">(</span><span class="n">contentValues</span><span class="p">).</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">capture</span><span class="p">.</span><span class="n">output</span>
</span><span class='line'>        <span class="p">.</span><span class="n">prepareRecording</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">outputOptions</span><span class="p">)</span>
</span><span class='line'>        <span class="p">.</span><span class="n">withAudioEnabled</span><span class="p">()</span> <span class="c1">// mic permission is ensured by PermissionGate above</span>
</span><span class='line'>        <span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">ContextCompat</span><span class="p">.</span><span class="n">getMainExecutor</span><span class="p">(</span><span class="n">context</span><span class="p">))</span> <span class="p">{</span> <span class="n">event</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="c1">// Handle recording events (e.g., finalize, error)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是纯粹的 Compose UI 构建。你的相机按钮与预览位于同一个可组合树中。没有桥接逻辑。无需管理单独的 View 层次结构。</p>

<h2>迁移策略：PreviewView → CameraXViewfinder</h2>

<p>如果你现有的相机代码使用“PreviewView”，则迁移路径如下：</p>

<p><strong>迁移前（旧方法）：</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">OldCameraPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">previewView</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">PreviewView</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">previewView</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="k">get</span><span class="p">()</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="n">preview</span><span class="p">.</span><span class="n">setSurfaceProvider</span><span class="p">(</span><span class="n">previewView</span><span class="p">.</span><span class="n">surfaceProvider</span><span class="p">)</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AndroidView</span><span class="p">(</span>
</span><span class='line'>        <span class="n">factory</span> <span class="p">=</span> <span class="p">{</span> <span class="n">previewView</span> <span class="p">},</span>
</span><span class='line'>        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>迁移后（Compose 原生方法）：</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">NewCameraPreview</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">context</span> <span class="p">=</span> <span class="n">LocalContext</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">lifecycleOwner</span> <span class="p">=</span> <span class="n">LocalLifecycleOwner</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">selector</span> <span class="p">=</span> <span class="n">CameraSelector</span><span class="p">.</span><span class="n">DEFAULT_BACK_CAMERA</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequests</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MutableStateFlow</span><span class="p">&lt;</span><span class="n">SurfaceRequest</span><span class="p">?&gt;(</span><span class="k">null</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">surfaceRequest</span> <span class="k">by</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">collectAsState</span><span class="p">(</span><span class="n">initial</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">LaunchedEffect</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">provider</span> <span class="p">=</span> <span class="n">ProcessCameraProvider</span><span class="p">.</span><span class="n">awaitInstance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">preview</span> <span class="p">=</span> <span class="n">Preview</span><span class="p">.</span><span class="n">Builder</span><span class="p">().</span><span class="n">build</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">setSurfaceProvider</span> <span class="p">{</span> <span class="n">req</span> <span class="p">-&gt;</span> <span class="n">surfaceRequests</span><span class="p">.</span><span class="n">value</span> <span class="p">=</span> <span class="n">req</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">unbindAll</span><span class="p">()</span>
</span><span class='line'>        <span class="n">provider</span><span class="p">.</span><span class="n">bindToLifecycle</span><span class="p">(</span><span class="n">lifecycleOwner</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">preview</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>            <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>            <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关键的思维转变：不再将 View 的“SurfaceProvider”赋予 CameraX，而是将“SurfaceRequest”对象发布到 Compose 状态，并使用“CameraXViewfinder”进行渲染。</p>

<h2>所需依赖项</h2>

<p>添加到你的 <code>build.gradle.kts</code> 中：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">cameraxVersion</span> <span class="p">=</span> <span class="s">&quot;1.5.1&quot;</span><span class="n">dependencies</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-core:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-camera2:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-lifecycle:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-video:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The new Compose-native viewfinder</span>
</span><span class='line'>    <span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.camera:camera-compose:$cameraxVersion&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>清单权限：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.CAMERA&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">&quot;android.permission.RECORD_AUDIO&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2><strong>实现模式（性能 vs. 合成）</strong></h2>

<p><code>CameraXViewfinder</code> 可以通过两种方式渲染预览：</p>

<h3><strong>EXTERNAL（SurfaceView 支持）</strong></h3>

<p>相机帧在其<strong>自己的 Surface</strong> 上渲染，由系统在 Compose 绘制通道<strong>之外</strong>合成。可以想象成“UI 背后的实时视频层”。通常启用硬件叠加 → 最佳性能/延迟。非常适合在标准 UI 后方显示全屏矩形预览。由于它是一个单独的层，因此对<em>相机像素</em>的逐像素效果（复杂的裁剪/模糊）不适用。</p>

<ul>
<li>优点：延迟更低，GPU 负载更少，非常适合全屏预览/录制。</li>
<li>缺点：不受逐像素界面特效（圆角蒙版/模糊）的影响，不会显示在 Compose 屏幕截图中。</li>
</ul>


<h3><strong>嵌入式（TextureView 支持）</strong></h3>

<p>相机帧作为<strong>GPU 纹理</strong>绘制在 Compose 渲染通道<strong>内部</strong>——类似于<strong>可重绘面板</strong>，其行为与其他可组合项类似。你可以获得深度裁剪/蒙版/动画/模糊/Z 轴排序，但代价是 GPU 工作量增加，延迟略高。</p>

<ul>
<li>优点：行为类似于普通界面；裁剪、Alpha 通道、模糊、特殊形状和复杂 Z 轴排序均正常。</li>
<li>缺点：GPU 工作量增加 → 在繁重的界面或中端设备上，延迟/卡顿风险略高。</li>
</ul>


<h3><strong>经验法则</strong></h3>

<ul>
<li>全屏/高性能 → <strong>外部</strong></li>
<li>特殊构图/特效 → <strong>嵌入式</strong>。</li>
</ul>


<p>如果你未指定模式，库将选择一个合理的默认模式。强制使用以下方式：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">androidx.camera.viewfinder.core.ImplementationMode</span>
</span><span class='line'>
</span><span class='line'><span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>    <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">request</span><span class="p">,</span>
</span><span class='line'>    <span class="n">implementationMode</span> <span class="p">=</span> <span class="n">ImplementationMode</span><span class="p">.</span><span class="n">EXTERNAL</span> <span class="c1">// or ImplementationMode.EMBEDDED</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>实际操作中的陷阱</h2>

<p><strong>坐标变换并非可选</strong>
不要将原始 Compose 偏移量传递给测量工厂。务必使用坐标变换器。数学运算看起来很简单，直到你在横屏、可折叠设备或非标准宽高比设备上进行测试。</p>

<p><strong>前置摄像头是镜像的</strong>
如果你正在绘制叠加层或处理拍摄的图像，请记住前置摄像头预览默认是镜像的，但拍摄的图像不是。在你的界面/处理逻辑中考虑到这一点。</p>

<p><strong>在真实设备上测试</strong>
不同 OEM 的相机行为有所不同。在 Pixel 上完美运行的功能在三星或小米上可能存在问题。在代表性硬件上测试你的关键流程。</p>

<p><strong>权限用户体验</strong>
在入口点请求 <code>CAMERA</code>；仅在开始录制时请求 <code>RECORD_AUDIO</code>（这是一种良好做法）。上面的内联 <code>PermissionGate</code> 模式将该逻辑保留在你的 Compose 树中。</p>

<h2>高级功能：可折叠和自适应 UI</h2>

<p>由于 <code>CameraXViewfinder</code> 只是另一个可组合项，因此可折叠支持非常简单。简单的双窗格布局或全屏布局通常就足够了；如果需要，可以使用 <code>AnimatedContent</code> 来在状态之间添加动画。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">AdaptiveCameraScreen</span><span class="p">(</span><span class="n">surfaceRequest</span><span class="p">:</span> <span class="n">SurfaceRequest</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">expanded</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">mutableStateOf</span><span class="p">(</span><span class="k">false</span><span class="p">)</span> <span class="p">}</span> <span class="c1">// pretend this reflects window size/hinge state</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AnimatedContent</span><span class="p">(</span><span class="n">targetState</span> <span class="p">=</span> <span class="n">expanded</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">label</span> <span class="p">=</span> <span class="s">&quot;layout&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">isExpanded</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">isExpanded</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Row</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">)</span>
</span><span class='line'>                            <span class="p">.</span><span class="n">aspectRatio</span><span class="p">(</span><span class="m">9f</span> <span class="p">/</span> <span class="m">16f</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">weight</span><span class="p">(</span><span class="m">1f</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* CameraControls(Modifier.align(Alignment.Center)) */</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Box</span><span class="p">(</span><span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">surfaceRequest</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">CameraXViewfinder</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">surfaceRequest</span> <span class="p">=</span> <span class="n">it</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">modifier</span> <span class="p">=</span> <span class="n">Modifier</span><span class="p">.</span><span class="n">fillMaxSize</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="cm">/* CameraControls(Modifier.align(Alignment.BottomCenter)) */</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>测试清单（实用）</h2>

<ul>
<li>验证纵向/横向以及 <code>ContentScale.Crop/Fit</code> 模式下的点击对焦精度。</li>
<li>测试缩放限制；确保捏合和程序化缩放过渡流畅。</li>
<li>切换摄像头（前/后）并重新验证变换 + 镜像行为。</li>
<li>导航离开/后退、旋转和处理配置更改；预览应能够恢复且不闪烁。</li>
<li>在对焦/缩放时录制视频；确保没有表面掉落。</li>
</ul>


<h2>全局展望</h2>

<p>此版本的重要性不仅在于它带来的功能，还在于它所传递的信息。</p>

<p>多年来，Android 中的相机开发一直感觉像是二等公民。除了相机页面之外，你可以在任何地方使用 Compose 构建现代 UI，而相机页面则需要你勉强才能与 View 进行互操作。虽然 Compose 确实有效，但编写代码时总感觉像是被束缚了一只手。</p>

<p><code>camera-compose</code> 不仅仅是一个新产物。CameraX 团队曾说过：“Compose 现在是一流的相机开发平台。”</p>

<p>这意味着：</p>

<ul>
<li>未来的相机功能将在设计时充分考虑 Compose，而不是对其进行改造。</li>
<li>社区将构建以 Compose 为先的相机库和组件。</li>
<li>最佳实践将围绕可组合相机 UI 不断发展。</li>
<li>文档和示例将反映现代 Android 开发。</li>
</ul>


<p>我们在整个 Android 生态系统中都看到了这种模式——最初以 View 为中心的 API 正在逐渐获得 Compose 原生的对应版本。<code>camera-compose</code> 就是迄今为止最具影响力的例子之一。</p>

<h2>你现在应该做什么</h2>

<p><strong>如果你正在开发一个新的相机功能：</strong>
从一开始就使用 <code>CameraXViewfinder</code>。甚至不需要考虑 <code>PreviewView</code>。它的代码更简洁，思维模型更简单，你以后会感谢自己的。</p>

<p><strong>如果你已经有相机代码：</strong>
将 <code>camera-compose</code> 添加到你的依赖项中，并一次迁移一个页面。从最简单的相机 UI（可能是基本的纯预览页面）开始，熟悉新的 API。然后再处理复杂的部分。</p>

<p><strong>如果你正在构建一个库：</strong>
现在是时候将 Compose 原生相机组件添加到你的 SDK 中了。开发者正在寻找可组合的相机解决方案，而生态系统已经为他们做好了准备。</p>

<h2>延伸阅读</h2>

<ul>
<li><a href="https://developer.android.com/jetpack/androidx/releases/camera">CameraX 发行说明</a> — 官方更新日志和工件</li>
<li><a href="https://developer.android.com/jetpack/androidx/releases/camera-viewfinder">Camera Viewfinder 文档</a> — 实现模式、缩放和对齐</li>
<li><a href="https://github.com/androidx/androidx/tree/androidx-main/camera">CameraX GitHub 示例</a> — 真实代码示例</li>
</ul>


<h2>国王已死 / 国王万岁</h2>

<p>“AndroidView”相机预览的时代已经结束。如果你要在 2025 年及以后构建相机功能，那么你将使用 Compose 来构建它们。现在终于有了可以正确支持这些功能的工具。</p>

<p>现在，甩掉那个“AndroidView”包装器，编写一些漂亮的相机 UI 吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[理解retain{}的内部机制：Jetpack Compose中基于作用域的状态保存]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals/"/>
    <updated>2025-10-22T14:29:55+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Understanding retain{} internals: A Scope-based State Preservation in Jetpack Compose」，原文链接<a href="https://proandroiddev.com/understanding-retain-internals-a-new-way-to-preserve-state-in-jetpack-compose-54471a32fd05">https://proandroiddev.com/understanding-retain-internals-a-new-way-to-preserve-state-in-jetpack-compose-54471a32fd05</a>，由Jaewoong Eum发布于2025年10月15日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/22/understanding-retrain-internals/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*yQo3amM25om4TWkUzgxjvQ.jpeg" title="auto auto" ></a></p>

<!-- more -->


<p>Jetpack Compose 是一种现代 Android UI 开发方式，拥有声明式方法和强大的状态管理原语。虽然 <code>remember{}</code> 能够很好地在重组过程中保存状态，但它有一个根本性的局限性：它无法在配置更改或导航转换后继续生效。引入 <code>retain{}</code>，这是一种在瞬时销毁场景下保存状态的新方法，同时保持可组合性。</p>

<p>在本文中，你将深入了解 <code>retain{}</code>、<code>RetainScope</code>、<code>RetainObserver</code> 和 <code>RetainedEffect</code> 的内部机制，探索它们的底层工作原理，以及使 Retention 既内存安全又性能卓越的优化方法。</p>

<p>如果你尚未阅读以下之前的文章，理解以下部分将对你有所帮助：</p>

<ul>
<li><a href="https://medium.com/proandroiddev/exploring-retain-api-a-new-way-to-persist-state-in-jetpack-compose-bfb2fe2eae43">预览 retain{} API：Jetpack Compose 中持久化状态的新方法</a></li>
<li><a href="https://medium.com/proandroiddev/previewing-retainedeffect-a-new-side-effect-to-bridge-between-composition-and-retention-lifecycles-685b9e543de7">预览 RetainedEffect：桥接 Composition 和 Retention 生命周期的新 Side Effect</a></li>
</ul>


<h2>导入 Compose 运行时 retain 库</h2>

<p>你可以使用以下依赖项导入 Compose 运行时 retain 库：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;androidx.compose.runtime:runtime-retain:1.10.0-alpha05&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意，此库目前处于实验阶段，未来将不断完善和稳定发布。</p>

<h2>理解核心问题：为什么 remember{} 还不够</h2>

<p>从本质上讲，<code>remember{}</code> 可以在单个组合生命周期内跨重组保留状态。但是，当你的 Activity 因配置更改而重新创建时会发生什么？或者当导航目标从返回堆栈中移除时？状态会丢失，你的可组合项会重新开始。</p>

<p>传统的 Android 解决方案涉及 <code>ViewModel</code> 和 <code>SavedStateHandle</code>，但它们本身也具有复杂性：序列化要求、手动状态恢复以及在可组合项层次结构之外管理状态的认知开销。如果我们可以拥有一个像 <code>remember{}</code> 一样工作，但又能在这些瞬时销毁后继续存在的东西，那会怎样？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// With remember: state lost on configuration change</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">remember</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">()</span> <span class="p">}</span> <span class="c1">// Lost on rotation!</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// With retain: state preserved across configuration changes</span>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">()</span> <span class="p">}</span> <span class="c1">// Survives rotation!</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>retain{}</code> 背后的关键洞察是，状态销毁并不总是永久性的。通常，它是暂时的；内容会被重新创建，恢复之前的状态会对我们有利。这就是“RetainScope”发挥作用的地方。</p>

<h2>retain{} API 及其生命周期</h2>

<p>如果你检查 retain 函数签名，会发现它与 <code>remember</code> API 类似，但存在以下区别：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">retain</span><span class="p">(</span><span class="n">noinline</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">retain</span><span class="p">(</span><span class="k">vararg</span> <span class="n">keys</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">noinline</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span>
</span></code></pre></td></tr></table></div></figure>


<p>带有 <code>reified</code> 类型参数的 inline 修饰符无需显式类参数即可实现类型安全的保留。但真正的魔力在于其实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">retainImpl</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">RetainKeys</span><span class="p">,</span> <span class="n">calculation</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span><span class="p">):</span> <span class="n">T</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">retainScope</span> <span class="p">=</span> <span class="n">LocalRetainScope</span><span class="p">.</span><span class="n">current</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">holder</span> <span class="p">=</span> <span class="n">remember</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">retainedValue</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">.</span><span class="n">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">RetainScopeMissingValue</span><span class="p">)</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">retainedValue</span> <span class="p">!==</span> <span class="n">RetainScopeMissingValue</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">RetainedValueHolder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">value</span> <span class="p">=</span> <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span> <span class="p">(</span><span class="n">retainedValue</span> <span class="k">as</span> <span class="n">T</span><span class="p">),</span>
</span><span class='line'>                <span class="n">owner</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">RetainedValueHolder</span><span class="p">(</span>
</span><span class='line'>                <span class="n">key</span> <span class="p">=</span> <span class="n">key</span><span class="p">,</span>
</span><span class='line'>                <span class="n">value</span> <span class="p">=</span> <span class="n">calculation</span><span class="p">(),</span>
</span><span class='line'>                <span class="n">owner</span> <span class="p">=</span> <span class="n">retainScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">holder</span><span class="p">.</span><span class="n">owner</span> <span class="p">!==</span> <span class="n">retainScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">SideEffect</span> <span class="p">{</span> <span class="n">holder</span><span class="p">.</span><span class="n">readoptUnder</span><span class="p">(</span><span class="n">retainScope</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">holder</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>此实现揭示了保留的两个阶段特性：</p>

<p><strong>阶段 1：记忆阶段</strong>。<code>retain{}</code> 首先使用 <code>remember{}</code> 创建一个 <code>RetainedValueHolder</code>。该持有者包装实际值并跟踪其生命周期。</p>

<p><strong>阶段 2：保留阶段</strong>。当持有者离开组合时，<code>RetainScope</code> 不会立即将其丢弃，而是决定是否将其保留以备将来恢复。</p>

<h2>RetainedValueHolder 和 RetainScope</h2>

<p>首先，如果你仔细研究 <code>RetainedValueHolder</code> 的内部代码，你会发现它是生命周期管理发生的地方。它实现了 <code>RememberObserver</code> 接口，以便与 Compose 的生命周期挂钩：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">RetainedValueHolder</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;</span> <span class="k">internal</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">owner</span><span class="p">:</span> <span class="n">RetainScope</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">isNewlyRetained</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RememberObserver</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRemembered</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">isNewlyRetained</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">isNewlyRetained</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>                <span class="n">value</span><span class="p">.</span><span class="n">onRetained</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onEnteredComposition</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onForgotten</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">owner</span><span class="p">.</span><span class="n">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onExitedComposition</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(!</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetired</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAbandoned</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">owner</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetained</span><span class="p">()</span>
</span><span class='line'>            <span class="n">owner</span><span class="p">.</span><span class="n">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">value</span><span class="p">.</span><span class="n">onUnused</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>重要的一点是，该持有者会拦截组合生命周期事件并将其转换为保留事件。当 <code>onForgotten()</code> 被调用时（值离开组合），它会检查 <code>RetainScope</code> 是否保留了已退出的值。如果是，它会保存该值以供将来恢复，而不是丢弃它。</p>

<p><code>RetainScope</code> 是保留系统的核心概念。它管理何时保留值、如何存储它们以及何时恢复或退出它们。让我们来看看它的细节：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">RetainScope</span> <span class="p">:</span> <span class="n">RetainStateProvider</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">var</span> <span class="py">keepExitedValuesRequests</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>        <span class="k">private</span> <span class="k">set</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">final</span> <span class="k">override</span> <span class="k">val</span> <span class="py">isKeepingExitedValues</span><span class="p">:</span> <span class="n">Boolean</span>
</span><span class='line'>        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">keepExitedValuesRequests</span> <span class="p">&gt;</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Any</span><span class="p">?</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">onStartKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>    <span class="k">protected</span> <span class="k">abstract</span> <span class="k">fun</span> <span class="nf">onStopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>作用域有两种运行模式：</p>

<ol>
<li><strong>普通模式</strong> (<code>isKeepingExitedValues = false</code>)：值离开组合时会被丢弃，就像 <code>remember{}</code> 一样。</li>
<li><strong>保留模式</strong> (<code>isKeepingExitedValues = true</code>)：值退出时会被保留，以便将来恢复。</li>
</ol>


<p>那么，保留生命周期是如何运作的呢？通过原始源代码中嵌入的图表可以最好地理解保留生命周期：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>┌──────────────────────┐
</span><span class='line'>│                      │
</span><span class='line'>│ retain<span class="o">(</span>keys<span class="o">)</span> <span class="o">{</span> ... <span class="o">}</span> │
</span><span class='line'>│        ┌────────────┐│
</span><span class='line'>└────────┤  value: T  ├┘
</span><span class='line'>         └──┬─────────┘
</span><span class='line'>            │   ▲
</span><span class='line'>        Exit│   │Enter
</span><span class='line'> composition│   │composition
</span><span class='line'>   or change│   │
</span><span class='line'>        keys│   │                         ┌──────────────────────────┐
</span><span class='line'>            │   ├───No retained value─────┤   calculation: <span class="o">()</span> -&gt; T   │
</span><span class='line'>            │   │   or different keys     └──────────────────────────┘
</span><span class='line'>            │   │                         ┌──────────────────────────┐
</span><span class='line'>            │   └───Re-enter composition──┤    Local RetainScope     │
</span><span class='line'>            │       with the same keys    └─────────────────┬────────┘
</span><span class='line'>            │                                           ▲   │
</span><span class='line'>            │                      ┌─Yes────────────────┘   │ value not
</span><span class='line'>            │                      │                        │ restored and
</span><span class='line'>            │   .──────────────────┴──────────────────.     │ scope stops
</span><span class='line'>            └─▶<span class="o">(</span>   RetainScope.isKeepingExitedValues   <span class="o">)</span>    │ keeping exited
</span><span class='line'>                <span class="sb">`</span>──────────────────┬──────────────────<span class="err">&#39;</span>     │ values
</span><span class='line'>                                   │                        ▼
</span><span class='line'>                                   │      ┌──────────────────────────┐
</span><span class='line'>                                   └─No──▶│     value is retired     │
</span><span class='line'>                                          └──────────────────────────┘
</span></code></pre></td></tr></table></div></figure>


<p>此流程揭示了几个关键的见解：</p>

<ol>
<li><strong>保留是有条件的</strong>：只有当 <code>isKeepingExitedValues</code> 为 <code>true</code> 时，值才会被保留。</li>
<li><strong>键很重要</strong>：即使在保留期间，更改的键也会导致立即退出。</li>
<li><strong>恢复是自动的</strong>：当内容使用相同的键重新输入时，保留的值将被恢复。</li>
<li><strong>退出是最终的</strong>：保留停止时未恢复的值将被退出。</li>
</ol>


<h2>ControlledRetainScope：可变实现</h2>

<p>虽然 <code>RetainScope</code> 提供了抽象，但 <code>ControlledRetainScope</code> 才是主要的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ControlledRetainScope</span> <span class="p">:</span> <span class="n">RetainScope</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">keptExitedValues</span> <span class="p">=</span> <span class="n">SafeMultiValueMap</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">?&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">saveExitingValue</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;UNCHECKED_CAST&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getExitedValueOrDefault</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">Any</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">removeLast</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">defaultIfAbsent</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onStopKeepingExitedValues</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">forEachValue</span> <span class="p">{</span> <span class="n">value</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="n">value</span><span class="p">.</span><span class="n">onRetired</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">keptExitedValues</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该实现使用 <code>SafeMultiValueMap</code> 进行存储是一个重要的设计选择。为什么？因为多个 retain 调用可以具有相同的键：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">Example</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Both have the same positional key!</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value1</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="s">&quot;First&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">value2</span> <span class="p">=</span> <span class="n">retain</span> <span class="p">{</span> <span class="s">&quot;Second&quot;</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该映射按 LIFO（后进先出）顺序存储每个键的值。恢复时，<code>removeLast()</code> 确保值按其存储的相反顺序恢复，从而保持 retain 调用与其值之间的正确配对。</p>

<p>此外，<code>ControlledRetainScope</code> 支持嵌套在父级 <code>RetainStateProvider</code> 下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">setParentRetainStateProvider</span><span class="p">(</span><span class="n">parent</span><span class="p">:</span> <span class="n">RetainStateProvider</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">oldParent</span> <span class="p">=</span> <span class="n">parentScope</span>
</span><span class='line'>    <span class="n">parentScope</span> <span class="p">=</span> <span class="n">parent</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">parent</span><span class="p">.</span><span class="n">addRetainStateObserver</span><span class="p">(</span><span class="n">parentObserver</span><span class="p">)</span>
</span><span class='line'>    <span class="n">oldParent</span><span class="p">.</span><span class="n">removeRetainStateObserver</span><span class="p">(</span><span class="n">parentObserver</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">oldParent</span><span class="p">.</span><span class="n">isKeepingExitedValues</span><span class="p">)</span> <span class="n">stopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这支持有序的层次结构，其中子作用域从父级继承保留状态。你可以利用此功能使所有 <code>RetainScopes</code> 在配置更改期间保留，根作用域会检测到配置更改，并沿层次结构向下级联保留。</p>

<h2>RetainObserver：保留对象的生命周期回调</h2>

<p>需要了解其保留生命周期的对象需要实现 <code>RetainObserver</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Suppress</span><span class="p">(</span><span class="s">&quot;CallbackName&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">public</span> <span class="n">interface</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Successfully retained</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onEnteredComposition</span><span class="p">()</span> <span class="c1">// Entered composition</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onExitedComposition</span><span class="p">()</span>  <span class="c1">// Exited composition</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// No longer retained</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">onUnused</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Created but never used</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些回调实现了 <code>remember{}</code> 无法实现的资源管理模式。设想一个媒体播放器，当屏幕未显示时应该暂停，但如果可能再次显示，则不应释放资源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">RetainableMediaPlayer</span> <span class="p">:</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">player</span><span class="p">:</span> <span class="n">MediaPlayer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="n">MediaPlayer</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onEnteredComposition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">play</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onExitedComposition</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">pause</span><span class="p">()</span> <span class="c1">// Just pause, don&#39;t release</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">release</span><span class="p">()</span> <span class="c1">// Now we can release</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onUnused</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Never entered composition, clean up</span>
</span><span class='line'>        <span class="n">player</span><span class="o">?.</span><span class="n">release</span><span class="p">()</span>
</span><span class='line'>        <span class="n">player</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>还应记住，回调遵循严格的顺序保证。当多个 <code>RetainObserver</code> 同时进入组合状态时，它们的 <code>onEnteredComposition</code> 回调将按顺序触发。退出时，<code>onExitedComposition</code> 将按相反顺序触发<strong>，</strong>以确保正确清理嵌套资源。</p>

<h2>RememberObserver 限制</h2>

<p>你可以在 <code>RetainedValueHolder</code> 中找到一个有趣的安全检查：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="k">is</span> <span class="n">RememberObserver</span> <span class="p">&amp;&amp;</span> <span class="n">value</span> <span class="p">!</span><span class="k">is</span> <span class="n">RetainObserver</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">IllegalArgumentException</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;Retained a value that implements RememberObserver but not RetainObserver. &quot;</span> <span class="p">+</span>
</span><span class='line'>            <span class="s">&quot;To receive the correct callbacks, the retained value &#39;$value&#39; must also &quot;</span> <span class="p">+</span>
</span><span class='line'>            <span class="s">&quot;implement RetainObserver.&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>为什么有这个限制？<code>RememberObserver</code> 回调（<code>onRemembered</code>、<code>onForgotten</code>、<code>onAbandoned</code>）与保留语义不一致。暂时脱离组合的保留值不会被“遗忘”，而是处于不确定状态，可能会再次返回。使用 <code>RememberObserver</code> 会导致错误的生命周期回调，因此库强制使用 <code>RetainObserver</code>。</p>

<h2>RetainedEffect：保留后仍存在的副作用</h2>

<p><code>RetainedEffect</code> 将保留的概念扩展到副作用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainedEffect</span><span class="p">(</span><span class="n">key1</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">effect</span><span class="p">:</span> <span class="n">RetainedEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">RetainedEffectResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">retain</span><span class="p">(</span><span class="n">key1</span><span class="p">)</span> <span class="p">{</span> <span class="n">RetainedEffectImpl</span><span class="p">(</span><span class="n">effect</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">class</span> <span class="nc">RetainedEffectImpl</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">effect</span><span class="p">:</span> <span class="n">RetainedEffectScope</span><span class="p">.()</span> <span class="p">-&gt;</span> <span class="n">RetainedEffectResult</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">RetainObserver</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">onRetire</span><span class="p">:</span> <span class="n">RetainedEffectResult</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetained</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">=</span> <span class="n">InternalRetainedEffectScope</span><span class="p">.</span><span class="n">effect</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRetired</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">onRetire</span><span class="o">?.</span><span class="n">retire</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Other callbacks are no-ops</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现非常简单：它将 effect 包装在一个 <code>RetainObserver</code> 中，该 <code>RetainObserver</code> 在保留时执行 effect，并在退出时进行清理。与 DisposableEffect 不同，DisposableEffect 在离开组合时运行其处置，而 RetainedEffect 仅在真正退出时处置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">VideoPlayer</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">player</span> <span class="p">=</span> <span class="n">retain</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">)</span> <span class="p">{</span> <span class="n">MediaPlayer</span><span class="p">(</span><span class="n">mediaUri</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// DisposableEffect would dispose on every hide/show</span>
</span><span class='line'>    <span class="c1">// RetainedEffect only disposes when truly done</span>
</span><span class='line'>    <span class="n">RetainedEffect</span><span class="p">(</span><span class="n">player</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">player</span><span class="p">.</span><span class="n">initialize</span><span class="p">()</span>
</span><span class='line'>        <span class="n">onRetire</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">player</span><span class="p">.</span><span class="n">close</span><span class="p">()</span> <span class="c1">// Only called when player is retired</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一个很好的例子，说明在短暂的 UI 变化期间不应重新创建昂贵的资源。</p>

<h2>RetainedContentHost 和 RetainScopeHolder</h2>

<p><code>compose-runtime-retain</code> 库提供了基于这些原语构建的更高级别的抽象。<code>RetainedContentHost</code> 管理显示/隐藏场景：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Composable</span>
</span><span class='line'><span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainedContentHost</span><span class="p">(</span><span class="n">active</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">retainScope</span> <span class="p">=</span> <span class="n">retainControlledRetainScope</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span><span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">retainScope</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">composer</span> <span class="p">=</span> <span class="n">currentComposer</span>
</span><span class='line'>        <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">retainScope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">cancellationHandle</span> <span class="p">=</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">retainScope</span><span class="p">.</span><span class="n">keepExitedValuesRequestsFromSelf</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">composer</span><span class="p">.</span><span class="n">scheduleFrameEndCallback</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">retainScope</span><span class="p">.</span><span class="n">stopKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">null</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cancellationHandle</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>                <span class="n">retainScope</span><span class="p">.</span><span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>该实现揭示了一些时间控制：</p>

<p><strong>变为活动状态</strong>：安排在帧结束时停止保留，确保所有内容都首先恢复其值。</p>

<p><strong>变为非活动状态</strong>：在内容被移除之前立即开始保留。</p>

<p>这确保了值在需要时被准确保留，不会太早（这会阻止恢复），也不会太晚（这会丢失值）。</p>

<p>对于列表等动态内容，<code>RetainScopeHolder</code> 负责管理每个项目的保留：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">RetainScopeHolder</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">childScopes</span> <span class="p">=</span> <span class="n">MutableScatterMap</span><span class="p">&lt;</span><span class="n">Any</span><span class="p">?,</span> <span class="n">ControlledRetainScope</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">getOrCreateRetainScopeForChild</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?):</span> <span class="n">RetainScope</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">childScopes</span><span class="p">.</span><span class="n">getOrPut</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ControlledRetainScope</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">isParentKeepingExitedValues</span><span class="p">)</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">fun</span> <span class="nf">RetainScopeProvider</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?,</span> <span class="n">content</span><span class="p">:</span> <span class="n">@Composable</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span>
</span><span class='line'>            <span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">getOrCreateRetainScopeForChild</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">content</span><span class="p">()</span>
</span><span class='line'>            <span class="n">PresenceIndicator</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">PresenceIndicator</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">Any</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">composer</span> <span class="p">=</span> <span class="n">currentComposer</span>
</span><span class='line'>        <span class="n">DisposableEffect</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">endRetainHandle</span> <span class="p">=</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">keepExitedValuesRequestsFor</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">composer</span><span class="p">.</span><span class="n">scheduleFrameEndCallback</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">stopKeepingExitedValues</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">null</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="n">onDispose</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">endRetainHandle</span><span class="o">?.</span><span class="n">cancel</span><span class="p">()</span>
</span><span class='line'>                <span class="n">startKeepingExitedValues</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>PresenceIndicator</code> 可组合项是一种巧妙的模式。它按组合顺序放置在内容<strong>之后</strong>，以确保正确的生命周期管理。移除时，它会触发保留。添加时，它会安排在帧完成后停止保留。</p>

<h2>内存和性能考量</h2>

<p>该实现中进行了值得理解的权衡：</p>

<p><strong>内存优先于 CPU</strong>：保留值在内存中保留的时间比 <code>remember{}</code> 更长。这用内存换取了重新创建时的 CPU 开销。对于开销较大的对象（例如位图、媒体播放器），这通常是值得的。</p>

<p><strong>O(n) 范围操作</strong>：查找要恢复或退出的值需要迭代存储的值。对于包含数十个保留值的典型用例，这可以忽略不计。</p>

<p><strong>惰性分配</strong>：仅在需要时分配缓冲区和存储空间。未使用的 <code>RetainScope</code> 开销极小。</p>

<p><strong>通过具体化实现类型安全</strong>：内联/具体化模式消除了运行时类型检查的需要，同时保持了类型安全。</p>

<p><strong>默认为组合范围</strong>：与 ViewModel（应用范围）或 rememberSaveable（Activity范围）不同，retain 是组合范围的，可以对保留边界进行细粒度的控制。</p>

<p>另外，需要注意的是，不要将长期存活的对象保留在其预期作用域之外，以免造成内存泄漏，正如 Compose 库中的以下注释所示。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * 重要提示：保留值的保存时间比其所关联的可组合项的生命周期长。</span>
</span><span class='line'><span class="cm"> * 如果保留对象的保存时间超过其预期的</span>
</span><span class='line'><span class="cm"> * 生命周期，则可能导致内存泄漏。请谨慎选择保留的数据类型。切勿保留 Android 上下文或</span>
</span><span class='line'><span class="cm"> * 直接或间接引用上下文（包括视图）的对象。</span>
</span><span class='line'><span class="cm"> */</span>
</span></code></pre></td></tr></table></div></figure>


<h2>测试保留机制</h2>

<p>一个有趣的<a href="https://github.com/androidx/androidx/blob/942319dfe9d751390febcef640d43290886f1a0b/compose/runtime/runtime-retain/src/commonTest/kotlin/androidx/compose/runtime/retain/RetainTests.kt#L866">内部单元测试用例</a> 表明，该库可以处理边缘情况并保证：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">retain_duplicateRetainKeys</span><span class="p">()</span> <span class="p">=</span> <span class="n">compositionTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">scope</span> <span class="p">=</span> <span class="n">ControlledRetainScope</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span> <span class="n">startKeepingExitedValues</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">showContent</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">compose</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CompositionLocalProvider</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="n">LocalRetainScope</span> <span class="n">provides</span> <span class="n">scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">showContent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// All have same key!</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>                <span class="n">retain</span> <span class="p">{</span> <span class="n">CountingRetainObject</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Hide and show content</span>
</span><span class='line'>    <span class="n">showContent</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>    <span class="n">recomposeScope</span><span class="p">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span class='line'>    <span class="n">advance</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">showContent</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>    <span class="n">recomposeScope</span><span class="p">.</span><span class="n">invalidate</span><span class="p">()</span>
</span><span class='line'>    <span class="n">advance</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// All values correctly restored despite duplicate keys</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>测试验证了即使存在重复的键（在循环或生成的内容中很常见），值也能通过后进先出 (LIFO) 顺序与其保留调用正确配对。</p>

<h2>结论</h2>

<p>在本文中，我们探索了 <code>retain{}</code>、<code>RetainScope</code>、<code>RetainObserver</code> 和 <code>RetainedEffect</code> API 的工作原理及其内部机制。了解这些内部机制有助于我们更好地决定何时使用 <code>retain{}</code>、<code>remember{}</code> 和 <code>rememberSaveable{}</code>，如何构建保留资源，以及预期的性能特征。</p>

<p>无论是构建可旋转的视频播放器、保留滚动位置的导航系统，还是在配置更改后保持状态的复杂表单，<code>retain{}</code> 都能在 Jetpack Compose 中提供基于作用域的状态保存功能。</p>

<p>如果你想了解最新的技能、新闻、技术文章、面试问题和实用代码技巧，请查看 <a href="https://github.com/doveletter/">Dove Letter</a>。如果你想深入了解面试准备，千万不要错过终极 Android 面试指南：<a href="https://www.android.skydoves.me/">Manifest Android Interview</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Kotlin互斥锁(Mutex)：协程的线程安全守护神]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex/"/>
    <updated>2025-10-15T15:05:51+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Kotlin Mutex: Thread-Safe Concurrency for Coroutines」，原文链接<a href="https://carrion.dev/en/posts/kotlin-mutex-concurrency-guide/">https://carrion.dev/en/posts/kotlin-mutex-concurrency-guide/</a>，由Ignacio Carrión发布于2025年10月3日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/15/kotlin-mutex/"><img src="file:///Users/alexhilton/Downloads/kotlin_mutex.webp" title="auto auto" ></a></p>

<!-- more -->


<p>使用 Kotlin 协程构建并发应用程序时，保护共享的可变状态至关重要。虽然传统的 Java 同步工具（例如 <code>synchronized</code> 块和 <code>ReentrantLock</code>）可以正常工作，但它们会阻塞线程，并且与协程的挂起模型不兼容。因此，引入 <code>Mutex</code>——一个协程友好的同步原语，它提供互斥而不阻塞线程。</p>

<p>本指南探讨了何时使用 Mutex、最佳实践以及它与其他并发控制机制的比较。</p>

<h2>TL;DR：省流版本的建议</h2>

<ul>
<li>当需要保护多个协程访问的共享可变状态时，请使用 <code>Mutex</code>。</li>
<li>在协程代码中，优先使用 <code>Mutex</code> 而不是 <code>synchronized</code>，以避免阻塞线程。</li>
<li>使用 <code>mutex.withLock { }</code> 自动获取和释放锁。</li>
<li>对于更复杂的状态管理场景，请考虑使用 <code>Actor</code> 或 <code>StateFlow</code>。</li>
<li>对于简单的计数器，请改用 <code>AtomicInteger</code> 或 <code>AtomicReference</code>。</li>
<li>如果需要将并发访问限制为多个许可，请使用 <code>Semaphore</code>。</li>
<li>如果不使用 <code>withLock</code>，请始终在 finally 块中释放锁。</li>
</ul>


<h2>什么是互斥锁？</h2>

<p><code>Mutex</code>（互斥）是 <code>kotlinx.coroutines</code> 中的同步原语，用于确保同一时间只有一个协程可以执行临界区。与阻塞线程的传统锁不同，Mutex 会暂停协程，从而使线程可以自由地执行其他工作。</p>

<p>基本结构：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.sync.Mutex</span>
</span><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.sync.withLock</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">protectedOperation</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Critical section - only one coroutine at a time</span>
</span><span class='line'>        <span class="c1">// Modify shared state safely here</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关键特性：</p>

<ul>
<li>非阻塞：暂停协程而不是阻塞线程</li>
<li>公平：默认按先进先出顺序授予访问权限</li>
<li>不重入安全：持有锁的协程无法再次获取锁（防止死锁）</li>
<li>轻量级：比线程阻塞锁更高效</li>
</ul>


<h2>互斥锁的核心用例</h2>

<p>最常见的用例——确保对共享变量的安全访问：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">CounterService</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">++</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getCount</span><span class="p">():</span> <span class="n">Int</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 协调资源访问</h3>

<p>当多个协程需要对某个资源进行独占访问时：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">FileWriter</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">file</span><span class="p">:</span> <span class="n">File</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">appendLine</span><span class="p">(</span><span class="n">line</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">file</span><span class="p">.</span><span class="n">appendText</span><span class="p">(</span><span class="s">&quot;$line\n&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3.确保顺序执行</h3>

<p>即使操作是并发触发的，也必须按顺序执行：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">OrderProcessor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">orders</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">Order</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">processOrder</span><span class="p">(</span><span class="n">order</span><span class="p">:</span> <span class="n">Order</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Ensure orders are processed sequentially</span>
</span><span class='line'>            <span class="n">orders</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>            <span class="n">validateOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>            <span class="n">persistOrder</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. 线程安全的延迟初始化</h3>

<p>在挂起上下文中实现线程安全的延迟初始化：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">DatabaseConnection</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">connection</span><span class="p">:</span> <span class="n">Connection</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getConnection</span><span class="p">():</span> <span class="n">Connection</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">connection</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">connection</span><span class="o">!!</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Double-check inside lock</span>
</span><span class='line'>            <span class="n">connection</span> <span class="o">?:</span> <span class="n">createConnection</span><span class="p">().</span><span class="n">also</span> <span class="p">{</span> <span class="n">connection</span> <span class="p">=</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">createConnection</span><span class="p">():</span> <span class="n">Connection</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="c1">// Simulate connection setup</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">Connection</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>最佳实践</h2>

<h3>1. 始终使用 withLock</h3>

<p>即使发生异常，withLock 也会自动处理锁的获取和释放：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ✅ Good: Automatic cleanup</span>
</span><span class='line'><span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dangerousOperation</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ❌ Bad: Manual management, error-prone</span>
</span><span class='line'><span class="n">mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
</span><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">dangerousOperation</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 保持临界区较小</h3>

<p>尽量减少锁的持有时间以减少争用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ✅ Good: Lock only for critical section</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">validated</span> <span class="p">=</span> <span class="n">validateName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">// Outside lock</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userCache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">validated</span> <span class="c1">// Only this needs protection</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">notifyObservers</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span> <span class="c1">// Outside lock</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ❌ Bad: Holding lock during slow operations</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUserSlow</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">validated</span> <span class="p">=</span> <span class="n">validateName</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="c1">// Slow operation inside lock</span>
</span><span class='line'>        <span class="n">userCache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">validated</span>
</span><span class='line'>        <span class="n">notifyObservers</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span> <span class="c1">// I/O inside lock</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. 避免嵌套锁</h3>

<p>互斥锁不可重入。避免两次获取同一个锁：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ❌ Bad: Deadlock!</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">problematic</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">helperFunction</span><span class="p">()</span> <span class="c1">// Tries to acquire mutex again</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">helperFunction</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Will suspend forever</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ✅ Good: Restructure to avoid nesting</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">better</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">helperFunctionUnsafe</span><span class="p">()</span> <span class="c1">// No lock acquisition</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">helperFunctionUnsafe</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Assumes caller holds lock</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. 优先考虑无锁替代方案</h3>

<p>对于简单操作，原子类型速度更快：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ✅ Better for simple counters</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">()</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="k">get</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ❌ Overkill for a simple counter</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">counter</span><span class="p">++</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>5.文档锁不变量</h3>

<p>明确锁保护的对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserCache</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span> <span class="c1">// Protects userMap and lastUpdate</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">userMap</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">lastUpdate</span> <span class="p">=</span> <span class="m">0L</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">userMap</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="n">lastUpdate</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">currentTimeMillis</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>互斥锁 vs. 其他同步方法</h2>

<h3>互斥锁 vs. synchronized</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Traditional synchronized (blocks thread)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">SynchronizedCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">count</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Synchronized</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">count</span><span class="p">++</span> <span class="c1">// Thread blocked while waiting</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Mutex (suspends coroutine)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">count</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">count</span><span class="p">++</span> <span class="c1">// Coroutine suspended, thread free</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>何时该用哪个：</strong></p>

<ul>
<li>对于非暂停代码和旧版 Java 互操作，请使用 <code>synchronized</code></li>
<li>对于暂停函数和基于协程的代码，请使用 <code>Mutex</code></li>
<li>在协程上下文中，<code>Mutex</code> 效率更高，因为线程不会被阻塞</li>
</ul>


<h3>互斥锁 vs. 信号量</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Only one coroutine at a time</span>
</span><span class='line'><span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Semaphore: N coroutines at a time</span>
</span><span class='line'><span class="k">val</span> <span class="py">semaphore</span> <span class="p">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="n">permits</span> <span class="p">=</span> <span class="m">3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Example: Rate limiting API calls</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ApiClient</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">semaphore</span> <span class="p">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="m">5</span><span class="p">)</span> <span class="c1">// Max 5 concurrent requests</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">makeRequest</span><span class="p">(</span><span class="n">endpoint</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">semaphore</span><span class="p">.</span><span class="n">withPermit</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>何时使用谁：</strong></p>

<ul>
<li>需要独占访问（单次许可）时使用 <code>Mutex</code></li>
<li>需要将并发限制为 N 个操作时使用 <code>Semaphore</code></li>
</ul>


<h3>互斥锁 vs. Actor</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Manual synchronization</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexBasedCache</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">=</span> <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">value</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Actor: Message-based synchronization</span>
</span><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">CacheMessage</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Get</span><span class="p">(</span><span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">response</span><span class="p">:</span> <span class="n">CompletableDeferred</span><span class="p">&lt;</span><span class="n">Data</span><span class="p">?&gt;)</span> <span class="p">:</span> <span class="n">CacheMessage</span><span class="p">()</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Put</span><span class="p">(</span><span class="k">val</span> <span class="py">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="k">val</span> <span class="py">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">:</span> <span class="n">CacheMessage</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">CoroutineScope</span><span class="p">.</span><span class="n">cacheActor</span><span class="p">()</span> <span class="p">=</span> <span class="n">actor</span><span class="p">&lt;</span><span class="n">CacheMessage</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">msg</span> <span class="k">in</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">Get</span> <span class="p">-&gt;</span> <span class="n">msg</span><span class="p">.</span><span class="n">response</span><span class="p">.</span><span class="n">complete</span><span class="p">(</span><span class="n">cache</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">key</span><span class="p">])</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">Put</span> <span class="p">-&gt;</span> <span class="n">cache</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>何时使用谁：</strong></p>

<ul>
<li>使用 <code>Mutex</code> 进行直接方法调用的简单同步</li>
<li>对于复杂的状态机或需要消息队列时，使用 <code>Actor</code></li>
<li>Actor 提供更好的封装性，并且可以处理背压</li>
</ul>


<h3>Mutex 与 StateFlow</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Mutex: Imperative state management</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MutexState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">state</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">state</span> <span class="p">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// StateFlow: Reactive state management</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FlowState</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_state</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_state</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">updateState</span><span class="p">(</span><span class="n">transform</span><span class="p">:</span> <span class="p">(</span><span class="n">Int</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_state</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">transform</span><span class="p">)</span> <span class="c1">// Thread-safe built-in</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>何时使用哪个：</strong></p>

<ul>
<li>需要自定义同步逻辑时使用 <code>Mutex</code></li>
<li>使用 <code>StateFlow</code> 进行内置线程安全的可观察状态</li>
<li><code>StateFlow</code> 更适合 UI 状态和响应式架构</li>
</ul>


<h3>Mutex 与原子类型</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// AtomicInteger: Lock-free for simple operations</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AtomicCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">AtomicInteger</span><span class="p">(</span><span class="m">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">incrementAndGet</span><span class="p">()</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">addAndGet</span><span class="p">(</span><span class="n">delta</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">=</span> <span class="n">counter</span><span class="p">.</span><span class="n">addAndGet</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Mutex: For complex operations</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ComplexCounter</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">counter</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">history</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">increment</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">++</span>
</span><span class='line'>            <span class="n">history</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="c1">// Multiple operations</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>何时使用哪个：</strong></p>

<ul>
<li>使用原子类型进行单变量操作（计数器、标志）</li>
<li>需要协调多个变量时使用 <code>Mutex</code></li>
<li>原子操作速度更快，但受限于特定操作</li>
</ul>


<h2>常见陷阱</h2>

<h3>1. 忘记使用 suspend</h3>

<p>互斥操作需要暂停：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ❌ Won&#39;t compile</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">broken</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="p">}</span> <span class="c1">// Error: suspend function called in non-suspend context</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ✅ Correct</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">correct</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2. 长时间操作期间持有锁</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ❌ Bad: Holding lock during I/O</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">bad</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="c1">// Network call inside lock</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ✅ Good: Fetch outside lock</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">good</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">data</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">cache</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="p">=</span> <span class="n">data</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>3. 假设可重入</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ❌ Deadlock: Mutex is not reentrant</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">outer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">inner</span><span class="p">()</span> <span class="c1">// Deadlock!</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">inner</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Never reached</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4. 不处理取消</h3>

<p>持有锁时务必考虑取消：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// ✅ Good: withLock handles cancellation</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">proper</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doWork</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span> <span class="c1">// Lock released even on cancellation</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ❌ Risky: Manual lock management</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">risky</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">mutex</span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doWork</span><span class="p">()</span> <span class="c1">// If cancelled here, lock stays acquired</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">unlock</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>性能考量</h2>

<ul>
<li><strong>互斥 vs. synchronized</strong>：在协程密集型代码中，互斥更高效，因为线程不会被阻塞</li>
<li><strong>争用</strong>：高争用会降低性能；考虑分片（为不同的键设置多个锁）</li>
<li><strong>锁粒度</strong>：更细粒度的锁（更多锁，每个锁保护更少的数据）可减少争用</li>
<li><strong>无锁替代方案</strong>：对于简单操作，原子类型和 <code>StateFlow</code> 速度更快</li>
</ul>


<p>示例：分片以减少争用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">ShardedCache</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">shardCount</span><span class="p">:</span> <span class="n">Int</span> <span class="p">=</span> <span class="m">16</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutexes</span> <span class="p">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">shardCount</span><span class="p">)</span> <span class="p">{</span> <span class="n">Mutex</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">caches</span> <span class="p">=</span> <span class="n">Array</span><span class="p">(</span><span class="n">shardCount</span><span class="p">)</span> <span class="p">{</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Data</span><span class="p">&gt;()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">=</span> <span class="n">key</span><span class="p">.</span><span class="n">hashCode</span><span class="p">()</span> <span class="n">and</span> <span class="p">(</span><span class="n">shardCount</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">put</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">index</span> <span class="p">=</span> <span class="n">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="n">mutexes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">caches</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="p">=</span> <span class="n">value</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">get</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Data</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">index</span> <span class="p">=</span> <span class="n">shardIndex</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mutexes</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">caches</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>真实示例：线程安全的Repository</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserRepository</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">api</span><span class="p">:</span> <span class="n">UserApi</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">database</span><span class="p">:</span> <span class="n">UserDatabase</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">User</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">userId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span><span class="p">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Check cache first (read lock)</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="k">return</span> <span class="n">it</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Try database (outside lock)</span>
</span><span class='line'>        <span class="n">database</span><span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">user</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Fetch from API (outside lock)</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">fetchUser</span><span class="p">(</span><span class="n">userId</span><span class="p">)</span>
</span><span class='line'>            <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">cache</span><span class="p">[</span><span class="n">userId</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>                <span class="n">database</span><span class="p">.</span><span class="n">insertUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">user</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">e</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">null</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">updateUser</span><span class="p">(</span><span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">[</span><span class="n">user</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="p">=</span> <span class="n">user</span>
</span><span class='line'>            <span class="n">database</span><span class="p">.</span><span class="n">updateUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">clearCache</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">cache</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>测试互斥锁保护的代码</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">concurrent</span> <span class="n">increments</span> <span class="n">should</span> <span class="n">be</span> <span class="n">thread</span><span class="p">-</span><span class="n">safe</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">counter</span> <span class="p">=</span> <span class="n">CounterService</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Launch 1000 concurrent increments</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">jobs</span> <span class="p">=</span> <span class="n">List</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">counter</span><span class="p">.</span><span class="n">increment</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">jobs</span><span class="p">.</span><span class="n">joinAll</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Should be exactly 1000</span>
</span><span class='line'>    <span class="n">assertEquals</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span> <span class="n">counter</span><span class="p">.</span><span class="n">getCount</span><span class="p">())</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">mutex</span> <span class="n">prevents</span> <span class="n">race</span> <span class="n">conditions</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">cache</span> <span class="p">=</span> <span class="n">mutableMapOf</span><span class="p">&lt;</span><span class="n">String</span><span class="p">,</span> <span class="n">Int</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">mutex</span> <span class="p">=</span> <span class="n">Mutex</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Simulate race condition</span>
</span><span class='line'>    <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">repeat</span><span class="p">(</span><span class="m">100</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">mutex</span><span class="p">.</span><span class="n">withLock</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">val</span> <span class="py">current</span> <span class="p">=</span> <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">]</span> <span class="o">?:</span> <span class="m">0</span>
</span><span class='line'>                    <span class="n">delay</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c1">// Simulate work</span>
</span><span class='line'>                    <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="n">current</span> <span class="p">+</span> <span class="m">1</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertEquals</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="n">cache</span><span class="p">[</span><span class="s">&quot;key&quot;</span><span class="p">])</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>总结</h2>

<p><code>Mutex</code> 是一个强大的工具，用于在基于协程的应用程序中保护共享可变状态。它提供线程安全的同步，而不会阻塞线程，使其成为并发协程代码的理想选择。</p>

<p><strong>关键要点</strong>：</p>

<ul>
<li>使用 <code>withLock</code> 进行自动锁管理</li>
<li>保持临界区简洁高效</li>
<li>适当时考虑更简单的替代方案（例如原子操作、StateFlow）</li>
<li>了解何时使用 Mutex 而非其他同步原语</li>
<li>始终妥善处理取消操作</li>
</ul>


<p>记住：最好的同步就是没有同步。尽可能地，设计系统时，通过使用不可变数据结构、消息传递（Actors/Channels）或响应式流（Flow/StateFlow）来完全避免共享可变状态。但是，当你在协程代码中确实需要互斥时，<code>Mutex</code> 是你的最佳选择。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[突破速度障碍：非阻塞启动画面如何将Android 应用启动时间缩短90%]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash/"/>
    <updated>2025-10-14T14:41:32+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Breaking the Speed Barrier: How Non-Blocking Splash Screens Cut Android App Launch Time by 90%」，原文链接<a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90">https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90</a>，由Sankalp Chauhan发布于2025年9月28日。</p></blockquote>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#overview">概述</a></h2>

<p>正值佳节期间，我们在每个应用上都能看到精美的启动画面和自定义徽标。在开发这些应用时，每个 Android 开发者都会面临启动画面的困境：用户期望获得美观且品牌化的启动体验，但 Google 原生的启动画面 API 却存在明显的局限性。创建自定义 <strong>SplashActivity</strong> 的常见解决方案看似合理，但却会引入隐藏的性能损失，导致应用运行缓慢且响应迟钝。</p>

<p><a href="https://alexhilton.github.io/blog/2025/10/14/non-blocking-splash/"><img src="https://sankalpchauhan.com/2db6f13d4b8881938f2fccacd47ff90b/untitled-design-1-.mp4.gif" title="auto auto" ></a></p>

<!-- more -->


<p>为了应对这一挑战，我开发了一个名为<strong>EventSplash</strong>的测试库，该库实现了一种非阻塞启动画面方法。完整的实现和基准测试代码可在 GitHub 上获取：<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment">fast-splash-experiment</a>（链接：<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E3%80%82">https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E3%80%82</a></p>

<p>本案例研究通过一项对照实验，比较了传统的基于活动的启动画面和创新的基于视图的启动画面方法，并提供了实证证据。使用<strong>保守的同类比较</strong>，结果显示：<strong>页面加载时间缩短 90%</strong>，<strong>首次内容绘制时间提升 78%</strong>，<strong>完全绘制时间缩短 41%</strong>。</p>

<p>我们将探索 Lottie 等复杂动画可能带来的显著优势，同时明确并发处理的利弊权衡和资源成本。</p>

<ul>
<li><strong>首次内容绘制 (FCP)</strong>：屏幕上出现第一个有意义内容的时间</li>
<li><strong>完全绘制时间 (FPT)</strong>：屏幕完全渲染并可交互的时间</li>
<li><strong>冷启动</strong>：应用在进程未运行时启动（性能影响最大）</li>
<li><strong>卡顿</strong>：用户认为性能不佳的卡顿或掉帧</li>
<li><strong>TTID/TTFD</strong>：初始显示时间/完全绘制时间（Android 官方指标）</li>
<li><strong>内存压力</strong>：可用内存极低时的系统状态</li>
<li><strong>低内存终止程序 (LMK)</strong>：在内存压力下终止进程的 Android 守护进程</li>
<li><strong>Choreographer.doFrame</strong>：Android 的帧协调系统，用于管理动画、输入和绘制</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-problem-statement">问题声明</a></h3>

<p>Google 原生的 Android 12+ SplashScreen API 性能出色，但自定义选项有限 <a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>。它不支持：</p>

<ul>
<li>视频背景</li>
<li>Lottie 动画</li>
<li>复杂的品牌元素</li>
<li>促销/活动期间的促销内容</li>
<li>自定义过渡效果</li>
</ul>


<p>这迫使开发者不得不进行自定义实现，通常使用专用的“SplashActivity”。虽然这种方法提供了创作自由，但它会创建一个<strong>阻塞序列</strong>，从而延迟应用主内容的显示。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-traditional-splash-activities-hurt-performance">为什么传统的闪屏活动会损害性能</a></h3>

<p>Android 文档强调，应用应该针对冷启动进行优化，因为这“也可以提高温启动和热启动的性能”<a href="https://developer.android.com/topic/performance/vitals/launch-time">[2]</a>。然而，传统的闪屏实现方式违背了这一原则。</p>

<p>当你使用单独的“SplashActivity”时，系统必须：</p>

<ol>
<li>创建并初始化启动画面 Activity</li>
<li>扩展启动画面视图</li>
<li>运行启动画面动画直至完成</li>
<li>销毁启动画面 Activity</li>
<li>创建并初始化主 Activity</li>
<li>扩展主内容视图</li>
</ol>


<p>这种顺序流程意味着你的主内容在启动画面完成之前无法开始加载，这是一个影响用户感知性能的根本架构缺陷。</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-journey-exploring-different-approaches">折腾：探索不同的方法</a></h2>

<p>在最终确定 EventSplash 实现方案之前，我探索了几种方法。了解这些探索为最终的设计决策提供了宝贵的背景，并展示了性能优化的迭代本质。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#discarded-approach-the-translucent-activity-overlay">弃用的方法：半透明 Activity 覆盖</a></h3>

<p>最初的想法是使用带有半透明主题的“SplashActivity”覆盖“MainActivity”。理论上，MainActivity 可以在后台加载，而启动画面则显示在最上面。</p>

<p><strong>启动顺序：</strong></p>

<ol>
<li>应用以具有半透明主题的 SplashActivity 启动</li>
<li>SplashActivity 显示在 MainActivity 之上，但不会完全遮挡 MainActivity</li>
<li>短暂延迟或初始化完成后，SplashActivity 结束，MainActivity 显露出来</li>
</ol>


<p><strong>弃用原因：</strong></p>

<p>这种方法导致<strong>14% 的性能下降</strong>。问题在于 Android 处理 Activity 生命周期和渲染的方式。系统并非真正并行启动两个 Activity。相反，它创建了一种顺序依赖关系，GPU 被迫组合两个独立的 Activity 缓冲区，这会在 RAM 和电池方面造成巨大的开销，有时甚至会禁用窗口过渡动画。</p>

<p>正如 Android 文档中关于半透明 Activity 的说明 <a href="https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iv-49946659b094">[3]</a>：</p>

<blockquote><p>“窗口管理器会保持原先的屏幕表面按 Z 轴顺序排列，并将新的屏幕表面混合在其上方。原先的 Activity 仍然可以通过新窗口中任何透明或部分透明的像素看到。”</p></blockquote>

<p>正是这种混合操作导致了性能下降。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-winning-approach-the-gated-splash-screen-mechanism">制胜之道：门控启动画面机制</a></h3>

<p>我最终找到了一种更复杂的方法，它采用了<strong>门控启动画面机制</strong>。此方法使用“ViewTreeObserver.OnPreDrawListener”来阻止所有 UI 渲染，直到满足特定条件为止。</p>

<p><strong>工作原理：</strong></p>

<ol>
<li>启动时，会立即将 <code>OnPreDrawListener</code> 附加到 Activity 的 <code>decorView</code> 上。</li>
<li>监听器的 <code>onPreDraw()</code> 方法返回 <code>false</code>，从而有效阻止所有绘制操作。</li>
<li>监听器仅在所有条件都满足时才返回 <code>true</code>，允许内容渲染。</li>
</ol>


<p><strong>关键实现：</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// The gate mechanism</span>
</span><span class='line'>
</span><span class='line'><span class="n">gate</span><span class="p">.</span><span class="n">onPreDraw</span><span class="p">()</span> <span class="err">→</span> <span class="n">returns</span> <span class="k">false</span> <span class="p">=</span> <span class="n">BLOCK</span> <span class="n">all</span> <span class="n">drawing</span>
</span><span class='line'>
</span><span class='line'><span class="n">gate</span><span class="p">.</span><span class="n">onPreDraw</span><span class="p">()</span> <span class="err">→</span> <span class="n">returns</span> <span class="k">true</span> <span class="p">=</span> <span class="n">ALLOW</span> <span class="n">drawing</span> <span class="n">to</span> <span class="n">proceed</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方法完全符合 Android 官方文档中关于延长启动画面在屏幕上停留时间的建议 <a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>:</p>

<blockquote><p>“如果你需要加载少量数据，例如从本地磁盘异步加载应用内设置，可以使用 ViewTreeObserver.OnPreDrawListener 暂停应用以绘制其第一帧。”</p></blockquote>

<p>EventSplash 库扩展了这一概念，在应用启动时提供对用户可见内容的帧完美控制，防止任何内容闪烁，确保无缝体验。</p>

<p><img src="https://sankalpchauhan.com/static/6810168ee26fb4ae7c236e03fbdd71bc/e5715/view-hirearchy.png" alt="DecorView 将包含我们的 SplashView 和 ContentView" /></p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-experiment-measuring-real-world-impact">实验：测量实际影响</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#test-environment">测试环境</a></h3>

<ul>
<li><strong>设备</strong>：小米 POCO F1，Android 10</li>
<li><strong>构建</strong>：发布配置</li>
<li><strong>方法</strong>：每个配置 35 次冷启动，每次运行之间暂停 2 秒</li>
<li><strong>指标</strong>：自定义 PerfTracker 库，用于测量页面加载时间、FCP 和 FPT</li>
<li><strong>脚本</strong>：通过 <code>perf_loop.sh</code> 自动执行可重复性</li>
</ul>


<p>所有测试代码和脚本均可在 <a href="https://github.com/sankalpchauhan-me/fast-splash-experiment">GitHub 代码库</a> （链接：<a href="https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E8%8E%B7%E5%8F%96%EF%BC%8C%E4%BB%A5%E7%A1%AE%E4%BF%9D%E5%8F%AF%E9%87%8D%E5%A4%8D%E6%80%A7%E3%80%82">https://github.com/sankalpchauhan-me/fast-splash-experiment%EF%BC%89%E8%8E%B7%E5%8F%96%EF%BC%8C%E4%BB%A5%E7%A1%AE%E4%BF%9D%E5%8F%AF%E9%87%8D%E5%A4%8D%E6%80%A7%E3%80%82</a></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#implementation-approaches-tested">测试的实现方法</a></h3>

<ol>
<li><strong>默认阻塞闪屏</strong>：简单的 <code>SplashActivity</code> 和基本路由（保守的基准）</li>
<li><strong>默认非阻塞闪屏</strong>：EventSplash 库和简单的叠加层</li>
<li><strong>Lottie 阻塞闪屏</strong>：传统方法和复杂的动画</li>
<li><strong>Lottie 非阻塞闪屏</strong>：EventSplash 与 Lottie 动画并行运行</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#results-conservative-claims-with-dramatic-potential">结果：保守的声明，但效果显著潜力</a></h2>

<p><img src="https://sankalpchauhan.com/static/b4c51a8a6d8ebb0f3f12161c0441e89d/e5715/performance_comparison.png" alt="性能对比" /></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-honest-comparison-default-splash-performance">真实对比：默认闪屏性能</a></h3>

<p>为了进行<strong>同类比较</strong>，我们重点关注在默认的闪屏实现中，阻塞方法只是简单地为了路由目的而扩大 Activity：</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> 方法 </th>
<th style="text-align:center;"> 页面加载时间 (毫秒) </th>
<th style="text-align:center;"> FCP (毫秒) </th>
<th style="text-align:center;"> FPT (毫秒) </th>
<th style="text-align:center;"> 用户影响 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> <strong>默认阻塞</strong> </td>
<td style="text-align:center;"> 366 </td>
<td style="text-align:center;"> 744 </td>
<td style="text-align:center;"> 2,195 </td>
<td style="text-align:center;"> 明显的延迟 </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>默认非阻塞</strong> </td>
<td style="text-align:center;"> 37 </td>
<td style="text-align:center;"> 164 </td>
<td style="text-align:center;"> 1,295 </td>
<td style="text-align:center;"> 流畅、响应迅速 </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>提升</strong> </td>
<td style="text-align:center;"> <strong>90%</strong> </td>
<td style="text-align:center;"> <strong>78%</strong> </td>
<td style="text-align:center;"> <strong>41%</strong> </td>
<td style="text-align:center;"> <strong>显著提升</strong> </td>
</tr>
</tbody>
</table>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-lottie-animation-advantage">Lottie 动画的优势</a></h3>

<p>当我们引入复杂的 Lottie 动画时，架构上的差异会更加明显发音：</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> 方法 </th>
<th style="text-align:center;"> 页面加载时间 (毫秒) </th>
<th style="text-align:center;"> FCP (毫秒) </th>
<th style="text-align:center;"> FPT (毫秒) </th>
<th style="text-align:center;"> 备注 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> <strong>Lottie 阻塞</strong> </td>
<td style="text-align:center;"> 2,228 </td>
<td style="text-align:center;"> 2,347 </td>
<td style="text-align:center;"> 3,524 </td>
<td style="text-align:center;"> <em>包含动画时长</em> </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>Lottie 非阻塞</strong> </td>
<td style="text-align:center;"> 109 </td>
<td style="text-align:center;"> 312 </td>
<td style="text-align:center;"> 1,467 </td>
<td style="text-align:center;"> <em>动画并行运行</em> </td>
</tr>
<tr>
<td style="text-align:center;"> <strong>提升</strong> </td>
<td style="text-align:center;"> <strong>95%</strong> </td>
<td style="text-align:center;"> <strong>87%</strong> </td>
<td style="text-align:center;"> <strong>58%</strong> </td>
<td style="text-align:center;"> <strong>显著提升</strong> </td>
</tr>
</tbody>
</table>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#understanding-the-lottie-numbers">理解 Lottie 数值</a></h3>

<p><strong>重要提示</strong>：Lottie 阻塞数值在设计上包含动画时长，用户必须等待整个动画完成后才能看到任何主要内容。在非阻塞方法中，<strong>动画和内容加载并行运行</strong>，因此当 Lottie 动画完成时，FPT 通常已经完成或接近完成。</p>

<p>这种并行执行是其关键的架构优势：<strong>无需牺牲性能即可获得精美的动画</strong>。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#performance-improvements-breakdown">性能改进细分</a></h3>

<p><img src="https://sankalpchauhan.com/static/620f7ce36b7f1d75840820adb257fa7f/e5715/improvement_chart.png" alt="改进图表" />
改进图表</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recap-what-happened">回顾：发生了什么</a></h3>

<p>即使与保守的默认启动画面相比，非阻塞方法也实现了<strong>90% 的页面加载速度提升次</strong>。用户体验从“明显的延迟”转变为“流畅且响应迅速”。</p>

<p>对于像 Lottie 这样的复杂动画，其优势更加显著，因为传统方法迫使用户等待整个动画序列，然后才会出现任何有意义的内容。</p>

<p><img src="https://sankalpchauhan.com/6f6ac6fcfed426f343bb76cd31f4694e/comparison.mp4.gif" alt="旧用户体验与新用户体验对比" /></p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-the-technical-mechanism">原因：技术机制</a></h3>

<p>性能提升源于<strong>并行执行</strong>。传统方法<strong>顺序</strong>运行启动画面和主内容，而基于视图的方法<strong>并发</strong>运行它们：</p>

<p><strong>传统（顺序）</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Splash</span> <span class="nt">Activity</span> <span class="err">→</span> <span class="nt">Animation</span> <span class="err">→</span> <span class="nt">Destroy</span> <span class="err">→</span> <span class="nt">Main</span> <span class="nt">Activity</span> <span class="err">→</span> <span class="nt">Content</span> <span class="nt">Load</span> <span class="err">→</span> <span class="nt">Display</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>非阻塞（并行）</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">Main</span> <span class="nt">Activity</span> <span class="o">+</span> <span class="nt">Content</span> <span class="nt">Load</span> <span class="o">(</span><span class="nt">background</span><span class="o">)</span>
</span><span class='line'>     <span class="err">↓</span>
</span><span class='line'><span class="nt">Splash</span> <span class="nt">View</span> <span class="o">(</span><span class="nt">overlay</span><span class="o">)</span> <span class="err">→</span> <span class="nt">Remove</span> <span class="nt">overlay</span> <span class="err">→</span> <span class="nt">Display</span> <span class="nt">loaded</span> <span class="nt">content</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种架构差异彻底消除了阻塞瓶颈。</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#deep-dive-understanding-the-technical-implementation">深入探究：理解技术实现</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#traditional-splash-activity-implementation">传统的 Splash Activity 实现</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">SplashActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>        <span class="n">installSplashScreen</span><span class="p">()</span>
</span><span class='line'>        <span class="n">enableEdgeToEdge</span><span class="p">()</span>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Loader</span> <span class="p">{</span> <span class="c1">// Blocks until animation completes</span>
</span><span class='line'>                <span class="n">startActivity</span><span class="p">(</span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="n">@SplashActivity</span><span class="p">,</span> <span class="n">MainActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Composable</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">Loader</span><span class="p">(</span><span class="n">onComplete</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">composition</span> <span class="k">by</span> <span class="n">rememberLottieComposition</span><span class="p">(</span><span class="n">LottieCompositionSpec</span><span class="p">.</span><span class="n">RawRes</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">sale_tags</span><span class="p">))</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">progress</span> <span class="k">by</span> <span class="n">animateLottieCompositionAsState</span><span class="p">(</span><span class="n">composition</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Animation blocks main content loading</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">progress</span> <span class="p">==</span> <span class="m">1.0f</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">onComplete</span><span class="p">.</span><span class="n">invoke</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#event-splash-non-blocking-implementation">EventSplash：非阻塞实现</a></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">EventSplash</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">activity</span><span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">config</span><span class="p">:</span> <span class="n">EventSplashConfig</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">decorView</span><span class="p">:</span> <span class="n">ViewGroup</span> <span class="p">=</span> <span class="n">activity</span><span class="p">.</span><span class="n">window</span><span class="p">.</span><span class="n">decorView</span> <span class="k">as</span> <span class="n">ViewGroup</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">composeView</span><span class="p">:</span> <span class="n">ComposeView</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Gate prevents premature display until main content ready</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">gate</span> <span class="p">=</span> <span class="k">object</span> <span class="err">: </span><span class="nc">ViewTreeObserver</span><span class="p">.</span><span class="n">OnPreDrawListener</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onPreDraw</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">isReady</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">decorView</span><span class="p">.</span><span class="n">viewTreeObserver</span><span class="p">.</span><span class="n">removeOnPreDrawListener</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>                <span class="k">true</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="k">false</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">decorView</span><span class="p">.</span><span class="n">viewTreeObserver</span><span class="p">.</span><span class="n">addOnPreDrawListener</span><span class="p">(</span><span class="n">gate</span><span class="p">)</span>
</span><span class='line'>        <span class="n">setupSplashCompose</span><span class="p">()</span> <span class="c1">// Non-blocking overlay</span>
</span><span class='line'>        <span class="n">isReady</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">setupSplashCompose</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">view</span> <span class="p">=</span> <span class="n">ComposeView</span><span class="p">(</span><span class="n">activity</span><span class="p">).</span><span class="n">apply</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">layoutParams</span> <span class="p">=</span> <span class="n">ViewGroup</span><span class="p">.</span><span class="n">LayoutParams</span><span class="p">(</span><span class="n">MATCH_PARENT</span><span class="p">,</span> <span class="n">MATCH_PARENT</span><span class="p">)</span>
</span><span class='line'>            <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">getProvider</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">Content</span><span class="p">(</span><span class="n">onFinish</span> <span class="p">=</span> <span class="p">{</span> <span class="n">dismiss</span><span class="p">()</span> <span class="p">})</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">composeView</span> <span class="p">=</span> <span class="n">view</span>
</span><span class='line'>        <span class="n">decorView</span><span class="p">.</span><span class="n">addView</span><span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="c1">// Overlay on main content</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#usage-comparison">使用情况比较</a></h3>

<p><strong>传统方法</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Requires separate activity, blocks main content</span>
</span><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Main content only loads after splash completes</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>EventSplash 方法</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">MainActivity</span> <span class="p">:</span> <span class="n">ComponentActivity</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Non-blocking: splash displays while content loads</span>
</span><span class='line'>        <span class="n">EventSplashApi</span><span class="p">.</span><span class="n">attachTo</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="n">with</span><span class="p">(</span><span class="n">getSaleConfig</span><span class="p">()).</span><span class="n">show</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">setContent</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Main content loads immediately in parallel</span>
</span><span class='line'>            <span class="n">MainAppContent</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recap-implementation-differences">回顾：实现差异</a></h3>

<p>传统方法需要单独的 Activity 生命周期，而 EventSplash 会注入一个与主内容加载过程共存的视图叠加层。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-architectural-advantages">原因：架构优势</a></h3>

<ol>
<li><strong>单一 Activity 上下文</strong>：消除 Activity 转换开销</li>
<li><strong>并行处理</strong>：主内容在启动画面显示时加载</li>
<li><strong>减少内存占用</strong>：没有重复的 Activity 对象</li>
<li><strong>减少 Choreographer.doFrame 循环</strong>：减少渲染管线压力</li>
<li><strong>优化视图层级</strong>：使用单一装饰视图，而非多个独立的 Activity</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#the-choreographer-do-frame-problem">Choreographer.doFrame 问题</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#understanding-frame-rendering-issues">理解帧渲染问题</a></h3>

<p>Android 的渲染系统依赖于 <code>Choreographer.doFrame</code> 来协调动画、输入和绘制 <a href="https://developer.android.com/topic/performance/vitals/render">[4]</a>。文档警告：</p>

<blockquote><p>“如果 Systrace 显示 Choreographer#doFrame 的布局部分工作过多或过于频繁，则意味着你遇到了布局性能问题”</p></blockquote>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#why-splash-activities-cause-jank">为什么闪屏 Activity 会导致卡顿</a></h3>

<p>传统的闪屏实现会造成多个性能瓶颈：</p>

<ol>
<li><strong>双重布局传递</strong>：每个 Activity 都需要单独的视图填充和布局</li>
<li><strong>上下文切换开销</strong>：操作系统必须管理多个 Activity 上下文</li>
<li><strong>内存压力</strong>：重复的视图层次结构会消耗额外的 RAM</li>
<li><strong>帧时序问题</strong>：Activity 转换会触发额外的 doFrame 周期</li>
</ol>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#perfetto-analysis-insights">Perfetto 分析洞察</a></h3>

<p>使用 Perfetto 分析轨迹时，传统的启动画面会显示：</p>

<ul>
<li><code>Choreographer.doFrame</code> 执行时间延长</li>
<li>布局膨胀多次峰值</li>
<li>垃圾回收压力增加</li>
<li>主线程可用性延迟</li>
</ul>


<p>基于视图的方法通过在整个启动过程中维护单一渲染上下文来消除这些问题。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#critical-consideration-concurrent-processing-isnt-free">⚠️ 关键考虑：并发处理并非免费</a></h3>

<p>虽然我们的结果显示性能显著提升，但<strong>非阻塞方法也带来了一系列挑战</strong>，必须仔细考虑。同时运行启动动画和主内容加载会带来额外的资源压力，而顺序加载方法则不会出现这种压力。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#memory-pressure-the-primary-concern">内存压力：主要问题</a></h3>

<p><strong>峰值内存使用量增加</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='nix'><span class='line'><span class="o">//</span> Memory usage pattern comparison
</span><span class='line'>Traditional Approach<span class="p">:</span>
</span><span class='line'>Splash<span class="p">:</span> <span class="mi">50</span>MB <span class="err">→</span> <span class="mi">0</span>MB <span class="err">→</span> Main Content<span class="p">:</span> <span class="mi">120</span><span class="ss">MB =</span> Peak<span class="p">:</span> <span class="mi">120</span>MB
</span><span class='line'>
</span><span class='line'>Non-blocking Approach<span class="p">:</span>
</span><span class='line'>Splash <span class="o">+</span> Main Content<span class="p">:</span> <span class="mi">50</span>MB <span class="o">+</span> <span class="mi">120</span><span class="ss">MB =</span> Peak<span class="p">:</span> <span class="mi">170</span>MB
</span></code></pre></td></tr></table></div></figure>


<p><strong>实际影响</strong>：</p>

<ul>
<li><strong>简单的闪屏叠加</strong>在并发执行期间会增加 20-50MB 的内存</li>
<li><strong>Lottie 动画</strong>在渲染期间可能会消耗 50-100MB 以上的内存</li>
<li><strong>综合峰值使用量</strong>可能比顺序加载方法高出 40-70%</li>
<li><strong>低端设备</strong>（1-2GB RAM）容易受到内存压力的影响</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#low-memory-killer-risk">低内存杀手风险</a></h3>

<p>Android 的低内存终止守护进程会监控系统内存，并可能在压力下终止应用 <a href="https://source.android.com/docs/core/perf/lmkd">[5]</a>:</p>

<blockquote><p>“内存压力是指系统内存不足的状态，需要 Android 通过限制或终止不重要的进程来释放内存”</p></blockquote>

<p><strong>风险因素</strong>:</p>

<ul>
<li>启动过程中终止应用进程会导致糟糕的用户体验</li>
<li>后台应用被更频繁地终止</li>
<li>并发分配导致的内存碎片</li>
<li>在预算设备上尤其成问题</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#cpu-and-battery-implications">CPU 和电池影响</a></h3>

<p><strong>CPU 开销增加</strong>：</p>

<ul>
<li><code>Choreographer.doFrame</code> 处理多个并发操作</li>
<li>主线程因 UI 工作重叠而变得更加繁忙</li>
<li>GPU 渲染管线同时处理启动画面和内容</li>
</ul>


<p><strong>功耗问题</strong>：研究表明，“智能手机上的 UI 渲染需要强大的 CPU 和 GPU 才能满足用户感知的流畅度，并且这占了相当一部分的功耗”<a href="https://www.sciencedirect.com/science/article/abs/pii/S1383762122001540">[6]</a>。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#device-compatibility-challenges">设备兼容性挑战</a></h3>

<p><strong>低端设备注意事项</strong>:</p>

<ul>
<li>单核或双核处理器难以并行化</li>
<li>有限的 RAM 使得内存压力至关重要</li>
<li>较慢的存储速度加剧加载延迟</li>
<li>优势可能无法转化为低端设备的优势</li>
</ul>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#when-not-to-use-non-blocking-approach">何时不应使用非阻塞方法</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#scenarios-where-traditional-approach-may-be-better">传统方法可能更佳的场景：</a></h3>

<ol>
<li><strong>资源极其受限的设备</strong>（&lt; 2GB RAM）</li>
<li><strong>电池关键型应用</strong>，功耗至关重要</li>
<li><strong>简单的启动画面</strong>，没有复杂的动画</li>
<li><strong>启动处理繁重的应用</strong>，已经给应用带来了压力系统</li>
<li><strong>遗留代码库</strong>，重构风险大于收益</li>
</ol>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#risk-mitigation-strategies">风险缓解策略</a></h3>

<p><strong>自适应实施</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AdaptiveSplashStrategy</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">chooseSplashApproach</span><span class="p">():</span> <span class="n">SplashConfig</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">when</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">isLowEndDevice</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">SimpleSplashConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="n">isBatteryLow</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">ReducedAnimationConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="n">isHighPerformanceDevice</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">FullLottieConfig</span><span class="p">()</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">DefaultConfig</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">isLowEndDevice</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">activityManager</span> <span class="p">=</span> <span class="n">getSystemService</span><span class="p">(</span><span class="n">Context</span><span class="p">.</span><span class="n">ACTIVITY_SERVICE</span><span class="p">)</span> <span class="k">as</span> <span class="n">ActivityManager</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">activityManager</span><span class="p">.</span><span class="n">isLowRamDevice</span> <span class="p">||</span>
</span><span class='line'>               <span class="n">Runtime</span><span class="p">.</span><span class="n">getRuntime</span><span class="p">().</span><span class="n">maxMemory</span><span class="p">()</span> <span class="p">&lt;</span> <span class="m">256</span> <span class="p">*</span> <span class="m">1024</span> <span class="p">*</span> <span class="m">1024</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>内存监控</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">private</span> <span class="k">fun</span> <span class="nf">monitorMemoryPressure</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">memoryInfo</span> <span class="p">=</span> <span class="n">ActivityManager</span><span class="p">.</span><span class="n">MemoryInfo</span><span class="p">()</span>
</span><span class='line'>    <span class="n">activityManager</span><span class="p">.</span><span class="n">getMemoryInfo</span><span class="p">(</span><span class="n">memoryInfo</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">memoryInfo</span><span class="p">.</span><span class="n">lowMemory</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Fallback to simpler splash</span>
</span><span class='line'>        <span class="n">simplifyOrDismissSplash</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#industry-context-and-validation">行业背景和验证</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#alignment-with-industry-best-practices">与行业最佳做法保持一致实践</a></h3>

<p>EventSplash 方法符合最新的行业趋势和官方建议。像 Turo 这样的公司通过消除专用的启动活动也取得了类似的效果。正如他们的案例研究 <a href="https://medium.com/androiddevelopers/turo-reduced-its-app-startup-time-by-77-using-android-developer-tools-and-best-practices-bcf82f596bcf">[7]</a> 中所述：</p>

<blockquote><p>“最初，我们使用专用的 SplashActivity 来运行所有启动工作，然后再将应用路由到 HomeActivity。然而，最新的指南建议不要采用这种方法。因此，我们移除了多余的 SplashActivity，并将所有启动逻辑转移到了根 Activity。”</p></blockquote>

<p>Turo 使用类似的原理实现了<strong>77% 的启动时间缩短</strong>。</p>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#validation-through-official-documentation">通过官方文档验证</a></h3>

<p>Android 官方文档明确建议使用“ViewTreeObserver.OnPreDrawListener”进行启动画面管理，<a href="https://developer.android.com/develop/ui/views/launch/splash-screen">[1]</a>，这进一步验证了该方法，而这正是 EventSplash 的核心实现。</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#best-practices-and-common-pitfalls">最佳实践和常见陷阱</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#dos">建议✅</a></h3>

<ul>
<li>在性能强大的设备上，<strong>使用基于视图的启动画面实现</strong>自定义动画</li>
<li>根据设备性能<strong>实施自适应策略</strong></li>
<li>使用真实设备**测量性能，并跨设备层级发布版本</li>
<li>监控内存使用情况**并实施内存泄漏预防</li>
<li>针对最坏情况进行冷启动优化</li>
<li>在低端设备上进行广泛测试**以确保广泛的兼容性</li>
<li><strong>为启动画面实施适当的生命周期管理</strong></li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#donts">注意事项❌</a></h3>

<ul>
<li><strong>不要想当然地认为一刀切</strong>：设备性能差异巨大</li>
<li><strong>不要忽视内存压力</strong>：监控并适应系统限制</li>
<li><strong>不要在未考虑替代方案的情况下使用单独的 SplashActivity</strong></li>
<li><strong>不要用启动画面动画阻碍主内容加载</strong></li>
<li><strong>不要忽略 Play 管理中心内的 Android Vitals 指标</strong></li>
<li><strong>不要只在高端设备</strong>或调试版本上进行测试</li>
<li><strong>不要在启动画面中创建复杂的视图层次结构</strong></li>
<li><strong>不要在启动画面中执行繁重的操作</strong></li>
<li><strong>不要忘记清理启动画面</strong>并清除缓存</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#common-pitfalls">常见陷阱</a></h3>

<ol>
<li><strong>内存泄漏</strong>：未能清除 LottieCompositionCache</li>
<li><strong>设备能力假设</strong>：未适应低端设备限制</li>
<li><strong>生命周期问题</strong>：未正确处理 Activity 状态变化</li>
<li><strong>动画冲突</strong>：闪屏动画干扰主内容</li>
<li><strong>测试偏差</strong>：仅在快速设备或调试版本上进行测试</li>
<li><strong>指标误解</strong>：关注动画时长而非用户感知的性能</li>
<li><strong>资源监控疏忽</strong>：未监控内存和 CPU 使用模式</li>
</ol>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#making-informed-architectural-decisions">制定明智的架构决策</a></h2>

<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#decision-framework">决策框架</a></h3>

<p>在选择启动画面方案时，请考虑以下因素：</p>

<p><strong>设备受众特征</strong>：</p>

<ul>
<li>你的用户中有多少比例使用低端设备？</li>
<li>你支持的最低 RAM 配置是多少？</li>
<li>你是否瞄准了拥有廉价设备的新兴市场？</li>
</ul>


<p><strong>应用特性</strong>：</p>

<ul>
<li>你的主要内容加载复杂度如何？</li>
<li>你是否对网络依赖性很强？</li>
<li>你当前的内存占用是多少？</li>
</ul>


<p><strong>业务需求</strong>：</p>

<ul>
<li>自定义启动动画对你的品牌有多重要？</li>
<li>你能实现渐进式增强吗？</li>
<li>你的开发和测试能力如何？</li>
</ul>


<h3><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#recommended-strategy">推荐策略</a></h3>

<p><strong>渐进式增强方法</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">EventSplashApi</span><span class="p">.</span><span class="n">attachTo</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withFallback</span><span class="p">(</span><span class="n">SimpleSplashConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// Low-end devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withStandard</span><span class="p">(</span><span class="n">ImageSplashConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// Mid-range devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">withEnhanced</span><span class="p">(</span><span class="n">LottieConfig</span><span class="p">())</span>
</span><span class='line'>    <span class="c1">// High-end devices</span>
</span><span class='line'>    <span class="p">.</span><span class="n">adaptToDevice</span><span class="p">()</span>
</span><span class='line'>    <span class="c1">// Automatic selection</span>
</span><span class='line'>    <span class="p">.</span><span class="n">show</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>此方法提供：</p>

<ul>
<li>适用于所有设备的<strong>基本功能</strong></li>
<li>在资源允许的情况下<strong>增强体验</strong></li>
<li>根据设备性能<strong>自动适配</strong></li>
<li>在内存压力下<strong>优雅降级</strong></li>
</ul>


<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#insights-recommendations">见解与建议</a></h2>

<p>非阻塞启动画面方法<strong>显著提升性能</strong>（保守测试中页面加载速度提升 90%，复杂动画下最高可达 95%），但也存在一些不足。<strong>并发处理会增加峰值内存使用量和 CPU 开销</strong>，这在低端设备上可能会造成问题。</p>

<p><strong>关键见解</strong>：其优势显著且可衡量，但也伴随着资源成本，必须通过自适应的实施策略进行管理。</p>

<p><strong>诚挚建议</strong>：使用非阻塞方法并结合设备感知回退机制。即使是保守估计，也能显​​示出显著的性能提升，其架构优势也令人信服。然而，该实现必须足够复杂，才能支持所有 Android 设备。</p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#conclusion">结论</a></h2>

<p>_本案例研究表明，性能优化需要在保持诚实声明的同时平衡相互竞争的约束条件。非阻塞、基于视图的方法提供了显著且可衡量的优势，但成功实施需要深入了解其收益和成本。</p>

<p>通过摆脱传统的“SplashActivity”模式，采用更复杂、更并发的架构，我们可以构建速度更快、响应更灵敏的 Android 应用，并在整个生态系统中可靠地运行。</p>

<p><strong>我们的目标不仅仅是构建更快的应用，而是构建使用体验即时、愉悦的应用，因为最终，性能是用户能够注意到并欣赏的功能。</strong></p>

<h2><a href="https://sankalpchauhan.com/breaking-the-speed-barrier-how-non-blocking-splash-screens-cut-android-app-launch-time-by-90#references">参考</a></h2>

<ol>
<li><a href="https://developer.android.com/develop/ui/views/launch/splash-screen">闪屏 | 视图 | Android 开发者</a></li>
<li><a href="https://developer.android.com/topic/performance/vitals/launch-time">应用启动时间 | 应用质量 | Android 开发者</a></li>
<li><a href="https://medium.com/androiddevelopers/the-android-lifecycle-cheat-sheet-part-iv-49946659b094">Android 生命周期速查表 — 第四部分：ViewModel、半透明 Activity 和启动模式 | 作者：Jose Alcérreca</a></li>
<li><a href="https://developer.android.com/topic/performance/vitals/render">渲染缓慢 | 应用质量 | Android 开发者</a></li>
<li><a href="https://source.android.com/docs/core/perf/lmkd">低内存终止守护进程 (lmkd) | Android 开源项目</a></li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S1383762122001540">移动 UI 渲染功耗研究</a></li>
<li><a href="https://medium.com/androiddevelopers/turo-reduced-its-app-startup-time-by-77-using-android-developer-tools-and-best-practices-bcf82f596bcf">Turo 利用 Android 开发者工具和最佳实践将其应用启动时间缩短了 77%</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[灵活、现代的Android应用架构：完整分步指南]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture/"/>
    <updated>2025-10-13T15:05:25+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「A flexible, modern Android app architecture: complete step-by-step」，原文链接<a href="https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993">https://proandroiddev.com/a-flexible-modern-android-app-architecture-complete-step-by-step-d76901e29993</a>，由Tom Colvin发布于2023年7月4日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/13/a-flexible-modern-android-app-architecture/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*ykKTTMXsKNzLJ7In" title="auto auto" ></a></p>

<!-- more -->


<p>我最近写了一篇关于<a href="https://juejin.cn/post/7553894051460694055">优秀 Android 应用架构背后的理论</a>的文章。这篇文章成为了我迄今为止最受欢迎的文章，许多人都慷慨地表示它对他们很有帮助。</p>

<p>最常见的问题之一是：“但是 X 呢？它不太符合规则。” 这就是为什么我一直说：</p>

<blockquote><p>要学习原则，而不是盲目遵循规则。</p></blockquote>

<p>本文旨在展示实践的一面：通过示例来教授 Android 架构。最重要的是，这意味着展示各种架构决策是如何制定的。我们会遇到有多种可能答案的情况，在每种情况下，我们都会依靠原则，而不是死记硬背一套规则。</p>

<p>所以，让我们一起构建一个应用程序吧。</p>

<h2>介绍我们将要构建的应用程序</h2>

<p>我们将为行星观测者构建一款应用程序。它看起来会像这样：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:640/1*7C7vCDdsppHzE1DQkI3QJA.gif" alt="应用程序（全球排名第一的行星观测应用程序）演示：添加示例行星、添加自定义行星、删除行星以及刷新" /></p>

<p>我们的应用程序将具有以下功能：</p>

<ul>
<li>列出你之前发现的所有行星</li>
<li>添加新发现的行星</li>
<li>删除行星（以防你意识到你的发现实际上只是望远镜镜头上的一小块痕迹）</li>
<li>添加一些示例行星，以便用户了解应用程序的工作原理</li>
</ul>


<p>它将具有离线数据缓存以及在线数据库访问功能。</p>

<p>与我的演示一样，我鼓励你尝试不同的做法：添加额外功能，考虑未来可能出现的规格变更，挑战自我。在这里，学习的重点在于<em>代码背后的思考过程</em>，而不是代码本身。所以，如果你想从本教程中获得最大收获，不要盲目地复制代码。</p>

<p>这是我们最终的仓库：<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>。</p>

<h2>介绍我们将要使用的架构原则</h2>

<p>我们将参考 SOLID 原则、整洁架构原则以及 Google 自己的现代应用架构原则。</p>

<p>我们不会将这些原则视为硬性规定，因为我们足够聪明，能够构建更适合我们应用（尤其是更符合我们预期应用增长方式）的架构。例如，如果你严格遵循整洁架构，你将开发出稳定、可靠、可扩展的软件，但对于单一用途的应用来说，你的代码可能会过于复杂。Google 的原则可以生成更简单的代码，但如果有一天该应用可能由多个大型开发团队维护，则这些原则就不太适用了。</p>

<p>我们将从 Google 的拓扑结构开始，并在此过程中参考整洁架构。</p>

<p>Google 的拓扑结构如下：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1200/1*tuohW6OJuZD8tMcAYjPBSg.png" alt="" /></p>

<p>我们将逐步实现这些功能，<a href="https://juejin.cn/post/7553894051460694055">我的上一篇文章</a> 对每个部分都进行了更深入的介绍。这里再简单地概述一下：</p>

<h3>UI 层</h3>

<p>UI 层实现用户界面。它分为：</p>

<ul>
<li><strong>UI 元素</strong>，即用于在屏幕上绘制内容的所有专有代码。在 Android 中，主要选择是 Jetpack Compose（此处使用 <code>@Composable</code>）或 XML（此处包含你的 XML 文件和资源）。</li>
<li><strong>状态持有者</strong>，用于实现你偏好的 MVVM / MVC / MVP / &hellip; 拓扑结构。在此应用中，我们将使用视图模型。</li>
</ul>


<h3>领域层</h3>

<p>领域层用于包含高级业务逻辑的<strong>用例</strong>。例如​​，当我们想要添加一个星球时，AddPlanetUseCase 将描述执行此操作所需的一系列步骤。它只是“做什么”的列表，而不是“怎么做”的列表：例如，我们会说“保存 Planet 对象的数据”。这是一个高级指令。我们不会说“将其保存到本地缓存”，更不用说“使用 Room 数据库将其保存到本地缓存”了——这些底层实现细节应该放在其他地方。</p>

<h3>数据层</h3>

<p>Google 敦促我们为应用中的所有数据提供单一可信来源；也就是说，一种获取最终“正确”数据版本的方法。这就是数据层将要提供的内容（涵盖除描述用户刚刚输入内容的数据结构之外的所有数据结构）。它分为：</p>

<ul>
<li><strong>存储库</strong>，用于管理各种类型的数据。例如，我们将有一个行星数据存储库，它将提供对已发现行星的 CRUD（创建、读取、更新、删除）操作。它还将处理数据存储在本地缓存和远程缓存中的情况，为不同类型的操作选择合适的数据源，并管理当两个数据源包含不同数据副本时的处理方式。这里我们将讨论本地缓存，但我们不会讨论我们将使用哪些第三方技术来实现它。</li>
<li><strong>数据源</strong>，用于管理数据存储的具体细节。当存储库请求“远程存储 X”时，它会请求数据源执行此操作。数据源仅包含驱动专有技术所需的代码——可能是 Firebase、HTTP API 或其他技术。</li>
</ul>


<h2>良好的架构允许延迟决策</h2>

<p>在此阶段，我们已经了解了应用的功能，以及一些关于如何管理数据的基本想法。</p>

<p>还有一些事情我们尚未确定。我们还不知道 UI 的具体外观，也不知道将使用什么技术来构建它（Jetpack Compose、XML 等）。我们不知道本地缓存将采用何种形式。我们不知道将使用哪种专有解决方案来访问在线数据。我们不知道是否支持手机、平板电脑或其他设备。</p>

<p><strong>_问题：我们需要了解以上任何内容才能制定架构吗？</strong></p>

<p><strong>_答案：不需要！</strong></p>

<p>以上都是底层考虑因素（在整洁架构中，它们的代码位于最外层）。它们是<em>实现细节</em>，而不是<em>逻辑</em>。SOLID 的依赖倒置原则告诉我们，任何代码都不应依赖于它们。</p>

<p>换句话说，我们应该能够在不了解上述任何知识的情况下编写（并测试！）应用程序的其余代码。当我们了解上述问题的答案时，我们已经编写的任何代码都无需更改。</p>

<p>这意味着代码生产阶段可以在设计师完成设计之前以及利益相关者决定使用第三方技术之前开始。因此，<em>良好的架构允许延迟决策</em>。（并且能够灵活地撤销任何此类决策，而不会导致严重的代码问题）。</p>

<h2>我们项目的架构图</h2>

<p>这是我们将行星观测员的应用程序融入 Google 拓扑结构的初步尝试。</p>

<h3>数据层</h3>

<p>我们将有一个用于行星数据的<strong>存储库</strong>，以及两个<strong>数据源</strong>：一个用于本地缓存，一个用于远程数据。</p>

<h3>UI 层</h3>

<p>将​​有两个<strong>状态持有者</strong>，一个用于行星列表页面，另一个用于添加行星页面。每个页面还会有一组<strong>UI 元素</strong>，这些元素将使用目前尚待确定的技术编写。</p>

<h3>领域层</h3>

<p>有两种非常有效的领域层架构方法：</p>

<ol>
<li>我们可以只在重复业务逻辑的地方添加用例。在我们的应用中，唯一重复的逻辑是添加行星：用户添加示例行星列表和手动输入自己的行星详细信息时都需要它。因此，我们只创建一个用例：AddPlanetUseCase。在其他情况下（例如删除行星），状态持有者将直接与存储库交互。</li>
<li>我们可以为与存储库的每次交互添加用例，这样状态持有者和存储库之间就不会有任何直接联系。在这种情况下，我们将有添加行星、删除行星和列出行星的用例。</li>
</ol>


<p>第二种方法的好处是它遵循了整洁架构的规则。我个人认为这种方法对于大多数应用来说有点太重了，所以我倾向于选择第一种。这就是我们要做的。</p>

<p>这给了我们以下架构图：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*69Zaett5v82b0uzpF1dgOg.png" alt="我们应用的架构图：显示 UI、领域和数据层的架构图" /></p>

<h2>我们应该从哪些代码开始？</h2>

<p>规则是：</p>

<blockquote><p>从高层代码开始，然后逐步向下。</p></blockquote>

<p>这意味着首先要写出用例，因为这样做可以告诉我们存储库层有哪些需求。一旦我们知道存储库需要什么，我们就可以写出数据源需要什么来支持它。</p>

<p>同样，由于用例告诉我们用户可能采取的所有操作，我们就可以了解 UI 的所有输入和输出。由此，我们可以知道 UI 需要包含哪些内容，从而可以编写状态持有者（视图模型）。有了状态持有者，我们就知道需要编写哪些 UI 元素。</p>

<p>当然，一旦高级工程师和项目利益相关者就将要使用的技术达成一致，我们就可以无限期地推迟编写 UI 元素和数据源（即所有底层代码）。</p>

<p>理论到此结束。现在让我们开始构建应用程序。我会向你们详细介绍我们做出的决定。</p>

<h2>步骤 0：创建项目</h2>

<p>打开 Android Studio 并创建一个“无活动”项目：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*SQ52XlNqWwTEQ9GfsluAQA.png" alt="Android Studio“No Activity”项目" /></p>

<p>在下一个屏幕上，将其命名为 PlanetSpotters，其他内容保持不变：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*wkq8joirefCSsxeR-y3bnw.png" alt="Android Studio“新建项目”屏幕显示输入的名称为“PlanetSpotters”" /></p>

<h3>添加依赖注入</h3>

<p>我们需要一个依赖注入框架，它有助于应用 SOLID 的依赖倒置原则。 Hilt 是我最喜欢的选择，而且值得庆幸的是，它也是 Google 特别推荐的。</p>

<p>要 <a href="https://developer.android.com/training/dependency-injection/hilt-android">添加 Hilt</a>，请在根 Gradle 文件中添加以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span> <span class="n">version</span> <span class="s1">&#39;2.44.2&#39;</span> <span class="n">apply</span> <span class="kc">false</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>并在 app/build.gradle 文件中添加以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">plugins</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;kotlin-kapt&#39;</span>
</span><span class='line'>  <span class="n">id</span> <span class="s1">&#39;com.google.dagger.hilt.android&#39;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">android</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="n">compileOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sourceCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>    <span class="n">targetCompatibility</span> <span class="n">JavaVersion</span><span class="o">.</span><span class="na">VERSION_17</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">kotlinOptions</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">jvmTarget</span> <span class="o">=</span> <span class="s1">&#39;17&#39;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">implementation</span> <span class="s2">&quot;com.google.dagger:hilt-android:2.44.2&quot;</span>
</span><span class='line'>  <span class="n">kapt</span> <span class="s2">&quot;com.google.dagger:hilt-compiler:2.44.2&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Allow references to generated code</span>
</span><span class='line'><span class="n">kapt</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">correctErrorTypes</span> <span class="kc">true</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>（请注意，我们在此处将兼容性设置为 Java 17，这是 Hilt 使用的 Kapt 的要求。你需要 Android Studio Flamingo 或更高版本）。</p>

<p>最后，添加 Application 类的重写，其中包含 <code>@HiltAndroidApp</code> 注解。也就是说，在应用的包文件夹（此处为 <code>com.tdcolvin.planetspotters</code>）中创建一个名为 PlanetSpottersApplication 的文件，内容如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">android.app.Application</span>
</span><span class='line'><span class="k">import</span> <span class="nn">dagger.hilt.android.HiltAndroidApp</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltAndroidApp</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetSpottersApplication</span><span class="p">:</span> <span class="n">Application</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>……然后，通过将文件添加到清单中，告诉操作系统实例化它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span>
</span><span class='line'><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">&quot;http://schemas.android.com/apk/res/android&quot;</span>
</span><span class='line'>    <span class="na">xmlns:tools=</span><span class="s">&quot;http://schemas.android.com/tools&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;application</span>
</span><span class='line'>        <span class="err">....</span>
</span><span class='line'>        <span class="na">android:name=</span><span class="s">&quot;.PlanetSpottersApplication&quot;</span>
</span><span class='line'>        <span class="err">...</span>
</span><span class='line'>    <span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'>    ...
</span><span class='line'><span class="nt">&lt;/manifest&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>一旦我们有了主 Activity，我们就需要为其添加 <code>@AndroidEntryPoint</code>。但现在，我们的 Hilt 设置就完成了。</p>

<p>最后，我们将通过在 app/build.gradle 中添加以下代码来添加对其他有用库的支持：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='groovy'><span class='line'><span class="n">dependencies</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Coroutines</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4&#39;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//viewModelScope</span>
</span><span class='line'>    <span class="n">implementation</span> <span class="s1">&#39;androidx.lifecycle:lifecycle-viewmodel-ktx:2.6.1&#39;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 1：列出用户可以执行和查看的所有功能</h2>

<p>此步骤是编写用例和存储库的准备工作。回想一下，用例是用户可以执行的单个任务，并以高层次描述（描述“什么”，而不是“如何”）。</p>

<p>因此，让我们从写出这些任务开始；列出用户可以在应用中执行和查看的所有功能的详尽列表。</p>

<p>其中一些任务最终会被编码为用例。（事实上，在清晰架构下，所有此类任务都必须以用例的形式编写）。其他任务将由 UI 层直接与存储库层通信来完成。</p>

<p>这里需要一份书面规范。它不需要 UI 设计，但如果有的话，它无疑有助于可视化。</p>

<p>我们的列表如下：</p>

<h3>获取已发现行星的列表，该列表会自动更新</h3>

<p><strong>输入</strong>：无</p>

<p><strong>输出</strong>：Flow&lt;List<Planet>></p>

<p><strong>操作</strong>：从存储库请求当前已发现行星的列表，该列表必须以表单形式提供，以便在发生变更时及时通知我们。</p>

<h3>获取单个已发现行星的详细信息，该列表会自动更新</h3>

<p><strong>输入</strong>：String — 我们要获取的行星的 ID</p>

<p><strong>输出</strong>：Flow<Planet></p>

<p><strong>操作</strong>：从存储库请求具有指定 ID 的行星，并在发生变更时通知我们。</p>

<h3>添加/编辑新发现的行星</h3>

<p><strong>输入</strong>：</p>

<ul>
<li>planetId: String? — 如果非空，则为要编辑的行星的 ID。如果为空，则表示我们正在添加一颗新行星。</li>
<li>name：字符串 — 行星名称</li>
<li>distanceLy：浮点型 — 行星与地球的距离（光年）</li>
<li>discover：日期 — 发现日期</li>
</ul>


<p><strong>输出</strong>：无（完成即成功，无异常）</p>

<p><strong>操作</strong>：根据输入创建一个 Planet 对象，并将其传递给存储库（以添加到其数据源）</p>

<h3>添加一些示例行星</h3>

<p><strong>输入</strong>：无</p>

<p><strong>输出</strong>：无（出错时抛出）</p>

<p><strong>操作</strong>：请求存储库添加三颗示例行星，其发现日期为当前时间：Trenzalore（300 光年）、Skaro（0.5 光年）、Gallifrey（40 光年）。</p>

<h3>删除行星</h3>

<p><strong>输入</strong>：字符串 — 待删除行星的 ID</p>

<p><strong>输出</strong>：无（出错时抛出）</p>

<p><strong>操作</strong>：请求存储库删除具有指定 ID 的行星。</p>

<p>现在我们有了这个列表，我们就可以开始编写用例和存储库了。</p>

<h2>步骤 2：编写用例（Usec ases）</h2>

<p>从步骤 1 开始，我们得到了一个用户可以执行的任务列表。之前我们决定，在这些任务中，唯一要编写为用例的任​​务是“添加星球”。（我们决定只添加那些在应用的不同区域重复执行任务的用例）。</p>

<p>这样我们就有了一个可以在这里编写的用例：<strong>AddPlanetUseCase</strong>。</p>

<p>一个很棒的 Kotlin 技巧是将用例的逻辑放在 <code>operator fun invoke(…)</code> 函数中。这样就可以像调用函数一样调用代码来“调用”类实例，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span> <span class="p">=</span> <span class="err">…</span><span class="c1">//Use our instance as if it were a function:</span>
</span><span class='line'><span class="n">addPlanetUseCase</span><span class="p">(</span><span class="err">…</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是我们使用该技巧编写的 AddPlanetUseCase 代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddPlanetUseCase</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="n">operator</span> <span class="k">fun</span> <span class="nf">invoke</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please specify a planet name&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span> <span class="p">&lt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a positive distance&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planet</span><span class="p">.</span><span class="n">discovered</span><span class="p">.</span><span class="n">after</span><span class="p">(</span><span class="n">Date</span><span class="p">()))</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">throw</span> <span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Please enter a discovery date in the past&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的 PlanetsRepository 是一个接口，它列出了存储库将拥有的方法。稍后会详细介绍（特别是为什么我们要创建接口而不是类）。但现在我们先创建它，这样我们的代码就能编译了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>描述 Planet 的数据类型：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">Planet</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">name</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">discovered</span><span class="p">:</span> <span class="n">Date</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>addPlanet 方法（类似于用例中的 invoke 函数）被声明为 <code>suspend</code>，因为我们知道它会涉及后台工作。稍后我们会向此接口添加更多方法，但目前这已经足够了。</p>

<p>顺便说一句，你可能会问，我们为什么要费心创建一个如此简单的用例？答案在于它可能会如何发展。未来它可能会变得更加复杂，而外部代码可以与这种复杂性隔离开来。</p>

<h2>步骤 2.1：测试用例</h2>

<p>我们现在已经编写了用例，但无法运行它。首先，它依赖于 <code>PlanetsRepository</code> 接口，而我们还没有它的实现。Hilt 不知道该如何处理它。</p>

<p>但我们可以编写测试，提供一个伪造的 <code>PlanetsRepository</code> 实例，并使用我们的测试框架运行它。这就是你现阶段应该做的事情。</p>

<p>由于这是一个关于架构的教程，测试的具体细节超出了范围，所以这一步留作练习。但请注意，良好的架构设计使我们能够将组件拆分成易于测试的部分。</p>

<h2>步骤 3：数据层，编写 PlanetsRepository</h2>

<p>请记住，存储库的作用是整理不同的数据源，管理它们之间的差异，并提供 CRUD 操作。</p>

<h3>使用依赖倒置和依赖注入</h3>

<p>根据整洁架构和依赖倒置原则（更多信息请参阅我的上一篇文章），我们希望避免外部代码依赖于存储库实现内部的代码。这样，用例或视图模型（例如）就不会受到存储库代码更改的影响。</p>

<p>这也解释了为什么我们之前将 PlanetsRepository 创建为接口（而不是类）。调用代码将仅依赖于接口，但它将通过依赖注入接收实现。现在我们将向接口添加更多方法，并创建它的实现，我们将其命名为 <strong>DefaultPlanetsRepository</strong>。</p>

<p>（补充：一些开发团队习惯将实现命名为 <code>&lt;接口名称&gt;Impl</code>；例如 <code>PlanetsRepositoryImpl</code>。我认为这种约定不利于代码可读性：类名应该能够说明实现接口的原因。所以我避免使用这种方式。但我还是提到了它，因为它的使用非常广泛。）</p>

<h3>使用 Kotlin Flows 实现数据可用</h3>

<p>如果你还没有接触过 <a href="https://developer.android.com/kotlin/flow">Kotlin Flows</a>，那就赶紧停下手头的工作，现在就去了解一下吧。它们将改变你的生活。</p>

<p>它们提供了一个数据“管道”，会随着新结果的出现而变化。只要调用者注册了该管道，他们就会在发生变更时收到更新。现在，我们的 UI 可以随着数据更新而自动更新，几乎无需任何额外操作。相比之下，过去我们必须手动向 UI 标记数据已更改。</p>

<p>其他解决方案，例如 RxJava 和 MutableLiveData，它们具有类似的功能，但它们不如 Flows 灵活易用。</p>

<h3>添加无处不在的 WorkResult 类</h3>

<p>WorkResult 类是数据层的常见返回值。它允许我们描述特定请求是否成功，如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="n">sealed</span> <span class="k">class</span> <span class="nc">WorkResult</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Success</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span><span class="k">val</span> <span class="py">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="k">val</span> <span class="py">exception</span><span class="p">:</span> <span class="n">Exception</span><span class="p">)</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'>    <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Nothing</span><span class="p">&gt;()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用代码可以检查给定的 WorkResult 是“Success”、“Error”还是“Loading”对象（后者表示请求尚未完成），从而确定请求是否成功。</p>

<h3>我们的存储库接口</h3>

<p>让我们将以上所有内容结合起来，制定构成 PlanetsRepository 的方法和属性的规范。</p>

<p>它有两种获取行星的方法。第一个方法通过 ID 获取单个行星：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>第二个方法获取一个代表行星列表的 Flow：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这两个方法都是各自数据的唯一真实来源。每次我们都会返回存储在本地缓存中的数据，因为我们需要处理这些方法的频繁运行，而且本地数据比访问远程数据源更快、更便宜。但我们需要一个方法来刷新本地缓存。这将从远程数据源更新本地数据源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来我们需要添加、更新和删除行星的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以我们的界面现在看起来像这样：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.repository</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">PlanetsRepository</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>边写边写数据源接口</h3>

<p>为了编写实现接口的类，我们需要关注数据源需要哪些方法。回想一下，我们有两个数据源：LocalDataSource 和 RemoteDataSource。我们还没有决定使用哪种第三方技术——而且现在也不需要。</p>

<p>现在让我们创建接口定义，以便我们边写边添加方法签名：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.local</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.data.source.remote</span>
</span><span class='line'>
</span><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//Ready to add method signatures here...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>准备好填充这些接口后，我们现在可以编写 DefaultPlanetsRepository 了。让我们逐一调用这些方法：</p>

<h3>编写 getPlanetFlow() 和 getPlanetsFlow()</h3>

<p>这两个方法都很简单；我们返回本地数据源中的数据。 （为什么不使用远程数据源？因为本地数据源的存在是为了快速、轻量地访问数据。远程数据源可能始终是最新的，但速度很慢。如果我们确实需要最新的数据，那么我们可以在调用 getPlanetsFlow() 之前使用下面的 refershPlanets()。）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">localDataSource</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以这依赖于 LocalDataSource 中的 getPlanetFlow() 和 getPlanetsFlow() 函数。我们现在将它们添加到接口中，以便代码能够编译。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>编写 refreshPlanets()</h3>

<p>要更新本地缓存，我们从远程数据源获取当前的行星列表，并将其保存到本地数据源。（然后，本地数据源可以“注意到”更改，并通过 getPlanetsFlow() 返回的 Flow 发出新的行星列表。）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">refreshPlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">getPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这需要在每个数据源接口中创建一个新方法，现在如下所示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意所有这些方法都被声明为“suspend fun”。这将线程和协程上下文的责任转交给调用者。</p>

<h3>编写 addPlanet() 和 deletePlanet()</h3>

<p>这两个函数都遵循相同的模式：对远程数据源执行写入操作，如果成功，则将更改镜像到本地缓存。</p>

<p>我们期望远程数据源在 Planet 对象写入数据库后为其分配一个唯一的 ID，因此 RemoteDataSource 的 addPlanet() 函数返回一个更新后的 Planet 对象，该对象具有非空的ID（NonNull ID）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetWithId</span> <span class="p">=</span> <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">addPlanet</span><span class="p">(</span><span class="n">planetWithId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">override</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">remoteDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="n">localDataSource</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>完成所有这些之后，最终的数据源接口如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">LocalDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetsFlow</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">WorkResult</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">?&gt;&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">setPlanets</span><span class="p">(</span><span class="n">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">)</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">interface</span> <span class="n">RemoteDataSource</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPlanets</span><span class="p">():</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">addPlanet</span><span class="p">(</span><span class="n">planet</span><span class="p">:</span> <span class="n">Planet</span><span class="p">):</span> <span class="n">Planet</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们稍后会编写实现这些接口的代码，但现在，我们先来看看 UI。</p>

<h2>步骤 4：状态持有者，编写 PlanetsListViewModel</h2>

<p>回想一下，UI 层由 UI 元素和状态持有者层组成：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*Z0Px8K4iaChOzLPxDd9GPw.png" alt="UI层" /></p>

<p>目前我们还不知道要使用什么技术来绘制 UI，所以还不能编写 UI 元素层。但这没关系；我们可以继续编写状态持有者，而且一旦我们做出决定，它们就无需更改。这就是优秀架构的更多优势！</p>

<h3>编写 PlanetsListViewModel 的规范</h3>

<p>UI 将包含两个页面，一个用于列出和删除行星，另一个用于添加或编辑行星。PlanetsListViewModel 为前者提供支持。这意味着它需要将数据暴露给行星列表屏幕的 UI 元素，并且必须准备好在用户执行操作时接收来自 UI 元素的事件。</p>

<p>具体来说，我们的 PlanetsListViewModel 需要暴露：</p>

<ul>
<li>描述页面当前状态的 Flow（至关重要的是，它包含行星列表）</li>
<li>刷新列表的方法</li>
<li>删除行星的方法</li>
<li>添加示例行星的方法，帮助用户了解应用的功能</li>
</ul>


<h3>PlanetsListUiState 对象：页面的当前状态</h3>

<p>我发现将页面的整个状态包含在一个数据类中很有帮助：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">PlanetsListUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planets</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Planet</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意，我已将其与视图模型定义在同一个文件中。它仅包含简单对象：没有 Flow 等，只有原始类型、数组和简单的数据类。另请注意，所有字段都有默认值——这将在后面帮助我们。</p>

<p>（有一些很好的理由让你甚至不希望 Planet 对象出现在上面的代码中。整洁架构的纯粹主义者会指出，在 Planet 的定义和使用之间，层级跳跃太多了。状态提升原则告诉我们，只提供我们需要的精确数据。例如，现在我们只需要 Planet 的名称和距离，所以我们应该只提供这些，而不是整个 Planet 对象。我个人认为这不必要地增加了代码的复杂性，并使未来的修改更加困难，但你可以不同意！）</p>

<p>定义好之后，我们现在可以在视图模型中创建一个状态变量来暴露它：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">package</span> <span class="nn">com.tdcolvin.planetspotters.ui.planetslist</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">PlanetsListViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetsFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">planets</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">planets</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Error</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Loading</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">-&gt;</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">planets</span> <span class="p">=</span> <span class="n">planets</span><span class="p">.</span><span class="n">data</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">initialValue</span> <span class="p">=</span> <span class="n">PlanetsListUiState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>看看如何根据刚从存储库收到的不同类型的结果来创建“下一个”UI 状态？</p>

<p><code>.stateIn(…)</code> 的 <code>scope</code> 和 <code>started</code> 参数安全地限制了此 StateFlow 的生命周期。更多信息，请参阅 <a href="https://medium.com/androiddevelopers/consuming-flows-safely-in-jetpack-compose-cde014d0d5a3">Manual Vivo 的精彩文章</a>。</p>

<h3>添加示例行星</h3>

<p>为了添加这 3 个示例行星，我们反复调用为此创建的用例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">addSamplePlanets</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">planets</span> <span class="p">=</span> <span class="n">arrayOf</span><span class="p">(</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Skaro&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">0.5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Trenzalore&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">5F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>            <span class="n">Planet</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">&quot;Galifrey&quot;</span><span class="p">,</span> <span class="n">distanceLy</span> <span class="p">=</span> <span class="m">80F</span><span class="p">,</span> <span class="n">discovered</span> <span class="p">=</span> <span class="n">Date</span><span class="p">()),</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>        <span class="n">planets</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span> <span class="n">addPlanetUseCase</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>刷新和删除</h3>

<p>刷新和删除函数的结构非常相似，只需调用相应的存储库函数即可。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">deletePlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">refreshPlanetsList</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">planetsRepository</span><span class="p">.</span><span class="n">refreshPlanets</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 5：编写 AddEditPlanetViewModel</h2>

<p>AddEditPlanetViewModel 为用于添加新行星或编辑现有行星的屏幕提供支持。</p>

<p>正如我们之前所做的那样——事实上，这也是任何视图模型的良好实践——我们将为 UI 显示的所有内容定义一个数据类，并为其定义一个单一的数据源：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">AddEditPlanetUiState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetName</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDistanceLy</span><span class="p">:</span> <span class="n">Float</span> <span class="p">=</span> <span class="m">1.0F</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">planetDiscovered</span><span class="p">:</span> <span class="n">Date</span> <span class="p">=</span> <span class="n">Date</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isPlanetSaved</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">():</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果我们正在编辑一个星球（而不是添加一个新的星球），我们希望视图的初始状态代表该星球的当前状态。</p>

<p>按照良好实践，此屏幕只会传递我们正在编辑的星球的 ID。（我们不会传递整个 Planet 对象——这可能会变得太大太复杂）。Android 的 Lifecycle 组件为我们提供了一个 SavedStateHandle，我们可以从中获取星球 ID 并加载 Planet 对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@HiltViewModel</span>
</span><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="n">savedStateHandle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetsRepository</span><span class="p">:</span> <span class="n">PlanetsRepository</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="n">savedStateHandle</span><span class="p">[</span><span class="n">PlanetsDestinationsArgs</span><span class="p">.</span><span class="n">PLANET_ID_ARG</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_uiState</span> <span class="p">=</span> <span class="n">MutableStateFlow</span><span class="p">(</span><span class="n">AddEditPlanetUiState</span><span class="p">())</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">AddEditPlanetUiState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">asStateFlow</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">init</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">planetId</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">loadPlanet</span><span class="p">(</span><span class="n">planetId</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">result</span> <span class="p">=</span> <span class="n">planetsRepository</span><span class="p">.</span><span class="n">getPlanetFlow</span><span class="p">(</span><span class="n">planetId</span><span class="p">).</span><span class="n">first</span><span class="p">()</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!</span><span class="k">is</span> <span class="n">WorkResult</span><span class="p">.</span><span class="n">Success</span> <span class="p">||</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">val</span> <span class="py">planet</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">data</span>
</span><span class='line'>                <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetName</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">distanceLy</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">planetDiscovered</span> <span class="p">=</span> <span class="n">planet</span><span class="p">.</span><span class="n">discovered</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意我们如何使用这种模式更新 UI 状态：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span> <span class="p">...</span> <span class="p">)</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>只需一行简单的代码，即可创建一个新的 AddEditPlanetUiState，其值从前一个复制而来，并通过 uiState Flow 将其发送出去。</p>

<p>以下是使用该技术更新行星各项属性的函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">setPlanetName</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetName</span> <span class="p">=</span> <span class="n">name</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">setPlanetDistanceLy</span><span class="p">(</span><span class="n">distanceLy</span><span class="p">:</span> <span class="n">Float</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">planetDistanceLy</span> <span class="p">=</span> <span class="n">distanceLy</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，我们使用 AddPlanetUseCase 保存行星对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddEditPlanetViewModel</span> <span class="n">@Inject</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">addPlanetUseCase</span><span class="p">:</span> <span class="n">AddPlanetUseCase</span><span class="p">,</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">):</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">savePlanet</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">addPlanetUseCase</span><span class="p">(</span>
</span><span class='line'>                <span class="n">Planet</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">planetId</span> <span class="p">=</span> <span class="n">planetId</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">name</span> <span class="p">=</span> <span class="n">_uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetName</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">distanceLy</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDistanceLy</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">discovered</span> <span class="p">=</span> <span class="n">uiState</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">planetDiscovered</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>            <span class="n">_uiState</span><span class="p">.</span><span class="n">update</span> <span class="p">{</span> <span class="n">it</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isPlanetSaved</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>步骤 6：编写数据源和 UI 元素</h2>

<p>现在我们已经完成了整个架构，可以编写最底层的代码了。也就是 UI 元素和数据源。对于 UI 元素，我们可以选择使用 Jetpack Compose 来支持手机和平板电脑。对于本地数据源，我们可以使用 Room DB 编写缓存；对于远程数据源，我们可以模拟访问远程 API。</p>

<p>这些层应该尽可能精简。例如，UI 元素代码不应包含任何计算或逻辑，而应仅包含获取视图模型给定状态并将其显示在屏幕上所需的代码。逻辑是为视图模型编写的。</p>

<p>对于数据源，只需编写实现 LocalDataSource 和 RemoteDataSource 接口中函数所需的最少代码即可。</p>

<p>具体的第三方技术（例如 Compose 和 Room）不在本教程的讨论范围内，但你可以在<a href="https://github.com/tdcolvin/PlanetSpotters">代码仓库</a> 中查看这些层的示例实现。</p>

<h3>将底层代码留到最后</h3>

<p>请注意，我们能够将应用程序的这些部分留到最后。这非常有益，因为它为利益相关者提供了充足的时间来决定使用哪些第三方技术以及应用程序的外观。即使在编写代码之后，我们也可以撤销这些决定，而不会影响应用程序的任何其他部分。</p>

<p>完整的代码库位于：<a href="https://github.com/tdcolvin/PlanetSpotters">https://github.com/tdcolvin/PlanetSpotters</a>。</p>

<p>本教程有很多内容需要学习；祝贺你坚持到最后。希望本教程对你有所帮助。我没有徽章（更不用说文凭）可以颁发——但请随意（甚至鼓励）自己制作一个，并将结果发布在这里。</p>

<p>当然，如果你有任何问题或意见，或者你不同意某些观点（实际上<em>特别是</em>如果你不同意某些观点），请分享！请在此处留言，我会尽力回复所有人。</p>

<p>最后，我目前每周提供几节免费课程，帮助任何有 Android 开发或应用业务相关经验的人士。你可以在这里预约：<a href="https://calendly.com/tdcolvin/android-assistance">calendly.com/tdcolvin/android-assistance</a>。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[如何构建Android应用：深入探讨原则而非规则]]></title>
    <link href="https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app/"/>
    <updated>2025-10-11T13:34:02+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「How to architect Android apps: a deep dive into principles, not rules」，原文链接<a href="https://proandroiddev.com/how-to-architect-android-apps-a-deep-dive-into-principles-not-rules-2f1eb7f26402">https://proandroiddev.com/how-to-architect-android-apps-a-deep-dive-into-principles-not-rules-2f1eb7f26402</a>，由Tom Colvin发布于2023年5月25日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/10/11/how-to-architect-an-android-app/"><img src="https://miro.medium.com/v2/resize:fit:2000/0*kT0PbUHF8ld0sU0t" title="auto auto" ></a></p>

<!-- more -->


<p>大多数 Android 开发者都经历过这样的场景……你被要求为应用添加一个简单的功能，但这样做会迫使你修改其他部分，然后又修改其他部分，直到你的修改变得非常繁琐，无法测试。</p>

<p>你可能也开发过这样的应用，用一些不靠谱的方式进行修改比弄清楚如何正确地做某件事要容易得多。或者，应用某个部分的修改会导致数百个完全不相关的 bug 突然出现。</p>

<p>这些都是糟糕架构的标志。</p>

<p>因此，本文基于我的演讲《别跟架构作对》探讨如何构建优秀的应用架构。</p>

<h3>正确的方法</h3>

<p>因为当你构建了优秀的应用架构后，你会发现它安全可靠、可测试且易于维护。你将能够推迟诸如使用哪个后端之类的决策，并在之后相对轻松地撤销这些决策。对我们开发者来说，最重要的是，有一个明确的“正确方法”，可以正确地隔离需要隔离的部分，这意味着即使是最初级的开发者也能在团队中发挥作用。</p>

<p>关于构建软件架构的“正确”方法有很多建议，其中很多都相互矛盾。因此，在本文中，我将为你提供架构背后的“原则”，以便你能够自行决定什么架构适合你自己的应用。所以，本文探讨的是原则，而不是规则。</p>

<blockquote><p>要成为一名优秀的架构师，学习原则，而不是规则。这样，你就可以根据你的软件和团队定制合适的架构。</p></blockquote>

<h2>SOLID 规则</h2>

<p>SOLID 规则是许多架构框架的基础，因此必须完全理解。我不会深入探讨这些规则，因为其他人已经在这方面做得很好。不过，我们先简单回顾一下：</p>

<h3>S = 责任分离</h3>

<p>该原则规定，一个类或模块<em>应该只有一个更改理由</em>。或者说，它应该只对一个<em>参与者</em>负责。这本质上意味着：将那些将单独演进的事物隔离开来。</p>

<h3>O = 开放-封闭</h3>

<p>你的代码应该允许你通过添加代码而不是修改现有代码来添加新功能。</p>

<h3>L = 里氏替换</h3>

<p>以麻省理工学院计算机科学家 Barbara Liskov 的名字命名。该原则规定，你应该能够使用任何派生类来替换基类。最重要的是，在派生基类时，不应尝试更改其含义。</p>

<h3>I = 接口隔离</h3>

<p>不应强迫客户端使用不适合他们的接口。拥有多个包含一两个方法的小型接口，而不是一个大型接口，这并没有什么坏处。</p>

<h3>D = 依赖倒置</h3>

<p>高级类不应依赖于低级类。相反，它们应该都依赖于抽象。</p>

<p>正确应用依赖倒置原则可以正确形成架构边界。让我们更深入地了解其工作原理。</p>

<h2>架构边界和依赖倒置</h2>

<p>假设我们有一个应用允许用户创建和保存个人资料。我们使用 Firebase 来实现这一点。以下是一个简单的实现：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:800/1*qORZctRds2AE60uxiH4w5Q.png" alt="流程图显示 User 类的 saveProfile 方法直接调用 FirebaseProfileSaver 类，这是错误的，因为违反了依赖倒置原则" /></p>

<p>这里，User 类调用了 FirebaseProfileSaver 类中的方法，该方法使用 Firebase 保存个人资料。User 类被称为<em>高级</em>类，因为它包含业务逻辑（即，它是纯逻辑，而不是关于数据如何读写到系统的具体细节）。相比之下，“FirebaseProfileSaver”是一个<em>低级</em>类，之所以这样称呼是因为它包含实现细节，即为特定技术编写的代码。</p>

<p>这种布局违反了依赖倒置原则，因为高级的东西依赖于低级的东西。我所说的依赖，是指严格的源代码含义：在“User”类中，有一行代码写着“import x.y.FirebaseProfileSaver”或类似的代码。也许依赖关系被移除了几层——比如“User”导入了“X”，而“X”又导入了“Y”，而“Y”又导入了“FirebaseProfileSaver”——但关键在于，你可以沿着依赖关系的方向画一组箭头，最终从“User”指向“FirebaseProfileSaver”。</p>

<p>为什么这会是个问题？一个问题是Firebase的变更并不是孤立的。如果Firebase SDK有一天发生了变化，那么显然“FirebaseProfileSaver”也需要随之改变；但没有什么可以阻止这种情况发生，因为它会影响“User”及其依赖的任何内容。测试更改意味着测试所有内容。</p>

<p>而且它也不太灵活。如果我们想从 Firebase 迁移到其他远程存储提供商，我们最终可能不得不重写应用程序的大部分内容。</p>

<h3>依赖倒置：“插头插座”解决方案</h3>

<p>解决方案是将“FirebaseProfileSaver”设置为一种“插头”，将“User”类设置为一种“插座”。“User”类必须对“FirebaseProfileSaver”一无所知；但它可以在抽象中了解保存配置文件的过程。无论我们将什么“插头”插入“User”的“套接字”（可以是“FirebaseProfileSaver”、“RoomDatabaseProfileSaver”或“MyProprietaryAPIProfileSaver”），“套接字”都知道如何与之通信，因为从“套接字”的角度来看，它们的操作方式都相同。</p>

<p>因此，“FirebaseProfileSaver”被重构为适合该套接字的插头。</p>

<p>它看起来像这样：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1000/1*oZXp4UqYwNb2Rhdo2I0_cQ.png" alt="流程图展示了一个 User 类，其中包含一个 saveProfile 方法，它调用了 ProfileSaver 接口上的 saveProfile 方法。另外，FirebaseProfileSaver 类实现了该接口。右图：正确应用了依赖倒置原则" /></p>

<p>这里，<code>User</code> 类只知道如何抽象地与“<code>ProfileSaver</code>”交互。重要的是，它没有提及任何与 Firebase 相关的内容。</p>

<p>然后，<code>FirebaseProfileSaver</code> 实现了 <code>ProfileSaver</code> 接口。<code>User</code> 类对此一无所知，因此，至关重要的是，它的任何逻辑都不基于 Firebase 的工作方式。</p>

<p>这隔离了 Firebase 逻辑。我们可以像上图一样在低级代码和高级代码之间画一条红线。这条红线就是架构边界。</p>

<p>注意依赖关系箭头现在是如何从低级指向高级的。不再存在任何可以遵循的从“User”类开始到 Firebase 结束的依赖箭头序列。</p>

<h2>架构边界应该放在哪里？</h2>

<p>显然，正确设置架构边界对于良好的架构至关重要。从上文来看，边界似乎越多越好——但事实并非如此。</p>

<p>架构边界会带来维护开销。它们会产生更多代码，而且一旦设置了边界，每个未来的开发人员都必须遵守它。</p>

<p>而且，带有边界的代码可读性会大大降低。从上文来看，<code>User</code> 类的 <code>profileSaver.saveProfile()</code> 调用实际上触发了 Firebase 逻辑，这一点并不明显。因此，新开发人员的入职培训会变得更加棘手，代码审查也会更加困难。</p>

<p>整洁架构 (Clean Architecture) 是合理化架构边界的一种尝试。</p>

<h2>Android 应用的整洁架构怎么样？</h2>

<p>整洁架构是由资深架构师 Robert C Martin 整理的一套原则，它在一定程度上提供了一种将软件合理化为一组选定层级的方法，这些层级由架构边界划分。</p>

<p>其著名的图表如下所示：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/0*iq1PK8t-7rusKw4r" alt="著名的整洁架构图，出自罗伯特·C·马丁的著作《整洁架构》。整洁架构图由一系列同心圆组成。最内圈标记为实体，其次是用例，然后是接口适配器，最外圈是框架和驱动程序" /></p>

<p>这张分层图的中心是高级代码（即纯逻辑），外围是低级代码。它遵循依赖规则（本质上是 SOLID 依赖倒置原则的产物），该规则规定低级代码可以依赖于高级代码，但反过来则不行。因此，上图中表示依赖关系的箭头始终指向内部。</p>

<p>那么，这些层级由什么组成呢？</p>

<h3>用例和实体（黄色和红色圆圈）</h3>

<p>在清晰架构图的正中央，我们可以看到用例层和实体层。它们包含应用的业务逻辑。这些逻辑是控制应用行为的纯逻辑，与具体的实现细节无关。</p>

<p>这种区别可能会造成混淆，因此我们来举个例子。</p>

<p>一个保存用户个人资料的用例会执行以下操作：</p>

<ol>
<li>运行一些安全性/一致性检查。确保正在保存的个人资料包含有效数据，并且用户有权执行此操作。</li>
<li>远程保存数据</li>
<li>在本地缓存新的个人资料</li>
<li>通知 UI 需要更新</li>
</ol>


<p>你可以说这些都是业务逻辑，因为它们与“我们在做什么”有关，而不是“我们如何做”。例如，在步骤 2 中，我们不会说明使用哪个远程 API 来保存数据；在步骤 4 中，我们也不关心要更新的 UI 是 Android 手机屏幕、网页还是 PDF。</p>

<p>一个用例代表来自单个参与者的单一需求（请参阅上文 SOLID 的单一职责原则）。它也是一个完整的步骤列表——你无需执行任何其他操作即可保存配置文件，并且尝试仅运行其中的一部分步骤毫无意义。</p>

<h3>接口适配器（绿色圆圈）</h3>

<p>这是用例细节的体现。例如，当一个用例要求在本地缓存一些数据时，我们可以在这里讨论 SQL 数据库。我们仍然不会讨论特定品牌的 SQL 数据库——任何专有技术都应放在后面讨论。如果有多个数据源，则接口适配器层应该对它们进行整理并管理差异。</p>

<p>几乎所有 MVVM、MVC、MVP 等拓扑结构都应该放在这里。同样，这里不涉及专有技术——所以我们这里不讨论 Jetpack Compose 或 Android XML——但我们确实保存了这些部分将要使用的状态。</p>

<h3>框架和驱动程序（蓝色圆圈）</h3>

<p>所有使用专有技术的内容都放在这里。这些是<em>实现细节</em>。</p>

<p>Jetpack Compose 的 <code>@Composable</code> 代码也放在这里。HTML 代码也放在这里。此外，Firebase 代码、任何 API 的具体细节、SQL 命令以及任何标有 Room 注解（例如 <code>@Entity</code>）的内容也放在这里……</p>

<p>此层的代码很难测试，因为它通常依赖于专有技术。例如，Jetpack Compose 测试依赖于专门为 Jetpack Compose 编写的工具（或者可能是为 Android 编写的工具，但重点依然存在）。因此，请尽可能精简此层。逻辑应该放在更高的层级。这只是将接口适配器的要求“翻译”到你正在使用的特定技术所需的最低限度。</p>

<p>这一层也是<em>易失性的</em>。它可能会在没有你输入的情况下发生变化和中断。例如，如果你正在使用的 API 突然需要不同类型的身份验证，你将不得不修改代码以适应，无论时机是否合适或你是否愿意接受这种变化。同样，尽可能精简这一层可以减少此类更改对代码库其余部分的影响。</p>

<h2>Android 专用代码在 Clean Architecture 中位于何处？</h2>

<p>根据 Clean Architecture 的官方定义，Android 是一项专有技术，因此应将其限制在框架和驱动程序（蓝色）层。任何带有“import android.x.y”或“import androidx.x.y”的代码都不应超出此层。</p>

<p>这在实践中可能非常难以实现。</p>

<p>一个例子是权限请求，有时在视图模型（即接口适配器区域）中提及会更方便（且更具可读性）。</p>

<p>因此，这完美地诠释了为什么我希望本文关注的是“原则”而​​非“规则”。如果你为了遵循某条规则而费尽心思，那么请考虑其背后的原则——它们可能与你的情况相关，也可能不相关。</p>

<p>就此示例而言，我个人认为允许在接口适配器中提及 Android 是可以接受的。毕竟，你正在构建一款 Android 应用，除非你未来有相当大的可能性会与 iOS 或 Web 应用共享完全相同的代码库，否则你没有必要为了避免 Android 而修改代码。显然，iOS 和 Web 应用通常都有各自独立的代码库。</p>

<h2>什么造就了一款优秀的应用？我们如何构建它？</h2>

<p>一款应用应该专注于一件事，并且做好它。它的目的不会随着时间的推移而发生太大变化，尽管它在其生命周期中可能会推出许多新功能，但它的目标受众几乎从未改变（根据单一职责原则，它的角色始终相同）。事实上，如果利益相关者开始要求你的应用迎合其他类型的用户，你通常最好为他们创建一个新的应用，以便更好地满足他们的需求。微软并没有单一的 Office 应用；相反，它有独立的 Word、Excel 和 Powerpoint 应用，每个应用都由不同的用户使用，有着不同的需求。</p>

<p>所以你可能会说，整洁架构（Clean Architecture）——其中许多原则旨在保护你免受 Android 应用中不太可能发生的此类更改的影响——对于我们的目的来说实在太过繁琐。在很多情况下，我同意你的观点。</p>

<p>谷歌似乎也同意这一点。它自己的架构建议——称之为“现代应用架构”（Modern App Architecture）——是整洁架构的一个略微宽松的版本。</p>

<h2>Google 的现代应用架构</h2>

<p>Google 将其架构简化为三层：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:938/1*Y9TFujbKQzLtY1rJynlmSA.png" alt="Google 现代应用架构的拓扑结构：流程图展示了 Google 现代应用架构的三个层级。UI 层指向领域层（标记为可选）。数据层也指向领域层。" /></p>

<p>广义上讲，UI 层用于处理用户的输入和输出，并更新显示内容。领域层用于处理业务逻辑——几乎与 Clean Architecture 的用例完全相同。数据层用于从应用的存储机制读取和写入数据。</p>

<p>这是一种单向架构。状态仅向上流动，事件仅向下流动。</p>

<p>让我们更详细地了解这一切的含义。</p>

<h3>UI 层：UI 元素和状态持有者</h3>

<p><img src="https://miro.medium.com/v2/resize:fit:950/1*81Y6jlUs43MnvwwvBu7zzw.png" alt="现代应用架构的 UI 层：上图中 UI 层的扩展，显示它由 UI 元素和状态持有者组成" /></p>

<p>UI 层分为 UI 元素和状态持有者。</p>

<p>UI 元素部分仅包含为专有技术编写的代码。如果你使用的是 Jetpack Compose，请将你的 @Composable 代码放在此处。如果你使用的是 Fragments 和 XML，那么 @Composable 代码也放在此处。除此之外，没有其他内容。没有逻辑，也没有数据。</p>

<p>（“无逻辑”规则有时对于 XML 数据绑定的用户来说很困难。例如，数据绑定允许你完全在 XML 代码中实现摄氏度/华氏度切换。不要这样做。）</p>

<p>相比之下，逻辑和数据则放在状态持有者中。它们之所以被称为“领域层”，是因为它们保存着 UI 的状态。想想视图控制器。它们包含支持 UI 控件的变量——所以，假设你的 UI 有一个文本字段，那么包含该文本字段内容的变量就放在这里。</p>

<p>一个很好的建议是将这样的状态变量暴露给 Kotlin Flows。这巧妙地封装了它们的动态特性，并提供了一种内置机制来向 UI 发出需要更新的信号。</p>

<h3>领域层：用例</h3>

<p>领域层包含的用例与“清晰架构”中的用例完全相同。也就是说，它是由单个参与者执行单个任务所需步骤的完整列表。</p>

<p>但在 Google 的架构中，这一层是可选的。这意味着将纯业务逻辑放在状态持有者（比如视图模型）中并没有错。</p>

<p>当业务逻辑在多个状态持有者之间重用时，将业务逻辑提取到领域层中可以避免代码重复。比如说，应用程序的多个部分允许更新用户的个人资料；在这种情况下，你可以创建一个 <code>UpdateUserProfileUseCase</code> 并在需要的地方引用它。</p>

<h3>数据层：存储库和数据源</h3>

<p>数据层分为存储库和数据源。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:950/1*gmZwdLcQrrLRkSGnR3PL1w.png" alt="现代应用架构的数据层：现代应用架构图的扩展，显示数据层分为存储库和数据源" /></p>

<p>存储库负责提供数据和保存数据。它包含 <code>getUserProfile()</code> 和 <code>saveUserProfile(…)</code> 方法。</p>

<p>数据源执行专有工作，例如通过调用 API 或编写 SQL 命令。</p>

<p>通常，一个存储库负责多个数据源。例如，你可能将数据存储在远程存储库和相同的本地缓存中。每个存储库都将作为单独的数据源实现。然后，在读取用户个人资料时，存储库可能会尝试从本地缓存读取，如果缓存为空，则回退到远程数据库。这样，负责多个数据源的存储库必须协调使用哪个数据源以及如何同步它们。</p>

<p>再次强调，使用 Kotlin Flows 向调用者提供数据是一种很好的做法。</p>

<h2>比较 Google 的现代应用架构与 Clean Architecture</h2>

<p>你可能已经注意到，现代应用架构和 Clean Architecture 各自使用“层”一词来表示略有不同的含义。以下是它们之间的对应关系：</p>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*9Ds8N-6LZNDNclnZEyX48w.png" alt="现代应用架构如何与 Clean Architecture 相适应：现代应用架构和 Clean Architecture 图表的比较，显示：UI 层与 Clean Architecture 的 UI 和 Presenter 对应（分别位于框架和驱动程序层以及接口适配器层）。领域层与 Clean Architecture 的用例层和实体层对应。数据层与 Clean Architecture 的存储库和 Presenter 对应（分别位于接口适配器层以及框架和驱动程序层）。" /></p>

<p>Google 的 UI 层与其数据层一样，位于 Clean Architecture 的外层两层（接口适配器、框架和驱动程序）。它的领域层完全等同于 Clean Architecture 的用例和实体。</p>

<p>其中一些界限比上图显示的要模糊一些。例如，Google 并不反对你将业务逻辑放置在 UI 层，这就是为什么它自己的领域层被标记为可选的原因。</p>

<p>UI 层和数据层都等同于 Clean Architecture 的接口适配器层和框架/驱动程序层。</p>

<h2>总结……</h2>

<p>本文深入探讨了良好架构背后的原则，并以两种常见范式为灵感：Clean Architecture 和 Google 的现代应用架构。</p>

<p>当然，你需要自行决定哪种架构最适合你的应用程序。我希望通过提供思路而不是僵化的框架，为你提供一个工具包，以便你自行做出决定。</p>

<p>我喜欢回答关于架构的具体问题，所以请随时在这里留下你的答案，我会尽快回复。当没有唯一的“正确”答案，而我们可以进行讨论时，这才是最有趣的。</p>

<p>在以后的文章中，我将使用上述内容逐步指导你使用 Kotlin 和 Compose 创建架构良好的示例应用程序。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[面向开发者的系统设计：像建筑师一样思考]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"/>
    <updated>2025-09-24T14:31:48+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「System Design for Developers: Think Like an Architect」，原文链接<a href="https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28">https://towardsdev.com/system-design-for-developers-think-like-an-architect-87f32882ca28</a>，由Saurabh Singh发布于2025年8月25日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/24/system-design-for-developers/"><img src="https://miro.medium.com/v2/resize:fit:1400/1*b1eSMQdryXSteTJredbMtA.png" title="auto auto" ></a></p>

<!-- more -->


<blockquote><p>“建筑是一种社会行为，也是人类活动的物质舞台。”—— Spiro Kostof</p></blockquote>

<p>正如建筑师不会在没有蓝图的情况下开始建造一样，开发者也不应该在没有系统设计的情况下开始编码。然而，许多开发者直接进入实现阶段，却发现自己陷入了技术债务、性能瓶颈和架构噩梦的迷宫之中，而这些本可以通过适当的规划来避免。</p>

<p>系统设计是一门艺术和科学，它定义系统的架构、组件、模块、接口和数据，以满足特定需求。它就像一座屹立百年的房屋和一座因自身重量而倒塌的房屋之间的区别。</p>

<h2>建筑师的思维方式：分解复杂问题</h2>

<h2>分层思考，而非直线思考</h2>

<p>想象一下，你正在设计一座摩天大楼。你不会先决定第 47 层的墙壁要刷什么颜色。你会先从地基开始，然后是结构框架，接着是电气和管道系统，最后是室内设计。</p>

<p>软件系统也遵循同样的原则。想象一下<strong>可视化页面构建器应用程序</strong>——想想 Webflow、Wix 或 Squarespace 等工具，它们允许用户通过拖放界面创建网页，而无需编写代码。这些系统非常复杂，用户可以：</p>

<ul>
<li>将组件（按钮、图片、文本块）从库拖放到画布上</li>
<li>通过可视化控件自定义属性（颜色、字体、大小）</li>
<li>在构建过程中实时预览页面</li>
<li>将网站直接发布到 Web 上</li>
<li>与团队成员实时协作</li>
</ul>


<p>架构师无需深入研究拖放功能的实现细节，而是首先思考：</p>

<p>基础层：核心实体有哪些？</p>

<p>页面、组件、模板、用户、项目</p>

<p>结构层：这些实体之间如何关联？</p>

<p>用户创建项目
项目包含页面
页面由组件组成
组件可以保存为模板</p>

<p>系统层：它们如何通信？</p>

<ul>
<li>用于 CRUD 操作的 RESTful API</li>
<li>用于实时协作的 WebSocket 连接</li>
<li>用于组件更新的事件驱动架构</li>
</ul>


<p><strong>界面层</strong>：用户如何交互？</p>

<ul>
<li>用于项目管理的仪表盘</li>
<li>用于页面编辑的画布</li>
<li>用于选择的组件库</li>
<li>用于测试的预览模式</li>
</ul>


<p>正如软件工程师 Grady Booch 曾经说过的：“优秀软件的功能在于化繁为简。” 这种分层方法将极其复杂的内容转化为易于管理的模块。</p>

<h2>📝 互动练习：分层架构</h2>

<p><strong>现在就拿起纸笔！</strong>在继续阅读之前，请尝试以下方法：</p>

<ol>
<li><strong>画四个水平矩形</strong>，并将它们叠放在一起</li>
<li><strong>从上到下分别标注</strong>：界面、系统、结构、基础</li>
<li><strong>选择你日常使用的任何应用</strong>（Netflix、Amazon、WhatsApp）</li>
<li><strong>在每一层</strong>中填入你认为应该填入的内容</li>
</ol>


<p>Netflix 示例：_</p>

<ul>
<li>界面：搜索栏、视频播放器、推荐</li>
<li>系统：流媒体服务、推荐引擎、用户身份验证</li>
<li>结构：用户观看电影，电影有评分</li>
<li>基础：用户、电影、评分、订阅</li>
</ul>


<p><strong>为什么要画这个？</strong>你的大脑对你手绘内容的记忆力比你刚刚阅读的内容强 6 倍。这张简单的草图会让你立刻理解文章的其余部分。</p>

<p><img src="https://miro.medium.com/v2/resize:fit:2000/1*k5g3kjh3ugcfUf5CWJjoFw.jpeg" alt="我在重新设计视频平台架构时画了这张草图。产品经理终于明白了为什么我们不能简单地“添加一个功能”——他能看到它会影响到哪个层级。这张图避免了3个月的技术债务！" /></p>

<h2>分解策略</h2>

<p>分解复杂问题就像解剖手表。你需要了解每个齿轮、弹簧和机械装置，然后才能构建或修复整个钟表。</p>

<p><strong>功能分解示例</strong>：可视化页面构建器</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Page</span> <span class="n">Builder</span> <span class="n">System</span>
</span><span class='line'><span class="err">├──</span> <span class="n">Authentication</span> <span class="o">&amp;</span> <span class="n">Authorization</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">User</span> <span class="n">registration</span><span class="o">/</span><span class="n">login</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Role</span><span class="o">-</span><span class="n">based</span> <span class="n">permissions</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="n">Session</span> <span class="n">management</span>
</span><span class='line'><span class="err">├──</span> <span class="n">Project</span> <span class="n">Management</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Project</span> <span class="n">CRUD</span> <span class="n">operations</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Version</span> <span class="n">control</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="n">Collaboration</span> <span class="n">features</span>
</span><span class='line'><span class="err">├──</span> <span class="n">Page</span> <span class="n">Editor</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Canvas</span> <span class="n">rendering</span> <span class="n">engine</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Component</span> <span class="n">management</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Drag</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">drop</span> <span class="n">interface</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="n">Real</span><span class="o">-</span><span class="n">time</span> <span class="n">preview</span>
</span><span class='line'><span class="err">├──</span> <span class="n">Component</span> <span class="n">Library</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Built</span><span class="o">-</span><span class="ow">in</span> <span class="n">components</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="n">Custom</span> <span class="n">components</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="n">Template</span> <span class="n">system</span>
</span><span class='line'><span class="err">└──</span> <span class="n">Export</span> <span class="o">&amp;</span> <span class="n">Publishing</span>
</span><span class='line'>    <span class="err">├──</span> <span class="n">Static</span> <span class="n">site</span> <span class="n">generation</span>
</span><span class='line'>    <span class="err">├──</span> <span class="n">Hosting</span> <span class="n">integration</span>
</span><span class='line'>    <span class="err">└──</span> <span class="n">SEO</span> <span class="n">optimization</span>
</span></code></pre></td></tr></table></div></figure>


<p>每个分支都可以独立开发、单独测试，并系统地集成。这种方法遵循 Unix 哲学：“专心做好一件事。”</p>

<h2>📝 互动练习：系统分解树</h2>

<p><strong>又该画草图了！</strong> 这个练习可以训练你的“架构师大脑”：</p>

<ol>
<li><strong>画一个树形结构</strong>，以“页面构建器”为根</li>
<li><strong>添加 5 个主要分支</strong>（思考：哪些是大块？）</li>
<li><strong>在每个分支下，添加 2-3 个叶子</strong>（较小的部分）</li>
<li><strong>使用简单的方框和线条</strong>——无需复杂的图表！</li>
</ol>


<p><em>你的绘图可能看起来像：</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='gherkin'><span class='line'><span class="nf">Page Builder</span>
</span><span class='line'><span class="nf">   /</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="k">   |</span>
</span><span class='line'>
</span><span class='line'><span class="nf">   \</span>
</span><span class='line'><span class="nf"> Auth  Pages  Components  Export</span>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span>
</span><span class='line'>
</span><span class='line'><span class="k">  |</span><span class="nf"></span>
</span><span class='line'><span class="nf">Login  Create   Library   HTML</span>
</span><span class='line'><span class="nf">Signup Edit</span>
</span><span class='line'>
</span><span class='line'><span class="nf">Custom</span>
</span><span class='line'>
</span><span class='line'><span class="nf">PDF</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>神奇时刻</strong>：当你无法进一步分解一个方框时，这可能就是一个开发人员一周的工作。如果觉得方框太大，就进一步分解它！</p>

<h2>可扩展性：今天构建，应对未来的问题</h2>

<h2>成长型思维</h2>

<blockquote><p>“种一棵树的最佳时机是20年前，其次是现在。”——中国谚语</p></blockquote>

<p>可扩展性规划就像为房子选择地基。你可能从一栋小屋开始，但如果你计划扩建成一座豪宅，你就需要一个能够支撑未来发展的地基。</p>

<p>考虑三个可扩展性维度：</p>

<p><strong>垂直扩展（向上扩展）</strong>：就像在建筑物中增加更多楼层</p>

<ul>
<li>增加现有服务器上的 CPU、RAM 或存储空间</li>
<li>简单但存在物理限制</li>
<li>单点故障</li>
</ul>


<p><strong>水平扩展（向外扩展）</strong>：就像在综合体中建造更多建筑物</p>

<ul>
<li>添加更多服务器以分散负载</li>
<li>更复杂但几乎不受限制</li>
<li>更好的容错能力</li>
</ul>


<p><strong>功能扩展</strong>：就像为不同用途建造专用建筑物</p>

<ul>
<li>微服务架构</li>
<li>每个服务处理特定功能</li>
<li>独立扩展和部署</li>
</ul>


<h2>可扩展性的红绿灯系统</h2>

<p><strong>🟢 绿灯决策（第一天）</strong>：</p>

<ul>
<li>简单的单体架构</li>
<li>单一数据库</li>
<li>使用 Redis 进行基本缓存</li>
<li>静态资源的 CDN</li>
</ul>


<p><strong>🟡 黄灯决策（流量增长）</strong>：</p>

<ul>
<li>数据库只读副本</li>
<li>应用服务器集群</li>
<li>API 速率限制</li>
<li>监控和报警系统</li>
</ul>


<p><strong>🔴 红灯决策（高流量）</strong>：</p>

<ul>
<li>微服务架构</li>
<li>数据库分片</li>
<li>用于异步处理的消息队列</li>
<li>自动扩展基础设施</li>
</ul>


<p>对于我们的页面构建器示例，你可以从一个简单的 Python FastAPI 服务器和 PostgreSQL 数据库开始。随着流量的增长，你将引入：</p>

<ol>
<li><strong>缓存层</strong>：用于会话存储和频繁访问的模板的 Redis</li>
<li><strong>CDN</strong>：用于服务组件资源和生成页面的 CloudFront</li>
<li><strong>数据库优化</strong>：用于分析的读取副本，为不同域提供独立的数据库</li>
<li><strong>服务分离</strong>：用于渲染、文件管理和用户管理的专用微服务</li>
</ol>


<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*93OTsJ_L4-7WhICsL2EL4w.jpeg" alt="我绘制产品目标的草图" /></p>

<h2>📝 互动练习：扩展演进</h2>

<p><strong>这张图将成为你的扩展路线图！</strong></p>

<ol>
<li>在你的纸上<strong>画三列</strong>，分别标记为：“第 1 天”、“第 6 个月”、“第 2 年”</li>
<li><p><strong>在每一列中，画出你的架构图：</strong></p></li>
<li><p>第 1 天：画两个方框（前端、API），下方画一个圆柱体（数据库）</p></li>
<li>第 6 个月：添加更多方框（Redis 缓存、CDN 云、负载均衡器）</li>
<li>第 2 年：将 API 方框拆分成多个小方框（用户服务、项目服务等）</li>
</ol>


<p><strong>3. 在各列之间画箭头</strong>，展示演进过程</p>

<p><strong>4. 在每列上方画一些简笔画</strong>，展示用户数量：100 → 1 万 → 100 万</p>

<p><strong>从你的图中得出的关键洞察：</strong>注意复杂性是如何逐渐增长的，而不是一下子增长的。这就是真实系统演进的方式！</p>

<h2>职责三位一体：数据库、API 和前端</h2>

<h2>三层架构理念</h2>

<p>将 Web 应用程序想象成一家餐厅：</p>

<p><strong>前端（餐厅）</strong>：客户互动的地方</p>

<ul>
<li>用户界面和体验</li>
<li>输入验证和格式化</li>
<li>状态管理和路由</li>
</ul>


<p><strong>API（厨房）</strong>：魔法发生的地方</p>

<ul>
<li>业务逻辑处理</li>
<li>数据转换和验证</li>
<li>与外部服务集成</li>
</ul>


<p><strong>数据库（食品储藏室）</strong>：食材存储的地方</p>

<ul>
<li>数据持久化和检索</li>
<li>数据完整性和关系</li>
<li>性能优化</li>
</ul>


<blockquote><p>“好的架构不在于结构本身，而在于它所创造的空间。” — 安藤忠雄</p></blockquote>

<h2>📝 互动练习：餐厅架构</h2>

<p><strong>让我们通过一个绘画练习来具体化这一点：</strong></p>

<ol>
<li><p><strong>绘制一个简单的餐厅平面图</strong>，其中包含三个区域：</p></li>
<li><p>餐厅（顾客就座的地方）</p></li>
<li>厨房（准备食物的地方）</li>
<li>储藏室（存放食材的地方）</li>
</ol>


<p><strong>2. 现在绘制箭头表示数据流向：</strong></p>

<ul>
<li>顾客点餐 → 厨房</li>
<li>厨房索取食材 → 储藏室</li>
<li><p>厨房送出准备好的食物 → 餐厅</p></li>
<li><p><strong>为每个区域标注相应的 Web 对应项：</strong></p></li>
<li><p>餐厅 = 前端</p></li>
<li>厨房 = API</li>
<li>储藏室 = 数据库</li>
</ul>


<p><strong>为什么这样做有效：</strong>现在你的大脑已经对抽象的系统概念有了物理隐喻。每次设计系统时，想象一下这家餐厅的场景！</p>

<h2>职责边界</h2>

<p><strong>数据库职责</strong>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">✅</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">handles</span> <span class="n">data</span> <span class="n">integrity</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">users</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">email</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">UNIQUE</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span>
</span><span class='line'>    <span class="n">created_at</span> <span class="n">TIMESTAMP</span> <span class="n">DEFAULT</span> <span class="n">NOW</span><span class="p">()</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">--</span> <span class="err">✅</span> <span class="n">Good</span><span class="p">:</span> <span class="n">Database</span> <span class="n">enforces</span> <span class="n">relationships</span>
</span><span class='line'><span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">pages</span> <span class="p">(</span>
</span><span class='line'>    <span class="nb">id</span> <span class="n">SERIAL</span> <span class="n">PRIMARY</span> <span class="n">KEY</span><span class="p">,</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="n">INTEGER</span> <span class="n">REFERENCES</span> <span class="n">projects</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span> <span class="n">ON</span> <span class="n">DELETE</span> <span class="n">CASCADE</span><span class="p">,</span>
</span><span class='line'>    <span class="n">title</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span> <span class="n">NOT</span> <span class="n">NULL</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>API 职责</strong>（Python 和 FastAPI）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># ✅ Good: API handles business logic</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span><span class="p">,</span> <span class="n">Depends</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span><span class="nd">@app.post</span><span class="p">(</span><span class="s">&quot;/api/pages&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">create_page</span><span class="p">(</span>
</span><span class='line'>    <span class="n">page_data</span><span class="p">:</span> <span class="n">PageCreateModel</span><span class="p">,</span>
</span><span class='line'>    <span class="n">current_user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_user</span><span class="p">)</span>
</span><span class='line'><span class="p">):</span>
</span><span class='line'>    <span class="c"># Validate user permissions</span>
</span><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">can_user_edit_project</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">page_data</span><span class="o">.</span><span class="n">project_id</span><span class="p">):</span>
</span><span class='line'>        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s">&quot;Unauthorized&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># Apply business rules</span>
</span><span class='line'>    <span class="n">page</span> <span class="o">=</span> <span class="n">await</span> <span class="n">create_page_with_defaults</span><span class="p">(</span><span class="n">page_data</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># Return appropriate response</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">{</span><span class="s">&quot;page&quot;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span> <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;Page created successfully&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>前端职责</strong>（Angular）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// ✅ Good: Frontend handles user interaction</span>
</span><span class='line'><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">selector</span><span class="o">:</span> <span class="s1">&#39;app-page-editor&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">templateUrl</span><span class="o">:</span> <span class="s1">&#39;./page-editor.component.html&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageEditorComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">components</span><span class="o">:</span> <span class="nx">Component</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
</span><span class='line'>  <span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Handle user interactions</span>
</span><span class='line'>  <span class="nx">onComponentDrop</span><span class="p">(</span><span class="nx">component</span><span class="o">:</span> <span class="nx">Component</span><span class="p">,</span> <span class="nx">position</span><span class="o">:</span> <span class="nx">Position</span><span class="p">)</span><span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">addComponent</span><span class="p">(</span><span class="nx">component</span><span class="p">,</span> <span class="nx">position</span><span class="p">)</span>
</span><span class='line'>      <span class="p">.</span><span class="nx">subscribe</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">next</span><span class="o">:</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">updateComponents</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">error</span><span class="o">:</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">),</span>
</span><span class='line'>        <span class="nx">complete</span><span class="o">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">isLoading</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>架构模式：伟大系统的基石</h2>

<h2>模型-视图-控制器 (MVC)：经典模式</h2>

<p>MVC 就像组织一场戏剧演出：</p>

<ul>
<li><strong>模型</strong>：剧本和故事（数据和业务逻辑）</li>
<li><strong>视图</strong>：舞台和演员（用户界面）</li>
<li><strong>控制器</strong>：导演（模型和（查看）</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="c1"># Model: Page data and operations</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span> <span class="nx">import</span> <span class="nx">Column</span><span class="p">,</span> <span class="nx">Integer</span><span class="p">,</span> <span class="nb">String</span><span class="p">,</span> <span class="nx">JSON</span>
</span><span class='line'><span class="nx">from</span> <span class="nx">sqlalchemy</span><span class="p">.</span><span class="nx">ext</span><span class="p">.</span><span class="nx">declarative</span> <span class="nx">import</span> <span class="nx">declarative_base</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span><span class="k">class</span> <span class="nc">PageModel</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
</span><span class='line'>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s">&quot;pages&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">title</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>    <span class="n">components</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">)</span>
</span><span class='line'>    <span class="n">project_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">async</span> <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_session</span><span class="p">):</span>
</span><span class='line'>        <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="bp">self</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='coffeescript'><span class='line'><span class="o">//</span> <span class="nv">View: </span><span class="nx">Page</span> <span class="nx">rendering</span> <span class="p">(</span><span class="nx">Angular</span> <span class="nx">Component</span><span class="p">)</span>
</span><span class='line'><span class="nx">@Component</span><span class="p">({</span>
</span><span class='line'>  <span class="nv">selector: </span><span class="s">&#39;app-page-view&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nv">template: </span><span class="o">`</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span> <span class="k">class</span><span class="o">=</span><span class="s">&quot;page&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="p"></span><span class="o">&lt;/</span><span class="nx">h1</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span>
</span><span class='line'>        <span class="o">*</span><span class="nx">ngFor</span><span class="o">=</span><span class="s">&quot;let component of pageModel.components&quot;</span>
</span><span class='line'>        <span class="p">[</span><span class="nx">componentData</span><span class="p">]</span><span class="o">=</span><span class="s">&quot;component&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;/</span><span class="nx">app</span><span class="o">-</span><span class="nx">component</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;/</span><span class="nx">div</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">`</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="nx">export</span> <span class="k">class</span> <span class="nx">PageViewComponent</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">@Input</span><span class="p">()</span> <span class="nv">pageModel: </span><span class="nx">PageModel</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Controller: Coordination logic (Angular Service)</span>
</span><span class='line'><span class="err">@</span><span class="nx">Injectable</span><span class="p">({</span>
</span><span class='line'>  <span class="nx">providedIn</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PageController</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">apiService</span><span class="o">:</span> <span class="nx">ApiService</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">async</span> <span class="nx">updateTitle</span><span class="p">(</span><span class="nx">pageId</span><span class="o">:</span> <span class="nx">number</span><span class="p">,</span> <span class="nx">newTitle</span><span class="o">:</span> <span class="nx">string</span><span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">const</span> <span class="nx">updatedPage</span> <span class="o">=</span> <span class="nx">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">apiService</span><span class="p">.</span><span class="nx">updatePage</span><span class="p">(</span><span class="nx">pageId</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span><span class="o">:</span> <span class="nx">newTitle</span> <span class="p">});</span>
</span><span class='line'>    <span class="c1">// Emit event to refresh view</span>
</span><span class='line'>    <span class="k">this</span><span class="p">.</span><span class="nx">pageUpdated</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">updatedPage</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>事件驱动架构：神经系统</h2>

<p>事件驱动架构就像人类的神经系统——当某个部分发生事件时，其他部分会自动做出反应。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Event system for page builder</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Callable</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">asyncio</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">EventBus</span><span class="p">:</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">):</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">event</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>
</span><span class='line'>            <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">event</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">async</span> <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
</span><span class='line'>        <span class="n">callbacks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="p">[])</span>
</span><span class='line'>        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">callback</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="p">])</span><span class="c"># Usage</span>
</span><span class='line'><span class="n">event_bus</span> <span class="o">=</span> <span class="n">EventBus</span><span class="p">()</span><span class="c"># Auto-save feature</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">auto_save_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">auto_save</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">])</span>
</span><span class='line'>    <span class="n">await</span> <span class="n">show_save_indicator</span><span class="p">()</span><span class="c"># Analytics tracking</span>
</span><span class='line'><span class="nd">@event_bus.on</span><span class="p">(</span><span class="s">&#39;component:added&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">async</span> <span class="k">def</span> <span class="nf">analytics_handler</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span><span class='line'>    <span class="n">analytics</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s">&#39;Component Added&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;component_type&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;component&#39;</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;page_id&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;page_id&#39;</span><span class="p">]</span>
</span><span class='line'>    <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<h2>微服务：专业团队</h2>

<p>微服务就像一个爵士乐团——每个音乐家（服务）都是各自乐器的专家，但他们共同努力，创造出美妙的音乐。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># Docker Compose for Page Builder Microservices</span>
</span><span class='line'>version: <span class="s1">&#39;3.8&#39;</span>
</span><span class='line'>services:
</span><span class='line'>  user-service:
</span><span class='line'>    image: pagebuilder/user-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://users_db
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8001:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      project-service:
</span><span class='line'>    image: pagebuilder/project-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://projects_db
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8002:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      rendering-service:
</span><span class='line'>    image: pagebuilder/rendering-service:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">REDIS_URL</span><span class="o">=</span>redis://redis:6379
</span><span class='line'>      - <span class="nv">S3_BUCKET</span><span class="o">=</span>pagebuilder-assets
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8003:8000&quot;</span>
</span><span class='line'>
</span><span class='line'>      frontend:
</span><span class='line'>    image: pagebuilder/angular-frontend
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;4200:80&quot;</span>
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">API_GATEWAY_URL</span><span class="o">=</span>http://api-gateway:8080
</span><span class='line'>
</span><span class='line'>      api-gateway:
</span><span class='line'>    image: pagebuilder/api-gateway:python
</span><span class='line'>    environment:
</span><span class='line'>      - <span class="nv">USER_SERVICE_URL</span><span class="o">=</span>http://user-service:8000
</span><span class='line'>      - <span class="nv">PROJECT_SERVICE_URL</span><span class="o">=</span>http://project-service:8000
</span><span class='line'>      - <span class="nv">RENDERING_SERVICE_URL</span><span class="o">=</span>http://rendering-service:8000
</span><span class='line'>    ports:
</span><span class='line'>      - <span class="s2">&quot;8080:8000&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>何时使用每种模式</h2>

<p><img src="https://miro.medium.com/v2/resize:fit:1400/1*Kx0t7cKSgdtO0Q1PpRiLXg.jpeg" alt="这是我在一次架构评审会上画的草图，当时团队就各种模式争论了两个小时。这张图在5分钟内就结束了这场争论——每个人都清楚地看到了他们的项目与一个模式的对应关系。现在，我把这张照片保存在手机里，每次架构讨论时都会拿出来用。" /></p>

<p><strong>在以下情况下使用 MVC</strong>：</p>

<ul>
<li>构建传统 Web 应用程序</li>
<li>团队熟悉该模式</li>
<li>需要清晰的关注点分离</li>
</ul>


<p><strong>在以下情况下使用事件驱动</strong>：</p>

<ul>
<li>实时功能很重要</li>
<li>需要多个系统响应变化</li>
<li>需要松散耦合</li>
</ul>


<p><strong>在以下情况下使用微服务</strong>：</p>

<ul>
<li>团队规模 > 10 名开发人员</li>
<li>不同部分的扩展能力不同</li>
<li>独立部署至关重要</li>
</ul>


<p>正如 Martin Fowler 所言：“傻瓜也能写出计算机能理解的代码。优秀的程序员写出人类能理解的代码。”</p>

<h2>📝 互动练习：架构模式比较</h2>

<p><strong>创建你的个人架构模式速查表：</strong></p>

<ol>
<li>在你的纸上<strong>画出三个部分</strong>：“MVC”、“事件驱动”、“微服务”</li>
<li><p><strong>对于 MVC：</strong>画出三个相连的方框（模型 ↔ 控制器 ↔ 视图）</p></li>
<li><p>在下面写上：“适合：传统应用，清晰的分离”</p></li>
</ol>


<p><strong>3.对于事件驱动：</strong> 画一个中心圆圈，标记为“事件总线”，并用箭头向外辐射到多个方框。</p>

<ol>
<li>在下面写：“适用于：实时功能，松耦合”</li>
</ol>


<p><strong>5. 对于微服务：</strong> 画 6-8 个独立的小方框，并用虚线连接它们。</p>

<ul>
<li>在下面写：“适用于：大型团队，独立扩展”</li>
</ul>


<p><strong>6. 添加决策树：</strong> 从问题到模式画箭头：</p>

<ul>
<li>“团队少于 5 人？” → MVC</li>
<li>“需要实时功能吗？” → 事件驱动</li>
<li>“多个团队？” → 微服务</li>
</ul>


<p><strong> 将此图放在手边！</strong> 这是你未来任何项目的架构决策流程图。</p>

<h2>绘制真正有用的系统图</h2>

<h2>视觉传达的艺术</h2>

<blockquote><p>“一图胜千言，但一张好的图表胜过千次会议。” — 未知</p></blockquote>

<p>系统图是软件架构的蓝图。它们应该讲述一个故事，而不是制造混乱。</p>

<h2>📝 互动练习：图表层次结构</h2>

<p><strong>练习三层系统图绘制方法：</strong></p>

<p><strong>第一层 - 上下文（30 秒绘制）：</strong></p>

<ol>
<li><strong>绘制三个形状</strong>：圆形（用户）、矩形（你的系统）、云（外部服务）</li>
<li><strong>用带标签的箭头连接</strong>：“HTTP 请求”、“API 调用”、“数据同步”</li>
<li><strong>这回答了</strong>“我们的系统连接到什么？”</li>
</ol>


<p><strong>第二层 - 容器（2 分钟绘制）：</strong></p>

<ol>
<li><strong>将系统矩形分成四个部分</strong>：前端、API 网关、服务、数据库</li>
<li><strong>用箭头</strong>显示它们之间的数据流**</li>
<li><strong>这回答了</strong>“主要部分是什么？”</li>
</ol>


<p><strong>第三级——组件（5 分钟绘制）：</strong></p>

<ol>
<li><strong>选择一个容器（例如前端）并将其分解</strong>为模块</li>
<li><strong>展示模块如何在该容器内交互</strong></li>
<li><strong>这将回答</strong>“这个组件内部是如何工作的？”</li>
</ol>


<p><strong>本练习的强大之处：</strong>只需选择要绘制的图纸，即可在任何细节层面解释任何系统！</p>

<h2>图表的层次结构</h2>

<p><strong>上下文图</strong>：30,000 英尺的视角</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Users]</span> --&gt; <span class="cm">[Page Builder System]</span> --&gt; <span class="cm">[CDN]</span>
</span><span class='line'>           |
</span><span class='line'>           v
</span><span class='line'>      <span class="cm">[Database]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>容器图</strong>：构建模块</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='inform7'><span class='line'><span class="cm">[Web Browser]</span> --&gt; <span class="cm">[Load Balancer]</span> --&gt; <span class="cm">[Web Application]</span>
</span><span class='line'>                                         |
</span><span class='line'>                                         v
</span><span class='line'><span class="cm">[File Storage]</span> &lt;-- <span class="cm">[API Gateway]</span> &lt;-- <span class="cm">[Cache Layer]</span>
</span><span class='line'>                        |
</span><span class='line'>                        v
</span><span class='line'>                   <span class="cm">[Database Cluster]</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>组件图</strong>：内部结构</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='mathematica'><span class='line'><span class="n">Web</span><span class="w"> </span><span class="n">Application</span><span class="err">:</span><span class="w"></span>
</span><span class='line'><span class="err">├──</span><span class="w"> </span><span class="n">Authentication</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">├──</span><span class="w"> </span><span class="n">Project</span><span class="w"> </span><span class="n">Management</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">├──</span><span class="w"> </span><span class="n">Page</span><span class="w"> </span><span class="n">Editor</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">Canvas</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">Toolbar</span><span class="w"> </span><span class="n">Component</span><span class="w"></span>
</span><span class='line'><span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">Properties</span><span class="w"> </span><span class="n">Panel</span><span class="w"></span>
</span><span class='line'><span class="err">├──</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="n">Library</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span><span class='line'><span class="err">└──</span><span class="w"> </span><span class="n">Export</span><span class="w"> </span><span class="n">Module</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure>


<h2>有效的图表绘制原则</h2>

<ol>
<li><strong>从用户旅程开始</strong>：每个图表都应该回答“数据如何从用户操作流向结果？”</li>
<li><strong>使用一致的符号</strong>：矩形表示进程，圆柱体表示数据存储，圆形表示外部实体</li>
<li><strong>清晰地显示关系</strong>：箭头应指示数据流方向并进行标记</li>
<li><strong>分层图表</strong>：从高层开始，然后放大到特定区域</li>
<li><strong>包含不愉快的路径</strong>：显示错误处理和故障场景</li>
</ol>


<h2>整合：可视化页面构建器案例研究</h2>

<p>让我们为我们的可视化页面构建器设计一个完整的系统架构：</p>

<h2>高层架构</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='coq'><span class='line'><span class="nc">Frontend</span> <span class="o">(</span><span class="nc">Angular</span><span class="o">)</span>
</span><span class='line'><span class="err">├──</span> <span class="nc">Editor</span> <span class="nc">Canvas</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">├──</span> <span class="nc">Component</span> <span class="nc">Library</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">├──</span> <span class="nc">Project</span> <span class="nc">Dashboard</span> <span class="kn">Module</span>
</span><span class='line'><span class="err">└──</span> <span class="nc">Shared</span> <span class="nc">Services</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scss'><span class='line'><span class="nt">API</span> <span class="nt">Gateway</span> <span class="o">(</span><span class="nt">Python</span><span class="o">/</span><span class="nt">FastAPI</span><span class="o">)</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">Authentication</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">Project</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">Component</span> <span class="nt">Service</span>
</span><span class='line'><span class="err">└──</span> <span class="nt">Rendering</span> <span class="nt">ServiceData</span> <span class="nt">Layer</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">PostgreSQL</span> <span class="o">(</span><span class="nt">structured</span> <span class="nt">data</span><span class="o">)</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">Redis</span> <span class="o">(</span><span class="nt">caching</span><span class="o">)</span>
</span><span class='line'><span class="err">└──</span> <span class="nt">S3</span> <span class="o">(</span><span class="nt">file</span> <span class="nt">storage</span><span class="o">)</span><span class="nt">Infrastructure</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">CDN</span> <span class="o">(</span><span class="nt">CloudFront</span><span class="o">)</span>
</span><span class='line'><span class="err">├──</span> <span class="nt">Load</span> <span class="nt">Balancer</span>
</span><span class='line'><span class="err">└──</span> <span class="nt">Auto-scaling</span> <span class="nt">Groups</span>
</span></code></pre></td></tr></table></div></figure>


<h2>组件添加的数据流</h2>

<ol>
<li><strong>用户操作</strong>：将组件从库拖到画布</li>
<li><strong>前端</strong>：验证位置，发送 API 请求</li>
<li><strong>API 网关</strong>：验证请求，路由到组件服务</li>
<li><strong>组件服务</strong>：验证业务规则，更新数据库</li>
<li><strong>事件总线</strong>：发出“component_added”事件</li>
<li><strong>渲染服务</strong>：生成更新后的页面预览</li>
<li><strong>WebSocket</strong>：通知其他协作者</li>
<li><strong>前端</strong>：使用新组件更新 UI</li>
</ol>


<h2>📝 互动练习：数据流映射</h2>

<p><strong>将这个抽象的流程转化为一个可视化的故事：</strong></p>

<ol>
<li><strong>在一个流程中画出 8 个方框</strong>（每个方框对应上面的每个步骤）</li>
<li><strong>用箭头连接它们</strong>以显示顺序</li>
<li><strong>在每个方框上方写出所需时间</strong>：“50 毫秒”、“200 毫秒”、“100 毫秒”等。</li>
<li><strong>在每个方框下方，注明可能出现的问题</strong>：“网络超时”、“身份验证失败”、“数据库宕机”</li>
<li><p><strong>现在画出第二个版本</strong>，展示步骤 4 失败时会发生什么：</p></li>
<li><p>用红色虚线画一条“悲伤的路径”箭头</p></li>
<li>显示返回给用户的错误消息</li>
<li>添加重试逻辑和回退选项</li>
</ol>


<p><strong>本练习将教会你：</strong>每个用户操作实际上都是一个复杂的系统编排。绘制箭头可以帮助你在生产环境中发生潜在故障之前发现它们！</p>

<p><strong>额外提示：</strong> 为箭头添加颜色代码——绿色代表正常路径，红色代表错误，蓝色代表重试。</p>

<h2>可扩展性考虑因素</h2>

<p><strong>流量模式</strong>：</p>

<ul>
<li>高读取操作（浏览页面）</li>
<li>突发写入操作（编辑会话）</li>
<li>大文件上传（图片、资源）</li>
</ul>


<p><strong>扩展策略</strong>：</p>

<ul>
<li>将渲染后的页面缓存在 CDN 中</li>
<li>使用只读副本进行页面浏览</li>
<li>将大文件处理排队</li>
<li>实现 WebSocket 连接池</li>
</ul>


<h2>要点：适用于任何 Web 应用程序的原则</h2>

<h2>系统设计的黄金法则</h2>

<ol>
<li><strong>从简单开始，规划复杂</strong>：从单体应用开始，但要针对微服务进行设计</li>
<li><strong>快速失败，快速学习</strong>：从第一天开始构建监控和报警功能</li>
<li><strong>数据为王</strong>：先设计数据模型，其他一切都水到渠成</li>
<li><strong>安全性不可或缺</strong>：在每一层都构建身份验证和授权机制</li>
<li><strong>性能是关键特性</strong>：用户更容易注意到应用程序运行缓慢，而不是功能缺失</li>
</ol>


<h2>架构清单</h2>

<p>在编写第一行代码之前编写代码时，请问自己：</p>

<ul>
<li>[ ] 核心实体及其关系是什么？</li>
<li>[ ] 该系统如何处理 10 倍于当前流量的情况？</li>
<li>[ ] 单点故障点在哪里？</li>
<li>[ ] 不同的团队将如何在该系统上协作？</li>
<li>[ ] 出现问题时会发生什么？</li>
<li>[ ] 我们将如何监控和调试问题？</li>
<li>[ ] 安全隐患是什么？</li>
</ul>


<h2>📝 互动练习：你的系统设计模板</h2>

<p><strong>创建你的个人系统设计模板，可用于任何项目：</strong></p>

<ol>
<li><strong>绘制一个包含以下部分的空白模板：</strong></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>┌────── 实体与关系 ────────┐ ┌───── 流量与扩展 ─────┐  │ │ │ │ │ │ │
</span><span class='line'>└────────────────────────┘ └────────────────────┘ ┌─ 故障点 ──────
</span><span class='line'>─────┐ ┌──── 团队边界 ────┐ │ │ │ │ │ │
</span><span class='line'>└─────────────────────┘ └──────────────────────┘
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p><strong>填写我们的页面构建器示例：</strong></p></li>
<li><p>实体：用户、项目、页面、组件</p></li>
<li>流量：浏览时读取量大，编辑时写入量大</li>
<li>故障：数据库宕机、CDN 速度慢、WebSocket 断开连接</li>
<li>团队：前端团队、API 团队、基础设施团队</li>
</ol>


<p><strong>2. 复制此模板</strong> — 将其用于未来的每个项目</p>

<p><strong>为什么有效：</strong> 拥有一致的思维框架可以防止你忘记关键方面。你的绘图将成为你的系统设计清单！</p>

<h2>你的绘图之旅：从草图到系统</h2>

<p>如果你完成了本文的绘图练习，那么你现在拥有：</p>

<ol>
<li><strong>分层架构模板</strong>（用于分解任何复杂系统）</li>
<li><strong>分解树方法</strong>（用于组织开发工作）</li>
<li><strong>扩展演进路线图</strong>（用于规划发展阶段）</li>
<li><strong>餐厅隐喻图</strong>（用于解释三层架构）</li>
<li><strong>架构模式对比图</strong>（用于选择正确的方法）</li>
<li><strong>三层图表系统</strong>（用于在任何细节层面进行沟通）</li>
<li><strong>数据流映射技术</strong>（用于理解系统交互）</li>
<li><strong>可复用系统设计模板</strong>（用于一致的项目规划）</li>
</ol>


<p><strong>这些手绘图表比任何昂贵的工具都更有价值</strong>，因为：</p>

<ul>
<li>通过绘制它们，你的大脑建立了更深层次的联系</li>
<li>你可以随时随地重新创建它们</li>
<li>它们根据你对系统的理解进行个性化定制</li>
<li>它们弥合了抽象概念与实践之间的差距实施</li>
</ul>


<p><strong>保留你的图纸！</strong> 把它们贴在你的显示器上，用手机拍照，或者创建一个“系统设计速写本”，让它随着每个项目的进展而不断更新。</p>

<h2>总结</h2>

<blockquote><p>“架构师身处两个世界之间。你必须愿意打破基本的假设。”——安藤忠雄</p></blockquote>

<p>系统设计并非要创造完美的架构，而是要做出明智的权衡。每个决策都有其后果，每个模式都有其利弊，每个解决方案都会产生新的问题需要解决。</p>

<p>最好的架构师并非精通所有模式和技术，而是能够倾听需求、理解约束，并设计出能够与用户和组织和谐共存的系统。</p>

<p>记住：你不仅仅是在构建软件，你还在为团队未来的成功奠定基础。构建好它，清晰地记录它，并始终做好演进的准备。</p>

<p>俗话说，“几周的编码时间可以节省数小时的规划时间。” 投资于系统设计，未来的你（和团队）会感谢你。</p>

<p>千个应用程序的旅程始于一个精心设计的系统。今天就开始像架构师一样思考，见证你的应用程序从脆弱的原型转变为经得起时间考验的强大、可扩展的平台。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[runBlocking实践：哪里该使用，哪里不该用]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"/>
    <updated>2025-09-23T14:34:01+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「runBlocking in practice: Where it should be used and where not」，原文链接<a href="https://kt.academy/article/run_blocking">https://kt.academy/article/run_blocking</a>，由Marcin Moskała发布于2025年9月1日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/23/runblocking-in-practice/"><img src="https://kt.academy/_next/image?url=https%3A%2F%2Fmarcinmoskala.com%2Fkt-academy-articles%2Fpromotion%2Frun_blocking.png&w=3840&q=75" title="auto auto" ></a></p>

<!-- more -->


<p>传统意义上讲，Java 和 Kotlin 项目都基于阻塞调用(blocking)。我所说的阻塞调用是指函数在等待某些操作（例如，等待网络响应）时会阻塞调用者的线程。Kotlin 协程最重要的规则之一是，我们不应该在挂起函数(suspending function)上进行阻塞调用（除非我们使用允许阻塞调用的调度程序，例如 <code>Dispatchers.IO</code>）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using withContext(Dispatchers.IO) to make a blocking call in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUser</span><span class="p">():</span> <span class="n">User</span> <span class="p">=</span> <span class="n">withContext</span><span class="p">(</span><span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">response</span> <span class="p">=</span> <span class="n">api</span><span class="p">.</span><span class="n">getUser</span><span class="p">()</span> <span class="c1">// blocking call</span>
</span><span class='line'>    <span class="n">response</span><span class="p">.</span><span class="n">toDomainUser</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是如何反其道而行之呢？如何将挂起调用转换为阻塞调用？为此，我们使用 <code>runBlocking</code>！</p>

<h2><a href="#how-runblocking-works"><code>runBlocking</code> 的工作原理</a></h2>

<p><code>runBlocking</code> 在调用它的线程上启动一个协程，并阻塞该线程直到协程完成。因此，runBlocking 本质上是同步的，因为如果我们多次调用它，第二个调用要等到第一个调用完成后才会启动。作为一个同步协程构建器，<code>runBlocking</code> 返回它启动的协程的结果。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting main&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Finishing first runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">result</span><span class="p">:</span> <span class="n">String</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">log</span><span class="p">(</span><span class="s">&quot;Starting second runBlocking&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>
</span><span class='line'>        <span class="s">&quot;ABCD&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">log</span><span class="p">(</span><span class="s">&quot;Second runBlocking finished with result: $result&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;[${Thread.currentThread().name}] $message&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// [main] Starting main</span>
</span><span class='line'><span class="c1">// [main] Starting first runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Finishing first runBlocking</span>
</span><span class='line'><span class="c1">// [main] Starting second runBlocking</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// [main] Second runBlocking finished with result: ABCD</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于 <code>runBlocking</code> 启动了一个作用域，它会等待其中启动的所有协程完成。这意味着它会等待所有子协程完成。这就是为什么下面的程序要等到所有三个异步协程都完成才会完成。为了展示如何使用 <code>runBlocking</code> 定义结果，我还让这个程序从 <code>main</code> 函数返回 <code>0</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">import</span> <span class="nn">kotlinx.coroutines.*</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Int</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span> <span class="n">delayAndPrintHello</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="m">0</span> <span class="c1">// result from main</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">delayAndPrintHello</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">delay</span><span class="p">(</span><span class="m">1000L</span><span class="p">)</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;World!&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// Hello</span>
</span><span class='line'><span class="c1">// (1 sec)</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span><span class='line'><span class="c1">// World!</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> 的行为可能会让你想起 <code>coroutineScope</code>，这并非巧合，因为它们都启动同步协程，但 <code>runBlocking</code> 是阻塞的，而 <code>coroutineScope</code> 是暂停的。这意味着完全不同的用法，我们只在暂停函数中使用 <code>coroutineScope</code>，而我们永远不应该在暂停函数中使用 <code>runBlocking</code>。这也意味着 <code>coroutineScope</code> 与其调用者建立关系，并且始终处于协程层次结构的中间，而 <code>runBlocking</code> 则启动一个新的协程层次结构。</p>

<h2><a href="#the-practice-of-using-runblocking">使用 <code>runBlocking</code> 的实践</a></h2>

<p>在正确实现的基于协程的项目中，并使用设计良好的协程友好库，我们几乎不需要使用 <code>runBlocking</code>。如果我们在项目中经常使用它，那就被认为是代码异味。然而，在某些情况下，runBlocking 是有用的，甚至是必要的。也有一些情况下，runBlocking 不应该被使用。我们还会讨论那些曾经需要 runBlocking 但现在有了更好的替代方案的情况。现在，让我们来看看。</p>

<h2><a href="#where-to-use-runblocking">在哪里使用 <code>runBlocking</code></a></h2>

<p><code>runBlocking</code> 应该用于需要启动协程并阻塞当前线程直到其完成的情况。这意味着它可以在以下情况下使用：</p>

<ul>
<li>我们需要等待协程的结果。</li>
<li>我们可以阻塞当前线程。</li>
</ul>


<p>一个常见的 Android 示例是在 Retrofit 客户端中设置一个拦截器，将令牌附加到网络调用。获取令牌可能需要发起网络调用，因此我们需要启动一个协程来获取令牌。同时，拦截器需要结果才能继续执行。这个拦截器在 Retrofit 的池中启动，因此可以调用它的调用。这使得它成为使用 <code>runBlocking</code> 的理想场所。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">AddTokenInterceptor</span><span class="p">:</span> <span class="n">Interceptor</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">intercept</span><span class="p">(</span><span class="n">chain</span><span class="p">:</span> <span class="n">Interceptor</span><span class="p">.</span><span class="n">Chain</span><span class="p">):</span> <span class="n">Response</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">token</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getToken</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">chain</span><span class="p">.</span><span class="n">request</span><span class="p">().</span><span class="n">newBuilder</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">addHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">,</span> <span class="s">&quot;Bearer $token&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">build</span><span class="p">()</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">chain</span><span class="p">.</span><span class="n">proceed</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在后端系统上，有时我们需要阻塞当前线程以等待协程完成，例如为了让我们的工具正确测量此进程的执行时间，或者当我们需要调用某些阻塞脚本并获取其结果时。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@MeasureExecutionTime</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">runDataMigrationScript</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">sourceData</span> <span class="p">=</span> <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">transformedData</span> <span class="p">=</span> <span class="n">transformData</span><span class="p">(</span><span class="n">sourceData</span><span class="p">)</span>
</span><span class='line'>    <span class="n">writeDataToTarget</span><span class="p">(</span><span class="n">transformedData</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些情况很少见，大多数后端项目不需要使用 <code>runBlocking</code>。除非它们有一些基于阻塞调用的遗留代码。考虑以下 <code>UserService</code>，它在我们的应用程序中用于管理用户。我们已经将其迁移到暂停调用，但我们仍然有一些基于阻塞调用的遗留控制器和服务。为了避免重写所有这些，我们可以为暂停函数提供阻塞替代方案。这些替代方案可以通过使用 <code>runBlocking</code> 包装暂停函数来实现（你也可以考虑使用一些调度器）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserService</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">userRepository</span><span class="p">:</span> <span class="n">UserRepository</span><span class="p">,</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">userRepository</span><span class="p">.</span><span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Blocking alternative for legacy parts of our application</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">findUserByIdBlocking</span><span class="p">(</span><span class="n">id</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">User</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">findUserById</span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这可能是 <code>runBlocking</code> 最重要的用途，它充当了从阻塞到暂停的桥梁。一些库为 Java 定义了阻塞替代方案。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">readDataFromSource</span><span class="p">():</span> <span class="n">Data</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="nf">readDataFromSourceBlocking</span><span class="p">():</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">readDataFromSource</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#where-not-to-use-runblocking">哪些情况下不应使用 <code>runBlocking</code></a></h2>

<p>在某些情况下，不应使用 <code>runBlocking</code>。此外，切勿在挂起函数中直接使用 <code>runBlocking</code>。<code>runBlocking</code> 会阻塞当前线程，因此不应在挂起函数中进行阻塞调用（除非使用允许阻塞调用的调度程序，例如 <code>Dispatchers.IO</code>）。在这种情况下，很可能不需要 <code>runBlocking</code>。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking in a suspending function</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// runBlocking is most likely not needed</span>
</span><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getToken</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>不应在不需要等待结果的函数中使用 <code>runBlocking</code>。如果你只需要启动协程，通常最好使用 <code>launch</code> 启动异步协程。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking used where we do not need to await result</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">startBackgroundProcess</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">doSomething</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们还应注意，不要在不应被阻塞的线程上使用 <code>runBlocking</code>。这在 Android 上尤其成问题，因为阻塞主线程会导致应用程序卡死。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Incorrect: runBlocking on the main thread</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Correct: Using launch to start an asynchronous coroutine</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">onClick</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">lifecycleScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">userNameView</span><span class="p">.</span><span class="n">test</span> <span class="p">=</span> <span class="n">getUserName</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在后端，如果我们在 <code>synchronized</code> 块中使用它，可能会出现问题。一个技巧是使用 <code>launch</code> 实现回调函数。但是，通常情况下，最好重新设计代码，使用暂停而不是阻塞调用，并使用协程友好的工具（我们将在<em>同步协程</em>课程中讨论）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="c1">// Possibly incorrect: runBlocking inside synchronized block</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span> <span class="n">getUser</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// One solution: use launch to implement a callback</span>
</span><span class='line'><span class="k">fun</span> <span class="nf">getUser</span><span class="p">(</span><span class="n">callback</span><span class="p">:</span> <span class="p">(</span><span class="n">User</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">backgroundScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>        <span class="n">callback</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">synchronized</span><span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// ...</span>
</span><span class='line'>    <span class="n">getUser</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#outdated-runblocking-uses">过时的 <code>runBlocking</code> 用法</a></h2>

<p><code>runBlocking</code> 传统上用于包装 <code>main</code> 函数体。它的属性非常适合此目的：它启动一个协程，因此它可以调用挂起函数或启动其他协程，并且它会阻塞线程直到协程完成，因此我们可以确保程序不会在所有这些进程完成之前结束。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> 仍然可以以这种方式使用，但是在大多数现代情况下，我们更喜欢使用 Kotlin 1.3 中引入的挂起 <code>main</code> 函数。此类函数在底层被一个类似于 <code>runBlocking</code> 的阻塞构建器包装。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">getUser</span><span class="p">()</span> <span class="c1">// suspending call</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="s">&quot;User: $user&quot;</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>关键区别在于 <code>runBlocking</code> 设置了一个调度器，使其所有子协程在其正在使用的同一线程上运行。挂起 main 函数不会设置调度器，因此其子协程默认在不同的线程上运行。引入此更改是因为 <code>runBlocking</code> 使用的单线程调度器经常导致意外行为。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">runBlocking</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// main</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">main</span><span class="p">():</span> <span class="n">Unit</span> <span class="p">=</span> <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">println</span><span class="p">(</span><span class="n">Thread</span><span class="p">.</span><span class="n">currentThread</span><span class="p">().</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">// main</span>
</span><span class='line'><span class="c1">// DefaultDispatcher-worker-1</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runBlocking</code> 的第二个传统用途是在测试中。它被用来包装测试主体，以便我们可以调用挂起函数并在其中启动协程。现在，我们更倾向于使用 <code>kotlinx-coroutines-test</code> 库中的 <code>runTest</code>，它是 <code>runBlocking</code> 的一个更强大、更灵活的替代方案。它允许我们控制时间、生成后台作用域并跟踪子协程上的异常。<code>runTest</code> 将在<em>测试协程</em>课程中讨论。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">UserRepositoryTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userRepository</span> <span class="p">=</span> <span class="n">InMemoryUserRepository</span><span class="p">()</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userService</span> <span class="p">=</span> <span class="n">UserService</span><span class="p">(</span><span class="n">userRepository</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Test</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">testGetUser</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span> <span class="c1">// previously runBlocking</span>
</span><span class='line'>        <span class="c1">// given</span>
</span><span class='line'>        <span class="n">userRepository</span><span class="p">.</span><span class="n">hasUser</span><span class="p">(</span><span class="n">UserEntity</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">,</span> <span class="s">&quot;John Doe&quot;</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// when</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">userService</span><span class="p">.</span><span class="n">getUser</span><span class="p">(</span><span class="s">&quot;1234&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// then</span>
</span><span class='line'>        <span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;John Doe&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a href="#%E6%80%BB%E7%BB%93">总结</a></h2>

<ul>
<li><code>runBlocking</code> 是一个阻塞协程构建器，它启动一个协程并阻塞当前线程直到它完成。</li>
<li><code>runBlocking</code> 是从阻塞世界(blocking)到挂起世界(suspending)的桥梁，它用于在需要阻塞当前线程直到协程完成的地方启动协程。</li>
<li>如果你需要在项目中频繁使用 <code>runBlocking</code>，那么它就是一种代码异味。在设计合理的基于协程的项目中，应该尽量少用，或者干脆不用。</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android ViewModel数据加载：基于Flow架构的最佳实践]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"/>
    <updated>2025-09-22T14:50:00+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Android ViewModel Data Loading: Best Practices and Flow-Based Architecture」，原文链接<a href="https://funkymuse.dev/posts/properly-load-data/">https://funkymuse.dev/posts/properly-load-data/</a>，由FunkyMuse于2025年8月29日。</p></blockquote>

<p>Android 开发中的架构讨论经常引发激烈的争论——有时褒贬不一。撰写这些主题的文章并不容易，但这正是它的价值所在。</p>

<p>本文阐述了我对数据加载模式的独到见解，这些见解源于我的经验以及近期手术后的恢复（其中一次手术仍在进行中）。</p>

<p>不妨将此视为我在 2025 年对数据加载模式的理解和技能的概述。</p>

<p>我可能比其他人更晚加入这场讨论，但迟做总比不做好。</p>

<h2>挑战：Android ViewModel 中常见的数据加载反模式</h2>

<p>“大多数”Android 开发者使用 ViewModel 来管理 UI 状态，这些状态由视图（Fragment、Activity 或可组合组件）收集。为了显示有意义的内容，你需要从真实数据源加载数据，将其转换为视图状态，然后公开以供使用。</p>

<p>以前是 LiveData，现在是 Flow，它充当视图和 ViewModel 之间的粘合剂（大多数情况下）。有一些解决方案使用 <a href="https://github.com/cashapp/molecule">molecule</a>，但这超出了我们的讨论范围。</p>

<p><a href="https://alexhilton.github.io/blog/2025/09/22/viewmodel-loading/"><img src="https://funkymuse.dev/assets/img/load_data/zhui.png" title="auto auto" ></a></p>

<!-- more -->


<p>正如这篇 <a href="https://x.com/github_skydoves/status/1829315087611707848">Twitter 讨论</a> 所示，大多数开发者在 <code>ViewModel</code> 的 init {} 块中加载数据。虽然这种方法看似合乎逻辑，但它带来了一些架构问题，Ian Lake 和其他人认为这是反模式——包括使用 <code>LaunchedEffect</code> 进行数据加载。</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/jokes.png"><img src="https://funkymuse.dev/assets/img/load_data/jokes.png" alt="Irony" /></a></p>

<p>讽刺的是，即使是官方示例有时也会与这些最佳做法相矛盾：</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/irony.png"><img src="https://funkymuse.dev/assets/img/load_data/irony.png" alt="Irony" /></a></p>

<h3>开发者为何选择 init {} 块（以及它为何存在问题）</h3>

<p>ViewModel 的 init {} 块的吸引力显而易见——它确保数据加载在配置更改后依然有效，从而避免了不必要的 API 调用或数据库读取。然而，这种方法也带来了四个关键问题：</p>

<h4>问题 1：导航返回栈复杂化</h4>

<p>使用 init {} 进行数据加载时，返回到包含现有 ViewModel 的屏幕不会触发重新初始化。这迫使开发者在 onStart 或 onResume 中添加变通逻辑来检查数据新鲜度，从而创建难以维护的意大利面条式代码。</p>

<h4>问题 2：调度程序竞争条件</h4>

<p>在 init {} 中加载数据通常使用 viewModelScope，它在 Dispatchers.Main.immediate 上运行。这种即时调度程序可能会导致竞争条件，即数据处理在 UI 组合之前就已完成，尤其是在 Jetpack Compose 应用中。</p>

<p><a href="https://funkymuse.dev/assets/img/load_data/darkness.png"><img src="https://funkymuse.dev/assets/img/load_data/darkness.png" alt="Darkness" /></a></p>

<h4>问题 #3：数据过期问题</h4>

<p>现代 CRUD 应用程序需要更新数据。用户可能会从其他屏幕返回，或者在相当长一段时间后从暂停状态恢复。<code>init {}</code> 方法没有提供内置的数据新鲜度验证机制。</p>

<h4>问题 #4：测试困难</h4>

<p>每次运行测试时，你都必须构建 ViewModel 才能成功运行该特定测试用例的 <code>init {}</code> 代码块。</p>

<h2>基于 Flow 的解决方案：将冷流转换为热流</h2>

<p>该解决方案利用 Kotlin Flows——具体来说，使用 StateFlow 和适当的共享策略将冷流转换为热流。可以将其视为 Katy Perry 的“Hot N Cold”方法，但所有边缘情况的行为都是可预测的。</p>

<h3>构建基础：用例和 ViewModel 结构</h3>

<p><strong>请注意，此代码仅用于演示目的，如何构建由你决定，除加载部分外，并非最佳实践</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">&gt;</span> <span class="n">provideFactory</span><span class="p">(</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">creator</span><span class="p">:</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">T</span>
</span><span class='line'><span class="p">)</span> <span class="p">=</span> <span class="n">viewModelFactory</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">initializer</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">creator</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>注意：此工厂模式仅用于演示目的</em></p>

<p>我们的用例处理数据检索、格式化和业务逻辑转换：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">class</span> <span class="nc">GetUserDetailsUseCase</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">authRepository</span><span class="p">:</span> <span class="n">AuthRepository</span> <span class="p">=</span> <span class="n">AuthRepository</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dispatcher</span><span class="p">:</span> <span class="n">CoroutineDispatcher</span> <span class="p">=</span> <span class="n">Dispatchers</span><span class="p">.</span><span class="n">IO</span><span class="p">,</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">billingCache</span><span class="p">:</span> <span class="n">BillingCache</span> <span class="p">=</span> <span class="n">BillingCache</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">dateFormatter</span><span class="p">:</span> <span class="n">DateFormatter</span> <span class="p">=</span> <span class="n">DataFormatter</span><span class="p">()</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">withContext</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetailsResponseModel</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">authRepository</span><span class="p">.</span><span class="n">getUserDetails</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">userDetails</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">details</span> <span class="p">-&gt;</span>
</span><span class='line'>                <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">creationDate</span> <span class="p">=</span> <span class="n">dateFormatter</span><span class="p">.</span><span class="n">format</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">details</span><span class="p">.</span><span class="n">creationDate</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">DateFormatter</span><span class="p">.</span><span class="n">Format</span><span class="p">.</span><span class="n">UTC_SHORT</span>
</span><span class='line'>                    <span class="p">).</span><span class="n">getOrNull</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">avatar</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isPremium</span> <span class="p">=</span> <span class="n">billingCache</span><span class="p">.</span><span class="n">isPremium</span><span class="p">(),</span>
</span><span class='line'>                    <span class="n">email</span> <span class="p">=</span> <span class="n">details</span><span class="p">.</span><span class="n">email</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">create</span><span class="p">()</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>此用例封装了从存储库检索数据、日期格式化、高级状态验证以及准备用户信息以供显示。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span>
</span><span class='line'>            <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>                <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                            <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                                <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                            <span class="p">)</span>
</span><span class='line'>                        <span class="p">)</span>
</span><span class='line'>                    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>                    <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方法有几个关键优势：</p>

<ul>
<li><strong>数据新鲜度</strong>：5 秒超时时间与 Android 的 ANR 阈值一致，确保在超时后收集器重新出现时数据能够刷新。</li>
<li><strong>配置变更处理</strong>：在超时窗口内，即使配置发生变化，数据也能持久保存。</li>
<li><strong>资源效率</strong>：避免不必要的网络调用，以实现快速导航模式。</li>
</ul>


<p><em>专业提示：对于需要实时数据新鲜度的应用程序，请将超时时间设置为 0</em></p>

<h3>添加用户交互：实现刷新功能</h3>

<p>实际应用程序需要用户主动发起的数据刷新功能。产品经理喜欢滑动刷新，但我们的基本流程无法适应这种模式。让我们来增强我们的架构：</p>

<p>我们使用在主流程收集器中触发的 <code>MutableSharedFlow</code> 来实现这一点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Unit</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">Unit</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>完美！我们成功重构了重复的数据加载逻辑，并实现了刷新功能。然而，这还不算完。</p>

<h3>优化状态管理：消除冗余状态输出</h3>

<p>为了避免不必要的 UI 更新，我们将添加 <code>distinctUntilChanged()</code> 来过滤重复的状态输出。</p>

<h3>处理复杂的状态更新</h3>

<p>对于意图修改 UI 状态而不需要重新加载数据的场景，我们需要在流程操作中访问当前状态。例如，切换电子邮件可见性——这需要修改状态而不是重新加载数据。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateParameters</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateParameters</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">//do some changes here</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">StateParameters</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>    <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>    <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>        <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>        <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的挑战在于如何在流程中访问当前状态。让我们通过内部跟踪状态来解决这个问题：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>智能数据缓存：条件加载策略</h3>

<p>现在我们可以实现复杂的缓存行为了。由于 <code>currentState</code> 在 ViewModel 生命周期内持续存在，我们可以立即发出缓存数据，并仅在必要时有条件地加载新数据：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">currentState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//i added error check just because this is for demonstration of this edge case</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshListener</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">currentState</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="m">5</span><span class="n">_000</span><span class="p">),</span>
</span><span class='line'>            <span class="n">currentState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>此模式提供智能缓存——即使在 5 秒超时后，你也可以根据具体需求选择是否重新获取数据：</p>

<ul>
<li><strong>昂贵的 API 调用</strong>：在 ViewModel 中缓存数据以减少网络开销</li>
<li><strong>静态后端数据</strong>：避免对很少更改的信息进行不必要的请求</li>
<li><strong>实时需求</strong>：强制刷新需要更新数据的应用程序</li>
</ul>


<h3>创建可复用的抽象</h3>

<p>重复编写此模式会变得非常繁琐。让我们从 ViewModel 扩展函数开始，创建可复用的抽象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshMechanism</span><span class="p">:</span> <span class="n">SharedFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'>    <span class="n">refreshData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshMechanism</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh mechanism but no way to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">requireNotNull</span><span class="p">(</span><span class="n">refreshMechanism</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="s">&quot;You&#39;ve provided a refresh data but no mechanism to refresh the data&quot;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">refreshMechanism</span><span class="o">?.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">refreshData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">refreshData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">,</span> <span class="n">refreshParams</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>    <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5</span><span class="n">_000</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了我们抽象的扩展函数，ViewModel 变得更加简洁：</p>

<p><em>注意：此抽象涵盖了 90% 的常见用例，但不支持复杂的流程链式操作</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">(),</span> <span class="n">IntentAware</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">refreshListener</span> <span class="p">=</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">userDetails</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="n">refreshMechanism</span> <span class="p">=</span> <span class="n">refreshListener</span><span class="p">,</span>
</span><span class='line'>        <span class="n">refreshData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">refreshListener</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以通过创建更复杂的基类来消除重复的 <code>refreshListener</code> 声明：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">ViewModelLoader</span><span class="p">&lt;</span><span class="n">State</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Intent</span> <span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Trigger</span> <span class="p">:</span> <span class="n">Any</span><span class="p">&gt;</span> <span class="p">:</span> <span class="n">ViewModel</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">_trigger</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span> <span class="n">MutableSharedFlow</span><span class="p">&lt;</span><span class="n">Trigger</span><span class="p">&gt;()</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">T</span><span class="p">&gt;</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>        <span class="n">loadData</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">,</span>
</span><span class='line'>        <span class="n">triggerData</span><span class="p">:</span> <span class="p">(</span><span class="n">suspend</span> <span class="n">FlowCollector</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;.(</span><span class="n">currentState</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span><span class="p">)?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">5000L</span><span class="p">,</span> <span class="c1">//matching ANR timeout in Android</span>
</span><span class='line'>    <span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">flow</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">emit</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">loadData</span><span class="p">(</span><span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">triggerData</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">_trigger</span><span class="p">.</span><span class="n">collect</span> <span class="p">{</span> <span class="n">triggerParams</span> <span class="p">-&gt;</span>
</span><span class='line'>                    <span class="n">triggerData</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">,</span> <span class="n">triggerParams</span><span class="p">)</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">distinctUntilChanged</span><span class="p">()</span>
</span><span class='line'>            <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>                <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>                <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>                <span class="n">initialValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">abstract</span> <span class="k">val</span> <span class="py">state</span><span class="p">:</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="py">currentState</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">state</span><span class="p">.</span><span class="n">value</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">open</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">Intent</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">fun</span> <span class="nf">sendTrigger</span><span class="p">(</span><span class="n">trigger</span><span class="p">:</span> <span class="n">Trigger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">viewModelScope</span><span class="p">.</span><span class="n">launch</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_trigger</span><span class="p">.</span><span class="n">emit</span><span class="p">(</span><span class="n">trigger</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们的最终实现将变得非常简洁且易于维护：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="k">internal</span> <span class="k">class</span> <span class="nc">UserAccountDetailsViewModel</span> <span class="k">private</span> <span class="n">constructor</span><span class="p">(</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">getUserDetailsUseCase</span><span class="p">:</span> <span class="n">GetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">GetUserDetailsUseCase</span><span class="p">.</span><span class="n">create</span><span class="p">(),</span>
</span><span class='line'><span class="p">)</span> <span class="p">:</span> <span class="n">ViewModelLoader</span><span class="p">&lt;</span><span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">,</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">.</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">&gt;()</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">class</span> <span class="nc">ViewState</span><span class="p">(</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isLoading</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isError</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">userInfo</span><span class="p">:</span> <span class="n">UserInfo</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">isDataLoaded</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">userInfo</span> <span class="p">!=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">data</span> <span class="k">class</span> <span class="nc">UserInfo</span><span class="p">(</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">displayEmail</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">avatarUrl</span><span class="p">:</span> <span class="n">String</span><span class="p">?,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">showPremiumBadge</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span>
</span><span class='line'>            <span class="k">val</span> <span class="py">memberSince</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">Intents</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">ToggleEmailVisibility</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">Intents</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sealed</span> <span class="k">class</span> <span class="nc">StateTriggers</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">class</span> <span class="nc">EmailVisibilityChanged</span><span class="p">(</span><span class="k">val</span> <span class="py">isEmailVisible</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>            <span class="n">data</span> <span class="k">object</span> <span class="nc">Refresh</span> <span class="p">:</span> <span class="n">StateTriggers</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">val</span> <span class="py">state</span> <span class="p">=</span> <span class="n">loadData</span><span class="p">(</span>
</span><span class='line'>        <span class="n">initialState</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">),</span>
</span><span class='line'>        <span class="n">loadData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">isDataLoaded</span><span class="p">.</span><span class="n">not</span><span class="p">()</span> <span class="p">||</span> <span class="n">currentState</span><span class="p">.</span><span class="n">isError</span><span class="p">.</span><span class="n">not</span><span class="p">())</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">triggerData</span> <span class="p">=</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">,</span> <span class="n">refreshParams</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="k">when</span> <span class="p">(</span><span class="n">refreshParams</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="n">refreshParams</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">))</span>
</span><span class='line'>                    <span class="n">emit</span><span class="p">(</span><span class="n">getUserDetailsState</span><span class="p">())</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getUserDetailsState</span><span class="p">():</span> <span class="n">ViewState</span> <span class="p">=</span> <span class="n">getUserDetailsUseCase</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">fold</span><span class="p">(</span>
</span><span class='line'>            <span class="n">onSuccess</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span>
</span><span class='line'>                    <span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">isError</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">userInfo</span> <span class="p">=</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">UserInfo</span><span class="p">(</span>
</span><span class='line'>                        <span class="n">displayEmail</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">email</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">avatarUrl</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">showPremiumBadge</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">isPremium</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">memberSince</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">creationDate</span><span class="o">?.</span><span class="n">toString</span><span class="p">()</span>
</span><span class='line'>                    <span class="p">)</span>
</span><span class='line'>                <span class="p">)</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">onFailure</span> <span class="p">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ViewState</span><span class="p">(</span><span class="n">isLoading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">isError</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onIntent</span><span class="p">(</span><span class="n">intent</span><span class="p">:</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">when</span> <span class="p">(</span><span class="n">intent</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">is</span> <span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span> <span class="p">-&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">sendTrigger</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">StateTriggers</span><span class="p">.</span><span class="n">EmailVisibilityChanged</span><span class="p">(</span><span class="n">intent</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">))</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">companion</span> <span class="k">object</span> <span class="err">{</span>
</span><span class='line'>        <span class="k">fun</span> <span class="nf">factory</span><span class="p">()</span> <span class="p">=</span> <span class="n">provideFactory</span> <span class="p">{</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">()</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>处理 UI 状态复杂性</h3>

<p>此抽象使用布尔标志（<code>isLoading</code>、<code>isError</code>），这些标志可能会创建模糊状态。为了更清晰地管理状态，可以考虑使用密封类：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">sealed</span> <span class="n">interface</span> <span class="n">UIState</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Success</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Error</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Idle</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'>    <span class="n">@Immutable</span>
</span><span class='line'>    <span class="n">data</span> <span class="k">object</span> <span class="nc">Loading</span> <span class="p">:</span> <span class="n">UIState</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>对于需要同时显示错误信息（例如 Snackbars）和现有数据的场景，你可以创建更复杂的状态持有者：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Immutable</span>
</span><span class='line'><span class="n">data</span> <span class="k">class</span> <span class="nc">UIStateHolder</span><span class="p">&lt;</span><span class="k">out</span> <span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">uiState</span><span class="p">:</span> <span class="n">UIState</span> <span class="p">=</span> <span class="n">UIState</span><span class="p">.</span><span class="n">Idle</span><span class="p">,</span>
</span><span class='line'>    <span class="k">val</span> <span class="py">payload</span><span class="p">:</span> <span class="n">T</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这种方法可以实现灵活的 UI 状态管理，同时保持 UI 状态和数据负载之间的明确分离，但可能会增加认知负荷，并引入更多的映射行为和解包逻辑。</p>

<h3>超越 ViewModel</h3>

<p>此模式不仅限于 ViewModel。通过提供自定义协程作用域，你可以在任何组件（可组合组件、存储库或业务逻辑层）中使用此数据加载方法。</p>

<h2>流组合模式</h2>

<p>这种方法的优点还在于可以组合多个数据源。以下是处理单流和双流的示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">flow</span>
</span><span class='line'>        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">newValue</span> <span class="p">-&gt;</span>
</span><span class='line'>            <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">transform</span><span class="p">(</span><span class="n">newValue</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>组合双流的示例：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">inline</span> <span class="k">fun</span> <span class="err">&lt;</span><span class="nf">reified</span> <span class="n">T1</span><span class="p">,</span> <span class="k">reified</span> <span class="n">T2</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">ViewModel</span><span class="p">.</span><span class="n">loadFlow</span><span class="p">(</span>
</span><span class='line'>    <span class="n">initialState</span><span class="p">:</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">flow1</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T1</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">flow2</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">T2</span><span class="p">&gt;,</span>
</span><span class='line'>    <span class="n">crossinline</span> <span class="n">transform</span><span class="p">:</span> <span class="n">suspend</span> <span class="n">CoroutineScope</span><span class="p">.(</span><span class="n">newValue1</span><span class="p">:</span> <span class="n">T1</span><span class="p">,</span> <span class="n">newValue2</span><span class="p">:</span> <span class="n">T2</span><span class="p">,</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">R</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">R</span><span class="p">,</span>
</span><span class='line'>    <span class="n">timeout</span><span class="p">:</span> <span class="n">Long</span> <span class="p">=</span> <span class="m">0</span><span class="p">,</span>
</span><span class='line'><span class="p">):</span> <span class="n">StateFlow</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">var</span> <span class="py">latestValue</span> <span class="p">=</span> <span class="n">initialState</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">combine</span><span class="p">(</span><span class="n">flow1</span><span class="p">,</span> <span class="n">flow2</span><span class="p">)</span> <span class="p">{</span> <span class="n">value1</span><span class="p">,</span> <span class="n">value2</span> <span class="p">-&gt;</span>
</span><span class='line'>        <span class="n">coroutineScope</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">transform</span><span class="p">(</span><span class="n">value1</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">latestValue</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>        <span class="p">.</span><span class="n">onEach</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">latestValue</span> <span class="p">=</span> <span class="n">it</span>
</span><span class='line'>        <span class="p">}.</span><span class="n">stateIn</span><span class="p">(</span>
</span><span class='line'>            <span class="n">scope</span> <span class="p">=</span> <span class="n">viewModelScope</span><span class="p">,</span>
</span><span class='line'>            <span class="n">started</span> <span class="p">=</span> <span class="n">SharingStarted</span><span class="p">.</span><span class="n">WhileSubscribed</span><span class="p">(</span><span class="n">timeout</span><span class="p">),</span>
</span><span class='line'>            <span class="n">initialValue</span> <span class="p">=</span> <span class="n">latestValue</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这些扩展允许你轻松组合多个数据源，同时保持相同的智能缓存和状态管理原则。</p>

<h3>测试基于流的 ViewModel</h3>

<p>在结束之前，让我们探索如何使用 fakes 和 Turbine 进行流测试，正确地测试我们的 <code>UserAccountDetailsViewModel</code> 实现。</p>

<h4>使用 Fakes 和 Turbine 设置测试依赖项</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@OptIn</span><span class="p">(</span><span class="n">ExperimentalCoroutinesApi</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAccountDetailsViewModelTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">testDispatcher</span> <span class="p">=</span> <span class="n">StandardTestDispatcher</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">val</span> <span class="py">fakeGetUserDetailsUseCase</span> <span class="p">=</span> <span class="n">FakeGetUserDetailsUseCase</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="n">lateinit</span> <span class="k">var</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">UserAccountDetailsViewModel</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@Before</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setUp</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">setMain</span><span class="p">(</span><span class="n">testDispatcher</span><span class="p">)</span>
</span><span class='line'>        <span class="n">viewModel</span> <span class="p">=</span> <span class="n">UserAccountDetailsViewModel</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">@After</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">tearDown</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Dispatchers</span><span class="p">.</span><span class="n">resetMain</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Fake implementation for realistic testing, this sounds funny to write haha</span>
</span><span class='line'><span class="k">class</span> <span class="nc">FakeGetUserDetailsUseCase</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">userDetailsToReturn</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">var</span> <span class="py">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setSuccessResponse</span><span class="p">(</span><span class="n">userDetails</span><span class="p">:</span> <span class="n">UserDetails</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="n">userDetails</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">false</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">setErrorResponse</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">shouldReturnError</span> <span class="p">=</span> <span class="k">true</span>
</span><span class='line'>        <span class="k">this</span><span class="p">.</span><span class="n">userDetailsToReturn</span> <span class="p">=</span> <span class="k">null</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Expose execution count when testing caching/performance behavior</span>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">getExecutionCount</span><span class="p">()</span> <span class="p">=</span> <span class="n">executionCount</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">fun</span> <span class="nf">reset</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span> <span class="p">=</span> <span class="m">0</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">execute</span><span class="p">():</span> <span class="n">Result</span><span class="p">&lt;</span><span class="n">UserDetails</span><span class="p">&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">executionCount</span><span class="p">++</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">delay</span><span class="p">(</span><span class="m">50</span><span class="p">)</span> <span class="c1">// Simulate network delay</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">shouldReturnError</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">failure</span><span class="p">(</span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Network error&quot;</span><span class="p">))</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">Result</span><span class="p">.</span><span class="n">success</span><span class="p">(</span><span class="n">userDetailsToReturn</span> <span class="o">?:</span> <span class="n">createDefaultUserDetails</span><span class="p">())</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span> <span class="k">fun</span> <span class="nf">createDefaultUserDetails</span><span class="p">()</span> <span class="p">=</span> <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>        <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;default@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>        <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>        <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>成功和失败场景的参数化测试</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@ParameterizedTest</span>
</span><span class='line'><span class="n">@ValueSource</span><span class="p">(</span><span class="n">booleans</span> <span class="p">=</span> <span class="p">[</span><span class="k">true</span><span class="p">,</span> <span class="k">false</span><span class="p">])</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">handle</span> <span class="n">both</span> <span class="n">success</span> <span class="n">and</span> <span class="n">error</span> <span class="n">scenarios</span><span class="err">`</span><span class="p">(</span><span class="n">shouldSucceed</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;success@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Focus on behavior, not implementation details</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">shouldSucceed</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">successState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;success@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">successState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading state</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">userInfo</span><span class="p">).</span><span class="n">isNull</span><span class="p">()</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">refresh</span> <span class="n">data</span> <span class="k">when</span> <span class="n">refresh</span> <span class="n">intent</span> <span class="k">is</span> <span class="n">triggered</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial successful load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;initial@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2022-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">initialState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">initialState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;initial@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Change response and trigger refresh</span>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;refreshed@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="s">&quot;https://new-avatar.url&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">refreshedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// New Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;refreshed@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">refreshedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">showPremiumBadge</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Verify both initial load and refresh were called</span>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>测试仅 UI 状态变化</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">toggle</span> <span class="n">email</span> <span class="n">visibility</span> <span class="n">without</span> <span class="n">triggering</span> <span class="n">data</span> <span class="n">reload</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Successful initial load</span>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;test@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">loadedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">loadedState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Toggle email visibility</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">ToggleEmailVisibility</span><span class="p">(</span><span class="n">isEmailVisible</span> <span class="p">=</span> <span class="k">true</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then</span>
</span><span class='line'>        <span class="k">val</span> <span class="py">toggledState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">isEmailVisible</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">toggledState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;test@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>测试数据缓存行为</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">use</span> <span class="n">cached</span> <span class="n">data</span> <span class="k">when</span> <span class="n">returning</span> <span class="n">to</span> <span class="n">screen</span> <span class="n">quickly</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>        <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>            <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;cached@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>            <span class="n">isPremium</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
</span><span class='line'>            <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When First collection</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">firstState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">firstState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">cancel</span><span class="p">()</span> <span class="c1">// Simulate leaving screen</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// When Quick return (simulating navigation back within timeout)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should have cached data immediately (no Loadin)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">cachedState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">isLoading</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">cachedState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;cached@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">expectNoEvents</span><span class="p">()</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>测试错误恢复</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='kotlin'><span class='line'><span class="n">@Test</span>
</span><span class='line'><span class="k">fun</span> <span class="err">`</span><span class="nf">should</span> <span class="n">recover</span> <span class="n">from</span> <span class="n">Error</span> <span class="n">on</span> <span class="n">successful</span> <span class="n">refresh</span><span class="err">`</span><span class="p">()</span> <span class="p">=</span> <span class="n">runTest</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Given Initial error</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setErrorResponse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">viewModel</span><span class="p">.</span><span class="n">state</span><span class="p">.</span><span class="n">test</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">errorState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Error</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">errorState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isTrue</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When Fix the response and refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">setSuccessResponse</span><span class="p">(</span>
</span><span class='line'>            <span class="n">UserDetails</span><span class="p">(</span>
</span><span class='line'>                <span class="n">email</span> <span class="p">=</span> <span class="s">&quot;recovered@example.com&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">avatarUrl</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>                <span class="n">isPremium</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span>
</span><span class='line'>                <span class="n">creationDate</span> <span class="p">=</span> <span class="s">&quot;2023-01-01&quot;</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">viewModel</span><span class="p">.</span><span class="n">onIntent</span><span class="p">(</span><span class="n">ViewState</span><span class="p">.</span><span class="n">Intents</span><span class="p">.</span><span class="n">Refresh</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">advanceUntilIdle</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Then Should recover successfully</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Loading during refresh</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">val</span> <span class="py">recoveredState</span> <span class="p">=</span> <span class="n">awaitItem</span><span class="p">()</span> <span class="c1">// Success</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">isError</span><span class="p">).</span><span class="n">isFalse</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">recoveredState</span><span class="p">.</span><span class="n">userInfo</span><span class="o">?.</span><span class="n">displayEmail</span><span class="p">).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="s">&quot;recovered@example.com&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">assertThat</span><span class="p">(</span><span class="n">fakeGetUserDetailsUseCase</span><span class="p">.</span><span class="n">getExecutionCount</span><span class="p">()).</span><span class="n">isEqualTo</span><span class="p">(</span><span class="m">2</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>为什么要测试基于流的 ViewModel 的原则</h3>

<p>哦……这可能会引发一些争论，但这里有一篇很棒的文章，它提供了更好的描述，并且不会影响本文关于我为什么使用 Fakes 的目的。这里有一个简短的总结，可以补充文章顶部</p>

<ol>
<li><strong>使用 Fakes 而非 Mocks</strong>：Fake 提供逼真的行为，并且更易于维护，尤其是在如今 LLM 的帮助下……</li>
<li><strong>参数化测试</strong>：用一个测试用例同时测试成功和失败路径</li>
<li><strong>使用 Turbine 进行流程测试</strong>：简洁、富有表现力的流程测试，并进行适当的状态验证</li>
<li><strong>测试状态转换</strong>：验证完整的状态流程，而不仅仅是最终状态</li>
<li><strong>谨慎执行计数</strong>：仅在测试缓存、性能或重试行为时验证调用计数</li>
<li><strong>关注行为</strong>：测试用户体验，而不是实现细节（我想这一点显而易见）</li>
</ol>


<h3>结论</h3>

<p>本文对 Android ViewModel 中基于流程的数据加载的探索，解决了传统 <code>init {}</code> 块方法的根本挑战。虽然涵盖所有架构变体会很繁琐，但该模式成功处理了大约 90% 的常见用例。</p>

<p>抽象基类方法（<code>ViewModelLoader</code>）提供了最可预测和可维护的解决方案，它提供：</p>

<ul>
<li><strong>可预测的状态管理</strong>：清晰的状态触发器和意图处理</li>
<li><strong>内置测试支持</strong>：具有适当协程处理的可测试架构</li>
<li><strong>灵活性</strong>：易于扩展效果和混合 MVI 模式</li>
<li><strong>缓存和刷新</strong>：缓存和刷新机制（本文将尽可能详细地介绍）</li>
</ul>


<h3>关键要点</h3>

<ol>
<li><strong>基于流的加载</strong>消除了竞争条件，提高了测试的简易性，并解决了 <code>init {}</code> 块中固有的回栈问题</li>
<li><strong>具有适当共享策略的 StateFlow</strong> 提供了最佳的生命周期感知数据管理</li>
<li><strong>抽象层</strong>减少了样板代码，同时保持了灵活性</li>
<li><strong>全面的测试</strong>确保所有用例的可靠性</li>
</ol>


<p>请记住，这只是众多架构方法中的一种，它解决了我的问题，但可能无法解决你的问题。我们的目标是了解潜在问题并评估此解决方案是否符合你的特定需求。随着时间的推移，这个解决方案将经历许多变化，甚至可能被淘汰。最近，我更多地投入到使用 Ktor 进行后端开发，这本身就是一次很棒的体验。</p>

<p>该架构成功地为 iOS 和 Android 平台上的 <a href="https://wallhub.app/">WallHub</a> 提供了支持，证明了其在现实世界中的“可行性”以及跨平台适应性（如果可以这么说的话）。</p>

<p>继续潜水，直到下一篇文章……</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android应用的架构演进]]></title>
    <link href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"/>
    <updated>2025-09-13T12:34:01+00:00</updated>
    <id>https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app</id>
    <content type="html"><![CDATA[<blockquote><p>本文译自「Architectural Evolution of and Android app」，原文链接<a href="https://herrbert74.github.io/posts/architectural-evolution-of-an-app/">https://herrbert74.github.io/posts/architectural-evolution-of-an-app/</a>，由Zsolt Bertalan发布于20258月19日。</p></blockquote>

<p><a href="https://alexhilton.github.io/blog/2025/09/13/architectual-evolution-of-an-android-app/"><img src="https://herrbert74.github.io/assets/img/posts/20250818_arch_evolution.jpg" title="auto auto" ></a></p>

<!-- more -->


<p>本文将解释 Android 应用在发展过程中可能经历的各个阶段。不同的架构可能看起来截然不同（更不用说对细节的不同看法），但其背后的理念是相同的。我将通过整洁架构 (Clean Architecture) 和我的 <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> 代码库（链接：<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E6%9D%A5%E8%A7%A3%E9%87%8A%E8%BF%99%E4%B8%80%E7%82%B9%E3%80%82</a></p>

<p>我还想介绍一下大型应用中的常见模式：<strong>超级层</strong> 和 <strong>功能组</strong>。每当我开发的应用达到一定规模时，都会用到这些模式，但我从未制定过相关的基本规则。我希望把它们写下来，能让我和其他人更容易理解。</p>

<h3>超级层</h3>

<p>你可能还记得我之前的文章，我的应用有一个独立的<strong>领域层</strong>，<strong>数据层和展现层（从现在开始是UI层）</strong>都依赖于它。这些是基本的水平层。包含它们的垂直层也称为功能层。</p>

<p>我创造了 <strong>“超级层”</strong> 这个术语，是为了在基本水平层之上引入一个更广泛的层次结构。我们需要它们，因为水平层的范围可能有所不同，这意味着它们不仅可以涵盖功能层，还可以涵盖更广泛的范围。我将定义<strong>功能层</strong>、<strong>功能组</strong>、<strong>应用级（共享）</strong>和<strong>多应用级（基础）</strong> 超级层。</p>

<p>请参阅下图。</p>

<p><img src="file:///Users/alexhilton/Downloads/arch-envolve-1.png" alt="" /></p>

<p>在我上面解释的基本情况下，我们有<strong>功能层</strong>，其中整洁架构层仅在功能层内部可见。</p>

<p>接下来，<strong>功能组</strong>层是介于应用范围层和功能范围层之间的中间层。由于它是对超级层的最后且最不明显的补充，我将在稍后详细讨论。</p>

<p><strong>共享、通用或应用范围层</strong>通常包含与业务相关或整个应用独有的类。这是可以添加领域、数据和 UI 模块的最低层。</p>

<p><strong>基础层、基础设施层或基础结构层</strong>可以跨多个应用使用。它不包含领域、数据或 UI 层，但包含这些层之间通用的类。我通常有一个<strong>Kotlin 模块和一个 Android 基础模块</strong>。我创建了 <a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/">BaBeStudios-Base</a> 库项目（<a href="https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82">https://bitbucket.org/babestudios/babestudiosbase/src/master/%EF%BC%89%EF%BC%8C%E4%BB%A5%E4%BE%BF%E5%9C%A8%E5%A4%9A%E4%B8%AA%E5%BA%94%E7%94%A8%E4%B8%AD%E5%A4%8D%E7%94%A8%E8%BF%99%E4%BA%9B%E6%A8%A1%E5%9D%97%EF%BC%8C%E4%BD%86%E6%88%91%E7%9A%84%E5%BA%94%E7%94%A8%E4%B8%AD%E4%B9%9F%E6%9C%89%E4%B8%80%E4%BA%9B%E5%9F%BA%E7%A1%80%E6%A8%A1%E5%9D%97%EF%BC%8C%E7%94%A8%E4%BA%8E%E5%B0%9A%E6%9C%AA%E5%8C%85%E5%90%AB%E5%9C%A8%E8%AF%A5%E5%BA%93%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%9A%84%E4%BB%A3%E7%A0%81%E3%80%82</a> BaBeStudios-Base 也可从 <a href="https://mvnrepository.com/artifact/io.bitbucket.babestudios">MavenCentral</a> 获取，但目前尚无相关文档。</p>

<p>随着应用程序规模的扩大和模块的引入，你需要引入上述各层。</p>

<p>接下来，让我们看看随着应用程序规模的扩大，我通常采取的模块化步骤。</p>

<h3>步骤 1：单模块</h3>

<p>当你确定应用程序规模不会超过<strong>最大规模</strong>，或者时间紧迫时，你可以选择单模块应用程序或单体应用。我不确定单模块应用程序的最大规模是多少。这可能因人而异。</p>

<p>此最大规模也不同于<strong>阈值规模，你应该从该阈值开始模块化应用程序</strong>，或者更通俗地说，你应该从该阈值切换到流程的下一步。我认为阈值大小远小于单模块应用程序的最大大小，这意味着你应该在达到该限制之前就开始模块化。</p>

<p>对于大多数应用程序，我甚至建议<strong>从模块化开始</strong>，而不是从单个模块开始，因为与接近限制（比如 10 或 20 kLOC）时才开始模块化相比，这样做的开销和干扰程度要小得多。</p>

<p>这是一个单模块应用程序的包树示例。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>├── data
</span><span class='line'>│   ├── database
</span><span class='line'>│   ├── <span class="nb">local</span>
</span><span class='line'>│   ├── repository
</span><span class='line'>│   └── remote
</span><span class='line'>├── domain
</span><span class='line'>│   ├── api
</span><span class='line'>│   ├── model
</span><span class='line'>│   └── usecase
</span><span class='line'>├── presentation
</span><span class='line'>│   ├── master
</span><span class='line'>│   └── detail
</span><span class='line'>└── shared
</span></code></pre></td></tr></table></div></figure>


<p>上面图中的叶子节点代表包，它们可以包含此处未显示的其他包。下面我将展示一个类似的模块结构，其中以冒号开头的名称代表模块，双冒号代表根模块。</p>

<h3>步骤 2：简单模块化</h3>

<p>对于<strong>小型应用程序</strong>，我使用简单模块化，而不是下一章的完全模块化。这里我们只介绍<strong>每个功能的模块</strong>。每个功能将包含一个领域模块，以及依赖于领域模块的数据和呈现模块（在我的例子中）。</p>

<p>我们还引入了一个<strong>共享模块</strong>，其中包含所有功能模块的通用代码。</p>

<p>应用程序的超层由一条<strong>水平线</strong>分隔。每个层都依赖于其下方的所有层。数据和呈现依赖于领域模块，但这并未在图中显示。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>::feature:Feature A
</span><span class='line'>
</span><span class='line'>├── :feature/:featurea/:data
</span><span class='line'>├── :feature/:featurea/:domain
</span><span class='line'>└── :feature/:featurea/:presentation
</span><span class='line'>
</span><span class='line'>::feature:Feature B
</span><span class='line'>
</span><span class='line'>├── :feature/:featureb/:data
</span><span class='line'>├── :feature/:featureb/:domain
</span><span class='line'>└── :feature/:featureb/:presentation
</span><span class='line'>
</span><span class='line'> ::feature:Feature C
</span><span class='line'>
</span><span class='line'>├── :feature/:featurec/:data
</span><span class='line'>├── :feature/:featurec/:domain
</span><span class='line'>└── :feature/:featurec/:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::shared:data
</span><span class='line'>
</span><span class='line'>├── database
</span><span class='line'>├── <span class="nb">local</span>
</span><span class='line'>├── repository
</span><span class='line'>└── remote
</span><span class='line'>
</span><span class='line'>::shared:domain
</span><span class='line'>
</span><span class='line'>├── api
</span><span class='line'>├── model
</span><span class='line'>└── usecase
</span><span class='line'>
</span><span class='line'>::shared:presentation
</span><span class='line'>
</span><span class='line'>├── compose
</span><span class='line'>├── design
</span><span class='line'>└── util
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>::base:kotlin
</span></code></pre></td></tr></table></div></figure>


<h3>步骤 4：功能组</h3>

<p>当你的应用完全模块化后，共享层会逐渐成为单体应用，并成为构建过程中的<strong>瓶颈</strong>。</p>

<p>我经常在超过一定规模的应用（大约 50 到 80 kLOC）时遇到这种情况。你需要共享太多内容，因此你的<strong>共享领域模块和展示模块</strong>变得过大。你开始注意到，在所有垂直模块之间共享代码也是一种浪费，因为你只想在两个或最多三个或四个模块之间共享代码。你会发现越来越多的新代码被添加到这些模块中，而<strong>增量缓存</strong>的效率越来越低，因为你频繁地修改代码，导致它们失效。</p>

<p>你可能会说，可以通过适当地重构和构建应用程序，或者复制一些代码来避免这种情况，但这可能比你想象的要难。我发现这些建议并没有起到什么帮助作用。或者你可能手头有一个遗留应用，没有时间完美地重构所有内容。</p>

<p>我目前解决这个问题的方法是识别<strong>功能组</strong>，即一组具有大量公共依赖项的功能。这样，你就可以通过创建<strong>更具凝聚力</strong>的模块，水平拆分共享层中的部分代码。</p>

<p>我最近开发的所有大型应用中都有两个不同的功能组。</p>

<p>第一个功能组与<strong>核心业务</strong>功能相关：例如，一个模块围绕产品列表，另一个模块围绕产品详情，第三个模块围绕收藏产品。因此，我们可以将这个功能组命名为<strong>产品</strong>。另一个功能组围绕<strong>支付、广告或订阅</strong>，或者有时是这些功能的组合。这关系到应用的盈利方式。因此，我们可以将功能组命名为<strong>“支付”</strong>。</p>

<p>大型应用中可能会有五个或更多功能组。每个功能组将包含领域模块、数据模块和演示模块（如果需要）。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>feature/Feature A
</span><span class='line'>
</span><span class='line'>feature/Feature B
</span><span class='line'>
</span><span class='line'>feature/Feature C
</span><span class='line'>
</span><span class='line'>feature/Feature D
</span><span class='line'>
</span><span class='line'>feature/Feature E
</span><span class='line'>
</span><span class='line'>feature/Feature F
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:data
</span><span class='line'>
</span><span class='line'>:domain
</span><span class='line'>
</span><span class='line'>:presentation
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>:kotlin-base
</span></code></pre></td></tr></table></div></figure>


<h3>何时使用哪一步？</h3>

<p>你肯定希望将单体应用用于永远不会投入生产或一次性使用的应用程序。这些应用程序可以是<strong>概念验证</strong> (PoC, Proof of Concept) 应用程序、用于第三方错误的<strong>最小可复现示例</strong> (MRE, Minimum Reproducible Example) 应用程序，或用于求职申请的<strong>测试挑战</strong>应用程序。</p>

<p>对于所有其他情况，我建议先从部分或完全模块化开始，然后根据需要升级到下一步，或者尽可能提前升级，以减少以后的麻烦。</p>

<p>你可以在我的 <a href="https://github.com/herrbert74/FlickSlate">FlickSlate</a> 代码库（链接：<a href="https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82">https://github.com/herrbert74/FlickSlate%EF%BC%89%E4%B8%AD%E6%89%BE%E5%88%B0%E4%B8%8A%E8%BF%B0%EF%BC%88%E5%A4%A7%E9%83%A8%E5%88%86%EF%BC%89%E5%86%85%E5%AE%B9%E7%9A%84%E6%9C%89%E6%95%88%E7%A4%BA%E4%BE%8B%EF%BC%8C%E6%88%91%E6%9C%80%E8%BF%91%E5%B0%86%E5%85%B6%E6%9B%B4%E6%96%B0%E5%88%B0%E4%BA%86%E5%AE%8C%E5%85%A8%E6%A8%A1%E5%9D%97%E5%8C%96%E9%98%B6%E6%AE%B5%E3%80%82%E8%99%BD%E7%84%B6%E4%B8%BA%E6%97%B6%E8%BF%87%E6%97%A9%EF%BC%8C%E4%BD%86%E6%9C%89%E5%8A%A9%E4%BA%8E%E6%BC%94%E7%A4%BA%E8%BF%99%E4%BA%9B%E5%8E%9F%E5%88%99%E3%80%82%E5%BD%93%E7%84%B6%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E9%81%BF%E5%85%8D%E4%BB%A5%E5%90%8E%E7%9A%84%E9%BA%BB%E7%83%A6%E3%80%82</a></p>

<p>FlickSlate 尚未升级到功能组。这毫无意义，因为共享层还无法拆分为功能组。该应用没有盈利功能，所以只能对节目进行分组，不过目前共享层已经完美地实现了这一点。</p>

<p>这篇文章主要源于我对互联网上关于何时以及如何模块化的建议一概而论的不满：要么建议不加区分地进行模块化，要么有人对任何进行模块化的人大喊“过度工程”。我希望这篇文章能帮助你在何时以及如何进行模块化方面做出更明智的决定。</p>
]]></content>
  </entry>
  
</feed>
